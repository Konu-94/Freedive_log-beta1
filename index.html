<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>DiveLog</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <!-- Supabase JS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --primary: #3182F6;
      --primary-light: #E8F3FF;
      --success: #00C853;
      --warning: #FF9100;
      --error: #F44336;
      --bg: #F7F8FA;
      --surface: #FFFFFF;
      --text-primary: #191F28;
      --text-secondary: #8B95A1;
      --text-tertiary: #B0B8C1;
      --border: #E5E8EB;
      --divider: #F2F4F6;
      --lv2-color: #FF9100;
      --lv2-light: #FFF3E0;
      --lv3-color: #00C853;
      --lv3-light: #E8F5E9;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text-primary);
      line-height: 1.5;
      min-height: 100vh;
    }
    .app { max-width: 480px; margin: 0 auto; min-height: 100vh; background: var(--bg); position: relative; padding-bottom: 80px; }
    .screen { display: none; }
    .screen.active { display: block; }
    .screen.swipe-screen { display: none; flex-direction: column; height: 100vh; padding-bottom: 0; }
    .screen.swipe-screen.active { display: flex; }
    .header { background: var(--surface); padding: 12px 20px; display: flex; align-items: center; gap: 12px; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid var(--divider); }
    .header-back { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border: none; background: none; font-size: 20px; color: var(--text-primary); cursor: pointer; border-radius: 12px; }
    .header-title { font-size: 18px; font-weight: 600; flex: 1; }
    .header-action { color: var(--primary); font-weight: 600; background: none; border: none; font-size: 16px; cursor: pointer; }
    .tab-bar { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 480px; background: var(--surface); border-top: 1px solid var(--divider); display: flex; padding: 8px 0 20px; z-index: 100; }
    .tab-item { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 8px; background: none; border: none; cursor: pointer; color: var(--text-tertiary); }
    .tab-item.active { color: var(--primary); }
    .tab-item i { font-size: 22px; }
    .tab-item span { font-size: 11px; font-weight: 500; }
    .container { padding: 20px; }
    .card { background: var(--surface); border-radius: 16px; padding: 20px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
    .greeting { font-size: 24px; font-weight: 700; margin-bottom: 4px; }
    .greeting-sub { color: var(--text-secondary); font-size: 15px; }
    .section-title { font-size: 16px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    .btn { width: 100%; padding: 16px; border-radius: 12px; font-size: 16px; font-weight: 600; border: none; cursor: pointer; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-secondary { background: var(--primary-light); color: var(--primary); }
    .btn-outline { background: transparent; border: 1px dashed var(--border); color: var(--text-secondary); }
    .btn-danger { background: #FEE; color: var(--error); }
    .btn-small { padding: 10px 16px; width: auto; font-size: 14px; }
    .input-group { margin-bottom: 16px; }
    .input-label { font-size: 14px; font-weight: 500; color: var(--text-secondary); margin-bottom: 8px; display: block; }
    .input { width: 100%; padding: 14px 16px; border: 1px solid var(--border); border-radius: 12px; font-size: 16px; font-family: inherit; background: var(--surface); }
    .input:focus { outline: none; border-color: var(--primary); }
    select.input { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%238B95A1' d='M6 8L1 3h10z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 16px center; }
    .schedule-card { display: flex; justify-content: space-between; align-items: center; }
    .schedule-info { flex: 1; }
    .schedule-time { font-size: 15px; font-weight: 600; margin-bottom: 2px; }
    .schedule-location { font-size: 14px; color: var(--text-secondary); }
    .schedule-meta { font-size: 13px; color: var(--text-tertiary); margin-top: 4px; }
    .schedule-arrow { color: var(--text-tertiary); font-size: 18px; }
    .participant-card { display: flex; align-items: center; gap: 12px; padding: 16px 0; border-bottom: 1px solid var(--divider); }
    .participant-card:last-child { border-bottom: none; }
    .participant-avatar { width: 44px; height: 44px; border-radius: 50%; background: var(--primary-light); display: flex; align-items: center; justify-content: center; color: var(--primary); font-weight: 600; }
    .participant-info { flex: 1; }
    .participant-name { font-weight: 600; font-size: 16px; }
    .participant-detail { font-size: 13px; color: var(--text-secondary); margin-top: 2px; }
    .attendance-badge { padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 500; }
    .attendance-yes { background: #E8F5E9; color: var(--success); }
    .attendance-no { background: #FFEBEE; color: var(--error); }
    .attendance-pending { background: var(--divider); color: var(--text-secondary); }
    .record-row { background: var(--bg); border-radius: 12px; padding: 16px; margin-bottom: 12px; }
    .record-row-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .record-row-title { font-weight: 600; font-size: 14px; color: var(--text-secondary); }
    .record-row-delete { background: none; border: none; color: var(--error); cursor: pointer; font-size: 18px; }
    .record-fields { display: grid; grid-template-columns: 1fr 80px 100px; gap: 8px; }
    .record-note { margin-top: 8px; }
    .record-note .input { padding: 10px 12px; font-size: 14px; }
    .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px; }
    .stat-card { background: var(--surface); border-radius: 12px; padding: 16px; text-align: center; }
    .stat-label { font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; }
    .stat-value { font-size: 20px; font-weight: 700; color: var(--primary); }
    .level-card { text-align: center; padding: 24px 20px; }
    .level-badge { font-size: 32px; font-weight: 700; color: var(--primary); margin-bottom: 8px; }
    .progress-bar { height: 8px; background: var(--divider); border-radius: 4px; overflow: hidden; margin: 12px 0; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary), #60A5FA); border-radius: 4px; }
    .quick-actions { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .quick-btn { background: var(--surface); border-radius: 16px; padding: 20px 12px; text-align: center; border: none; cursor: pointer; }
    .quick-btn i { font-size: 24px; color: var(--primary); margin-bottom: 8px; display: block; }
    .quick-btn span { font-size: 13px; font-weight: 500; }
    .btn-icon-delete { 
      background: none; 
      border: none; 
      color: var(--text-tertiary); 
      cursor: pointer; 
      padding: 8px; 
      margin-left: 4px;
      border-radius: 8px;
    }
    .btn-icon-delete:hover { color: var(--error); background: #FEE; }
    
    /* 참가자 탭 */
    .participant-tabs {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding-bottom: 8px;
      margin-bottom: 16px;
    }
    .participant-tab {
      padding: 10px 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
      white-space: nowrap;
      cursor: pointer;
    }
    .participant-tab.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    
    /* 종목 탭 */
    .discipline-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      overflow-x: auto;
    }
    .disc-tab {
      padding: 8px 16px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .disc-tab.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    
    /* 기록 일괄 입력 종목 탭 (태그 형태) */
    .batch-tabs-container { display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px; }
    .batch-tabs-row { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
    .batch-tabs-label { font-size: 11px; color: var(--text-tertiary); min-width: 24px; }
    .batch-disc-tag {
      padding: 4px 12px;
      background: var(--primary-light);
      border: none;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
      color: var(--primary);
      cursor: pointer;
    }
    .batch-disc-tag.active {
      background: var(--primary);
      color: white;
    }
    .batch-skill-tag {
      padding: 4px 10px;
      border: none;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
    }
    .batch-skill-tag.lv2 {
      background: var(--lv2-light);
      color: var(--lv2-color);
    }
    .batch-skill-tag.lv2.active {
      background: var(--lv2-color);
      color: white;
    }
    .batch-skill-tag.lv3 {
      background: var(--lv3-light);
      color: var(--lv3-color);
    }
    .batch-skill-tag.lv3.active {
      background: var(--lv3-color);
      color: white;
    }
    
    /* 시도 입력 행 */
    .attempt-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      padding: 8px;
      background: var(--bg);
      border-radius: 8px;
    }
    .attempt-num {
      width: 30px;
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 13px;
    }
    .attempt-input {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 16px;
    }
    .attempt-input:focus {
      outline: none;
      border-color: var(--primary);
    }
    .attempt-delete {
      width: 32px;
      height: 32px;
      border: none;
      background: none;
      color: var(--text-tertiary);
      cursor: pointer;
      border-radius: 8px;
    }
    .attempt-delete:hover {
      color: var(--error);
      background: #FEE;
    }
    
    /* 기록 테이블 */
    .record-table-container {
      overflow-x: auto;
    }
    .record-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    .record-table th, .record-table td {
      padding: 10px 8px;
      text-align: center;
      border-bottom: 1px solid var(--divider);
    }
    .record-table th {
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 13px;
      background: var(--bg);
    }
    .record-table .col-name {
      text-align: left;
      min-width: 70px;
      font-weight: 500;
    }
    .record-table .col-attempt {
      min-width: 60px;
    }
    .record-table .col-note {
      min-width: 80px;
    }
    .record-table .col-skill {
      min-width: 50px;
    }
    .record-table .col-add-attempt {
      width: 30px;
      padding: 4px;
      border-left: 1px solid var(--divider);
    }
    .btn-add-col {
      width: 24px;
      height: 24px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 16px;
      color: var(--text-tertiary);
    }
    .btn-add-col:hover {
      color: var(--primary);
    }
    .record-table input {
      width: 100%;
      padding: 8px 4px;
      border: none;
      background: transparent;
      text-align: center;
      font-size: 14px;
      color: var(--text-secondary);
    }
    .record-table input:focus {
      outline: none;
      color: var(--primary);
      font-weight: 600;
    }
    .record-table input::placeholder {
      color: var(--text-tertiary);
    }
    .record-table input.note-input {
      text-align: left;
      padding-left: 8px;
    }
    .record-table td {
      border-right: 1px solid var(--divider);
    }
    .record-table td:last-child {
      border-right: none;
    }
    
    /* 스킬 체크 버튼 */
    .skill-check-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 2px solid var(--border);
      background: white;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    .skill-check-btn.success {
      background: var(--success);
      border-color: var(--success);
      color: white;
    }
    .skill-check-btn.fail {
      background: var(--error);
      border-color: var(--error);
      color: white;
    }
    
    /* 스킬 탭 */
    .disc-tab-skill {
      background: var(--lv3-light) !important;
      border-color: var(--lv3-color) !important;
      color: var(--lv3-color) !important;
    }
    .disc-tab-skill.active {
      background: var(--lv3-color) !important;
      color: white !important;
    }
    
    /* 일정 선택 아이템 */
    .schedule-select-item {
      padding: 16px;
      border-bottom: 1px solid var(--divider);
      cursor: pointer;
    }
    .schedule-select-item:hover {
      background: var(--bg);
    }
    .schedule-select-item:last-child {
      border-bottom: none;
    }
    
    /* 아이콘 버튼 */
    .icon-btn {
      width: 36px;
      height: 36px;
      border: none;
      background: transparent;
      color: var(--text-tertiary);
      cursor: pointer;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    .icon-btn:hover {
      background: var(--bg);
      color: var(--text-secondary);
    }
    
    /* 모드 스위치 버튼 - 토글 형태 */
    .mode-switch-container {
      display: flex;
      background: var(--bg);
      border-radius: 8px;
      padding: 2px;
    }
    .mode-switch-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      color: var(--text-tertiary);
      cursor: pointer;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      transition: all 0.15s;
    }
    .mode-switch-btn.active {
      background: var(--surface);
      color: var(--text-primary);
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .mode-switch-btn:hover:not(.active) {
      color: var(--text-secondary);
    }
    
    /* 섹션 타이틀 (일정 구분) */
    .schedule-section-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-tertiary);
      margin: 20px 0 12px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .schedule-section-title:first-child {
      margin-top: 0;
    }
    
    /* 캘린더 스타일 */
    .calendar-header {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      padding: 12px 0;
      margin-bottom: 8px;
    }
    .calendar-nav {
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      border-radius: 8px;
      font-size: 14px;
    }
    .calendar-nav:hover {
      background: var(--bg);
    }
    .calendar-title {
      font-size: 16px;
      font-weight: 600;
    }
    .calendar-grid {
      background: white;
      border-radius: 16px;
      padding: 0; /* 16px → 0으로 줄임 (좌우 여백 제거) */
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .calendar-weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      text-align: center;
      margin-bottom: 4px;
      padding: 8px 0;  /* 추가: 상하 여백만 */
    }
    .calendar-weekdays .weekday {
      font-size: 12px;
      color: var(--text-tertiary);
      padding: 8px 0;
    }
    .calendar-weekdays .weekday.sun {
      color: var(--error);
    }
    .calendar-weekdays .weekday.sat {
      color: var(--primary);
    }
    .calendar-days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px 0;  /* 세로 간격 */
      padding: 0 0 12px 0;
    }
    .calendar-day {
      aspect-ratio: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      cursor: pointer;
      font-size: 14px;
      font-weight: 400;  /* 기본: bold 없음 */
      position: relative;
      color: var(--text-primary);
      width: 40px;
      height: 40px;
      max-width: 40px;
      max-height: 40px;
      margin: 0 auto;
    }
    .calendar-day:hover {
      background: var(--bg);
    }
    .calendar-day.other-month {
      color: var(--text-tertiary);
      font-weight: 400;
    }
    /* 오늘 날짜 - 밑줄로 표시 */
    .calendar-day.today::after {
      content: '';
      position: absolute;
      bottom: 6px;
      left: 50%;
      transform: translateX(-50%);
      width: 16px;
      height: 2px;
      background: var(--text-secondary);
      border-radius: 1px;
    }
    .calendar-day.today:hover {
      background: var(--bg);
    }
    .calendar-day.selected {
      /* 선택시 bold */
      font-weight: 600;
    }
    .calendar-day.selected:hover {
      background: var(--bg);
    }
    .calendar-day.today.selected::after {
      background: var(--text-secondary);
    }
    /* 일정 있는 날짜 - 연한 색 동그라미 표시 */
    .calendar-day.has-lesson {
      background: #BFDBFE; /* 연한 하늘색 */
      color: var(--text-primary);
    }
    .calendar-day.has-personal {
      background: #BBF7D0; /* 연한 연두색 */
      color: var(--text-primary);
    }
    .calendar-day.has-dry {
      background: #FED7AA; /* 연한 주황색 */
      color: var(--text-primary);
    }
    /* 일정 있는 날짜 hover 시 배경색 유지 */
    .calendar-day.has-lesson:hover {
      background: #BFDBFE;
    }
    .calendar-day.has-personal:hover {
      background: #BBF7D0;
    }
    .calendar-day.has-dry:hover {
      background: #FED7AA;
    }
    /* 신청 가능한 강습 - 테두리만 */
    .calendar-day.has-available {
      box-shadow: inset 0 0 0 2px #93C5FD;
      color: var(--text-primary);
    }
    .calendar-day.has-available:hover {
      background: rgba(147, 197, 253, 0.1);
    }
    .calendar-day.has-lesson.selected,
    .calendar-day.has-personal.selected,
    .calendar-day.has-dry.selected,
    .calendar-day.has-available.selected {
      font-weight: 600;
    }
    /* 오늘이면서 일정 있는 날짜 */
    .calendar-day.has-lesson.today::after,
    .calendar-day.has-personal.today::after,
    .calendar-day.has-dry.today::after {
      background: var(--text-primary);
    }
    .calendar-day.has-available.today::after {
      background: #3B82F6;
    }
    /* 일정 바 제거 (동그라미로 대체) */
    .calendar-day .schedule-bars {
      display: none;
    }
    
    /* 범례 */
    .calendar-legend {
      display: flex;
      justify-content: center;
      gap: 16px;
  padding: 8px 0;  /* 12px 0 → 8px 0 */
      font-size: 12px;
      color: var(--text-secondary);
    }
    .calendar-legend span {
      display: flex;
      align-items: center;
      gap: 6px;
    }

/* 선택된 날짜 헤더 */
    .selected-date-header {
      display: flex;
      align-items: center;
      gap: 8px;
  padding: 12px 0;  /* 16px 0 12px 0 → 12px 0 */
      font-weight: 600;
      color: var(--text-primary);
      border-top: 1px solid var(--divider);
      margin-top: 8px;
    }
    .selected-date-header i {
      color: var(--primary);
    }
    .tab-filter { display: flex; gap: 8px; margin-bottom: 16px; overflow-x: auto; }
    .filter-chip { padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 500; background: var(--surface); border: 1px solid var(--border); color: var(--text-secondary); cursor: pointer; white-space: nowrap; }
    .filter-chip.active { background: var(--primary); border-color: var(--primary); color: white; }
    .bottom-sheet-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); z-index: 200; opacity: 0; visibility: hidden; transition: all 0.3s; }
    .bottom-sheet-overlay.active { opacity: 1; visibility: visible; }
    .bottom-sheet { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%) translateY(100%); width: 100%; max-width: 480px; background: var(--surface); border-radius: 24px 24px 0 0; z-index: 201; transition: transform 0.3s ease; max-height: 90vh; overflow-y: auto; }
    .bottom-sheet-overlay.active .bottom-sheet { transform: translateX(-50%) translateY(0); }
    .bottom-sheet-handle { width: 40px; height: 4px; background: var(--border); border-radius: 2px; margin: 12px auto; }
    .bottom-sheet-header { display: flex; align-items: center; justify-content: space-between; padding: 20px 20px 12px; border-bottom: 1px solid var(--divider); }
    .bottom-sheet-header h3 { font-size: 18px; font-weight: 700; margin: 0; }
    .bottom-sheet-close { width: 32px; height: 32px; border-radius: 50%; background: var(--bg); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); font-size: 16px; }
    .bottom-sheet-close:hover { background: var(--divider); }
    .bottom-sheet-content { padding: 8px 20px 32px; }
    .bottom-sheet-title { font-size: 20px; font-weight: 700; margin-bottom: 20px; }
    .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: var(--text-primary); color: white; padding: 14px 24px; border-radius: 12px; font-size: 15px; font-weight: 500; z-index: 300; opacity: 0; visibility: hidden; transition: all 0.3s; }
    .toast.show { opacity: 1; visibility: visible; }
    .login-screen { display: flex; flex-direction: column; min-height: 100vh; padding: 60px 24px 40px; }
    .login-logo { text-align: center; margin-bottom: 48px; }
    .login-logo i { font-size: 64px; color: var(--primary); margin-bottom: 16px; }
    .login-logo h1 { font-size: 32px; font-weight: 700; }
    .login-logo p { color: var(--text-secondary); margin-top: 8px; }
    .login-form { flex: 1; }
    .phone-input-wrapper { position: relative; }
    .phone-prefix { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: var(--text-primary); font-size: 16px; pointer-events: none; }
    .phone-input { padding-left: 46px !important; }
    .empty-state { text-align: center; padding: 48px 20px; }
    .empty-state i { font-size: 48px; color: var(--text-tertiary); margin-bottom: 16px; }
    .empty-state p { color: var(--text-secondary); }
    .purpose-buttons { display: flex; gap: 8px; margin-top: 12px; }
    .purpose-btn { flex: 1; padding: 12px; border-radius: 10px; font-size: 14px; font-weight: 500; border: 1px solid var(--border); background: var(--surface); cursor: pointer; }
    .purpose-btn.selected { background: var(--primary); border-color: var(--primary); color: white; }
    .chart-container { background: var(--surface); border-radius: 16px; padding: 20px; margin-bottom: 16px; }
    .chart-title { font-size: 16px; font-weight: 600; margin-bottom: 16px; }
    .record-list-item { padding: 16px 0; border-bottom: 1px solid var(--divider); }
    .record-list-item:last-child { border-bottom: none; }
    .record-date { font-size: 14px; font-weight: 600; margin-bottom: 8px; }
    .record-entry { display: flex; justify-content: space-between; padding: 4px 0; }
    .record-discipline { font-size: 14px; color: var(--text-secondary); }
    .record-value { font-weight: 600; }
    
    .discipline-checkbox { display: inline-block; margin: 8px 12px 8px 0; }
    .discipline-checkbox input { margin-right: 6px; }
    .batch-tabs { display: flex; gap: 8px; margin-bottom: 16px; border-bottom: 2px solid var(--border); overflow-x: auto; }
    .batch-tab { padding: 12px 20px; background: none; border: none; font-weight: 500; color: var(--text-secondary); cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px; white-space: nowrap; }
    .batch-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
    .batch-tab.skill-tab { color: var(--success); }
    .batch-tab.skill-tab.active { border-bottom-color: var(--success); }
    .batch-tab.skill-tab-lv2 { color: var(--lv2-color); }
    .batch-tab.skill-tab-lv2.active { border-bottom-color: var(--lv2-color); }
    .batch-table { width: 100%; border-collapse: collapse; }
    .batch-table th { background: var(--bg); padding: 12px 8px; font-size: 14px; font-weight: 600; text-align: left; }
    .batch-table td { padding: 12px 8px; border-bottom: 1px solid var(--divider); }
    .batch-table input { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; }
    .batch-table .student-name { font-weight: 500; }
    .common-disciplines-badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: var(--primary-light); color: var(--primary); border-radius: 20px; font-size: 13px; font-weight: 500; margin-top: 8px; }
    .common-disciplines-badge.skill-badge { background: #E8F5E9; color: var(--success); }
    .common-disciplines-badge.skill-badge-lv2 { background: var(--lv2-light); color: var(--lv2-color); }

    /* 스킬 테이블 스타일 */
    .skill-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .skill-table th { background: var(--bg); padding: 8px 4px; font-weight: 600; text-align: center; border-bottom: 2px solid var(--border); }
    .skill-table th.skill-header { font-size: 11px; }
    .skill-table th.attempt-header { font-size: 10px; color: var(--text-tertiary); font-weight: 500; }
    .skill-table td { padding: 8px 4px; border-bottom: 1px solid var(--divider); text-align: center; }
    .skill-table td.student-name { text-align: left; font-weight: 500; padding-left: 8px; white-space: nowrap; }
    .skill-cell { 
      width: 32px; 
      height: 32px; 
      border-radius: 8px; 
      display: inline-flex; 
      align-items: center; 
      justify-content: center; 
      cursor: pointer; 
      font-size: 14px;
      transition: all 0.15s ease;
      user-select: none;
    }
    .skill-cell.empty { background: var(--divider); color: var(--text-tertiary); }
    .skill-cell.success { background: #E8F5E9; color: var(--success); }
    .skill-cell.fail { background: #FFEBEE; color: var(--error); }
    .skill-cell:active { transform: scale(0.9); }
    
    .skill-group-header { 
      background: var(--primary-light) !important; 
      color: var(--primary); 
      font-weight: 600 !important;
    }
    .skill-group-header-lv2 { 
      background: var(--lv2-light) !important; 
      color: var(--lv2-color); 
      font-weight: 600 !important;
    }

    /* Lv 진도 차트 스타일 */
    .lv-charts { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
    .lv-chart-card { background: var(--surface); border-radius: 16px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
    .chart-header { font-size: 14px; font-weight: 600; margin-bottom: 12px; text-align: center; color: var(--text-primary); display: flex; align-items: center; justify-content: center; gap: 6px; cursor: pointer; user-select: none; }
    .chart-header:hover { color: var(--primary); }
    .toggle-icon { font-size: 12px; transition: transform 0.3s ease; color: var(--text-tertiary); }
    .toggle-icon.open { transform: rotate(180deg); }
    .donut-container { position: relative; width: 140px; height: 140px; margin: 0 auto 16px; }
    .donut-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; pointer-events: none; }
    .donut-value { font-size: 24px; font-weight: 700; color: var(--primary); line-height: 1; }
    .donut-value.lv2 { color: var(--lv2-color); }
    .donut-value.lv3 { color: var(--lv3-color); }
    .donut-label { font-size: 11px; color: var(--text-secondary); margin-top: 4px; }
    .checklist { border-top: 1px solid var(--divider); padding-top: 0; max-height: 0; overflow: hidden; transition: max-height 0.3s ease, padding 0.3s ease; border-top: none; }
    .checklist.open { max-height: 300px; overflow-y: auto; padding-top: 12px; border-top: 1px solid var(--divider); }
    .checklist-item { display: flex; align-items: center; gap: 8px; padding: 8px 0; border-bottom: 1px solid var(--divider); }
    .checklist-item:last-child { border-bottom: none; }
    .checklist-icon { width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 11px; }
    .checklist-icon.done { background: #E8F5E9; color: var(--success); }
    .checklist-icon.undone { background: var(--divider); color: var(--text-tertiary); }
    .checklist-text { flex: 1; font-size: 12px; line-height: 1.3; }
    .checklist-text.done { color: var(--text-secondary); text-decoration: line-through; }
    .checklist-badge { font-size: 11px; padding: 2px 6px; border-radius: 10px; background: var(--bg); color: var(--text-secondary); white-space: nowrap; }

    /* 일정 정보 카드 스타일 개선 */
    .schedule-info-card { background: var(--surface); border-radius: 16px; padding: 16px; margin-bottom: 16px; }
    .schedule-info-row { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
    .schedule-info-row:last-child { margin-bottom: 0; }
    .schedule-info-row i { color: var(--primary); width: 16px; }
    .schedule-badges { display: flex; flex-wrap: wrap; gap: 6px; }
    .btn-edit-disciplines { 
      background: var(--bg); 
      border: 1px solid var(--border); 
      border-radius: 8px; 
      padding: 8px 12px; 
      font-size: 13px; 
      color: var(--text-secondary); 
      cursor: pointer; 
      display: flex; 
      align-items: center; 
      gap: 4px;
      flex-shrink: 0;
    }
    .btn-edit-disciplines:hover { background: var(--divider); color: var(--text-primary); }
    
    /* 스킬 섹션 구분 */
    .skill-section-label { 
      font-size: 12px; 
      font-weight: 600; 
      padding: 8px 12px; 
      margin: 16px 0 8px; 
      border-radius: 8px;
    }
    .skill-section-label.lv2 { background: var(--lv2-light); color: var(--lv2-color); }
    .skill-section-label.lv3 { background: #E8F5E9; color: var(--success); }

    /* 일정 카드 아이콘 버튼 */
    .schedule-card-header { display: flex; justify-content: space-between; align-items: flex-start; }
    .schedule-card-content { flex: 1; cursor: pointer; }
    .schedule-icon-buttons { display: flex; gap: 4px; flex-shrink: 0; margin-left: 8px; }
    .icon-btn { 
      width: 32px; 
      height: 32px; 
      border-radius: 8px; 
      border: none; 
      background: var(--bg); 
      color: var(--text-tertiary); 
      cursor: pointer; 
      display: flex; 
      align-items: center; 
      justify-content: center;
      font-size: 14px;
      transition: all 0.15s;
    }
    .icon-btn:hover { background: var(--divider); color: var(--text-secondary); }
    .icon-btn.danger:hover { background: #FFEBEE; color: var(--error); }
    .schedule-action-buttons { display: flex; gap: 8px; margin-top: 12px; }
    .schedule-action-buttons .btn { flex: 1; padding: 10px; font-size: 14px; }

    /* Notion 스타일 기록 테이블 */
    .record-table-container { margin-top: 16px; }
    .record-table-wrapper { display: flex; align-items: stretch; }
    .record-table { 
      flex: 1;
      border-collapse: collapse; 
      background: white; 
      border-radius: 12px; 
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .record-table th, .record-table td { 
      border: 1px solid var(--divider); 
      padding: 12px 8px; 
      text-align: center;
      min-width: 60px;
    }
    .record-table th { 
      background: var(--bg); 
      font-weight: 600; 
      font-size: 13px;
      color: var(--text-secondary);
    }
    .record-table th.discipline-col {
      min-width: 70px;
      background: var(--bg);
    }
    .record-table td.discipline-cell {
      background: var(--bg);
      font-weight: 600;
      color: var(--text);
      position: relative;
    }
    .record-table td.discipline-cell .remove-row-btn {
      position: absolute;
      left: 4px;
      top: 50%;
      transform: translateY(-50%);
      width: 18px;
      height: 18px;
      border: none;
      background: transparent;
      color: var(--text-tertiary);
      cursor: pointer;
      font-size: 10px;
      opacity: 0;
      transition: opacity 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
    }
    .record-table tr:hover td.discipline-cell .remove-row-btn { opacity: 1; }
    .record-table td.discipline-cell .remove-row-btn:hover { background: #FFEBEE; color: var(--error); }
    .record-table input.record-input {
      width: 100%;
      border: none;
      background: transparent;
      text-align: center;
      font-size: 15px;
      padding: 4px;
      outline: none;
    }
    .record-table input.record-input:focus {
      background: rgba(49, 130, 246, 0.05);
      border-radius: 4px;
    }
    .record-table input.record-input::placeholder {
      color: var(--text-tertiary);
      font-size: 13px;
    }
    .record-table th .remove-col-btn {
      display: inline-block;
      margin-left: 4px;
      width: 16px;
      height: 16px;
      border: none;
      background: transparent;
      color: var(--text-tertiary);
      cursor: pointer;
      font-size: 9px;
      opacity: 0;
      transition: opacity 0.15s;
      vertical-align: middle;
      border-radius: 4px;
    }
    .record-table th:hover .remove-col-btn { opacity: 1; }
    .record-table th .remove-col-btn:hover { background: #FFEBEE; color: var(--error); }
    
    /* 추가 버튼들 */
    .add-col-btn {
      width: 36px;
      min-width: 36px;
      background: var(--bg);
      border: 1px dashed var(--divider);
      border-left: none;
      border-radius: 0 12px 12px 0;
      cursor: pointer;
      color: var(--text-tertiary);
      font-size: 14px;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .add-col-btn:hover { background: rgba(49, 130, 246, 0.05); color: var(--primary); }
    .add-row-btn {
      width: 100%;
      padding: 12px;
      margin-top: 8px;
      background: var(--bg);
      border: 1px dashed var(--divider);
      border-radius: 8px;
      cursor: pointer;
      color: var(--text-tertiary);
      font-size: 14px;
      transition: all 0.15s;
    }
    .add-row-btn:hover { background: rgba(49, 130, 246, 0.05); color: var(--primary); }

    /* 일괄 추가 - 날짜 입력 행 */
    .bulk-date-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      align-items: center;
    }
    .bulk-date-row .date-input-wrapper {
      flex: 1;
      position: relative;
    }
    .bulk-date-row .date-display {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 15px;
      background: var(--surface);
      text-align: center;
      font-family: 'SF Mono', Monaco, monospace;
      letter-spacing: 1px;
    }
    .bulk-date-row .date-display:focus {
      outline: none;
      border-color: var(--primary);
    }
    .bulk-date-row .date-display::placeholder {
      color: var(--text-tertiary);
      letter-spacing: 0;
    }
    .bulk-date-row .location-input {
      flex: 1.2;
      padding: 12px 14px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 15px;
      background: var(--surface);
    }
    .bulk-date-row .location-input:focus {
      outline: none;
      border-color: var(--primary);
    }
    .bulk-date-row .remove-btn {
      width: 36px;
      height: 36px;
      border: none;
      background: transparent;
      color: var(--text-tertiary);
      cursor: pointer;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .bulk-date-row .remove-btn:hover {
      background: #FFEBEE;
      color: var(--error);
    }

    /* 일괄 추가 - 날짜 탭 */
    .bulk-date-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      overflow-x: auto;
      padding-bottom: 4px;
    }
    .bulk-date-tab {
      padding: 10px 14px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.15s;
    }
    .bulk-date-tab.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    .bulk-date-tab.saved {
      background: #E8F5E9;
      border-color: var(--success);
      color: var(--success);
    }
    .bulk-date-tab.saved.active {
      background: var(--success);
      color: white;
    }

    /* 날짜 추가 버튼 */
    .btn-add-date {
      padding: 8px 12px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: all 0.15s;
    }
    .btn-add-date:hover { background: #2563EB; }

    /* 캘린더 스타일 */
    .calendar-container {
      background: var(--surface);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .calendar-nav {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .calendar-nav-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: var(--bg);
      border-radius: 8px;
      cursor: pointer;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .calendar-nav-btn:hover {
      background: var(--divider);
      color: var(--text-primary);
    }
    .calendar-month {
      font-size: 16px;
      font-weight: 600;
    }
    .calendar-weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      text-align: center;
      margin-bottom: 8px;
    }
    .calendar-weekday {
      font-size: 12px;
      color: var(--text-tertiary);
      font-weight: 500;
      padding: 8px 0;
    }
    .calendar-weekday:first-child {
      color: #F44336;
    }
    .calendar-weekday:last-child {
      color: #3182F6;
    }

    /* 선택된 날짜 일정 카드 */
    .selected-date-header {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .selected-date-header i {
      color: var(--primary);
    }
    .schedule-detail-card {
      background: var(--surface);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 12px;
    }
    .schedule-detail-card .schedule-date-time {
      font-weight: 600;
      font-size: 15px;
      margin-bottom: 4px;
    }
    .schedule-detail-card .schedule-location,
    .schedule-detail-card .schedule-instructor {
      color: var(--text-secondary);
      font-size: 14px;
      margin-bottom: 4px;
    }
    .my-schedule-badge {
      display: inline-block;
      padding: 4px 10px;
      background: var(--primary-light);
      color: var(--primary);
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 8px;
    }
    /* 메모 섹션 스타일 */
    .memo-section {
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid var(--divider);
    }
    .memo-section-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .memo-section-title i {
      color: var(--primary);
    }
    .memo-card {
      background: var(--bg);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 10px;
    }
    .memo-card-header {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .memo-card-header.instructor {
      color: var(--primary);
    }
    .memo-card-header.student {
      color: var(--success);
    }
    .memo-card-content {
      font-size: 14px;
      color: var(--text-primary);
      line-height: 1.5;
    }
    .memo-card-empty {
      font-size: 13px;
      color: var(--text-tertiary);
      font-style: italic;
    }
    .memo-textarea {
      width: 100%;
      min-height: 80px;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 14px;
      font-family: inherit;
      resize: vertical;
      background: var(--surface);
    }
    .memo-textarea:focus {
      outline: none;
      border-color: var(--primary);
    }
    .memo-textarea::placeholder {
      color: var(--text-tertiary);
    }
    /* 로딩 인디케이터 */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 40px;
    }
    .loading-spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--divider);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* 트레이닝 탭 스타일 */
    .training-tab {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--surface);
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: all 0.2s;
    }
    .training-tab.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    .training-tab i {
      font-size: 16px;
    }
    
    /* 이미지 트레이닝 카테고리 카드 */
    .image-category-card {
      background: var(--surface);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 16px;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    .image-category-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    .image-category-card:active {
      transform: scale(0.98);
    }
    .image-category-card.not-ready {
      opacity: 0.6;
      cursor: default;
    }
    .image-category-card.not-ready:hover {
      transform: none;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    .image-category-card.not-ready .category-icon {
      background: var(--bg);
      filter: grayscale(100%);
    }
    .preparing-badge {
      display: inline-block;
      font-size: 11px;
      font-weight: 500;
      padding: 2px 8px;
      border-radius: 10px;
      background: var(--text-tertiary);
      color: white;
      margin-left: 6px;
      vertical-align: middle;
    }
    .category-icon {
      width: 56px;
      height: 56px;
      border-radius: 16px;
      background: var(--primary-light);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
    }
    .category-info {
      flex: 1;
    }
    .category-name {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .category-desc {
      font-size: 13px;
      color: var(--text-secondary);
    }
    .category-arrow {
      color: var(--text-tertiary);
      font-size: 18px;
    }
    
    /* 이미지 트레이닝 스텝 카드 */
    .training-step-card {
      background: var(--surface);
      border-radius: 16px;
      margin-bottom: 16px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    .step-image-container {
      width: 100%;
      aspect-ratio: 16/10;
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .step-image-container img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .step-image-placeholder {
      color: var(--text-tertiary);
      font-size: 48px;
    }
    .step-content {
      padding: 16px;
    }
    .step-number {
      display: inline-block;
      width: 28px;
      height: 28px;
      background: var(--primary);
      color: white;
      border-radius: 50%;
      text-align: center;
      line-height: 28px;
      font-size: 14px;
      font-weight: 600;
      margin-right: 10px;
    }
    .step-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
    }
    .step-title-text {
      flex: 1;
    }
    .step-description {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.6;
      margin-bottom: 12px;
    }
    .step-tips {
      background: var(--primary-light);
      border-radius: 10px;
      padding: 12px;
      font-size: 13px;
      color: var(--primary);
    }
    .step-tips i {
      margin-right: 6px;
    }
    
    /* 스와이프 UI */
    .swipe-container {
      flex: 1;
      overflow: hidden;
      position: relative;
      touch-action: pan-y;
    }
    .swipe-wrapper {
      display: flex;
      transition: transform 0.3s ease;
      height: 100%;
    }
    .swipe-slide {
      flex: 0 0 100%;
      width: 100%;
      padding: 20px;
      overflow-y: auto;
    }
    .swipe-card {
      background: var(--surface);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
    }
    .swipe-card-image {
      width: 100%;
      aspect-ratio: 16/10;
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .swipe-card-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .swipe-card-image .placeholder {
      font-size: 64px;
      color: var(--text-tertiary);
    }
    .swipe-card-content {
      padding: 20px;
    }
    .swipe-card-step {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      background: var(--primary);
      color: white;
      border-radius: 50%;
      font-size: 16px;
      font-weight: 700;
      margin-right: 12px;
    }
    .swipe-card-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
    }
    .swipe-card-desc {
      font-size: 15px;
      color: var(--text-secondary);
      line-height: 1.6;
      margin-bottom: 16px;
      white-space: pre-line;
      padding-left: 16px;
    }
    .swipe-card-tips {
      background: var(--primary-light);
      border-radius: 12px;
      padding: 14px 16px;
      font-size: 14px;
      color: var(--primary);
    }
    .swipe-card-tips .tips-header {
      font-weight: 600;
      margin-bottom: 8px;
    }
    .swipe-card-tips .tips-content {
      white-space: pre-line;
      line-height: 1.6;
    }
    .swipe-card-tips i {
      margin-right: 4px;
    }
    
    .swipe-controls {
      background: var(--surface);
      padding: 16px 20px 24px;
      border-top: 1px solid var(--divider);
    }
    .swipe-indicators {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 16px;
    }
    .swipe-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--border);
      transition: all 0.3s;
    }
    .swipe-indicator.active {
      width: 24px;
      border-radius: 4px;
      background: var(--primary);
    }
    .swipe-buttons {
      display: flex;
      gap: 12px;
    }
    .swipe-btn {
      flex: 1;
      padding: 14px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--surface);
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s;
    }
    .swipe-btn:hover {
      background: var(--bg);
    }
    .swipe-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    .swipe-btn.primary {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    
    /* 리그 랭크 카드 */
    .league-cards {
      display: flex;
      gap: 10px;
      overflow-x: auto;
      padding-bottom: 8px;
      margin-bottom: 8px;
    }
    .league-card {
      flex: 0 0 auto;
      width: 100px;
      background: var(--surface);
      border-radius: 16px;
      padding: 16px 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      border: 2px solid transparent;
    }
    .league-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    .league-card.active {
      border-color: var(--primary);
    }
    .league-card-disc {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }
    .league-card-emoji {
      font-size: 36px;
      margin-bottom: 6px;
    }
    .league-card-tier {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 2px;
    }
    .league-card-record {
      font-size: 11px;
      color: var(--text-tertiary);
    }
    .league-card.frenzel-card {
      background: linear-gradient(135deg, #E8E0FF 0%, #D4C4FF 100%);
    }
    .league-card.frenzel-card .league-card-disc {
      color: #7C3AED;
    }
    .league-card.frenzel-card .league-card-tier {
      color: #5B21B6;
    }
    .league-card.frenzel-card .league-card-record {
      color: #7C3AED;
    }
    
    /* 리그 랭킹 화면 */
    .league-header {
      background: linear-gradient(135deg, var(--primary) 0%, #60A5FA 100%);
      border-radius: 20px;
      padding: 24px;
      margin-bottom: 20px;
      color: white;
      text-align: center;
    }
    .league-header-emoji {
      font-size: 56px;
      margin-bottom: 8px;
    }
    .league-header-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    .league-header-subtitle {
      font-size: 14px;
      opacity: 0.9;
    }
    .league-header-range {
      font-size: 12px;
      opacity: 0.8;
      margin-top: 8px;
    }
    
    .league-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      overflow-x: auto;
    }
    .league-tab {
      flex: 0 0 auto;
      padding: 8px 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
    }
    .league-tab.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    
    .ranking-list {
      background: var(--surface);
      border-radius: 16px;
      overflow: hidden;
    }
    .ranking-item {
      display: flex;
      align-items: center;
      padding: 14px 16px;
      border-bottom: 1px solid var(--divider);
    }
    .ranking-item:last-child {
      border-bottom: none;
    }
    .ranking-item.me {
      background: var(--primary-light);
    }
    .ranking-position {
      width: 32px;
      font-size: 16px;
      font-weight: 700;
      color: var(--text-secondary);
    }
    .ranking-position.top1 { color: #FFD700; }
    .ranking-position.top2 { color: #C0C0C0; }
    .ranking-position.top3 { color: #CD7F32; }
    .ranking-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: var(--primary);
      margin-right: 12px;
    }
    .ranking-info {
      flex: 1;
    }
    .ranking-name {
      font-size: 15px;
      font-weight: 600;
    }
    .ranking-record {
      font-size: 16px;
      font-weight: 700;
      color: var(--primary);
    }
    
    /* 티어 색상 */
    .tier-egg { color: #9E9E9E; }
    .tier-shrimp { color: #FF8A65; }
    .tier-seahorse { color: #4FC3F7; }
    .tier-turtle { color: #81C784; }
    .tier-dolphin { color: #BA68C8; }
    .tier-whale { color: #FFD54F; }
    
    .league-card.tier-0 { background: linear-gradient(135deg, #F5F5F5 0%, #E0E0E0 100%); }
    .league-card.tier-1 { background: linear-gradient(135deg, #FFF3E0 0%, #FFCCBC 100%); }
    .league-card.tier-2 { background: linear-gradient(135deg, #E1F5FE 0%, #B3E5FC 100%); }
    .league-card.tier-3 { background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%); }
    .league-card.tier-4 { background: linear-gradient(135deg, #F3E5F5 0%, #E1BEE7 100%); }
    .league-card.tier-5 { background: linear-gradient(135deg, #FFFDE7 0%, #FFF9C4 100%); }
    
    /* 리그 기준 표 */
    .league-info-table {
      overflow-x: auto;
    }
    .league-info-table table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    .league-info-table th,
    .league-info-table td {
      padding: 10px 8px;
      text-align: center;
      border-bottom: 1px solid var(--divider);
    }
    .league-info-table th {
      background: var(--bg);
      font-weight: 600;
      color: var(--text-secondary);
    }
    .league-info-table tbody tr:last-child td {
      border-bottom: none;
    }
    .tier-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      white-space: nowrap;
    }
    .tier-badge.tier-egg { background: #F5F5F5; color: #757575; }
    .tier-badge.tier-shrimp { background: #FFF3E0; color: #E65100; }
    .tier-badge.tier-seahorse { background: #E1F5FE; color: #0277BD; }
    .tier-badge.tier-turtle { background: #E8F5E9; color: #2E7D32; }
    .tier-badge.tier-dolphin { background: #F3E5F5; color: #7B1FA2; }
    .tier-badge.tier-whale { background: #FFFDE7; color: #F57F17; }
    
    /* 프렌젤 리그 */
    .frenzel-league-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 16px;
      padding: 16px;
      color: white;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .frenzel-league-card:hover {
      transform: translateY(-2px);
    }
    .frenzel-league-card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }
    .frenzel-league-card-icon {
      font-size: 32px;
    }
    .frenzel-league-card-title {
      font-size: 16px;
      font-weight: 700;
    }
    .frenzel-league-card-subtitle {
      font-size: 12px;
      opacity: 0.9;
    }
    .frenzel-league-card-stats {
      display: flex;
      gap: 16px;
      font-size: 13px;
    }
    .frenzel-league-card-stat {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .frenzel-league-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 20px;
      padding: 24px;
      color: white;
      text-align: center;
      margin-bottom: 20px;
    }
    .frenzel-icon {
      font-size: 48px;
      margin-bottom: 8px;
    }
    .frenzel-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    .frenzel-subtitle {
      font-size: 14px;
      opacity: 0.9;
    }
    
    .frenzel-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    .frenzel-tab {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 12px;
      background: var(--surface);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .frenzel-tab.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .frenzel-ranking-item {
      display: flex;
      align-items: center;
      padding: 14px 16px;
      background: var(--surface);
      border-radius: 12px;
      margin-bottom: 8px;
    }
    .frenzel-ranking-item.me {
      background: linear-gradient(135deg, #EEF2FF 0%, #E0E7FF 100%);
      border: 2px solid #667eea;
    }
    .frenzel-ranking-item.today-done {
      background: linear-gradient(135deg, #FFF7ED 0%, #FFEDD5 100%);
    }
    .frenzel-ranking-item.me.today-done {
      background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
      border: 2px solid #F59E0B;
    }
    .frenzel-rank {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
      color: var(--text-secondary);
      margin-right: 12px;
    }
    .frenzel-rank.top1 { color: #FFD700; }
    .frenzel-rank.top2 { color: #C0C0C0; }
    .frenzel-rank.top3 { color: #CD7F32; }
    .frenzel-info {
      flex: 1;
    }
    .frenzel-name {
      font-weight: 600;
      font-size: 15px;
    }
    .frenzel-detail {
      font-size: 12px;
      color: var(--text-tertiary);
      margin-top: 2px;
    }
    .frenzel-score {
      text-align: right;
    }
    .frenzel-score-value {
      font-size: 16px;
      font-weight: 700;
      color: #667eea;
    }
    .frenzel-score-detail {
      font-size: 11px;
      color: var(--text-tertiary);
    }
    
    .graduate-item {
      display: flex;
      align-items: center;
      padding: 14px 16px;
      background: var(--surface);
      border-radius: 12px;
      margin-bottom: 8px;
    }
    .graduate-icon {
      font-size: 24px;
      margin-right: 12px;
    }
    .graduate-info {
      flex: 1;
    }
    .graduate-name {
      font-weight: 600;
    }
    .graduate-date {
      font-size: 12px;
      color: var(--text-tertiary);
    }
    
    /* 자주 가는 장소 */
    .frequent-locations {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    .frequent-loc-btn {
      padding: 8px 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 13px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
    }
    .frequent-loc-btn:hover {
      background: var(--primary-light);
      border-color: var(--primary);
      color: var(--primary);
    }
    
    /* 다중 선택 UI */
    .multi-select-container {
      border: 1px solid var(--border);
      border-radius: 12px;
      max-height: 180px;
      overflow-y: auto;
    }
    .multi-select-item {
      display: flex;
      align-items: center;
      padding: 10px 12px;
      border-bottom: 1px solid var(--divider);
      cursor: pointer;
      transition: background 0.2s;
    }
    .multi-select-item:last-child {
      border-bottom: none;
    }
    .multi-select-item:hover {
      background: var(--bg);
    }
    .multi-select-item.selected {
      background: var(--primary-light);
    }
    .multi-select-item input[type="checkbox"] {
      margin-right: 10px;
      width: 16px;
      height: 16px;
    }
    .multi-select-item .item-name {
      font-size: 14px;
    }
    .selected-count {
      font-size: 12px;
      color: var(--primary);
      margin-top: 6px;
    }
  </style>
</head>
<body>
  <div class="app" id="app">
    <!-- 로그인 화면 -->
    <div class="screen active" id="screen-login">
      <div class="login-screen">
        <div class="login-logo">
          <i class="fas fa-water"></i>
          <h1>DiveLog</h1>
          <p>프리다이빙 기록을 한눈에</p>
        </div>
        <div class="login-form">
          <div class="input-group">
            <label class="input-label">연락처</label>
            <div class="phone-input-wrapper">
              <span class="phone-prefix">010-</span>
              <input type="tel" class="input phone-input" id="login-phone" placeholder="0000-0000" maxlength="9">
            </div>
          </div>
          <div class="input-group" style="margin-top: 12px;">
            <label class="input-label">아이디</label>
            <input type="text" class="input" id="login-userid" placeholder="아이디 입력">
          </div>
          <button class="btn btn-primary" onclick="handleLogin()">시작하기</button>
        </div>
      </div>
    </div>

    <!-- 강사 대시보드 -->
    <div class="screen" id="screen-instructor-home">
      <div class="container">
        <div style="padding: 20px 0;">
          <div class="greeting">안녕하세요, <span id="instructor-name">코치</span>님 👋</div>
          <div class="greeting-sub">오늘도 좋은 강습 되세요</div>
        </div>
        <div class="section-title"><i class="fas fa-calendar-day"></i> 오늘의 일정</div>
        <div id="today-schedules"></div>
        <div class="section-title" style="margin-top: 24px;"><i class="fas fa-bolt"></i> 빠른 실행</div>
        <div class="quick-actions">
          <button class="quick-btn" onclick="openScheduleForm()"><i class="fas fa-calendar-plus"></i><span>일정 등록</span></button>
          <button class="quick-btn" onclick="showScreen('screen-dry-manage')"><i class="fas fa-dumbbell"></i><span>트레이닝<br>관리</span></button>
          <button class="quick-btn" onclick="quickRecordInput()"><i class="fas fa-pen"></i><span>최근 강습<br>기록 입력</span></button>
        </div>
        <div class="card" style="margin-top: 24px;">
          <div class="section-title"><i class="fas fa-chart-bar"></i> 이번 주 요약</div>
          <div id="instructor-stats" style="color: var(--text-secondary);"></div>
        </div>
      </div>
      <div class="tab-bar">
        <button class="tab-item active" onclick="showScreen('screen-instructor-home')"><i class="fas fa-home"></i><span>홈</span></button>
        <button class="tab-item" onclick="showScreen('screen-schedule-manage')"><i class="fas fa-calendar"></i><span>일정</span></button>
        <button class="tab-item" onclick="showScreen('screen-dry-manage')"><i class="fas fa-dumbbell"></i><span>트레이닝</span></button>
        <button class="tab-item" onclick="showScreen('screen-my-records')"><i class="fas fa-chart-line"></i><span>내기록</span></button>
        <button class="tab-item" onclick="showScreen('screen-mypage')"><i class="fas fa-user"></i><span>마이</span></button>
      </div>
    </div>

    <!-- 강습생 대시보드 -->
    <div class="screen" id="screen-student-home">
      <div class="container">
        <div style="padding: 20px 0;">
          <div class="greeting">안녕하세요, <span id="student-name">강습생</span>님 🏊‍♂️</div>
          <div class="greeting-sub">꾸준히 성장하고 있어요!</div>
        </div>

        <!-- 레벨별 진도 차트 섹션 -->
        <div id="level-progress-section" style="display: none;">
          <div class="section-title" id="level-progress-title"><i class="fas fa-graduation-cap"></i> Level 진도</div>
          <div id="level-progress-summary" style="color: var(--text-secondary); font-size: 14px; margin: -8px 0 16px; padding-left: 24px;"></div>
          <div class="lv-charts">
            <div class="lv-chart-card">
              <div class="chart-header" onclick="toggleChecklist('skills')">
                스킬 체크리스트
                <i class="fas fa-chevron-down toggle-icon" id="skills-toggle-icon"></i>
              </div>
              <div class="donut-container">
                <canvas id="skills-chart"></canvas>
                <div class="donut-center">
                  <div class="donut-value" id="skills-progress-value">0/0</div>
                  <div class="donut-label">완료</div>
                </div>
              </div>
              <div class="checklist" id="skills-checklist"></div>
            </div>
            
            <div class="lv-chart-card">
              <div class="chart-header" onclick="toggleChecklist('records')">
                기록 달성
                <i class="fas fa-chevron-down toggle-icon" id="records-toggle-icon"></i>
              </div>
              <div class="donut-container">
                <canvas id="records-chart"></canvas>
                <div class="donut-center">
                  <div class="donut-value" id="records-progress-value">0/0</div>
                  <div class="donut-label">달성</div>
                </div>
              </div>
              <div class="checklist" id="records-checklist"></div>
            </div>
          </div>
        </div>

        <div class="section-title"><i class="fas fa-trophy"></i> 종목별 최고 기록</div>
        <div class="stat-grid" id="best-records"></div>
        
        <!-- 나의 리그 랭크 섹션 -->
        <div class="section-title" style="margin-top: 24px;"><i class="fas fa-medal"></i> 나의 리그</div>
        <div class="league-cards" id="my-league-cards">
          <div class="loading"><div class="loading-spinner"></div></div>
        </div>
        
        <div class="section-title" style="margin-top: 24px;"><i class="fas fa-calendar"></i> 다가오는 일정</div>
        <div id="upcoming-schedules"></div>
        
        <!-- 드라이 트레이닝 섹션 -->
        <div class="section-title" style="margin-top: 24px;"><i class="fas fa-lungs"></i> 드라이 트레이닝</div>
        <div id="home-dry-training"></div>
      </div>
      <div class="tab-bar">
        <button class="tab-item active" onclick="showScreen('screen-student-home')"><i class="fas fa-home"></i><span>홈</span></button>
        <button class="tab-item" onclick="showScreen('screen-student-schedule')"><i class="fas fa-calendar"></i><span>일정</span></button>
        <button class="tab-item" onclick="showScreen('screen-dry-training')"><i class="fas fa-dumbbell"></i><span>트레이닝</span></button>
        <button class="tab-item" onclick="showScreen('screen-my-records')"><i class="fas fa-chart-line"></i><span>내기록</span></button>
        <button class="tab-item" onclick="showScreen('screen-mypage')"><i class="fas fa-user"></i><span>마이</span></button>
      </div>
    </div>
    
    <!-- 리그 랭킹 화면 -->
    <div class="screen" id="screen-league-ranking">
      <div class="header">
        <button class="header-back" onclick="showScreen('screen-student-home')"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title" id="league-screen-title">리그 랭킹</span>
        <button class="header-action" onclick="openLeagueInfo()" style="font-size: 18px;"><i class="fas fa-question-circle"></i></button>
      </div>
      <div class="container">
        <!-- 리그 헤더 -->
        <div class="league-header" id="league-header">
          <div class="league-header-emoji">🐢</div>
          <div class="league-header-title">거북이 리그</div>
          <div class="league-header-subtitle">STA</div>
          <div class="league-header-range">2'00" ~ 2'39"</div>
        </div>
        
        <!-- 종목 탭 -->
        <div class="league-tabs" id="league-disc-tabs">
          <button class="league-tab active" data-disc="STA" onclick="switchLeagueDisc('STA')">STA</button>
          <button class="league-tab" data-disc="CWTB" onclick="switchLeagueDisc('CWTB')">CWTB</button>
          <button class="league-tab" data-disc="DYNB" onclick="switchLeagueDisc('DYNB')">DYN</button>
        </div>
        
        <!-- 랭킹 리스트 -->
        <div class="ranking-list" id="league-ranking-list">
          <div class="loading"><div class="loading-spinner"></div></div>
        </div>
      </div>
    </div>
    
    <!-- 일정 관리 (강사) -->
    <div class="screen" id="screen-schedule-manage">
      <div class="header">
        <button class="header-back" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">일정 관리</span>
        <div style="display: flex; align-items: center; gap: 12px;">
          <div class="mode-switch-container">
            <button class="mode-switch-btn active" id="schedule-calendar-btn" onclick="setScheduleViewMode('calendar')">
              <i class="fas fa-calendar-alt"></i>
            </button>
            <button class="mode-switch-btn" id="schedule-list-btn" onclick="setScheduleViewMode('list')">
              <i class="fas fa-list"></i>
            </button>
          </div>
          <button class="header-action" onclick="openScheduleForm()">추가</button>
        </div>
      </div>
      <div class="container">
        <!-- 리스트 모드 -->
        <div id="schedule-list-mode" style="display: none;">
          <div id="schedule-list">
            <div class="loading"><div class="loading-spinner"></div></div>
          </div>
        </div>
        
        <!-- 캘린더 모드 -->
        <div id="schedule-calendar-mode">
          <!-- 캘린더 헤더 -->
          <div class="calendar-header">
            <button class="calendar-nav" onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
            <span class="calendar-title" id="calendar-title">2025년 12월</span>
            <button class="calendar-nav" onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
          </div>
          
          <!-- 캘린더 그리드 -->
          <div class="calendar-grid">
            <div class="calendar-weekdays">
              <span class="weekday sun">일</span>
              <span class="weekday">월</span>
              <span class="weekday">화</span>
              <span class="weekday">수</span>
              <span class="weekday">목</span>
              <span class="weekday">금</span>
              <span class="weekday sat">토</span>
            </div>
            <div class="calendar-days" id="calendar-days"></div>
          </div>
          
          <!-- 범례 -->
          <div class="calendar-legend">
            <span><span style="display: inline-block; width: 10px; height: 10px; background: #BFDBFE; border-radius: 50%; vertical-align: middle;"></span> 강습</span>
            <span><span style="display: inline-block; width: 10px; height: 10px; background: #BBF7D0; border-radius: 50%; vertical-align: middle;"></span> 개인</span>
            <span><span style="display: inline-block; width: 10px; height: 10px; background: #FED7AA; border-radius: 50%; vertical-align: middle;"></span> 드라이</span>
          </div>
          
          <!-- 선택된 날짜 일정 -->
          <div class="selected-date-header" id="selected-date-header">
            <i class="fas fa-calendar"></i> <span id="selected-date-text">12월 19일 (목)</span>
          </div>
          <div id="calendar-schedule-list"></div>
        </div>
      </div>
      <div class="tab-bar">
        <button class="tab-item" onclick="showScreen('screen-instructor-home')"><i class="fas fa-home"></i><span>홈</span></button>
        <button class="tab-item active"><i class="fas fa-calendar"></i><span>일정</span></button>
        <button class="tab-item" onclick="showScreen('screen-dry-manage')"><i class="fas fa-dumbbell"></i><span>트레이닝</span></button>
        <button class="tab-item" onclick="showScreen('screen-my-records')"><i class="fas fa-chart-line"></i><span>내기록</span></button>
        <button class="tab-item" onclick="showScreen('screen-mypage')"><i class="fas fa-user"></i><span>마이</span></button>
      </div>
    </div>

    <!-- 참가자 관리 -->
    <div class="screen" id="screen-participants">
      <div class="header">
        <button class="header-back" onclick="showScreen('screen-schedule-manage')"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">참가자 관리</span>
        <button class="header-action" onclick="openAddParticipant()">추가</button>
      </div>
      <div class="container">
        <div class="card" style="margin-bottom: 20px;">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
            <i class="fas fa-calendar" style="color: var(--primary);"></i>
            <span id="participant-schedule-date" style="font-weight: 600;"></span>
          </div>
          <div style="display: flex; align-items: center; gap: 8px; color: var(--text-secondary);">
            <i class="fas fa-map-marker-alt"></i>
            <span id="participant-schedule-location"></span>
          </div>
        </div>
        <div class="section-title">강습</div>
        <div class="card" id="lesson-participants">
          <div class="loading"><div class="loading-spinner"></div></div>
        </div>
        <div class="section-title" style="margin-top: 20px;">펀다이빙</div>
        <div class="card" id="fun-participants">
          <div style="text-align: center; color: var(--text-secondary); padding: 20px;">펀다이빙 참가자가 없습니다</div>
        </div>
      </div>
    </div>

    <!-- 트레이닝 관리 (강사) -->
    <div class="screen" id="screen-dry-manage">
      <div class="header">
        <button class="header-back" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">트레이닝</span>
        <button class="header-action" id="instructor-training-add-btn" onclick="openDryForm()">추가</button>
      </div>
      <div class="container">
        <!-- 드라이/이미지 탭 -->
        <div class="training-tabs" style="display: flex; gap: 8px; margin-bottom: 20px;">
          <button class="training-tab active" data-tab="dry" onclick="switchInstructorTrainingTab('dry')">
            <i class="fas fa-fire"></i> 드라이
          </button>
          <button class="training-tab" data-tab="image" onclick="switchInstructorTrainingTab('image')">
            <i class="fas fa-images"></i> 이미지
          </button>
        </div>
        
        <!-- 드라이 트레이닝 콘텐츠 -->
        <div id="instructor-dry-content">
          <div class="section-title"><i class="fas fa-list"></i> 트레이닝 목록</div>
          <div id="dry-training-list"></div>
        </div>
        
        <!-- 이미지 트레이닝 콘텐츠 -->
        <div id="instructor-image-content" style="display: none;">
          <div class="section-title"><i class="fas fa-images"></i> 동작 가이드</div>
          <div id="instructor-image-categories">
            <div class="loading"><div class="loading-spinner"></div></div>
          </div>
        </div>
      </div>
      <div class="tab-bar">
        <button class="tab-item" onclick="showScreen('screen-instructor-home')"><i class="fas fa-home"></i><span>홈</span></button>
        <button class="tab-item" onclick="showScreen('screen-schedule-manage')"><i class="fas fa-calendar"></i><span>일정</span></button>
        <button class="tab-item active"><i class="fas fa-dumbbell"></i><span>트레이닝</span></button>
        <button class="tab-item" onclick="showScreen('screen-my-records')"><i class="fas fa-chart-line"></i><span>내기록</span></button>
        <button class="tab-item" onclick="showScreen('screen-mypage')"><i class="fas fa-user"></i><span>마이</span></button>
      </div>
    </div>

    <!-- 강습생 일정 -->
    <div class="screen" id="screen-student-schedule">
      <div class="header">
        <button class="header-back" onclick="showScreen('screen-student-home')"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">일정</span>
        <div class="mode-switch-container">
          <button class="mode-switch-btn active" id="student-calendar-btn" onclick="setStudentScheduleViewMode('calendar')">
            <i class="fas fa-calendar-alt"></i>
          </button>
          <button class="mode-switch-btn" id="student-list-btn" onclick="setStudentScheduleViewMode('list')">
            <i class="fas fa-list"></i>
          </button>
        </div>
      </div>
      <div class="container">
        <!-- 리스트 모드 -->
        <div id="student-schedule-list-mode" style="display: none;">
          <div id="available-schedules">
            <div class="loading"><div class="loading-spinner"></div></div>
          </div>
        </div>
        
        <!-- 캘린더 모드 -->
        <div id="student-schedule-calendar-mode">
          <!-- 캘린더 헤더 -->
          <div class="calendar-header">
            <button class="calendar-nav" onclick="changeStudentMonth(-1)"><i class="fas fa-chevron-left"></i></button>
            <span class="calendar-title" id="student-calendar-title">2025년 12월</span>
            <button class="calendar-nav" onclick="changeStudentMonth(1)"><i class="fas fa-chevron-right"></i></button>
          </div>
          
          <!-- 캘린더 그리드 -->
          <div class="calendar-grid">
            <div class="calendar-weekdays">
              <span class="weekday sun">일</span>
              <span class="weekday">월</span>
              <span class="weekday">화</span>
              <span class="weekday">수</span>
              <span class="weekday">목</span>
              <span class="weekday">금</span>
              <span class="weekday sat">토</span>
            </div>
            <div class="calendar-days" id="student-calendar-days"></div>
          </div>
          
          <!-- 범례 -->
          <div class="calendar-legend">
            <span><span style="display: inline-block; width: 10px; height: 10px; background: #BFDBFE; border-radius: 50%; vertical-align: middle;"></span> 다이빙</span>
            <span><span style="display: inline-block; width: 10px; height: 10px; background: #FED7AA; border-radius: 50%; vertical-align: middle;"></span> 드라이</span>
          </div>
          
          <!-- 선택된 날짜 일정 -->
          <div class="selected-date-header">
            <i class="fas fa-calendar"></i> <span id="student-selected-date-text">12월 19일 (목)</span>
          </div>
          <div id="student-calendar-schedule-list"></div>
        </div>
      </div>
      <div class="tab-bar">
        <button class="tab-item" onclick="showScreen('screen-student-home')"><i class="fas fa-home"></i><span>홈</span></button>
        <button class="tab-item active"><i class="fas fa-calendar"></i><span>일정</span></button>
        <button class="tab-item" onclick="showScreen('screen-dry-training')"><i class="fas fa-dumbbell"></i><span>트레이닝</span></button>
        <button class="tab-item" onclick="showScreen('screen-my-records')"><i class="fas fa-chart-line"></i><span>내기록</span></button>
        <button class="tab-item" onclick="showScreen('screen-mypage')"><i class="fas fa-user"></i><span>마이</span></button>
      </div>
    </div>

    <!-- 학생 일정 상세 화면 -->
    <div class="screen" id="screen-schedule-detail">
      <div class="header">
        <button class="header-back" onclick="showScreen('screen-student-schedule')"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">일정 상세</span>
      </div>
      <div class="container">
        <!-- 일정 정보 -->
        <div class="card" id="schedule-detail-info"></div>
        
        <!-- 기록 보기 (위로 이동) -->
        <div class="card" id="schedule-detail-records" style="display: none;">
          <div class="section-title" style="margin-bottom: 12px;"><i class="fas fa-chart-bar"></i> 이 날의 기록</div>
          <div id="schedule-detail-records-list"></div>
        </div>
        
        <!-- 강사 피드백 (읽기 전용) -->
        <div class="card" id="schedule-detail-instructor-note" style="display: none;">
          <div class="section-title" style="margin-bottom: 8px;"><i class="fas fa-comment"></i> 강사 피드백</div>
          <p id="schedule-detail-instructor-note-text" style="color: var(--text-secondary); font-size: 14px; line-height: 1.5;"></p>
        </div>
        
        <!-- 내 느낀점 입력 -->
        <div class="card">
          <div class="section-title" style="margin-bottom: 8px;"><i class="fas fa-pen"></i> 내 느낀점</div>
          <textarea class="input" id="schedule-detail-my-note" rows="3" placeholder="이 날의 느낀점을 기록해보세요"></textarea>
          <button class="btn btn-primary" style="width: 100%; margin-top: 12px;" onclick="saveStudentNote()">저장</button>
        </div>
      </div>
      <div class="tab-bar">
        <button class="tab-item" onclick="showScreen('screen-student-home')"><i class="fas fa-home"></i><span>홈</span></button>
        <button class="tab-item active"><i class="fas fa-calendar"></i><span>일정</span></button>
        <button class="tab-item" onclick="showScreen('screen-dry-training')"><i class="fas fa-dumbbell"></i><span>트레이닝</span></button>
        <button class="tab-item" onclick="showScreen('screen-my-records')"><i class="fas fa-chart-line"></i><span>내기록</span></button>
        <button class="tab-item" onclick="showScreen('screen-mypage')"><i class="fas fa-user"></i><span>마이</span></button>
      </div>
    </div>

    <!-- 트레이닝 (학생) -->
    <div class="screen" id="screen-dry-training">
      <div class="header">
        <button class="header-back" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">트레이닝</span>
      </div>
      <div class="container">
        <!-- 드라이/이미지 탭 -->
        <div class="training-tabs" style="display: flex; gap: 8px; margin-bottom: 20px;">
          <button class="training-tab active" data-tab="dry" onclick="switchTrainingTab('dry')">
            <i class="fas fa-fire"></i> 드라이
          </button>
          <button class="training-tab" data-tab="image" onclick="switchTrainingTab('image')">
            <i class="fas fa-images"></i> 이미지
          </button>
        </div>
        
        <!-- 드라이 트레이닝 콘텐츠 -->
        <div id="dry-training-content">
          <!-- 프렌젤 리그 카드 -->
          <div id="frenzel-league-training" style="margin-bottom: 20px;"></div>
          
          <!-- 참여 중인 트레이닝 -->
          <div class="section-title"><i class="fas fa-fire"></i> 참여 중</div>
          <div id="my-dry-trainings"></div>
          
          <!-- 이번 달 기록 캘린더 (참여 중일 때만 표시) -->
          <div id="dry-training-calendar-section" style="display: none;">
            <div class="section-title" style="margin-top: 20px;"><i class="fas fa-calendar-check"></i> 이번 달 기록</div>
            <div class="card">
              <div class="calendar-header">
                <button class="calendar-nav" onclick="changeDryListMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                <span class="calendar-title" id="dry-list-calendar-title">2025년 12월</span>
                <button class="calendar-nav" onclick="changeDryListMonth(1)"><i class="fas fa-chevron-right"></i></button>
              </div>
              <div class="calendar-grid">
                <div class="calendar-weekdays">
                  <span class="weekday sun">일</span>
                  <span class="weekday">월</span>
                  <span class="weekday">화</span>
                  <span class="weekday">수</span>
                  <span class="weekday">목</span>
                  <span class="weekday">금</span>
                  <span class="weekday sat">토</span>
                </div>
                <div class="calendar-days" id="dry-list-calendar-days"></div>
              </div>
            </div>
          </div>
          
          <!-- 전체 트레이닝 목록 (참여 안한 것만) -->
          <div id="other-dry-trainings-section" style="display: none;">
            <div class="section-title" style="margin-top: 24px;"><i class="fas fa-list"></i> 참여중이지 않은 트레이닝</div>
            <div id="all-dry-trainings"></div>
          </div>
          
          <!-- 전체 트레이닝 목록 (참여 안했을 때) -->
          <div id="all-dry-trainings-section" style="display: none;">
            <div class="section-title" style="margin-top: 24px;"><i class="fas fa-list"></i> 전체 트레이닝</div>
            <div id="all-dry-trainings-no-participation"></div>
          </div>
        </div>
        
        <!-- 이미지 트레이닝 콘텐츠 -->
        <div id="image-training-content" style="display: none;">
          <div class="section-title"><i class="fas fa-images"></i> 동작 가이드</div>
          <div id="image-training-categories">
            <div class="loading"><div class="loading-spinner"></div></div>
          </div>
        </div>
      </div>
      <div class="tab-bar">
        <button class="tab-item" onclick="showScreen('screen-student-home')"><i class="fas fa-home"></i><span>홈</span></button>
        <button class="tab-item" onclick="showScreen('screen-student-schedule')"><i class="fas fa-calendar"></i><span>일정</span></button>
        <button class="tab-item active"><i class="fas fa-dumbbell"></i><span>트레이닝</span></button>
        <button class="tab-item" onclick="showScreen('screen-my-records')"><i class="fas fa-chart-line"></i><span>내기록</span></button>
        <button class="tab-item" onclick="showScreen('screen-mypage')"><i class="fas fa-user"></i><span>마이</span></button>
      </div>
    </div>
    
    <!-- 이미지 트레이닝 상세 (학생용) - 스와이프 UI -->
    <div class="screen swipe-screen" id="screen-image-training-detail">
      <div class="header">
        <button class="header-back" onclick="showScreen('screen-dry-training'); switchTrainingTab('image');"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title" id="image-training-detail-title">동작 가이드</span>
        <span class="header-action" id="image-step-counter" style="font-size: 14px; color: var(--text-secondary);">1/6</span>
      </div>
      <div class="swipe-container" id="swipe-container">
        <div class="swipe-wrapper" id="swipe-wrapper">
          <!-- 스텝 카드들이 여기에 동적으로 생성됨 -->
        </div>
      </div>
      <div class="swipe-controls">
        <div class="swipe-indicators" id="swipe-indicators">
          <!-- 페이지 인디케이터 -->
        </div>
        <div class="swipe-buttons">
          <button class="swipe-btn" id="swipe-prev" onclick="swipeStep(-1)"><i class="fas fa-chevron-left"></i> 이전</button>
          <button class="swipe-btn" id="swipe-next" onclick="swipeStep(1)">다음 <i class="fas fa-chevron-right"></i></button>
        </div>
      </div>
    </div>
    
    <!-- 이미지 트레이닝 상세 (강사용) - 스와이프 UI -->
    <div class="screen swipe-screen" id="screen-instructor-image-detail">
      <div class="header">
        <button class="header-back" onclick="showScreen('screen-dry-manage'); switchInstructorTrainingTab('image');"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title" id="instructor-image-detail-title">동작 가이드</span>
        <span class="header-action" id="instructor-step-counter" style="font-size: 14px; color: var(--text-secondary);">1/6</span>
      </div>
      <div class="swipe-container" id="instructor-swipe-container">
        <div class="swipe-wrapper" id="instructor-swipe-wrapper">
          <!-- 스텝 카드들이 여기에 동적으로 생성됨 -->
        </div>
      </div>
      <div class="swipe-controls">
        <div class="swipe-indicators" id="instructor-swipe-indicators">
          <!-- 페이지 인디케이터 -->
        </div>
        <div class="swipe-buttons">
          <button class="swipe-btn" onclick="instructorSwipeStep(-1)"><i class="fas fa-chevron-left"></i> 이전</button>
          <button class="swipe-btn" onclick="instructorSwipeStep(1)">다음 <i class="fas fa-chevron-right"></i></button>
        </div>
      </div>
    </div>

    <!-- 드라이 트레이닝 상세 -->
    <div class="screen swipe-screen" id="screen-dry-detail">
      <div class="header">
        <button class="header-back" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title" id="dry-detail-title">트레이닝 상세</span>
        <span class="header-action" id="dry-step-counter" style="font-size: 14px; color: var(--text-secondary);">1/3</span>
      </div>
      
      <!-- 스와이프 컨테이너 -->
      <div class="swipe-container" id="dry-swipe-container">
        <div class="swipe-wrapper" id="dry-swipe-wrapper">
          <!-- 스텝 카드들이 여기에 동적으로 생성됨 -->
        </div>
      </div>
      <div class="swipe-controls">
        <div class="swipe-indicators" id="dry-swipe-indicators">
          <!-- 페이지 인디케이터 -->
        </div>
        <div class="swipe-buttons">
          <button class="swipe-btn" onclick="drySwipeStep(-1)"><i class="fas fa-chevron-left"></i> 이전</button>
          <button class="swipe-btn" onclick="drySwipeStep(1)">다음 <i class="fas fa-chevron-right"></i></button>
        </div>
      </div>
    </div>

    <!-- 나의 기록 -->
    <div class="screen" id="screen-my-records">
      <div class="header">
        <button class="header-back" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">나의 기록</span>
        <div style="display: flex; gap: 8px;">
          <button class="header-action" style="color: var(--text-secondary);" onclick="openPersonalBulkAdd()">일괄</button>
          <button class="header-action" onclick="openPersonalRecordAdd()">추가</button>
        </div>
      </div>
      <div class="container">
        <!-- 성장 그래프 -->
        <div class="card" id="growth-chart-card">
          <div class="section-title" style="margin-bottom: 12px;"><i class="fas fa-chart-line"></i> 성장 그래프</div>
          <div class="discipline-tabs" id="chart-discipline-tabs">
            <button class="disc-tab active" data-disc="STA" onclick="selectChartDiscipline('STA')">STA</button>
            <button class="disc-tab" data-disc="DYNB" onclick="selectChartDiscipline('DYNB')">DYNB</button>
            <button class="disc-tab" data-disc="FIM" onclick="selectChartDiscipline('FIM')">FIM</button>
            <button class="disc-tab" data-disc="CWTB" onclick="selectChartDiscipline('CWTB')">CWTB</button>
          </div>
          <div style="height: 200px; position: relative;">
            <canvas id="growth-chart"></canvas>
          </div>
        </div>
        
        <div class="section-title" style="margin-top: 20px;"><i class="fas fa-trophy"></i> 종목별 최고 기록</div>
        <div class="card" id="my-best-records">
          <div class="loading"><div class="loading-spinner"></div></div>
        </div>
        <div class="section-title" style="margin-top: 20px;"><i class="fas fa-list"></i> 전체 기록</div>
        <div class="card" id="my-all-records">
          <div style="text-align: center; color: var(--text-secondary); padding: 20px;">기록이 없습니다</div>
        </div>
      </div>
      <div class="tab-bar" id="my-records-tabbar">
        <!-- 동적으로 렌더링 -->
      </div>
    </div>

    <!-- Bottom Sheet: 일정 등록 -->
    <div class="bottom-sheet-overlay" id="sheet-schedule">
      <div class="bottom-sheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-content">
          <div class="bottom-sheet-title" id="schedule-form-title">새 일정 등록</div>
          <input type="hidden" id="edit-schedule-id">
          <div class="input-group">
            <label class="input-label">날짜</label>
            <input type="date" class="input" id="schedule-date">
          </div>
          <div class="input-group">
            <label class="input-label">시간</label>
            <select class="input" id="schedule-time">
              <option value="">시간 선택</option>
              <option value="06:00">오전 6:00</option>
              <option value="06:30">오전 6:30</option>
              <option value="07:00">오전 7:00</option>
              <option value="07:30">오전 7:30</option>
              <option value="08:00">오전 8:00</option>
              <option value="08:30">오전 8:30</option>
              <option value="09:00">오전 9:00</option>
              <option value="09:30">오전 9:30</option>
              <option value="10:00">오전 10:00</option>
              <option value="10:30">오전 10:30</option>
              <option value="11:00">오전 11:00</option>
              <option value="11:30">오전 11:30</option>
              <option value="12:00">오후 12:00</option>
              <option value="12:30">오후 12:30</option>
              <option value="13:00">오후 1:00</option>
              <option value="13:30">오후 1:30</option>
              <option value="14:00">오후 2:00</option>
              <option value="14:30">오후 2:30</option>
              <option value="15:00">오후 3:00</option>
              <option value="15:30">오후 3:30</option>
              <option value="16:00">오후 4:00</option>
              <option value="16:30">오후 4:30</option>
              <option value="17:00">오후 5:00</option>
              <option value="17:30">오후 5:30</option>
              <option value="18:00">오후 6:00</option>
              <option value="18:30">오후 6:30</option>
              <option value="19:00">오후 7:00</option>
              <option value="19:30">오후 7:30</option>
              <option value="20:00">오후 8:00</option>
              <option value="20:30">오후 8:30</option>
              <option value="21:00">오후 9:00</option>
            </select>
          </div>
          <div class="input-group">
            <label class="input-label">장소</label>
            <input type="text" class="input" id="schedule-location" placeholder="장소를 입력하세요">
            <div class="frequent-locations" id="frequent-locations">
              <!-- 자주 가는 장소 버튼들 -->
            </div>
          </div>
          
          <!-- 기록 종목 선택 (토글) -->
          <div class="input-group">
            <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleScheduleSection('disc')">
              <label class="input-label" style="margin-bottom: 0;">기록 종목</label>
              <span style="color: var(--text-tertiary); font-size: 13px;" id="schedule-disc-toggle">선택</span>
            </div>
            <div id="schedule-disc-section" style="display: none; margin-top: 8px;">
              <div style="display: flex; flex-wrap: wrap; gap: 4px;" id="schedule-disc-checks">
                <label style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;"><input type="checkbox" value="STA" checked> STA</label>
                <label style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;"><input type="checkbox" value="DYNB" checked> DYNB</label>
                <label style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;"><input type="checkbox" value="FIM" checked> FIM</label>
                <label style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;"><input type="checkbox" value="CWTB" checked> CWTB</label>
                <label style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;"><input type="checkbox" value="DNF"> DNF</label>
                <label style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;"><input type="checkbox" value="CNF"> CNF</label>
                <label style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;"><input type="checkbox" value="DYN"> DYN</label>
                <label style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;"><input type="checkbox" value="CWT"> CWT</label>
              </div>
            </div>
          </div>
          
          <!-- 스킬 종목 선택 (토글) -->
          <div class="input-group">
            <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleScheduleSection('skill')">
              <label class="input-label" style="margin-bottom: 0;">스킬 종목</label>
              <span style="color: var(--text-tertiary); font-size: 13px;" id="schedule-skill-toggle">선택</span>
            </div>
            <div id="schedule-skill-section" style="display: none; margin-top: 8px;">
              <div style="font-size: 12px; color: var(--text-tertiary); margin-bottom: 6px;">Lv2</div>
              <div style="display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 12px;">
                <label style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;"><input type="checkbox" value="레스큐 5-10m"> 레스큐 5-10m</label>
                <label style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;"><input type="checkbox" value="이론 평가"> 이론 평가</label>
              </div>
              <div style="font-size: 12px; color: var(--text-tertiary); margin-bottom: 6px;">Lv3</div>
              <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                <label style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;"><input type="checkbox" value="렌야드 제거"> 렌야드 제거</label>
                <label style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;"><input type="checkbox" value="노마스크 10m"> 노마스크 10m</label>
                <label style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;"><input type="checkbox" value="레스큐+토잉"> 레스큐+토잉</label>
                <label style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;"><input type="checkbox" value="중성부력"> 중성부력</label>
                <label style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;"><input type="checkbox" value="프리폴"> 프리폴</label>
                <label style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;"><input type="checkbox" value="암스온리 15m"> 암스온리 15m</label>
                <label style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;"><input type="checkbox" value="버디 10-15m"> 버디 10-15m</label>
                <label style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;"><input type="checkbox" value="이론 평가_lv3"> 이론 평가</label>
              </div>
            </div>
          </div>
          
          <button class="btn btn-primary" onclick="saveSchedule()">저장하기</button>
          <button class="btn btn-secondary" style="margin-top: 8px;" onclick="closeBottomSheet('sheet-schedule')">취소</button>
        </div>
      </div>
    </div>

    <!-- Bottom Sheet: 참가자 추가 (다중 선택) -->
    <div class="bottom-sheet-overlay" id="sheet-add-participant">
      <div class="bottom-sheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-content">
          <div class="bottom-sheet-title">참가자 추가</div>
          
          <!-- 회원 선택 (다중) -->
          <div class="input-group">
            <label class="input-label">회원 선택</label>
            <div class="multi-select-container" id="member-multi-select">
              <!-- 회원 목록 동적 생성 -->
            </div>
            <div class="selected-count" id="member-selected-count"></div>
          </div>
          
          <!-- 비회원 선택 (토글) -->
          <div class="input-group">
            <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleGuestSection()">
              <label class="input-label" style="margin-bottom: 0; cursor: pointer;">비회원 선택</label>
              <span style="color: var(--text-tertiary); font-size: 13px;" id="guest-section-toggle">
                <span id="guest-toggle-text">펼치기</span> <i class="fas fa-chevron-down" id="guest-toggle-icon"></i>
              </span>
            </div>
            <div id="guest-section-content" style="display: none; margin-top: 8px;">
              <div class="multi-select-container" id="guest-multi-select">
                <!-- 비회원 목록 동적 생성 -->
              </div>
              <div class="selected-count" id="guest-selected-count"></div>
            </div>
          </div>
          
          <div class="input-group">
            <label class="input-label">참가 목적</label>
            <div class="purpose-buttons">
              <button class="purpose-btn selected" data-purpose="강습" onclick="selectPurpose(this)">강습</button>
              <button class="purpose-btn" data-purpose="펀다이빙" onclick="selectPurpose(this)">펀다이빙</button>
            </div>
          </div>
          <div class="input-group" id="lesson-level-group">
            <label class="input-label">강습 레벨</label>
            <select class="input" id="participant-level">
              <option value="1">Level 1</option>
              <option value="2" selected>Level 2</option>
              <option value="3">Level 3</option>
              <option value="4">Level 4</option>
            </select>
          </div>
          <button class="btn btn-primary" onclick="addMultipleParticipants()">추가하기</button>
          <button class="btn btn-secondary" style="margin-top: 8px;" onclick="closeBottomSheet('sheet-add-participant')">취소</button>
        </div>
      </div>
    </div>

    <!-- 일정 관리 (강사용) -->
    <div class="screen" id="screen-schedule-manage">
      <div class="header">
        <button class="header-back" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">일정 관리</span>
        <button class="header-action" onclick="openScheduleForm()">추가</button>
      </div>
      <div class="container">
        <div id="schedule-list">
          <div class="loading"><div class="loading-spinner"></div></div>
        </div>
      </div>
      <div class="tab-bar">
        <button class="tab-item" onclick="showScreen('screen-instructor-home')"><i class="fas fa-home"></i><span>홈</span></button>
        <button class="tab-item active"><i class="fas fa-calendar"></i><span>일정</span></button>
        <button class="tab-item" onclick="showScreen('screen-my-records')"><i class="fas fa-chart-line"></i><span>내기록</span></button>
        <button class="tab-item" onclick="showScreen('screen-mypage')"><i class="fas fa-user"></i><span>마이</span></button>
      </div>
    </div>

    <!-- 참가자 관리 -->
    <div class="screen" id="screen-participants">
      <div class="header">
        <button class="header-back" onclick="showScreen('screen-schedule-manage')"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">참가자 관리</span>
        <button class="header-action" onclick="openAddParticipant()">추가</button>
      </div>
      <div class="container">
        <div class="card" style="margin-bottom: 20px;">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
            <i class="fas fa-calendar" style="color: var(--primary);"></i>
            <span id="participant-schedule-date" style="font-weight: 600;"></span>
          </div>
          <div style="display: flex; align-items: center; gap: 8px; color: var(--text-secondary);">
            <i class="fas fa-map-marker-alt"></i>
            <span id="participant-schedule-location"></span>
          </div>
        </div>
        <button class="btn btn-primary" style="margin-bottom: 20px;" onclick="openBatchRecordInput()">
          <i class="fas fa-pen"></i> 일괄 기록 입력
        </button>
        <div class="section-title">강습</div>
        <div class="card" id="lesson-participants"></div>
        <div class="section-title" style="margin-top: 20px;">펀다이빙</div>
        <div class="card" id="fun-participants"></div>
      </div>
    </div>

    <!-- 강습생 일정 화면 -->
    <div class="screen" id="screen-student-schedule">
      <div class="header">
        <button class="header-back" onclick="showScreen('screen-student-home')"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">일정</span>
      </div>
      <div class="container">
        <div id="student-schedule-list">
          <div class="loading"><div class="loading-spinner"></div></div>
        </div>
      </div>
      <div class="tab-bar">
        <button class="tab-item" onclick="showScreen('screen-student-home')"><i class="fas fa-home"></i><span>홈</span></button>
        <button class="tab-item active"><i class="fas fa-calendar"></i><span>일정</span></button>
        <button class="tab-item" onclick="showScreen('screen-my-records')"><i class="fas fa-chart-line"></i><span>내기록</span></button>
        <button class="tab-item" onclick="showScreen('screen-mypage')"><i class="fas fa-user"></i><span>마이</span></button>
      </div>
    </div>

    <!-- 일괄 기록 입력 화면 (강습) -->
    <div class="screen" id="screen-batch-record">
      <div class="header">
        <button class="header-back" onclick="closeBatchRecord()"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">기록 일괄 입력</span>
      </div>
      <div class="container">
        <!-- 일정 정보 (간소화) -->
        <div class="card" style="margin-bottom: 16px;">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
            <i class="fas fa-calendar" style="color: var(--primary);"></i>
            <span id="batch-schedule-date" style="font-weight: 600;"></span>
          </div>
          <div style="display: flex; align-items: center; gap: 8px; color: var(--text-secondary);">
            <i class="fas fa-map-marker-alt"></i>
            <span id="batch-schedule-location"></span>
          </div>
        </div>
        
        <!-- 기록 입력 카드 -->
        <div class="card" id="batch-record-table-card">
          <!-- 기록 헤더 + 종목 수정 -->
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <div class="section-title" style="margin: 0;"><i class="fas fa-clipboard-list"></i> 기록</div>
            <button style="padding: 4px 10px; background: var(--bg); border: 1px dashed var(--border); border-radius: 10px; font-size: 12px; cursor: pointer;" onclick="openBatchAddDisciplineSheet()">종목 수정</button>
          </div>
          
          <!-- 종목 탭 (compact) -->
          <div id="batch-discipline-tabs" style="margin-bottom: 12px;"></div>
          
          <!-- 기록 테이블 -->
          <div class="record-table-container">
            <table class="record-table" id="batch-record-table">
              <thead>
                <tr>
                  <th class="col-name">학생명</th>
                  <th class="col-attempt">1차</th>
                  <th class="col-attempt">2차</th>
                  <th class="col-add-attempt"><button class="btn-add-col" onclick="addBatchAttemptColumn()">+</button></th>
                  <th class="col-note">메모</th>
                </tr>
              </thead>
              <tbody id="batch-record-tbody"></tbody>
            </table>
          </div>
        </div>
        
        <!-- 스킬 체크 테이블 (숨김 - 사용 안 함) -->
        <div class="card" id="batch-skill-table-card" style="display: none;">
          <div class="record-table-container">
            <table class="record-table" id="batch-skill-table">
              <thead>
                <tr>
                  <th class="col-name">학생명</th>
                </tr>
              </thead>
              <tbody id="batch-skill-tbody"></tbody>
            </table>
          </div>
        </div>
        
        <!-- 노트 섹션 -->
        <div class="card" style="margin-top: 16px;">
          <div class="section-title" style="margin-bottom: 12px;"><i class="fas fa-comment-alt"></i> 노트</div>
          
          <!-- 오늘 총평 (schedules.note) -->
          <div style="margin-bottom: 16px;">
            <label class="input-label">오늘 총평</label>
            <input type="text" class="input" id="batch-schedule-note" placeholder="오늘 강습 전체에 대한 느낀점">
          </div>
          
          <!-- 학생별 피드백 (registrations.note_instructor) -->
          <div>
            <label class="input-label">학생별 피드백</label>
            <div id="batch-student-notes"></div>
          </div>
        </div>
        
        <!-- 저장 버튼 -->
        <div style="display: flex; gap: 12px; margin-top: 20px;">
          <button class="btn btn-secondary" style="flex: 1;" onclick="saveBatchRecords(false)">저장하고 계속</button>
          <button class="btn btn-primary" style="flex: 1;" onclick="saveBatchRecords(true)">저장하고 완료</button>
        </div>
      </div>
    </div>

    <!-- 개인 기록 개별 추가 화면 -->
    <div class="screen" id="screen-personal-record">
      <div class="header">
        <button class="header-back" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">개인 기록 입력</span>
      </div>
      <div class="container">
        <!-- 날짜/장소 정보 -->
        <div class="card" style="margin-bottom: 16px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <div>
              <div style="display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-calendar" style="color: var(--primary);"></i>
                <span id="personal-date-display" style="font-weight: 600;"></span>
              </div>
              <div style="display: flex; align-items: center; gap: 8px; margin-top: 4px; color: var(--text-secondary);">
                <i class="fas fa-map-marker-alt"></i>
                <span id="personal-location-display"></span>
              </div>
            </div>
            <button class="btn btn-outline btn-small" onclick="openPersonalDateEdit()">+ 날짜</button>
          </div>
        </div>
        
        <!-- 기록 테이블 -->
        <div class="card">
          <div class="record-table-container">
            <table class="record-table" id="personal-record-table">
              <thead>
                <tr>
                  <th class="col-name">종목</th>
                  <th class="col-attempt">1차</th>
                  <th class="col-attempt">2차</th>
                </tr>
              </thead>
              <tbody id="personal-record-tbody"></tbody>
            </table>
          </div>
          <div style="display: flex; gap: 8px; margin-top: 12px;">
            <button class="btn btn-outline btn-small" style="flex: 1;" onclick="addPersonalAttemptColumn()">
              <i class="fas fa-plus"></i> 시도 추가
            </button>
            <button class="btn btn-outline btn-small" style="flex: 1;" onclick="openAddDisciplineSheet()">
              <i class="fas fa-plus"></i> 종목 추가
            </button>
          </div>
        </div>
        
        <!-- 메모 -->
        <div class="card" style="margin-top: 16px;">
          <div class="section-title"><i class="fas fa-sticky-note"></i> 메모</div>
          <textarea class="input" id="personal-memo" rows="3" placeholder="이 다이빙에 대한 메모를 남겨보세요... (컨디션, 느낀점, 개선할 점 등)"></textarea>
        </div>
        
        <!-- 저장 버튼 -->
        <div style="display: flex; gap: 12px; margin-top: 20px;">
          <button class="btn btn-secondary" style="flex: 1;" onclick="savePersonalRecord(false)">저장하고 계속</button>
          <button class="btn btn-primary" style="flex: 1;" onclick="savePersonalRecord(true)">저장하고 완료</button>
        </div>
      </div>
    </div>

    <!-- 개인 기록 일괄 추가 화면 -->
    <div class="screen" id="screen-personal-bulk">
      <div class="header">
        <button class="header-back" onclick="showScreen('screen-my-records')"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">일괄 기록 추가</span>
      </div>
      <div class="container">
        <!-- 안내 -->
        <div class="card" style="background: var(--primary-light); margin-bottom: 16px;">
          <div style="display: flex; align-items: flex-start; gap: 12px;">
            <i class="fas fa-info-circle" style="color: var(--primary); margin-top: 2px;"></i>
            <div style="font-size: 14px; color: var(--text-secondary);">
              과거 다이빙 기록을 한번에 입력할 수 있습니다.<br>
              날짜는 <strong>YYMMDD</strong> 형식으로 입력하세요.<br>
              예: 231112 → 2023-11-12
            </div>
          </div>
        </div>
        
        <!-- 날짜/장소 목록 -->
        <div class="section-title"><i class="fas fa-calendar"></i> 날짜/장소 목록</div>
        <div id="bulk-date-list"></div>
        <button class="btn btn-outline" style="margin-top: 8px;" onclick="addBulkDateRow()">
          <i class="fas fa-plus"></i> 날짜 추가
        </button>
        
        <button class="btn btn-primary" style="margin-top: 20px;" onclick="proceedToBulkRecordInput()">
          다음: 기록 입력
        </button>
      </div>
      <div class="tab-bar" id="bulk-tabbar">
        <!-- 동적으로 렌더링 -->
      </div>
    </div>

    <!-- 개인 기록 일괄 입력 화면 (2단계) -->
    <div class="screen" id="screen-personal-bulk-input">
      <div class="header">
        <button class="header-back" onclick="showScreen('screen-personal-bulk')"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">일괄 기록 입력</span>
      </div>
      <div class="container">
        <!-- 날짜 탭 -->
        <div class="participant-tabs" id="bulk-date-tabs"></div>
        
        <!-- 기록 테이블 -->
        <div class="card">
          <div class="record-table-container">
            <table class="record-table" id="bulk-record-table">
              <thead>
                <tr>
                  <th class="col-name">종목</th>
                  <th class="col-attempt">1차</th>
                  <th class="col-attempt">2차</th>
                  <th class="col-add-attempt"><button class="btn-add-col" onclick="addBulkAttemptColumn()">+</button></th>
                </tr>
              </thead>
              <tbody id="bulk-record-tbody"></tbody>
            </table>
          </div>
          <button class="btn btn-outline" style="margin-top: 12px;" onclick="openBulkAddDisciplineSheet()">
            <i class="fas fa-plus"></i> 종목 추가
          </button>
        </div>
        
        <!-- 저장 버튼 -->
        <div style="display: flex; gap: 12px; margin-top: 20px;">
          <button class="btn btn-secondary" style="flex: 1;" onclick="saveBulkRecords(false)">저장하고 계속</button>
          <button class="btn btn-primary" style="flex: 1;" onclick="saveBulkRecords(true)">저장하고 완료</button>
        </div>
      </div>
      <div class="tab-bar" id="bulk-input-tabbar">
        <!-- 동적으로 렌더링 -->
      </div>
    </div>

    <!-- 내 기록 화면 -->
    <div class="screen" id="screen-my-records">
      <div class="header">
        <button class="header-back" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">나의 기록</span>
      </div>
      <div class="container">
        <div class="section-title"><i class="fas fa-trophy"></i> 종목별 최고 기록</div>
        <div class="card" id="my-best-records"></div>
        <div class="section-title" style="margin-top: 20px;"><i class="fas fa-list"></i> 전체 기록</div>
        <div class="card" id="my-all-records"></div>
      </div>
      <div class="tab-bar" id="my-records-tabbar"></div>
    </div>

    <!-- 마이페이지 -->
    <div class="screen" id="screen-mypage">
      <div class="header">
        <button class="header-back" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">마이페이지</span>
      </div>
      <div class="container">
        <div class="card" style="display: flex; align-items: center; gap: 16px;">
          <div class="participant-avatar" style="width: 60px; height: 60px; font-size: 24px;" id="mypage-avatar"></div>
          <div style="flex: 1;">
            <div style="font-size: 20px; font-weight: 700;" id="mypage-name"></div>
            <div style="color: var(--text-secondary); margin-top: 4px;" id="mypage-phone"></div>
            <div style="color: var(--text-tertiary); font-size: 14px; margin-top: 2px;" id="mypage-info"></div>
          </div>
        </div>

    <!-- 자격증 섹션 추가 -->
    <div class="card" style="margin-top: 16px;">
      <div class="section-title" style="margin-bottom: 12px;">
        <i class="fas fa-id-card"></i> 자격증
      </div>
      <div id="cert-image-container">
        <!-- 자격증 이미지 또는 업로드 버튼 -->
      </div>
    </div>

        <button class="btn btn-danger" style="margin-top: 20px;" onclick="logout()">로그아웃</button>
      </div>
    </div>

    <!-- 토스트 -->
    <div class="toast" id="toast"></div>

    <!-- Bottom Sheet: 강습생 일정 신청 -->
    <div class="bottom-sheet-overlay" id="sheet-register">
      <div class="bottom-sheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-content">
          <div class="bottom-sheet-title">일정 신청</div>
          <div class="input-group">
            <label class="input-label">참가 목적</label>
            <div class="purpose-buttons">
              <button class="purpose-btn selected" data-purpose="강습" onclick="selectRegisterPurpose(this)">강습</button>
              <button class="purpose-btn" data-purpose="펀다이빙" onclick="selectRegisterPurpose(this)">펀다이빙</button>
            </div>
          </div>
          <div class="input-group" id="register-level-group">
            <label class="input-label">수강 레벨</label>
            <select class="input" id="register-level">
              <option value="2">Level 2</option>
              <option value="3">Level 3</option>
              <option value="4">Level 4</option>
            </select>
          </div>
          <button class="btn btn-primary" onclick="registerSchedule()">신청하기</button>
        </div>
      </div>
    </div>

    <!-- Bottom Sheet: 최근 일정 선택 (강사용) -->
    <div class="bottom-sheet-overlay" id="sheet-select-schedule">
      <div class="bottom-sheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-content">
          <div class="bottom-sheet-title">일정 선택</div>
          <div id="recent-schedule-list" style="max-height: 300px; overflow-y: auto;"></div>
        </div>
      </div>
    </div>

    <!-- Bottom Sheet: 개인 기록 추가 (날짜/장소 입력) -->
    <div class="bottom-sheet-overlay" id="sheet-personal-add">
      <div class="bottom-sheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-content">
          <div class="bottom-sheet-title">개인 기록 추가</div>
          <div class="input-group">
            <label class="input-label">날짜 *</label>
            <input type="date" class="input" id="personal-add-date">
          </div>
          <div class="input-group">
            <label class="input-label">시간</label>
            <input type="time" class="input" id="personal-add-time">
          </div>
          <div class="input-group">
            <label class="input-label">장소</label>
            <input type="text" class="input" id="personal-add-location" placeholder="장소를 입력하세요">
          </div>
          <div class="input-group">
            <label class="input-label">종목 선택</label>
            <div style="display: flex; flex-wrap: wrap; gap: 8px;" id="personal-discipline-checks">
              <label style="display: flex; align-items: center; gap: 4px;">
                <input type="checkbox" value="STA" checked> STA
              </label>
              <label style="display: flex; align-items: center; gap: 4px;">
                <input type="checkbox" value="DYNB" checked> DYNB
              </label>
              <label style="display: flex; align-items: center; gap: 4px;">
                <input type="checkbox" value="FIM" checked> FIM
              </label>
              <label style="display: flex; align-items: center; gap: 4px;">
                <input type="checkbox" value="CWTB" checked> CWTB
              </label>
              <label style="display: flex; align-items: center; gap: 4px;">
                <input type="checkbox" value="DNF"> DNF
              </label>
              <label style="display: flex; align-items: center; gap: 4px;">
                <input type="checkbox" value="CNF"> CNF
              </label>
              <label style="display: flex; align-items: center; gap: 4px;">
                <input type="checkbox" value="DYN"> DYN
              </label>
              <label style="display: flex; align-items: center; gap: 4px;">
                <input type="checkbox" value="CWT"> CWT
              </label>
            </div>
          </div>
          <button class="btn btn-primary" onclick="startPersonalRecordInput()">다음: 기록 입력</button>
          <button class="btn btn-secondary" style="margin-top: 8px;" onclick="closeBottomSheet('sheet-personal-add')">취소</button>
        </div>
      </div>
    </div>

    <!-- Bottom Sheet: 종목 추가 -->
    <div class="bottom-sheet-overlay" id="sheet-add-discipline">
      <div class="bottom-sheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-content">
          <div class="bottom-sheet-title">종목 추가</div>
          <div style="display: flex; flex-wrap: wrap; gap: 12px;" id="add-discipline-options"></div>
          <button class="btn btn-primary" style="margin-top: 16px;" onclick="confirmAddDiscipline()">추가하기</button>
          <button class="btn btn-secondary" style="margin-top: 8px;" onclick="closeBottomSheet('sheet-add-discipline')">취소</button>
        </div>
      </div>
    </div>

    <!-- Bottom Sheet: 일괄 종목 추가 -->
    <div class="bottom-sheet-overlay" id="sheet-bulk-add-discipline">
      <div class="bottom-sheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-content">
          <div class="bottom-sheet-title">종목 추가</div>
          <div style="display: flex; flex-wrap: wrap; gap: 12px;" id="bulk-add-discipline-options"></div>
          <button class="btn btn-primary" style="margin-top: 16px;" onclick="confirmBulkAddDiscipline()">추가하기</button>
          <button class="btn btn-secondary" style="margin-top: 8px;" onclick="closeBottomSheet('sheet-bulk-add-discipline')">취소</button>
        </div>
      </div>
    </div>

    <!-- Bottom Sheet: 강습 종목 추가 -->
    <div class="bottom-sheet-overlay" id="sheet-batch-add-discipline">
      <div class="bottom-sheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-content">
          <div class="bottom-sheet-title">종목 추가</div>
          <div style="display: flex; flex-wrap: wrap; gap: 12px;" id="batch-add-discipline-options"></div>
          <button class="btn btn-primary" style="margin-top: 16px;" onclick="confirmBatchAddDiscipline()">추가하기</button>
          <button class="btn btn-secondary" style="margin-top: 8px;" onclick="closeBottomSheet('sheet-batch-add-discipline')">취소</button>
        </div>
      </div>
    </div>

    <!-- Bottom Sheet: 드라이 트레이닝 추가/수정 (강사용) -->
    <div class="bottom-sheet-overlay" id="sheet-dry-form">
      <div class="bottom-sheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-content">
          <div class="bottom-sheet-title" id="dry-form-title">새 트레이닝 추가</div>
          <input type="hidden" id="edit-dry-id">
          <div class="input-group">
            <label class="input-label">트레이닝 이름</label>
            <input type="text" class="input" id="dry-name" placeholder="예: 프렌젤 500회">
          </div>
          <div class="input-group">
            <label class="input-label">설명 (선택)</label>
            <textarea class="input" id="dry-description" rows="3" placeholder="트레이닝 방법이나 목표를 설명해주세요"></textarea>
          </div>
          <button class="btn btn-primary" onclick="saveDryTraining()">저장</button>
          <button class="btn btn-secondary" style="margin-top: 8px;" onclick="closeBottomSheet('sheet-dry-form')">취소</button>
        </div>
      </div>
    </div>

    <!-- Bottom Sheet: 드라이 트레이닝 기록 입력 (학생용) -->
    <div class="bottom-sheet-overlay" id="sheet-dry-record">
      <div class="bottom-sheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-content">
          <div class="bottom-sheet-title">오늘 기록</div>
          <div class="input-group">
            <label class="input-label">달성률</label>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;" id="dry-achievement-btns">
              <button class="purpose-btn" data-value="0.5" onclick="selectDryAchievement(this)">50%</button>
              <button class="purpose-btn" data-value="0.7" onclick="selectDryAchievement(this)">70%</button>
              <button class="purpose-btn" data-value="0.8" onclick="selectDryAchievement(this)">80%</button>
              <button class="purpose-btn" data-value="0.9" onclick="selectDryAchievement(this)">90%</button>
              <button class="purpose-btn selected" data-value="1.0" onclick="selectDryAchievement(this)">100%</button>
            </div>
          </div>
          <div class="input-group">
            <label class="input-label">메모 (선택)</label>
            <input type="text" class="input" id="dry-record-note" placeholder="오늘 트레이닝 느낌은?">
          </div>
          <button class="btn btn-primary" onclick="saveDryRecord()">저장</button>
          <button class="btn btn-secondary" style="margin-top: 8px;" onclick="closeBottomSheet('sheet-dry-record')">취소</button>
        </div>
      </div>
    </div>
    
    <!-- 리그 기준 팝업 -->
    <div class="bottom-sheet-overlay" id="league-info-overlay" onclick="closeLeagueInfo()">
      <div class="bottom-sheet" onclick="event.stopPropagation()">
        <div class="bottom-sheet-header">
          <h3>리그 기준</h3>
          <button class="bottom-sheet-close" onclick="closeLeagueInfo()"><i class="fas fa-times"></i></button>
        </div>
        <div class="bottom-sheet-content">
          <div class="league-info-table">
            <table>
              <thead>
                <tr>
                  <th>티어</th>
                  <th>STA</th>
                  <th>CWTB</th>
                  <th>DYN</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><span class="tier-badge tier-whale">🐋 고래</span></td>
                  <td>4'00"+</td>
                  <td>40m+</td>
                  <td>100m+</td>
                </tr>
                <tr>
                  <td><span class="tier-badge tier-dolphin">🐬 돌고래</span></td>
                  <td>3'20"</td>
                  <td>32m</td>
                  <td>75m</td>
                </tr>
                <tr>
                  <td><span class="tier-badge tier-turtle">🐢 거북이</span></td>
                  <td>2'40"</td>
                  <td>24m</td>
                  <td>55m</td>
                </tr>
                <tr>
                  <td><span class="tier-badge tier-seahorse">🐴 해마</span></td>
                  <td>2'00"</td>
                  <td>12m</td>
                  <td>40m</td>
                </tr>
                <tr>
                  <td><span class="tier-badge tier-shrimp">🦐 새우</span></td>
                  <td>1'00"</td>
                  <td>5m</td>
                  <td>20m</td>
                </tr>
                <tr>
                  <td><span class="tier-badge tier-egg">🥚 알</span></td>
                  <td>~59"</td>
                  <td>~4m</td>
                  <td>~19m</td>
                </tr>
              </tbody>
            </table>
          </div>
          <p style="margin-top: 16px; font-size: 13px; color: var(--text-secondary); text-align: center;">
            함께 성장하는 프리다이버들 🌊
          </p>
        </div>
      </div>
    </div>
    
    <!-- 프렌젤 리그 화면 -->
    <div class="screen" id="screen-frenzel-league">
      <div class="header">
        <button class="header-back" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">🎯 프렌젤 리그</span>
      </div>
      <div class="container">
        <!-- 리그 헤더 -->
        <div class="frenzel-league-header">
          <div class="frenzel-icon">🎯</div>
          <div class="frenzel-title">프렌젤 마스터 도전</div>
          <div class="frenzel-subtitle">매일 500번으로 프렌젤 완전정복</div>
        </div>
        
        <!-- 탭 -->
        <div class="frenzel-tabs">
          <button class="frenzel-tab active" onclick="switchFrenzelTab('active')">🔥 도전 중</button>
          <button class="frenzel-tab" onclick="switchFrenzelTab('graduated')">🎓 졸업생</button>
        </div>
        
        <!-- 도전 중 탭 -->
        <div id="frenzel-active-content">
          <div id="frenzel-ranking-list">
            <div class="loading"><div class="loading-spinner"></div></div>
          </div>
        </div>
        
        <!-- 졸업생 탭 -->
        <div id="frenzel-graduated-content" style="display: none;">
          <div id="frenzel-graduates-list"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==================== Supabase 초기화 ====================
    const SUPABASE_URL = 'https://dnndjqlbjudnjpwescfl.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRubmRqcWxianVkbmpwd2VzY2ZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5MzE2NzMsImV4cCI6MjA4MTUwNzY3M30.0x3vKhKzZyn5MPDSoNJgbOvU-LGZ7q34N44DjWLQWz0';
    
    // Supabase 클라이언트 생성 (db로 명명하여 충돌 방지)
    const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ==================== 전역 변수 ====================
    let currentUser = null;
    let currentScheduleId = null;
    let currentRegId = null;
    let allSchedules = [];
    let screenHistory = [];
    let skillsDonutChart = null;
    let recordsDonutChart = null;
    let instructorSelectedDate = new Date().toISOString().split('T')[0]; // 강사 캘린더 선택 날짜

    // ==================== 초기화 ====================
    document.addEventListener('DOMContentLoaded', async function() {
      // 자동 로그인 확인
      const savedUser = localStorage.getItem('divelog_user');
      if (savedUser) {
        try {
          const user = JSON.parse(savedUser);
          // DB에서 최신 정보 확인
          const { data, error } = await db
            .from('users')
            .select('*')
            .eq('user_id', user.user_id)
            .single();
          
          if (data && !error) {
            currentUser = data;
            // 최신 정보로 localStorage 업데이트
            localStorage.setItem('divelog_user', JSON.stringify(currentUser));
            
            if (currentUser.user_type === '강사') {
              showScreen('screen-instructor-home');
            } else {
              showScreen('screen-student-home');
            }
            return;
          } else {
            // 유효하지 않은 저장된 사용자 정보 삭제
            localStorage.removeItem('divelog_user');
          }
        } catch (e) {
          localStorage.removeItem('divelog_user');
        }
      }
      
      const phoneInput = document.getElementById('login-phone');
      
      // 전화번호 자동 포맷팅 (뒷자리만)
      phoneInput.addEventListener('input', function(e) {
        // 숫자만 추출
        let v = e.target.value.replace(/\D/g, '');
        
        // 8자리 제한 (뒷번호만)
        if (v.length > 8) v = v.slice(0, 8);
        
        // 하이픈 추가 (0000-0000 형식)
        if (v.length > 4) {
          v = v.slice(0, 4) + '-' + v.slice(4);
        }
        
        e.target.value = v;
      });

      const overlays = document.querySelectorAll('.bottom-sheet-overlay');
      overlays.forEach(overlay => {
        overlay.addEventListener('click', function(e) {
          if (e.target === this) closeBottomSheet(this.id);
        });
      });
    });

    // ==================== 유틸리티 함수 ====================
    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 3000);
    }

    function showScreen(id) {
      const currentScreen = document.querySelector('.screen.active');
      if (currentScreen && currentScreen.id !== id) {
        screenHistory.push(currentScreen.id);
      }
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      window.scrollTo(0, 0);
      
      // 화면별 로드 함수 호출
      if (id === 'screen-instructor-home') loadInstructorDashboard();
      else if (id === 'screen-student-home') loadStudentDashboard();
      else if (id === 'screen-mypage') loadMypage();
      else if (id === 'screen-schedule-manage') loadScheduleManage();
      else if (id === 'screen-student-schedule') loadStudentSchedule();
      else if (id === 'screen-my-records') loadMyRecords();
      else if (id === 'screen-dry-training') loadDryTraining();
      else if (id === 'screen-dry-manage') loadDryManage();
    }

    function goBack() {
      if (screenHistory.length > 0) {
        const prevScreen = screenHistory.pop();
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(prevScreen).classList.add('active');
      } else {
        if (currentUser && currentUser.user_type === '강사') showScreen('screen-instructor-home');
        else showScreen('screen-student-home');
      }
    }

    function openBottomSheet(id) {
      document.getElementById(id).classList.add('active');
    }

    function closeBottomSheet(id) {
      document.getElementById(id).classList.remove('active');
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      const d = new Date(dateStr);
      const days = ['일', '월', '화', '수', '목', '금', '토'];
      return (d.getMonth()+1) + '월 ' + d.getDate() + '일 (' + days[d.getDay()] + ')';
    }

    function formatTime(timeStr) {
      if (!timeStr) return '';
      const parts = timeStr.split(':');
      const h = parseInt(parts[0]);
      const m = parts[1];
      return (h < 12 ? '오전 ' : '오후 ') + (h > 12 ? h - 12 : h) + ':' + m;
    }

    // ==================== 로그인/로그아웃 ====================
    async function handleLogin() {
      const phoneBack = document.getElementById('login-phone').value.replace(/-/g, '');
      const userId = document.getElementById('login-userid').value.trim();
      
      // 유효성 검사
      if (!phoneBack || phoneBack.length < 8) {
        showToast('연락처를 정확히 입력해주세요');
        return;
      }
      
      if (!userId) {
        showToast('아이디를 입력해주세요');
        return;
      }
      
      // 전체 전화번호 조합 (010-0000-0000 형식)
      const phone = '010-' + phoneBack.slice(0, 4) + '-' + phoneBack.slice(4);
      
      console.log('로그인 시도:', phone, userId);
      
      try {
        // Supabase에서 사용자 조회 (전화번호 + 아이디 둘 다 일치)
        const { data, error } = await db
          .from('users')
          .select('*')
          .eq('phone', phone)
          .eq('user_id', userId)
          .single();
        
        console.log('Supabase 응답:', { data, error });
        
        if (error || !data) {
          showToast('연락처 또는 아이디가 일치하지 않습니다.');
          return;
        }
        
        currentUser = data;
        console.log('로그인 성공:', currentUser);
        
        // 자동 로그인을 위해 localStorage에 저장
        localStorage.setItem('divelog_user', JSON.stringify(currentUser));
        
        if (currentUser.user_type === '강사') {
          showScreen('screen-instructor-home');
        } else {
          showScreen('screen-student-home');
        }
      } catch (err) {
        console.error('로그인 오류:', err);
        showToast('로그인 실패: ' + err.message);
      }
    }

    function logout() {
      currentUser = null;
      screenHistory = [];
      // 자동 로그인 정보 삭제
      localStorage.removeItem('divelog_user');
      showScreen('screen-login');
      document.getElementById('login-phone').value = '';
      document.getElementById('login-userid').value = '';
    }

    // ==================== 강사 대시보드 ====================
    async function loadInstructorDashboard() {
      document.getElementById('instructor-name').textContent = currentUser.name;
      await loadTodaySchedules();
      await loadInstructorStats();
    }

    async function loadTodaySchedules() {
      try {
        const today = new Date().toISOString().split('T')[0];
        
        // 오늘 일정 조회
        const { data: schedules, error } = await db
          .from('schedules')
          .select('*')
          .eq('instructor_id', currentUser.user_id)
          .eq('date', today);
        
        if (error) throw error;
        
        const container = document.getElementById('today-schedules');
        
        if (!schedules || schedules.length === 0) {
          container.innerHTML = '<div class="card" style="text-align: center; color: var(--text-secondary);">오늘 일정이 없습니다</div>';
          return;
        }
        
        // 각 일정에 참가자 수 추가
        let html = '';
        for (const s of schedules) {
          // 참가자 수 조회
          const { count } = await db
            .from('registrations')
            .select('*', { count: 'exact', head: true })
            .eq('schedule_id', s.schedule_id);
          
          html += `<div class="card schedule-card" style="cursor:pointer;" onclick="openParticipants('${s.schedule_id}')">`;
          html += '<div class="schedule-info">';
          html += `<div class="schedule-time">${formatTime(s.time)} · ${s.location}</div>`;
          html += `<div class="schedule-meta">참가자 ${count || 0}명</div>`;
          html += '</div>';
          html += '<i class="fas fa-chevron-right schedule-arrow"></i>';
          html += '</div>';
        }
        
        container.innerHTML = html;
        allSchedules = schedules;
      } catch (err) {
        console.error('일정 로드 오류:', err);
        document.getElementById('today-schedules').innerHTML = '<div class="card" style="text-align: center; color: var(--error);">일정을 불러오지 못했습니다</div>';
      }
    }

    async function loadInstructorStats() {
      try {
        // 이번 주 시작일 계산
        const now = new Date();
        const weekStart = new Date(now);
        weekStart.setDate(now.getDate() - now.getDay());
        weekStart.setHours(0, 0, 0, 0);
        const weekStartStr = weekStart.toISOString().split('T')[0];
        
        // 이번 주 일정 수
        const { count: weekLessons } = await db
          .from('schedules')
          .select('*', { count: 'exact', head: true })
          .eq('instructor_id', currentUser.user_id)
          .gte('date', weekStartStr);
        
        // 이번 주 일정 ID 조회
        const { data: weekSchedules } = await db
          .from('schedules')
          .select('schedule_id')
          .eq('instructor_id', currentUser.user_id)
          .gte('date', weekStartStr);
        
        let weekStudents = 0;
        let weekRecords = 0;
        
        if (weekSchedules && weekSchedules.length > 0) {
          const scheduleIds = weekSchedules.map(s => s.schedule_id);
          
          // 이번 주 참가자 수
          const { count: studentCount } = await db
            .from('registrations')
            .select('*', { count: 'exact', head: true })
            .in('schedule_id', scheduleIds);
          weekStudents = studentCount || 0;
          
          // 이번 주 reg_id 조회
          const { data: regs } = await db
            .from('registrations')
            .select('reg_id')
            .in('schedule_id', scheduleIds);
          
          if (regs && regs.length > 0) {
            const regIds = regs.map(r => r.reg_id);
            
            // 이번 주 기록 수
            const { count: recordCount } = await db
              .from('dive_records')
              .select('*', { count: 'exact', head: true })
              .in('reg_id', regIds);
            weekRecords = recordCount || 0;
          }
        }
        
        document.getElementById('instructor-stats').innerHTML = 
          `강습 ${weekLessons || 0}회 · 강습생 ${weekStudents}명 · 기록 ${weekRecords}건`;
      } catch (err) {
        console.error('통계 로드 오류:', err);
        document.getElementById('instructor-stats').innerHTML = '통계를 불러오지 못했습니다';
      }
    }

    // ==================== 강습생 대시보드 ====================
    async function loadStudentDashboard() {
      document.getElementById('student-name').textContent = currentUser.name;
      
      // 진도율 로드 (in_training_level이 있으면)
      await loadLevelProgress();
      
      // 최고 기록 조회
      await loadBestRecords();
      
      // 다가오는 일정 조회
      await loadUpcomingSchedules();
      
      // 드라이 트레이닝 로드
      await loadHomeDryTraining();
      
      // 리그 랭크 로드 (프렌젤 리그 포함)
      await loadMyLeagueCards();
    }
    
    // ==================== 리그 랭크 시스템 ====================
    const TIER_SYSTEM = {
      tiers: [
        { tier: 0, name: '알', emoji: '🥚', color: '#E0E0E0' },
        { tier: 1, name: '새우', emoji: '🦐', color: '#FF8A65' },
        { tier: 2, name: '해마', emoji: '🐴', color: '#4FC3F7' },
        { tier: 3, name: '거북이', emoji: '🐢', color: '#81C784' },
        { tier: 4, name: '돌고래', emoji: '🐬', color: '#BA68C8' },
        { tier: 5, name: '고래', emoji: '🐋', color: '#FFD54F' }
      ],
      thresholds: {
        STA: [60, 120, 160, 200, 240],      // 1분, 2분, 2분40초, 3분20초, 4분 (초 단위)
        CWTB: [5, 12, 24, 32, 40],          // 미터
        FIM: [5, 12, 24, 32, 40],           // 미터
        DYNB: [20, 40, 55, 75, 100]         // 미터
      },
      ranges: {
        STA: ["0' ~ 59\"", "1'00\" ~ 1'59\"", "2'00\" ~ 2'39\"", "2'40\" ~ 3'19\"", "3'20\" ~ 3'59\"", "4'00\"+"],
        CWTB: ["0m ~ 4m", "5m ~ 11m", "12m ~ 23m", "24m ~ 31m", "32m ~ 39m", "40m+"],
        FIM: ["0m ~ 4m", "5m ~ 11m", "12m ~ 23m", "24m ~ 31m", "32m ~ 39m", "40m+"],
        DYNB: ["0m ~ 19m", "20m ~ 39m", "40m ~ 54m", "55m ~ 74m", "75m ~ 99m", "100m+"]
      }
    };
    
    let currentLeagueDisc = 'STA';
    let currentLeagueTier = 1;
    let myBestRecords = {};
    
    // 기록으로 티어 계산
    function calculateTier(discipline, value) {
      if (!value || value <= 0) return -1; // 기록 없음 (-1)
      
      const thresholds = TIER_SYSTEM.thresholds[discipline];
      if (!thresholds) return -1;
      
      for (let i = thresholds.length - 1; i >= 0; i--) {
        if (value >= thresholds[i]) return i + 1;
      }
      return 0; // 기록은 있지만 1티어 미만 = 알(0티어)
    }
    
    // 티어 정보 가져오기
    function getTierInfo(tier) {
      if (tier < 0) return { tier: -1, name: '기록없음', emoji: '❓', color: '#B0B8C1' };
      if (tier === 0) return TIER_SYSTEM.tiers[0]; // 알
      return TIER_SYSTEM.tiers[tier] || TIER_SYSTEM.tiers[0];
    }
    
    // 티어 범위 가져오기
    function getTierRange(discipline, tier) {
      const ranges = TIER_SYSTEM.ranges[discipline];
      if (!ranges || tier <= 0) return '';
      return ranges[tier] || ranges[ranges.length - 1];
    }
    
    // 기록 포맷팅
    function formatRecordValue(discipline, value) {
      if (!value) return '-';
      if (discipline === 'STA') {
        const min = Math.floor(value / 60);
        const sec = value % 60;
        return `${min}'${sec.toString().padStart(2, '0')}"`;
      }
      return `${value}m`;
    }
    
    // 나의 리그 카드 로드
    async function loadMyLeagueCards() {
      const container = document.getElementById('my-league-cards');
      if (!container) return;
      
      try {
        // currentUser에서 최고 기록 가져오기
        // FIM은 별도 컬럼이 없으면 CWTB와 같은 값 사용하거나 0
        myBestRecords = {
          'STA': currentUser.best_sta || 0,
          'CWTB': currentUser.best_cwtb || 0,
          'FIM': currentUser.best_fim || currentUser.best_cwtb || 0, // FIM 없으면 CWTB 사용
          'DYNB': currentUser.best_dynb || 0
        };
        
        // 카드 렌더링 (FIM 제외 - 별도 관리 안하면)
        const disciplines = ['STA', 'CWTB', 'DYNB'];
        let html = '';
        
        for (const disc of disciplines) {
          const value = myBestRecords[disc] || 0;
          const tier = calculateTier(disc, value);
          const tierInfo = getTierInfo(tier);
          const displayDisc = disc;
          
          html += `<div class="league-card tier-${tier}" onclick="openLeagueRanking('${disc}', ${tier})">
            <div class="league-card-disc">${displayDisc}</div>
            <div class="league-card-emoji">${tierInfo.emoji}</div>
            <div class="league-card-tier">${tierInfo.name}</div>
            <div class="league-card-record">${formatRecordValue(disc, value)}</div>
          </div>`;
        }
        
        // 프렌젤 리그 카드 추가
        const frenzelCard = await renderFrenzelLeagueCard();
        html += frenzelCard;
        
        container.innerHTML = html;
      } catch (err) {
        console.error('리그 카드 로드 오류:', err);
        container.innerHTML = `<div style="color: var(--text-secondary); font-size: 14px;">리그 정보를 불러오지 못했습니다</div>`;
      }
    }
    
    // 리그 랭킹 화면 열기
    async function openLeagueRanking(discipline, tier) {
      if (tier < 0) {
        showToast('기록이 있어야 리그에 참여할 수 있어요!');
        return;
      }
      
      currentLeagueDisc = discipline;
      currentLeagueTier = tier;
      
      showScreen('screen-league-ranking');
      updateLeagueHeader();
      updateLeagueDiscTabs();
      await loadLeagueRanking();
    }
    
    // 리그 헤더 업데이트
    function updateLeagueHeader() {
      const tierInfo = getTierInfo(currentLeagueTier);
      const range = getTierRange(currentLeagueDisc, currentLeagueTier);
      const displayDisc = currentLeagueDisc === 'DYNB' ? 'DYN' : currentLeagueDisc;
      
      document.getElementById('league-header').innerHTML = `
        <div class="league-header-emoji">${tierInfo.emoji}</div>
        <div class="league-header-title">${tierInfo.name} 리그</div>
        <div class="league-header-subtitle">${displayDisc}</div>
        <div class="league-header-range">${range}</div>
      `;
      document.getElementById('league-header').style.background = 
        `linear-gradient(135deg, ${tierInfo.color} 0%, ${tierInfo.color}99 100%)`;
      
      document.getElementById('league-screen-title').textContent = `${tierInfo.name} 리그`;
    }
    
    // 종목 탭 업데이트
    function updateLeagueDiscTabs() {
      document.querySelectorAll('#league-disc-tabs .league-tab').forEach(tab => {
        const disc = tab.dataset.disc;
        const myTier = calculateTier(disc, myBestRecords[disc] || 0);
        tab.classList.toggle('active', disc === currentLeagueDisc);
        
        // 내가 속한 티어가 있는 종목만 활성화 (0티어=알 포함)
        if (myTier >= 0) {
          tab.style.opacity = '1';
          tab.style.pointerEvents = 'auto';
        } else {
          tab.style.opacity = '0.5';
          tab.style.pointerEvents = 'none';
        }
      });
    }
    
    // 종목 전환
    async function switchLeagueDisc(discipline) {
      const myTier = calculateTier(discipline, myBestRecords[discipline] || 0);
      if (myTier < 0) return;  // -1(기록없음)만 제외
      
      currentLeagueDisc = discipline;
      currentLeagueTier = myTier;
      
      updateLeagueHeader();
      updateLeagueDiscTabs();
      await loadLeagueRanking();
    }
    
    // 리그 랭킹 로드 (같은 티어만)
    async function loadLeagueRanking() {
      const container = document.getElementById('league-ranking-list');
      container.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';
      
      try {
        const thresholds = TIER_SYSTEM.thresholds[currentLeagueDisc];
        
        // 0티어(알)는 1 ~ (1티어 기준-1) 범위
        let minValue, maxValue;
        if (currentLeagueTier === 0) {
          minValue = 1;
          maxValue = thresholds[0] - 1;
        } else {
          minValue = thresholds[currentLeagueTier - 1];
          maxValue = currentLeagueTier < 5 ? thresholds[currentLeagueTier] - 1 : 999999;
        }
        
        // 종목에 따른 best_ 필드명 결정
        const bestField = 'best_' + currentLeagueDisc.toLowerCase();
        
        // users 테이블에서 해당 종목의 최고 기록이 있는 유저들 조회
        const { data: users, error } = await db
          .from('users')
          .select(`user_id, name, ${bestField}`)
          .gte(bestField, minValue)
          .lte(bestField, maxValue)
          .order(bestField, { ascending: false });
        
        if (error) throw error;
        
        // 유효한 기록이 있는 유저만 필터링
        let rankings = (users || []).filter(u => u[bestField] && u[bestField] > 0);
        
        // 같은 기록일 때 본인 우선 정렬
        rankings.sort((a, b) => {
          if (b[bestField] !== a[bestField]) {
            return b[bestField] - a[bestField]; // 기록 높은 순
          }
          // 같은 기록이면 본인 우선
          if (a.user_id === currentUser.user_id) return -1;
          if (b.user_id === currentUser.user_id) return 1;
          return a.name.localeCompare(b.name); // 그 외엔 이름순
        });
        
        if (rankings.length === 0) {
          container.innerHTML = `<div style="text-align: center; color: var(--text-secondary); padding: 40px;">
            이 리그에 참가자가 없습니다
          </div>`;
          return;
        }
        
        let html = '';
        rankings.forEach((u, idx) => {
          const isMe = u.user_id === currentUser.user_id;
          const posClass = idx === 0 ? 'top1' : idx === 1 ? 'top2' : idx === 2 ? 'top3' : '';
          const name = u.name || '알 수 없음';
          const recordValue = u[bestField];
          
          html += `<div class="ranking-item ${isMe ? 'me' : ''}">
            <div class="ranking-position ${posClass}">${idx + 1}</div>
            <div class="ranking-avatar">${name.charAt(0)}</div>
            <div class="ranking-info">
              <div class="ranking-name">${name}${isMe ? ' (나)' : ''}</div>
            </div>
            <div class="ranking-record">${formatRecordValue(currentLeagueDisc, recordValue)}</div>
          </div>`;
        });
        
        container.innerHTML = html;
      } catch (err) {
        console.error('리그 랭킹 로드 오류:', err);
        container.innerHTML = `<div style="text-align: center; color: var(--error); padding: 20px;">
          랭킹을 불러오지 못했습니다
        </div>`;
      }
    }
    
    // 리그 기준 팝업 열기
    function openLeagueInfo() {
      document.getElementById('league-info-overlay').classList.add('active');
      document.getElementById('league-info-sheet').classList.add('active');
    }
    
    // 리그 기준 팝업 닫기
    function closeLeagueInfo() {
      document.getElementById('league-info-overlay').classList.remove('active');
      document.getElementById('league-info-sheet').classList.remove('active');
    }
    
    // 레벨별 요구사항 정의
    const LEVEL_REQUIREMENTS = {
      2: {
        skills: [
          { key: 'rescue_5_10m', name: '레스큐 5-10m' },
          { key: 'theory_test_lv2', name: '이론 평가' }
        ],
        records: [
          { key: 'sta', name: 'STA', target: 120, unit: '초', display: "2'00\"" },  // 2분 = 120초
          { key: 'dynb', name: 'DYNB', target: 40, unit: 'm', display: '40m' },
          { key: 'cwtb', name: 'CWTB', target: 12, unit: 'm', display: '12m' }
        ],
        lessonRequired: 3
      },
      3: {
        skills: [
          { key: 'lanyard_remove', name: '랜야드 제거' },
          { key: 'no_mask_10m', name: '노마스크 10m' },
          { key: 'rescue_towing', name: '레스큐 10-15m + 토잉 50m' },
          { key: 'neutral_buoyancy', name: '중성부력' },
          { key: 'freefall', name: '프리폴' },
          { key: 'arms_only_15m', name: '암스 온리 15m' },
          { key: 'buddy_10_15m', name: '적절한 버디 10-15m' },
          { key: 'theory_test', name: '이론 평가' }
        ],
        records: [
          { key: 'sta', name: 'STA', target: 165, unit: '초', display: "2'45\"" },  // 2분45초 = 165초
          { key: 'dynb', name: 'DYNB', target: 55, unit: 'm', display: '55m' },
          { key: 'cwtb', name: 'CWTB', target: 24, unit: 'm', display: '24m' }
        ],
        lessonRequired: 4
      }
    };
    
    // 진도율 차트 인스턴스
    let skillsChartInstance = null;
    let recordsChartInstance = null;
    
    // 진도율 로드
    async function loadLevelProgress() {
      const level = currentUser.in_training_level;
      const section = document.getElementById('level-progress-section');
      
      // 레벨 과정 중이 아니면 숨김
      if (!level || (level !== 2 && level !== 3)) {
        section.style.display = 'none';
        return;
      }
      
      section.style.display = 'block';
      
      const req = LEVEL_REQUIREMENTS[level];
      const tableName = level === 2 ? 'lv2_progress' : 'lv3_progress';
      
      try {
        // 진도 데이터 조회
        const { data: progress } = await db
          .from(tableName)
          .select('*')
          .eq('user_id', currentUser.user_id)
          .single();
        
        // 스킬 완료 계산
        let skillsDone = 0;
        const skillsTotal = req.skills.length;
        const skillItems = [];
        
        for (const skill of req.skills) {
          const isDone = progress && progress[skill.key] === 'Y';
          const attempts = progress ? (progress[skill.key + '_attempts'] || 0) : 0;
          if (isDone) skillsDone++;
          skillItems.push({ name: skill.name, done: isDone, attempts: attempts });
        }
        
        // 기록 달성률 계산
        let totalRecordPercent = 0;
        const recordItems = [];
        
        for (const rec of req.records) {
          const value = progress ? progress[rec.key] : null;
          let percent = 0;
          
          if (value && value > 0) {
            percent = Math.min(100, Math.round((value / rec.target) * 100));
          }
          
          totalRecordPercent += percent;
          recordItems.push({
            name: rec.name,
            target: rec.display,
            percent: percent,
            done: percent >= 100,
            currentValue: value,  // 현재 기록 값 추가
            unit: rec.unit || ''  // 단위 추가
          });
        }
        
        const avgRecordPercent = Math.round(totalRecordPercent / req.records.length);
        
        // 강습 횟수
        const lessonCount = progress?.lesson_count || 0;
        const lessonDone = lessonCount >= req.lessonRequired;
        
        // 타이틀 및 요약 업데이트
        document.getElementById('level-progress-title').innerHTML = `<i class="fas fa-graduation-cap"></i> Level ${level} 진도`;
        document.getElementById('level-progress-summary').innerHTML = `
          강습 ${lessonCount}/${req.lessonRequired}회 ${lessonDone ? '<i class="fas fa-check" style="color: var(--success);"></i>' : ''} · 
          스킬 ${skillsDone}/${skillsTotal} · 
          기록 ${avgRecordPercent}%
        `;
        
        // 도넛 차트 색상
        const lvColor = level === 2 ? '#FF9100' : '#00C853';
        const lvColorLight = level === 2 ? '#FFF3E0' : '#E8F5E9';
        
        // 스킬 차트 렌더링
        renderDonutChart('skills-chart', skillsDone, skillsTotal, lvColor, lvColorLight, 'skillsChartInstance');
        document.getElementById('skills-progress-value').textContent = `${skillsDone}/${skillsTotal}`;
        document.getElementById('skills-progress-value').className = `donut-value lv${level}`;
        
        // 스킬 체크리스트 렌더링
        let skillsHtml = '';
        for (const item of skillItems) {
          const attemptsText = item.attempts > 0 ? `${item.attempts}회` : '-';
          skillsHtml += `
            <div class="checklist-item">
              <div class="checklist-icon ${item.done ? 'done' : 'undone'}">
                <i class="fas fa-${item.done ? 'check' : 'circle'}"></i>
              </div>
              <span class="checklist-text ${item.done ? 'done' : ''}">${item.name}</span>
              <span class="checklist-badge" style="min-width: 40px; text-align: right;">${attemptsText}</span>
            </div>
          `;
        }
        document.getElementById('skills-checklist').innerHTML = skillsHtml;
        
        // 기록 차트 렌더링
        renderDonutChart('records-chart', avgRecordPercent, 100, lvColor, lvColorLight, 'recordsChartInstance');
        document.getElementById('records-progress-value').textContent = `${avgRecordPercent}%`;
        document.getElementById('records-progress-value').className = `donut-value lv${level}`;
        document.querySelector('#records-chart').parentElement.nextElementSibling.querySelector('.donut-label')?.remove;
        
        // 기록 체크리스트 렌더링
        let recordsHtml = '';
        for (const item of recordItems) {
          // 현재 기록 포맷팅
          let currentDisplay = '-';
          if (item.currentValue && item.currentValue > 0) {
            if (item.name === 'STA') {
              // STA는 초를 분:초로 변환
              const mins = Math.floor(item.currentValue / 60);
              const secs = item.currentValue % 60;
              currentDisplay = `${mins}'${secs.toString().padStart(2, '0')}"`;
            } else {
              // DYNB, CWTB 등은 m 단위
              currentDisplay = `${item.currentValue}m`;
            }
          }
          
          recordsHtml += `
            <div class="checklist-item">
              <div class="checklist-icon ${item.done ? 'done' : 'undone'}">
                <i class="fas fa-${item.done ? 'check' : 'circle'}"></i>
              </div>
              <span class="checklist-text">${item.name} ≥ ${item.target}</span>
              <span class="checklist-badge" style="min-width: 50px; text-align: right;">${currentDisplay}</span>
            </div>
          `;
        }
        document.getElementById('records-checklist').innerHTML = recordsHtml;
        
      } catch (err) {
        console.error('진도율 로드 오류:', err);
        section.style.display = 'none';
      }
    }
    
    // 도넛 차트 렌더링
    function renderDonutChart(canvasId, value, total, color, bgColor, instanceVar) {
      const canvas = document.getElementById(canvasId);
      const ctx = canvas.getContext('2d');
      
      // 기존 차트 파괴
      if (instanceVar === 'skillsChartInstance' && skillsChartInstance) {
        skillsChartInstance.destroy();
      } else if (instanceVar === 'recordsChartInstance' && recordsChartInstance) {
        recordsChartInstance.destroy();
      }
      
      const chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          datasets: [{
            data: [value, Math.max(0, total - value)],
            backgroundColor: [color, bgColor],
            borderWidth: 0
          }]
        },
        options: {
          cutout: '70%',
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { display: false },
            tooltip: { enabled: false }
          }
        }
      });
      
      if (instanceVar === 'skillsChartInstance') {
        skillsChartInstance = chart;
      } else if (instanceVar === 'recordsChartInstance') {
        recordsChartInstance = chart;
      }
    }

    async function loadBestRecords() {
      try {
        const disciplines = ['STA', 'CWTB', 'DYNB'];
        let bestHtml = '';
        
        for (const disc of disciplines) {
          const key = 'best_' + disc.toLowerCase();
          const value = currentUser[key];
          
          let displayVal = '-';
          if (value && value > 0) {
            if (disc === 'STA') {
              // STA는 초 단위를 분'초" 형식으로 변환
              const minutes = Math.floor(value / 60);
              const seconds = Math.floor(value % 60);
              displayVal = `${minutes}'${seconds.toString().padStart(2, '0')}"`;
            } else {
              displayVal = value + 'm';
            }
          }
          
          bestHtml += `<div class="stat-card">
            <div class="stat-label">${disc}</div>
            <div class="stat-value">${displayVal}</div>
          </div>`;
        }
        
        document.getElementById('best-records').innerHTML = bestHtml;
      } catch (err) {
        console.error('최고 기록 로드 오류:', err);
      }
    }

    async function loadUpcomingSchedules() {
      try {
        const today = new Date().toISOString().split('T')[0];
        
        // 학생의 등록된 일정 조회
        const { data: regs } = await db
          .from('registrations')
          .select(`
            reg_id,
            purpose,
            schedule_id,
            schedules (
              schedule_id,
              date,
              time,
              location
            )
          `)
          .eq('student_id', currentUser.user_id);
        
        const container = document.getElementById('upcoming-schedules');
        
        if (!regs || regs.length === 0) {
          container.innerHTML = '<div class="card" style="text-align: center; color: var(--text-secondary);">예정된 일정이 없습니다</div>';
          return;
        }
        
        // 미래 일정만 필터링
        const upcoming = regs
          .filter(r => r.schedules && r.schedules.date >= today)
          .sort((a, b) => new Date(a.schedules.date) - new Date(b.schedules.date))
          .slice(0, 3);
        
        if (upcoming.length === 0) {
          container.innerHTML = '<div class="card" style="text-align: center; color: var(--text-secondary);">예정된 일정이 없습니다</div>';
          return;
        }
        
        let html = '';
        for (const r of upcoming) {
          const s = r.schedules;
          html += `<div class="card schedule-card" onclick="openScheduleDetail('${r.reg_id}')" style="cursor: pointer;">
            <div class="schedule-info">
              <div class="schedule-time">${formatDate(s.date)} ${formatTime(s.time)}</div>
              <div class="schedule-location">${s.location} · ${r.purpose}</div>
            </div>
            <i class="fas fa-chevron-right schedule-arrow"></i>
          </div>`;
        }
        
        container.innerHTML = html;
      } catch (err) {
        console.error('일정 로드 오류:', err);
        document.getElementById('upcoming-schedules').innerHTML = '<div class="card" style="text-align: center; color: var(--error);">일정을 불러오지 못했습니다</div>';
      }
    }

    // ==================== 마이페이지 ====================
    function loadMypage() {
      document.getElementById('mypage-avatar').textContent = currentUser.name ? currentUser.name.charAt(0) : '?';
      document.getElementById('mypage-name').textContent = currentUser.name;
      document.getElementById('mypage-phone').textContent = currentUser.phone;
      document.getElementById('mypage-info').textContent = 'Level ' + (currentUser.cert_level === 'X' ? '1' : currentUser.cert_level) + ' · ' + currentUser.user_type;

  // 자격증 이미지 렌더링 추가
  renderCertImage();   
 }

    // ==================== 일정 관리 (강사) ====================
    async function loadScheduleManage() {
      try {
        const { data: schedules, error } = await db
          .from('schedules')
          .select('*')
          .eq('instructor_id', currentUser.user_id)
          .order('date', { ascending: false });
        
        if (error) throw error;
        
        allSchedules = schedules || [];
        renderScheduleList();
        // 캘린더형이 기본이므로 캘린더도 렌더링
        renderCalendar();
      } catch (err) {
        console.error('일정 로드 오류:', err);
        document.getElementById('schedule-list').innerHTML = 
          '<div class="card" style="text-align: center; color: var(--error);">일정을 불러오지 못했습니다</div>';
      }
    }

    async function renderScheduleList() {
      const container = document.getElementById('schedule-list');
      
      if (allSchedules.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="fas fa-calendar-times"></i><p>일정이 없습니다</p></div>';
        return;
      }
      
      const today = new Date().toISOString().split('T')[0];
      
      // 일정 분류
      const pastSchedules = allSchedules.filter(s => s.date < today);
      const todaySchedules = allSchedules.filter(s => s.date === today);
      const futureSchedules = allSchedules.filter(s => s.date > today);
      
      let html = '';
      
      // 다가올 일정 (미래 → 날짜순)
      if (futureSchedules.length > 0) {
        html += '<div class="schedule-section-title"><i class="fas fa-arrow-right"></i> 다가올 일정</div>';
        for (const s of futureSchedules.sort((a, b) => a.date.localeCompare(b.date))) {
          html += await renderScheduleCard(s);
        }
      }
      
      // 오늘 일정
      if (todaySchedules.length > 0) {
        html += '<div class="schedule-section-title"><i class="fas fa-clock"></i> 오늘 일정</div>';
        for (const s of todaySchedules) {
          html += await renderScheduleCard(s);
        }
      }
      
      // 지난 일정 (과거 → 최신순)
      if (pastSchedules.length > 0) {
        html += '<div class="schedule-section-title"><i class="fas fa-check"></i> 지난 일정</div>';
        for (const s of pastSchedules.sort((a, b) => b.date.localeCompare(a.date))) {
          html += await renderScheduleCard(s);
        }
      }
      
      container.innerHTML = html;
    }

    async function renderScheduleCard(s) {
      // 참가자 정보 조회 (강습/펀 구분, 레벨)
      const { data: regs } = await db
        .from('registrations')
        .select('purpose, lesson_level')
        .eq('schedule_id', s.schedule_id);
      
      // 강습생 수와 레벨, 펀다이빙 수
      const lessonRegs = (regs || []).filter(r => r.purpose === '강습');
      const funRegs = (regs || []).filter(r => r.purpose === '펀다이빙');
      const lessonLevels = [...new Set(lessonRegs.map(r => r.lesson_level).filter(l => l))].sort();
      
      let participantText = s.location;
      if (lessonRegs.length > 0 || funRegs.length > 0) {
        participantText += ' · ';
        if (lessonRegs.length > 0) {
          participantText += `강습 ${lessonRegs.length}명`;
          if (lessonLevels.length > 0) {
            participantText += `(${lessonLevels.map(l => 'Lv' + l).join(', ')})`;
          }
        }
        if (funRegs.length > 0) {
          if (lessonRegs.length > 0) participantText += ' · ';
          participantText += `펀 ${funRegs.length}명`;
        }
      }
      
      return `<div class="card">
        <div class="schedule-card" style="margin-bottom: 12px;">
          <div class="schedule-info" style="flex: 1;">
            <div class="schedule-time">${formatDate(s.date)} ${formatTime(s.time)}</div>
            <div class="schedule-location">${participantText}</div>
          </div>
          <div style="display: flex; gap: 8px;">
            <button class="icon-btn" onclick="openScheduleForm('${s.schedule_id}')"><i class="fas fa-pen"></i></button>
            <button class="icon-btn" onclick="deleteSchedule('${s.schedule_id}')"><i class="fas fa-trash"></i></button>
          </div>
        </div>
        <div style="display: flex; gap: 8px;">
          <button class="btn btn-secondary btn-small" style="flex: 1;" onclick="openParticipants('${s.schedule_id}')">
            <i class="fas fa-users"></i> 참가자
          </button>
          <button class="btn btn-primary btn-small" style="flex: 1;" onclick="openLessonRecordInput('${s.schedule_id}')">
            <i class="fas fa-pen"></i> 기록 입력
          </button>
        </div>
      </div>`;
    }

    async function deleteSchedule(scheduleId) {
      if (!confirm('이 일정을 삭제하시겠습니까? 관련 참가자 정보도 함께 삭제됩니다.')) return;
      
      try {
        // 먼저 관련 기록 삭제
        const { data: regs } = await db
          .from('registrations')
          .select('reg_id')
          .eq('schedule_id', scheduleId);
        
        if (regs && regs.length > 0) {
          const regIds = regs.map(r => r.reg_id);
          await db.from('dive_records').delete().in('reg_id', regIds);
          await db.from('skill_records').delete().in('reg_id', regIds);
          await db.from('registrations').delete().eq('schedule_id', scheduleId);
        }
        
        // 일정 삭제
        const { error } = await db
          .from('schedules')
          .delete()
          .eq('schedule_id', scheduleId);
        
        if (error) throw error;
        
        showToast('일정이 삭제되었습니다');
        loadScheduleManage();
      } catch (err) {
        console.error('일정 삭제 오류:', err);
        showToast('삭제 실패: ' + err.message);
      }
    }

    // ==================== 캘린더 모드 ====================
    let scheduleViewMode = 'calendar'; // 'list' or 'calendar' - 캘린더형 기본
    let calendarYear = new Date().getFullYear();
    let calendarMonth = new Date().getMonth();
    let selectedDate = new Date().toISOString().split('T')[0];

    function setScheduleViewMode(mode) {
      scheduleViewMode = mode;
      if (mode === 'calendar') {
        document.getElementById('schedule-list-mode').style.display = 'none';
        document.getElementById('schedule-calendar-mode').style.display = 'block';
        document.getElementById('schedule-calendar-btn').classList.add('active');
        document.getElementById('schedule-list-btn').classList.remove('active');
        renderCalendar();
      } else {
        document.getElementById('schedule-list-mode').style.display = 'block';
        document.getElementById('schedule-calendar-mode').style.display = 'none';
        document.getElementById('schedule-calendar-btn').classList.remove('active');
        document.getElementById('schedule-list-btn').classList.add('active');
      }
    }

    function toggleScheduleViewMode() {
      if (scheduleViewMode === 'list') {
        setScheduleViewMode('calendar');
      } else {
        setScheduleViewMode('list');
      }
    }

    function changeMonth(delta) {
      calendarMonth += delta;
      if (calendarMonth > 11) {
        calendarMonth = 0;
        calendarYear++;
      } else if (calendarMonth < 0) {
        calendarMonth = 11;
        calendarYear--;
      }
      renderCalendar();
    }

    function renderCalendar() {
      const monthNames = ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'];
      document.getElementById('calendar-title').textContent = `${calendarYear}년 ${monthNames[calendarMonth]}`;
      
      const firstDay = new Date(calendarYear, calendarMonth, 1);
      const lastDay = new Date(calendarYear, calendarMonth + 1, 0);
      const startDayOfWeek = firstDay.getDay();
      const daysInMonth = lastDay.getDate();
      
      const today = new Date().toISOString().split('T')[0];
      
      // 일정이 있는 날짜 맵 생성
      const scheduleDates = {};
      for (const s of allSchedules) {
        if (!scheduleDates[s.date]) {
          scheduleDates[s.date] = { lesson: false, personal: false, dry: false };
        }
        scheduleDates[s.date].lesson = true; // 강사용은 전부 강습 일정
      }
      
      let html = '';
      
      // 이전 달 날짜
      const prevMonthLastDay = new Date(calendarYear, calendarMonth, 0).getDate();
      for (let i = startDayOfWeek - 1; i >= 0; i--) {
        const day = prevMonthLastDay - i;
        html += `<div class="calendar-day other-month">${day}</div>`;
      }
      
      // 이번 달 날짜
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${calendarYear}-${String(calendarMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const isToday = dateStr === today;
        const isSelected = dateStr === selectedDate;
        const schedule = scheduleDates[dateStr];
        
        let classes = 'calendar-day';
        if (isToday) classes += ' today';
        if (isSelected) classes += ' selected';
        
        // 일정 있는 날짜에 색 동그라미 클래스 추가 (우선순위: 강습 > 개인 > 챌린지)
        if (schedule) {
          if (schedule.lesson) classes += ' has-lesson';
          else if (schedule.personal) classes += ' has-personal';
          else if (schedule.dry) classes += ' has-dry';
        }
        
        // 일정 바는 더 이상 사용하지 않음 (CSS에서 숨김 처리)
        let bars = '';
        
        html += `<div class="${classes}" onclick="selectCalendarDate('${dateStr}')">${day}${bars}</div>`;
      }
      
      // 다음 달 날짜
      const totalCells = startDayOfWeek + daysInMonth;
      const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
      for (let i = 1; i <= remainingCells; i++) {
        html += `<div class="calendar-day other-month">${i}</div>`;
      }
      
      document.getElementById('calendar-days').innerHTML = html;
      
      // 선택된 날짜 일정 표시
      renderCalendarScheduleList();
    }

    function selectCalendarDate(dateStr) {
      selectedDate = dateStr;
      instructorSelectedDate = dateStr; // 강사용 선택 날짜도 업데이트
      renderCalendar();
    }

    async function renderCalendarScheduleList() {
      const date = new Date(selectedDate);
      const dayNames = ['일', '월', '화', '수', '목', '금', '토'];
      const dateText = `${date.getMonth() + 1}월 ${date.getDate()}일 (${dayNames[date.getDay()]})`;
      document.getElementById('selected-date-text').textContent = dateText;
      
      const daySchedules = allSchedules.filter(s => s.date === selectedDate);
      const container = document.getElementById('calendar-schedule-list');
      
      if (daySchedules.length === 0) {
        container.innerHTML = '<div class="card" style="text-align: center; color: var(--text-tertiary); padding: 30px;">일정이 없습니다</div>';
        return;
      }
      
      let html = '';
      for (const s of daySchedules) {
        html += await renderScheduleCard(s);
      }
      container.innerHTML = html;
    }

    // ==================== 학생용 캘린더 ====================
    let studentScheduleViewMode = 'calendar'; // 캘린더형 기본
    let studentCalendarYear = new Date().getFullYear();
    let studentCalendarMonth = new Date().getMonth();
    let studentSelectedDate = new Date().toISOString().split('T')[0];
    let studentSchedules = []; // 학생의 등록된 일정

    function setStudentScheduleViewMode(mode) {
      studentScheduleViewMode = mode;
      if (mode === 'calendar') {
        document.getElementById('student-schedule-list-mode').style.display = 'none';
        document.getElementById('student-schedule-calendar-mode').style.display = 'block';
        document.getElementById('student-calendar-btn').classList.add('active');
        document.getElementById('student-list-btn').classList.remove('active');
        renderStudentCalendar();
      } else {
        document.getElementById('student-schedule-list-mode').style.display = 'block';
        document.getElementById('student-schedule-calendar-mode').style.display = 'none';
        document.getElementById('student-calendar-btn').classList.remove('active');
        document.getElementById('student-list-btn').classList.add('active');
      }
    }

    function toggleStudentScheduleViewMode() {
      if (studentScheduleViewMode === 'list') {
        setStudentScheduleViewMode('calendar');
      } else {
        setStudentScheduleViewMode('list');
      }
    }

    function changeStudentMonth(delta) {
      studentCalendarMonth += delta;
      if (studentCalendarMonth > 11) {
        studentCalendarMonth = 0;
        studentCalendarYear++;
      } else if (studentCalendarMonth < 0) {
        studentCalendarMonth = 11;
        studentCalendarYear--;
      }
      renderStudentCalendar();
    }

    function renderStudentCalendar() {
      const monthNames = ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'];
      document.getElementById('student-calendar-title').textContent = `${studentCalendarYear}년 ${monthNames[studentCalendarMonth]}`;
      
      const firstDay = new Date(studentCalendarYear, studentCalendarMonth, 1);
      const lastDay = new Date(studentCalendarYear, studentCalendarMonth + 1, 0);
      const startDayOfWeek = firstDay.getDay();
      const daysInMonth = lastDay.getDate();
      
      const today = new Date().toISOString().split('T')[0];
      
      // 내가 신청한 일정 ID 목록
      const myScheduleIds = studentSchedules.map(r => r.schedule_id);
      
      // 일정이 있는 날짜 맵 생성
      const scheduleDates = {};
      
      // 1. 내가 신청한 강습 (하늘색 배경)
      for (const s of studentSchedules) {
        if (s.schedules) {
          const date = s.schedules.date;
          if (!scheduleDates[date]) {
            scheduleDates[date] = { lesson: false, personal: false, dry: false, available: false };
          }
          scheduleDates[date].lesson = true;
        }
      }
      
      // 2. 드라이 트레이닝 기록 (주황색 배경)
      for (const r of studentDryRecords) {
        if (r.date) {
          if (!scheduleDates[r.date]) {
            scheduleDates[r.date] = { lesson: false, personal: false, dry: false, available: false };
          }
          // 이미 강습이 있는 날은 강습 우선
          if (!scheduleDates[r.date].lesson) {
            scheduleDates[r.date].dry = true;
          }
        }
      }
      
      // 3. 신청 가능한 강습 (테두리만 - 미래 일정만)
      for (const s of availableSchedules) {
        if (!myScheduleIds.includes(s.schedule_id) && s.date >= today) {
          if (!scheduleDates[s.date]) {
            scheduleDates[s.date] = { lesson: false, personal: false, dry: false, available: false };
          }
          // 다른 일정이 없는 경우에만 신청 가능 표시
          if (!scheduleDates[s.date].lesson && !scheduleDates[s.date].challenge) {
            scheduleDates[s.date].available = true;
          }
        }
      }
      
      let html = '';
      
      // 이전 달 날짜
      const prevMonthLastDay = new Date(studentCalendarYear, studentCalendarMonth, 0).getDate();
      for (let i = startDayOfWeek - 1; i >= 0; i--) {
        const day = prevMonthLastDay - i;
        html += `<div class="calendar-day other-month">${day}</div>`;
      }
      
      // 이번 달 날짜
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${studentCalendarYear}-${String(studentCalendarMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const isToday = dateStr === today;
        const isSelected = dateStr === studentSelectedDate;
        const schedule = scheduleDates[dateStr];
        
        let classes = 'calendar-day';
        if (isToday) classes += ' today';
        if (isSelected) classes += ' selected';
        
        // 일정 있는 날짜에 색 동그라미 클래스 추가 (우선순위: 강습 > 드라이 > 신청가능)
        if (schedule) {
          if (schedule.lesson) classes += ' has-lesson';
          else if (schedule.dry) classes += ' has-dry';
          else if (schedule.available) classes += ' has-available';
        }
        
        html += `<div class="${classes}" onclick="selectStudentCalendarDate('${dateStr}')">${day}</div>`;
      }
      
      // 다음 달 날짜
      const totalCells = startDayOfWeek + daysInMonth;
      const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
      for (let i = 1; i <= remainingCells; i++) {
        html += `<div class="calendar-day other-month">${i}</div>`;
      }
      
      document.getElementById('student-calendar-days').innerHTML = html;
      
      // 선택된 날짜 일정 표시
      renderStudentCalendarScheduleList();
    }

    function selectStudentCalendarDate(dateStr) {
      studentSelectedDate = dateStr;
      renderStudentCalendar();
    }

    function renderStudentCalendarScheduleList() {
      const date = new Date(studentSelectedDate);
      const dayNames = ['일', '월', '화', '수', '목', '금', '토'];
      const dateText = `${date.getMonth() + 1}월 ${date.getDate()}일 (${dayNames[date.getDay()]})`;
      document.getElementById('student-selected-date-text').textContent = dateText;
      
      const container = document.getElementById('student-calendar-schedule-list');
      let html = '';
      
      const today = new Date().toISOString().split('T')[0];
      
      // 내가 신청한 일정
      const myDaySchedules = studentSchedules.filter(s => s.schedules && s.schedules.date === studentSelectedDate);
      
      // 신청 가능한 일정 (내가 신청하지 않은 것, 오늘 이후만)
      const myScheduleIds = studentSchedules.map(r => r.schedule_id);
      const availableDaySchedules = availableSchedules.filter(s => 
        s.date === studentSelectedDate && 
        !myScheduleIds.includes(s.schedule_id) &&
        s.date >= today  // 지난 날짜 제외
      );
      
      // 드라이 트레이닝 기록
      const hasDryRecord = studentDryRecords.some(r => r.date === studentSelectedDate);
      
      // 신청한 일정 표시
      for (const r of myDaySchedules) {
        const s = r.schedules;
        html += `<div class="card schedule-card" style="cursor: pointer;" onclick="openScheduleDetail('${r.reg_id}')">
          <div class="schedule-info">
            <div class="schedule-time">${formatTime(s.time)}</div>
            <div class="schedule-location">${s.location} · ${s.users?.name || '강사'}</div>
          </div>
          <span class="my-schedule-badge">${r.purpose === '펀다이빙' ? '펀다이빙' : '강습'}</span>
        </div>`;
      }
      
      // 신청 가능한 일정 표시 (미래 일정만)
      for (const s of availableDaySchedules) {
        html += `<div class="card schedule-card">
          <div class="schedule-info">
            <div class="schedule-time">${formatTime(s.time)}</div>
            <div class="schedule-location">${s.location} · ${s.users?.name || '강사'}</div>
          </div>
          <button class="btn btn-small btn-primary" onclick="openRegisterSheet('${s.schedule_id}')">신청</button>
        </div>`;
      }
      
      // 오늘이고 참여 중인 드라이 트레이닝이 있으면 표시 (다이빙 일정 유무와 관계없이)
      const isToday = studentSelectedDate === today;
      if (isToday && studentMyDryTrainings.length > 0) {
        for (const t of studentMyDryTrainings) {
          // 오늘 이 트레이닝을 완료했는지 확인
          const todayDone = studentDryRecords.some(r => r.date === today && r.dry_id === t.dry_id);
          
          html += `<div class="card schedule-card">
            <div class="schedule-info">
              <div class="schedule-time"><i class="fas fa-lungs" style="color: var(--warning);"></i> ${t.name}</div>
              <div class="schedule-location">${t.description || '드라이 트레이닝'}</div>
            </div>
            ${todayDone 
              ? `<span style="color: var(--success); font-size: 13px;"><i class="fas fa-check-circle"></i> 완료</span>`
              : `<button class="btn btn-small btn-primary" onclick="quickDryRecord('${t.dry_id}')">체크</button>`
            }
          </div>`;
        }
      } else if (hasDryRecord) {
        // 오늘이 아닌 날짜에 드라이 기록이 있으면 완료 표시
        html += `<div class="card schedule-card">
          <div class="schedule-info">
            <div class="schedule-time"><i class="fas fa-lungs" style="color: var(--warning);"></i> 드라이 트레이닝</div>
            <div class="schedule-location">완료</div>
          </div>
          <span style="color: var(--success); font-size: 13px;"><i class="fas fa-check-circle"></i></span>
        </div>`;
      }
      
      if (!html) {
        html = '<div class="card" style="text-align: center; color: var(--text-tertiary); padding: 30px;">일정이 없습니다</div>';
      }
      
      container.innerHTML = html;
    }

    function toggleScheduleSection(type) {
      const section = document.getElementById('schedule-' + type + '-section');
      const toggle = document.getElementById('schedule-' + type + '-toggle');
      
      if (section.style.display === 'none') {
        section.style.display = 'block';
        toggle.textContent = '접기';
      } else {
        section.style.display = 'none';
        toggle.textContent = '선택';
      }
    }

    function resetScheduleFormChecks(defaultDiscs, defaultSkills) {
      // 기록 종목 체크박스 초기화
      document.querySelectorAll('#schedule-disc-checks input[type="checkbox"]').forEach(cb => {
        cb.checked = defaultDiscs.includes(cb.value);
      });
      
      // 스킬 종목 체크박스 초기화 (영어→한국어 매핑 적용)
      document.querySelectorAll('#schedule-skill-section input[type="checkbox"]').forEach(cb => {
        const koreanName = cb.value;
        const englishName = toEnglishSkillName(koreanName);
        cb.checked = defaultSkills.includes(koreanName) || defaultSkills.includes(englishName);
      });
    }

    function openScheduleForm(scheduleId) {
      document.getElementById('schedule-form-title').textContent = scheduleId ? '일정 수정' : '새 일정 등록';
      document.getElementById('edit-schedule-id').value = scheduleId || '';
      
      // 토글 섹션 초기화 (닫기)
      document.getElementById('schedule-disc-section').style.display = 'none';
      document.getElementById('schedule-disc-toggle').textContent = '선택';
      document.getElementById('schedule-skill-section').style.display = 'none';
      document.getElementById('schedule-skill-toggle').textContent = '선택';
      
      if (scheduleId) {
        // 수정 모드 - 기존 데이터 로드
        const s = allSchedules.find(x => x.schedule_id === scheduleId);
        if (s) {
          document.getElementById('schedule-date').value = s.date;
          // 시간은 HH:MM 형식으로 변환 (HH:MM:SS인 경우 처리)
          const timeValue = s.time ? s.time.substring(0, 5) : '';
          document.getElementById('schedule-time').value = timeValue;
          document.getElementById('schedule-location').value = s.location;
          
          // DB에 저장된 종목 정보 로드 (NULL이면 빈 배열)
          const savedDiscs = s.common_disciplines ? s.common_disciplines.split(',') : [];
          const savedSkills = s.common_skill_disciplines ? s.common_skill_disciplines.split(',') : [];
          resetScheduleFormChecks(savedDiscs, savedSkills);
        }
      } else {
        // 새 일정 - 캘린더에서 선택된 날짜 사용
        const selectedDate = instructorSelectedDate || new Date().toISOString().split('T')[0];
        document.getElementById('schedule-date').value = selectedDate;
        document.getElementById('schedule-time').value = '';
        document.getElementById('schedule-location').value = '';
        
        // 기본 선택: STA, DYNB, FIM, CWTB만
        resetScheduleFormChecks(['STA', 'DYNB', 'FIM', 'CWTB'], []);
      }
      
      // 자주 가는 장소 표시
      updateFrequentLocations();
      
      openBottomSheet('sheet-schedule');
    }
    
    // 자주 가는 장소 업데이트
    function updateFrequentLocations() {
      const container = document.getElementById('frequent-locations');
      
      // allSchedules에서 장소 빈도 계산
      const locationCounts = {};
      for (const s of allSchedules) {
        if (s.location) {
          locationCounts[s.location] = (locationCounts[s.location] || 0) + 1;
        }
      }
      
      // 상위 3개 추출
      const topLocations = Object.entries(locationCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 3)
        .map(([loc]) => loc);
      
      if (topLocations.length === 0) {
        container.innerHTML = '';
        return;
      }
      
      let html = '';
      for (const loc of topLocations) {
        html += `<button type="button" class="frequent-loc-btn" onclick="selectFrequentLocation('${loc}')">${loc}</button>`;
      }
      container.innerHTML = html;
    }
    
    // 자주 가는 장소 선택
    function selectFrequentLocation(location) {
      document.getElementById('schedule-location').value = location;
    }

    async function saveSchedule() {
      const scheduleId = document.getElementById('edit-schedule-id').value;
      const date = document.getElementById('schedule-date').value;
      const time = document.getElementById('schedule-time').value;
      const location = document.getElementById('schedule-location').value;
      
      if (!date || !time || !location) {
        showToast('모든 항목을 입력해주세요');
        return;
      }
      
      // 선택된 기록 종목
      const recordDiscs = [];
      document.querySelectorAll('#schedule-disc-checks input[type="checkbox"]:checked').forEach(cb => {
        recordDiscs.push(cb.value);
      });
      
      // 선택된 스킬 종목 (영어로 변환해서 저장)
      const skillDiscs = [];
      document.querySelectorAll('#schedule-skill-section input[type="checkbox"]:checked').forEach(cb => {
        skillDiscs.push(toEnglishSkillName(cb.value));
      });
      
      try {
        const scheduleData = {
          date,
          time,
          location,
          common_disciplines: recordDiscs.length > 0 ? recordDiscs.join(',') : null,
          common_skill_disciplines: skillDiscs.length > 0 ? skillDiscs.join(',') : null
        };
        
        if (scheduleId) {
          // 수정
          const { error } = await db
            .from('schedules')
            .update(scheduleData)
            .eq('schedule_id', scheduleId);
          
          if (error) throw error;
          showToast('일정이 수정되었습니다');
        } else {
          // 새로 생성
          const newId = 'SCH_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
          const { error } = await db
            .from('schedules')
            .insert({
              schedule_id: newId,
              instructor_id: currentUser.user_id,
              ...scheduleData
            });
          
          if (error) throw error;
          showToast('일정이 등록되었습니다');
        }
        
        closeBottomSheet('sheet-schedule');
        loadScheduleManage();
        loadTodaySchedules();
      } catch (err) {
        console.error('일정 저장 오류:', err);
        showToast('저장 실패: ' + err.message);
      }
    }

    // ==================== 참가자 관리 ====================
    async function openParticipants(scheduleId) {
      currentScheduleId = scheduleId;
      const s = allSchedules.find(x => x.schedule_id === scheduleId);
      
      if (s) {
        document.getElementById('participant-schedule-date').textContent = formatDate(s.date) + ' ' + formatTime(s.time);
        document.getElementById('participant-schedule-location').textContent = s.location;
      }
      
      showScreen('screen-participants');
      await loadParticipants();
    }

    async function loadParticipants() {
      try {
        // 참가자 목록 조회 (users 테이블과 guests 테이블 모두 조인)
        const { data: regs, error } = await db
          .from('registrations')
          .select(`
            reg_id,
            student_id,
            guest_id,
            purpose,
            lesson_level,
            attendance,
            session_no,
            users!registrations_student_id_fkey (
              user_id,
              name,
              cert_level
            ),
            guests!registrations_guest_id_fkey (
              guest_id,
              name,
              cert_level,
              in_training_level
            )
          `)
          .eq('schedule_id', currentScheduleId);
        
        if (error) throw error;
        
        const lessons = [];
        const funs = [];
        
        for (const r of (regs || [])) {
          // 회원인지 비회원인지 확인
          const isGuest = !r.student_id && r.guest_id;
          const participant = {
            reg_id: r.reg_id,
            student_id: r.student_id,
            guest_id: r.guest_id,
            is_guest: isGuest,
            purpose: r.purpose,
            lesson_level: r.lesson_level,
            attendance: r.attendance,
            session_no: r.session_no,
            student_name: isGuest ? (r.guests?.name || '알 수 없음') : (r.users?.name || '알 수 없음'),
            student_cert: isGuest ? (r.guests?.cert_level || 'X') : (r.users?.cert_level || 'X')
          };
          
          if (r.purpose === '강습') lessons.push(participant);
          else funs.push(participant);
        }
        
        document.getElementById('lesson-participants').innerHTML = lessons.length === 0 
          ? '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">강습 참가자가 없습니다</div>'
          : lessons.map(p => renderParticipantCard(p)).join('');
        
        document.getElementById('fun-participants').innerHTML = funs.length === 0
          ? '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">펀다이빙 참가자가 없습니다</div>'
          : funs.map(p => renderParticipantCard(p)).join('');
          
      } catch (err) {
        console.error('참가자 로드 오류:', err);
        document.getElementById('lesson-participants').innerHTML = 
          '<div style="text-align: center; color: var(--error); padding: 20px;">참가자를 불러오지 못했습니다</div>';
      }
    }

    function renderParticipantCard(p) {
      const attClass = p.attendance === 'Y' ? 'attendance-yes' : p.attendance === 'N' ? 'attendance-no' : 'attendance-pending';
      const attText = p.attendance === 'Y' ? '출석' : p.attendance === 'N' ? '불참' : '미정';
      const guestBadge = p.is_guest ? '<span style="font-size: 11px; color: var(--warning); margin-left: 4px;">(비회원)</span>' : '';
      const sessionInfo = p.session_no ? ` · ${p.session_no}회차` : '';
      
      return `<div class="participant-card">
        <div class="participant-avatar" style="${p.is_guest ? 'background: var(--lv2-light); color: var(--lv2-color);' : ''}">${p.student_name ? p.student_name.charAt(0) : '?'}</div>
        <div class="participant-info">
          <div class="participant-name">${p.student_name}${guestBadge}</div>
          <div class="participant-detail">Lv.${p.student_cert || 'X'}${p.lesson_level ? ' · Lv.' + p.lesson_level + ' 수강중' + sessionInfo : ''}</div>
        </div>
        <div class="attendance-badge ${attClass}" onclick="toggleAttendance('${p.reg_id}', '${p.attendance}')" style="cursor: pointer;">${attText}</div>
        <button class="btn-icon-delete" onclick="deleteParticipant('${p.reg_id}')" title="삭제">
          <i class="fas fa-times"></i>
        </button>
      </div>`;
    }

    async function deleteParticipant(regId) {
      if (!confirm('이 참가자를 삭제하시겠습니까?')) return;
      
      try {
        // 관련 기록 삭제
        await db.from('dive_records').delete().eq('reg_id', regId);
        await db.from('skill_records').delete().eq('reg_id', regId);
        
        // 참가자 삭제
        const { error } = await db
          .from('registrations')
          .delete()
          .eq('reg_id', regId);
        
        if (error) throw error;
        
        showToast('참가자가 삭제되었습니다');
        loadParticipants();
      } catch (err) {
        console.error('참가자 삭제 오류:', err);
        showToast('삭제 실패: ' + err.message);
      }
    }

    async function toggleAttendance(regId, currentStatus) {
      const nextStatus = currentStatus === 'Y' ? 'N' : currentStatus === 'N' ? '미정' : 'Y';
      
      try {
        const { error } = await db
          .from('registrations')
          .update({ attendance: nextStatus })
          .eq('reg_id', regId);
        
        if (error) throw error;
        await loadParticipants();
      } catch (err) {
        console.error('출석 변경 오류:', err);
        showToast('출석 변경 실패');
      }
    }

    let allMembers = [];
    let allGuests = [];
    let selectedMembers = new Set();
    let selectedGuests = new Set();
    
    async function openAddParticipant() {
      try {
        // 회원(강습생) 목록 조회
        const { data: students, error: studentsError } = await db
          .from('users')
          .select('user_id, name, phone, in_training_level')
          .eq('user_type', '강습생')
          .order('name');
        
        if (studentsError) throw studentsError;
        allMembers = students || [];
        
        // 비회원 목록 조회
        const { data: guests, error: guestsError } = await db
          .from('guests')
          .select('guest_id, name, phone, in_training_level')
          .order('name');
        
        if (guestsError) throw guestsError;
        allGuests = guests || [];
        
        // 이미 등록된 참가자 조회
        const { data: existingRegs } = await db
          .from('registrations')
          .select('student_id, guest_id')
          .eq('schedule_id', currentScheduleId);
        
        const existingMemberIds = new Set((existingRegs || []).filter(r => r.student_id).map(r => r.student_id));
        const existingGuestIds = new Set((existingRegs || []).filter(r => r.guest_id).map(r => r.guest_id));
        
        // 선택 초기화
        selectedMembers = new Set();
        selectedGuests = new Set();
        
        // 회원 다중 선택 리스트 렌더링
        const memberContainer = document.getElementById('member-multi-select');
        let memberHtml = '';
        for (const s of allMembers) {
          const isExisting = existingMemberIds.has(s.user_id);
          const levelText = s.in_training_level ? `Lv${s.in_training_level}` : '';
          const existingText = isExisting ? ' · 등록됨' : '';
          memberHtml += `<div class="multi-select-item ${isExisting ? 'disabled' : ''}" 
            onclick="${isExisting ? '' : `toggleMemberSelect('${s.user_id}')`}"
            id="member-item-${s.user_id}"
            style="${isExisting ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
            <input type="checkbox" ${isExisting ? 'disabled' : ''} id="member-cb-${s.user_id}">
            <span class="item-name">${s.name}${levelText ? ' · ' + levelText : ''}${existingText}</span>
          </div>`;
        }
        memberContainer.innerHTML = memberHtml || '<div style="padding: 16px; text-align: center; color: var(--text-tertiary);">등록된 회원이 없습니다</div>';
        
        // 비회원 다중 선택 리스트 렌더링
        const guestContainer = document.getElementById('guest-multi-select');
        let guestHtml = '';
        for (const g of allGuests) {
          const isExisting = existingGuestIds.has(g.guest_id);
          const existingText = isExisting ? ' · 등록됨' : '';
          guestHtml += `<div class="multi-select-item ${isExisting ? 'disabled' : ''}" 
            onclick="${isExisting ? '' : `toggleGuestSelect('${g.guest_id}')`}"
            id="guest-item-${g.guest_id}"
            style="${isExisting ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
            <input type="checkbox" ${isExisting ? 'disabled' : ''} id="guest-cb-${g.guest_id}">
            <span class="item-name">${g.name} · 비회원${existingText}</span>
          </div>`;
        }
        guestContainer.innerHTML = guestHtml || '<div style="padding: 20px; text-align: center; color: var(--text-tertiary);">등록된 비회원이 없습니다</div>';
        
        // 선택 카운트 초기화
        updateSelectedCount();
        
        // 비회원 섹션 접기 초기화
        document.getElementById('guest-section-content').style.display = 'none';
        document.getElementById('guest-toggle-icon').className = 'fas fa-chevron-down';
        document.getElementById('guest-toggle-text').textContent = '펼치기';
        
        openBottomSheet('sheet-add-participant');
      } catch (err) {
        console.error('참가자 목록 로드 오류:', err);
        showToast('참가자 목록을 불러오지 못했습니다');
      }
    }
    
    function toggleMemberSelect(userId) {
      if (selectedMembers.has(userId)) {
        selectedMembers.delete(userId);
      } else {
        selectedMembers.add(userId);
      }
      
      const item = document.getElementById(`member-item-${userId}`);
      const checkbox = document.getElementById(`member-cb-${userId}`);
      if (item && checkbox) {
        item.classList.toggle('selected', selectedMembers.has(userId));
        checkbox.checked = selectedMembers.has(userId);
      }
      updateSelectedCount();
    }
    
    function toggleGuestSelect(guestId) {
      if (selectedGuests.has(guestId)) {
        selectedGuests.delete(guestId);
      } else {
        selectedGuests.add(guestId);
      }
      
      const item = document.getElementById(`guest-item-${guestId}`);
      const checkbox = document.getElementById(`guest-cb-${guestId}`);
      if (item && checkbox) {
        item.classList.toggle('selected', selectedGuests.has(guestId));
        checkbox.checked = selectedGuests.has(guestId);
      }
      updateSelectedCount();
    }
    
    function updateSelectedCount() {
      const memberCount = selectedMembers.size;
      const guestCount = selectedGuests.size;
      
      document.getElementById('member-selected-count').textContent = 
        memberCount > 0 ? `${memberCount}명 선택됨` : '';
      document.getElementById('guest-selected-count').textContent = 
        guestCount > 0 ? `${guestCount}명 선택됨` : '';
      
      // 비회원 선택됐으면 토글 텍스트에 표시
      const toggleText = document.getElementById('guest-toggle-text');
      const guestContent = document.getElementById('guest-section-content');
      if (toggleText && guestContent) {
        if (guestContent.style.display === 'none') {
          toggleText.textContent = guestCount > 0 ? `${guestCount}명 선택됨` : '펼치기';
        } else {
          toggleText.textContent = '접기';
        }
      }
    }
    
    function toggleGuestSection() {
      const content = document.getElementById('guest-section-content');
      const icon = document.getElementById('guest-toggle-icon');
      const toggleText = document.getElementById('guest-toggle-text');
      const guestCount = selectedGuests.size;
      
      if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.className = 'fas fa-chevron-up';
        toggleText.textContent = '접기';
      } else {
        content.style.display = 'none';
        icon.className = 'fas fa-chevron-down';
        toggleText.textContent = guestCount > 0 ? `${guestCount}명 선택됨` : '펼치기';
      }
    }

    function selectPurpose(btn) {
      document.querySelectorAll('#sheet-add-participant .purpose-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      document.getElementById('lesson-level-group').style.display = btn.dataset.purpose === '강습' ? 'block' : 'none';
    }

    async function addMultipleParticipants() {
      const totalSelected = selectedMembers.size + selectedGuests.size;
      
      if (totalSelected === 0) {
        showToast('참가자를 선택해주세요');
        return;
      }
      
      const purposeBtn = document.querySelector('#sheet-add-participant .purpose-btn.selected');
      const purpose = purposeBtn.dataset.purpose;
      const level = purpose === '강습' ? parseInt(document.getElementById('participant-level').value) : null;
      
      try {
        let addedCount = 0;
        
        // 회원 추가
        for (const userId of selectedMembers) {
          // session_no 계산
          let sessionNo = null;
          if (purpose === '강습' && (level === 2 || level === 3)) {
            const { data: prevRegs } = await db
              .from('registrations')
              .select('session_no')
              .eq('student_id', userId)
              .eq('purpose', '강습')
              .eq('lesson_level', level);
            
            const maxSessionNo = (prevRegs || []).reduce((max, r) => {
              const sn = r.session_no || 0;
              return sn > max ? sn : max;
            }, 0);
            sessionNo = maxSessionNo + 1;
          }
          
          const regId = 'REG_' + userId + '_' + Date.now() + '_' + Math.random().toString(36).substr(2, 4);
          await db.from('registrations').insert({
            reg_id: regId,
            schedule_id: currentScheduleId,
            student_id: userId,
            purpose,
            lesson_level: level,
            attendance: 'Y',
            session_no: sessionNo
          });
          addedCount++;
        }
        
        // 비회원 추가
        for (const guestId of selectedGuests) {
          // session_no 계산
          let sessionNo = null;
          if (purpose === '강습' && (level === 2 || level === 3)) {
            const { data: prevRegs } = await db
              .from('registrations')
              .select('session_no')
              .eq('guest_id', guestId)
              .eq('purpose', '강습')
              .eq('lesson_level', level);
            
            const maxSessionNo = (prevRegs || []).reduce((max, r) => {
              const sn = r.session_no || 0;
              return sn > max ? sn : max;
            }, 0);
            sessionNo = maxSessionNo + 1;
          }
          
          const regId = 'REG_' + guestId + '_' + Date.now() + '_' + Math.random().toString(36).substr(2, 4);
          await db.from('registrations').insert({
            reg_id: regId,
            schedule_id: currentScheduleId,
            guest_id: guestId,
            purpose,
            lesson_level: level,
            attendance: 'Y',
            session_no: sessionNo
          });
          addedCount++;
        }
        
        showToast(`${addedCount}명의 참가자가 추가되었습니다`);
        closeBottomSheet('sheet-add-participant');
        await loadParticipants();
      } catch (err) {
        console.error('참가자 추가 오류:', err);
        showToast('추가 실패: ' + (err.message || '오류가 발생했습니다'));
      }
    }

    // ==================== 강습생 일정 ====================
    let availableSchedules = []; // 신청 가능한 강습
    let studentDryRecords = []; // 드라이 트레이닝 기록
    let studentMyDryTrainings = []; // 참여 중인 드라이 트레이닝
    
    async function loadStudentSchedule() {
      try {
        const today = new Date().toISOString().split('T')[0];
        
        // 열린 일정 조회 (모든 일정 - 캘린더용)
        const { data: schedules, error } = await db
          .from('schedules')
          .select(`
            schedule_id,
            date,
            time,
            location,
            instructor_id,
            users!schedules_instructor_id_fkey (name)
          `)
          .order('date', { ascending: true });
        
        if (error) throw error;
        
        // 신청 가능한 강습 저장 (캘린더용)
        availableSchedules = schedules || [];
        
        // 내가 이미 신청한 일정 조회 (모든 일정 - 과거 포함)
        const { data: myRegs } = await db
          .from('registrations')
          .select(`
            reg_id,
            schedule_id, 
            purpose,
            schedules (
              schedule_id,
              date,
              time,
              location,
              users!schedules_instructor_id_fkey (name)
            )
          `)
          .eq('student_id', currentUser.user_id);
        
        // 학생 캘린더용 일정 저장
        studentSchedules = myRegs || [];
        
        // 드라이 트레이닝 기록 조회
        const { data: dryRecords } = await db
          .from('dry_training_records')
          .select('date, dry_id')
          .eq('user_id', currentUser.user_id);
        
        studentDryRecords = dryRecords || [];
        
        // 참여 중인 드라이 트레이닝 조회
        const { data: allDry } = await db
          .from('dry_trainings')
          .select('dry_id, name, description')
          .contains('participants', [currentUser.user_id]);
        
        studentMyDryTrainings = allDry || [];
        
        const myScheduleIds = myRegs ? myRegs.map(r => r.schedule_id) : [];
        
        // 내가 신청한 일정 중 지난 일정
        const pastMySchedules = (myRegs || []).filter(r => r.schedules && r.schedules.date < today);
        
        // 미래 일정만 필터링 (리스트용)
        const futureSchedules = (schedules || []).filter(s => s.date >= today);
        
        const container = document.getElementById('available-schedules');
        let html = '';
        
        // 다가오는 일정 (열린 일정)
        if (futureSchedules && futureSchedules.length > 0) {
          html += '<div class="schedule-section-title"><i class="fas fa-arrow-right"></i> 다가오는 일정</div>';
          for (const s of futureSchedules) {
            const isRegistered = myScheduleIds.includes(s.schedule_id);
            const myReg = myRegs ? myRegs.find(r => r.schedule_id === s.schedule_id) : null;
            
            html += `<div class="card schedule-card">
              <div class="schedule-info">
                <div class="schedule-time">${formatDate(s.date)} ${formatTime(s.time)}</div>
                <div class="schedule-location">${s.location} · ${s.users?.name || '강사'}</div>
              </div>
              ${isRegistered 
                ? `<span class="my-schedule-badge" style="cursor: pointer;" onclick="cancelRegistration('${myReg?.reg_id}')">${myReg?.purpose === '펀다이빙' ? '펀다이빙' : '강습'} 신청완료</span>` 
                : `<button class="btn btn-small btn-primary" onclick="openRegisterSheet('${s.schedule_id}')">신청</button>`
              }
            </div>`;
          }
        }
        
        // 지난 일정 (내가 참여한 것만)
        if (pastMySchedules.length > 0) {
          html += '<div class="schedule-section-title" style="margin-top: 24px;"><i class="fas fa-check"></i> 지난 일정</div>';
          // 최신순 정렬
          const sortedPast = pastMySchedules.sort((a, b) => b.schedules.date.localeCompare(a.schedules.date));
          for (const r of sortedPast) {
            const s = r.schedules;
            html += `<div class="card schedule-card" style="cursor: pointer;" onclick="openScheduleDetail('${r.reg_id}')">
              <div class="schedule-info">
                <div class="schedule-time">${formatDate(s.date)} ${formatTime(s.time)}</div>
                <div class="schedule-location">${s.location} · ${s.users?.name || '강사'}</div>
              </div>
              <span style="color: var(--text-tertiary); font-size: 13px;">${r.purpose} <i class="fas fa-chevron-right"></i></span>
            </div>`;
          }
        }
        
        if (!html) {
          html = '<div class="card" style="text-align: center; color: var(--text-secondary);">일정이 없습니다</div>';
        }
        
        container.innerHTML = html;
        // 캘린더형이 기본이므로 캘린더도 렌더링
        renderStudentCalendar();
      } catch (err) {
        console.error('일정 로드 오류:', err);
        document.getElementById('available-schedules').innerHTML = 
          '<div class="card" style="text-align: center; color: var(--error);">일정을 불러오지 못했습니다</div>';
      }
    }
    
    // 학생 일정 상세 화면 열기
    let currentDetailRegId = null;
    
    async function openScheduleDetail(regId) {
      currentDetailRegId = regId;
      
      try {
        // 등록 정보 조회 (일정 정보, 강사 피드백, 내 노트 포함)
        const { data: reg } = await db
          .from('registrations')
          .select(`
            reg_id,
            purpose,
            lesson_level,
            note_instructor,
            note_student,
            schedule_id,
            schedules (
              schedule_id,
              date,
              time,
              location,
              note,
              common_disciplines,
              common_skill_disciplines,
              users!schedules_instructor_id_fkey (name)
            )
          `)
          .eq('reg_id', regId)
          .single();
        
        if (!reg) {
          showToast('일정 정보를 찾을 수 없습니다');
          return;
        }
        
        const s = reg.schedules;
        
        // 같은 일정의 다른 참가자 조회 (lesson_level 포함)
        const { data: otherParticipants } = await db
          .from('registrations')
          .select('student_id, purpose, lesson_level, users!registrations_student_id_fkey(name)')
          .eq('schedule_id', reg.schedule_id)
          .neq('student_id', currentUser.user_id);
        
        // 참가자 목록 생성 (목적별로 분류)
        const lv3Participants = [];
        const lv2Participants = [];
        const funDiveParticipants = [];
        
        // 본인 추가
        if (reg.purpose === '펀다이빙') {
          funDiveParticipants.push(currentUser.name);
        } else if (reg.lesson_level === 3) {
          lv3Participants.push(currentUser.name);
        } else if (reg.lesson_level === 2) {
          lv2Participants.push(currentUser.name);
        } else {
          // 레벨 미지정 강습은 Lv2로 간주
          lv2Participants.push(currentUser.name);
        }
        
        // 다른 참가자 추가
        if (otherParticipants && otherParticipants.length > 0) {
          for (const p of otherParticipants) {
            const name = p.users?.name || '학생';
            if (p.purpose === '펀다이빙') {
              funDiveParticipants.push(name);
            } else if (p.lesson_level === 3) {
              lv3Participants.push(name);
            } else if (p.lesson_level === 2) {
              lv2Participants.push(name);
            } else {
              lv2Participants.push(name);
            }
          }
        }
        
        // 참가자 HTML 생성 (Lv3 → Lv2 → 펀다이빙 순서)
        let participantsHtml = '';
        if (lv3Participants.length > 0) {
          participantsHtml += `
            <div style="display: flex; align-items: flex-start; gap: 8px; color: var(--text-secondary); margin-top: 4px;">
              <i class="fas fa-graduation-cap" style="margin-top: 3px;"></i>
              <span>Lv3 강습: ${lv3Participants.join(', ')}</span>
            </div>
          `;
        }
        if (lv2Participants.length > 0) {
          participantsHtml += `
            <div style="display: flex; align-items: flex-start; gap: 8px; color: var(--text-secondary); margin-top: 4px;">
              <i class="fas fa-graduation-cap" style="margin-top: 3px;"></i>
              <span>Lv2 강습: ${lv2Participants.join(', ')}</span>
            </div>
          `;
        }
        if (funDiveParticipants.length > 0) {
          participantsHtml += `
            <div style="display: flex; align-items: flex-start; gap: 8px; color: var(--text-secondary); margin-top: 4px;">
              <i class="fas fa-water" style="margin-top: 3px;"></i>
              <span>펀다이빙: ${funDiveParticipants.join(', ')}</span>
            </div>
          `;
        }
        
        // 종목 표시
        let disciplinesHtml = '';
        const disciplines = s.common_disciplines ? s.common_disciplines.split(',') : [];
        const skillItems = s.common_skill_disciplines ? s.common_skill_disciplines.split(',') : [];
        
        // Lv2, Lv3 스킬 분류
        const lv2Skills = ['rescue_5_10m', 'theory_test_lv2'];
        const lv3Skills = ['lanyard_remove', 'no_mask_10m', 'rescue_towing', 'neutral_buoyancy', 'freefall', 'arms_only_15m', 'buddy_10_15m', 'theory_test'];
        
        const lv2SkillItems = skillItems.filter(sk => lv2Skills.includes(sk));
        const lv3SkillItems = skillItems.filter(sk => lv3Skills.includes(sk));
        
        if (disciplines.length > 0) {
          disciplinesHtml += `
            <div style="display: flex; align-items: center; gap: 8px; margin-top: 12px; flex-wrap: wrap;">
              <span style="color: var(--text-tertiary); font-size: 13px;">기록종목</span>
              ${disciplines.map(d => `<span style="padding: 2px 8px; background: var(--primary-light); color: var(--primary); border-radius: 10px; font-size: 12px;">${d}</span>`).join('')}
            </div>
          `;
        }
        if (lv3SkillItems.length > 0) {
          disciplinesHtml += `
            <div style="display: flex; align-items: center; gap: 8px; margin-top: 8px; flex-wrap: wrap;">
              <span style="color: var(--text-tertiary); font-size: 13px;">Lv3 스킬</span>
              ${lv3SkillItems.map(sk => `<span style="padding: 2px 8px; background: var(--lv3-light); color: var(--lv3-color); border-radius: 10px; font-size: 12px;">${toKoreanSkillName(sk)}</span>`).join('')}
            </div>
          `;
        }
        if (lv2SkillItems.length > 0) {
          disciplinesHtml += `
            <div style="display: flex; align-items: center; gap: 8px; margin-top: 8px; flex-wrap: wrap;">
              <span style="color: var(--text-tertiary); font-size: 13px;">Lv2 스킬</span>
              ${lv2SkillItems.map(sk => `<span style="padding: 2px 8px; background: var(--lv2-light); color: var(--lv2-color); border-radius: 10px; font-size: 12px;">${toKoreanSkillName(sk)}</span>`).join('')}
            </div>
          `;
        }
        
        // 일정 정보 표시
        document.getElementById('schedule-detail-info').innerHTML = `
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
            <i class="fas fa-calendar" style="color: var(--primary);"></i>
            <span style="font-weight: 600;">${formatDate(s.date)} ${formatTime(s.time)}</span>
          </div>
          <div style="display: flex; align-items: center; gap: 8px; color: var(--text-secondary);">
            <i class="fas fa-map-marker-alt"></i>
            <span>${s.location}</span>
          </div>
          <div style="display: flex; align-items: center; gap: 8px; color: var(--text-secondary); margin-top: 4px;">
            <i class="fas fa-user"></i>
            <span>${s.users?.name || '강사'}</span>
          </div>
          ${participantsHtml}
          ${disciplinesHtml}
        `;
        
        // 강사 피드백 표시
        const instructorNoteSection = document.getElementById('schedule-detail-instructor-note');
        if (reg.note_instructor) {
          document.getElementById('schedule-detail-instructor-note-text').textContent = reg.note_instructor;
          instructorNoteSection.style.display = 'block';
        } else {
          instructorNoteSection.style.display = 'none';
        }
        
        // 내 노트 표시
        document.getElementById('schedule-detail-my-note').value = reg.note_student || '';
        
        // 기록 조회 및 표시
        const { data: diveRecords } = await db
          .from('dive_records')
          .select('discipline, attempt, value')
          .eq('reg_id', regId)
          .order('discipline')
          .order('attempt');
        
        const recordsSection = document.getElementById('schedule-detail-records');
        const recordsList = document.getElementById('schedule-detail-records-list');
        
        if (diveRecords && diveRecords.length > 0) {
          // 종목별로 그룹핑
          const grouped = {};
          for (const r of diveRecords) {
            if (!grouped[r.discipline]) grouped[r.discipline] = [];
            grouped[r.discipline].push(r);
          }
          
          let recordsHtml = '';
          for (const disc of Object.keys(grouped)) {
            const records = grouped[disc];
            const values = records.map(r => {
              if (disc === 'STA') {
                const min = Math.floor(r.value / 60);
                const sec = Math.floor(r.value % 60);
                return `${min}'${sec.toString().padStart(2, '0')}"`;
              }
              return r.value + 'm';
            });
            recordsHtml += `
              <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--divider);">
                <span style="font-weight: 500;">${disc}</span>
                <span style="color: var(--text-secondary);">${values.join(' / ')}</span>
              </div>
            `;
          }
          recordsList.innerHTML = recordsHtml;
          recordsSection.style.display = 'block';
        } else {
          recordsSection.style.display = 'none';
        }
        
        showScreen('screen-schedule-detail');
      } catch (err) {
        console.error('일정 상세 로드 오류:', err);
        showToast('일정 정보를 불러오지 못했습니다');
      }
    }
    
    // 학생 노트 저장
    async function saveStudentNote() {
      const note = document.getElementById('schedule-detail-my-note').value.trim();
      
      try {
        await db
          .from('registrations')
          .update({ note_student: note || null })
          .eq('reg_id', currentDetailRegId);
        
        showToast('저장되었습니다');
      } catch (err) {
        console.error('노트 저장 오류:', err);
        showToast('저장 실패: ' + err.message);
      }
    }

    let pendingScheduleId = null;
    
    function openRegisterSheet(scheduleId) {
      pendingScheduleId = scheduleId;
      // 기본값 설정
      document.querySelectorAll('#sheet-register .purpose-btn').forEach(b => b.classList.remove('selected'));
      document.querySelector('#sheet-register .purpose-btn[data-purpose="강습"]').classList.add('selected');
      document.getElementById('register-level-group').style.display = 'block';
      document.getElementById('register-level').value = currentUser.in_training_level || '2';
      openBottomSheet('sheet-register');
    }
    
    function selectRegisterPurpose(btn) {
      document.querySelectorAll('#sheet-register .purpose-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      document.getElementById('register-level-group').style.display = btn.dataset.purpose === '강습' ? 'block' : 'none';
    }

    async function registerSchedule() {
      const purposeBtn = document.querySelector('#sheet-register .purpose-btn.selected');
      const purpose = purposeBtn.dataset.purpose;
      const level = purpose === '강습' ? parseInt(document.getElementById('register-level').value) : null;
      
      try {
        const regId = 'REG_' + currentUser.user_id + '_' + Date.now();
        const { error } = await db
          .from('registrations')
          .insert({
            reg_id: regId,
            schedule_id: pendingScheduleId,
            student_id: currentUser.user_id,
            purpose,
            lesson_level: level,
            attendance: 'Y'
          });
        
        if (error) throw error;
        
        showToast('일정 신청 완료!');
        closeBottomSheet('sheet-register');
        loadStudentSchedule();
        loadUpcomingSchedules();
      } catch (err) {
        console.error('일정 신청 오류:', err);
        showToast('신청 실패: ' + (err.message || '이미 신청했을 수 있습니다'));
      }
    }

    async function cancelRegistration(regId) {
      if (!confirm('일정 신청을 취소하시겠습니까?')) return;
      
      try {
        const { error } = await db
          .from('registrations')
          .delete()
          .eq('reg_id', regId);
        
        if (error) throw error;
        
        showToast('신청이 취소되었습니다');
        loadStudentSchedule();
        loadUpcomingSchedules();
      } catch (err) {
        console.error('신청 취소 오류:', err);
        showToast('취소 실패: ' + err.message);
      }
    }

    // ==================== 나의 기록 ====================
    async function loadMyRecords() {
      // 탭바 렌더링
      const isInstructor = currentUser.user_type === '강사';
      document.getElementById('my-records-tabbar').innerHTML = `
        <button class="tab-item" onclick="showScreen('${isInstructor ? 'screen-instructor-home' : 'screen-student-home'}')"><i class="fas fa-home"></i><span>홈</span></button>
        <button class="tab-item" onclick="showScreen('${isInstructor ? 'screen-schedule-manage' : 'screen-student-schedule'}')"><i class="fas fa-calendar"></i><span>일정</span></button>
        <button class="tab-item" onclick="showScreen('${isInstructor ? 'screen-dry-manage' : 'screen-dry-training'}')"><i class="fas fa-dumbbell"></i><span>트레이닝</span></button>
        <button class="tab-item active"><i class="fas fa-chart-line"></i><span>내기록</span></button>
        <button class="tab-item" onclick="showScreen('screen-mypage')"><i class="fas fa-user"></i><span>마이</span></button>
      `;
      
      try {
        let allRecords = [];
        
        // 1. 강습 기록 조회 (registrations → dive_records)
        const { data: regs } = await db
          .from('registrations')
          .select('reg_id, schedule_id')
          .eq('student_id', currentUser.user_id);
        
        if (regs && regs.length > 0) {
          const regIds = regs.map(r => r.reg_id);
          const scheduleIds = regs.map(r => r.schedule_id);
          
          // 일정 날짜 조회
          const { data: schedules } = await db
            .from('schedules')
            .select('schedule_id, date')
            .in('schedule_id', scheduleIds);
          
          const scheduleMap = {};
          for (const s of (schedules || [])) {
            scheduleMap[s.schedule_id] = s.date;
          }
          
          // reg_id → schedule_id 매핑
          const regToSchedule = {};
          for (const r of regs) {
            regToSchedule[r.reg_id] = r.schedule_id;
          }
          
          // 강습 기록
          const { data: lessonRecords } = await db
            .from('dive_records')
            .select('record_id, reg_id, discipline, attempt, value, note')
            .in('reg_id', regIds);
          
          for (const r of (lessonRecords || [])) {
            const scheduleId = regToSchedule[r.reg_id];
            const date = scheduleMap[scheduleId] || '날짜 없음';
            allRecords.push({
              ...r,
              date,
              type: '강습'
            });
          }
        }
        
        // 2. 개인 기록 조회 (personal_dive_records)
        const { data: personalRecords } = await db
          .from('personal_dive_records')
          .select(`
            record_id,
            personal_schedule_id,
            discipline,
            attempt,
            value,
            personal_schedules!personal_dive_records_personal_schedule_id_fkey (date)
          `)
          .eq('user_id', currentUser.user_id);
        
        for (const r of (personalRecords || [])) {
          allRecords.push({
            record_id: r.record_id,
            discipline: r.discipline,
            attempt: r.attempt,
            value: r.value,
            date: r.personal_schedules?.date || '날짜 없음',
            type: '개인'
          });
        }
        
        // 기록이 없는 경우
        if (allRecords.length === 0) {
          document.getElementById('my-best-records').innerHTML = 
            '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">기록이 없습니다</div>';
          document.getElementById('my-all-records').innerHTML = 
            '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">기록이 없습니다</div>';
          document.getElementById('growth-chart-card').style.display = 'none';
          return;
        }
        
        // 성장 그래프용 데이터 저장
        allRecordsForChart = allRecords;
        document.getElementById('growth-chart-card').style.display = 'block';
        renderGrowthChart();
        
        // 종목별 최고 기록 계산
        const bestByDiscipline = {};
        for (const r of allRecords) {
          const val = parseFloat(r.value) || 0;
          if (!bestByDiscipline[r.discipline] || val > bestByDiscipline[r.discipline]) {
            bestByDiscipline[r.discipline] = val;
          }
        }
        
        const disciplines = ['STA', 'DYNB', 'FIM', 'CWTB', 'DNF', 'CNF', 'DYN', 'CWT'];
        let bestHtml = '';
        for (const d of disciplines) {
          const best = bestByDiscipline[d];
          let val = '-';
          if (best) {
            if (d === 'STA') {
              const min = Math.floor(best / 60);
              const sec = Math.round(best % 60);
              val = `${min}'${sec.toString().padStart(2, '0')}"`;
            } else {
              val = best + 'm';
            }
          }
          bestHtml += `<div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--divider);">
            <span style="font-weight: 500;">${d}</span>
            <span style="color: var(--primary); font-weight: 600;">${val}</span>
          </div>`;
        }
        
        document.getElementById('my-best-records').innerHTML = bestHtml;
        
        // 날짜별 그룹핑 (날짜별 최고 기록만)
        const recordsByDate = {};
        for (const r of allRecords) {
          if (!recordsByDate[r.date]) {
            recordsByDate[r.date] = {};
          }
          const val = parseFloat(r.value) || 0;
          if (!recordsByDate[r.date][r.discipline] || val > recordsByDate[r.date][r.discipline].value) {
            recordsByDate[r.date][r.discipline] = {
              value: val,
              type: r.type
            };
          }
        }
        
        // 날짜 정렬 (최신순)
        const sortedDates = Object.keys(recordsByDate).sort((a, b) => b.localeCompare(a));
        
        // 연도별로 그룹핑
        const recordsByYear = {};
        for (const date of sortedDates) {
          const year = date.substring(0, 4);
          if (!recordsByYear[year]) {
            recordsByYear[year] = [];
          }
          recordsByYear[year].push(date);
        }
        
        let allHtml = '';
        const sortedYears = Object.keys(recordsByYear).sort((a, b) => b - a);
        
        for (const year of sortedYears) {
          const shortYear = year.substring(2); // '2025' -> '25'
          allHtml += `<div style="font-size: 14px; font-weight: 700; color: var(--text-primary); margin: 16px 0 12px 0; padding-bottom: 8px; border-bottom: 2px solid var(--primary);">
            📆 ${shortYear}년
          </div>`;
          
          for (const date of recordsByYear[year].slice(0, 15)) { // 연도당 최대 15일
            const dateRecords = recordsByDate[date];
            const dateFormatted = formatDateCompact(date);
            
            allHtml += `<div style="margin-bottom: 12px; margin-left: 8px;">
              <div style="font-size: 13px; color: var(--text-secondary); font-weight: 500; margin-bottom: 6px;">
                ${dateFormatted}
              </div>
              <div style="display: flex; flex-wrap: wrap; gap: 6px;">`;
            
            for (const [disc, data] of Object.entries(dateRecords)) {
              const val = disc === 'STA' ? data.value + 's' : data.value + 'm';
              const typeColor = data.type === '개인' ? 'var(--warning)' : 'var(--primary)';
              allHtml += `<div style="background: var(--bg); padding: 6px 10px; border-radius: 8px; display: flex; align-items: center; gap: 4px;">
                <span style="font-weight: 500; font-size: 12px;">${disc}</span>
                <span style="color: ${typeColor}; font-weight: 600; font-size: 13px;">${val}</span>
              </div>`;
            }
            
            allHtml += `</div></div>`;
          }
        }
        
        document.getElementById('my-all-records').innerHTML = allHtml || 
          '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">기록이 없습니다</div>';
        
      } catch (err) {
        console.error('기록 로드 오류:', err);
        document.getElementById('my-best-records').innerHTML = 
          '<div style="text-align: center; color: var(--error); padding: 20px;">기록을 불러오지 못했습니다</div>';
      }
    }
    
    function formatDateShort(dateStr) {
      if (!dateStr || dateStr === '날짜 없음') return dateStr;
      const d = new Date(dateStr);
      const month = d.getMonth() + 1;
      const day = d.getDate();
      const weekdays = ['일', '월', '화', '수', '목', '금', '토'];
      const weekday = weekdays[d.getDay()];
      return `${month}월 ${day}일 (${weekday})`;
    }
    
    function formatDateCompact(dateStr) {
      if (!dateStr || dateStr === '날짜 없음') return dateStr;
      const d = new Date(dateStr);
      const month = d.getMonth() + 1;
      const day = d.getDate();
      const weekdays = ['일', '월', '화', '수', '목', '금', '토'];
      const weekday = weekdays[d.getDay()];
      return `${month}/${day} (${weekday})`;
    }

    // ==================== 임시 함수들 ====================
    function quickRecordInput() {
      // 개인 기록 입력 화면으로 이동
      document.getElementById('personal-date').value = new Date().toISOString().split('T')[0];
      document.getElementById('personal-location').value = '';
      currentPersonalDiscipline = 'STA';
      personalAttempts = [{ value: '', note: '' }];
      renderPersonalAttempts();
      updatePersonalDisciplineUI();
      showScreen('screen-personal-record');
    }

    // ==================== 강습 기록 입력 (표 형태) ====================
    let batchParticipants = [];
    let currentBatchDiscipline = 'STA';
    let batchDisciplines = ['STA', 'DYNB', 'FIM', 'CWTB']; // 선택된 종목들
    let batchSkillItems = []; // 스킬 항목들 (강습 레벨에 따라)
    let batchAttemptCount = 2;
    let batchRecords = {};
    let batchSkills = {};
    let currentBatchScheduleId = null;
    
    // 원본 데이터 (변경 감지용)
    let batchOriginalRecords = {};
    let batchOriginalSkills = {};
    let batchOriginalScheduleNote = '';
    let batchOriginalStudentNotes = {};

    // 진입점 1: 홈 → 최근 강습 기록 입력
    async function quickRecordInput() {
      if (currentUser.user_type !== '강사') {
        openPersonalRecordAdd();
        return;
      }
      
      try {
        const { data: schedules, error } = await db
          .from('schedules')
          .select('schedule_id, date, time, location')
          .eq('instructor_id', currentUser.user_id)
          .order('date', { ascending: false })
          .limit(5);
        
        if (error) throw error;
        
        if (!schedules || schedules.length === 0) {
          showToast('등록된 일정이 없습니다');
          return;
        }
        
        let html = '';
        for (const s of schedules) {
          html += `<div class="schedule-select-item" onclick="openLessonRecordInput('${s.schedule_id}'); closeBottomSheet('sheet-select-schedule');">
            <div style="font-weight: 600;">${formatDate(s.date)} ${formatTime(s.time)}</div>
            <div style="color: var(--text-secondary); font-size: 14px;">${s.location}</div>
          </div>`;
        }
        document.getElementById('recent-schedule-list').innerHTML = html;
        openBottomSheet('sheet-select-schedule');
      } catch (err) {
        console.error('일정 로드 오류:', err);
        showToast('일정을 불러오지 못했습니다');
      }
    }

    // 진입점 2: 일정 카드 → 기록 입력
    async function openLessonRecordInput(scheduleId) {
      currentBatchScheduleId = scheduleId;
      
      try {
        const { data: schedule } = await db
          .from('schedules')
          .select('*')
          .eq('schedule_id', scheduleId)
          .single();
        
        if (schedule) {
          document.getElementById('batch-schedule-date').textContent = formatDate(schedule.date) + ' ' + formatTime(schedule.time);
          document.getElementById('batch-schedule-location').textContent = schedule.location;
          
          // 일정에 저장된 종목 정보 사용 (없으면 빈 배열)
          batchDisciplines = schedule.common_disciplines ? schedule.common_disciplines.split(',') : [];
          
          // 스킬 종목 (영어→한국어 변환)
          if (schedule.common_skill_disciplines) {
            batchSkillItems = schedule.common_skill_disciplines.split(',').map(s => toKoreanSkillName(s));
          } else {
            batchSkillItems = [];
          }
          
          // 일정 총평 노트 로드
          document.getElementById('batch-schedule-note').value = schedule.note || '';
          batchOriginalScheduleNote = schedule.note || '';
        } else {
          batchDisciplines = [];
          batchSkillItems = [];
          document.getElementById('batch-schedule-note').value = '';
          batchOriginalScheduleNote = '';
        }
        
        const { data: regs, error } = await db
          .from('registrations')
          .select(`
            reg_id,
            student_id,
            purpose,
            lesson_level,
            note_instructor,
            users!registrations_student_id_fkey (name, cert_level)
          `)
          .eq('schedule_id', scheduleId);
        
        if (error) throw error;
        
        if (!regs || regs.length === 0) {
          showToast('참가자가 없습니다');
          return;
        }
        
        batchParticipants = regs.map(r => ({
          reg_id: r.reg_id,
          student_id: r.student_id,
          name: r.users?.name || '알 수 없음',
          purpose: r.purpose,
          lesson_level: r.lesson_level,
          note_instructor: r.note_instructor || ''
        }));
        
        // 학생별 피드백 원본 저장
        batchOriginalStudentNotes = {};
        for (const p of batchParticipants) {
          batchOriginalStudentNotes[p.reg_id] = p.note_instructor || '';
        }
        
        // 초기화
        batchRecords = {};
        batchSkills = {};
        batchOriginalRecords = {};
        batchOriginalSkills = {};
        batchAttemptCount = 2;
        currentBatchDiscipline = batchDisciplines.length > 0 ? batchDisciplines[0] : 'STA';
        
        for (const p of batchParticipants) {
          batchRecords[p.reg_id] = {};
          batchSkills[p.reg_id] = {};
        }
        
        // 기존 기록 로드
        await loadExistingBatchRecords();
        
        renderBatchDisciplineTabs();
        renderBatchSelectedDisciplines();
        renderBatchTable();
        renderBatchStudentNotes();
        
        showScreen('screen-batch-record');
      } catch (err) {
        console.error('기록 입력 오류:', err);
        showToast('참가자 로드 실패');
      }
    }
    
    // 학생별 피드백 입력란 렌더링
    function renderBatchStudentNotes() {
      let html = '';
      for (const p of batchParticipants) {
        html += `
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
            <span style="min-width: 60px; font-size: 14px; color: var(--text-secondary);">${p.name}</span>
            <input type="text" class="input" style="flex: 1; padding: 10px 12px;" 
              id="batch-note-${p.reg_id}" 
              value="${p.note_instructor || ''}" 
              placeholder="피드백 입력">
          </div>
        `;
      }
      document.getElementById('batch-student-notes').innerHTML = html;
    }

    // 스킬 종목 영어↔한국어 매핑
    const SKILL_NAME_MAP = {
      // 영어 → 한국어 (DB에서 읽어올 때)
      'neutral_buoyancy': '중성부력',
      'freefall': '프리폴',
      'arms_only_15m': '암스온리 15m',
      'buddy_10_15m': '버디 10-15m',
      'lanyard_remove': '렌야드 제거',
      'no_mask_10m': '노마스크 10m',
      'rescue_towing': '레스큐+토잉',
      'theory_test': '이론 평가',
      'rescue_5_10m': '레스큐 5-10m',
      'theory_test_lv2': '이론 평가',
      // 한국어 → 영어 (DB에 저장할 때)
      '중성부력': 'neutral_buoyancy',
      '프리폴': 'freefall',
      '암스온리 15m': 'arms_only_15m',
      '버디 10-15m': 'buddy_10_15m',
      '렌야드 제거': 'lanyard_remove',
      '노마스크 10m': 'no_mask_10m',
      '레스큐+토잉': 'rescue_towing',
      '이론 평가': 'theory_test',
      '레스큐 5-10m': 'rescue_5_10m'
    };

    // 스킬명을 한국어로 변환
    function toKoreanSkillName(name) {
      return SKILL_NAME_MAP[name] || name;
    }

    // 스킬명을 영어로 변환 (DB 저장용)
    function toEnglishSkillName(name) {
      return SKILL_NAME_MAP[name] || name;
    }

    // 기존 기록 로드
    async function loadExistingBatchRecords() {
      const regIds = batchParticipants.map(p => p.reg_id);
      
      try {
        // 다이브 기록 로드
        const { data: diveRecords } = await db
          .from('dive_records')
          .select('*')
          .in('reg_id', regIds);
        
        if (diveRecords) {
          for (const r of diveRecords) {
            if (!batchRecords[r.reg_id]) batchRecords[r.reg_id] = {};
            if (!batchRecords[r.reg_id][r.discipline]) {
              batchRecords[r.reg_id][r.discipline] = { attempts: [], note: '', recordIds: [] };
            }
            
            const attemptIdx = (r.attempt || 1) - 1;
            const valStr = r.value?.toString() || '';
            batchRecords[r.reg_id][r.discipline].attempts[attemptIdx] = valStr;
            // record_id 저장 (이미 저장된 기록 표시)
            batchRecords[r.reg_id][r.discipline].recordIds[attemptIdx] = r.record_id;
            if (r.note) {
              batchRecords[r.reg_id][r.discipline].note = r.note;
            }
            
            // 시도 수 업데이트
            if (r.attempt > batchAttemptCount) {
              batchAttemptCount = r.attempt;
            }
            
            // 종목 추가
            if (!batchDisciplines.includes(r.discipline)) {
              batchDisciplines.push(r.discipline);
            }
          }
        }
        
        // 스킬 기록 로드 (시도별로)
        const { data: skillRecords } = await db
          .from('skill_records')
          .select('*')
          .in('reg_id', regIds);
        
        if (skillRecords) {
          for (const r of skillRecords) {
            if (!batchSkills[r.reg_id]) batchSkills[r.reg_id] = {};
            
            // 한국어로 변환
            const koreanName = toKoreanSkillName(r.discipline);
            
            if (!batchSkills[r.reg_id][koreanName]) {
              batchSkills[r.reg_id][koreanName] = { attempts: [], recordIds: [] };
            }
            
            const attemptIdx = (r.attempt || 1) - 1;
            const result = r.result === 'Y' ? 'Y' : 'N';
            batchSkills[r.reg_id][koreanName].attempts[attemptIdx] = result;
            batchSkills[r.reg_id][koreanName].recordIds[attemptIdx] = r.record_id;
            
            // 스킬 종목 추가 (한국어로)
            if (!batchSkillItems.includes(koreanName)) {
              batchSkillItems.push(koreanName);
            }
            
            // 스킬 시도 수 업데이트
            if (r.attempt > batchAttemptCount) {
              batchAttemptCount = r.attempt;
            }
          }
        }
        
        // 원본 데이터 깊은 복사 (변경 감지용)
        batchOriginalRecords = JSON.parse(JSON.stringify(batchRecords));
        batchOriginalSkills = JSON.parse(JSON.stringify(batchSkills));
        
      } catch (err) {
        console.error('기존 기록 로드 오류:', err);
      }
    }

    function renderBatchDisciplineTabs() {
      // Lv2, Lv3 스킬 분류
      const lv2SkillNames = ['레스큐 5-10m', '이론 평가'];
      const lv3SkillNames = ['렌야드 제거', '노마스크 10m', '레스큐+토잉', '중성부력', '프리폴', '암스온리 15m', '버디 10-15m'];
      
      const lv2Skills = batchSkillItems.filter(sk => lv2SkillNames.includes(sk));
      let lv3Skills = batchSkillItems.filter(sk => lv3SkillNames.includes(sk));
      // 이론 평가 처리 (Lv2에 없으면 Lv3에 추가)
      if (batchSkillItems.includes('이론 평가') && !lv2Skills.includes('이론 평가')) {
        lv3Skills.push('이론 평가');
      }
      
      let html = '<div style="display: flex; flex-wrap: wrap; gap: 6px;">';
      
      // 기록 종목
      for (const disc of batchDisciplines) {
        const active = disc === currentBatchDiscipline ? 'active' : '';
        html += `<button class="batch-disc-tag ${active}" onclick="selectBatchDiscipline('${disc}')">${disc}</button>`;
      }
      
      // Lv3 스킬 먼저
      for (const skill of lv3Skills) {
        const active = currentBatchDiscipline === skill ? 'active' : '';
        html += `<button class="batch-skill-tag lv3 ${active}" onclick="selectBatchDiscipline('${skill}')">${skill}</button>`;
      }
      
      // Lv2 스킬
      for (const skill of lv2Skills) {
        const active = currentBatchDiscipline === skill ? 'active' : '';
        html += `<button class="batch-skill-tag lv2 ${active}" onclick="selectBatchDiscipline('${skill}')">${skill}</button>`;
      }
      
      html += '</div>';
      document.getElementById('batch-discipline-tabs').innerHTML = html;
    }

    function renderBatchSelectedDisciplines() {
      // 상단 카드에서 종목 표시 제거됨 - 이제 사용하지 않음
    }

    function openBatchAddDisciplineSheet() {
      const allDiscs = ['STA', 'DYNB', 'FIM', 'CWTB', 'DNF', 'CNF', 'DYN', 'CWT'];
      const allSkills = {
        'Lv2': ['레스큐 5-10m', '이론 평가'],
        'Lv3': ['렌야드 제거', '노마스크 10m', '레스큐+토잉', '중성부력', '프리폴', '암스온리 15m', '버디 10-15m', '이론 평가']
      };
      
      // 참가자들의 레슨 레벨 확인
      const lessonLevels = batchParticipants.filter(p => p.purpose === '강습').map(p => p.lesson_level);
      const hasLv2 = lessonLevels.includes(2);
      const hasLv3 = lessonLevels.includes(3);
      
      let html = '<div style="margin-bottom: 20px;">';
      html += '<div style="font-weight: 600; margin-bottom: 12px;">기록 종목</div>';
      html += '<div style="display: flex; flex-wrap: wrap; gap: 4px;">';
      
      for (const d of allDiscs) {
        const checked = batchDisciplines.includes(d) ? 'checked' : '';
        html += `<label style="display: inline-flex; align-items: center; gap: 6px; padding: 8px 12px;">
          <input type="checkbox" value="${d}" data-type="disc" ${checked}> ${d}
        </label>`;
      }
      html += '</div></div>';
      
      // 스킬 종목
      if (hasLv2 || hasLv3) {
        html += '<div style="border-top: 1px solid var(--divider); padding-top: 16px;">';
        html += '<div style="font-weight: 600; margin-bottom: 12px;">스킬 종목</div>';
        
        if (hasLv2) {
          html += '<div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">Lv2</div>';
          html += '<div style="display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 12px;">';
          for (const s of allSkills['Lv2']) {
            const checked = batchSkillItems.includes(s) ? 'checked' : '';
            html += `<label style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px;">
              <input type="checkbox" value="${s}" data-type="skill" ${checked}> ${s}
            </label>`;
          }
          html += '</div>';
        }
        
        if (hasLv3) {
          html += '<div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">Lv3</div>';
          html += '<div style="display: flex; flex-wrap: wrap; gap: 4px;">';
          for (const s of allSkills['Lv3']) {
            const checked = batchSkillItems.includes(s) ? 'checked' : '';
            html += `<label style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px;">
              <input type="checkbox" value="${s}" data-type="skill" ${checked}> ${s}
            </label>`;
          }
          html += '</div>';
        }
        html += '</div>';
      }
      
      document.getElementById('batch-add-discipline-options').innerHTML = html;
      openBottomSheet('sheet-batch-add-discipline');
    }

    function confirmBatchAddDiscipline() {
      const selectedDiscs = [];
      const selectedSkills = [];
      
      document.querySelectorAll('#batch-add-discipline-options input:checked').forEach(cb => {
        if (cb.dataset.type === 'disc') {
          selectedDiscs.push(cb.value);
        } else if (cb.dataset.type === 'skill') {
          selectedSkills.push(cb.value);
        }
      });
      
      if (selectedDiscs.length === 0) {
        showToast('최소 1개 기록 종목을 선택하세요');
        return;
      }
      
      batchDisciplines = selectedDiscs;
      batchSkillItems = selectedSkills;
      
      // 현재 선택된 종목이 유효하지 않으면 첫 번째로 변경
      const allDisciplines = [...batchDisciplines, ...batchSkillItems];
      if (!allDisciplines.includes(currentBatchDiscipline)) {
        currentBatchDiscipline = batchDisciplines[0] || batchSkillItems[0];
      }
      
      closeBottomSheet('sheet-batch-add-discipline');
      renderBatchDisciplineTabs();
      renderBatchSelectedDisciplines();
      renderBatchTable();
    }

    function closeBatchRecord() {
      if (currentBatchScheduleId) {
        currentScheduleId = currentBatchScheduleId;
        showScreen('screen-schedule-manage');
      } else {
        goBack();
      }
    }

    function selectBatchDiscipline(disc) {
      saveBatchCurrentInput();
      currentBatchDiscipline = disc;
      renderBatchDisciplineTabs();
      renderBatchTable();
    }

    function updateBatchDisciplineUI() {
      renderBatchDisciplineTabs();
      renderBatchTable();
    }

    function renderBatchTable() {
      // 종목이 없으면 안내 메시지
      if (batchDisciplines.length === 0 && batchSkillItems.length === 0) {
        document.getElementById('batch-record-table-card').style.display = 'block';
        document.getElementById('batch-skill-table-card').style.display = 'none';
        document.getElementById('batch-record-tbody').innerHTML = `
          <tr><td colspan="5" style="text-align: center; padding: 40px; color: var(--text-tertiary);">
            종목이 설정되지 않았습니다.<br>+ 수정 버튼을 눌러 종목을 추가하세요.
          </td></tr>`;
        document.querySelector('#batch-record-table thead').innerHTML = '<tr><th></th></tr>';
        return;
      }
      
      // 스킬 종목인지 확인
      const isSkillDiscipline = batchSkillItems.includes(currentBatchDiscipline);
      
      // 기록 테이블만 사용 (스킬 테이블 숨김)
      document.getElementById('batch-record-table-card').style.display = 'block';
      document.getElementById('batch-skill-table-card').style.display = 'none';
      
      // 헤더 렌더링
      let headerHtml = '<tr><th class="col-name">학생명</th>';
      for (let i = 1; i <= batchAttemptCount; i++) {
        headerHtml += `<th class="col-attempt">${i}차</th>`;
      }
      headerHtml += `<th class="col-add-attempt"><button class="btn-add-col" onclick="addBatchAttemptColumn()">+</button></th>`;
      if (!isSkillDiscipline) {
        headerHtml += '<th class="col-note">메모</th>';
      }
      headerHtml += '</tr>';
      document.querySelector('#batch-record-table thead').innerHTML = headerHtml;
      
      // 바디 렌더링
      let bodyHtml = '';
      for (const p of batchParticipants) {
        // 모든 참여자 표시 (강습/펀다이빙 구분 없음)
        
        bodyHtml += `<tr data-reg-id="${p.reg_id}">
          <td class="col-name">${p.name}</td>`;
        
        if (isSkillDiscipline) {
          // 스킬 종목: Y/N 버튼
          const skills = batchSkills[p.reg_id]?.[currentBatchDiscipline] || { attempts: [] };
          for (let i = 0; i < batchAttemptCount; i++) {
            const val = skills.attempts[i] || '';
            const successClass = val === 'Y' ? 'success' : '';
            const failClass = val === 'N' ? 'fail' : '';
            bodyHtml += `<td>
              <button class="skill-check-btn ${successClass} ${failClass}" 
                      onclick="toggleSkillAttempt('${p.reg_id}', ${i}, this)"
                      data-attempt="${i}">
                ${val === 'Y' ? '✓' : val === 'N' ? '✗' : '-'}
              </button>
            </td>`;
          }
          bodyHtml += `<td></td></tr>`;
        } else {
          // 기록 종목: 숫자 입력
          const records = batchRecords[p.reg_id]?.[currentBatchDiscipline] || { attempts: [], note: '' };
          for (let i = 0; i < batchAttemptCount; i++) {
            const val = records.attempts[i] || '';
            bodyHtml += `<td><input type="number" value="${val}" data-attempt="${i}" placeholder="-"></td>`;
          }
          bodyHtml += `<td></td>`;
          bodyHtml += `<td><input type="text" class="note-input" value="${records.note || ''}" data-note="true" placeholder=""></td>
          </tr>`;
        }
      }
      
      document.getElementById('batch-record-tbody').innerHTML = bodyHtml;
    }
    
    // 스킬 시도 토글 (Y → N → 빈값 순환)
    function toggleSkillAttempt(regId, attemptIdx, btn) {
      if (!batchSkills[regId]) batchSkills[regId] = {};
      if (!batchSkills[regId][currentBatchDiscipline]) {
        batchSkills[regId][currentBatchDiscipline] = { attempts: [], recordIds: [] };
      }
      
      const current = batchSkills[regId][currentBatchDiscipline].attempts[attemptIdx] || '';
      let next = '';
      
      if (current === '') next = 'Y';
      else if (current === 'Y') next = 'N';
      else next = '';
      
      batchSkills[regId][currentBatchDiscipline].attempts[attemptIdx] = next;
      
      btn.className = 'skill-check-btn ' + (next === 'Y' ? 'success' : next === 'N' ? 'fail' : '');
      btn.textContent = next === 'Y' ? '✓' : next === 'N' ? '✗' : '-';
    }

    function addBatchAttemptColumn() {
      saveBatchCurrentInput();
      batchAttemptCount++;
      renderBatchTable();
    }

    function saveBatchCurrentInput() {
      const isSkillDiscipline = batchSkillItems.includes(currentBatchDiscipline);
      if (isSkillDiscipline) return; // 스킬은 버튼 클릭 시 즉시 저장됨
      
      const rows = document.querySelectorAll('#batch-record-tbody tr');
      rows.forEach(row => {
        const regId = row.dataset.regId;
        if (!regId) return;
        
        if (!batchRecords[regId]) batchRecords[regId] = {};
        if (!batchRecords[regId][currentBatchDiscipline]) {
          batchRecords[regId][currentBatchDiscipline] = { attempts: [], note: '' };
        }
        
        const inputs = row.querySelectorAll('input');
        const attempts = [];
        let note = '';
        
        inputs.forEach(input => {
          if (input.dataset.note) {
            note = input.value;
          } else if (input.dataset.attempt !== undefined) {
            attempts[parseInt(input.dataset.attempt)] = input.value;
          }
        });
        
        batchRecords[regId][currentBatchDiscipline] = { attempts, note };
      });
    }

    async function saveBatchRecords(finish = false) {
      saveBatchCurrentInput();
      
      try {
        let totalSaved = 0;
        let totalUpdated = 0;
        let totalDeleted = 0;
        
        // ===== 다이브 기록 처리 =====
        for (const regId of Object.keys(batchRecords)) {
          for (const discipline of Object.keys(batchRecords[regId])) {
            const data = batchRecords[regId][discipline];
            const originalData = batchOriginalRecords[regId]?.[discipline] || { attempts: [], recordIds: [] };
            
            for (let i = 0; i < Math.max(data.attempts.length, originalData.attempts.length); i++) {
              const newVal = data.attempts[i] || '';
              const oldVal = originalData.attempts[i] || '';
              const existingRecordId = originalData.recordIds?.[i];
              
              // 값이 없어진 경우 (삭제)
              if (oldVal && !newVal && existingRecordId) {
                await db.from('dive_records').delete().eq('record_id', existingRecordId);
                totalDeleted++;
              }
              // 새로운 값 (추가)
              else if (newVal && !existingRecordId) {
                const recordId = 'DR_' + regId + '_' + discipline + '_' + Date.now() + '_' + i + '_' + Math.random().toString(36).substr(2, 5);
                await db.from('dive_records').insert({
                  record_id: recordId,
                  reg_id: regId,
                  discipline: discipline,
                  attempt: i + 1,
                  value: parseFloat(newVal),
                  note: i === 0 ? data.note : null
                });
                totalSaved++;
              }
              // 값이 변경된 경우 (업데이트)
              else if (newVal && existingRecordId && newVal !== oldVal) {
                await db.from('dive_records').update({
                  value: parseFloat(newVal),
                  note: i === 0 ? data.note : null
                }).eq('record_id', existingRecordId);
                totalUpdated++;
              }
              // 노트만 변경된 경우
              else if (i === 0 && newVal && existingRecordId && data.note !== originalData.note) {
                await db.from('dive_records').update({ note: data.note || null }).eq('record_id', existingRecordId);
                totalUpdated++;
              }
            }
          }
        }
        
        // ===== 스킬 기록 처리 =====
        for (const regId of Object.keys(batchSkills)) {
          for (const skillName of Object.keys(batchSkills[regId])) {
            const data = batchSkills[regId][skillName];
            if (!data || !data.attempts) continue;
            
            const originalData = batchOriginalSkills[regId]?.[skillName] || { attempts: [], recordIds: [] };
            const englishName = toEnglishSkillName(skillName);
            
            for (let i = 0; i < Math.max(data.attempts.length, originalData.attempts.length); i++) {
              const newVal = data.attempts[i] || '';
              const oldVal = originalData.attempts[i] || '';
              const existingRecordId = originalData.recordIds?.[i];
              
              // 값이 없어진 경우 (삭제)
              if (oldVal && !newVal && existingRecordId) {
                await db.from('skill_records').delete().eq('record_id', existingRecordId);
                totalDeleted++;
              }
              // 새로운 값 (추가)
              else if (newVal && !existingRecordId) {
                const recordId = 'SR_' + regId + '_' + Date.now() + '_' + i + '_' + Math.random().toString(36).substr(2, 5);
                await db.from('skill_records').insert({
                  record_id: recordId,
                  reg_id: regId,
                  discipline: englishName,
                  attempt: i + 1,
                  result: newVal === 'Y' ? 'Y' : 'N',
                  note: null
                });
                totalSaved++;
              }
              // 값이 변경된 경우 (업데이트)
              else if (newVal && existingRecordId && newVal !== oldVal) {
                await db.from('skill_records').update({
                  result: newVal === 'Y' ? 'Y' : 'N'
                }).eq('record_id', existingRecordId);
                totalUpdated++;
              }
            }
          }
        }
        
        // ===== 노트 처리 (변경된 경우만) =====
        const scheduleNote = document.getElementById('batch-schedule-note').value.trim();
        if (scheduleNote !== batchOriginalScheduleNote) {
          await db.from('schedules').update({ note: scheduleNote || null }).eq('schedule_id', currentBatchScheduleId);
        }
        
        for (const p of batchParticipants) {
          const noteInput = document.getElementById(`batch-note-${p.reg_id}`);
          const noteValue = noteInput ? noteInput.value.trim() : '';
          const originalNote = batchOriginalStudentNotes[p.reg_id] || '';
          
          if (noteValue !== originalNote) {
            await db.from('registrations').update({ note_instructor: noteValue || null }).eq('reg_id', p.reg_id);
          }
        }
        
        // Users Best 기록 업데이트 (변경이 있을 때만)
        if (totalSaved > 0 || totalUpdated > 0 || totalDeleted > 0) {
          await updateUsersBestRecords();
          await updateLvProgress();
        }
        
        const totalChanges = totalSaved + totalUpdated + totalDeleted;
        if (totalChanges > 0) {
          showToast(`저장 완료 (추가: ${totalSaved}, 수정: ${totalUpdated}, 삭제: ${totalDeleted})`);
        } else {
          showToast('변경사항이 없습니다');
        }
        
        if (finish) {
          closeBatchRecord();
        } else {
          // DB에서 다시 로드해서 UI 갱신
          batchRecords = {};
          batchSkills = {};
          for (const p of batchParticipants) {
            batchRecords[p.reg_id] = {};
            batchSkills[p.reg_id] = {};
          }
          await loadExistingBatchRecords();
          renderBatchTable();
        }
      } catch (err) {
        console.error('저장 오류:', err);
        showToast('저장 실패: ' + err.message);
      }
    }
    
    // Users Best 기록 업데이트 함수 (모든 학생 대상)
    async function updateUsersBestRecords() {
      try {
        const studentIds = [...new Set(batchParticipants.map(p => p.student_id))];
        
        const { data: students } = await db
          .from('users')
          .select('user_id, best_sta, best_dynb, best_fim, best_cwtb')
          .in('user_id', studentIds);
        
        if (!students) return;
        
        for (const student of students) {
          const participant = batchParticipants.find(p => p.student_id === student.user_id);
          if (!participant) continue;
          
          const regId = participant.reg_id;
          const diveRecords = batchRecords[regId] || {};
          
          const updates = {};
          for (const disc of ['STA', 'DYNB', 'FIM', 'CWTB']) {
            const data = diveRecords[disc];
            if (!data || !data.attempts) continue;
            
            const maxValue = Math.max(...data.attempts.filter(v => v && v !== '').map(v => parseFloat(v)));
            if (isNaN(maxValue) || maxValue <= 0) continue;
            
            const bestKey = 'best_' + disc.toLowerCase();
            const currentBest = student[bestKey] || 0;
            
            if (maxValue > currentBest) {
              updates[bestKey] = maxValue;
            }
          }
          
          if (Object.keys(updates).length > 0) {
            await db
              .from('users')
              .update(updates)
              .eq('user_id', student.user_id);
          }
        }
      } catch (err) {
        console.error('Best 기록 업데이트 오류:', err);
      }
    }
    
    // LV Progress 업데이트 함수 (레벨 과정 중인 학생만)
    async function updateLvProgress() {
      try {
        const studentIds = [...new Set(batchParticipants.map(p => p.student_id))];
        
        const { data: students } = await db
          .from('users')
          .select('user_id, in_training_level')
          .in('user_id', studentIds);
        
        if (!students) return;
        
        for (const student of students) {
          const level = student.in_training_level;
          if (!level || (level !== 2 && level !== 3)) continue;
          
          const participant = batchParticipants.find(p => p.student_id === student.user_id);
          if (!participant) continue;
          
          const regId = participant.reg_id;
          const tableName = level === 2 ? 'lv2_progress' : 'lv3_progress';
          const req = LEVEL_REQUIREMENTS[level];
          
          // 현재 진도 조회
          let { data: progress } = await db
            .from(tableName)
            .select('*')
            .eq('user_id', student.user_id)
            .single();
          
          // 진도 레코드가 없으면 생성
          if (!progress) {
            const { data: newProgress } = await db
              .from(tableName)
              .insert({ user_id: student.user_id })
              .select()
              .single();
            progress = newProgress || {};
          }
          
          const updates = {};
          
          // 기록 종목 업데이트 (STA, DYNB, FIM, CWTB)
          const diveRecords = batchRecords[regId] || {};
          for (const disc of ['STA', 'DYNB', 'FIM', 'CWTB']) {
            const data = diveRecords[disc];
            if (!data || !data.attempts) continue;
            
            const maxValue = Math.max(...data.attempts.filter(v => v && v !== '').map(v => parseFloat(v)));
            if (isNaN(maxValue) || maxValue <= 0) continue;
            
            const key = disc.toLowerCase();
            const currentValue = progress[key] || 0;
            
            if (maxValue > currentValue) {
              updates[key] = maxValue;
            }
          }
          
          // 스킬 종목 업데이트
          const skillRecords = batchSkills[regId] || {};
          for (const skill of req.skills) {
            const koreanName = toKoreanSkillName(skill.key);
            const skillData = skillRecords[koreanName];
            
            if (!skillData || !skillData.attempts) continue;
            
            // 시도 횟수 계산 (Y 또는 N이 있는 시도만)
            const attemptCount = skillData.attempts.filter(v => v === 'Y' || v === 'N').length;
            if (attemptCount > 0) {
              const attemptKey = skill.key + '_attempts';
              const currentAttempts = progress[attemptKey] || 0;
              updates[attemptKey] = currentAttempts + attemptCount;
            }
            
            // 성공이 하나라도 있으면 Y로 업데이트
            const hasSuccess = skillData.attempts.some(v => v === 'Y');
            if (hasSuccess && progress[skill.key] !== 'Y') {
              updates[skill.key] = 'Y';
            }
          }
          
          // 강습 횟수 업데이트 (강습 목적인 경우만)
          if (participant.purpose === '강습') {
            const currentLessonCount = progress.lesson_count || 0;
            updates.lesson_count = currentLessonCount + 1;
          }
          
          if (Object.keys(updates).length > 0) {
            await db
              .from(tableName)
              .update(updates)
              .eq('user_id', student.user_id);
          }
        }
      } catch (err) {
        console.error('LV Progress 업데이트 오류:', err);
      }
    }

    // ==================== 개인 기록 입력 ====================
    let personalDate = '';
    let personalTime = '';
    let personalLocation = '';
    let personalDisciplines = ['STA', 'DYNB', 'FIM', 'CWTB'];
    let personalAttemptCount = 2;
    let personalRecords = {}; // { discipline: [val1, val2, ...] }
    let personalMemo = '';

    // 개별 추가 진입점
    function openPersonalRecordAdd() {
      document.getElementById('personal-add-date').value = new Date().toISOString().split('T')[0];
      document.getElementById('personal-add-time').value = '';
      document.getElementById('personal-add-location').value = '';
      
      // 체크박스 초기화
      document.querySelectorAll('#personal-discipline-checks input').forEach(cb => {
        cb.checked = ['STA', 'DYNB', 'FIM', 'CWTB'].includes(cb.value);
      });
      
      openBottomSheet('sheet-personal-add');
    }

    function startPersonalRecordInput() {
      personalDate = document.getElementById('personal-add-date').value;
      personalTime = document.getElementById('personal-add-time').value;
      personalLocation = document.getElementById('personal-add-location').value;
      
      if (!personalDate) {
        showToast('날짜를 선택해주세요');
        return;
      }
      
      // 선택된 종목
      personalDisciplines = [];
      document.querySelectorAll('#personal-discipline-checks input:checked').forEach(cb => {
        personalDisciplines.push(cb.value);
      });
      
      if (personalDisciplines.length === 0) {
        showToast('종목을 선택해주세요');
        return;
      }
      
      // 초기화
      personalAttemptCount = 2;
      personalRecords = {};
      for (const d of personalDisciplines) {
        personalRecords[d] = [];
      }
      personalMemo = '';
      
      closeBottomSheet('sheet-personal-add');
      renderPersonalRecordScreen();
      showScreen('screen-personal-record');
    }

    function renderPersonalRecordScreen() {
      // 날짜/장소 표시
      document.getElementById('personal-date-display').textContent = formatDate(personalDate) + (personalTime ? ' ' + formatTime(personalTime) : '');
      document.getElementById('personal-location-display').textContent = personalLocation || '장소 미입력';
      
      // 테이블 헤더
      let headerHtml = '<tr><th class="col-name">종목</th>';
      for (let i = 1; i <= personalAttemptCount; i++) {
        headerHtml += `<th class="col-attempt">${i}차</th>`;
      }
      headerHtml += '</tr>';
      document.querySelector('#personal-record-table thead').innerHTML = headerHtml;
      
      // 테이블 바디
      let bodyHtml = '';
      for (const disc of personalDisciplines) {
        const records = personalRecords[disc] || [];
        
        bodyHtml += `<tr data-disc="${disc}">
          <td class="col-name">${disc}</td>`;
        
        for (let i = 0; i < personalAttemptCount; i++) {
          const val = records[i] || '';
          bodyHtml += `<td><input type="number" value="${val}" data-attempt="${i}" placeholder="-"></td>`;
        }
        
        bodyHtml += '</tr>';
      }
      
      document.getElementById('personal-record-tbody').innerHTML = bodyHtml;
      document.getElementById('personal-memo').value = personalMemo;
    }

    function addPersonalAttemptColumn() {
      savePersonalCurrentInput();
      personalAttemptCount++;
      renderPersonalRecordScreen();
    }

    function openAddDisciplineSheet() {
      const allDiscs = ['STA', 'DYNB', 'FIM', 'CWTB', 'DNF', 'CNF', 'DYN', 'CWT'];
      let html = '';
      
      for (const d of allDiscs) {
        const checked = personalDisciplines.includes(d) ? 'checked disabled' : '';
        html += `<label style="display: flex; align-items: center; gap: 8px; padding: 8px;">
          <input type="checkbox" value="${d}" ${checked}> ${d}
        </label>`;
      }
      
      document.getElementById('add-discipline-options').innerHTML = html;
      openBottomSheet('sheet-add-discipline');
    }

    function confirmAddDiscipline() {
      document.querySelectorAll('#add-discipline-options input:checked:not(:disabled)').forEach(cb => {
        if (!personalDisciplines.includes(cb.value)) {
          personalDisciplines.push(cb.value);
          personalRecords[cb.value] = [];
        }
      });
      
      closeBottomSheet('sheet-add-discipline');
      renderPersonalRecordScreen();
    }

    function openPersonalDateEdit() {
      const newDate = prompt('날짜 (YYYY-MM-DD):', personalDate);
      if (newDate) {
        personalDate = newDate;
        renderPersonalRecordScreen();
      }
    }

    function savePersonalCurrentInput() {
      const rows = document.querySelectorAll('#personal-record-tbody tr');
      rows.forEach(row => {
        const disc = row.dataset.disc;
        if (!disc) return;
        
        const inputs = row.querySelectorAll('input');
        const attempts = [];
        
        inputs.forEach(input => {
          if (input.dataset.attempt !== undefined) {
            attempts[parseInt(input.dataset.attempt)] = input.value;
          }
        });
        
        personalRecords[disc] = attempts;
      });
      
      personalMemo = document.getElementById('personal-memo')?.value || '';
    }

    async function savePersonalRecord(finish = false) {
      savePersonalCurrentInput();
      personalMemo = document.getElementById('personal-memo').value.trim();
      
      try {
        const personalScheduleId = 'PS_' + currentUser.user_id + '_' + Date.now();
        
        const { error: scheduleError } = await db
          .from('personal_schedules')
          .insert({
            personal_schedule_id: personalScheduleId,
            date: personalDate,
            time: personalTime || null,
            location: personalLocation || null,
            common_disciplines: personalDisciplines.join(','),
            note: personalMemo || null
          });
        
        if (scheduleError) throw scheduleError;
        
        let totalSaved = 0;
        
        for (const disc of Object.keys(personalRecords)) {
          const attempts = personalRecords[disc];
          
          for (let i = 0; i < attempts.length; i++) {
            const val = attempts[i];
            if (!val || val === '') continue;
            
            const recordId = 'PDR_' + currentUser.user_id + '_' + Date.now() + '_' + disc + '_' + i;
            
            const { error } = await db
              .from('personal_dive_records')
              .insert({
                record_id: recordId,
                personal_schedule_id: personalScheduleId,
                user_id: currentUser.user_id,
                discipline: disc,
                attempt: i + 1,
                value: parseFloat(val)
              });
            
            if (!error) totalSaved++;
          }
        }
        
        showToast(`${totalSaved}개 기록이 저장되었습니다`);
        
        if (finish) {
          showScreen('screen-my-records');
        } else {
          personalRecords = {};
          for (const d of personalDisciplines) {
            personalRecords[d] = [];
          }
          renderPersonalRecordScreen();
        }
      } catch (err) {
        console.error('개인 기록 저장 오류:', err);
        showToast('저장 실패: ' + err.message);
      }
    }

    // ==================== 개인 기록 일괄 추가 ====================
    let bulkDates = [];
    let currentBulkDateIndex = 0;
    let bulkRecords = {};
    let bulkDisciplines = ['CWTB', 'FIM'];
    let bulkAttemptCount = 2;

    function openPersonalBulkAdd() {
      bulkDates = [{ date: '', location: '' }];
      bulkRecords = {};
      bulkDisciplines = ['CWTB', 'FIM'];
      bulkAttemptCount = 2;
      renderBulkDateList();
      renderBulkTabbar();
      showScreen('screen-personal-bulk');
    }

    function renderBulkTabbar() {
      const isInstructor = currentUser.user_type === '강사';
      const html = `
        <button class="tab-item" onclick="showScreen('${isInstructor ? 'screen-instructor-home' : 'screen-student-home'}')"><i class="fas fa-home"></i><span>홈</span></button>
        <button class="tab-item" onclick="showScreen('${isInstructor ? 'screen-schedule-manage' : 'screen-student-schedule'}')"><i class="fas fa-calendar"></i><span>일정</span></button>
        <button class="tab-item active"><i class="fas fa-chart-line"></i><span>내기록</span></button>
        <button class="tab-item" onclick="showScreen('screen-mypage')"><i class="fas fa-user"></i><span>마이</span></button>
      `;
      const tabbar1 = document.getElementById('bulk-tabbar');
      const tabbar2 = document.getElementById('bulk-input-tabbar');
      if (tabbar1) tabbar1.innerHTML = html;
      if (tabbar2) tabbar2.innerHTML = html;
    }

    function renderBulkDateList() {
      let html = '';
      bulkDates.forEach((d, idx) => {
        html += `<div class="card" style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px; padding: 12px;">
          <input type="text" class="input" style="flex: 0.4;" placeholder="YYMMDD" value="${d.date}" 
                 onchange="bulkDates[${idx}].date = this.value">
          <input type="text" class="input" style="flex: 0.6;" placeholder="장소" value="${d.location}"
                 onchange="bulkDates[${idx}].location = this.value">
          ${bulkDates.length > 1 ? `<button class="attempt-delete" onclick="removeBulkDateRow(${idx})"><i class="fas fa-times"></i></button>` : ''}
        </div>`;
      });
      document.getElementById('bulk-date-list').innerHTML = html;
    }

    function addBulkDateRow() {
      bulkDates.push({ date: '', location: '' });
      renderBulkDateList();
    }

    function removeBulkDateRow(idx) {
      bulkDates.splice(idx, 1);
      renderBulkDateList();
    }

    function proceedToBulkRecordInput() {
      bulkDates = bulkDates.filter(d => d.date && d.date.length === 6);
      
      if (bulkDates.length === 0) {
        showToast('날짜를 입력해주세요 (YYMMDD 형식)');
        return;
      }
      
      currentBulkDateIndex = 0;
      bulkRecords = {};
      bulkAttemptCount = 2;
      
      for (let i = 0; i < bulkDates.length; i++) {
        bulkRecords[i] = {};
        for (const d of bulkDisciplines) {
          bulkRecords[i][d] = [];
        }
      }
      
      renderBulkDateTabs();
      renderBulkRecordTable();
      renderBulkTabbar();
      showScreen('screen-personal-bulk-input');
    }

    function renderBulkDateTabs() {
      let html = '';
      bulkDates.forEach((d, idx) => {
        const label = d.date.substring(0, 2) + '-' + d.date.substring(2, 4) + '-' + d.date.substring(4, 6) + ' ' + (d.location || '');
        const active = idx === currentBulkDateIndex ? 'active' : '';
        html += `<button class="participant-tab ${active}" onclick="selectBulkDate(${idx})">${label}</button>`;
      });
      document.getElementById('bulk-date-tabs').innerHTML = html;
    }

    function selectBulkDate(idx) {
      saveBulkCurrentInput();
      currentBulkDateIndex = idx;
      renderBulkDateTabs();
      renderBulkRecordTable();
    }

    function renderBulkRecordTable() {
      // 헤더
      let headerHtml = '<tr><th class="col-name">종목</th>';
      for (let i = 1; i <= bulkAttemptCount; i++) {
        headerHtml += `<th class="col-attempt">${i}차</th>`;
      }
      headerHtml += `<th class="col-add-attempt"><button class="btn-add-col" onclick="addBulkAttemptColumn()">+</button></th></tr>`;
      document.querySelector('#bulk-record-table thead').innerHTML = headerHtml;
      
      // 바디
      let bodyHtml = '';
      for (const disc of bulkDisciplines) {
        const records = bulkRecords[currentBulkDateIndex]?.[disc] || [];
        
        bodyHtml += `<tr data-disc="${disc}">
          <td class="col-name">${disc}</td>`;
        
        for (let i = 0; i < bulkAttemptCount; i++) {
          bodyHtml += `<td><input type="number" value="${records[i] || ''}" data-attempt="${i}" placeholder="-"></td>`;
        }
        
        bodyHtml += `<td></td></tr>`;
      }
      
      document.getElementById('bulk-record-tbody').innerHTML = bodyHtml;
    }

    function addBulkAttemptColumn() {
      saveBulkCurrentInput();
      bulkAttemptCount++;
      renderBulkRecordTable();
    }

    function openBulkAddDisciplineSheet() {
      const allDiscs = ['STA', 'DYNB', 'FIM', 'CWTB', 'DNF', 'CNF', 'DYN', 'CWT'];
      let html = '';
      
      for (const d of allDiscs) {
        const checked = bulkDisciplines.includes(d) ? 'checked' : '';
        html += `<label style="display: flex; align-items: center; gap: 8px; padding: 8px;">
          <input type="checkbox" value="${d}" ${checked}> ${d}
        </label>`;
      }
      
      document.getElementById('bulk-add-discipline-options').innerHTML = html;
      openBottomSheet('sheet-bulk-add-discipline');
    }

    function confirmBulkAddDiscipline() {
      const selected = [];
      document.querySelectorAll('#bulk-add-discipline-options input:checked').forEach(cb => {
        selected.push(cb.value);
      });
      
      if (selected.length === 0) {
        showToast('최소 1개 종목을 선택하세요');
        return;
      }
      
      // 새로 추가된 종목 초기화
      for (const disc of selected) {
        if (!bulkDisciplines.includes(disc)) {
          for (let i = 0; i < bulkDates.length; i++) {
            if (!bulkRecords[i]) bulkRecords[i] = {};
            bulkRecords[i][disc] = [];
          }
        }
      }
      
      bulkDisciplines = selected;
      closeBottomSheet('sheet-bulk-add-discipline');
      renderBulkRecordTable();
    }

    function saveBulkCurrentInput() {
      const rows = document.querySelectorAll('#bulk-record-tbody tr');
      rows.forEach(row => {
        const disc = row.dataset.disc;
        if (!disc) return;
        
        const inputs = row.querySelectorAll('input');
        const attempts = [];
        
        inputs.forEach(input => {
          if (input.dataset.attempt !== undefined) {
            attempts[parseInt(input.dataset.attempt)] = input.value;
          }
        });
        
        if (!bulkRecords[currentBulkDateIndex]) bulkRecords[currentBulkDateIndex] = {};
        bulkRecords[currentBulkDateIndex][disc] = attempts;
      });
    }

    async function saveBulkRecords(finish = false) {
      saveBulkCurrentInput();
      
      try {
        let totalSaved = 0;
        
        for (let dateIdx = 0; dateIdx < bulkDates.length; dateIdx++) {
          const dateInfo = bulkDates[dateIdx];
          const fullDate = '20' + dateInfo.date.substring(0, 2) + '-' + dateInfo.date.substring(2, 4) + '-' + dateInfo.date.substring(4, 6);
          
          const personalScheduleId = 'PS_' + currentUser.user_id + '_' + Date.now() + '_' + dateIdx;
          
          await db.from('personal_schedules').insert({
            personal_schedule_id: personalScheduleId,
            date: fullDate,
            time: null,
            location: dateInfo.location || null,
            common_disciplines: bulkDisciplines.join(',')
          });
          
          const dateRecords = bulkRecords[dateIdx] || {};
          
          for (const disc of Object.keys(dateRecords)) {
            const attempts = dateRecords[disc];
            
            for (let i = 0; i < attempts.length; i++) {
              const val = attempts[i];
              if (!val || val === '') continue;
              
              const recordId = 'PDR_' + currentUser.user_id + '_' + Date.now() + '_' + dateIdx + '_' + disc + '_' + i;
              
              const { error } = await db.from('personal_dive_records').insert({
                record_id: recordId,
                personal_schedule_id: personalScheduleId,
                user_id: currentUser.user_id,
                discipline: disc,
                attempt: i + 1,
                value: parseFloat(val)
              });
              
              if (!error) totalSaved++;
            }
          }
        }
        
        showToast(`${totalSaved}개 기록이 저장되었습니다`);
        
        if (finish) {
          showScreen('screen-my-records');
        }
      } catch (err) {
        console.error('일괄 저장 오류:', err);
        showToast('저장 실패: ' + err.message);
      }
    }

    // ==================== 성장 그래프 ====================
    let growthChart = null;
    let currentChartDiscipline = 'STA';
    let allRecordsForChart = [];

    function selectChartDiscipline(disc) {
      currentChartDiscipline = disc;
      document.querySelectorAll('#chart-discipline-tabs .disc-tab').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.disc === disc);
      });
      renderGrowthChart();
    }

    function renderGrowthChart() {
      const ctx = document.getElementById('growth-chart');
      if (!ctx) return;
      
      const discRecords = allRecordsForChart.filter(r => r.discipline === currentChartDiscipline);
      
      if (discRecords.length === 0) {
        if (growthChart) {
          growthChart.destroy();
          growthChart = null;
        }
        return;
      }
      
      const dateMap = {};
      for (const r of discRecords) {
        const val = parseFloat(r.value) || 0;
        if (!dateMap[r.date] || val > dateMap[r.date]) {
          dateMap[r.date] = val;
        }
      }
      
      const sortedDates = Object.keys(dateMap).sort();
      const labels = sortedDates.map(d => {
        const date = new Date(d);
        return (date.getMonth() + 1) + '/' + date.getDate();
      });
      const data = sortedDates.map(d => dateMap[d]);
      
      if (growthChart) {
        growthChart.destroy();
      }
      
      growthChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: currentChartDiscipline,
            data: data,
            borderColor: '#3182F6',
            backgroundColor: 'rgba(49, 130, 246, 0.1)',
            borderWidth: 2,
            tension: 0.3,
            fill: true,
            pointRadius: 4,
            pointBackgroundColor: '#3182F6'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { 
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const val = context.raw;
                  if (currentChartDiscipline === 'STA') {
                    const min = Math.floor(val / 60);
                    const sec = Math.round(val % 60);
                    return `${min}'${sec.toString().padStart(2, '0')}"`;
                  }
                  return val + 'm';
                }
              }
            }
          },
          scales: {
            y: { 
              beginAtZero: true, 
              grid: { color: '#E5E8EB' },
              ticks: {
                callback: function(value) {
                  if (currentChartDiscipline === 'STA') {
                    const min = Math.floor(value / 60);
                    const sec = Math.round(value % 60);
                    return `${min}'${sec.toString().padStart(2, '0')}"`;
                  }
                  return value + 'm';
                }
              }
            },
            x: { grid: { display: false } }
          }
        }
      });
    }

    function toggleChecklist(type) {
      // 스킬과 기록 체크리스트 둘 다 한번에 토글
      const skillsChecklist = document.getElementById('skills-checklist');
      const skillsIcon = document.getElementById('skills-toggle-icon');
      const recordsChecklist = document.getElementById('records-checklist');
      const recordsIcon = document.getElementById('records-toggle-icon');
      
      // 현재 상태 확인 (둘 중 하나라도 열려있으면 닫기, 둘 다 닫혀있으면 열기)
      const isAnyOpen = (skillsChecklist && skillsChecklist.classList.contains('open')) || 
                        (recordsChecklist && recordsChecklist.classList.contains('open'));
      
      if (isAnyOpen) {
        // 둘 다 닫기
        if (skillsChecklist) skillsChecklist.classList.remove('open');
        if (skillsIcon) skillsIcon.classList.remove('open');
        if (recordsChecklist) recordsChecklist.classList.remove('open');
        if (recordsIcon) recordsIcon.classList.remove('open');
      } else {
        // 둘 다 열기
        if (skillsChecklist) skillsChecklist.classList.add('open');
        if (skillsIcon) skillsIcon.classList.add('open');
        if (recordsChecklist) recordsChecklist.classList.add('open');
        if (recordsIcon) recordsIcon.classList.add('open');
      }
    }

    // ==================== 드라이 트레이닝 ====================
    let allDryTrainings = [];
    let myDryParticipations = [];
    let currentDryId = null;
    let frenzelTrainingId = null; // 프렌젤 연습 500회 dry_id
    
    // ==================== 프렌젤 리그 ====================
    
    // 프렌젤 리그 카드 로드 (홈, 트레이닝 탭)
    // 프렌젤 리그 카드 렌더링 (나의 리그 카드 스타일)
    async function renderFrenzelLeagueCard() {
      try {
        // 프렌젤 연습 트레이닝 찾기
        const { data: frenzelTraining } = await db
          .from('dry_trainings')
          .select('*')
          .ilike('name', '%프렌젤%')
          .single();
        
        if (!frenzelTraining) {
          return '';
        }
        
        frenzelTrainingId = frenzelTraining.dry_id;
        
        const participants = frenzelTraining.participants || [];
        const graduates = frenzelTraining.graduates || [];
        
        // 내가 참여 중인지 확인
        const isParticipant = participants.includes(currentUser.user_id);
        const isGraduate = graduates.includes(currentUser.user_id);
        
        // 내 기록 계산
        let myCount = 0;
        let myAvgRate = 0;
        let totalPractice = 0; // 총 연습횟수 (참여횟수 × 달성률 × 500)
        
        if (isParticipant || isGraduate) {
          const { data: myRecords } = await db
            .from('dry_training_records')
            .select('achievement')
            .eq('dry_id', frenzelTrainingId)
            .eq('user_id', currentUser.user_id);
          
          if (myRecords && myRecords.length > 0) {
            myCount = myRecords.length;
            myAvgRate = myRecords.reduce((sum, r) => sum + r.achievement, 0) / myCount;
            totalPractice = Math.round(myCount * myAvgRate * 500);
          }
        }
        
        // 현재 이퀄 상태에 따라 도전 중인 단계 표시
        // 발살바 → 프렌젤 도전, 프렌젤 → 헤드퍼스트 도전, 헤드퍼스트 → 완료
        const eqStatus = currentUser.equalization || 'valsalva';
        let challengeDisplay = '프렌젤'; // 기본: 발살바 → 프렌젤 도전
        let practiceDisplay = '';
        
        if (eqStatus === 'frenzel') {
          challengeDisplay = '헤드퍼스트';
        } else if (eqStatus === 'headfirst_frenzel') {
          challengeDisplay = '마스터 🎓';
        }
        
        // 총 연습횟수 또는 현재 상태 표시
        if (eqStatus === 'headfirst_frenzel') {
          practiceDisplay = '완료!';
        } else if (totalPractice > 0) {
          practiceDisplay = totalPractice.toLocaleString() + '회';
        } else {
          practiceDisplay = '도전하기';
        }
        
        return `<div class="league-card frenzel-card" onclick="openFrenzelLeague()">
          <div class="league-card-disc">이퀄라이징</div>
          <div class="league-card-emoji">🎯</div>
          <div class="league-card-tier">${challengeDisplay}</div>
          <div class="league-card-record">${practiceDisplay}</div>
        </div>`;
      } catch (err) {
        console.error('프렌젤 리그 카드 로드 오류:', err);
        return '';
      }
    }
    
    // 프렌젤 리그 카드 로드 (트레이닝 탭용)
    async function loadFrenzelLeagueCard(containerId) {
      const container = document.getElementById(containerId);
      if (!container) return;
      
      try {
        // 프렌젤 연습 트레이닝 찾기
        const { data: frenzelTraining } = await db
          .from('dry_trainings')
          .select('*')
          .ilike('name', '%프렌젤%')
          .single();
        
        if (!frenzelTraining) {
          container.innerHTML = '';
          return;
        }
        
        frenzelTrainingId = frenzelTraining.dry_id;
        
        const participants = frenzelTraining.participants || [];
        const graduates = frenzelTraining.graduates || [];
        
        // 내가 참여 중인지 확인
        const isParticipant = participants.includes(currentUser.user_id);
        const isGraduate = graduates.includes(currentUser.user_id);
        
        // 내 점수 계산
        let myScore = 0;
        let myCount = 0;
        let myAvgRate = 0;
        
        if (isParticipant || isGraduate) {
          const { data: myRecords } = await db
            .from('dry_training_records')
            .select('achievement')
            .eq('dry_id', frenzelTrainingId)
            .eq('user_id', currentUser.user_id);
          
          if (myRecords && myRecords.length > 0) {
            myCount = myRecords.length;
            myAvgRate = Math.round(myRecords.reduce((sum, r) => sum + r.achievement, 0) / myCount * 100);
            myScore = myCount * myAvgRate;
          }
        }
        
        container.innerHTML = `
          <div class="frenzel-league-card" onclick="openFrenzelLeague()">
            <div class="frenzel-league-card-header">
              <div class="frenzel-league-card-icon">🎯</div>
              <div>
                <div class="frenzel-league-card-title">프렌젤 리그</div>
                <div class="frenzel-league-card-subtitle">${isGraduate ? '🎓 졸업!' : isParticipant ? '도전 중' : '도전해보세요!'}</div>
              </div>
            </div>
            <div class="frenzel-league-card-stats">
              <div class="frenzel-league-card-stat"><i class="fas fa-fire"></i> ${participants.length}명 도전 중</div>
              <div class="frenzel-league-card-stat"><i class="fas fa-graduation-cap"></i> ${graduates.length}명 졸업</div>
              ${myScore > 0 ? `<div class="frenzel-league-card-stat"><i class="fas fa-star"></i> 내점수 ${myScore}점</div>` : ''}
            </div>
          </div>
        `;
      } catch (err) {
        console.error('프렌젤 리그 카드 로드 오류:', err);
        container.innerHTML = '';
      }
    }
    
    // 프렌젤 리그 화면 열기
    async function openFrenzelLeague() {
      showScreen('screen-frenzel-league');
      await loadFrenzelRanking();
    }
    
    // 프렌젤 탭 전환
    function switchFrenzelTab(tab) {
      document.querySelectorAll('.frenzel-tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`.frenzel-tab[onclick*="${tab}"]`).classList.add('active');
      
      document.getElementById('frenzel-active-content').style.display = tab === 'active' ? 'block' : 'none';
      document.getElementById('frenzel-graduated-content').style.display = tab === 'graduated' ? 'block' : 'none';
      
      if (tab === 'graduated') {
        loadFrenzelGraduates();
      }
    }
    
    // 프렌젤 랭킹 로드
    async function loadFrenzelRanking() {
      const container = document.getElementById('frenzel-ranking-list');
      container.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';
      
      try {
        // 프렌젤 트레이닝 찾기
        const { data: frenzelTraining } = await db
          .from('dry_trainings')
          .select('*')
          .ilike('name', '%프렌젤%')
          .single();
        
        if (!frenzelTraining) {
          container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 40px;">프렌젤 트레이닝이 없습니다</div>';
          return;
        }
        
        frenzelTrainingId = frenzelTraining.dry_id;
        const participants = frenzelTraining.participants || [];
        
        if (participants.length === 0) {
          container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 40px;">아직 도전자가 없습니다</div>';
          return;
        }
        
        // 참여자들의 기록 조회 (날짜 포함)
        const { data: records } = await db
          .from('dry_training_records')
          .select('user_id, achievement, date')
          .eq('dry_id', frenzelTrainingId)
          .order('date', { ascending: true });
        
        // 참여자 정보 조회
        const { data: users } = await db
          .from('users')
          .select('user_id, name')
          .in('user_id', participants);
        
        const userMap = {};
        (users || []).forEach(u => userMap[u.user_id] = u.name);
        
        const today = new Date().toISOString().split('T')[0];
        
        // 연속 참여일 계산 함수
        function calculateStreak(userRecords) {
          if (!userRecords || userRecords.length === 0) return 0;
          
          // 날짜별로 정렬 (최신순)
          const dates = [...new Set(userRecords.map(r => r.date))].sort().reverse();
          
          // 오늘 참여 안했으면 0
          if (dates[0] !== today) return 0;
          
          let streak = 1;
          for (let i = 1; i < dates.length; i++) {
            const prevDate = new Date(dates[i-1]);
            const currDate = new Date(dates[i]);
            const diffDays = (prevDate - currDate) / (1000 * 60 * 60 * 24);
            
            if (diffDays === 1) {
              streak++;
            } else {
              break;
            }
          }
          return streak;
        }
        
        // 점수 계산 -> 총 연습 횟수 (참여횟수 × 500회 × 달성률)
        const scores = {};
        participants.forEach(pid => {
          const userRecords = (records || []).filter(r => r.user_id === pid);
          
          const count = userRecords.length;
          const avgRate = count > 0 ? userRecords.reduce((sum, r) => sum + r.achievement, 0) / count : 0;
          const avgRatePercent = Math.round(avgRate * 100);
          const totalPractice = Math.round(count * 500 * avgRate); // 총 연습 횟수
          const todayDone = userRecords.some(r => r.date === today);
          const streak = calculateStreak(userRecords);
          
          scores[pid] = {
            totalPractice,
            count,
            avgRate: avgRatePercent,
            name: userMap[pid] || '알 수 없음',
            todayDone,
            streak
          };
        });
        
        // 총 연습 횟수순 정렬
        const sortedParticipants = participants.sort((a, b) => scores[b].totalPractice - scores[a].totalPractice);
        
        let html = '';
        sortedParticipants.forEach((pid, idx) => {
          const s = scores[pid];
          const isMe = pid === currentUser.user_id;
          const rankClass = idx === 0 ? 'top1' : idx === 1 ? 'top2' : idx === 2 ? 'top3' : '';
          
          // 불꽃 이모지 (최대 3개)
          const fireEmoji = s.streak > 0 ? '🔥'.repeat(Math.min(s.streak, 3)) : '';
          
          // 연속 참여 텍스트
          const streakText = s.streak > 1 ? ` · ${s.streak}일 연속!` : '';
          
          // 오늘 참여 시 배경색 클래스
          const todayClass = s.todayDone ? 'today-done' : '';
          
          html += `
            <div class="frenzel-ranking-item ${isMe ? 'me' : ''} ${todayClass}">
              <div class="frenzel-rank ${rankClass}">${idx + 1}</div>
              <div class="frenzel-info">
                <div class="frenzel-name">${s.name}${isMe ? ' (나)' : ''} ${fireEmoji}</div>
                <div class="frenzel-detail">${s.count}회 참여${streakText}</div>
              </div>
              <div class="frenzel-score">
                <div class="frenzel-score-value">${s.totalPractice.toLocaleString()}번</div>
                <div class="frenzel-score-detail">${s.count}회 × ${s.avgRate}%</div>
              </div>
            </div>
          `;
        });
        
        container.innerHTML = html || '<div style="text-align: center; color: var(--text-secondary); padding: 40px;">도전자가 없습니다</div>';
        
      } catch (err) {
        console.error('프렌젤 랭킹 로드 오류:', err);
        container.innerHTML = '<div style="text-align: center; color: var(--error); padding: 20px;">랭킹을 불러오지 못했습니다</div>';
      }
    }
    
    // 프렌젤 졸업생 로드
    async function loadFrenzelGraduates() {
      const container = document.getElementById('frenzel-graduates-list');
      container.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';
      
      try {
        const { data: frenzelTraining } = await db
          .from('dry_trainings')
          .select('graduates')
          .ilike('name', '%프렌젤%')
          .single();
        
        const graduates = frenzelTraining?.graduates || [];
        
        if (graduates.length === 0) {
          container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 40px;">아직 졸업생이 없습니다<br><span style="font-size: 13px;">🎯 첫 번째 졸업생이 되어보세요!</span></div>';
          return;
        }
        
        // 졸업생 정보 조회
        const { data: users } = await db
          .from('users')
          .select('user_id, name')
          .in('user_id', graduates);
        
        const userMap = {};
        (users || []).forEach(u => userMap[u.user_id] = u.name);
        
        let html = '';
        graduates.forEach(gid => {
          const name = userMap[gid] || '알 수 없음';
          const isMe = gid === currentUser.user_id;
          
          html += `
            <div class="graduate-item ${isMe ? 'me' : ''}">
              <div class="graduate-icon">🎓</div>
              <div class="graduate-info">
                <div class="graduate-name">${name}${isMe ? ' (나)' : ''}</div>
                <div class="graduate-date">프렌젤 마스터</div>
              </div>
            </div>
          `;
        });
        
        container.innerHTML = html;
        
      } catch (err) {
        console.error('프렌젤 졸업생 로드 오류:', err);
        container.innerHTML = '<div style="text-align: center; color: var(--error); padding: 20px;">졸업생을 불러오지 못했습니다</div>';
      }
    }
    
    // 강사: 프렌젤 졸업 처리
    async function graduateFrenzelMember(userId) {
      if (!confirm('이 회원을 프렌젤 마스터로 졸업 처리하시겠습니까?')) return;
      
      try {
        // 현재 데이터 조회
        const { data: training } = await db
          .from('dry_trainings')
          .select('participants, graduates')
          .eq('dry_id', frenzelTrainingId)
          .single();
        
        const participants = training.participants || [];
        const graduates = training.graduates || [];
        
        // participants에서 제거, graduates에 추가
        const newParticipants = participants.filter(p => p !== userId);
        const newGraduates = [...graduates, userId];
        
        const { error } = await db
          .from('dry_trainings')
          .update({
            participants: newParticipants,
            graduates: newGraduates
          })
          .eq('dry_id', frenzelTrainingId);
        
        if (error) throw error;
        
        showToast('졸업 처리되었습니다! 🎓');
        loadFrenzelRanking();
        
      } catch (err) {
        console.error('졸업 처리 오류:', err);
        showToast('졸업 처리 실패');
      }
    }
    
    // ==================== 드라이 트레이닝 상세 ====================
    let currentDryDetailId = null;
    let drySteps = [];
    let currentDryStepIndex = 0;
    
    // 드라이 트레이닝 상세 화면 열기
    async function openDryDetail(dryId) {
      currentDryDetailId = dryId;
      currentDryStepIndex = 0;
      showScreen('screen-dry-detail');
      
      try {
        // 트레이닝 정보 조회
        const { data: training } = await db
          .from('dry_trainings')
          .select('*')
          .eq('dry_id', dryId)
          .single();
        
        if (training) {
          document.getElementById('dry-detail-title').textContent = training.name;
        }
        
        // 스텝 정보 조회
        const { data: steps } = await db
          .from('dry_training_steps')
          .select('*')
          .eq('dry_id', dryId)
          .order('step_order', { ascending: true });
        
        drySteps = steps || [];
        
        // 스와이프 UI 렌더링
        renderDrySteps();
        
      } catch (err) {
        console.error('드라이 트레이닝 상세 로드 오류:', err);
        showToast('로드 실패');
      }
    }
    
    // 스텝 렌더링
    function renderDrySteps() {
      const wrapper = document.getElementById('dry-swipe-wrapper');
      const indicators = document.getElementById('dry-swipe-indicators');
      
      if (drySteps.length === 0) {
        wrapper.innerHTML = `
          <div class="swipe-slide">
            <div class="swipe-card" style="display: flex; align-items: center; justify-content: center; min-height: 300px; flex-direction: column; color: var(--text-secondary);">
              <i class="fas fa-info-circle" style="font-size: 48px; margin-bottom: 16px;"></i>
              <p>상세 연습 방법이 아직 등록되지 않았습니다</p>
            </div>
          </div>
        `;
        indicators.innerHTML = '';
        document.getElementById('dry-step-counter').textContent = '';
        return;
      }
      
      // 스텝 카드 생성
      let html = '';
      drySteps.forEach((step, idx) => {
        html += `
          <div class="swipe-slide">
            <div class="swipe-card">
              <div class="swipe-card-image">
                ${step.image_url 
                  ? `<img src="${step.image_url}" alt="${step.title}">`
                  : `<i class="fas fa-image placeholder"></i>`
                }
              </div>
              <div class="swipe-card-content">
                <div class="swipe-card-title">
                  <span class="swipe-card-step">${idx + 1}</span>
                  ${step.title}
                </div>
                ${step.description ? `<div class="swipe-card-desc">${step.description}</div>` : ''}
                ${step.tips ? `<div class="swipe-card-tips"><div class="tips-header"><i class="fas fa-lightbulb"></i> Tips</div><div class="tips-content">${step.tips}</div></div>` : ''}
              </div>
            </div>
          </div>
        `;
      });
      wrapper.innerHTML = html;
      
      // 인디케이터 생성
      let indHtml = '';
      drySteps.forEach((_, idx) => {
        indHtml += `<div class="swipe-indicator ${idx === 0 ? 'active' : ''}" onclick="goToDryStep(${idx})"></div>`;
      });
      indicators.innerHTML = indHtml;
      
      // 카운터 업데이트
      updateDryStepCounter();
      
      // 터치 이벤트 설정
      setupDrySwipeTouch();
    }
    
    // 특정 스텝으로 이동
    function goToDryStep(index) {
      currentDryStepIndex = index;
      const wrapper = document.getElementById('dry-swipe-wrapper');
      wrapper.style.transform = `translateX(-${currentDryStepIndex * 100}%)`;
      updateDryStepCounter();
    }
    
    // 스텝 카운터 업데이트
    function updateDryStepCounter() {
      document.getElementById('dry-step-counter').textContent = `${currentDryStepIndex + 1}/${drySteps.length}`;
      
      // 인디케이터 업데이트
      document.querySelectorAll('#dry-swipe-indicators .swipe-indicator').forEach((ind, idx) => {
        ind.classList.toggle('active', idx === currentDryStepIndex);
      });
    }
    
    // 스와이프 이동
    function drySwipeStep(direction) {
      const newIndex = currentDryStepIndex + direction;
      if (newIndex < 0 || newIndex >= drySteps.length) return;
      
      currentDryStepIndex = newIndex;
      const wrapper = document.getElementById('dry-swipe-wrapper');
      wrapper.style.transform = `translateX(-${currentDryStepIndex * 100}%)`;
      updateDryStepCounter();
    }
    
    // 터치 스와이프 설정
    function setupDrySwipeTouch() {
      const container = document.getElementById('dry-swipe-container');
      let startX = 0;
      let isDragging = false;
      
      container.addEventListener('touchstart', (e) => {
        startX = e.touches[0].clientX;
        isDragging = true;
      });
      
      container.addEventListener('touchend', (e) => {
        if (!isDragging) return;
        const endX = e.changedTouches[0].clientX;
        const diff = startX - endX;
        
        if (Math.abs(diff) > 50) {
          if (diff > 0) {
            drySwipeStep(1); // 다음
          } else {
            drySwipeStep(-1); // 이전
          }
        }
        isDragging = false;
      });
    }

    // 강사: 드라이 트레이닝 관리 로드
    async function loadDryManage() {
      try {
        const { data, error } = await db
          .from('dry_trainings')
          .select('*')
          .eq('instructor_id', currentUser.user_id)
          .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        const container = document.getElementById('dry-training-list');
        
        if (!data || data.length === 0) {
          container.innerHTML = `<div class="card" style="text-align: center; padding: 40px;">
            <i class="fas fa-lungs" style="font-size: 48px; color: var(--text-tertiary); margin-bottom: 16px;"></i>
            <p style="color: var(--text-secondary); margin-bottom: 16px;">등록된 트레이닝이 없습니다</p>
            <button class="btn btn-primary" onclick="openDryForm()">+ 새 트레이닝 추가</button>
          </div>`;
          return;
        }
        
        let html = '';
        for (const d of data) {
          // participants 배열 길이로 참여자 수 계산
          const participantCount = d.participants ? d.participants.length : 0;
          
          html += `<div class="card" style="margin-bottom: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: start;">
              <div style="flex: 1;">
                <div style="font-weight: 600; margin-bottom: 4px;">${d.name}</div>
                <div style="font-size: 13px; color: var(--text-secondary);">${d.description || '설명 없음'}</div>
                <div style="font-size: 12px; color: var(--text-tertiary); margin-top: 8px;">
                  <i class="fas fa-users"></i> 참여자 ${participantCount}명
                </div>
              </div>
              <div style="display: flex; gap: 8px;">
                <button class="icon-btn" onclick="openDryForm('${d.dry_id}')"><i class="fas fa-pen"></i></button>
                <button class="icon-btn" onclick="deleteDryTraining('${d.dry_id}')"><i class="fas fa-trash"></i></button>
              </div>
            </div>
          </div>`;
        }
        
        container.innerHTML = html;
      } catch (err) {
        console.error('드라이 트레이닝 로드 오류:', err);
      }
    }

    // 강사: 드라이 트레이닝 폼 열기
    function openDryForm(dryId = null) {
      document.getElementById('edit-dry-id').value = dryId || '';
      document.getElementById('dry-form-title').textContent = dryId ? '트레이닝 수정' : '새 트레이닝 추가';
      
      if (dryId) {
        // 수정 시 기존 데이터 로드
        db.from('dry_trainings').select('*').eq('dry_id', dryId).single()
          .then(({ data }) => {
            if (data) {
              document.getElementById('dry-name').value = data.name;
              document.getElementById('dry-description').value = data.description || '';
            }
          });
      } else {
        document.getElementById('dry-name').value = '';
        document.getElementById('dry-description').value = '';
      }
      
      openBottomSheet('sheet-dry-form');
    }

    // 강사: 드라이 트레이닝 저장
    async function saveDryTraining() {
      const dryId = document.getElementById('edit-dry-id').value;
      const name = document.getElementById('dry-name').value.trim();
      const description = document.getElementById('dry-description').value.trim();
      
      if (!name) {
        showToast('트레이닝 이름을 입력해주세요');
        return;
      }
      
      try {
        if (dryId) {
          // 수정
          const { error } = await db
            .from('dry_trainings')
            .update({ name, description })
            .eq('dry_id', dryId);
          if (error) throw error;
          showToast('수정되었습니다');
        } else {
          // 추가
          const { error } = await db
            .from('dry_trainings')
            .insert({ name, description, instructor_id: currentUser.user_id });
          if (error) throw error;
          showToast('추가되었습니다');
        }
        
        closeBottomSheet('sheet-dry-form');
        loadDryManage();
      } catch (err) {
        console.error('저장 오류:', err);
        showToast('저장 실패: ' + err.message);
      }
    }

    // 강사: 드라이 트레이닝 삭제
    async function deleteDryTraining(dryId) {
      if (!confirm('이 트레이닝을 삭제하시겠습니까?')) return;
      
      try {
        // 관련 기록도 삭제
        await db.from('dry_training_records').delete().eq('dry_id', dryId);
        const { error } = await db.from('dry_trainings').delete().eq('dry_id', dryId);
        if (error) throw error;
        
        showToast('삭제되었습니다');
        loadDryManage();
      } catch (err) {
        console.error('삭제 오류:', err);
        showToast('삭제 실패: ' + err.message);
      }
    }

    // ==================== 트레이닝 탭 전환 ====================
    let currentTrainingTab = 'dry';
    let imageTrainingCategories = [];
    
    function switchTrainingTab(tab) {
      currentTrainingTab = tab;
      
      // 탭 버튼 스타일 변경
      document.querySelectorAll('.training-tab').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tab);
      });
      
      // 콘텐츠 표시/숨김
      document.getElementById('dry-training-content').style.display = tab === 'dry' ? 'block' : 'none';
      document.getElementById('image-training-content').style.display = tab === 'image' ? 'block' : 'none';
      
      // 이미지 탭 선택 시 데이터 로드
      if (tab === 'image' && imageTrainingCategories.length === 0) {
        loadImageTrainingCategories();
      }
    }
    
    // 이미지 트레이닝 카테고리 로드
    async function loadImageTrainingCategories() {
      const container = document.getElementById('image-training-categories');
      
      try {
        const { data: categories, error } = await db
          .from('image_training_categories')
          .select('*')
          .order('sort_order', { ascending: true });
        
        if (error) throw error;
        
        imageTrainingCategories = categories || [];
        
        if (imageTrainingCategories.length === 0) {
          container.innerHTML = `<div class="card" style="text-align: center; color: var(--text-secondary); padding: 30px;">
            등록된 동작 가이드가 없습니다
          </div>`;
          return;
        }
        
        // 각 카테고리별 스텝 수 조회
        const { data: stepCounts } = await db
          .from('image_training_steps')
          .select('category_id');
        
        const categoryStepCounts = {};
        (stepCounts || []).forEach(s => {
          categoryStepCounts[s.category_id] = (categoryStepCounts[s.category_id] || 0) + 1;
        });
        
        let html = '';
        for (const cat of imageTrainingCategories) {
          const hasSteps = categoryStepCounts[cat.category_id] > 0;
          const isReady = hasSteps;
          
          html += `<div class="image-category-card ${!isReady ? 'not-ready' : ''}" onclick="${isReady ? `openImageTrainingDetail('${cat.category_id}')` : 'showToast(\'준비 중입니다\')'}">
            <div class="category-icon">${cat.icon || '📖'}</div>
            <div class="category-info">
              <div class="category-name">${cat.name} ${!isReady ? '<span class="preparing-badge">준비중</span>' : ''}</div>
              <div class="category-desc">${cat.description || ''}</div>
            </div>
            <i class="fas fa-chevron-right category-arrow"></i>
          </div>`;
        }
        
        container.innerHTML = html;
      } catch (err) {
        console.error('이미지 트레이닝 카테고리 로드 오류:', err);
        container.innerHTML = `<div class="card" style="text-align: center; color: var(--error); padding: 20px;">
          데이터를 불러오지 못했습니다
        </div>`;
      }
    }
    
    // ==================== 스와이프 이미지 트레이닝 ====================
    let currentSwipeIndex = 0;
    let swipeSteps = [];
    let touchStartX = 0;
    let touchEndX = 0;
    
    // 이미지 트레이닝 상세 보기 (스와이프)
    async function openImageTrainingDetail(categoryId) {
      const category = imageTrainingCategories.find(c => c.category_id === categoryId);
      if (category) {
        document.getElementById('image-training-detail-title').textContent = category.name;
      }
      
      showScreen('screen-image-training-detail');
      currentSwipeIndex = 0;
      
      const wrapper = document.getElementById('swipe-wrapper');
      wrapper.innerHTML = '<div class="swipe-slide"><div class="loading"><div class="loading-spinner"></div></div></div>';
      
      try {
        const { data: steps, error } = await db
          .from('image_training_steps')
          .select('*')
          .eq('category_id', categoryId)
          .order('step_order', { ascending: true });
        
        if (error) throw error;
        
        if (!steps || steps.length === 0) {
          wrapper.innerHTML = `<div class="swipe-slide">
            <div class="swipe-card" style="display: flex; align-items: center; justify-content: center; min-height: 300px; color: var(--text-secondary);">
              등록된 단계가 없습니다
            </div>
          </div>`;
          document.getElementById('swipe-indicators').innerHTML = '';
          document.getElementById('image-step-counter').textContent = '';
          return;
        }
        
        swipeSteps = steps;
        
        // 슬라이드 생성
        let slidesHtml = '';
        for (const step of steps) {
          slidesHtml += `<div class="swipe-slide">
            <div class="swipe-card">
              <div class="swipe-card-image">
                ${step.image_url 
                  ? `<img src="${step.image_url}" alt="${step.title}">`
                  : `<i class="fas fa-image placeholder"></i>`
                }
              </div>
              <div class="swipe-card-content">
                <div class="swipe-card-title">
                  <span class="swipe-card-step">${step.step_order}</span>
                  ${step.title}
                </div>
                ${step.description ? `<div class="swipe-card-desc">${step.description}</div>` : ''}
                ${step.tips ? `<div class="swipe-card-tips"><div class="tips-header"><i class="fas fa-lightbulb"></i> Tips</div><div class="tips-content">${step.tips}</div></div>` : ''}
              </div>
            </div>
          </div>`;
        }
        wrapper.innerHTML = slidesHtml;
        
        // 인디케이터 생성
        let indicatorsHtml = '';
        for (let i = 0; i < steps.length; i++) {
          indicatorsHtml += `<div class="swipe-indicator ${i === 0 ? 'active' : ''}" onclick="goToSwipeStep(${i})"></div>`;
        }
        document.getElementById('swipe-indicators').innerHTML = indicatorsHtml;
        
        // 카운터 업데이트
        updateSwipeUI();
        
        // 터치 이벤트 설정
        setupSwipeTouch('swipe-container');
        
      } catch (err) {
        console.error('이미지 트레이닝 스텝 로드 오류:', err);
        wrapper.innerHTML = `<div class="swipe-slide">
          <div class="swipe-card" style="display: flex; align-items: center; justify-content: center; min-height: 300px; color: var(--error);">
            데이터를 불러오지 못했습니다
          </div>
        </div>`;
      }
    }
    
    // 스와이프 터치 이벤트 설정
    function setupSwipeTouch(containerId) {
      const container = document.getElementById(containerId);
      
      container.addEventListener('touchstart', (e) => {
        touchStartX = e.changedTouches[0].screenX;
      }, { passive: true });
      
      container.addEventListener('touchend', (e) => {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipeGesture();
      }, { passive: true });
    }
    
    // 스와이프 제스처 처리
    function handleSwipeGesture() {
      const diff = touchStartX - touchEndX;
      const threshold = 50;
      
      if (diff > threshold) {
        // 왼쪽으로 스와이프 → 다음
        swipeStep(1);
      } else if (diff < -threshold) {
        // 오른쪽으로 스와이프 → 이전
        swipeStep(-1);
      }
    }
    
    // 스텝 이동 (순환형)
    function swipeStep(direction) {
      let newIndex = currentSwipeIndex + direction;
      
      // 순환 처리
      if (newIndex < 0) {
        newIndex = swipeSteps.length - 1; // 처음에서 이전 → 마지막으로
      } else if (newIndex >= swipeSteps.length) {
        newIndex = 0; // 마지막에서 다음 → 처음으로
      }
      
      currentSwipeIndex = newIndex;
      updateSwipeUI();
    }
    
    // 특정 스텝으로 이동
    function goToSwipeStep(index) {
      currentSwipeIndex = index;
      updateSwipeUI();
    }
    
    // 스와이프 UI 업데이트
    function updateSwipeUI() {
      const wrapper = document.getElementById('swipe-wrapper');
      wrapper.style.transform = `translateX(-${currentSwipeIndex * 100}%)`;
      
      // 카운터 업데이트
      document.getElementById('image-step-counter').textContent = `${currentSwipeIndex + 1}/${swipeSteps.length}`;
      
      // 인디케이터 업데이트
      document.querySelectorAll('#swipe-indicators .swipe-indicator').forEach((ind, i) => {
        ind.classList.toggle('active', i === currentSwipeIndex);
      });
      
      // 버튼은 항상 활성화 (순환형)
    }
    
    // ==================== 강사용 트레이닝 탭 전환 ====================
    let currentInstructorTrainingTab = 'dry';
    
    function switchInstructorTrainingTab(tab) {
      currentInstructorTrainingTab = tab;
      
      // 탭 버튼 스타일 변경
      document.querySelectorAll('#screen-dry-manage .training-tab').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tab);
      });
      
      // 콘텐츠 표시/숨김
      document.getElementById('instructor-dry-content').style.display = tab === 'dry' ? 'block' : 'none';
      document.getElementById('instructor-image-content').style.display = tab === 'image' ? 'block' : 'none';
      
      // 추가 버튼 표시/숨김 (드라이만 추가 가능)
      document.getElementById('instructor-training-add-btn').style.display = tab === 'dry' ? 'block' : 'none';
      
      // 이미지 탭 선택 시 데이터 로드
      if (tab === 'image') {
        loadInstructorImageCategories();
      }
    }
    
    // 강사용 이미지 트레이닝 카테고리 로드
    async function loadInstructorImageCategories() {
      const container = document.getElementById('instructor-image-categories');
      
      try {
        const { data: categories, error } = await db
          .from('image_training_categories')
          .select('*')
          .order('sort_order', { ascending: true });
        
        if (error) throw error;
        
        imageTrainingCategories = categories || [];
        
        if (imageTrainingCategories.length === 0) {
          container.innerHTML = `<div class="card" style="text-align: center; color: var(--text-secondary); padding: 30px;">
            등록된 동작 가이드가 없습니다
          </div>`;
          return;
        }
        
        let html = '';
        for (const cat of imageTrainingCategories) {
          html += `<div class="image-category-card" onclick="openInstructorImageDetail('${cat.category_id}')">
            <div class="category-icon">${cat.icon || '📖'}</div>
            <div class="category-info">
              <div class="category-name">${cat.name}</div>
              <div class="category-desc">${cat.description || ''}</div>
            </div>
            <i class="fas fa-chevron-right category-arrow"></i>
          </div>`;
        }
        
        container.innerHTML = html;
      } catch (err) {
        console.error('이미지 트레이닝 카테고리 로드 오류:', err);
        container.innerHTML = `<div class="card" style="text-align: center; color: var(--error); padding: 20px;">
          데이터를 불러오지 못했습니다
        </div>`;
      }
    }
    
    // 강사용 이미지 트레이닝 상세 보기 (스와이프)
    let instructorSwipeIndex = 0;
    let instructorSwipeSteps = [];
    
    async function openInstructorImageDetail(categoryId) {
      const category = imageTrainingCategories.find(c => c.category_id === categoryId);
      if (category) {
        document.getElementById('instructor-image-detail-title').textContent = category.name;
      }
      
      showScreen('screen-instructor-image-detail');
      instructorSwipeIndex = 0;
      
      const wrapper = document.getElementById('instructor-swipe-wrapper');
      wrapper.innerHTML = '<div class="swipe-slide"><div class="loading"><div class="loading-spinner"></div></div></div>';
      
      try {
        const { data: steps, error } = await db
          .from('image_training_steps')
          .select('*')
          .eq('category_id', categoryId)
          .order('step_order', { ascending: true });
        
        if (error) throw error;
        
        if (!steps || steps.length === 0) {
          wrapper.innerHTML = `<div class="swipe-slide">
            <div class="swipe-card" style="display: flex; align-items: center; justify-content: center; min-height: 300px; color: var(--text-secondary);">
              등록된 단계가 없습니다
            </div>
          </div>`;
          document.getElementById('instructor-swipe-indicators').innerHTML = '';
          document.getElementById('instructor-step-counter').textContent = '';
          return;
        }
        
        instructorSwipeSteps = steps;
        
        // 슬라이드 생성
        let slidesHtml = '';
        for (const step of steps) {
          slidesHtml += `<div class="swipe-slide">
            <div class="swipe-card">
              <div class="swipe-card-image">
                ${step.image_url 
                  ? `<img src="${step.image_url}" alt="${step.title}">`
                  : `<i class="fas fa-image placeholder"></i>`
                }
              </div>
              <div class="swipe-card-content">
                <div class="swipe-card-title">
                  <span class="swipe-card-step">${step.step_order}</span>
                  ${step.title}
                </div>
                ${step.description ? `<div class="swipe-card-desc">${step.description}</div>` : ''}
                ${step.tips ? `<div class="swipe-card-tips"><div class="tips-header"><i class="fas fa-lightbulb"></i> Tips</div><div class="tips-content">${step.tips}</div></div>` : ''}
              </div>
            </div>
          </div>`;
        }
        wrapper.innerHTML = slidesHtml;
        
        // 인디케이터 생성
        let indicatorsHtml = '';
        for (let i = 0; i < steps.length; i++) {
          indicatorsHtml += `<div class="swipe-indicator ${i === 0 ? 'active' : ''}" onclick="goToInstructorSwipeStep(${i})"></div>`;
        }
        document.getElementById('instructor-swipe-indicators').innerHTML = indicatorsHtml;
        
        // 카운터 업데이트
        updateInstructorSwipeUI();
        
        // 터치 이벤트 설정
        setupInstructorSwipeTouch();
        
      } catch (err) {
        console.error('이미지 트레이닝 스텝 로드 오류:', err);
        wrapper.innerHTML = `<div class="swipe-slide">
          <div class="swipe-card" style="display: flex; align-items: center; justify-content: center; min-height: 300px; color: var(--error);">
            데이터를 불러오지 못했습니다
          </div>
        </div>`;
      }
    }
    
    // 강사용 스와이프 터치
    function setupInstructorSwipeTouch() {
      const container = document.getElementById('instructor-swipe-container');
      
      container.addEventListener('touchstart', (e) => {
        touchStartX = e.changedTouches[0].screenX;
      }, { passive: true });
      
      container.addEventListener('touchend', (e) => {
        touchEndX = e.changedTouches[0].screenX;
        handleInstructorSwipeGesture();
      }, { passive: true });
    }
    
    function handleInstructorSwipeGesture() {
      const diff = touchStartX - touchEndX;
      const threshold = 50;
      
      if (diff > threshold) {
        instructorSwipeStep(1);
      } else if (diff < -threshold) {
        instructorSwipeStep(-1);
      }
    }
    
    function instructorSwipeStep(direction) {
      let newIndex = instructorSwipeIndex + direction;
      
      // 순환 처리
      if (newIndex < 0) {
        newIndex = instructorSwipeSteps.length - 1;
      } else if (newIndex >= instructorSwipeSteps.length) {
        newIndex = 0;
      }
      
      instructorSwipeIndex = newIndex;
      updateInstructorSwipeUI();
    }
    
    function goToInstructorSwipeStep(index) {
      instructorSwipeIndex = index;
      updateInstructorSwipeUI();
    }
    
    function updateInstructorSwipeUI() {
      const wrapper = document.getElementById('instructor-swipe-wrapper');
      wrapper.style.transform = `translateX(-${instructorSwipeIndex * 100}%)`;
      
      document.getElementById('instructor-step-counter').textContent = `${instructorSwipeIndex + 1}/${instructorSwipeSteps.length}`;
      
      document.querySelectorAll('#instructor-swipe-indicators .swipe-indicator').forEach((ind, i) => {
        ind.classList.toggle('active', i === instructorSwipeIndex);
      });
    }

    // 학생: 드라이 트레이닝 목록 로드
    async function loadDryTraining() {
      // 프렌젤 리그 카드 로드
      await loadFrenzelLeagueCard('frenzel-league-training');
      
      try {
        // 모든 트레이닝 조회
        const { data: trainings } = await db
          .from('dry_trainings')
          .select('*, users!dry_trainings_instructor_id_fkey(name)')
          .order('created_at', { ascending: false });
        
        allDryTrainings = trainings || [];
        
        // 내가 참여 중인 트레이닝 (participants 배열에 있는지 확인)
        const myTrainings = allDryTrainings.filter(t => 
          t.participants && t.participants.includes(currentUser.user_id)
        );
        
        // 참여 안한 트레이닝
        const otherTrainings = allDryTrainings.filter(t => 
          !t.participants || !t.participants.includes(currentUser.user_id)
        );
        
        // 참여 중인 트레이닝 영역
        const myContainer = document.getElementById('my-dry-trainings');
        const calendarSection = document.getElementById('dry-training-calendar-section');
        const otherSection = document.getElementById('other-dry-trainings-section');
        const allSection = document.getElementById('all-dry-trainings-section');
        
        if (myTrainings.length === 0) {
          // 참여 중인 트레이닝이 없는 경우 (사진3)
          myContainer.innerHTML = `<div class="card" style="text-align: center; color: var(--text-secondary); padding: 20px;">
            참여 중인 트레이닝이 없습니다<br>
            <span style="font-size: 12px;">아래에서 트레이닝을 선택해보세요!</span>
          </div>`;
          
          // 캘린더 숨기기, 참여중이지 않은 트레이닝 섹션 숨기기
          calendarSection.style.display = 'none';
          otherSection.style.display = 'none';
          
          // 전체 트레이닝 표시
          allSection.style.display = 'block';
          const allContainer = document.getElementById('all-dry-trainings-no-participation');
          
          if (allDryTrainings.length === 0) {
            allContainer.innerHTML = `<div class="card" style="text-align: center; color: var(--text-secondary); padding: 20px;">
              등록된 트레이닝이 없습니다
            </div>`;
          } else {
            let html = '';
            for (const t of allDryTrainings) {
              html += renderDryCard(t, false);
            }
            allContainer.innerHTML = html;
          }
        } else {
          // 참여 중인 트레이닝이 있는 경우 (사진5)
          // 첫 번째 참여 중인 트레이닝을 currentDryId로 설정
          currentDryId = myTrainings[0].dry_id;
          
          // 참여 중인 트레이닝 카드 (체크 버튼 포함)
          let myHtml = '';
          const today = new Date().toISOString().split('T')[0];
          const { data: todayRecords } = await db
            .from('dry_training_records')
            .select('dry_id')
            .eq('user_id', currentUser.user_id)
            .eq('date', today);
          
          const completedIds = (todayRecords || []).map(r => r.dry_id);
          
          for (const t of myTrainings) {
            const isDone = completedIds.includes(t.dry_id);
            myHtml += `<div class="card" style="margin-bottom: 12px; cursor: pointer;" onclick="openDryDetail('${t.dry_id}')">
              <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div style="flex: 1;">
                  <div style="font-weight: 600; margin-bottom: 4px;">${t.name}</div>
                  <div style="font-size: 13px; color: var(--text-secondary);">${t.description || ''}</div>
                </div>
                <div style="display: flex; gap: 8px;">
                  <button class="btn btn-secondary btn-small" onclick="event.stopPropagation(); openDryDetail('${t.dry_id}')">설명</button>
                  ${isDone 
                    ? `<span style="color: var(--success); font-size: 13px; padding: 10px 16px;"><i class="fas fa-check-circle"></i> 완료</span>`
                    : `<button class="btn btn-primary btn-small" onclick="event.stopPropagation(); quickDryRecord('${t.dry_id}')">체크</button>`
                  }
                </div>
              </div>
            </div>`;
          }
          myContainer.innerHTML = myHtml;
          
          // 캘린더 표시
          calendarSection.style.display = 'block';
          renderDryListCalendar();
          
          // 참여중이지 않은 트레이닝 표시
          allSection.style.display = 'none';
          
          if (otherTrainings.length > 0) {
            otherSection.style.display = 'block';
            const allContainer = document.getElementById('all-dry-trainings');
            let html = '';
            for (const t of otherTrainings) {
              html += renderDryCard(t, false);
            }
            allContainer.innerHTML = html;
          } else {
            otherSection.style.display = 'none';
          }
        }
      } catch (err) {
        console.error('드라이 트레이닝 로드 오류:', err);
      }
    }
    
    // 드라이 트레이닝 목록 캘린더 변수
    let dryListCalendarYear = new Date().getFullYear();
    let dryListCalendarMonth = new Date().getMonth();
    
    // 드라이 목록 캘린더 월 변경
    function changeDryListMonth(delta) {
      dryListCalendarMonth += delta;
      if (dryListCalendarMonth > 11) {
        dryListCalendarMonth = 0;
        dryListCalendarYear++;
      } else if (dryListCalendarMonth < 0) {
        dryListCalendarMonth = 11;
        dryListCalendarYear--;
      }
      renderDryListCalendar();
    }
    
    // 드라이 목록 캘린더 렌더링
    async function renderDryListCalendar() {
      const monthNames = ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'];
      document.getElementById('dry-list-calendar-title').textContent = `${dryListCalendarYear}년 ${monthNames[dryListCalendarMonth]}`;
      
      // 해당 월 기록 조회 (참여 중인 모든 트레이닝)
      const startDate = `${dryListCalendarYear}-${String(dryListCalendarMonth + 1).padStart(2, '0')}-01`;
      const endDate = `${dryListCalendarYear}-${String(dryListCalendarMonth + 1).padStart(2, '0')}-31`;
      
      const { data: records } = await db
        .from('dry_training_records')
        .select('date, achievement')
        .eq('user_id', currentUser.user_id)
        .gte('date', startDate)
        .lte('date', endDate);
      
      const recordMap = {};
      (records || []).forEach(r => {
        recordMap[r.date] = true;
      });
      
      const firstDay = new Date(dryListCalendarYear, dryListCalendarMonth, 1);
      const lastDay = new Date(dryListCalendarYear, dryListCalendarMonth + 1, 0);
      const startDayOfWeek = firstDay.getDay();
      const daysInMonth = lastDay.getDate();
      const today = new Date().toISOString().split('T')[0];
      
      let html = '';
      
      // 이전 달
      const prevMonthLastDay = new Date(dryListCalendarYear, dryListCalendarMonth, 0).getDate();
      for (let i = startDayOfWeek - 1; i >= 0; i--) {
        html += `<div class="calendar-day other-month">${prevMonthLastDay - i}</div>`;
      }
      
      // 이번 달
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${dryListCalendarYear}-${String(dryListCalendarMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const isToday = dateStr === today;
        const hasRecord = recordMap[dateStr];
        
        let classes = 'calendar-day';
        if (isToday) classes += ' today';
        if (hasRecord) classes += ' has-dry';
        
        html += `<div class="${classes}">${day}</div>`;
      }
      
      // 다음 달
      const totalCells = startDayOfWeek + daysInMonth;
      const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
      for (let i = 1; i <= remainingCells; i++) {
        html += `<div class="calendar-day other-month">${i}</div>`;
      }
      
      document.getElementById('dry-list-calendar-days').innerHTML = html;
    }

    // 드라이 트레이닝 카드 렌더링 (공용)
    function renderDryCard(t, isParticipating) {
      return `<div class="card" style="margin-bottom: 12px; cursor: pointer;" onclick="openDryDetail('${t.dry_id}')">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
          <div style="flex: 1;">
            <div style="font-weight: 600; margin-bottom: 4px;">${t.name}</div>
            <div style="font-size: 13px; color: var(--text-secondary);">${t.description || ''}</div>
            <div style="font-size: 12px; color: var(--text-tertiary); margin-top: 4px;">by ${t.users?.name || '강사'}</div>
          </div>
          <div style="display: flex; gap: 8px;">
            <button class="btn btn-secondary btn-small" onclick="event.stopPropagation(); openDryDetail('${t.dry_id}')">설명</button>
            ${isParticipating 
              ? `<button class="btn btn-primary btn-small" onclick="event.stopPropagation(); quickDryRecord('${t.dry_id}')">체크</button>`
              : `<button class="btn btn-primary btn-small" onclick="event.stopPropagation(); joinDryTraining('${t.dry_id}')">참여하기</button>`
            }
          </div>
        </div>
      </div>`;
    }

    // 학생: 트레이닝 참여하기 (드라이 탭에서)
    async function joinDryTraining(dryId) {
      try {
        // 현재 트레이닝 정보 가져오기
        const training = allDryTrainings.find(t => t.dry_id === dryId);
        if (!training) return;
        
        // participants 배열에 현재 유저 추가
        const currentParticipants = training.participants || [];
        if (!currentParticipants.includes(currentUser.user_id)) {
          const newParticipants = [...currentParticipants, currentUser.user_id];
          
          await db.from('dry_trainings')
            .update({ participants: newParticipants })
            .eq('dry_id', dryId);
          
          // 로컬 데이터도 업데이트
          training.participants = newParticipants;
        }
        
        showToast('참여 완료!');
        currentDryId = dryId;
        // 드라이 탭 새로고침 (사진3처럼 표시)
        loadDryTraining();
      } catch (err) {
        console.error('참여 오류:', err);
        showToast('참여 실패: ' + err.message);
      }
    }

    // 기록 입력 시트 열기
    function openDryRecordSheet() {
      // 기본값 100%
      document.querySelectorAll('#dry-achievement-btns .purpose-btn').forEach(b => b.classList.remove('selected'));
      document.querySelector('#dry-achievement-btns .purpose-btn[data-value="1.0"]').classList.add('selected');
      document.getElementById('dry-record-note').value = '';
      openBottomSheet('sheet-dry-record');
    }

    function selectDryAchievement(btn) {
      document.querySelectorAll('#dry-achievement-btns .purpose-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
    }

    // 기록 저장
    async function saveDryRecord() {
      const achievementBtn = document.querySelector('#dry-achievement-btns .purpose-btn.selected');
      const achievement = parseFloat(achievementBtn.dataset.value);
      const note = document.getElementById('dry-record-note').value.trim();
      const today = new Date().toISOString().split('T')[0];
      
      try {
        // 기존 기록 확인
        const { data: existing } = await db
          .from('dry_training_records')
          .select('record_id')
          .eq('dry_id', currentDryId)
          .eq('user_id', currentUser.user_id)
          .eq('date', today)
          .maybeSingle();
        
        if (existing) {
          // 수정
          await db.from('dry_training_records')
            .update({ achievement, note })
            .eq('record_id', existing.record_id);
        } else {
          // 추가
          await db.from('dry_training_records')
            .insert({
              dry_id: currentDryId,
              user_id: currentUser.user_id,
              date: today,
              achievement,
              note
            });
        }
        
        showToast('완료! 🎉');
        closeBottomSheet('sheet-dry-record');
        
        // 현재 화면에 따라 새로고침
        const currentScreen = document.querySelector('.screen.active');
        if (currentScreen) {
          if (currentScreen.id === 'screen-student-home') {
            loadHomeDryTraining();
          } else if (currentScreen.id === 'screen-dry-training') {
            loadDryTraining();
          }
        }
        // 홈 드라이 섹션도 새로고침
        loadHomeDryTraining();
      } catch (err) {
        console.error('기록 저장 오류:', err);
        showToast('저장 실패: ' + err.message);
      }
    }

    // 학생 홈: 드라이 트레이닝 섹션 로드
    async function loadHomeDryTraining() {
      try {
        const { data: trainings } = await db
          .from('dry_trainings')
          .select('*, users!dry_trainings_instructor_id_fkey(name)')
          .limit(5);
        
        const container = document.getElementById('home-dry-training');
        
        if (!trainings || trainings.length === 0) {
          container.innerHTML = `<div class="card" style="text-align: center; color: var(--text-secondary); padding: 20px;">
            등록된 드라이 트레이닝이 없습니다
          </div>`;
          return;
        }
        
        // 내가 참여 중인 트레이닝만 필터링
        const myTrainings = trainings.filter(t => 
          t.participants && t.participants.includes(currentUser.user_id)
        );
        
        let html = '';
        
        // 참여한 트레이닝만 표시
        if (myTrainings.length > 0) {
          // 오늘 기록 확인
          const today = new Date().toISOString().split('T')[0];
          const { data: todayRecords } = await db
            .from('dry_training_records')
            .select('dry_id')
            .eq('user_id', currentUser.user_id)
            .eq('date', today);
          
          const completedIds = (todayRecords || []).map(r => r.dry_id);
          
          for (const t of myTrainings) {
            const isDone = completedIds.includes(t.dry_id);
            html += `<div class="card" style="margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="openDryDetail('${t.dry_id}')">
              <span>${t.name}</span>
              <div style="display: flex; gap: 8px;">
                <button class="btn btn-secondary btn-small" onclick="event.stopPropagation(); openDryDetail('${t.dry_id}')">설명</button>
                ${isDone 
                  ? `<span style="color: var(--success); font-size: 13px;"><i class="fas fa-check-circle"></i> 완료</span>`
                  : `<button class="btn btn-small btn-primary" onclick="event.stopPropagation(); quickDryRecord('${t.dry_id}')">체크</button>`
                }
              </div>
            </div>`;
          }
        } else {
          // 참여 중인 트레이닝이 없으면 안내 메시지
          html = `<div class="card" style="text-align: center; color: var(--text-secondary); padding: 20px;">
            참여 중인 드라이 트레이닝이 없습니다<br>
            <span style="font-size: 12px;">트레이닝 탭에서 참여해보세요!</span>
          </div>`;
        }
        
        container.innerHTML = html;
      } catch (err) {
        console.error('홈 드라이 트레이닝 로드 오류:', err);
      }
    }
    
    // 홈에서 트레이닝 참여하기 (joinDryTraining과 동일하게 동작하지만 홈 새로고침)
    async function joinDryTrainingFromHome(dryId) {
      try {
        // 현재 트레이닝 정보 가져오기
        const { data: training } = await db
          .from('dry_trainings')
          .select('*')
          .eq('dry_id', dryId)
          .single();
        
        if (!training) return;
        
        // participants 배열에 현재 유저 추가
        const currentParticipants = training.participants || [];
        if (!currentParticipants.includes(currentUser.user_id)) {
          const newParticipants = [...currentParticipants, currentUser.user_id];
          
          await db.from('dry_trainings')
            .update({ participants: newParticipants })
            .eq('dry_id', dryId);
        }
        
        showToast('참여 완료!');
        loadHomeDryTraining(); // 홈 새로고침
      } catch (err) {
        console.error('참여 오류:', err);
        showToast('참여 실패: ' + err.message);
      }
    }

    // 홈에서 빠른 기록
    // 홈에서 기록하기 (바텀시트 열기)
    function quickDryRecord(dryId) {
      currentDryId = dryId;
      openDryRecordSheet();
    }

    // 기록 저장 후 콜백 (홈에서 호출 시 홈도 새로고침)
    let afterDryRecordSave = null;

    // ==================== 자격증 이미지 ====================

// 마이페이지 로드 시 자격증 표시
function renderCertImage() {
  const container = document.getElementById('cert-image-container');
  
  if (currentUser.cert_image_url) {
    // 이미지가 있으면 표시
    container.innerHTML = `
      <div style="position: relative;">
        <img src="${currentUser.cert_image_url}" 
             style="width: 100%; border-radius: 12px; cursor: pointer;"
             onclick="viewCertImage('${currentUser.cert_image_url}')"
             alt="자격증">
        <button onclick="deleteCertImage()" 
                style="position: absolute; top: 8px; right: 8px; 
                       width: 32px; height: 32px; border-radius: 50%; 
                       border: none; background: rgba(0,0,0,0.5); 
                       color: white; cursor: pointer;">
          <i class="fas fa-trash"></i>
        </button>
      </div>
    `;
  } else {
    // 이미지가 없으면 업로드 버튼
    container.innerHTML = `
      <label style="display: flex; flex-direction: column; align-items: center; 
                    padding: 40px 20px; border: 2px dashed var(--border); 
                    border-radius: 12px; cursor: pointer; color: var(--text-secondary);">
        <i class="fas fa-camera" style="font-size: 32px; margin-bottom: 12px;"></i>
        <span>자격증 사진 등록</span>
        <span style="font-size: 12px; margin-top: 4px;">탭하여 업로드</span>
        <input type="file" accept="image/*" onchange="uploadCertImage(event)" style="display: none;">
      </label>
    `;
  }
}

// 자격증 이미지 업로드
async function uploadCertImage(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  // 파일 크기 체크 (5MB 제한)
  if (file.size > 5 * 1024 * 1024) {
    showToast('파일 크기는 5MB 이하로 해주세요');
    return;
  }
  
  showToast('업로드 중...');
  
  try {
    // 파일명 생성
    const fileExt = file.name.split('.').pop();
    const fileName = `${currentUser.user_id}_${Date.now()}.${fileExt}`;
    
    // Supabase Storage에 업로드
    const { data, error } = await db.storage
      .from('certifications')
      .upload(fileName, file);
    
    if (error) throw error;
    
    // Public URL 가져오기
    const { data: urlData } = db.storage
      .from('certifications')
      .getPublicUrl(fileName);
    
    const imageUrl = urlData.publicUrl;
    
    // DB에 URL 저장
    const { error: updateError } = await db
      .from('users')
      .update({ cert_image_url: imageUrl })
      .eq('user_id', currentUser.user_id);
    
    if (updateError) throw updateError;
    
    // 로컬 데이터 업데이트
    currentUser.cert_image_url = imageUrl;
    localStorage.setItem('divelog_user', JSON.stringify(currentUser));
    
    showToast('자격증이 등록되었습니다!');
    renderCertImage();
    
  } catch (err) {
    console.error('업로드 오류:', err);
    showToast('업로드 실패: ' + err.message);
  }
}

// 자격증 이미지 삭제
async function deleteCertImage() {
  if (!confirm('자격증 이미지를 삭제하시겠습니까?')) return;
  
  try {
    // Storage에서 파일 삭제 (URL에서 파일명 추출)
    const url = currentUser.cert_image_url;
    const fileName = url.split('/').pop();
    
    await db.storage
      .from('certifications')
      .remove([fileName]);
    
    // DB에서 URL 제거
    const { error } = await db
      .from('users')
      .update({ cert_image_url: null })
      .eq('user_id', currentUser.user_id);
    
    if (error) throw error;
    
    // 로컬 데이터 업데이트
    currentUser.cert_image_url = null;
    localStorage.setItem('divelog_user', JSON.stringify(currentUser));
    
    showToast('삭제되었습니다');
    renderCertImage();
    
  } catch (err) {
    console.error('삭제 오류:', err);
    showToast('삭제 실패: ' + err.message);
  }
}

// 자격증 이미지 크게 보기
function viewCertImage(url) {
  window.open(url, '_blank');
}
  </script>
</body>
</html>
