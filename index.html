<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>DiveLog</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <!-- Supabase JS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --primary: #3182F6;
      --primary-light: #E8F3FF;
      --success: #00C853;
      --warning: #FF9100;
      --error: #F44336;
      --bg: #F7F8FA;
      --surface: #FFFFFF;
      --text-primary: #191F28;
      --text-secondary: #8B95A1;
      --text-tertiary: #B0B8C1;
      --border: #E5E8EB;
      --divider: #F2F4F6;
      --lv2-color: #FF9100;
      --lv2-light: #FFF3E0;
      --lv3-color: #00C853;
      --lv3-light: #E8F5E9;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text-primary);
      line-height: 1.5;
      min-height: 100vh;
    }
    .app { max-width: 480px; margin: 0 auto; min-height: 100vh; background: var(--bg); position: relative; padding-bottom: 80px; }
    .screen { display: none; }
    .screen.active { display: block; }
    .header { background: var(--surface); padding: 12px 20px; display: flex; align-items: center; gap: 12px; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid var(--divider); }
    .header-back { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border: none; background: none; font-size: 20px; color: var(--text-primary); cursor: pointer; border-radius: 12px; }
    .header-title { font-size: 18px; font-weight: 600; flex: 1; }
    .header-action { color: var(--primary); font-weight: 600; background: none; border: none; font-size: 16px; cursor: pointer; }
    .tab-bar { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 480px; background: var(--surface); border-top: 1px solid var(--divider); display: flex; padding: 8px 0 20px; z-index: 100; }
    .tab-item { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 8px; background: none; border: none; cursor: pointer; color: var(--text-tertiary); }
    .tab-item.active { color: var(--primary); }
    .tab-item i { font-size: 22px; }
    .tab-item span { font-size: 11px; font-weight: 500; }
    .container { padding: 20px; }
    .card { background: var(--surface); border-radius: 16px; padding: 20px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
    .greeting { font-size: 24px; font-weight: 700; margin-bottom: 4px; }
    .greeting-sub { color: var(--text-secondary); font-size: 15px; }
    .section-title { font-size: 16px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    .btn { width: 100%; padding: 16px; border-radius: 12px; font-size: 16px; font-weight: 600; border: none; cursor: pointer; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-secondary { background: var(--primary-light); color: var(--primary); }
    .btn-outline { background: transparent; border: 1px dashed var(--border); color: var(--text-secondary); }
    .btn-danger { background: #FEE; color: var(--error); }
    .btn-small { padding: 10px 16px; width: auto; font-size: 14px; }
    .input-group { margin-bottom: 16px; }
    .input-label { font-size: 14px; font-weight: 500; color: var(--text-secondary); margin-bottom: 8px; display: block; }
    .input { width: 100%; padding: 14px 16px; border: 1px solid var(--border); border-radius: 12px; font-size: 16px; font-family: inherit; background: var(--surface); }
    .input:focus { outline: none; border-color: var(--primary); }
    select.input { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%238B95A1' d='M6 8L1 3h10z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 16px center; }
    .schedule-card { display: flex; justify-content: space-between; align-items: center; }
    .schedule-info { flex: 1; }
    .schedule-time { font-size: 15px; font-weight: 600; margin-bottom: 2px; }
    .schedule-location { font-size: 14px; color: var(--text-secondary); }
    .schedule-meta { font-size: 13px; color: var(--text-tertiary); margin-top: 4px; }
    .schedule-arrow { color: var(--text-tertiary); font-size: 18px; }
    .participant-card { display: flex; align-items: center; gap: 12px; padding: 16px 0; border-bottom: 1px solid var(--divider); }
    .participant-card:last-child { border-bottom: none; }
    .participant-avatar { width: 44px; height: 44px; border-radius: 50%; background: var(--primary-light); display: flex; align-items: center; justify-content: center; color: var(--primary); font-weight: 600; }
    .participant-info { flex: 1; }
    .participant-name { font-weight: 600; font-size: 16px; }
    .participant-detail { font-size: 13px; color: var(--text-secondary); margin-top: 2px; }
    .attendance-badge { padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 500; }
    .attendance-yes { background: #E8F5E9; color: var(--success); }
    .attendance-no { background: #FFEBEE; color: var(--error); }
    .attendance-pending { background: var(--divider); color: var(--text-secondary); }
    .record-row { background: var(--bg); border-radius: 12px; padding: 16px; margin-bottom: 12px; }
    .record-row-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .record-row-title { font-weight: 600; font-size: 14px; color: var(--text-secondary); }
    .record-row-delete { background: none; border: none; color: var(--error); cursor: pointer; font-size: 18px; }
    .record-fields { display: grid; grid-template-columns: 1fr 80px 100px; gap: 8px; }
    .record-note { margin-top: 8px; }
    .record-note .input { padding: 10px 12px; font-size: 14px; }
    .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px; }
    .stat-card { background: var(--surface); border-radius: 12px; padding: 16px; text-align: center; }
    .stat-label { font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; }
    .stat-value { font-size: 20px; font-weight: 700; color: var(--primary); }
    .level-card { text-align: center; padding: 24px 20px; }
    .level-badge { font-size: 32px; font-weight: 700; color: var(--primary); margin-bottom: 8px; }
    .progress-bar { height: 8px; background: var(--divider); border-radius: 4px; overflow: hidden; margin: 12px 0; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary), #60A5FA); border-radius: 4px; }
    .quick-actions { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .quick-btn { background: var(--surface); border-radius: 16px; padding: 20px 12px; text-align: center; border: none; cursor: pointer; }
    .quick-btn i { font-size: 24px; color: var(--primary); margin-bottom: 8px; display: block; }
    .quick-btn span { font-size: 13px; font-weight: 500; }
    .btn-icon-delete { 
      background: none; 
      border: none; 
      color: var(--text-tertiary); 
      cursor: pointer; 
      padding: 8px; 
      margin-left: 4px;
      border-radius: 8px;
    }
    .btn-icon-delete:hover { color: var(--error); background: #FEE; }
    
    /* Ï∞∏Í∞ÄÏûê ÌÉ≠ */
    .participant-tabs {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding-bottom: 8px;
      margin-bottom: 16px;
    }
    .participant-tab {
      padding: 10px 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
      white-space: nowrap;
      cursor: pointer;
    }
    .participant-tab.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    
    /* Ï¢ÖÎ™© ÌÉ≠ */
    .discipline-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      overflow-x: auto;
    }
    .disc-tab {
      padding: 8px 16px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .disc-tab.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    
    /* Í∏∞Î°ù ÏùºÍ¥Ñ ÏûÖÎ†• Ï¢ÖÎ™© ÌÉ≠ (ÌÉúÍ∑∏ ÌòïÌÉú) */
    .batch-tabs-container { display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px; }
    .batch-tabs-row { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
    .batch-tabs-label { font-size: 11px; color: var(--text-tertiary); min-width: 24px; }
    .batch-disc-tag {
      padding: 4px 12px;
      background: var(--primary-light);
      border: none;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
      color: var(--primary);
      cursor: pointer;
    }
    .batch-disc-tag.active {
      background: var(--primary);
      color: white;
    }
    .batch-skill-tag {
      padding: 4px 10px;
      border: none;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
    }
    .batch-skill-tag.lv2 {
      background: var(--lv2-light);
      color: var(--lv2-color);
    }
    .batch-skill-tag.lv2.active {
      background: var(--lv2-color);
      color: white;
    }
    .batch-skill-tag.lv3 {
      background: var(--lv3-light);
      color: var(--lv3-color);
    }
    .batch-skill-tag.lv3.active {
      background: var(--lv3-color);
      color: white;
    }
    
    /* ÏãúÎèÑ ÏûÖÎ†• Ìñâ */
    .attempt-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      padding: 8px;
      background: var(--bg);
      border-radius: 8px;
    }
    .attempt-num {
      width: 30px;
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 13px;
    }
    .attempt-input {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 16px;
    }
    .attempt-input:focus {
      outline: none;
      border-color: var(--primary);
    }
    .attempt-delete {
      width: 32px;
      height: 32px;
      border: none;
      background: none;
      color: var(--text-tertiary);
      cursor: pointer;
      border-radius: 8px;
    }
    .attempt-delete:hover {
      color: var(--error);
      background: #FEE;
    }
    
    /* Í∏∞Î°ù ÌÖåÏù¥Î∏î */
    .record-table-container {
      overflow-x: auto;
    }
    .record-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    .record-table th, .record-table td {
      padding: 10px 8px;
      text-align: center;
      border-bottom: 1px solid var(--divider);
    }
    .record-table th {
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 13px;
      background: var(--bg);
    }
    .record-table .col-name {
      text-align: left;
      min-width: 70px;
      font-weight: 500;
    }
    .record-table .col-attempt {
      min-width: 60px;
    }
    .record-table .col-note {
      min-width: 80px;
    }
    .record-table .col-skill {
      min-width: 50px;
    }
    .record-table .col-add-attempt {
      width: 30px;
      padding: 4px;
      border-left: 1px solid var(--divider);
    }
    .btn-add-col {
      width: 24px;
      height: 24px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 16px;
      color: var(--text-tertiary);
    }
    .btn-add-col:hover {
      color: var(--primary);
    }
    .record-table input {
      width: 100%;
      padding: 8px 4px;
      border: none;
      background: transparent;
      text-align: center;
      font-size: 14px;
      color: var(--text-secondary);
    }
    .record-table input:focus {
      outline: none;
      color: var(--primary);
      font-weight: 600;
    }
    .record-table input::placeholder {
      color: var(--text-tertiary);
    }
    .record-table input.note-input {
      text-align: left;
      padding-left: 8px;
    }
    .record-table td {
      border-right: 1px solid var(--divider);
    }
    .record-table td:last-child {
      border-right: none;
    }
    
    /* Ïä§ÌÇ¨ Ï≤¥ÌÅ¨ Î≤ÑÌäº */
    .skill-check-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 2px solid var(--border);
      background: white;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    .skill-check-btn.success {
      background: var(--success);
      border-color: var(--success);
      color: white;
    }
    .skill-check-btn.fail {
      background: var(--error);
      border-color: var(--error);
      color: white;
    }
    
    /* Ïä§ÌÇ¨ ÌÉ≠ */
    .disc-tab-skill {
      background: var(--lv3-light) !important;
      border-color: var(--lv3-color) !important;
      color: var(--lv3-color) !important;
    }
    .disc-tab-skill.active {
      background: var(--lv3-color) !important;
      color: white !important;
    }
    
    /* ÏùºÏ†ï ÏÑ†ÌÉù ÏïÑÏù¥ÌÖú */
    .schedule-select-item {
      padding: 16px;
      border-bottom: 1px solid var(--divider);
      cursor: pointer;
    }
    .schedule-select-item:hover {
      background: var(--bg);
    }
    .schedule-select-item:last-child {
      border-bottom: none;
    }
    
    /* ÏïÑÏù¥ÏΩò Î≤ÑÌäº */
    .icon-btn {
      width: 36px;
      height: 36px;
      border: none;
      background: transparent;
      color: var(--text-tertiary);
      cursor: pointer;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    .icon-btn:hover {
      background: var(--bg);
      color: var(--text-secondary);
    }
    
    /* Î™®Îìú Ïä§ÏúÑÏπò Î≤ÑÌäº - ÌÜ†Í∏Ä ÌòïÌÉú */
    .mode-switch-container {
      display: flex;
      background: var(--bg);
      border-radius: 8px;
      padding: 2px;
    }
    .mode-switch-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      color: var(--text-tertiary);
      cursor: pointer;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      transition: all 0.15s;
    }
    .mode-switch-btn.active {
      background: var(--surface);
      color: var(--text-primary);
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .mode-switch-btn:hover:not(.active) {
      color: var(--text-secondary);
    }
    
    /* ÏÑπÏÖò ÌÉÄÏù¥ÌãÄ (ÏùºÏ†ï Íµ¨Î∂Ñ) */
    .schedule-section-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-tertiary);
      margin: 20px 0 12px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .schedule-section-title:first-child {
      margin-top: 0;
    }
    
    /* Ï∫òÎ¶∞Îçî Ïä§ÌÉÄÏùº */
    .calendar-header {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      padding: 12px 0;
      margin-bottom: 8px;
    }
    .calendar-nav {
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      border-radius: 8px;
      font-size: 14px;
    }
    .calendar-nav:hover {
      background: var(--bg);
    }
    .calendar-title {
      font-size: 16px;
      font-weight: 600;
    }
    .calendar-grid {
      background: white;
      border-radius: 16px;
      padding: 0; /* 16px ‚Üí 0ÏúºÎ°ú Ï§ÑÏûÑ (Ï¢åÏö∞ Ïó¨Î∞± Ï†úÍ±∞) */
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .calendar-weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      text-align: center;
      margin-bottom: 4px;
      padding: 8px 0;  /* Ï∂îÍ∞Ä: ÏÉÅÌïò Ïó¨Î∞±Îßå */
    }
    .calendar-weekdays .weekday {
      font-size: 12px;
      color: var(--text-tertiary);
      padding: 8px 0;
    }
    .calendar-weekdays .weekday.sun {
      color: var(--error);
    }
    .calendar-weekdays .weekday.sat {
      color: var(--primary);
    }
    .calendar-days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px 0;  /* ÏÑ∏Î°ú Í∞ÑÍ≤© */
      padding: 0 0 12px 0;
    }
    .calendar-day {
      aspect-ratio: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      cursor: pointer;
      font-size: 14px;
      font-weight: 400;  /* Í∏∞Î≥∏: bold ÏóÜÏùå */
      position: relative;
      color: var(--text-primary);
      width: 40px;
      height: 40px;
      max-width: 40px;
      max-height: 40px;
      margin: 0 auto;
    }
    .calendar-day:hover {
      background: var(--bg);
    }
    .calendar-day.other-month {
      color: var(--text-tertiary);
      font-weight: 400;
    }
    /* Ïò§Îäò ÎÇ†Ïßú - Î∞ëÏ§ÑÎ°ú ÌëúÏãú */
    .calendar-day.today::after {
      content: '';
      position: absolute;
      bottom: 6px;
      left: 50%;
      transform: translateX(-50%);
      width: 16px;
      height: 2px;
      background: var(--text-secondary);
      border-radius: 1px;
    }
    .calendar-day.today:hover {
      background: var(--bg);
    }
    .calendar-day.selected {
      /* ÏÑ†ÌÉùÏãú bold */
      font-weight: 600;
    }
    .calendar-day.selected:hover {
      background: var(--bg);
    }
    .calendar-day.today.selected::after {
      background: var(--text-secondary);
    }
    /* ÏùºÏ†ï ÏûàÎäî ÎÇ†Ïßú - Ïó∞Ìïú ÏÉâ ÎèôÍ∑∏ÎùºÎØ∏ ÌëúÏãú */
    .calendar-day.has-lesson {
      background: #BFDBFE; /* Ïó∞Ìïú ÌïòÎäòÏÉâ */
      color: var(--text-primary);
    }
    .calendar-day.has-personal {
      background: #BBF7D0; /* Ïó∞Ìïú Ïó∞ÎëêÏÉâ */
      color: var(--text-primary);
    }
    .calendar-day.has-dry {
      background: #FED7AA; /* Ïó∞Ìïú Ï£ºÌô©ÏÉâ */
      color: var(--text-primary);
    }
    /* ÏùºÏ†ï ÏûàÎäî ÎÇ†Ïßú hover Ïãú Î∞∞Í≤ΩÏÉâ Ïú†ÏßÄ */
    .calendar-day.has-lesson:hover {
      background: #BFDBFE;
    }
    .calendar-day.has-personal:hover {
      background: #BBF7D0;
    }
    .calendar-day.has-dry:hover {
      background: #FED7AA;
    }
    /* Ïã†Ï≤≠ Í∞ÄÎä•Ìïú Í∞ïÏäµ - ÌÖåÎëêÎ¶¨Îßå */
    .calendar-day.has-available {
      box-shadow: inset 0 0 0 2px #93C5FD;
      color: var(--text-primary);
    }
    .calendar-day.has-available:hover {
      background: rgba(147, 197, 253, 0.1);
    }
    .calendar-day.has-lesson.selected,
    .calendar-day.has-personal.selected,
    .calendar-day.has-dry.selected,
    .calendar-day.has-available.selected {
      font-weight: 600;
    }
    /* Ïò§ÎäòÏù¥Î©¥ÏÑú ÏùºÏ†ï ÏûàÎäî ÎÇ†Ïßú */
    .calendar-day.has-lesson.today::after,
    .calendar-day.has-personal.today::after,
    .calendar-day.has-dry.today::after {
      background: var(--text-primary);
    }
    .calendar-day.has-available.today::after {
      background: #3B82F6;
    }
    /* ÏùºÏ†ï Î∞î Ï†úÍ±∞ (ÎèôÍ∑∏ÎùºÎØ∏Î°ú ÎåÄÏ≤¥) */
    .calendar-day .schedule-bars {
      display: none;
    }
    
    /* Î≤îÎ°Ä */
    .calendar-legend {
      display: flex;
      justify-content: center;
      gap: 16px;
  padding: 8px 0;  /* 12px 0 ‚Üí 8px 0 */
      font-size: 12px;
      color: var(--text-secondary);
    }
    .calendar-legend span {
      display: flex;
      align-items: center;
      gap: 6px;
    }

/* ÏÑ†ÌÉùÎêú ÎÇ†Ïßú Ìó§Îçî */
    .selected-date-header {
      display: flex;
      align-items: center;
      gap: 8px;
  padding: 12px 0;  /* 16px 0 12px 0 ‚Üí 12px 0 */
      font-weight: 600;
      color: var(--text-primary);
      border-top: 1px solid var(--divider);
      margin-top: 8px;
    }
    .selected-date-header i {
      color: var(--primary);
    }
    .tab-filter { display: flex; gap: 8px; margin-bottom: 16px; overflow-x: auto; }
    .filter-chip { padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 500; background: var(--surface); border: 1px solid var(--border); color: var(--text-secondary); cursor: pointer; white-space: nowrap; }
    .filter-chip.active { background: var(--primary); border-color: var(--primary); color: white; }
    .bottom-sheet-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); z-index: 200; opacity: 0; visibility: hidden; transition: all 0.3s; }
    .bottom-sheet-overlay.active { opacity: 1; visibility: visible; }
    .bottom-sheet { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%) translateY(100%); width: 100%; max-width: 480px; background: var(--surface); border-radius: 24px 24px 0 0; z-index: 201; transition: transform 0.3s ease; max-height: 90vh; overflow-y: auto; }
    .bottom-sheet-overlay.active .bottom-sheet { transform: translateX(-50%) translateY(0); }
    .bottom-sheet-handle { width: 40px; height: 4px; background: var(--border); border-radius: 2px; margin: 12px auto; }
    .bottom-sheet-content { padding: 8px 20px 32px; }
    .bottom-sheet-title { font-size: 20px; font-weight: 700; margin-bottom: 20px; }
    .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: var(--text-primary); color: white; padding: 14px 24px; border-radius: 12px; font-size: 15px; font-weight: 500; z-index: 300; opacity: 0; visibility: hidden; transition: all 0.3s; }
    .toast.show { opacity: 1; visibility: visible; }
    .login-screen { display: flex; flex-direction: column; min-height: 100vh; padding: 60px 24px 40px; }
    .login-logo { text-align: center; margin-bottom: 48px; }
    .login-logo i { font-size: 64px; color: var(--primary); margin-bottom: 16px; }
    .login-logo h1 { font-size: 32px; font-weight: 700; }
    .login-logo p { color: var(--text-secondary); margin-top: 8px; }
    .login-form { flex: 1; }
    .phone-input-wrapper { position: relative; }
    .phone-prefix { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: var(--text-primary); font-size: 16px; pointer-events: none; }
    .phone-input { padding-left: 46px !important; }
    .empty-state { text-align: center; padding: 48px 20px; }
    .empty-state i { font-size: 48px; color: var(--text-tertiary); margin-bottom: 16px; }
    .empty-state p { color: var(--text-secondary); }
    .purpose-buttons { display: flex; gap: 8px; margin-top: 12px; }
    .purpose-btn { flex: 1; padding: 12px; border-radius: 10px; font-size: 14px; font-weight: 500; border: 1px solid var(--border); background: var(--surface); cursor: pointer; }
    .purpose-btn.selected { background: var(--primary); border-color: var(--primary); color: white; }
    .chart-container { background: var(--surface); border-radius: 16px; padding: 20px; margin-bottom: 16px; }
    .chart-title { font-size: 16px; font-weight: 600; margin-bottom: 16px; }
    .record-list-item { padding: 16px 0; border-bottom: 1px solid var(--divider); }
    .record-list-item:last-child { border-bottom: none; }
    .record-date { font-size: 14px; font-weight: 600; margin-bottom: 8px; }
    .record-entry { display: flex; justify-content: space-between; padding: 4px 0; }
    .record-discipline { font-size: 14px; color: var(--text-secondary); }
    .record-value { font-weight: 600; }
    
    .discipline-checkbox { display: inline-block; margin: 8px 12px 8px 0; }
    .discipline-checkbox input { margin-right: 6px; }
    .batch-tabs { display: flex; gap: 8px; margin-bottom: 16px; border-bottom: 2px solid var(--border); overflow-x: auto; }
    .batch-tab { padding: 12px 20px; background: none; border: none; font-weight: 500; color: var(--text-secondary); cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px; white-space: nowrap; }
    .batch-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
    .batch-tab.skill-tab { color: var(--success); }
    .batch-tab.skill-tab.active { border-bottom-color: var(--success); }
    .batch-tab.skill-tab-lv2 { color: var(--lv2-color); }
    .batch-tab.skill-tab-lv2.active { border-bottom-color: var(--lv2-color); }
    .batch-table { width: 100%; border-collapse: collapse; }
    .batch-table th { background: var(--bg); padding: 12px 8px; font-size: 14px; font-weight: 600; text-align: left; }
    .batch-table td { padding: 12px 8px; border-bottom: 1px solid var(--divider); }
    .batch-table input { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; }
    .batch-table .student-name { font-weight: 500; }
    .common-disciplines-badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: var(--primary-light); color: var(--primary); border-radius: 20px; font-size: 13px; font-weight: 500; margin-top: 8px; }
    .common-disciplines-badge.skill-badge { background: #E8F5E9; color: var(--success); }
    .common-disciplines-badge.skill-badge-lv2 { background: var(--lv2-light); color: var(--lv2-color); }

    /* Ïä§ÌÇ¨ ÌÖåÏù¥Î∏î Ïä§ÌÉÄÏùº */
    .skill-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .skill-table th { background: var(--bg); padding: 8px 4px; font-weight: 600; text-align: center; border-bottom: 2px solid var(--border); }
    .skill-table th.skill-header { font-size: 11px; }
    .skill-table th.attempt-header { font-size: 10px; color: var(--text-tertiary); font-weight: 500; }
    .skill-table td { padding: 8px 4px; border-bottom: 1px solid var(--divider); text-align: center; }
    .skill-table td.student-name { text-align: left; font-weight: 500; padding-left: 8px; white-space: nowrap; }
    .skill-cell { 
      width: 32px; 
      height: 32px; 
      border-radius: 8px; 
      display: inline-flex; 
      align-items: center; 
      justify-content: center; 
      cursor: pointer; 
      font-size: 14px;
      transition: all 0.15s ease;
      user-select: none;
    }
    .skill-cell.empty { background: var(--divider); color: var(--text-tertiary); }
    .skill-cell.success { background: #E8F5E9; color: var(--success); }
    .skill-cell.fail { background: #FFEBEE; color: var(--error); }
    .skill-cell:active { transform: scale(0.9); }
    
    .skill-group-header { 
      background: var(--primary-light) !important; 
      color: var(--primary); 
      font-weight: 600 !important;
    }
    .skill-group-header-lv2 { 
      background: var(--lv2-light) !important; 
      color: var(--lv2-color); 
      font-weight: 600 !important;
    }

    /* Lv ÏßÑÎèÑ Ï∞®Ìä∏ Ïä§ÌÉÄÏùº */
    .lv-charts { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
    .lv-chart-card { background: var(--surface); border-radius: 16px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
    .chart-header { font-size: 14px; font-weight: 600; margin-bottom: 12px; text-align: center; color: var(--text-primary); display: flex; align-items: center; justify-content: center; gap: 6px; cursor: pointer; user-select: none; }
    .chart-header:hover { color: var(--primary); }
    .toggle-icon { font-size: 12px; transition: transform 0.3s ease; color: var(--text-tertiary); }
    .toggle-icon.open { transform: rotate(180deg); }
    .donut-container { position: relative; width: 140px; height: 140px; margin: 0 auto 16px; }
    .donut-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; pointer-events: none; }
    .donut-value { font-size: 24px; font-weight: 700; color: var(--primary); line-height: 1; }
    .donut-value.lv2 { color: var(--lv2-color); }
    .donut-value.lv3 { color: var(--lv3-color); }
    .donut-label { font-size: 11px; color: var(--text-secondary); margin-top: 4px; }
    .checklist { border-top: 1px solid var(--divider); padding-top: 0; max-height: 0; overflow: hidden; transition: max-height 0.3s ease, padding 0.3s ease; border-top: none; }
    .checklist.open { max-height: 300px; overflow-y: auto; padding-top: 12px; border-top: 1px solid var(--divider); }
    .checklist-item { display: flex; align-items: center; gap: 8px; padding: 8px 0; border-bottom: 1px solid var(--divider); }
    .checklist-item:last-child { border-bottom: none; }
    .checklist-icon { width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 11px; }
    .checklist-icon.done { background: #E8F5E9; color: var(--success); }
    .checklist-icon.undone { background: var(--divider); color: var(--text-tertiary); }
    .checklist-text { flex: 1; font-size: 12px; line-height: 1.3; }
    .checklist-text.done { color: var(--text-secondary); text-decoration: line-through; }
    .checklist-badge { font-size: 11px; padding: 2px 6px; border-radius: 10px; background: var(--bg); color: var(--text-secondary); white-space: nowrap; }

    /* ÏùºÏ†ï Ï†ïÎ≥¥ Ïπ¥Îìú Ïä§ÌÉÄÏùº Í∞úÏÑ† */
    .schedule-info-card { background: var(--surface); border-radius: 16px; padding: 16px; margin-bottom: 16px; }
    .schedule-info-row { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
    .schedule-info-row:last-child { margin-bottom: 0; }
    .schedule-info-row i { color: var(--primary); width: 16px; }
    .schedule-badges { display: flex; flex-wrap: wrap; gap: 6px; }
    .btn-edit-disciplines { 
      background: var(--bg); 
      border: 1px solid var(--border); 
      border-radius: 8px; 
      padding: 8px 12px; 
      font-size: 13px; 
      color: var(--text-secondary); 
      cursor: pointer; 
      display: flex; 
      align-items: center; 
      gap: 4px;
      flex-shrink: 0;
    }
    .btn-edit-disciplines:hover { background: var(--divider); color: var(--text-primary); }
    
    /* Ïä§ÌÇ¨ ÏÑπÏÖò Íµ¨Î∂Ñ */
    .skill-section-label { 
      font-size: 12px; 
      font-weight: 600; 
      padding: 8px 12px; 
      margin: 16px 0 8px; 
      border-radius: 8px;
    }
    .skill-section-label.lv2 { background: var(--lv2-light); color: var(--lv2-color); }
    .skill-section-label.lv3 { background: #E8F5E9; color: var(--success); }

    /* ÏùºÏ†ï Ïπ¥Îìú ÏïÑÏù¥ÏΩò Î≤ÑÌäº */
    .schedule-card-header { display: flex; justify-content: space-between; align-items: flex-start; }
    .schedule-card-content { flex: 1; cursor: pointer; }
    .schedule-icon-buttons { display: flex; gap: 4px; flex-shrink: 0; margin-left: 8px; }
    .icon-btn { 
      width: 32px; 
      height: 32px; 
      border-radius: 8px; 
      border: none; 
      background: var(--bg); 
      color: var(--text-tertiary); 
      cursor: pointer; 
      display: flex; 
      align-items: center; 
      justify-content: center;
      font-size: 14px;
      transition: all 0.15s;
    }
    .icon-btn:hover { background: var(--divider); color: var(--text-secondary); }
    .icon-btn.danger:hover { background: #FFEBEE; color: var(--error); }
    .schedule-action-buttons { display: flex; gap: 8px; margin-top: 12px; }
    .schedule-action-buttons .btn { flex: 1; padding: 10px; font-size: 14px; }

    /* Notion Ïä§ÌÉÄÏùº Í∏∞Î°ù ÌÖåÏù¥Î∏î */
    .record-table-container { margin-top: 16px; }
    .record-table-wrapper { display: flex; align-items: stretch; }
    .record-table { 
      flex: 1;
      border-collapse: collapse; 
      background: white; 
      border-radius: 12px; 
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .record-table th, .record-table td { 
      border: 1px solid var(--divider); 
      padding: 12px 8px; 
      text-align: center;
      min-width: 60px;
    }
    .record-table th { 
      background: var(--bg); 
      font-weight: 600; 
      font-size: 13px;
      color: var(--text-secondary);
    }
    .record-table th.discipline-col {
      min-width: 70px;
      background: var(--bg);
    }
    .record-table td.discipline-cell {
      background: var(--bg);
      font-weight: 600;
      color: var(--text);
      position: relative;
    }
    .record-table td.discipline-cell .remove-row-btn {
      position: absolute;
      left: 4px;
      top: 50%;
      transform: translateY(-50%);
      width: 18px;
      height: 18px;
      border: none;
      background: transparent;
      color: var(--text-tertiary);
      cursor: pointer;
      font-size: 10px;
      opacity: 0;
      transition: opacity 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
    }
    .record-table tr:hover td.discipline-cell .remove-row-btn { opacity: 1; }
    .record-table td.discipline-cell .remove-row-btn:hover { background: #FFEBEE; color: var(--error); }
    .record-table input.record-input {
      width: 100%;
      border: none;
      background: transparent;
      text-align: center;
      font-size: 15px;
      padding: 4px;
      outline: none;
    }
    .record-table input.record-input:focus {
      background: rgba(49, 130, 246, 0.05);
      border-radius: 4px;
    }
    .record-table input.record-input::placeholder {
      color: var(--text-tertiary);
      font-size: 13px;
    }
    .record-table th .remove-col-btn {
      display: inline-block;
      margin-left: 4px;
      width: 16px;
      height: 16px;
      border: none;
      background: transparent;
      color: var(--text-tertiary);
      cursor: pointer;
      font-size: 9px;
      opacity: 0;
      transition: opacity 0.15s;
      vertical-align: middle;
      border-radius: 4px;
    }
    .record-table th:hover .remove-col-btn { opacity: 1; }
    .record-table th .remove-col-btn:hover { background: #FFEBEE; color: var(--error); }
    
    /* Ï∂îÍ∞Ä Î≤ÑÌäºÎì§ */
    .add-col-btn {
      width: 36px;
      min-width: 36px;
      background: var(--bg);
      border: 1px dashed var(--divider);
      border-left: none;
      border-radius: 0 12px 12px 0;
      cursor: pointer;
      color: var(--text-tertiary);
      font-size: 14px;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .add-col-btn:hover { background: rgba(49, 130, 246, 0.05); color: var(--primary); }
    .add-row-btn {
      width: 100%;
      padding: 12px;
      margin-top: 8px;
      background: var(--bg);
      border: 1px dashed var(--divider);
      border-radius: 8px;
      cursor: pointer;
      color: var(--text-tertiary);
      font-size: 14px;
      transition: all 0.15s;
    }
    .add-row-btn:hover { background: rgba(49, 130, 246, 0.05); color: var(--primary); }

    /* ÏùºÍ¥Ñ Ï∂îÍ∞Ä - ÎÇ†Ïßú ÏûÖÎ†• Ìñâ */
    .bulk-date-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      align-items: center;
    }
    .bulk-date-row .date-input-wrapper {
      flex: 1;
      position: relative;
    }
    .bulk-date-row .date-display {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 15px;
      background: var(--surface);
      text-align: center;
      font-family: 'SF Mono', Monaco, monospace;
      letter-spacing: 1px;
    }
    .bulk-date-row .date-display:focus {
      outline: none;
      border-color: var(--primary);
    }
    .bulk-date-row .date-display::placeholder {
      color: var(--text-tertiary);
      letter-spacing: 0;
    }
    .bulk-date-row .location-input {
      flex: 1.2;
      padding: 12px 14px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 15px;
      background: var(--surface);
    }
    .bulk-date-row .location-input:focus {
      outline: none;
      border-color: var(--primary);
    }
    .bulk-date-row .remove-btn {
      width: 36px;
      height: 36px;
      border: none;
      background: transparent;
      color: var(--text-tertiary);
      cursor: pointer;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .bulk-date-row .remove-btn:hover {
      background: #FFEBEE;
      color: var(--error);
    }

    /* ÏùºÍ¥Ñ Ï∂îÍ∞Ä - ÎÇ†Ïßú ÌÉ≠ */
    .bulk-date-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      overflow-x: auto;
      padding-bottom: 4px;
    }
    .bulk-date-tab {
      padding: 10px 14px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.15s;
    }
    .bulk-date-tab.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    .bulk-date-tab.saved {
      background: #E8F5E9;
      border-color: var(--success);
      color: var(--success);
    }
    .bulk-date-tab.saved.active {
      background: var(--success);
      color: white;
    }

    /* ÎÇ†Ïßú Ï∂îÍ∞Ä Î≤ÑÌäº */
    .btn-add-date {
      padding: 8px 12px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: all 0.15s;
    }
    .btn-add-date:hover { background: #2563EB; }

    /* Ï∫òÎ¶∞Îçî Ïä§ÌÉÄÏùº */
    .calendar-container {
      background: var(--surface);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .calendar-nav {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .calendar-nav-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: var(--bg);
      border-radius: 8px;
      cursor: pointer;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .calendar-nav-btn:hover {
      background: var(--divider);
      color: var(--text-primary);
    }
    .calendar-month {
      font-size: 16px;
      font-weight: 600;
    }
    .calendar-weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      text-align: center;
      margin-bottom: 8px;
    }
    .calendar-weekday {
      font-size: 12px;
      color: var(--text-tertiary);
      font-weight: 500;
      padding: 8px 0;
    }
    .calendar-weekday:first-child {
      color: #F44336;
    }
    .calendar-weekday:last-child {
      color: #3182F6;
    }

    /* ÏÑ†ÌÉùÎêú ÎÇ†Ïßú ÏùºÏ†ï Ïπ¥Îìú */
    .selected-date-header {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .selected-date-header i {
      color: var(--primary);
    }
    .schedule-detail-card {
      background: var(--surface);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 12px;
    }
    .schedule-detail-card .schedule-date-time {
      font-weight: 600;
      font-size: 15px;
      margin-bottom: 4px;
    }
    .schedule-detail-card .schedule-location,
    .schedule-detail-card .schedule-instructor {
      color: var(--text-secondary);
      font-size: 14px;
      margin-bottom: 4px;
    }
    .my-schedule-badge {
      display: inline-block;
      padding: 4px 10px;
      background: var(--primary-light);
      color: var(--primary);
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 8px;
    }
    /* Î©îÎ™® ÏÑπÏÖò Ïä§ÌÉÄÏùº */
    .memo-section {
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid var(--divider);
    }
    .memo-section-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .memo-section-title i {
      color: var(--primary);
    }
    .memo-card {
      background: var(--bg);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 10px;
    }
    .memo-card-header {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .memo-card-header.instructor {
      color: var(--primary);
    }
    .memo-card-header.student {
      color: var(--success);
    }
    .memo-card-content {
      font-size: 14px;
      color: var(--text-primary);
      line-height: 1.5;
    }
    .memo-card-empty {
      font-size: 13px;
      color: var(--text-tertiary);
      font-style: italic;
    }
    .memo-textarea {
      width: 100%;
      min-height: 80px;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 14px;
      font-family: inherit;
      resize: vertical;
      background: var(--surface);
    }
    .memo-textarea:focus {
      outline: none;
      border-color: var(--primary);
    }
    .memo-textarea::placeholder {
      color: var(--text-tertiary);
    }
    /* Î°úÎî© Ïù∏ÎîîÏºÄÏù¥ÌÑ∞ */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 40px;
    }
    .loading-spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--divider);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Ìä∏Î†àÏù¥Îãù ÌÉ≠ Ïä§ÌÉÄÏùº */
    .training-tab {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--surface);
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: all 0.2s;
    }
    .training-tab.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    .training-tab i {
      font-size: 16px;
    }
    
    /* Ïù¥ÎØ∏ÏßÄ Ìä∏Î†àÏù¥Îãù Ïπ¥ÌÖåÍ≥†Î¶¨ Ïπ¥Îìú */
    .image-category-card {
      background: var(--surface);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 16px;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    .image-category-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    .image-category-card:active {
      transform: scale(0.98);
    }
    .category-icon {
      width: 56px;
      height: 56px;
      border-radius: 16px;
      background: var(--primary-light);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
    }
    .category-info {
      flex: 1;
    }
    .category-name {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .category-desc {
      font-size: 13px;
      color: var(--text-secondary);
    }
    .category-arrow {
      color: var(--text-tertiary);
      font-size: 18px;
    }
    
    /* Ïù¥ÎØ∏ÏßÄ Ìä∏Î†àÏù¥Îãù Ïä§ÌÖù Ïπ¥Îìú */
    .training-step-card {
      background: var(--surface);
      border-radius: 16px;
      margin-bottom: 16px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    .step-image-container {
      width: 100%;
      aspect-ratio: 16/10;
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .step-image-container img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .step-image-placeholder {
      color: var(--text-tertiary);
      font-size: 48px;
    }
    .step-content {
      padding: 16px;
    }
    .step-number {
      display: inline-block;
      width: 28px;
      height: 28px;
      background: var(--primary);
      color: white;
      border-radius: 50%;
      text-align: center;
      line-height: 28px;
      font-size: 14px;
      font-weight: 600;
      margin-right: 10px;
    }
    .step-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
    }
    .step-title-text {
      flex: 1;
    }
    .step-description {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.6;
      margin-bottom: 12px;
    }
    .step-tips {
      background: var(--primary-light);
      border-radius: 10px;
      padding: 12px;
      font-size: 13px;
      color: var(--primary);
    }
    .step-tips i {
      margin-right: 6px;
    }
  </style>
</head>
<body>
  <div class="app" id="app">
    <!-- Î°úÍ∑∏Ïù∏ ÌôîÎ©¥ -->
    <div class="screen active" id="screen-login">
      <div class="login-screen">
        <div class="login-logo">
          <i class="fas fa-water"></i>
          <h1>DiveLog</h1>
          <p>ÌîÑÎ¶¨Îã§Ïù¥Îπô Í∏∞Î°ùÏùÑ ÌïúÎààÏóê</p>
        </div>
        <div class="login-form">
          <div class="input-group">
            <label class="input-label">Ïó∞ÎùΩÏ≤ò</label>
            <div class="phone-input-wrapper">
              <span class="phone-prefix">010-</span>
              <input type="tel" class="input phone-input" id="login-phone" placeholder="0000-0000" maxlength="9">
            </div>
          </div>
          <div class="input-group" style="margin-top: 12px;">
            <label class="input-label">ÏïÑÏù¥Îîî</label>
            <input type="text" class="input" id="login-userid" placeholder="ÏïÑÏù¥Îîî ÏûÖÎ†•">
          </div>
          <button class="btn btn-primary" onclick="handleLogin()">ÏãúÏûëÌïòÍ∏∞</button>
        </div>
      </div>
    </div>

    <!-- Í∞ïÏÇ¨ ÎåÄÏãúÎ≥¥Îìú -->
    <div class="screen" id="screen-instructor-home">
      <div class="container">
        <div style="padding: 20px 0;">
          <div class="greeting">ÏïàÎÖïÌïòÏÑ∏Ïöî, <span id="instructor-name">ÏΩîÏπò</span>Îãò üëã</div>
          <div class="greeting-sub">Ïò§ÎäòÎèÑ Ï¢ãÏùÄ Í∞ïÏäµ ÎêòÏÑ∏Ïöî</div>
        </div>
        <div class="section-title"><i class="fas fa-calendar-day"></i> Ïò§ÎäòÏùò ÏùºÏ†ï</div>
        <div id="today-schedules"></div>
        <div class="section-title" style="margin-top: 24px;"><i class="fas fa-bolt"></i> Îπ†Î•∏ Ïã§Ìñâ</div>
        <div class="quick-actions">
          <button class="quick-btn" onclick="openScheduleForm()"><i class="fas fa-calendar-plus"></i><span>ÏùºÏ†ï Îì±Î°ù</span></button>
          <button class="quick-btn" onclick="showScreen('screen-dry-manage')"><i class="fas fa-dumbbell"></i><span>Ìä∏Î†àÏù¥Îãù<br>Í¥ÄÎ¶¨</span></button>
          <button class="quick-btn" onclick="quickRecordInput()"><i class="fas fa-pen"></i><span>ÏµúÍ∑º Í∞ïÏäµ<br>Í∏∞Î°ù ÏûÖÎ†•</span></button>
        </div>
        <div class="card" style="margin-top: 24px;">
          <div class="section-title"><i class="fas fa-chart-bar"></i> Ïù¥Î≤à Ï£º ÏöîÏïΩ</div>
          <div id="instructor-stats" style="color: var(--text-secondary);"></div>
        </div>
      </div>
      <div class="tab-bar">
        <button class="tab-item active" onclick="showScreen('screen-instructor-home')"><i class="fas fa-home"></i><span>Ìôà</span></button>
        <button class="tab-item" onclick="showScreen('screen-schedule-manage')"><i class="fas fa-calendar"></i><span>ÏùºÏ†ï</span></button>
        <button class="tab-item" onclick="showScreen('screen-dry-manage')"><i class="fas fa-dumbbell"></i><span>Ìä∏Î†àÏù¥Îãù</span></button>
        <button class="tab-item" onclick="showScreen('screen-my-records')"><i class="fas fa-chart-line"></i><span>ÎÇ¥Í∏∞Î°ù</span></button>
        <button class="tab-item" onclick="showScreen('screen-mypage')"><i class="fas fa-user"></i><span>ÎßàÏù¥</span></button>
      </div>
    </div>

    <!-- Í∞ïÏäµÏÉù ÎåÄÏãúÎ≥¥Îìú -->
    <div class="screen" id="screen-student-home">
      <div class="container">
        <div style="padding: 20px 0;">
          <div class="greeting">ÏïàÎÖïÌïòÏÑ∏Ïöî, <span id="student-name">Í∞ïÏäµÏÉù</span>Îãò üèä‚Äç‚ôÇÔ∏è</div>
          <div class="greeting-sub">Íæ∏Ï§ÄÌûà ÏÑ±Ïû•ÌïòÍ≥† ÏûàÏñ¥Ïöî!</div>
        </div>

        <!-- Î†àÎ≤®Î≥Ñ ÏßÑÎèÑ Ï∞®Ìä∏ ÏÑπÏÖò -->
        <div id="level-progress-section" style="display: none;">
          <div class="section-title" id="level-progress-title"><i class="fas fa-graduation-cap"></i> Level ÏßÑÎèÑ</div>
          <div id="level-progress-summary" style="color: var(--text-secondary); font-size: 14px; margin: -8px 0 16px; padding-left: 24px;"></div>
          <div class="lv-charts">
            <div class="lv-chart-card">
              <div class="chart-header" onclick="toggleChecklist('skills')">
                Ïä§ÌÇ¨ Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏
                <i class="fas fa-chevron-down toggle-icon" id="skills-toggle-icon"></i>
              </div>
              <div class="donut-container">
                <canvas id="skills-chart"></canvas>
                <div class="donut-center">
                  <div class="donut-value" id="skills-progress-value">0/0</div>
                  <div class="donut-label">ÏôÑÎ£å</div>
                </div>
              </div>
              <div class="checklist" id="skills-checklist"></div>
            </div>
            
            <div class="lv-chart-card">
              <div class="chart-header" onclick="toggleChecklist('records')">
                Í∏∞Î°ù Îã¨ÏÑ±
                <i class="fas fa-chevron-down toggle-icon" id="records-toggle-icon"></i>
              </div>
              <div class="donut-container">
                <canvas id="records-chart"></canvas>
                <div class="donut-center">
                  <div class="donut-value" id="records-progress-value">0/0</div>
                  <div class="donut-label">Îã¨ÏÑ±</div>
                </div>
              </div>
              <div class="checklist" id="records-checklist"></div>
            </div>
          </div>
        </div>

        <div class="section-title"><i class="fas fa-trophy"></i> Ï¢ÖÎ™©Î≥Ñ ÏµúÍ≥† Í∏∞Î°ù</div>
        <div class="stat-grid" id="best-records"></div>
        
        <div class="section-title"><i class="fas fa-calendar"></i> Îã§Í∞ÄÏò§Îäî ÏùºÏ†ï</div>
        <div id="upcoming-schedules"></div>
        
        <!-- ÎìúÎùºÏù¥ Ìä∏Î†àÏù¥Îãù ÏÑπÏÖò -->
        <div class="section-title" style="margin-top: 24px;"><i class="fas fa-lungs"></i> ÎìúÎùºÏù¥ Ìä∏Î†àÏù¥Îãù</div>
        <div id="home-dry-training"></div>
      </div>
      <div class="tab-bar">
        <button class="tab-item active" onclick="showScreen('screen-student-home')"><i class="fas fa-home"></i><span>Ìôà</span></button>
        <button class="tab-item" onclick="showScreen('screen-student-schedule')"><i class="fas fa-calendar"></i><span>ÏùºÏ†ï</span></button>
        <button class="tab-item" onclick="showScreen('screen-dry-training')"><i class="fas fa-dumbbell"></i><span>Ìä∏Î†àÏù¥Îãù</span></button>
        <button class="tab-item" onclick="showScreen('screen-my-records')"><i class="fas fa-chart-line"></i><span>ÎÇ¥Í∏∞Î°ù</span></button>
        <button class="tab-item" onclick="showScreen('screen-mypage')"><i class="fas fa-user"></i><span>ÎßàÏù¥</span></button>
      </div>
    </div>

    <!-- ÏùºÏ†ï Í¥ÄÎ¶¨ (Í∞ïÏÇ¨) -->
    <div class="screen" id="screen-schedule-manage">
      <div class="header">
        <button class="header-back" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">ÏùºÏ†ï Í¥ÄÎ¶¨</span>
        <div style="display: flex; align-items: center; gap: 12px;">
          <div class="mode-switch-container">
            <button class="mode-switch-btn active" id="schedule-calendar-btn" onclick="setScheduleViewMode('calendar')">
              <i class="fas fa-calendar-alt"></i>
            </button>
            <button class="mode-switch-btn" id="schedule-list-btn" onclick="setScheduleViewMode('list')">
              <i class="fas fa-list"></i>
            </button>
          </div>
          <button class="header-action" onclick="openScheduleForm()">Ï∂îÍ∞Ä</button>
        </div>
      </div>
      <div class="container">
        <!-- Î¶¨Ïä§Ìä∏ Î™®Îìú -->
        <div id="schedule-list-mode" style="display: none;">
          <div id="schedule-list">
            <div class="loading"><div class="loading-spinner"></div></div>
          </div>
        </div>
        
        <!-- Ï∫òÎ¶∞Îçî Î™®Îìú -->
        <div id="schedule-calendar-mode">
          <!-- Ï∫òÎ¶∞Îçî Ìó§Îçî -->
          <div class="calendar-header">
            <button class="calendar-nav" onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
            <span class="calendar-title" id="calendar-title">2025ÎÖÑ 12Ïõî</span>
            <button class="calendar-nav" onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
          </div>
          
          <!-- Ï∫òÎ¶∞Îçî Í∑∏Î¶¨Îìú -->
          <div class="calendar-grid">
            <div class="calendar-weekdays">
              <span class="weekday sun">Ïùº</span>
              <span class="weekday">Ïõî</span>
              <span class="weekday">Ìôî</span>
              <span class="weekday">Ïàò</span>
              <span class="weekday">Î™©</span>
              <span class="weekday">Í∏à</span>
              <span class="weekday sat">ÌÜ†</span>
            </div>
            <div class="calendar-days" id="calendar-days"></div>
          </div>
          
          <!-- Î≤îÎ°Ä -->
          <div class="calendar-legend">
            <span><span style="display: inline-block; width: 10px; height: 10px; background: #BFDBFE; border-radius: 50%; vertical-align: middle;"></span> Í∞ïÏäµ</span>
            <span><span style="display: inline-block; width: 10px; height: 10px; background: #BBF7D0; border-radius: 50%; vertical-align: middle;"></span> Í∞úÏù∏</span>
            <span><span style="display: inline-block; width: 10px; height: 10px; background: #FED7AA; border-radius: 50%; vertical-align: middle;"></span> ÎìúÎùºÏù¥</span>
          </div>
          
          <!-- ÏÑ†ÌÉùÎêú ÎÇ†Ïßú ÏùºÏ†ï -->
          <div class="selected-date-header" id="selected-date-header">
            <i class="fas fa-calendar"></i> <span id="selected-date-text">12Ïõî 19Ïùº (Î™©)</span>
          </div>
          <div id="calendar-schedule-list"></div>
        </div>
      </div>
      <div class="tab-bar">
        <button class="tab-item" onclick="showScreen('screen-instructor-home')"><i class="fas fa-home"></i><span>Ìôà</span></button>
        <button class="tab-item active"><i class="fas fa-calendar"></i><span>ÏùºÏ†ï</span></button>
        <button class="tab-item" onclick="showScreen('screen-dry-manage')"><i class="fas fa-dumbbell"></i><span>Ìä∏Î†àÏù¥Îãù</span></button>
        <button class="tab-item" onclick="showScreen('screen-my-records')"><i class="fas fa-chart-line"></i><span>ÎÇ¥Í∏∞Î°ù</span></button>
        <button class="tab-item" onclick="showScreen('screen-mypage')"><i class="fas fa-user"></i><span>ÎßàÏù¥</span></button>
      </div>
    </div>

    <!-- Ï∞∏Í∞ÄÏûê Í¥ÄÎ¶¨ -->
    <div class="screen" id="screen-participants">
      <div class="header">
        <button class="header-back" onclick="showScreen('screen-schedule-manage')"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">Ï∞∏Í∞ÄÏûê Í¥ÄÎ¶¨</span>
        <button class="header-action" onclick="openAddParticipant()">Ï∂îÍ∞Ä</button>
      </div>
      <div class="container">
        <div class="card" style="margin-bottom: 20px;">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
            <i class="fas fa-calendar" style="color: var(--primary);"></i>
            <span id="participant-schedule-date" style="font-weight: 600;"></span>
          </div>
          <div style="display: flex; align-items: center; gap: 8px; color: var(--text-secondary);">
            <i class="fas fa-map-marker-alt"></i>
            <span id="participant-schedule-location"></span>
          </div>
        </div>
        <div class="section-title">Í∞ïÏäµ</div>
        <div class="card" id="lesson-participants">
          <div class="loading"><div class="loading-spinner"></div></div>
        </div>
        <div class="section-title" style="margin-top: 20px;">ÌéÄÎã§Ïù¥Îπô</div>
        <div class="card" id="fun-participants">
          <div style="text-align: center; color: var(--text-secondary); padding: 20px;">ÌéÄÎã§Ïù¥Îπô Ï∞∏Í∞ÄÏûêÍ∞Ä ÏóÜÏäµÎãàÎã§</div>
        </div>
      </div>
    </div>

    <!-- Ìä∏Î†àÏù¥Îãù Í¥ÄÎ¶¨ (Í∞ïÏÇ¨) -->
    <div class="screen" id="screen-dry-manage">
      <div class="header">
        <button class="header-back" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">Ìä∏Î†àÏù¥Îãù</span>
        <button class="header-action" id="instructor-training-add-btn" onclick="openDryForm()">Ï∂îÍ∞Ä</button>
      </div>
      <div class="container">
        <!-- ÎìúÎùºÏù¥/Ïù¥ÎØ∏ÏßÄ ÌÉ≠ -->
        <div class="training-tabs" style="display: flex; gap: 8px; margin-bottom: 20px;">
          <button class="training-tab active" data-tab="dry" onclick="switchInstructorTrainingTab('dry')">
            <i class="fas fa-fire"></i> ÎìúÎùºÏù¥
          </button>
          <button class="training-tab" data-tab="image" onclick="switchInstructorTrainingTab('image')">
            <i class="fas fa-images"></i> Ïù¥ÎØ∏ÏßÄ
          </button>
        </div>
        
        <!-- ÎìúÎùºÏù¥ Ìä∏Î†àÏù¥Îãù ÏΩòÌÖêÏ∏† -->
        <div id="instructor-dry-content">
          <div class="section-title"><i class="fas fa-list"></i> Ìä∏Î†àÏù¥Îãù Î™©Î°ù</div>
          <div id="dry-training-list"></div>
        </div>
        
        <!-- Ïù¥ÎØ∏ÏßÄ Ìä∏Î†àÏù¥Îãù ÏΩòÌÖêÏ∏† -->
        <div id="instructor-image-content" style="display: none;">
          <div class="section-title"><i class="fas fa-images"></i> ÎèôÏûë Í∞ÄÏù¥Îìú</div>
          <div id="instructor-image-categories">
            <div class="loading"><div class="loading-spinner"></div></div>
          </div>
        </div>
      </div>
      <div class="tab-bar">
        <button class="tab-item" onclick="showScreen('screen-instructor-home')"><i class="fas fa-home"></i><span>Ìôà</span></button>
        <button class="tab-item" onclick="showScreen('screen-schedule-manage')"><i class="fas fa-calendar"></i><span>ÏùºÏ†ï</span></button>
        <button class="tab-item active"><i class="fas fa-dumbbell"></i><span>Ìä∏Î†àÏù¥Îãù</span></button>
        <button class="tab-item" onclick="showScreen('screen-my-records')"><i class="fas fa-chart-line"></i><span>ÎÇ¥Í∏∞Î°ù</span></button>
        <button class="tab-item" onclick="showScreen('screen-mypage')"><i class="fas fa-user"></i><span>ÎßàÏù¥</span></button>
      </div>
    </div>

    <!-- Í∞ïÏäµÏÉù ÏùºÏ†ï -->
    <div class="screen" id="screen-student-schedule">
      <div class="header">
        <button class="header-back" onclick="showScreen('screen-student-home')"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">ÏùºÏ†ï</span>
        <div class="mode-switch-container">
          <button class="mode-switch-btn active" id="student-calendar-btn" onclick="setStudentScheduleViewMode('calendar')">
            <i class="fas fa-calendar-alt"></i>
          </button>
          <button class="mode-switch-btn" id="student-list-btn" onclick="setStudentScheduleViewMode('list')">
            <i class="fas fa-list"></i>
          </button>
        </div>
      </div>
      <div class="container">
        <!-- Î¶¨Ïä§Ìä∏ Î™®Îìú -->
        <div id="student-schedule-list-mode" style="display: none;">
          <div id="available-schedules">
            <div class="loading"><div class="loading-spinner"></div></div>
          </div>
        </div>
        
        <!-- Ï∫òÎ¶∞Îçî Î™®Îìú -->
        <div id="student-schedule-calendar-mode">
          <!-- Ï∫òÎ¶∞Îçî Ìó§Îçî -->
          <div class="calendar-header">
            <button class="calendar-nav" onclick="changeStudentMonth(-1)"><i class="fas fa-chevron-left"></i></button>
            <span class="calendar-title" id="student-calendar-title">2025ÎÖÑ 12Ïõî</span>
            <button class="calendar-nav" onclick="changeStudentMonth(1)"><i class="fas fa-chevron-right"></i></button>
          </div>
          
          <!-- Ï∫òÎ¶∞Îçî Í∑∏Î¶¨Îìú -->
          <div class="calendar-grid">
            <div class="calendar-weekdays">
              <span class="weekday sun">Ïùº</span>
              <span class="weekday">Ïõî</span>
              <span class="weekday">Ìôî</span>
              <span class="weekday">Ïàò</span>
              <span class="weekday">Î™©</span>
              <span class="weekday">Í∏à</span>
              <span class="weekday sat">ÌÜ†</span>
            </div>
            <div class="calendar-days" id="student-calendar-days"></div>
          </div>
          
          <!-- Î≤îÎ°Ä -->
          <div class="calendar-legend">
            <span><span style="display: inline-block; width: 10px; height: 10px; background: #BFDBFE; border-radius: 50%; vertical-align: middle;"></span> Îã§Ïù¥Îπô</span>
            <span><span style="display: inline-block; width: 10px; height: 10px; background: #FED7AA; border-radius: 50%; vertical-align: middle;"></span> ÎìúÎùºÏù¥</span>
          </div>
          
          <!-- ÏÑ†ÌÉùÎêú ÎÇ†Ïßú ÏùºÏ†ï -->
          <div class="selected-date-header">
            <i class="fas fa-calendar"></i> <span id="student-selected-date-text">12Ïõî 19Ïùº (Î™©)</span>
          </div>
          <div id="student-calendar-schedule-list"></div>
        </div>
      </div>
      <div class="tab-bar">
        <button class="tab-item" onclick="showScreen('screen-student-home')"><i class="fas fa-home"></i><span>Ìôà</span></button>
        <button class="tab-item active"><i class="fas fa-calendar"></i><span>ÏùºÏ†ï</span></button>
        <button class="tab-item" onclick="showScreen('screen-dry-training')"><i class="fas fa-dumbbell"></i><span>Ìä∏Î†àÏù¥Îãù</span></button>
        <button class="tab-item" onclick="showScreen('screen-my-records')"><i class="fas fa-chart-line"></i><span>ÎÇ¥Í∏∞Î°ù</span></button>
        <button class="tab-item" onclick="showScreen('screen-mypage')"><i class="fas fa-user"></i><span>ÎßàÏù¥</span></button>
      </div>
    </div>

    <!-- ÌïôÏÉù ÏùºÏ†ï ÏÉÅÏÑ∏ ÌôîÎ©¥ -->
    <div class="screen" id="screen-schedule-detail">
      <div class="header">
        <button class="header-back" onclick="showScreen('screen-student-schedule')"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">ÏùºÏ†ï ÏÉÅÏÑ∏</span>
      </div>
      <div class="container">
        <!-- ÏùºÏ†ï Ï†ïÎ≥¥ -->
        <div class="card" id="schedule-detail-info"></div>
        
        <!-- Í∏∞Î°ù Î≥¥Í∏∞ (ÏúÑÎ°ú Ïù¥Îèô) -->
        <div class="card" id="schedule-detail-records" style="display: none;">
          <div class="section-title" style="margin-bottom: 12px;"><i class="fas fa-chart-bar"></i> Ïù¥ ÎÇ†Ïùò Í∏∞Î°ù</div>
          <div id="schedule-detail-records-list"></div>
        </div>
        
        <!-- Í∞ïÏÇ¨ ÌîºÎìúÎ∞± (ÏùΩÍ∏∞ Ï†ÑÏö©) -->
        <div class="card" id="schedule-detail-instructor-note" style="display: none;">
          <div class="section-title" style="margin-bottom: 8px;"><i class="fas fa-comment"></i> Í∞ïÏÇ¨ ÌîºÎìúÎ∞±</div>
          <p id="schedule-detail-instructor-note-text" style="color: var(--text-secondary); font-size: 14px; line-height: 1.5;"></p>
        </div>
        
        <!-- ÎÇ¥ ÎäêÎÇÄÏ†ê ÏûÖÎ†• -->
        <div class="card">
          <div class="section-title" style="margin-bottom: 8px;"><i class="fas fa-pen"></i> ÎÇ¥ ÎäêÎÇÄÏ†ê</div>
          <textarea class="input" id="schedule-detail-my-note" rows="3" placeholder="Ïù¥ ÎÇ†Ïùò ÎäêÎÇÄÏ†êÏùÑ Í∏∞Î°ùÌï¥Î≥¥ÏÑ∏Ïöî"></textarea>
          <button class="btn btn-primary" style="width: 100%; margin-top: 12px;" onclick="saveStudentNote()">Ï†ÄÏû•</button>
        </div>
      </div>
      <div class="tab-bar">
        <button class="tab-item" onclick="showScreen('screen-student-home')"><i class="fas fa-home"></i><span>Ìôà</span></button>
        <button class="tab-item active"><i class="fas fa-calendar"></i><span>ÏùºÏ†ï</span></button>
        <button class="tab-item" onclick="showScreen('screen-dry-training')"><i class="fas fa-dumbbell"></i><span>Ìä∏Î†àÏù¥Îãù</span></button>
        <button class="tab-item" onclick="showScreen('screen-my-records')"><i class="fas fa-chart-line"></i><span>ÎÇ¥Í∏∞Î°ù</span></button>
        <button class="tab-item" onclick="showScreen('screen-mypage')"><i class="fas fa-user"></i><span>ÎßàÏù¥</span></button>
      </div>
    </div>

    <!-- Ìä∏Î†àÏù¥Îãù (ÌïôÏÉù) -->
    <div class="screen" id="screen-dry-training">
      <div class="header">
        <button class="header-back" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">Ìä∏Î†àÏù¥Îãù</span>
      </div>
      <div class="container">
        <!-- ÎìúÎùºÏù¥/Ïù¥ÎØ∏ÏßÄ ÌÉ≠ -->
        <div class="training-tabs" style="display: flex; gap: 8px; margin-bottom: 20px;">
          <button class="training-tab active" data-tab="dry" onclick="switchTrainingTab('dry')">
            <i class="fas fa-fire"></i> ÎìúÎùºÏù¥
          </button>
          <button class="training-tab" data-tab="image" onclick="switchTrainingTab('image')">
            <i class="fas fa-images"></i> Ïù¥ÎØ∏ÏßÄ
          </button>
        </div>
        
        <!-- ÎìúÎùºÏù¥ Ìä∏Î†àÏù¥Îãù ÏΩòÌÖêÏ∏† -->
        <div id="dry-training-content">
          <!-- Ï∞∏Ïó¨ Ï§ëÏù∏ Ìä∏Î†àÏù¥Îãù -->
          <div class="section-title"><i class="fas fa-fire"></i> Ï∞∏Ïó¨ Ï§ë</div>
          <div id="my-dry-trainings"></div>
          
          <!-- Ïù¥Î≤à Îã¨ Í∏∞Î°ù Ï∫òÎ¶∞Îçî (Ï∞∏Ïó¨ Ï§ëÏùº ÎïåÎßå ÌëúÏãú) -->
          <div id="dry-training-calendar-section" style="display: none;">
            <div class="section-title" style="margin-top: 20px;"><i class="fas fa-calendar-check"></i> Ïù¥Î≤à Îã¨ Í∏∞Î°ù</div>
            <div class="card">
              <div class="calendar-header">
                <button class="calendar-nav" onclick="changeDryListMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                <span class="calendar-title" id="dry-list-calendar-title">2025ÎÖÑ 12Ïõî</span>
                <button class="calendar-nav" onclick="changeDryListMonth(1)"><i class="fas fa-chevron-right"></i></button>
              </div>
              <div class="calendar-grid">
                <div class="calendar-weekdays">
                  <span class="weekday sun">Ïùº</span>
                  <span class="weekday">Ïõî</span>
                  <span class="weekday">Ìôî</span>
                  <span class="weekday">Ïàò</span>
                  <span class="weekday">Î™©</span>
                  <span class="weekday">Í∏à</span>
                  <span class="weekday sat">ÌÜ†</span>
                </div>
                <div class="calendar-days" id="dry-list-calendar-days"></div>
              </div>
            </div>
          </div>
          
          <!-- Ï†ÑÏ≤¥ Ìä∏Î†àÏù¥Îãù Î™©Î°ù (Ï∞∏Ïó¨ ÏïàÌïú Í≤ÉÎßå) -->
          <div id="other-dry-trainings-section" style="display: none;">
            <div class="section-title" style="margin-top: 24px;"><i class="fas fa-list"></i> Ï∞∏Ïó¨Ï§ëÏù¥ÏßÄ ÏïäÏùÄ Ìä∏Î†àÏù¥Îãù</div>
            <div id="all-dry-trainings"></div>
          </div>
          
          <!-- Ï†ÑÏ≤¥ Ìä∏Î†àÏù¥Îãù Î™©Î°ù (Ï∞∏Ïó¨ ÏïàÌñàÏùÑ Îïå) -->
          <div id="all-dry-trainings-section" style="display: none;">
            <div class="section-title" style="margin-top: 24px;"><i class="fas fa-list"></i> Ï†ÑÏ≤¥ Ìä∏Î†àÏù¥Îãù</div>
            <div id="all-dry-trainings-no-participation"></div>
          </div>
        </div>
        
        <!-- Ïù¥ÎØ∏ÏßÄ Ìä∏Î†àÏù¥Îãù ÏΩòÌÖêÏ∏† -->
        <div id="image-training-content" style="display: none;">
          <div class="section-title"><i class="fas fa-images"></i> ÎèôÏûë Í∞ÄÏù¥Îìú</div>
          <div id="image-training-categories">
            <div class="loading"><div class="loading-spinner"></div></div>
          </div>
        </div>
      </div>
      <div class="tab-bar">
        <button class="tab-item" onclick="showScreen('screen-student-home')"><i class="fas fa-home"></i><span>Ìôà</span></button>
        <button class="tab-item" onclick="showScreen('screen-student-schedule')"><i class="fas fa-calendar"></i><span>ÏùºÏ†ï</span></button>
        <button class="tab-item active"><i class="fas fa-dumbbell"></i><span>Ìä∏Î†àÏù¥Îãù</span></button>
        <button class="tab-item" onclick="showScreen('screen-my-records')"><i class="fas fa-chart-line"></i><span>ÎÇ¥Í∏∞Î°ù</span></button>
        <button class="tab-item" onclick="showScreen('screen-mypage')"><i class="fas fa-user"></i><span>ÎßàÏù¥</span></button>
      </div>
    </div>
    
    <!-- Ïù¥ÎØ∏ÏßÄ Ìä∏Î†àÏù¥Îãù ÏÉÅÏÑ∏ (ÌïôÏÉùÏö©) -->
    <div class="screen" id="screen-image-training-detail">
      <div class="header">
        <button class="header-back" onclick="showScreen('screen-dry-training'); switchTrainingTab('image');"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title" id="image-training-detail-title">ÎèôÏûë Í∞ÄÏù¥Îìú</span>
      </div>
      <div class="container">
        <div id="image-training-steps">
          <div class="loading"><div class="loading-spinner"></div></div>
        </div>
      </div>
    </div>
    
    <!-- Ïù¥ÎØ∏ÏßÄ Ìä∏Î†àÏù¥Îãù ÏÉÅÏÑ∏ (Í∞ïÏÇ¨Ïö©) -->
    <div class="screen" id="screen-instructor-image-detail">
      <div class="header">
        <button class="header-back" onclick="showScreen('screen-dry-manage'); switchInstructorTrainingTab('image');"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title" id="instructor-image-detail-title">ÎèôÏûë Í∞ÄÏù¥Îìú</span>
      </div>
      <div class="container">
        <div id="instructor-image-steps">
          <div class="loading"><div class="loading-spinner"></div></div>
        </div>
      </div>
    </div>

    <!-- ÎìúÎùºÏù¥ Ìä∏Î†àÏù¥Îãù ÏÉÅÏÑ∏ -->

    <!-- ÎÇòÏùò Í∏∞Î°ù -->
    <div class="screen" id="screen-my-records">
      <div class="header">
        <button class="header-back" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">ÎÇòÏùò Í∏∞Î°ù</span>
        <div style="display: flex; gap: 8px;">
          <button class="header-action" style="color: var(--text-secondary);" onclick="openPersonalBulkAdd()">ÏùºÍ¥Ñ</button>
          <button class="header-action" onclick="openPersonalRecordAdd()">Ï∂îÍ∞Ä</button>
        </div>
      </div>
      <div class="container">
        <!-- ÏÑ±Ïû• Í∑∏ÎûòÌîÑ -->
        <div class="card" id="growth-chart-card">
          <div class="section-title" style="margin-bottom: 12px;"><i class="fas fa-chart-line"></i> ÏÑ±Ïû• Í∑∏ÎûòÌîÑ</div>
          <div class="discipline-tabs" id="chart-discipline-tabs">
            <button class="disc-tab active" data-disc="STA" onclick="selectChartDiscipline('STA')">STA</button>
            <button class="disc-tab" data-disc="DYNB" onclick="selectChartDiscipline('DYNB')">DYNB</button>
            <button class="disc-tab" data-disc="FIM" onclick="selectChartDiscipline('FIM')">FIM</button>
            <button class="disc-tab" data-disc="CWTB" onclick="selectChartDiscipline('CWTB')">CWTB</button>
          </div>
          <div style="height: 200px; position: relative;">
            <canvas id="growth-chart"></canvas>
          </div>
        </div>
        
        <div class="section-title" style="margin-top: 20px;"><i class="fas fa-trophy"></i> Ï¢ÖÎ™©Î≥Ñ ÏµúÍ≥† Í∏∞Î°ù</div>
        <div class="card" id="my-best-records">
          <div class="loading"><div class="loading-spinner"></div></div>
        </div>
        <div class="section-title" style="margin-top: 20px;"><i class="fas fa-list"></i> Ï†ÑÏ≤¥ Í∏∞Î°ù</div>
        <div class="card" id="my-all-records">
          <div style="text-align: center; color: var(--text-secondary); padding: 20px;">Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§</div>
        </div>
      </div>
      <div class="tab-bar" id="my-records-tabbar">
        <!-- ÎèôÏ†ÅÏúºÎ°ú Î†åÎçîÎßÅ -->
      </div>
    </div>

    <!-- Bottom Sheet: ÏùºÏ†ï Îì±Î°ù -->
    <div class="bottom-sheet-overlay" id="sheet-schedule">
      <div class="bottom-sheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-content">
          <div class="bottom-sheet-title" id="schedule-form-title">ÏÉà ÏùºÏ†ï Îì±Î°ù</div>
          <input type="hidden" id="edit-schedule-id">
          <div class="input-group">
            <label class="input-label">ÎÇ†Ïßú</label>
            <input type="date" class="input" id="schedule-date">
          </div>
          <div class="input-group">
            <label class="input-label">ÏãúÍ∞Ñ</label>
            <input type="time" class="input" id="schedule-time">
          </div>
          <div class="input-group">
            <label class="input-label">Ïû•ÏÜå</label>
            <input type="text" class="input" id="schedule-location" placeholder="Ïû•ÏÜåÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
          </div>
          
          <!-- Í∏∞Î°ù Ï¢ÖÎ™© ÏÑ†ÌÉù (ÌÜ†Í∏Ä) -->
          <div class="input-group">
            <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleScheduleSection('disc')">
              <label class="input-label" style="margin-bottom: 0;">Í∏∞Î°ù Ï¢ÖÎ™©</label>
              <span style="color: var(--text-tertiary); font-size: 13px;" id="schedule-disc-toggle">ÏÑ†ÌÉù</span>
            </div>
            <div id="schedule-disc-section" style="display: none; margin-top: 8px;">
              <div style="display: flex; flex-wrap: wrap; gap: 4px;" id="schedule-disc-checks">
                <label style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;"><input type="checkbox" value="STA" checked> STA</label>
                <label style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;"><input type="checkbox" value="DYNB" checked> DYNB</label>
                <label style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;"><input type="checkbox" value="FIM" checked> FIM</label>
                <label style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;"><input type="checkbox" value="CWTB" checked> CWTB</label>
                <label style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;"><input type="checkbox" value="DNF"> DNF</label>
                <label style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;"><input type="checkbox" value="CNF"> CNF</label>
                <label style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;"><input type="checkbox" value="DYN"> DYN</label>
                <label style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;"><input type="checkbox" value="CWT"> CWT</label>
              </div>
            </div>
          </div>
          
          <!-- Ïä§ÌÇ¨ Ï¢ÖÎ™© ÏÑ†ÌÉù (ÌÜ†Í∏Ä) -->
          <div class="input-group">
            <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleScheduleSection('skill')">
              <label class="input-label" style="margin-bottom: 0;">Ïä§ÌÇ¨ Ï¢ÖÎ™©</label>
              <span style="color: var(--text-tertiary); font-size: 13px;" id="schedule-skill-toggle">ÏÑ†ÌÉù</span>
            </div>
            <div id="schedule-skill-section" style="display: none; margin-top: 8px;">
              <div style="font-size: 12px; color: var(--text-tertiary); margin-bottom: 6px;">Lv2</div>
              <div style="display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 12px;">
                <label style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;"><input type="checkbox" value="Î†àÏä§ÌÅê 5-10m"> Î†àÏä§ÌÅê 5-10m</label>
                <label style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;"><input type="checkbox" value="Ïù¥Î°† ÌèâÍ∞Ä"> Ïù¥Î°† ÌèâÍ∞Ä</label>
              </div>
              <div style="font-size: 12px; color: var(--text-tertiary); margin-bottom: 6px;">Lv3</div>
              <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                <label style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;"><input type="checkbox" value="Î†åÏïºÎìú Ï†úÍ±∞"> Î†åÏïºÎìú Ï†úÍ±∞</label>
                <label style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;"><input type="checkbox" value="ÎÖ∏ÎßàÏä§ÌÅ¨ 10m"> ÎÖ∏ÎßàÏä§ÌÅ¨ 10m</label>
                <label style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;"><input type="checkbox" value="Î†àÏä§ÌÅê+ÌÜ†Ïûâ"> Î†àÏä§ÌÅê+ÌÜ†Ïûâ</label>
                <label style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;"><input type="checkbox" value="Ï§ëÏÑ±Î∂ÄÎ†•"> Ï§ëÏÑ±Î∂ÄÎ†•</label>
                <label style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;"><input type="checkbox" value="ÌîÑÎ¶¨Ìè¥"> ÌîÑÎ¶¨Ìè¥</label>
                <label style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;"><input type="checkbox" value="ÏïîÏä§Ïò®Î¶¨ 15m"> ÏïîÏä§Ïò®Î¶¨ 15m</label>
                <label style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;"><input type="checkbox" value="Î≤ÑÎîî 10-15m"> Î≤ÑÎîî 10-15m</label>
                <label style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;"><input type="checkbox" value="Ïù¥Î°† ÌèâÍ∞Ä_lv3"> Ïù¥Î°† ÌèâÍ∞Ä</label>
              </div>
            </div>
          </div>
          
          <button class="btn btn-primary" onclick="saveSchedule()">Ï†ÄÏû•ÌïòÍ∏∞</button>
          <button class="btn btn-secondary" style="margin-top: 8px;" onclick="closeBottomSheet('sheet-schedule')">Ï∑®ÏÜå</button>
        </div>
      </div>
    </div>

    <!-- Bottom Sheet: Ï∞∏Í∞ÄÏûê Ï∂îÍ∞Ä -->
    <div class="bottom-sheet-overlay" id="sheet-add-participant">
      <div class="bottom-sheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-content">
          <div class="bottom-sheet-title">Ï∞∏Í∞ÄÏûê Ï∂îÍ∞Ä</div>
          
          <!-- ÌöåÏõê/ÎπÑÌöåÏõê ÌÉ≠ -->
          <div class="participant-type-tabs" style="display: flex; gap: 8px; margin-bottom: 16px;">
            <button class="participant-type-tab active" data-type="member" onclick="selectParticipantType('member')" style="flex: 1; padding: 10px; border: 1px solid var(--border); border-radius: 8px; background: var(--primary); color: white; font-weight: 600; cursor: pointer;">ÌöåÏõê</button>
            <button class="participant-type-tab" data-type="guest" onclick="selectParticipantType('guest')" style="flex: 1; padding: 10px; border: 1px solid var(--border); border-radius: 8px; background: var(--surface); color: var(--text-primary); font-weight: 600; cursor: pointer;">ÎπÑÌöåÏõê</button>
          </div>
          
          <!-- ÌöåÏõê ÏÑ†ÌÉù -->
          <div class="input-group" id="member-select-group">
            <label class="input-label">ÌöåÏõê ÏÑ†ÌÉù</label>
            <select class="input" id="participant-student"></select>
          </div>
          
          <!-- ÎπÑÌöåÏõê ÏÑ†ÌÉù -->
          <div class="input-group" id="guest-select-group" style="display: none;">
            <label class="input-label">ÎπÑÌöåÏõê ÏÑ†ÌÉù</label>
            <select class="input" id="participant-guest"></select>
          </div>
          
          <div class="input-group">
            <label class="input-label">Ï∞∏Í∞Ä Î™©Ï†Å</label>
            <div class="purpose-buttons">
              <button class="purpose-btn selected" data-purpose="Í∞ïÏäµ" onclick="selectPurpose(this)">Í∞ïÏäµ</button>
              <button class="purpose-btn" data-purpose="ÌéÄÎã§Ïù¥Îπô" onclick="selectPurpose(this)">ÌéÄÎã§Ïù¥Îπô</button>
            </div>
          </div>
          <div class="input-group" id="lesson-level-group">
            <label class="input-label">Í∞ïÏäµ Î†àÎ≤®</label>
            <select class="input" id="participant-level">
              <option value="1">Level 1</option>
              <option value="2" selected>Level 2</option>
              <option value="3">Level 3</option>
              <option value="4">Level 4</option>
            </select>
          </div>
          <button class="btn btn-primary" onclick="addParticipant()">Ï∂îÍ∞ÄÌïòÍ∏∞</button>
        </div>
      </div>
    </div>

    <!-- ÏùºÏ†ï Í¥ÄÎ¶¨ (Í∞ïÏÇ¨Ïö©) -->
    <div class="screen" id="screen-schedule-manage">
      <div class="header">
        <button class="header-back" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">ÏùºÏ†ï Í¥ÄÎ¶¨</span>
        <button class="header-action" onclick="openScheduleForm()">Ï∂îÍ∞Ä</button>
      </div>
      <div class="container">
        <div id="schedule-list">
          <div class="loading"><div class="loading-spinner"></div></div>
        </div>
      </div>
      <div class="tab-bar">
        <button class="tab-item" onclick="showScreen('screen-instructor-home')"><i class="fas fa-home"></i><span>Ìôà</span></button>
        <button class="tab-item active"><i class="fas fa-calendar"></i><span>ÏùºÏ†ï</span></button>
        <button class="tab-item" onclick="showScreen('screen-my-records')"><i class="fas fa-chart-line"></i><span>ÎÇ¥Í∏∞Î°ù</span></button>
        <button class="tab-item" onclick="showScreen('screen-mypage')"><i class="fas fa-user"></i><span>ÎßàÏù¥</span></button>
      </div>
    </div>

    <!-- Ï∞∏Í∞ÄÏûê Í¥ÄÎ¶¨ -->
    <div class="screen" id="screen-participants">
      <div class="header">
        <button class="header-back" onclick="showScreen('screen-schedule-manage')"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">Ï∞∏Í∞ÄÏûê Í¥ÄÎ¶¨</span>
        <button class="header-action" onclick="openAddParticipant()">Ï∂îÍ∞Ä</button>
      </div>
      <div class="container">
        <div class="card" style="margin-bottom: 20px;">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
            <i class="fas fa-calendar" style="color: var(--primary);"></i>
            <span id="participant-schedule-date" style="font-weight: 600;"></span>
          </div>
          <div style="display: flex; align-items: center; gap: 8px; color: var(--text-secondary);">
            <i class="fas fa-map-marker-alt"></i>
            <span id="participant-schedule-location"></span>
          </div>
        </div>
        <button class="btn btn-primary" style="margin-bottom: 20px;" onclick="openBatchRecordInput()">
          <i class="fas fa-pen"></i> ÏùºÍ¥Ñ Í∏∞Î°ù ÏûÖÎ†•
        </button>
        <div class="section-title">Í∞ïÏäµ</div>
        <div class="card" id="lesson-participants"></div>
        <div class="section-title" style="margin-top: 20px;">ÌéÄÎã§Ïù¥Îπô</div>
        <div class="card" id="fun-participants"></div>
      </div>
    </div>

    <!-- Í∞ïÏäµÏÉù ÏùºÏ†ï ÌôîÎ©¥ -->
    <div class="screen" id="screen-student-schedule">
      <div class="header">
        <button class="header-back" onclick="showScreen('screen-student-home')"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">ÏùºÏ†ï</span>
      </div>
      <div class="container">
        <div id="student-schedule-list">
          <div class="loading"><div class="loading-spinner"></div></div>
        </div>
      </div>
      <div class="tab-bar">
        <button class="tab-item" onclick="showScreen('screen-student-home')"><i class="fas fa-home"></i><span>Ìôà</span></button>
        <button class="tab-item active"><i class="fas fa-calendar"></i><span>ÏùºÏ†ï</span></button>
        <button class="tab-item" onclick="showScreen('screen-my-records')"><i class="fas fa-chart-line"></i><span>ÎÇ¥Í∏∞Î°ù</span></button>
        <button class="tab-item" onclick="showScreen('screen-mypage')"><i class="fas fa-user"></i><span>ÎßàÏù¥</span></button>
      </div>
    </div>

    <!-- ÏùºÍ¥Ñ Í∏∞Î°ù ÏûÖÎ†• ÌôîÎ©¥ (Í∞ïÏäµ) -->
    <div class="screen" id="screen-batch-record">
      <div class="header">
        <button class="header-back" onclick="closeBatchRecord()"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">Í∏∞Î°ù ÏùºÍ¥Ñ ÏûÖÎ†•</span>
      </div>
      <div class="container">
        <!-- ÏùºÏ†ï Ï†ïÎ≥¥ (Í∞ÑÏÜåÌôî) -->
        <div class="card" style="margin-bottom: 16px;">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
            <i class="fas fa-calendar" style="color: var(--primary);"></i>
            <span id="batch-schedule-date" style="font-weight: 600;"></span>
          </div>
          <div style="display: flex; align-items: center; gap: 8px; color: var(--text-secondary);">
            <i class="fas fa-map-marker-alt"></i>
            <span id="batch-schedule-location"></span>
          </div>
        </div>
        
        <!-- Í∏∞Î°ù ÏûÖÎ†• Ïπ¥Îìú -->
        <div class="card" id="batch-record-table-card">
          <!-- Í∏∞Î°ù Ìó§Îçî + Ï¢ÖÎ™© ÏàòÏ†ï -->
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <div class="section-title" style="margin: 0;"><i class="fas fa-clipboard-list"></i> Í∏∞Î°ù</div>
            <button style="padding: 4px 10px; background: var(--bg); border: 1px dashed var(--border); border-radius: 10px; font-size: 12px; cursor: pointer;" onclick="openBatchAddDisciplineSheet()">Ï¢ÖÎ™© ÏàòÏ†ï</button>
          </div>
          
          <!-- Ï¢ÖÎ™© ÌÉ≠ (compact) -->
          <div id="batch-discipline-tabs" style="margin-bottom: 12px;"></div>
          
          <!-- Í∏∞Î°ù ÌÖåÏù¥Î∏î -->
          <div class="record-table-container">
            <table class="record-table" id="batch-record-table">
              <thead>
                <tr>
                  <th class="col-name">ÌïôÏÉùÎ™Ö</th>
                  <th class="col-attempt">1Ï∞®</th>
                  <th class="col-attempt">2Ï∞®</th>
                  <th class="col-add-attempt"><button class="btn-add-col" onclick="addBatchAttemptColumn()">+</button></th>
                  <th class="col-note">Î©îÎ™®</th>
                </tr>
              </thead>
              <tbody id="batch-record-tbody"></tbody>
            </table>
          </div>
        </div>
        
        <!-- Ïä§ÌÇ¨ Ï≤¥ÌÅ¨ ÌÖåÏù¥Î∏î (Ïà®ÍπÄ - ÏÇ¨Ïö© Ïïà Ìï®) -->
        <div class="card" id="batch-skill-table-card" style="display: none;">
          <div class="record-table-container">
            <table class="record-table" id="batch-skill-table">
              <thead>
                <tr>
                  <th class="col-name">ÌïôÏÉùÎ™Ö</th>
                </tr>
              </thead>
              <tbody id="batch-skill-tbody"></tbody>
            </table>
          </div>
        </div>
        
        <!-- ÎÖ∏Ìä∏ ÏÑπÏÖò -->
        <div class="card" style="margin-top: 16px;">
          <div class="section-title" style="margin-bottom: 12px;"><i class="fas fa-comment-alt"></i> ÎÖ∏Ìä∏</div>
          
          <!-- Ïò§Îäò Ï¥ùÌèâ (schedules.note) -->
          <div style="margin-bottom: 16px;">
            <label class="input-label">Ïò§Îäò Ï¥ùÌèâ</label>
            <input type="text" class="input" id="batch-schedule-note" placeholder="Ïò§Îäò Í∞ïÏäµ Ï†ÑÏ≤¥Ïóê ÎåÄÌïú ÎäêÎÇÄÏ†ê">
          </div>
          
          <!-- ÌïôÏÉùÎ≥Ñ ÌîºÎìúÎ∞± (registrations.note_instructor) -->
          <div>
            <label class="input-label">ÌïôÏÉùÎ≥Ñ ÌîºÎìúÎ∞±</label>
            <div id="batch-student-notes"></div>
          </div>
        </div>
        
        <!-- Ï†ÄÏû• Î≤ÑÌäº -->
        <div style="display: flex; gap: 12px; margin-top: 20px;">
          <button class="btn btn-secondary" style="flex: 1;" onclick="saveBatchRecords(false)">Ï†ÄÏû•ÌïòÍ≥† Í≥ÑÏÜç</button>
          <button class="btn btn-primary" style="flex: 1;" onclick="saveBatchRecords(true)">Ï†ÄÏû•ÌïòÍ≥† ÏôÑÎ£å</button>
        </div>
      </div>
    </div>

    <!-- Í∞úÏù∏ Í∏∞Î°ù Í∞úÎ≥Ñ Ï∂îÍ∞Ä ÌôîÎ©¥ -->
    <div class="screen" id="screen-personal-record">
      <div class="header">
        <button class="header-back" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">Í∞úÏù∏ Í∏∞Î°ù ÏûÖÎ†•</span>
      </div>
      <div class="container">
        <!-- ÎÇ†Ïßú/Ïû•ÏÜå Ï†ïÎ≥¥ -->
        <div class="card" style="margin-bottom: 16px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <div>
              <div style="display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-calendar" style="color: var(--primary);"></i>
                <span id="personal-date-display" style="font-weight: 600;"></span>
              </div>
              <div style="display: flex; align-items: center; gap: 8px; margin-top: 4px; color: var(--text-secondary);">
                <i class="fas fa-map-marker-alt"></i>
                <span id="personal-location-display"></span>
              </div>
            </div>
            <button class="btn btn-outline btn-small" onclick="openPersonalDateEdit()">+ ÎÇ†Ïßú</button>
          </div>
        </div>
        
        <!-- Í∏∞Î°ù ÌÖåÏù¥Î∏î -->
        <div class="card">
          <div class="record-table-container">
            <table class="record-table" id="personal-record-table">
              <thead>
                <tr>
                  <th class="col-name">Ï¢ÖÎ™©</th>
                  <th class="col-attempt">1Ï∞®</th>
                  <th class="col-attempt">2Ï∞®</th>
                </tr>
              </thead>
              <tbody id="personal-record-tbody"></tbody>
            </table>
          </div>
          <div style="display: flex; gap: 8px; margin-top: 12px;">
            <button class="btn btn-outline btn-small" style="flex: 1;" onclick="addPersonalAttemptColumn()">
              <i class="fas fa-plus"></i> ÏãúÎèÑ Ï∂îÍ∞Ä
            </button>
            <button class="btn btn-outline btn-small" style="flex: 1;" onclick="openAddDisciplineSheet()">
              <i class="fas fa-plus"></i> Ï¢ÖÎ™© Ï∂îÍ∞Ä
            </button>
          </div>
        </div>
        
        <!-- Î©îÎ™® -->
        <div class="card" style="margin-top: 16px;">
          <div class="section-title"><i class="fas fa-sticky-note"></i> Î©îÎ™®</div>
          <textarea class="input" id="personal-memo" rows="3" placeholder="Ïù¥ Îã§Ïù¥ÎπôÏóê ÎåÄÌïú Î©îÎ™®Î•º ÎÇ®Í≤®Î≥¥ÏÑ∏Ïöî... (Ïª®ÎîîÏÖò, ÎäêÎÇÄÏ†ê, Í∞úÏÑ†Ìï† Ï†ê Îì±)"></textarea>
        </div>
        
        <!-- Ï†ÄÏû• Î≤ÑÌäº -->
        <div style="display: flex; gap: 12px; margin-top: 20px;">
          <button class="btn btn-secondary" style="flex: 1;" onclick="savePersonalRecord(false)">Ï†ÄÏû•ÌïòÍ≥† Í≥ÑÏÜç</button>
          <button class="btn btn-primary" style="flex: 1;" onclick="savePersonalRecord(true)">Ï†ÄÏû•ÌïòÍ≥† ÏôÑÎ£å</button>
        </div>
      </div>
    </div>

    <!-- Í∞úÏù∏ Í∏∞Î°ù ÏùºÍ¥Ñ Ï∂îÍ∞Ä ÌôîÎ©¥ -->
    <div class="screen" id="screen-personal-bulk">
      <div class="header">
        <button class="header-back" onclick="showScreen('screen-my-records')"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">ÏùºÍ¥Ñ Í∏∞Î°ù Ï∂îÍ∞Ä</span>
      </div>
      <div class="container">
        <!-- ÏïàÎÇ¥ -->
        <div class="card" style="background: var(--primary-light); margin-bottom: 16px;">
          <div style="display: flex; align-items: flex-start; gap: 12px;">
            <i class="fas fa-info-circle" style="color: var(--primary); margin-top: 2px;"></i>
            <div style="font-size: 14px; color: var(--text-secondary);">
              Í≥ºÍ±∞ Îã§Ïù¥Îπô Í∏∞Î°ùÏùÑ ÌïúÎ≤àÏóê ÏûÖÎ†•Ìï† Ïàò ÏûàÏäµÎãàÎã§.<br>
              ÎÇ†ÏßúÎäî <strong>YYMMDD</strong> ÌòïÏãùÏúºÎ°ú ÏûÖÎ†•ÌïòÏÑ∏Ïöî.<br>
              Ïòà: 231112 ‚Üí 2023-11-12
            </div>
          </div>
        </div>
        
        <!-- ÎÇ†Ïßú/Ïû•ÏÜå Î™©Î°ù -->
        <div class="section-title"><i class="fas fa-calendar"></i> ÎÇ†Ïßú/Ïû•ÏÜå Î™©Î°ù</div>
        <div id="bulk-date-list"></div>
        <button class="btn btn-outline" style="margin-top: 8px;" onclick="addBulkDateRow()">
          <i class="fas fa-plus"></i> ÎÇ†Ïßú Ï∂îÍ∞Ä
        </button>
        
        <button class="btn btn-primary" style="margin-top: 20px;" onclick="proceedToBulkRecordInput()">
          Îã§Ïùå: Í∏∞Î°ù ÏûÖÎ†•
        </button>
      </div>
      <div class="tab-bar" id="bulk-tabbar">
        <!-- ÎèôÏ†ÅÏúºÎ°ú Î†åÎçîÎßÅ -->
      </div>
    </div>

    <!-- Í∞úÏù∏ Í∏∞Î°ù ÏùºÍ¥Ñ ÏûÖÎ†• ÌôîÎ©¥ (2Îã®Í≥Ñ) -->
    <div class="screen" id="screen-personal-bulk-input">
      <div class="header">
        <button class="header-back" onclick="showScreen('screen-personal-bulk')"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">ÏùºÍ¥Ñ Í∏∞Î°ù ÏûÖÎ†•</span>
      </div>
      <div class="container">
        <!-- ÎÇ†Ïßú ÌÉ≠ -->
        <div class="participant-tabs" id="bulk-date-tabs"></div>
        
        <!-- Í∏∞Î°ù ÌÖåÏù¥Î∏î -->
        <div class="card">
          <div class="record-table-container">
            <table class="record-table" id="bulk-record-table">
              <thead>
                <tr>
                  <th class="col-name">Ï¢ÖÎ™©</th>
                  <th class="col-attempt">1Ï∞®</th>
                  <th class="col-attempt">2Ï∞®</th>
                  <th class="col-add-attempt"><button class="btn-add-col" onclick="addBulkAttemptColumn()">+</button></th>
                </tr>
              </thead>
              <tbody id="bulk-record-tbody"></tbody>
            </table>
          </div>
          <button class="btn btn-outline" style="margin-top: 12px;" onclick="openBulkAddDisciplineSheet()">
            <i class="fas fa-plus"></i> Ï¢ÖÎ™© Ï∂îÍ∞Ä
          </button>
        </div>
        
        <!-- Ï†ÄÏû• Î≤ÑÌäº -->
        <div style="display: flex; gap: 12px; margin-top: 20px;">
          <button class="btn btn-secondary" style="flex: 1;" onclick="saveBulkRecords(false)">Ï†ÄÏû•ÌïòÍ≥† Í≥ÑÏÜç</button>
          <button class="btn btn-primary" style="flex: 1;" onclick="saveBulkRecords(true)">Ï†ÄÏû•ÌïòÍ≥† ÏôÑÎ£å</button>
        </div>
      </div>
      <div class="tab-bar" id="bulk-input-tabbar">
        <!-- ÎèôÏ†ÅÏúºÎ°ú Î†åÎçîÎßÅ -->
      </div>
    </div>

    <!-- ÎÇ¥ Í∏∞Î°ù ÌôîÎ©¥ -->
    <div class="screen" id="screen-my-records">
      <div class="header">
        <button class="header-back" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">ÎÇòÏùò Í∏∞Î°ù</span>
      </div>
      <div class="container">
        <div class="section-title"><i class="fas fa-trophy"></i> Ï¢ÖÎ™©Î≥Ñ ÏµúÍ≥† Í∏∞Î°ù</div>
        <div class="card" id="my-best-records"></div>
        <div class="section-title" style="margin-top: 20px;"><i class="fas fa-list"></i> Ï†ÑÏ≤¥ Í∏∞Î°ù</div>
        <div class="card" id="my-all-records"></div>
      </div>
      <div class="tab-bar" id="my-records-tabbar"></div>
    </div>

    <!-- ÎßàÏù¥ÌéòÏù¥ÏßÄ -->
    <div class="screen" id="screen-mypage">
      <div class="header">
        <button class="header-back" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">ÎßàÏù¥ÌéòÏù¥ÏßÄ</span>
      </div>
      <div class="container">
        <div class="card" style="display: flex; align-items: center; gap: 16px;">
          <div class="participant-avatar" style="width: 60px; height: 60px; font-size: 24px;" id="mypage-avatar"></div>
          <div style="flex: 1;">
            <div style="font-size: 20px; font-weight: 700;" id="mypage-name"></div>
            <div style="color: var(--text-secondary); margin-top: 4px;" id="mypage-phone"></div>
            <div style="color: var(--text-tertiary); font-size: 14px; margin-top: 2px;" id="mypage-info"></div>
          </div>
        </div>

    <!-- ÏûêÍ≤©Ï¶ù ÏÑπÏÖò Ï∂îÍ∞Ä -->
    <div class="card" style="margin-top: 16px;">
      <div class="section-title" style="margin-bottom: 12px;">
        <i class="fas fa-id-card"></i> ÏûêÍ≤©Ï¶ù
      </div>
      <div id="cert-image-container">
        <!-- ÏûêÍ≤©Ï¶ù Ïù¥ÎØ∏ÏßÄ ÎòêÎäî ÏóÖÎ°úÎìú Î≤ÑÌäº -->
      </div>
    </div>

        <button class="btn btn-danger" style="margin-top: 20px;" onclick="logout()">Î°úÍ∑∏ÏïÑÏõÉ</button>
      </div>
    </div>

    <!-- ÌÜ†Ïä§Ìä∏ -->
    <div class="toast" id="toast"></div>

    <!-- Bottom Sheet: Í∞ïÏäµÏÉù ÏùºÏ†ï Ïã†Ï≤≠ -->
    <div class="bottom-sheet-overlay" id="sheet-register">
      <div class="bottom-sheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-content">
          <div class="bottom-sheet-title">ÏùºÏ†ï Ïã†Ï≤≠</div>
          <div class="input-group">
            <label class="input-label">Ï∞∏Í∞Ä Î™©Ï†Å</label>
            <div class="purpose-buttons">
              <button class="purpose-btn selected" data-purpose="Í∞ïÏäµ" onclick="selectRegisterPurpose(this)">Í∞ïÏäµ</button>
              <button class="purpose-btn" data-purpose="ÌéÄÎã§Ïù¥Îπô" onclick="selectRegisterPurpose(this)">ÌéÄÎã§Ïù¥Îπô</button>
            </div>
          </div>
          <div class="input-group" id="register-level-group">
            <label class="input-label">ÏàòÍ∞ï Î†àÎ≤®</label>
            <select class="input" id="register-level">
              <option value="2">Level 2</option>
              <option value="3">Level 3</option>
              <option value="4">Level 4</option>
            </select>
          </div>
          <button class="btn btn-primary" onclick="registerSchedule()">Ïã†Ï≤≠ÌïòÍ∏∞</button>
        </div>
      </div>
    </div>

    <!-- Bottom Sheet: ÏµúÍ∑º ÏùºÏ†ï ÏÑ†ÌÉù (Í∞ïÏÇ¨Ïö©) -->
    <div class="bottom-sheet-overlay" id="sheet-select-schedule">
      <div class="bottom-sheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-content">
          <div class="bottom-sheet-title">ÏùºÏ†ï ÏÑ†ÌÉù</div>
          <div id="recent-schedule-list" style="max-height: 300px; overflow-y: auto;"></div>
        </div>
      </div>
    </div>

    <!-- Bottom Sheet: Í∞úÏù∏ Í∏∞Î°ù Ï∂îÍ∞Ä (ÎÇ†Ïßú/Ïû•ÏÜå ÏûÖÎ†•) -->
    <div class="bottom-sheet-overlay" id="sheet-personal-add">
      <div class="bottom-sheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-content">
          <div class="bottom-sheet-title">Í∞úÏù∏ Í∏∞Î°ù Ï∂îÍ∞Ä</div>
          <div class="input-group">
            <label class="input-label">ÎÇ†Ïßú *</label>
            <input type="date" class="input" id="personal-add-date">
          </div>
          <div class="input-group">
            <label class="input-label">ÏãúÍ∞Ñ</label>
            <input type="time" class="input" id="personal-add-time">
          </div>
          <div class="input-group">
            <label class="input-label">Ïû•ÏÜå</label>
            <input type="text" class="input" id="personal-add-location" placeholder="Ïû•ÏÜåÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
          </div>
          <div class="input-group">
            <label class="input-label">Ï¢ÖÎ™© ÏÑ†ÌÉù</label>
            <div style="display: flex; flex-wrap: wrap; gap: 8px;" id="personal-discipline-checks">
              <label style="display: flex; align-items: center; gap: 4px;">
                <input type="checkbox" value="STA" checked> STA
              </label>
              <label style="display: flex; align-items: center; gap: 4px;">
                <input type="checkbox" value="DYNB" checked> DYNB
              </label>
              <label style="display: flex; align-items: center; gap: 4px;">
                <input type="checkbox" value="FIM" checked> FIM
              </label>
              <label style="display: flex; align-items: center; gap: 4px;">
                <input type="checkbox" value="CWTB" checked> CWTB
              </label>
              <label style="display: flex; align-items: center; gap: 4px;">
                <input type="checkbox" value="DNF"> DNF
              </label>
              <label style="display: flex; align-items: center; gap: 4px;">
                <input type="checkbox" value="CNF"> CNF
              </label>
              <label style="display: flex; align-items: center; gap: 4px;">
                <input type="checkbox" value="DYN"> DYN
              </label>
              <label style="display: flex; align-items: center; gap: 4px;">
                <input type="checkbox" value="CWT"> CWT
              </label>
            </div>
          </div>
          <button class="btn btn-primary" onclick="startPersonalRecordInput()">Îã§Ïùå: Í∏∞Î°ù ÏûÖÎ†•</button>
          <button class="btn btn-secondary" style="margin-top: 8px;" onclick="closeBottomSheet('sheet-personal-add')">Ï∑®ÏÜå</button>
        </div>
      </div>
    </div>

    <!-- Bottom Sheet: Ï¢ÖÎ™© Ï∂îÍ∞Ä -->
    <div class="bottom-sheet-overlay" id="sheet-add-discipline">
      <div class="bottom-sheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-content">
          <div class="bottom-sheet-title">Ï¢ÖÎ™© Ï∂îÍ∞Ä</div>
          <div style="display: flex; flex-wrap: wrap; gap: 12px;" id="add-discipline-options"></div>
          <button class="btn btn-primary" style="margin-top: 16px;" onclick="confirmAddDiscipline()">Ï∂îÍ∞ÄÌïòÍ∏∞</button>
          <button class="btn btn-secondary" style="margin-top: 8px;" onclick="closeBottomSheet('sheet-add-discipline')">Ï∑®ÏÜå</button>
        </div>
      </div>
    </div>

    <!-- Bottom Sheet: ÏùºÍ¥Ñ Ï¢ÖÎ™© Ï∂îÍ∞Ä -->
    <div class="bottom-sheet-overlay" id="sheet-bulk-add-discipline">
      <div class="bottom-sheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-content">
          <div class="bottom-sheet-title">Ï¢ÖÎ™© Ï∂îÍ∞Ä</div>
          <div style="display: flex; flex-wrap: wrap; gap: 12px;" id="bulk-add-discipline-options"></div>
          <button class="btn btn-primary" style="margin-top: 16px;" onclick="confirmBulkAddDiscipline()">Ï∂îÍ∞ÄÌïòÍ∏∞</button>
          <button class="btn btn-secondary" style="margin-top: 8px;" onclick="closeBottomSheet('sheet-bulk-add-discipline')">Ï∑®ÏÜå</button>
        </div>
      </div>
    </div>

    <!-- Bottom Sheet: Í∞ïÏäµ Ï¢ÖÎ™© Ï∂îÍ∞Ä -->
    <div class="bottom-sheet-overlay" id="sheet-batch-add-discipline">
      <div class="bottom-sheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-content">
          <div class="bottom-sheet-title">Ï¢ÖÎ™© Ï∂îÍ∞Ä</div>
          <div style="display: flex; flex-wrap: wrap; gap: 12px;" id="batch-add-discipline-options"></div>
          <button class="btn btn-primary" style="margin-top: 16px;" onclick="confirmBatchAddDiscipline()">Ï∂îÍ∞ÄÌïòÍ∏∞</button>
          <button class="btn btn-secondary" style="margin-top: 8px;" onclick="closeBottomSheet('sheet-batch-add-discipline')">Ï∑®ÏÜå</button>
        </div>
      </div>
    </div>

    <!-- Bottom Sheet: ÎìúÎùºÏù¥ Ìä∏Î†àÏù¥Îãù Ï∂îÍ∞Ä/ÏàòÏ†ï (Í∞ïÏÇ¨Ïö©) -->
    <div class="bottom-sheet-overlay" id="sheet-dry-form">
      <div class="bottom-sheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-content">
          <div class="bottom-sheet-title" id="dry-form-title">ÏÉà Ìä∏Î†àÏù¥Îãù Ï∂îÍ∞Ä</div>
          <input type="hidden" id="edit-dry-id">
          <div class="input-group">
            <label class="input-label">Ìä∏Î†àÏù¥Îãù Ïù¥Î¶Ñ</label>
            <input type="text" class="input" id="dry-name" placeholder="Ïòà: ÌîÑÎ†åÏ†§ 500Ìöå">
          </div>
          <div class="input-group">
            <label class="input-label">ÏÑ§Î™Ö (ÏÑ†ÌÉù)</label>
            <textarea class="input" id="dry-description" rows="3" placeholder="Ìä∏Î†àÏù¥Îãù Î∞©Î≤ïÏù¥ÎÇò Î™©ÌëúÎ•º ÏÑ§Î™ÖÌï¥Ï£ºÏÑ∏Ïöî"></textarea>
          </div>
          <button class="btn btn-primary" onclick="saveDryTraining()">Ï†ÄÏû•</button>
          <button class="btn btn-secondary" style="margin-top: 8px;" onclick="closeBottomSheet('sheet-dry-form')">Ï∑®ÏÜå</button>
        </div>
      </div>
    </div>

    <!-- Bottom Sheet: ÎìúÎùºÏù¥ Ìä∏Î†àÏù¥Îãù Í∏∞Î°ù ÏûÖÎ†• (ÌïôÏÉùÏö©) -->
    <div class="bottom-sheet-overlay" id="sheet-dry-record">
      <div class="bottom-sheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-content">
          <div class="bottom-sheet-title">Ïò§Îäò Í∏∞Î°ù</div>
          <div class="input-group">
            <label class="input-label">Îã¨ÏÑ±Î•†</label>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;" id="dry-achievement-btns">
              <button class="purpose-btn" data-value="0.5" onclick="selectDryAchievement(this)">50%</button>
              <button class="purpose-btn" data-value="0.7" onclick="selectDryAchievement(this)">70%</button>
              <button class="purpose-btn" data-value="0.8" onclick="selectDryAchievement(this)">80%</button>
              <button class="purpose-btn" data-value="0.9" onclick="selectDryAchievement(this)">90%</button>
              <button class="purpose-btn selected" data-value="1.0" onclick="selectDryAchievement(this)">100%</button>
            </div>
          </div>
          <div class="input-group">
            <label class="input-label">Î©îÎ™® (ÏÑ†ÌÉù)</label>
            <input type="text" class="input" id="dry-record-note" placeholder="Ïò§Îäò Ìä∏Î†àÏù¥Îãù ÎäêÎÇåÏùÄ?">
          </div>
          <button class="btn btn-primary" onclick="saveDryRecord()">Ï†ÄÏû•</button>
          <button class="btn btn-secondary" style="margin-top: 8px;" onclick="closeBottomSheet('sheet-dry-record')">Ï∑®ÏÜå</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==================== Supabase Ï¥àÍ∏∞Ìôî ====================
    const SUPABASE_URL = 'https://dnndjqlbjudnjpwescfl.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRubmRqcWxianVkbmpwd2VzY2ZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5MzE2NzMsImV4cCI6MjA4MTUwNzY3M30.0x3vKhKzZyn5MPDSoNJgbOvU-LGZ7q34N44DjWLQWz0';
    
    // Supabase ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ ÏÉùÏÑ± (dbÎ°ú Î™ÖÎ™ÖÌïòÏó¨ Ï∂©Îèå Î∞©ÏßÄ)
    const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ==================== Ï†ÑÏó≠ Î≥ÄÏàò ====================
    let currentUser = null;
    let currentScheduleId = null;
    let currentRegId = null;
    let allSchedules = [];
    let screenHistory = [];
    let skillsDonutChart = null;
    let recordsDonutChart = null;

    // ==================== Ï¥àÍ∏∞Ìôî ====================
    document.addEventListener('DOMContentLoaded', async function() {
      // ÏûêÎèô Î°úÍ∑∏Ïù∏ ÌôïÏù∏
      const savedUser = localStorage.getItem('divelog_user');
      if (savedUser) {
        try {
          const user = JSON.parse(savedUser);
          // DBÏóêÏÑú ÏµúÏã† Ï†ïÎ≥¥ ÌôïÏù∏
          const { data, error } = await db
            .from('users')
            .select('*')
            .eq('user_id', user.user_id)
            .single();
          
          if (data && !error) {
            currentUser = data;
            // ÏµúÏã† Ï†ïÎ≥¥Î°ú localStorage ÏóÖÎç∞Ïù¥Ìä∏
            localStorage.setItem('divelog_user', JSON.stringify(currentUser));
            
            if (currentUser.user_type === 'Í∞ïÏÇ¨') {
              showScreen('screen-instructor-home');
            } else {
              showScreen('screen-student-home');
            }
            return;
          } else {
            // Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ Ï†ÄÏû•Îêú ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ ÏÇ≠Ï†ú
            localStorage.removeItem('divelog_user');
          }
        } catch (e) {
          localStorage.removeItem('divelog_user');
        }
      }
      
      const phoneInput = document.getElementById('login-phone');
      
      // Ï†ÑÌôîÎ≤àÌò∏ ÏûêÎèô Ìè¨Îß∑ÌåÖ (Îí∑ÏûêÎ¶¨Îßå)
      phoneInput.addEventListener('input', function(e) {
        // Ïà´ÏûêÎßå Ï∂îÏ∂ú
        let v = e.target.value.replace(/\D/g, '');
        
        // 8ÏûêÎ¶¨ Ï†úÌïú (Îí∑Î≤àÌò∏Îßå)
        if (v.length > 8) v = v.slice(0, 8);
        
        // ÌïòÏù¥Ìîà Ï∂îÍ∞Ä (0000-0000 ÌòïÏãù)
        if (v.length > 4) {
          v = v.slice(0, 4) + '-' + v.slice(4);
        }
        
        e.target.value = v;
      });

      const overlays = document.querySelectorAll('.bottom-sheet-overlay');
      overlays.forEach(overlay => {
        overlay.addEventListener('click', function(e) {
          if (e.target === this) closeBottomSheet(this.id);
        });
      });
    });

    // ==================== Ïú†Ìã∏Î¶¨Ìã∞ Ìï®Ïàò ====================
    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 3000);
    }

    function showScreen(id) {
      const currentScreen = document.querySelector('.screen.active');
      if (currentScreen && currentScreen.id !== id) {
        screenHistory.push(currentScreen.id);
      }
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      window.scrollTo(0, 0);
      
      // ÌôîÎ©¥Î≥Ñ Î°úÎìú Ìï®Ïàò Ìò∏Ï∂ú
      if (id === 'screen-instructor-home') loadInstructorDashboard();
      else if (id === 'screen-student-home') loadStudentDashboard();
      else if (id === 'screen-mypage') loadMypage();
      else if (id === 'screen-schedule-manage') loadScheduleManage();
      else if (id === 'screen-student-schedule') loadStudentSchedule();
      else if (id === 'screen-my-records') loadMyRecords();
      else if (id === 'screen-dry-training') loadDryTraining();
      else if (id === 'screen-dry-manage') loadDryManage();
    }

    function goBack() {
      if (screenHistory.length > 0) {
        const prevScreen = screenHistory.pop();
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(prevScreen).classList.add('active');
      } else {
        if (currentUser && currentUser.user_type === 'Í∞ïÏÇ¨') showScreen('screen-instructor-home');
        else showScreen('screen-student-home');
      }
    }

    function openBottomSheet(id) {
      document.getElementById(id).classList.add('active');
    }

    function closeBottomSheet(id) {
      document.getElementById(id).classList.remove('active');
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      const d = new Date(dateStr);
      const days = ['Ïùº', 'Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†'];
      return (d.getMonth()+1) + 'Ïõî ' + d.getDate() + 'Ïùº (' + days[d.getDay()] + ')';
    }

    function formatTime(timeStr) {
      if (!timeStr) return '';
      const parts = timeStr.split(':');
      const h = parseInt(parts[0]);
      const m = parts[1];
      return (h < 12 ? 'Ïò§Ï†Ñ ' : 'Ïò§ÌõÑ ') + (h > 12 ? h - 12 : h) + ':' + m;
    }

    // ==================== Î°úÍ∑∏Ïù∏/Î°úÍ∑∏ÏïÑÏõÉ ====================
    async function handleLogin() {
      const phoneBack = document.getElementById('login-phone').value.replace(/-/g, '');
      const userId = document.getElementById('login-userid').value.trim();
      
      // Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
      if (!phoneBack || phoneBack.length < 8) {
        showToast('Ïó∞ÎùΩÏ≤òÎ•º Ï†ïÌôïÌûà ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî');
        return;
      }
      
      if (!userId) {
        showToast('ÏïÑÏù¥ÎîîÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî');
        return;
      }
      
      // Ï†ÑÏ≤¥ Ï†ÑÌôîÎ≤àÌò∏ Ï°∞Ìï© (010-0000-0000 ÌòïÏãù)
      const phone = '010-' + phoneBack.slice(0, 4) + '-' + phoneBack.slice(4);
      
      console.log('Î°úÍ∑∏Ïù∏ ÏãúÎèÑ:', phone, userId);
      
      try {
        // SupabaseÏóêÏÑú ÏÇ¨Ïö©Ïûê Ï°∞Ìöå (Ï†ÑÌôîÎ≤àÌò∏ + ÏïÑÏù¥Îîî Îëò Îã§ ÏùºÏπò)
        const { data, error } = await db
          .from('users')
          .select('*')
          .eq('phone', phone)
          .eq('user_id', userId)
          .single();
        
        console.log('Supabase ÏùëÎãµ:', { data, error });
        
        if (error || !data) {
          showToast('Ïó∞ÎùΩÏ≤ò ÎòêÎäî ÏïÑÏù¥ÎîîÍ∞Ä ÏùºÏπòÌïòÏßÄ ÏïäÏäµÎãàÎã§.');
          return;
        }
        
        currentUser = data;
        console.log('Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µ:', currentUser);
        
        // ÏûêÎèô Î°úÍ∑∏Ïù∏ÏùÑ ÏúÑÌï¥ localStorageÏóê Ï†ÄÏû•
        localStorage.setItem('divelog_user', JSON.stringify(currentUser));
        
        if (currentUser.user_type === 'Í∞ïÏÇ¨') {
          showScreen('screen-instructor-home');
        } else {
          showScreen('screen-student-home');
        }
      } catch (err) {
        console.error('Î°úÍ∑∏Ïù∏ Ïò§Î•ò:', err);
        showToast('Î°úÍ∑∏Ïù∏ Ïã§Ìå®: ' + err.message);
      }
    }

    function logout() {
      currentUser = null;
      screenHistory = [];
      // ÏûêÎèô Î°úÍ∑∏Ïù∏ Ï†ïÎ≥¥ ÏÇ≠Ï†ú
      localStorage.removeItem('divelog_user');
      showScreen('screen-login');
      document.getElementById('login-phone').value = '';
      document.getElementById('login-userid').value = '';
    }

    // ==================== Í∞ïÏÇ¨ ÎåÄÏãúÎ≥¥Îìú ====================
    async function loadInstructorDashboard() {
      document.getElementById('instructor-name').textContent = currentUser.name;
      await loadTodaySchedules();
      await loadInstructorStats();
    }

    async function loadTodaySchedules() {
      try {
        const today = new Date().toISOString().split('T')[0];
        
        // Ïò§Îäò ÏùºÏ†ï Ï°∞Ìöå
        const { data: schedules, error } = await db
          .from('schedules')
          .select('*')
          .eq('instructor_id', currentUser.user_id)
          .eq('date', today);
        
        if (error) throw error;
        
        const container = document.getElementById('today-schedules');
        
        if (!schedules || schedules.length === 0) {
          container.innerHTML = '<div class="card" style="text-align: center; color: var(--text-secondary);">Ïò§Îäò ÏùºÏ†ïÏù¥ ÏóÜÏäµÎãàÎã§</div>';
          return;
        }
        
        // Í∞Å ÏùºÏ†ïÏóê Ï∞∏Í∞ÄÏûê Ïàò Ï∂îÍ∞Ä
        let html = '';
        for (const s of schedules) {
          // Ï∞∏Í∞ÄÏûê Ïàò Ï°∞Ìöå
          const { count } = await db
            .from('registrations')
            .select('*', { count: 'exact', head: true })
            .eq('schedule_id', s.schedule_id);
          
          html += `<div class="card schedule-card" style="cursor:pointer;" onclick="openParticipants('${s.schedule_id}')">`;
          html += '<div class="schedule-info">';
          html += `<div class="schedule-time">${formatTime(s.time)} ¬∑ ${s.location}</div>`;
          html += `<div class="schedule-meta">Ï∞∏Í∞ÄÏûê ${count || 0}Î™Ö</div>`;
          html += '</div>';
          html += '<i class="fas fa-chevron-right schedule-arrow"></i>';
          html += '</div>';
        }
        
        container.innerHTML = html;
        allSchedules = schedules;
      } catch (err) {
        console.error('ÏùºÏ†ï Î°úÎìú Ïò§Î•ò:', err);
        document.getElementById('today-schedules').innerHTML = '<div class="card" style="text-align: center; color: var(--error);">ÏùºÏ†ïÏùÑ Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§</div>';
      }
    }

    async function loadInstructorStats() {
      try {
        // Ïù¥Î≤à Ï£º ÏãúÏûëÏùº Í≥ÑÏÇ∞
        const now = new Date();
        const weekStart = new Date(now);
        weekStart.setDate(now.getDate() - now.getDay());
        weekStart.setHours(0, 0, 0, 0);
        const weekStartStr = weekStart.toISOString().split('T')[0];
        
        // Ïù¥Î≤à Ï£º ÏùºÏ†ï Ïàò
        const { count: weekLessons } = await db
          .from('schedules')
          .select('*', { count: 'exact', head: true })
          .eq('instructor_id', currentUser.user_id)
          .gte('date', weekStartStr);
        
        // Ïù¥Î≤à Ï£º ÏùºÏ†ï ID Ï°∞Ìöå
        const { data: weekSchedules } = await db
          .from('schedules')
          .select('schedule_id')
          .eq('instructor_id', currentUser.user_id)
          .gte('date', weekStartStr);
        
        let weekStudents = 0;
        let weekRecords = 0;
        
        if (weekSchedules && weekSchedules.length > 0) {
          const scheduleIds = weekSchedules.map(s => s.schedule_id);
          
          // Ïù¥Î≤à Ï£º Ï∞∏Í∞ÄÏûê Ïàò
          const { count: studentCount } = await db
            .from('registrations')
            .select('*', { count: 'exact', head: true })
            .in('schedule_id', scheduleIds);
          weekStudents = studentCount || 0;
          
          // Ïù¥Î≤à Ï£º reg_id Ï°∞Ìöå
          const { data: regs } = await db
            .from('registrations')
            .select('reg_id')
            .in('schedule_id', scheduleIds);
          
          if (regs && regs.length > 0) {
            const regIds = regs.map(r => r.reg_id);
            
            // Ïù¥Î≤à Ï£º Í∏∞Î°ù Ïàò
            const { count: recordCount } = await db
              .from('dive_records')
              .select('*', { count: 'exact', head: true })
              .in('reg_id', regIds);
            weekRecords = recordCount || 0;
          }
        }
        
        document.getElementById('instructor-stats').innerHTML = 
          `Í∞ïÏäµ ${weekLessons || 0}Ìöå ¬∑ Í∞ïÏäµÏÉù ${weekStudents}Î™Ö ¬∑ Í∏∞Î°ù ${weekRecords}Í±¥`;
      } catch (err) {
        console.error('ÌÜµÍ≥Ñ Î°úÎìú Ïò§Î•ò:', err);
        document.getElementById('instructor-stats').innerHTML = 'ÌÜµÍ≥ÑÎ•º Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§';
      }
    }

    // ==================== Í∞ïÏäµÏÉù ÎåÄÏãúÎ≥¥Îìú ====================
    async function loadStudentDashboard() {
      document.getElementById('student-name').textContent = currentUser.name;
      
      // ÏßÑÎèÑÏú® Î°úÎìú (in_training_levelÏù¥ ÏûàÏúºÎ©¥)
      await loadLevelProgress();
      
      // ÏµúÍ≥† Í∏∞Î°ù Ï°∞Ìöå
      await loadBestRecords();
      
      // Îã§Í∞ÄÏò§Îäî ÏùºÏ†ï Ï°∞Ìöå
      await loadUpcomingSchedules();
      
      // ÎìúÎùºÏù¥ Ìä∏Î†àÏù¥Îãù Î°úÎìú
      await loadHomeDryTraining();
    }
    
    // Î†àÎ≤®Î≥Ñ ÏöîÍµ¨ÏÇ¨Ìï≠ Ï†ïÏùò
    const LEVEL_REQUIREMENTS = {
      2: {
        skills: [
          { key: 'rescue_5_10m', name: 'Î†àÏä§ÌÅê 5-10m' },
          { key: 'theory_test_lv2', name: 'Ïù¥Î°† ÌèâÍ∞Ä' }
        ],
        records: [
          { key: 'sta', name: 'STA', target: 120, unit: 'Ï¥à', display: "2'00\"" },  // 2Î∂Ñ = 120Ï¥à
          { key: 'dynb', name: 'DYNB', target: 40, unit: 'm', display: '40m' },
          { key: 'cwtb', name: 'CWTB', target: 12, unit: 'm', display: '12m' }
        ],
        lessonRequired: 3
      },
      3: {
        skills: [
          { key: 'lanyard_remove', name: 'ÎûúÏïºÎìú Ï†úÍ±∞' },
          { key: 'no_mask_10m', name: 'ÎÖ∏ÎßàÏä§ÌÅ¨ 10m' },
          { key: 'rescue_towing', name: 'Î†àÏä§ÌÅê 10-15m + ÌÜ†Ïûâ 50m' },
          { key: 'neutral_buoyancy', name: 'Ï§ëÏÑ±Î∂ÄÎ†•' },
          { key: 'freefall', name: 'ÌîÑÎ¶¨Ìè¥' },
          { key: 'arms_only_15m', name: 'ÏïîÏä§ Ïò®Î¶¨ 15m' },
          { key: 'buddy_10_15m', name: 'Ï†ÅÏ†àÌïú Î≤ÑÎîî 10-15m' },
          { key: 'theory_test', name: 'Ïù¥Î°† ÌèâÍ∞Ä' }
        ],
        records: [
          { key: 'sta', name: 'STA', target: 165, unit: 'Ï¥à', display: "2'45\"" },  // 2Î∂Ñ45Ï¥à = 165Ï¥à
          { key: 'dynb', name: 'DYNB', target: 55, unit: 'm', display: '55m' },
          { key: 'cwtb', name: 'CWTB', target: 24, unit: 'm', display: '24m' }
        ],
        lessonRequired: 4
      }
    };
    
    // ÏßÑÎèÑÏú® Ï∞®Ìä∏ Ïù∏Ïä§ÌÑ¥Ïä§
    let skillsChartInstance = null;
    let recordsChartInstance = null;
    
    // ÏßÑÎèÑÏú® Î°úÎìú
    async function loadLevelProgress() {
      const level = currentUser.in_training_level;
      const section = document.getElementById('level-progress-section');
      
      // Î†àÎ≤® Í≥ºÏ†ï Ï§ëÏù¥ ÏïÑÎãàÎ©¥ Ïà®ÍπÄ
      if (!level || (level !== 2 && level !== 3)) {
        section.style.display = 'none';
        return;
      }
      
      section.style.display = 'block';
      
      const req = LEVEL_REQUIREMENTS[level];
      const tableName = level === 2 ? 'lv2_progress' : 'lv3_progress';
      
      try {
        // ÏßÑÎèÑ Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå
        const { data: progress } = await db
          .from(tableName)
          .select('*')
          .eq('user_id', currentUser.user_id)
          .single();
        
        // Ïä§ÌÇ¨ ÏôÑÎ£å Í≥ÑÏÇ∞
        let skillsDone = 0;
        const skillsTotal = req.skills.length;
        const skillItems = [];
        
        for (const skill of req.skills) {
          const isDone = progress && progress[skill.key] === 'Y';
          const attempts = progress ? (progress[skill.key + '_attempts'] || 0) : 0;
          if (isDone) skillsDone++;
          skillItems.push({ name: skill.name, done: isDone, attempts: attempts });
        }
        
        // Í∏∞Î°ù Îã¨ÏÑ±Î•† Í≥ÑÏÇ∞
        let totalRecordPercent = 0;
        const recordItems = [];
        
        for (const rec of req.records) {
          const value = progress ? progress[rec.key] : null;
          let percent = 0;
          
          if (value && value > 0) {
            percent = Math.min(100, Math.round((value / rec.target) * 100));
          }
          
          totalRecordPercent += percent;
          recordItems.push({
            name: rec.name,
            target: rec.display,
            percent: percent,
            done: percent >= 100,
            currentValue: value,  // ÌòÑÏû¨ Í∏∞Î°ù Í∞í Ï∂îÍ∞Ä
            unit: rec.unit || ''  // Îã®ÏúÑ Ï∂îÍ∞Ä
          });
        }
        
        const avgRecordPercent = Math.round(totalRecordPercent / req.records.length);
        
        // Í∞ïÏäµ ÌöüÏàò
        const lessonCount = progress?.lesson_count || 0;
        const lessonDone = lessonCount >= req.lessonRequired;
        
        // ÌÉÄÏù¥ÌãÄ Î∞è ÏöîÏïΩ ÏóÖÎç∞Ïù¥Ìä∏
        document.getElementById('level-progress-title').innerHTML = `<i class="fas fa-graduation-cap"></i> Level ${level} ÏßÑÎèÑ`;
        document.getElementById('level-progress-summary').innerHTML = `
          Í∞ïÏäµ ${lessonCount}/${req.lessonRequired}Ìöå ${lessonDone ? '<i class="fas fa-check" style="color: var(--success);"></i>' : ''} ¬∑ 
          Ïä§ÌÇ¨ ${skillsDone}/${skillsTotal} ¬∑ 
          Í∏∞Î°ù ${avgRecordPercent}%
        `;
        
        // ÎèÑÎÑõ Ï∞®Ìä∏ ÏÉâÏÉÅ
        const lvColor = level === 2 ? '#FF9100' : '#00C853';
        const lvColorLight = level === 2 ? '#FFF3E0' : '#E8F5E9';
        
        // Ïä§ÌÇ¨ Ï∞®Ìä∏ Î†åÎçîÎßÅ
        renderDonutChart('skills-chart', skillsDone, skillsTotal, lvColor, lvColorLight, 'skillsChartInstance');
        document.getElementById('skills-progress-value').textContent = `${skillsDone}/${skillsTotal}`;
        document.getElementById('skills-progress-value').className = `donut-value lv${level}`;
        
        // Ïä§ÌÇ¨ Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏ Î†åÎçîÎßÅ
        let skillsHtml = '';
        for (const item of skillItems) {
          const attemptsText = item.attempts > 0 ? `${item.attempts}Ìöå` : '-';
          skillsHtml += `
            <div class="checklist-item">
              <div class="checklist-icon ${item.done ? 'done' : 'undone'}">
                <i class="fas fa-${item.done ? 'check' : 'circle'}"></i>
              </div>
              <span class="checklist-text ${item.done ? 'done' : ''}">${item.name}</span>
              <span class="checklist-badge" style="min-width: 40px; text-align: right;">${attemptsText}</span>
            </div>
          `;
        }
        document.getElementById('skills-checklist').innerHTML = skillsHtml;
        
        // Í∏∞Î°ù Ï∞®Ìä∏ Î†åÎçîÎßÅ
        renderDonutChart('records-chart', avgRecordPercent, 100, lvColor, lvColorLight, 'recordsChartInstance');
        document.getElementById('records-progress-value').textContent = `${avgRecordPercent}%`;
        document.getElementById('records-progress-value').className = `donut-value lv${level}`;
        document.querySelector('#records-chart').parentElement.nextElementSibling.querySelector('.donut-label')?.remove;
        
        // Í∏∞Î°ù Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏ Î†åÎçîÎßÅ
        let recordsHtml = '';
        for (const item of recordItems) {
          // ÌòÑÏû¨ Í∏∞Î°ù Ìè¨Îß∑ÌåÖ
          let currentDisplay = '-';
          if (item.currentValue && item.currentValue > 0) {
            if (item.name === 'STA') {
              // STAÎäî Ï¥àÎ•º Î∂Ñ:Ï¥àÎ°ú Î≥ÄÌôò
              const mins = Math.floor(item.currentValue / 60);
              const secs = item.currentValue % 60;
              currentDisplay = `${mins}'${secs.toString().padStart(2, '0')}"`;
            } else {
              // DYNB, CWTB Îì±ÏùÄ m Îã®ÏúÑ
              currentDisplay = `${item.currentValue}m`;
            }
          }
          
          recordsHtml += `
            <div class="checklist-item">
              <div class="checklist-icon ${item.done ? 'done' : 'undone'}">
                <i class="fas fa-${item.done ? 'check' : 'circle'}"></i>
              </div>
              <span class="checklist-text">${item.name} ‚â• ${item.target}</span>
              <span class="checklist-badge" style="min-width: 50px; text-align: right;">${currentDisplay}</span>
            </div>
          `;
        }
        document.getElementById('records-checklist').innerHTML = recordsHtml;
        
      } catch (err) {
        console.error('ÏßÑÎèÑÏú® Î°úÎìú Ïò§Î•ò:', err);
        section.style.display = 'none';
      }
    }
    
    // ÎèÑÎÑõ Ï∞®Ìä∏ Î†åÎçîÎßÅ
    function renderDonutChart(canvasId, value, total, color, bgColor, instanceVar) {
      const canvas = document.getElementById(canvasId);
      const ctx = canvas.getContext('2d');
      
      // Í∏∞Ï°¥ Ï∞®Ìä∏ ÌååÍ¥¥
      if (instanceVar === 'skillsChartInstance' && skillsChartInstance) {
        skillsChartInstance.destroy();
      } else if (instanceVar === 'recordsChartInstance' && recordsChartInstance) {
        recordsChartInstance.destroy();
      }
      
      const chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          datasets: [{
            data: [value, Math.max(0, total - value)],
            backgroundColor: [color, bgColor],
            borderWidth: 0
          }]
        },
        options: {
          cutout: '70%',
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { display: false },
            tooltip: { enabled: false }
          }
        }
      });
      
      if (instanceVar === 'skillsChartInstance') {
        skillsChartInstance = chart;
      } else if (instanceVar === 'recordsChartInstance') {
        recordsChartInstance = chart;
      }
    }

    async function loadBestRecords() {
      try {
        const disciplines = ['STA', 'CWTB', 'DYNB'];
        let bestHtml = '';
        
        for (const disc of disciplines) {
          const key = 'best_' + disc.toLowerCase();
          const value = currentUser[key];
          
          let displayVal = '-';
          if (value && value > 0) {
            if (disc === 'STA') {
              // STAÎäî Ï¥à Îã®ÏúÑÎ•º Î∂Ñ'Ï¥à" ÌòïÏãùÏúºÎ°ú Î≥ÄÌôò
              const minutes = Math.floor(value / 60);
              const seconds = Math.floor(value % 60);
              displayVal = `${minutes}'${seconds.toString().padStart(2, '0')}"`;
            } else {
              displayVal = value + 'm';
            }
          }
          
          bestHtml += `<div class="stat-card">
            <div class="stat-label">${disc}</div>
            <div class="stat-value">${displayVal}</div>
          </div>`;
        }
        
        document.getElementById('best-records').innerHTML = bestHtml;
      } catch (err) {
        console.error('ÏµúÍ≥† Í∏∞Î°ù Î°úÎìú Ïò§Î•ò:', err);
      }
    }

    async function loadUpcomingSchedules() {
      try {
        const today = new Date().toISOString().split('T')[0];
        
        // ÌïôÏÉùÏùò Îì±Î°ùÎêú ÏùºÏ†ï Ï°∞Ìöå
        const { data: regs } = await db
          .from('registrations')
          .select(`
            reg_id,
            purpose,
            schedule_id,
            schedules (
              schedule_id,
              date,
              time,
              location
            )
          `)
          .eq('student_id', currentUser.user_id);
        
        const container = document.getElementById('upcoming-schedules');
        
        if (!regs || regs.length === 0) {
          container.innerHTML = '<div class="card" style="text-align: center; color: var(--text-secondary);">ÏòàÏ†ïÎêú ÏùºÏ†ïÏù¥ ÏóÜÏäµÎãàÎã§</div>';
          return;
        }
        
        // ÎØ∏Îûò ÏùºÏ†ïÎßå ÌïÑÌÑ∞ÎßÅ
        const upcoming = regs
          .filter(r => r.schedules && r.schedules.date >= today)
          .sort((a, b) => new Date(a.schedules.date) - new Date(b.schedules.date))
          .slice(0, 3);
        
        if (upcoming.length === 0) {
          container.innerHTML = '<div class="card" style="text-align: center; color: var(--text-secondary);">ÏòàÏ†ïÎêú ÏùºÏ†ïÏù¥ ÏóÜÏäµÎãàÎã§</div>';
          return;
        }
        
        let html = '';
        for (const r of upcoming) {
          const s = r.schedules;
          html += `<div class="card schedule-card" onclick="openScheduleDetail('${r.reg_id}')" style="cursor: pointer;">
            <div class="schedule-info">
              <div class="schedule-time">${formatDate(s.date)} ${formatTime(s.time)}</div>
              <div class="schedule-location">${s.location} ¬∑ ${r.purpose}</div>
            </div>
            <i class="fas fa-chevron-right schedule-arrow"></i>
          </div>`;
        }
        
        container.innerHTML = html;
      } catch (err) {
        console.error('ÏùºÏ†ï Î°úÎìú Ïò§Î•ò:', err);
        document.getElementById('upcoming-schedules').innerHTML = '<div class="card" style="text-align: center; color: var(--error);">ÏùºÏ†ïÏùÑ Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§</div>';
      }
    }

    // ==================== ÎßàÏù¥ÌéòÏù¥ÏßÄ ====================
    function loadMypage() {
      document.getElementById('mypage-avatar').textContent = currentUser.name ? currentUser.name.charAt(0) : '?';
      document.getElementById('mypage-name').textContent = currentUser.name;
      document.getElementById('mypage-phone').textContent = currentUser.phone;
      document.getElementById('mypage-info').textContent = 'Level ' + (currentUser.cert_level === 'X' ? '1' : currentUser.cert_level) + ' ¬∑ ' + currentUser.user_type;

  // ÏûêÍ≤©Ï¶ù Ïù¥ÎØ∏ÏßÄ Î†åÎçîÎßÅ Ï∂îÍ∞Ä
  renderCertImage();   
 }

    // ==================== ÏùºÏ†ï Í¥ÄÎ¶¨ (Í∞ïÏÇ¨) ====================
    async function loadScheduleManage() {
      try {
        const { data: schedules, error } = await db
          .from('schedules')
          .select('*')
          .eq('instructor_id', currentUser.user_id)
          .order('date', { ascending: false });
        
        if (error) throw error;
        
        allSchedules = schedules || [];
        renderScheduleList();
        // Ï∫òÎ¶∞ÎçîÌòïÏù¥ Í∏∞Î≥∏Ïù¥ÎØÄÎ°ú Ï∫òÎ¶∞ÎçîÎèÑ Î†åÎçîÎßÅ
        renderCalendar();
      } catch (err) {
        console.error('ÏùºÏ†ï Î°úÎìú Ïò§Î•ò:', err);
        document.getElementById('schedule-list').innerHTML = 
          '<div class="card" style="text-align: center; color: var(--error);">ÏùºÏ†ïÏùÑ Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§</div>';
      }
    }

    async function renderScheduleList() {
      const container = document.getElementById('schedule-list');
      
      if (allSchedules.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="fas fa-calendar-times"></i><p>ÏùºÏ†ïÏù¥ ÏóÜÏäµÎãàÎã§</p></div>';
        return;
      }
      
      const today = new Date().toISOString().split('T')[0];
      
      // ÏùºÏ†ï Î∂ÑÎ•ò
      const pastSchedules = allSchedules.filter(s => s.date < today);
      const todaySchedules = allSchedules.filter(s => s.date === today);
      const futureSchedules = allSchedules.filter(s => s.date > today);
      
      let html = '';
      
      // Îã§Í∞ÄÏò¨ ÏùºÏ†ï (ÎØ∏Îûò ‚Üí ÎÇ†ÏßúÏàú)
      if (futureSchedules.length > 0) {
        html += '<div class="schedule-section-title"><i class="fas fa-arrow-right"></i> Îã§Í∞ÄÏò¨ ÏùºÏ†ï</div>';
        for (const s of futureSchedules.sort((a, b) => a.date.localeCompare(b.date))) {
          html += await renderScheduleCard(s);
        }
      }
      
      // Ïò§Îäò ÏùºÏ†ï
      if (todaySchedules.length > 0) {
        html += '<div class="schedule-section-title"><i class="fas fa-clock"></i> Ïò§Îäò ÏùºÏ†ï</div>';
        for (const s of todaySchedules) {
          html += await renderScheduleCard(s);
        }
      }
      
      // ÏßÄÎÇú ÏùºÏ†ï (Í≥ºÍ±∞ ‚Üí ÏµúÏã†Ïàú)
      if (pastSchedules.length > 0) {
        html += '<div class="schedule-section-title"><i class="fas fa-check"></i> ÏßÄÎÇú ÏùºÏ†ï</div>';
        for (const s of pastSchedules.sort((a, b) => b.date.localeCompare(a.date))) {
          html += await renderScheduleCard(s);
        }
      }
      
      container.innerHTML = html;
    }

    async function renderScheduleCard(s) {
      // Ï∞∏Í∞ÄÏûê Ï†ïÎ≥¥ Ï°∞Ìöå (Í∞ïÏäµ/ÌéÄ Íµ¨Î∂Ñ, Î†àÎ≤®)
      const { data: regs } = await db
        .from('registrations')
        .select('purpose, lesson_level')
        .eq('schedule_id', s.schedule_id);
      
      // Í∞ïÏäµÏÉù ÏàòÏôÄ Î†àÎ≤®, ÌéÄÎã§Ïù¥Îπô Ïàò
      const lessonRegs = (regs || []).filter(r => r.purpose === 'Í∞ïÏäµ');
      const funRegs = (regs || []).filter(r => r.purpose === 'ÌéÄÎã§Ïù¥Îπô');
      const lessonLevels = [...new Set(lessonRegs.map(r => r.lesson_level).filter(l => l))].sort();
      
      let participantText = s.location;
      if (lessonRegs.length > 0 || funRegs.length > 0) {
        participantText += ' ¬∑ ';
        if (lessonRegs.length > 0) {
          participantText += `Í∞ïÏäµ ${lessonRegs.length}Î™Ö`;
          if (lessonLevels.length > 0) {
            participantText += `(${lessonLevels.map(l => 'Lv' + l).join(', ')})`;
          }
        }
        if (funRegs.length > 0) {
          if (lessonRegs.length > 0) participantText += ' ¬∑ ';
          participantText += `ÌéÄ ${funRegs.length}Î™Ö`;
        }
      }
      
      return `<div class="card">
        <div class="schedule-card" style="margin-bottom: 12px;">
          <div class="schedule-info" style="flex: 1;">
            <div class="schedule-time">${formatDate(s.date)} ${formatTime(s.time)}</div>
            <div class="schedule-location">${participantText}</div>
          </div>
          <div style="display: flex; gap: 8px;">
            <button class="icon-btn" onclick="openScheduleForm('${s.schedule_id}')"><i class="fas fa-pen"></i></button>
            <button class="icon-btn" onclick="deleteSchedule('${s.schedule_id}')"><i class="fas fa-trash"></i></button>
          </div>
        </div>
        <div style="display: flex; gap: 8px;">
          <button class="btn btn-secondary btn-small" style="flex: 1;" onclick="openParticipants('${s.schedule_id}')">
            <i class="fas fa-users"></i> Ï∞∏Í∞ÄÏûê
          </button>
          <button class="btn btn-primary btn-small" style="flex: 1;" onclick="openLessonRecordInput('${s.schedule_id}')">
            <i class="fas fa-pen"></i> Í∏∞Î°ù ÏûÖÎ†•
          </button>
        </div>
      </div>`;
    }

    async function deleteSchedule(scheduleId) {
      if (!confirm('Ïù¥ ÏùºÏ†ïÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå? Í¥ÄÎ†® Ï∞∏Í∞ÄÏûê Ï†ïÎ≥¥ÎèÑ Ìï®Íªò ÏÇ≠Ï†úÎê©ÎãàÎã§.')) return;
      
      try {
        // Î®ºÏ†Ä Í¥ÄÎ†® Í∏∞Î°ù ÏÇ≠Ï†ú
        const { data: regs } = await db
          .from('registrations')
          .select('reg_id')
          .eq('schedule_id', scheduleId);
        
        if (regs && regs.length > 0) {
          const regIds = regs.map(r => r.reg_id);
          await db.from('dive_records').delete().in('reg_id', regIds);
          await db.from('skill_records').delete().in('reg_id', regIds);
          await db.from('registrations').delete().eq('schedule_id', scheduleId);
        }
        
        // ÏùºÏ†ï ÏÇ≠Ï†ú
        const { error } = await db
          .from('schedules')
          .delete()
          .eq('schedule_id', scheduleId);
        
        if (error) throw error;
        
        showToast('ÏùºÏ†ïÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§');
        loadScheduleManage();
      } catch (err) {
        console.error('ÏùºÏ†ï ÏÇ≠Ï†ú Ïò§Î•ò:', err);
        showToast('ÏÇ≠Ï†ú Ïã§Ìå®: ' + err.message);
      }
    }

    // ==================== Ï∫òÎ¶∞Îçî Î™®Îìú ====================
    let scheduleViewMode = 'calendar'; // 'list' or 'calendar' - Ï∫òÎ¶∞ÎçîÌòï Í∏∞Î≥∏
    let calendarYear = new Date().getFullYear();
    let calendarMonth = new Date().getMonth();
    let selectedDate = new Date().toISOString().split('T')[0];

    function setScheduleViewMode(mode) {
      scheduleViewMode = mode;
      if (mode === 'calendar') {
        document.getElementById('schedule-list-mode').style.display = 'none';
        document.getElementById('schedule-calendar-mode').style.display = 'block';
        document.getElementById('schedule-calendar-btn').classList.add('active');
        document.getElementById('schedule-list-btn').classList.remove('active');
        renderCalendar();
      } else {
        document.getElementById('schedule-list-mode').style.display = 'block';
        document.getElementById('schedule-calendar-mode').style.display = 'none';
        document.getElementById('schedule-calendar-btn').classList.remove('active');
        document.getElementById('schedule-list-btn').classList.add('active');
      }
    }

    function toggleScheduleViewMode() {
      if (scheduleViewMode === 'list') {
        setScheduleViewMode('calendar');
      } else {
        setScheduleViewMode('list');
      }
    }

    function changeMonth(delta) {
      calendarMonth += delta;
      if (calendarMonth > 11) {
        calendarMonth = 0;
        calendarYear++;
      } else if (calendarMonth < 0) {
        calendarMonth = 11;
        calendarYear--;
      }
      renderCalendar();
    }

    function renderCalendar() {
      const monthNames = ['1Ïõî', '2Ïõî', '3Ïõî', '4Ïõî', '5Ïõî', '6Ïõî', '7Ïõî', '8Ïõî', '9Ïõî', '10Ïõî', '11Ïõî', '12Ïõî'];
      document.getElementById('calendar-title').textContent = `${calendarYear}ÎÖÑ ${monthNames[calendarMonth]}`;
      
      const firstDay = new Date(calendarYear, calendarMonth, 1);
      const lastDay = new Date(calendarYear, calendarMonth + 1, 0);
      const startDayOfWeek = firstDay.getDay();
      const daysInMonth = lastDay.getDate();
      
      const today = new Date().toISOString().split('T')[0];
      
      // ÏùºÏ†ïÏù¥ ÏûàÎäî ÎÇ†Ïßú Îßµ ÏÉùÏÑ±
      const scheduleDates = {};
      for (const s of allSchedules) {
        if (!scheduleDates[s.date]) {
          scheduleDates[s.date] = { lesson: false, personal: false, dry: false };
        }
        scheduleDates[s.date].lesson = true; // Í∞ïÏÇ¨Ïö©ÏùÄ Ï†ÑÎ∂Ä Í∞ïÏäµ ÏùºÏ†ï
      }
      
      let html = '';
      
      // Ïù¥Ï†Ñ Îã¨ ÎÇ†Ïßú
      const prevMonthLastDay = new Date(calendarYear, calendarMonth, 0).getDate();
      for (let i = startDayOfWeek - 1; i >= 0; i--) {
        const day = prevMonthLastDay - i;
        html += `<div class="calendar-day other-month">${day}</div>`;
      }
      
      // Ïù¥Î≤à Îã¨ ÎÇ†Ïßú
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${calendarYear}-${String(calendarMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const isToday = dateStr === today;
        const isSelected = dateStr === selectedDate;
        const schedule = scheduleDates[dateStr];
        
        let classes = 'calendar-day';
        if (isToday) classes += ' today';
        if (isSelected) classes += ' selected';
        
        // ÏùºÏ†ï ÏûàÎäî ÎÇ†ÏßúÏóê ÏÉâ ÎèôÍ∑∏ÎùºÎØ∏ ÌÅ¥ÎûòÏä§ Ï∂îÍ∞Ä (Ïö∞ÏÑ†ÏàúÏúÑ: Í∞ïÏäµ > Í∞úÏù∏ > Ï±åÎ¶∞ÏßÄ)
        if (schedule) {
          if (schedule.lesson) classes += ' has-lesson';
          else if (schedule.personal) classes += ' has-personal';
          else if (schedule.dry) classes += ' has-dry';
        }
        
        // ÏùºÏ†ï Î∞îÎäî Îçî Ïù¥ÏÉÅ ÏÇ¨Ïö©ÌïòÏßÄ ÏïäÏùå (CSSÏóêÏÑú Ïà®ÍπÄ Ï≤òÎ¶¨)
        let bars = '';
        
        html += `<div class="${classes}" onclick="selectCalendarDate('${dateStr}')">${day}${bars}</div>`;
      }
      
      // Îã§Ïùå Îã¨ ÎÇ†Ïßú
      const totalCells = startDayOfWeek + daysInMonth;
      const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
      for (let i = 1; i <= remainingCells; i++) {
        html += `<div class="calendar-day other-month">${i}</div>`;
      }
      
      document.getElementById('calendar-days').innerHTML = html;
      
      // ÏÑ†ÌÉùÎêú ÎÇ†Ïßú ÏùºÏ†ï ÌëúÏãú
      renderCalendarScheduleList();
    }

    function selectCalendarDate(dateStr) {
      selectedDate = dateStr;
      renderCalendar();
    }

    async function renderCalendarScheduleList() {
      const date = new Date(selectedDate);
      const dayNames = ['Ïùº', 'Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†'];
      const dateText = `${date.getMonth() + 1}Ïõî ${date.getDate()}Ïùº (${dayNames[date.getDay()]})`;
      document.getElementById('selected-date-text').textContent = dateText;
      
      const daySchedules = allSchedules.filter(s => s.date === selectedDate);
      const container = document.getElementById('calendar-schedule-list');
      
      if (daySchedules.length === 0) {
        container.innerHTML = '<div class="card" style="text-align: center; color: var(--text-tertiary); padding: 30px;">ÏùºÏ†ïÏù¥ ÏóÜÏäµÎãàÎã§</div>';
        return;
      }
      
      let html = '';
      for (const s of daySchedules) {
        html += await renderScheduleCard(s);
      }
      container.innerHTML = html;
    }

    // ==================== ÌïôÏÉùÏö© Ï∫òÎ¶∞Îçî ====================
    let studentScheduleViewMode = 'calendar'; // Ï∫òÎ¶∞ÎçîÌòï Í∏∞Î≥∏
    let studentCalendarYear = new Date().getFullYear();
    let studentCalendarMonth = new Date().getMonth();
    let studentSelectedDate = new Date().toISOString().split('T')[0];
    let studentSchedules = []; // ÌïôÏÉùÏùò Îì±Î°ùÎêú ÏùºÏ†ï

    function setStudentScheduleViewMode(mode) {
      studentScheduleViewMode = mode;
      if (mode === 'calendar') {
        document.getElementById('student-schedule-list-mode').style.display = 'none';
        document.getElementById('student-schedule-calendar-mode').style.display = 'block';
        document.getElementById('student-calendar-btn').classList.add('active');
        document.getElementById('student-list-btn').classList.remove('active');
        renderStudentCalendar();
      } else {
        document.getElementById('student-schedule-list-mode').style.display = 'block';
        document.getElementById('student-schedule-calendar-mode').style.display = 'none';
        document.getElementById('student-calendar-btn').classList.remove('active');
        document.getElementById('student-list-btn').classList.add('active');
      }
    }

    function toggleStudentScheduleViewMode() {
      if (studentScheduleViewMode === 'list') {
        setStudentScheduleViewMode('calendar');
      } else {
        setStudentScheduleViewMode('list');
      }
    }

    function changeStudentMonth(delta) {
      studentCalendarMonth += delta;
      if (studentCalendarMonth > 11) {
        studentCalendarMonth = 0;
        studentCalendarYear++;
      } else if (studentCalendarMonth < 0) {
        studentCalendarMonth = 11;
        studentCalendarYear--;
      }
      renderStudentCalendar();
    }

    function renderStudentCalendar() {
      const monthNames = ['1Ïõî', '2Ïõî', '3Ïõî', '4Ïõî', '5Ïõî', '6Ïõî', '7Ïõî', '8Ïõî', '9Ïõî', '10Ïõî', '11Ïõî', '12Ïõî'];
      document.getElementById('student-calendar-title').textContent = `${studentCalendarYear}ÎÖÑ ${monthNames[studentCalendarMonth]}`;
      
      const firstDay = new Date(studentCalendarYear, studentCalendarMonth, 1);
      const lastDay = new Date(studentCalendarYear, studentCalendarMonth + 1, 0);
      const startDayOfWeek = firstDay.getDay();
      const daysInMonth = lastDay.getDate();
      
      const today = new Date().toISOString().split('T')[0];
      
      // ÎÇ¥Í∞Ä Ïã†Ï≤≠Ìïú ÏùºÏ†ï ID Î™©Î°ù
      const myScheduleIds = studentSchedules.map(r => r.schedule_id);
      
      // ÏùºÏ†ïÏù¥ ÏûàÎäî ÎÇ†Ïßú Îßµ ÏÉùÏÑ±
      const scheduleDates = {};
      
      // 1. ÎÇ¥Í∞Ä Ïã†Ï≤≠Ìïú Í∞ïÏäµ (ÌïòÎäòÏÉâ Î∞∞Í≤Ω)
      for (const s of studentSchedules) {
        if (s.schedules) {
          const date = s.schedules.date;
          if (!scheduleDates[date]) {
            scheduleDates[date] = { lesson: false, personal: false, dry: false, available: false };
          }
          scheduleDates[date].lesson = true;
        }
      }
      
      // 2. ÎìúÎùºÏù¥ Ìä∏Î†àÏù¥Îãù Í∏∞Î°ù (Ï£ºÌô©ÏÉâ Î∞∞Í≤Ω)
      for (const r of studentDryRecords) {
        if (r.date) {
          if (!scheduleDates[r.date]) {
            scheduleDates[r.date] = { lesson: false, personal: false, dry: false, available: false };
          }
          // Ïù¥ÎØ∏ Í∞ïÏäµÏù¥ ÏûàÎäî ÎÇ†ÏùÄ Í∞ïÏäµ Ïö∞ÏÑ†
          if (!scheduleDates[r.date].lesson) {
            scheduleDates[r.date].dry = true;
          }
        }
      }
      
      // 3. Ïã†Ï≤≠ Í∞ÄÎä•Ìïú Í∞ïÏäµ (ÌÖåÎëêÎ¶¨Îßå - ÎØ∏Îûò ÏùºÏ†ïÎßå)
      for (const s of availableSchedules) {
        if (!myScheduleIds.includes(s.schedule_id) && s.date >= today) {
          if (!scheduleDates[s.date]) {
            scheduleDates[s.date] = { lesson: false, personal: false, dry: false, available: false };
          }
          // Îã§Î•∏ ÏùºÏ†ïÏù¥ ÏóÜÎäî Í≤ΩÏö∞ÏóêÎßå Ïã†Ï≤≠ Í∞ÄÎä• ÌëúÏãú
          if (!scheduleDates[s.date].lesson && !scheduleDates[s.date].challenge) {
            scheduleDates[s.date].available = true;
          }
        }
      }
      
      let html = '';
      
      // Ïù¥Ï†Ñ Îã¨ ÎÇ†Ïßú
      const prevMonthLastDay = new Date(studentCalendarYear, studentCalendarMonth, 0).getDate();
      for (let i = startDayOfWeek - 1; i >= 0; i--) {
        const day = prevMonthLastDay - i;
        html += `<div class="calendar-day other-month">${day}</div>`;
      }
      
      // Ïù¥Î≤à Îã¨ ÎÇ†Ïßú
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${studentCalendarYear}-${String(studentCalendarMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const isToday = dateStr === today;
        const isSelected = dateStr === studentSelectedDate;
        const schedule = scheduleDates[dateStr];
        
        let classes = 'calendar-day';
        if (isToday) classes += ' today';
        if (isSelected) classes += ' selected';
        
        // ÏùºÏ†ï ÏûàÎäî ÎÇ†ÏßúÏóê ÏÉâ ÎèôÍ∑∏ÎùºÎØ∏ ÌÅ¥ÎûòÏä§ Ï∂îÍ∞Ä (Ïö∞ÏÑ†ÏàúÏúÑ: Í∞ïÏäµ > ÎìúÎùºÏù¥ > Ïã†Ï≤≠Í∞ÄÎä•)
        if (schedule) {
          if (schedule.lesson) classes += ' has-lesson';
          else if (schedule.dry) classes += ' has-dry';
          else if (schedule.available) classes += ' has-available';
        }
        
        html += `<div class="${classes}" onclick="selectStudentCalendarDate('${dateStr}')">${day}</div>`;
      }
      
      // Îã§Ïùå Îã¨ ÎÇ†Ïßú
      const totalCells = startDayOfWeek + daysInMonth;
      const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
      for (let i = 1; i <= remainingCells; i++) {
        html += `<div class="calendar-day other-month">${i}</div>`;
      }
      
      document.getElementById('student-calendar-days').innerHTML = html;
      
      // ÏÑ†ÌÉùÎêú ÎÇ†Ïßú ÏùºÏ†ï ÌëúÏãú
      renderStudentCalendarScheduleList();
    }

    function selectStudentCalendarDate(dateStr) {
      studentSelectedDate = dateStr;
      renderStudentCalendar();
    }

    function renderStudentCalendarScheduleList() {
      const date = new Date(studentSelectedDate);
      const dayNames = ['Ïùº', 'Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†'];
      const dateText = `${date.getMonth() + 1}Ïõî ${date.getDate()}Ïùº (${dayNames[date.getDay()]})`;
      document.getElementById('student-selected-date-text').textContent = dateText;
      
      const container = document.getElementById('student-calendar-schedule-list');
      let html = '';
      
      const today = new Date().toISOString().split('T')[0];
      
      // ÎÇ¥Í∞Ä Ïã†Ï≤≠Ìïú ÏùºÏ†ï
      const myDaySchedules = studentSchedules.filter(s => s.schedules && s.schedules.date === studentSelectedDate);
      
      // Ïã†Ï≤≠ Í∞ÄÎä•Ìïú ÏùºÏ†ï (ÎÇ¥Í∞Ä Ïã†Ï≤≠ÌïòÏßÄ ÏïäÏùÄ Í≤É, Ïò§Îäò Ïù¥ÌõÑÎßå)
      const myScheduleIds = studentSchedules.map(r => r.schedule_id);
      const availableDaySchedules = availableSchedules.filter(s => 
        s.date === studentSelectedDate && 
        !myScheduleIds.includes(s.schedule_id) &&
        s.date >= today  // ÏßÄÎÇú ÎÇ†Ïßú Ï†úÏô∏
      );
      
      // ÎìúÎùºÏù¥ Ìä∏Î†àÏù¥Îãù Í∏∞Î°ù
      const hasDryRecord = studentDryRecords.some(r => r.date === studentSelectedDate);
      
      // Ïã†Ï≤≠Ìïú ÏùºÏ†ï ÌëúÏãú
      for (const r of myDaySchedules) {
        const s = r.schedules;
        html += `<div class="card schedule-card" style="cursor: pointer;" onclick="openScheduleDetail('${r.reg_id}')">
          <div class="schedule-info">
            <div class="schedule-time">${formatTime(s.time)}</div>
            <div class="schedule-location">${s.location} ¬∑ ${s.users?.name || 'Í∞ïÏÇ¨'}</div>
          </div>
          <span class="my-schedule-badge">${r.purpose === 'ÌéÄÎã§Ïù¥Îπô' ? 'ÌéÄÎã§Ïù¥Îπô' : 'Í∞ïÏäµ'}</span>
        </div>`;
      }
      
      // Ïã†Ï≤≠ Í∞ÄÎä•Ìïú ÏùºÏ†ï ÌëúÏãú (ÎØ∏Îûò ÏùºÏ†ïÎßå)
      for (const s of availableDaySchedules) {
        html += `<div class="card schedule-card">
          <div class="schedule-info">
            <div class="schedule-time">${formatTime(s.time)}</div>
            <div class="schedule-location">${s.location} ¬∑ ${s.users?.name || 'Í∞ïÏÇ¨'}</div>
          </div>
          <button class="btn btn-small btn-primary" onclick="openRegisterSheet('${s.schedule_id}')">Ïã†Ï≤≠</button>
        </div>`;
      }
      
      // Ïò§ÎäòÏù¥Í≥† Ï∞∏Ïó¨ Ï§ëÏù∏ ÎìúÎùºÏù¥ Ìä∏Î†àÏù¥ÎãùÏù¥ ÏûàÏúºÎ©¥ ÌëúÏãú (Îã§Ïù¥Îπô ÏùºÏ†ï Ïú†Î¨¥ÏôÄ Í¥ÄÍ≥ÑÏóÜÏù¥)
      const isToday = studentSelectedDate === today;
      if (isToday && studentMyDryTrainings.length > 0) {
        for (const t of studentMyDryTrainings) {
          // Ïò§Îäò Ïù¥ Ìä∏Î†àÏù¥ÎãùÏùÑ ÏôÑÎ£åÌñàÎäîÏßÄ ÌôïÏù∏
          const todayDone = studentDryRecords.some(r => r.date === today && r.dry_id === t.dry_id);
          
          html += `<div class="card schedule-card">
            <div class="schedule-info">
              <div class="schedule-time"><i class="fas fa-lungs" style="color: var(--warning);"></i> ${t.name}</div>
              <div class="schedule-location">${t.description || 'ÎìúÎùºÏù¥ Ìä∏Î†àÏù¥Îãù'}</div>
            </div>
            ${todayDone 
              ? `<span style="color: var(--success); font-size: 13px;"><i class="fas fa-check-circle"></i> ÏôÑÎ£å</span>`
              : `<button class="btn btn-small btn-primary" onclick="quickDryRecord('${t.dry_id}')">Ï≤¥ÌÅ¨</button>`
            }
          </div>`;
        }
      } else if (hasDryRecord) {
        // Ïò§ÎäòÏù¥ ÏïÑÎãå ÎÇ†ÏßúÏóê ÎìúÎùºÏù¥ Í∏∞Î°ùÏù¥ ÏûàÏúºÎ©¥ ÏôÑÎ£å ÌëúÏãú
        html += `<div class="card schedule-card">
          <div class="schedule-info">
            <div class="schedule-time"><i class="fas fa-lungs" style="color: var(--warning);"></i> ÎìúÎùºÏù¥ Ìä∏Î†àÏù¥Îãù</div>
            <div class="schedule-location">ÏôÑÎ£å</div>
          </div>
          <span style="color: var(--success); font-size: 13px;"><i class="fas fa-check-circle"></i></span>
        </div>`;
      }
      
      if (!html) {
        html = '<div class="card" style="text-align: center; color: var(--text-tertiary); padding: 30px;">ÏùºÏ†ïÏù¥ ÏóÜÏäµÎãàÎã§</div>';
      }
      
      container.innerHTML = html;
    }

    function toggleScheduleSection(type) {
      const section = document.getElementById('schedule-' + type + '-section');
      const toggle = document.getElementById('schedule-' + type + '-toggle');
      
      if (section.style.display === 'none') {
        section.style.display = 'block';
        toggle.textContent = 'Ï†ëÍ∏∞';
      } else {
        section.style.display = 'none';
        toggle.textContent = 'ÏÑ†ÌÉù';
      }
    }

    function resetScheduleFormChecks(defaultDiscs, defaultSkills) {
      // Í∏∞Î°ù Ï¢ÖÎ™© Ï≤¥ÌÅ¨Î∞ïÏä§ Ï¥àÍ∏∞Ìôî
      document.querySelectorAll('#schedule-disc-checks input[type="checkbox"]').forEach(cb => {
        cb.checked = defaultDiscs.includes(cb.value);
      });
      
      // Ïä§ÌÇ¨ Ï¢ÖÎ™© Ï≤¥ÌÅ¨Î∞ïÏä§ Ï¥àÍ∏∞Ìôî (ÏòÅÏñ¥‚ÜíÌïúÍµ≠Ïñ¥ Îß§Ìïë Ï†ÅÏö©)
      document.querySelectorAll('#schedule-skill-section input[type="checkbox"]').forEach(cb => {
        const koreanName = cb.value;
        const englishName = toEnglishSkillName(koreanName);
        cb.checked = defaultSkills.includes(koreanName) || defaultSkills.includes(englishName);
      });
    }

    function openScheduleForm(scheduleId) {
      document.getElementById('schedule-form-title').textContent = scheduleId ? 'ÏùºÏ†ï ÏàòÏ†ï' : 'ÏÉà ÏùºÏ†ï Îì±Î°ù';
      document.getElementById('edit-schedule-id').value = scheduleId || '';
      
      // ÌÜ†Í∏Ä ÏÑπÏÖò Ï¥àÍ∏∞Ìôî (Îã´Í∏∞)
      document.getElementById('schedule-disc-section').style.display = 'none';
      document.getElementById('schedule-disc-toggle').textContent = 'ÏÑ†ÌÉù';
      document.getElementById('schedule-skill-section').style.display = 'none';
      document.getElementById('schedule-skill-toggle').textContent = 'ÏÑ†ÌÉù';
      
      if (scheduleId) {
        // ÏàòÏ†ï Î™®Îìú - Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        const s = allSchedules.find(x => x.schedule_id === scheduleId);
        if (s) {
          document.getElementById('schedule-date').value = s.date;
          document.getElementById('schedule-time').value = s.time;
          document.getElementById('schedule-location').value = s.location;
          
          // DBÏóê Ï†ÄÏû•Îêú Ï¢ÖÎ™© Ï†ïÎ≥¥ Î°úÎìú (NULLÏù¥Î©¥ Îπà Î∞∞Ïó¥)
          const savedDiscs = s.common_disciplines ? s.common_disciplines.split(',') : [];
          const savedSkills = s.common_skill_disciplines ? s.common_skill_disciplines.split(',') : [];
          resetScheduleFormChecks(savedDiscs, savedSkills);
        }
      } else {
        // ÏÉà ÏùºÏ†ï - Í∏∞Î≥∏Í∞í
        document.getElementById('schedule-date').value = '';
        document.getElementById('schedule-time').value = '';
        document.getElementById('schedule-location').value = '';
        
        // Í∏∞Î≥∏ ÏÑ†ÌÉù: STA, DYNB, FIM, CWTBÎßå
        resetScheduleFormChecks(['STA', 'DYNB', 'FIM', 'CWTB'], []);
      }
      
      openBottomSheet('sheet-schedule');
    }

    async function saveSchedule() {
      const scheduleId = document.getElementById('edit-schedule-id').value;
      const date = document.getElementById('schedule-date').value;
      const time = document.getElementById('schedule-time').value;
      const location = document.getElementById('schedule-location').value;
      
      if (!date || !time || !location) {
        showToast('Î™®Îì† Ìï≠Î™©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî');
        return;
      }
      
      // ÏÑ†ÌÉùÎêú Í∏∞Î°ù Ï¢ÖÎ™©
      const recordDiscs = [];
      document.querySelectorAll('#schedule-disc-checks input[type="checkbox"]:checked').forEach(cb => {
        recordDiscs.push(cb.value);
      });
      
      // ÏÑ†ÌÉùÎêú Ïä§ÌÇ¨ Ï¢ÖÎ™© (ÏòÅÏñ¥Î°ú Î≥ÄÌôòÌï¥ÏÑú Ï†ÄÏû•)
      const skillDiscs = [];
      document.querySelectorAll('#schedule-skill-section input[type="checkbox"]:checked').forEach(cb => {
        skillDiscs.push(toEnglishSkillName(cb.value));
      });
      
      try {
        const scheduleData = {
          date,
          time,
          location,
          common_disciplines: recordDiscs.length > 0 ? recordDiscs.join(',') : null,
          common_skill_disciplines: skillDiscs.length > 0 ? skillDiscs.join(',') : null
        };
        
        if (scheduleId) {
          // ÏàòÏ†ï
          const { error } = await db
            .from('schedules')
            .update(scheduleData)
            .eq('schedule_id', scheduleId);
          
          if (error) throw error;
          showToast('ÏùºÏ†ïÏù¥ ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§');
        } else {
          // ÏÉàÎ°ú ÏÉùÏÑ±
          const newId = 'SCH_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
          const { error } = await db
            .from('schedules')
            .insert({
              schedule_id: newId,
              instructor_id: currentUser.user_id,
              ...scheduleData
            });
          
          if (error) throw error;
          showToast('ÏùºÏ†ïÏù¥ Îì±Î°ùÎêòÏóàÏäµÎãàÎã§');
        }
        
        closeBottomSheet('sheet-schedule');
        loadScheduleManage();
        loadTodaySchedules();
      } catch (err) {
        console.error('ÏùºÏ†ï Ï†ÄÏû• Ïò§Î•ò:', err);
        showToast('Ï†ÄÏû• Ïã§Ìå®: ' + err.message);
      }
    }

    // ==================== Ï∞∏Í∞ÄÏûê Í¥ÄÎ¶¨ ====================
    async function openParticipants(scheduleId) {
      currentScheduleId = scheduleId;
      const s = allSchedules.find(x => x.schedule_id === scheduleId);
      
      if (s) {
        document.getElementById('participant-schedule-date').textContent = formatDate(s.date) + ' ' + formatTime(s.time);
        document.getElementById('participant-schedule-location').textContent = s.location;
      }
      
      showScreen('screen-participants');
      await loadParticipants();
    }

    async function loadParticipants() {
      try {
        // Ï∞∏Í∞ÄÏûê Î™©Î°ù Ï°∞Ìöå (users ÌÖåÏù¥Î∏îÍ≥º guests ÌÖåÏù¥Î∏î Î™®Îëê Ï°∞Ïù∏)
        const { data: regs, error } = await db
          .from('registrations')
          .select(`
            reg_id,
            student_id,
            guest_id,
            purpose,
            lesson_level,
            attendance,
            session_no,
            users!registrations_student_id_fkey (
              user_id,
              name,
              cert_level
            ),
            guests!registrations_guest_id_fkey (
              guest_id,
              name,
              cert_level,
              in_training_level
            )
          `)
          .eq('schedule_id', currentScheduleId);
        
        if (error) throw error;
        
        const lessons = [];
        const funs = [];
        
        for (const r of (regs || [])) {
          // ÌöåÏõêÏù∏ÏßÄ ÎπÑÌöåÏõêÏù∏ÏßÄ ÌôïÏù∏
          const isGuest = !r.student_id && r.guest_id;
          const participant = {
            reg_id: r.reg_id,
            student_id: r.student_id,
            guest_id: r.guest_id,
            is_guest: isGuest,
            purpose: r.purpose,
            lesson_level: r.lesson_level,
            attendance: r.attendance,
            session_no: r.session_no,
            student_name: isGuest ? (r.guests?.name || 'Ïïå Ïàò ÏóÜÏùå') : (r.users?.name || 'Ïïå Ïàò ÏóÜÏùå'),
            student_cert: isGuest ? (r.guests?.cert_level || 'X') : (r.users?.cert_level || 'X')
          };
          
          if (r.purpose === 'Í∞ïÏäµ') lessons.push(participant);
          else funs.push(participant);
        }
        
        document.getElementById('lesson-participants').innerHTML = lessons.length === 0 
          ? '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">Í∞ïÏäµ Ï∞∏Í∞ÄÏûêÍ∞Ä ÏóÜÏäµÎãàÎã§</div>'
          : lessons.map(p => renderParticipantCard(p)).join('');
        
        document.getElementById('fun-participants').innerHTML = funs.length === 0
          ? '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">ÌéÄÎã§Ïù¥Îπô Ï∞∏Í∞ÄÏûêÍ∞Ä ÏóÜÏäµÎãàÎã§</div>'
          : funs.map(p => renderParticipantCard(p)).join('');
          
      } catch (err) {
        console.error('Ï∞∏Í∞ÄÏûê Î°úÎìú Ïò§Î•ò:', err);
        document.getElementById('lesson-participants').innerHTML = 
          '<div style="text-align: center; color: var(--error); padding: 20px;">Ï∞∏Í∞ÄÏûêÎ•º Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§</div>';
      }
    }

    function renderParticipantCard(p) {
      const attClass = p.attendance === 'Y' ? 'attendance-yes' : p.attendance === 'N' ? 'attendance-no' : 'attendance-pending';
      const attText = p.attendance === 'Y' ? 'Ï∂úÏÑù' : p.attendance === 'N' ? 'Î∂àÏ∞∏' : 'ÎØ∏Ï†ï';
      const guestBadge = p.is_guest ? '<span style="font-size: 11px; color: var(--warning); margin-left: 4px;">(ÎπÑÌöåÏõê)</span>' : '';
      const sessionInfo = p.session_no ? ` ¬∑ ${p.session_no}ÌöåÏ∞®` : '';
      
      return `<div class="participant-card">
        <div class="participant-avatar" style="${p.is_guest ? 'background: var(--lv2-light); color: var(--lv2-color);' : ''}">${p.student_name ? p.student_name.charAt(0) : '?'}</div>
        <div class="participant-info">
          <div class="participant-name">${p.student_name}${guestBadge}</div>
          <div class="participant-detail">Lv.${p.student_cert || 'X'}${p.lesson_level ? ' ¬∑ Lv.' + p.lesson_level + ' ÏàòÍ∞ïÏ§ë' + sessionInfo : ''}</div>
        </div>
        <div class="attendance-badge ${attClass}" onclick="toggleAttendance('${p.reg_id}', '${p.attendance}')" style="cursor: pointer;">${attText}</div>
        <button class="btn-icon-delete" onclick="deleteParticipant('${p.reg_id}')" title="ÏÇ≠Ï†ú">
          <i class="fas fa-times"></i>
        </button>
      </div>`;
    }

    async function deleteParticipant(regId) {
      if (!confirm('Ïù¥ Ï∞∏Í∞ÄÏûêÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
      
      try {
        // Í¥ÄÎ†® Í∏∞Î°ù ÏÇ≠Ï†ú
        await db.from('dive_records').delete().eq('reg_id', regId);
        await db.from('skill_records').delete().eq('reg_id', regId);
        
        // Ï∞∏Í∞ÄÏûê ÏÇ≠Ï†ú
        const { error } = await db
          .from('registrations')
          .delete()
          .eq('reg_id', regId);
        
        if (error) throw error;
        
        showToast('Ï∞∏Í∞ÄÏûêÍ∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§');
        loadParticipants();
      } catch (err) {
        console.error('Ï∞∏Í∞ÄÏûê ÏÇ≠Ï†ú Ïò§Î•ò:', err);
        showToast('ÏÇ≠Ï†ú Ïã§Ìå®: ' + err.message);
      }
    }

    async function toggleAttendance(regId, currentStatus) {
      const nextStatus = currentStatus === 'Y' ? 'N' : currentStatus === 'N' ? 'ÎØ∏Ï†ï' : 'Y';
      
      try {
        const { error } = await db
          .from('registrations')
          .update({ attendance: nextStatus })
          .eq('reg_id', regId);
        
        if (error) throw error;
        await loadParticipants();
      } catch (err) {
        console.error('Ï∂úÏÑù Î≥ÄÍ≤Ω Ïò§Î•ò:', err);
        showToast('Ï∂úÏÑù Î≥ÄÍ≤Ω Ïã§Ìå®');
      }
    }

    async function openAddParticipant() {
      try {
        // ÌöåÏõê(Í∞ïÏäµÏÉù) Î™©Î°ù Ï°∞Ìöå
        const { data: students, error: studentsError } = await db
          .from('users')
          .select('user_id, name, phone')
          .eq('user_type', 'Í∞ïÏäµÏÉù')
          .order('name');
        
        if (studentsError) throw studentsError;
        
        // ÎπÑÌöåÏõê Î™©Î°ù Ï°∞Ìöå
        const { data: guests, error: guestsError } = await db
          .from('guests')
          .select('guest_id, name, phone, cert_level')
          .order('name');
        
        if (guestsError) throw guestsError;
        
        // ÌöåÏõê ÏÑ†ÌÉù ÎìúÎ°≠Îã§Ïö¥
        const memberSelect = document.getElementById('participant-student');
        let memberHtml = '<option value="">ÌöåÏõêÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>';
        for (const s of (students || [])) {
          memberHtml += `<option value="${s.user_id}">${s.name}${s.phone ? ' (' + s.phone + ')' : ''}</option>`;
        }
        memberSelect.innerHTML = memberHtml;
        
        // ÎπÑÌöåÏõê ÏÑ†ÌÉù ÎìúÎ°≠Îã§Ïö¥
        const guestSelect = document.getElementById('participant-guest');
        let guestHtml = '<option value="">ÎπÑÌöåÏõêÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>';
        for (const g of (guests || [])) {
          guestHtml += `<option value="${g.guest_id}">${g.name}${g.phone ? ' (' + g.phone + ')' : ''}</option>`;
        }
        guestSelect.innerHTML = guestHtml;
        
        // Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï (ÌöåÏõê ÌÉ≠ ÏÑ†ÌÉù)
        selectParticipantType('member');
        
        openBottomSheet('sheet-add-participant');
      } catch (err) {
        console.error('Ï∞∏Í∞ÄÏûê Î™©Î°ù Î°úÎìú Ïò§Î•ò:', err);
        showToast('Ï∞∏Í∞ÄÏûê Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§');
      }
    }
    
    function selectParticipantType(type) {
      // ÌÉ≠ ÌôúÏÑ±Ìôî ÏÉÅÌÉú Î≥ÄÍ≤Ω + Ïä§ÌÉÄÏùº ÏóÖÎç∞Ïù¥Ìä∏
      document.querySelectorAll('.participant-type-tab').forEach(tab => {
        const isActive = tab.dataset.type === type;
        tab.classList.toggle('active', isActive);
        if (isActive) {
          tab.style.background = 'var(--primary)';
          tab.style.color = 'white';
          tab.style.borderColor = 'var(--primary)';
        } else {
          tab.style.background = 'var(--surface)';
          tab.style.color = 'var(--text-primary)';
          tab.style.borderColor = 'var(--border)';
        }
      });
      
      // Ìï¥Îãπ ÎìúÎ°≠Îã§Ïö¥ ÌëúÏãú/Ïà®ÍπÄ
      document.getElementById('member-select-group').style.display = type === 'member' ? 'block' : 'none';
      document.getElementById('guest-select-group').style.display = type === 'guest' ? 'block' : 'none';
      
      // ÏÑ†ÌÉù Ï¥àÍ∏∞Ìôî
      document.getElementById('participant-student').value = '';
      document.getElementById('participant-guest').value = '';
    }

    function selectPurpose(btn) {
      document.querySelectorAll('#sheet-add-participant .purpose-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      document.getElementById('lesson-level-group').style.display = btn.dataset.purpose === 'Í∞ïÏäµ' ? 'block' : 'none';
    }

    async function addParticipant() {
      const activeTab = document.querySelector('.participant-type-tab.active');
      const participantType = activeTab?.dataset.type || 'member';
      
      const studentId = participantType === 'member' ? document.getElementById('participant-student').value : null;
      const guestId = participantType === 'guest' ? document.getElementById('participant-guest').value : null;
      
      const purposeBtn = document.querySelector('#sheet-add-participant .purpose-btn.selected');
      const purpose = purposeBtn.dataset.purpose;
      const level = purpose === 'Í∞ïÏäµ' ? parseInt(document.getElementById('participant-level').value) : null;
      
      if (!studentId && !guestId) {
        showToast(participantType === 'member' ? 'ÌöåÏõêÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî' : 'ÎπÑÌöåÏõêÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî');
        return;
      }
      
      try {
        // session_no Í≥ÑÏÇ∞: Í∞ïÏäµ Î™©Ï†ÅÏù¥Í≥† levelÏù¥ 2 ÎòêÎäî 3Ïù∏ Í≤ΩÏö∞
        let sessionNo = null;
        if (purpose === 'Í∞ïÏäµ' && (level === 2 || level === 3)) {
          // Ìï¥Îãπ Ï∞∏Í∞ÄÏûêÏùò Ïù¥Ï†Ñ Í∞ïÏäµ Ï∞∏Ïó¨ ÌöüÏàò Ï°∞Ìöå
          let query = db
            .from('registrations')
            .select('session_no')
            .eq('purpose', 'Í∞ïÏäµ')
            .eq('lesson_level', level);
          
          if (studentId) {
            query = query.eq('student_id', studentId);
          } else {
            query = query.eq('guest_id', guestId);
          }
          
          const { data: prevRegs, error: prevError } = await query;
          
          if (prevError) throw prevError;
          
          // Í∏∞Ï°¥ ÏµúÎåÄ session_no Ï∞æÍ∏∞ (ÏóÜÏúºÎ©¥ 0)
          const maxSessionNo = (prevRegs || []).reduce((max, r) => {
            const sn = r.session_no || 0;
            return sn > max ? sn : max;
          }, 0);
          
          sessionNo = maxSessionNo + 1;
        }
        
        const regId = 'REG_' + (studentId || guestId) + '_' + Date.now();
        const insertData = {
          reg_id: regId,
          schedule_id: currentScheduleId,
          purpose,
          lesson_level: level,
          attendance: 'Y',
          session_no: sessionNo
        };
        
        if (studentId) {
          insertData.student_id = studentId;
        } else {
          insertData.guest_id = guestId;
        }
        
        const { error } = await db
          .from('registrations')
          .insert(insertData);
        
        if (error) throw error;
        
        const sessionMsg = sessionNo ? ` (${sessionNo}ÌöåÏ∞®)` : '';
        showToast(`Ï∞∏Í∞ÄÏûêÍ∞Ä Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§${sessionMsg}`);
        closeBottomSheet('sheet-add-participant');
        await loadParticipants();
      } catch (err) {
        console.error('Ï∞∏Í∞ÄÏûê Ï∂îÍ∞Ä Ïò§Î•ò:', err);
        showToast('Ï∂îÍ∞Ä Ïã§Ìå®: ' + (err.message || 'Ïù¥ÎØ∏ Îì±Î°ùÎêú Ï∞∏Í∞ÄÏûêÏùº Ïàò ÏûàÏäµÎãàÎã§'));
      }
    }

    // ==================== Í∞ïÏäµÏÉù ÏùºÏ†ï ====================
    let availableSchedules = []; // Ïã†Ï≤≠ Í∞ÄÎä•Ìïú Í∞ïÏäµ
    let studentDryRecords = []; // ÎìúÎùºÏù¥ Ìä∏Î†àÏù¥Îãù Í∏∞Î°ù
    let studentMyDryTrainings = []; // Ï∞∏Ïó¨ Ï§ëÏù∏ ÎìúÎùºÏù¥ Ìä∏Î†àÏù¥Îãù
    
    async function loadStudentSchedule() {
      try {
        const today = new Date().toISOString().split('T')[0];
        
        // Ïó¥Î¶∞ ÏùºÏ†ï Ï°∞Ìöå (Î™®Îì† ÏùºÏ†ï - Ï∫òÎ¶∞ÎçîÏö©)
        const { data: schedules, error } = await db
          .from('schedules')
          .select(`
            schedule_id,
            date,
            time,
            location,
            instructor_id,
            users!schedules_instructor_id_fkey (name)
          `)
          .order('date', { ascending: true });
        
        if (error) throw error;
        
        // Ïã†Ï≤≠ Í∞ÄÎä•Ìïú Í∞ïÏäµ Ï†ÄÏû• (Ï∫òÎ¶∞ÎçîÏö©)
        availableSchedules = schedules || [];
        
        // ÎÇ¥Í∞Ä Ïù¥ÎØ∏ Ïã†Ï≤≠Ìïú ÏùºÏ†ï Ï°∞Ìöå (Î™®Îì† ÏùºÏ†ï - Í≥ºÍ±∞ Ìè¨Ìï®)
        const { data: myRegs } = await db
          .from('registrations')
          .select(`
            reg_id,
            schedule_id, 
            purpose,
            schedules (
              schedule_id,
              date,
              time,
              location,
              users!schedules_instructor_id_fkey (name)
            )
          `)
          .eq('student_id', currentUser.user_id);
        
        // ÌïôÏÉù Ï∫òÎ¶∞ÎçîÏö© ÏùºÏ†ï Ï†ÄÏû•
        studentSchedules = myRegs || [];
        
        // ÎìúÎùºÏù¥ Ìä∏Î†àÏù¥Îãù Í∏∞Î°ù Ï°∞Ìöå
        const { data: dryRecords } = await db
          .from('dry_training_records')
          .select('date, dry_id')
          .eq('user_id', currentUser.user_id);
        
        studentDryRecords = dryRecords || [];
        
        // Ï∞∏Ïó¨ Ï§ëÏù∏ ÎìúÎùºÏù¥ Ìä∏Î†àÏù¥Îãù Ï°∞Ìöå
        const { data: allDry } = await db
          .from('dry_trainings')
          .select('dry_id, name, description')
          .contains('participants', [currentUser.user_id]);
        
        studentMyDryTrainings = allDry || [];
        
        const myScheduleIds = myRegs ? myRegs.map(r => r.schedule_id) : [];
        
        // ÎÇ¥Í∞Ä Ïã†Ï≤≠Ìïú ÏùºÏ†ï Ï§ë ÏßÄÎÇú ÏùºÏ†ï
        const pastMySchedules = (myRegs || []).filter(r => r.schedules && r.schedules.date < today);
        
        // ÎØ∏Îûò ÏùºÏ†ïÎßå ÌïÑÌÑ∞ÎßÅ (Î¶¨Ïä§Ìä∏Ïö©)
        const futureSchedules = (schedules || []).filter(s => s.date >= today);
        
        const container = document.getElementById('available-schedules');
        let html = '';
        
        // Îã§Í∞ÄÏò§Îäî ÏùºÏ†ï (Ïó¥Î¶∞ ÏùºÏ†ï)
        if (futureSchedules && futureSchedules.length > 0) {
          html += '<div class="schedule-section-title"><i class="fas fa-arrow-right"></i> Îã§Í∞ÄÏò§Îäî ÏùºÏ†ï</div>';
          for (const s of futureSchedules) {
            const isRegistered = myScheduleIds.includes(s.schedule_id);
            const myReg = myRegs ? myRegs.find(r => r.schedule_id === s.schedule_id) : null;
            
            html += `<div class="card schedule-card">
              <div class="schedule-info">
                <div class="schedule-time">${formatDate(s.date)} ${formatTime(s.time)}</div>
                <div class="schedule-location">${s.location} ¬∑ ${s.users?.name || 'Í∞ïÏÇ¨'}</div>
              </div>
              ${isRegistered 
                ? `<span class="my-schedule-badge" style="cursor: pointer;" onclick="cancelRegistration('${myReg?.reg_id}')">${myReg?.purpose === 'ÌéÄÎã§Ïù¥Îπô' ? 'ÌéÄÎã§Ïù¥Îπô' : 'Í∞ïÏäµ'} Ïã†Ï≤≠ÏôÑÎ£å</span>` 
                : `<button class="btn btn-small btn-primary" onclick="openRegisterSheet('${s.schedule_id}')">Ïã†Ï≤≠</button>`
              }
            </div>`;
          }
        }
        
        // ÏßÄÎÇú ÏùºÏ†ï (ÎÇ¥Í∞Ä Ï∞∏Ïó¨Ìïú Í≤ÉÎßå)
        if (pastMySchedules.length > 0) {
          html += '<div class="schedule-section-title" style="margin-top: 24px;"><i class="fas fa-check"></i> ÏßÄÎÇú ÏùºÏ†ï</div>';
          // ÏµúÏã†Ïàú Ï†ïÎ†¨
          const sortedPast = pastMySchedules.sort((a, b) => b.schedules.date.localeCompare(a.schedules.date));
          for (const r of sortedPast) {
            const s = r.schedules;
            html += `<div class="card schedule-card" style="cursor: pointer;" onclick="openScheduleDetail('${r.reg_id}')">
              <div class="schedule-info">
                <div class="schedule-time">${formatDate(s.date)} ${formatTime(s.time)}</div>
                <div class="schedule-location">${s.location} ¬∑ ${s.users?.name || 'Í∞ïÏÇ¨'}</div>
              </div>
              <span style="color: var(--text-tertiary); font-size: 13px;">${r.purpose} <i class="fas fa-chevron-right"></i></span>
            </div>`;
          }
        }
        
        if (!html) {
          html = '<div class="card" style="text-align: center; color: var(--text-secondary);">ÏùºÏ†ïÏù¥ ÏóÜÏäµÎãàÎã§</div>';
        }
        
        container.innerHTML = html;
        // Ï∫òÎ¶∞ÎçîÌòïÏù¥ Í∏∞Î≥∏Ïù¥ÎØÄÎ°ú Ï∫òÎ¶∞ÎçîÎèÑ Î†åÎçîÎßÅ
        renderStudentCalendar();
      } catch (err) {
        console.error('ÏùºÏ†ï Î°úÎìú Ïò§Î•ò:', err);
        document.getElementById('available-schedules').innerHTML = 
          '<div class="card" style="text-align: center; color: var(--error);">ÏùºÏ†ïÏùÑ Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§</div>';
      }
    }
    
    // ÌïôÏÉù ÏùºÏ†ï ÏÉÅÏÑ∏ ÌôîÎ©¥ Ïó¥Í∏∞
    let currentDetailRegId = null;
    
    async function openScheduleDetail(regId) {
      currentDetailRegId = regId;
      
      try {
        // Îì±Î°ù Ï†ïÎ≥¥ Ï°∞Ìöå (ÏùºÏ†ï Ï†ïÎ≥¥, Í∞ïÏÇ¨ ÌîºÎìúÎ∞±, ÎÇ¥ ÎÖ∏Ìä∏ Ìè¨Ìï®)
        const { data: reg } = await db
          .from('registrations')
          .select(`
            reg_id,
            purpose,
            lesson_level,
            note_instructor,
            note_student,
            schedule_id,
            schedules (
              schedule_id,
              date,
              time,
              location,
              note,
              common_disciplines,
              common_skill_disciplines,
              users!schedules_instructor_id_fkey (name)
            )
          `)
          .eq('reg_id', regId)
          .single();
        
        if (!reg) {
          showToast('ÏùºÏ†ï Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§');
          return;
        }
        
        const s = reg.schedules;
        
        // Í∞ôÏùÄ ÏùºÏ†ïÏùò Îã§Î•∏ Ï∞∏Í∞ÄÏûê Ï°∞Ìöå (lesson_level Ìè¨Ìï®)
        const { data: otherParticipants } = await db
          .from('registrations')
          .select('student_id, purpose, lesson_level, users!registrations_student_id_fkey(name)')
          .eq('schedule_id', reg.schedule_id)
          .neq('student_id', currentUser.user_id);
        
        // Ï∞∏Í∞ÄÏûê Î™©Î°ù ÏÉùÏÑ± (Î™©Ï†ÅÎ≥ÑÎ°ú Î∂ÑÎ•ò)
        const lv3Participants = [];
        const lv2Participants = [];
        const funDiveParticipants = [];
        
        // Î≥∏Ïù∏ Ï∂îÍ∞Ä
        if (reg.purpose === 'ÌéÄÎã§Ïù¥Îπô') {
          funDiveParticipants.push(currentUser.name);
        } else if (reg.lesson_level === 3) {
          lv3Participants.push(currentUser.name);
        } else if (reg.lesson_level === 2) {
          lv2Participants.push(currentUser.name);
        } else {
          // Î†àÎ≤® ÎØ∏ÏßÄÏ†ï Í∞ïÏäµÏùÄ Lv2Î°ú Í∞ÑÏ£º
          lv2Participants.push(currentUser.name);
        }
        
        // Îã§Î•∏ Ï∞∏Í∞ÄÏûê Ï∂îÍ∞Ä
        if (otherParticipants && otherParticipants.length > 0) {
          for (const p of otherParticipants) {
            const name = p.users?.name || 'ÌïôÏÉù';
            if (p.purpose === 'ÌéÄÎã§Ïù¥Îπô') {
              funDiveParticipants.push(name);
            } else if (p.lesson_level === 3) {
              lv3Participants.push(name);
            } else if (p.lesson_level === 2) {
              lv2Participants.push(name);
            } else {
              lv2Participants.push(name);
            }
          }
        }
        
        // Ï∞∏Í∞ÄÏûê HTML ÏÉùÏÑ± (Lv3 ‚Üí Lv2 ‚Üí ÌéÄÎã§Ïù¥Îπô ÏàúÏÑú)
        let participantsHtml = '';
        if (lv3Participants.length > 0) {
          participantsHtml += `
            <div style="display: flex; align-items: flex-start; gap: 8px; color: var(--text-secondary); margin-top: 4px;">
              <i class="fas fa-graduation-cap" style="margin-top: 3px;"></i>
              <span>Lv3 Í∞ïÏäµ: ${lv3Participants.join(', ')}</span>
            </div>
          `;
        }
        if (lv2Participants.length > 0) {
          participantsHtml += `
            <div style="display: flex; align-items: flex-start; gap: 8px; color: var(--text-secondary); margin-top: 4px;">
              <i class="fas fa-graduation-cap" style="margin-top: 3px;"></i>
              <span>Lv2 Í∞ïÏäµ: ${lv2Participants.join(', ')}</span>
            </div>
          `;
        }
        if (funDiveParticipants.length > 0) {
          participantsHtml += `
            <div style="display: flex; align-items: flex-start; gap: 8px; color: var(--text-secondary); margin-top: 4px;">
              <i class="fas fa-water" style="margin-top: 3px;"></i>
              <span>ÌéÄÎã§Ïù¥Îπô: ${funDiveParticipants.join(', ')}</span>
            </div>
          `;
        }
        
        // Ï¢ÖÎ™© ÌëúÏãú
        let disciplinesHtml = '';
        const disciplines = s.common_disciplines ? s.common_disciplines.split(',') : [];
        const skillItems = s.common_skill_disciplines ? s.common_skill_disciplines.split(',') : [];
        
        // Lv2, Lv3 Ïä§ÌÇ¨ Î∂ÑÎ•ò
        const lv2Skills = ['rescue_5_10m', 'theory_test_lv2'];
        const lv3Skills = ['lanyard_remove', 'no_mask_10m', 'rescue_towing', 'neutral_buoyancy', 'freefall', 'arms_only_15m', 'buddy_10_15m', 'theory_test'];
        
        const lv2SkillItems = skillItems.filter(sk => lv2Skills.includes(sk));
        const lv3SkillItems = skillItems.filter(sk => lv3Skills.includes(sk));
        
        if (disciplines.length > 0) {
          disciplinesHtml += `
            <div style="display: flex; align-items: center; gap: 8px; margin-top: 12px; flex-wrap: wrap;">
              <span style="color: var(--text-tertiary); font-size: 13px;">Í∏∞Î°ùÏ¢ÖÎ™©</span>
              ${disciplines.map(d => `<span style="padding: 2px 8px; background: var(--primary-light); color: var(--primary); border-radius: 10px; font-size: 12px;">${d}</span>`).join('')}
            </div>
          `;
        }
        if (lv3SkillItems.length > 0) {
          disciplinesHtml += `
            <div style="display: flex; align-items: center; gap: 8px; margin-top: 8px; flex-wrap: wrap;">
              <span style="color: var(--text-tertiary); font-size: 13px;">Lv3 Ïä§ÌÇ¨</span>
              ${lv3SkillItems.map(sk => `<span style="padding: 2px 8px; background: var(--lv3-light); color: var(--lv3-color); border-radius: 10px; font-size: 12px;">${toKoreanSkillName(sk)}</span>`).join('')}
            </div>
          `;
        }
        if (lv2SkillItems.length > 0) {
          disciplinesHtml += `
            <div style="display: flex; align-items: center; gap: 8px; margin-top: 8px; flex-wrap: wrap;">
              <span style="color: var(--text-tertiary); font-size: 13px;">Lv2 Ïä§ÌÇ¨</span>
              ${lv2SkillItems.map(sk => `<span style="padding: 2px 8px; background: var(--lv2-light); color: var(--lv2-color); border-radius: 10px; font-size: 12px;">${toKoreanSkillName(sk)}</span>`).join('')}
            </div>
          `;
        }
        
        // ÏùºÏ†ï Ï†ïÎ≥¥ ÌëúÏãú
        document.getElementById('schedule-detail-info').innerHTML = `
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
            <i class="fas fa-calendar" style="color: var(--primary);"></i>
            <span style="font-weight: 600;">${formatDate(s.date)} ${formatTime(s.time)}</span>
          </div>
          <div style="display: flex; align-items: center; gap: 8px; color: var(--text-secondary);">
            <i class="fas fa-map-marker-alt"></i>
            <span>${s.location}</span>
          </div>
          <div style="display: flex; align-items: center; gap: 8px; color: var(--text-secondary); margin-top: 4px;">
            <i class="fas fa-user"></i>
            <span>${s.users?.name || 'Í∞ïÏÇ¨'}</span>
          </div>
          ${participantsHtml}
          ${disciplinesHtml}
        `;
        
        // Í∞ïÏÇ¨ ÌîºÎìúÎ∞± ÌëúÏãú
        const instructorNoteSection = document.getElementById('schedule-detail-instructor-note');
        if (reg.note_instructor) {
          document.getElementById('schedule-detail-instructor-note-text').textContent = reg.note_instructor;
          instructorNoteSection.style.display = 'block';
        } else {
          instructorNoteSection.style.display = 'none';
        }
        
        // ÎÇ¥ ÎÖ∏Ìä∏ ÌëúÏãú
        document.getElementById('schedule-detail-my-note').value = reg.note_student || '';
        
        // Í∏∞Î°ù Ï°∞Ìöå Î∞è ÌëúÏãú
        const { data: diveRecords } = await db
          .from('dive_records')
          .select('discipline, attempt, value')
          .eq('reg_id', regId)
          .order('discipline')
          .order('attempt');
        
        const recordsSection = document.getElementById('schedule-detail-records');
        const recordsList = document.getElementById('schedule-detail-records-list');
        
        if (diveRecords && diveRecords.length > 0) {
          // Ï¢ÖÎ™©Î≥ÑÎ°ú Í∑∏Î£πÌïë
          const grouped = {};
          for (const r of diveRecords) {
            if (!grouped[r.discipline]) grouped[r.discipline] = [];
            grouped[r.discipline].push(r);
          }
          
          let recordsHtml = '';
          for (const disc of Object.keys(grouped)) {
            const records = grouped[disc];
            const values = records.map(r => {
              if (disc === 'STA') {
                const min = Math.floor(r.value / 60);
                const sec = Math.floor(r.value % 60);
                return `${min}'${sec.toString().padStart(2, '0')}"`;
              }
              return r.value + 'm';
            });
            recordsHtml += `
              <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--divider);">
                <span style="font-weight: 500;">${disc}</span>
                <span style="color: var(--text-secondary);">${values.join(' / ')}</span>
              </div>
            `;
          }
          recordsList.innerHTML = recordsHtml;
          recordsSection.style.display = 'block';
        } else {
          recordsSection.style.display = 'none';
        }
        
        showScreen('screen-schedule-detail');
      } catch (err) {
        console.error('ÏùºÏ†ï ÏÉÅÏÑ∏ Î°úÎìú Ïò§Î•ò:', err);
        showToast('ÏùºÏ†ï Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§');
      }
    }
    
    // ÌïôÏÉù ÎÖ∏Ìä∏ Ï†ÄÏû•
    async function saveStudentNote() {
      const note = document.getElementById('schedule-detail-my-note').value.trim();
      
      try {
        await db
          .from('registrations')
          .update({ note_student: note || null })
          .eq('reg_id', currentDetailRegId);
        
        showToast('Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§');
      } catch (err) {
        console.error('ÎÖ∏Ìä∏ Ï†ÄÏû• Ïò§Î•ò:', err);
        showToast('Ï†ÄÏû• Ïã§Ìå®: ' + err.message);
      }
    }

    let pendingScheduleId = null;
    
    function openRegisterSheet(scheduleId) {
      pendingScheduleId = scheduleId;
      // Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï
      document.querySelectorAll('#sheet-register .purpose-btn').forEach(b => b.classList.remove('selected'));
      document.querySelector('#sheet-register .purpose-btn[data-purpose="Í∞ïÏäµ"]').classList.add('selected');
      document.getElementById('register-level-group').style.display = 'block';
      document.getElementById('register-level').value = currentUser.in_training_level || '2';
      openBottomSheet('sheet-register');
    }
    
    function selectRegisterPurpose(btn) {
      document.querySelectorAll('#sheet-register .purpose-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      document.getElementById('register-level-group').style.display = btn.dataset.purpose === 'Í∞ïÏäµ' ? 'block' : 'none';
    }

    async function registerSchedule() {
      const purposeBtn = document.querySelector('#sheet-register .purpose-btn.selected');
      const purpose = purposeBtn.dataset.purpose;
      const level = purpose === 'Í∞ïÏäµ' ? parseInt(document.getElementById('register-level').value) : null;
      
      try {
        const regId = 'REG_' + currentUser.user_id + '_' + Date.now();
        const { error } = await db
          .from('registrations')
          .insert({
            reg_id: regId,
            schedule_id: pendingScheduleId,
            student_id: currentUser.user_id,
            purpose,
            lesson_level: level,
            attendance: 'Y'
          });
        
        if (error) throw error;
        
        showToast('ÏùºÏ†ï Ïã†Ï≤≠ ÏôÑÎ£å!');
        closeBottomSheet('sheet-register');
        loadStudentSchedule();
        loadUpcomingSchedules();
      } catch (err) {
        console.error('ÏùºÏ†ï Ïã†Ï≤≠ Ïò§Î•ò:', err);
        showToast('Ïã†Ï≤≠ Ïã§Ìå®: ' + (err.message || 'Ïù¥ÎØ∏ Ïã†Ï≤≠ÌñàÏùÑ Ïàò ÏûàÏäµÎãàÎã§'));
      }
    }

    async function cancelRegistration(regId) {
      if (!confirm('ÏùºÏ†ï Ïã†Ï≤≠ÏùÑ Ï∑®ÏÜåÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
      
      try {
        const { error } = await db
          .from('registrations')
          .delete()
          .eq('reg_id', regId);
        
        if (error) throw error;
        
        showToast('Ïã†Ï≤≠Ïù¥ Ï∑®ÏÜåÎêòÏóàÏäµÎãàÎã§');
        loadStudentSchedule();
        loadUpcomingSchedules();
      } catch (err) {
        console.error('Ïã†Ï≤≠ Ï∑®ÏÜå Ïò§Î•ò:', err);
        showToast('Ï∑®ÏÜå Ïã§Ìå®: ' + err.message);
      }
    }

    // ==================== ÎÇòÏùò Í∏∞Î°ù ====================
    async function loadMyRecords() {
      // ÌÉ≠Î∞î Î†åÎçîÎßÅ
      const isInstructor = currentUser.user_type === 'Í∞ïÏÇ¨';
      document.getElementById('my-records-tabbar').innerHTML = `
        <button class="tab-item" onclick="showScreen('${isInstructor ? 'screen-instructor-home' : 'screen-student-home'}')"><i class="fas fa-home"></i><span>Ìôà</span></button>
        <button class="tab-item" onclick="showScreen('${isInstructor ? 'screen-schedule-manage' : 'screen-student-schedule'}')"><i class="fas fa-calendar"></i><span>ÏùºÏ†ï</span></button>
        <button class="tab-item" onclick="showScreen('${isInstructor ? 'screen-dry-manage' : 'screen-dry-training'}')"><i class="fas fa-dumbbell"></i><span>Ìä∏Î†àÏù¥Îãù</span></button>
        <button class="tab-item active"><i class="fas fa-chart-line"></i><span>ÎÇ¥Í∏∞Î°ù</span></button>
        <button class="tab-item" onclick="showScreen('screen-mypage')"><i class="fas fa-user"></i><span>ÎßàÏù¥</span></button>
      `;
      
      try {
        let allRecords = [];
        
        // 1. Í∞ïÏäµ Í∏∞Î°ù Ï°∞Ìöå (registrations ‚Üí dive_records)
        const { data: regs } = await db
          .from('registrations')
          .select('reg_id, schedule_id')
          .eq('student_id', currentUser.user_id);
        
        if (regs && regs.length > 0) {
          const regIds = regs.map(r => r.reg_id);
          const scheduleIds = regs.map(r => r.schedule_id);
          
          // ÏùºÏ†ï ÎÇ†Ïßú Ï°∞Ìöå
          const { data: schedules } = await db
            .from('schedules')
            .select('schedule_id, date')
            .in('schedule_id', scheduleIds);
          
          const scheduleMap = {};
          for (const s of (schedules || [])) {
            scheduleMap[s.schedule_id] = s.date;
          }
          
          // reg_id ‚Üí schedule_id Îß§Ìïë
          const regToSchedule = {};
          for (const r of regs) {
            regToSchedule[r.reg_id] = r.schedule_id;
          }
          
          // Í∞ïÏäµ Í∏∞Î°ù
          const { data: lessonRecords } = await db
            .from('dive_records')
            .select('record_id, reg_id, discipline, attempt, value, note')
            .in('reg_id', regIds);
          
          for (const r of (lessonRecords || [])) {
            const scheduleId = regToSchedule[r.reg_id];
            const date = scheduleMap[scheduleId] || 'ÎÇ†Ïßú ÏóÜÏùå';
            allRecords.push({
              ...r,
              date,
              type: 'Í∞ïÏäµ'
            });
          }
        }
        
        // 2. Í∞úÏù∏ Í∏∞Î°ù Ï°∞Ìöå (personal_dive_records)
        const { data: personalRecords } = await db
          .from('personal_dive_records')
          .select(`
            record_id,
            personal_schedule_id,
            discipline,
            attempt,
            value,
            personal_schedules!personal_dive_records_personal_schedule_id_fkey (date)
          `)
          .eq('user_id', currentUser.user_id);
        
        for (const r of (personalRecords || [])) {
          allRecords.push({
            record_id: r.record_id,
            discipline: r.discipline,
            attempt: r.attempt,
            value: r.value,
            date: r.personal_schedules?.date || 'ÎÇ†Ïßú ÏóÜÏùå',
            type: 'Í∞úÏù∏'
          });
        }
        
        // Í∏∞Î°ùÏù¥ ÏóÜÎäî Í≤ΩÏö∞
        if (allRecords.length === 0) {
          document.getElementById('my-best-records').innerHTML = 
            '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§</div>';
          document.getElementById('my-all-records').innerHTML = 
            '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§</div>';
          document.getElementById('growth-chart-card').style.display = 'none';
          return;
        }
        
        // ÏÑ±Ïû• Í∑∏ÎûòÌîÑÏö© Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
        allRecordsForChart = allRecords;
        document.getElementById('growth-chart-card').style.display = 'block';
        renderGrowthChart();
        
        // Ï¢ÖÎ™©Î≥Ñ ÏµúÍ≥† Í∏∞Î°ù Í≥ÑÏÇ∞
        const bestByDiscipline = {};
        for (const r of allRecords) {
          const val = parseFloat(r.value) || 0;
          if (!bestByDiscipline[r.discipline] || val > bestByDiscipline[r.discipline]) {
            bestByDiscipline[r.discipline] = val;
          }
        }
        
        const disciplines = ['STA', 'DYNB', 'FIM', 'CWTB', 'DNF', 'CNF', 'DYN', 'CWT'];
        let bestHtml = '';
        for (const d of disciplines) {
          const best = bestByDiscipline[d];
          const val = best ? (d === 'STA' ? best + 's' : best + 'm') : '-';
          bestHtml += `<div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--divider);">
            <span style="font-weight: 500;">${d}</span>
            <span style="color: var(--primary); font-weight: 600;">${val}</span>
          </div>`;
        }
        
        document.getElementById('my-best-records').innerHTML = bestHtml;
        
        // ÎÇ†ÏßúÎ≥Ñ Í∑∏Î£πÌïë (ÎÇ†ÏßúÎ≥Ñ ÏµúÍ≥† Í∏∞Î°ùÎßå)
        const recordsByDate = {};
        for (const r of allRecords) {
          if (!recordsByDate[r.date]) {
            recordsByDate[r.date] = {};
          }
          const val = parseFloat(r.value) || 0;
          if (!recordsByDate[r.date][r.discipline] || val > recordsByDate[r.date][r.discipline].value) {
            recordsByDate[r.date][r.discipline] = {
              value: val,
              type: r.type
            };
          }
        }
        
        // ÎÇ†Ïßú Ï†ïÎ†¨ (ÏµúÏã†Ïàú)
        const sortedDates = Object.keys(recordsByDate).sort((a, b) => b.localeCompare(a));
        
        // Ïó∞ÎèÑÎ≥ÑÎ°ú Í∑∏Î£πÌïë
        const recordsByYear = {};
        for (const date of sortedDates) {
          const year = date.substring(0, 4);
          if (!recordsByYear[year]) {
            recordsByYear[year] = [];
          }
          recordsByYear[year].push(date);
        }
        
        let allHtml = '';
        const sortedYears = Object.keys(recordsByYear).sort((a, b) => b - a);
        
        for (const year of sortedYears) {
          const shortYear = year.substring(2); // '2025' -> '25'
          allHtml += `<div style="font-size: 14px; font-weight: 700; color: var(--text-primary); margin: 16px 0 12px 0; padding-bottom: 8px; border-bottom: 2px solid var(--primary);">
            üìÜ ${shortYear}ÎÖÑ
          </div>`;
          
          for (const date of recordsByYear[year].slice(0, 15)) { // Ïó∞ÎèÑÎãπ ÏµúÎåÄ 15Ïùº
            const dateRecords = recordsByDate[date];
            const dateFormatted = formatDateCompact(date);
            
            allHtml += `<div style="margin-bottom: 12px; margin-left: 8px;">
              <div style="font-size: 13px; color: var(--text-secondary); font-weight: 500; margin-bottom: 6px;">
                ${dateFormatted}
              </div>
              <div style="display: flex; flex-wrap: wrap; gap: 6px;">`;
            
            for (const [disc, data] of Object.entries(dateRecords)) {
              const val = disc === 'STA' ? data.value + 's' : data.value + 'm';
              const typeColor = data.type === 'Í∞úÏù∏' ? 'var(--warning)' : 'var(--primary)';
              allHtml += `<div style="background: var(--bg); padding: 6px 10px; border-radius: 8px; display: flex; align-items: center; gap: 4px;">
                <span style="font-weight: 500; font-size: 12px;">${disc}</span>
                <span style="color: ${typeColor}; font-weight: 600; font-size: 13px;">${val}</span>
              </div>`;
            }
            
            allHtml += `</div></div>`;
          }
        }
        
        document.getElementById('my-all-records').innerHTML = allHtml || 
          '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§</div>';
        
      } catch (err) {
        console.error('Í∏∞Î°ù Î°úÎìú Ïò§Î•ò:', err);
        document.getElementById('my-best-records').innerHTML = 
          '<div style="text-align: center; color: var(--error); padding: 20px;">Í∏∞Î°ùÏùÑ Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§</div>';
      }
    }
    
    function formatDateShort(dateStr) {
      if (!dateStr || dateStr === 'ÎÇ†Ïßú ÏóÜÏùå') return dateStr;
      const d = new Date(dateStr);
      const month = d.getMonth() + 1;
      const day = d.getDate();
      const weekdays = ['Ïùº', 'Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†'];
      const weekday = weekdays[d.getDay()];
      return `${month}Ïõî ${day}Ïùº (${weekday})`;
    }
    
    function formatDateCompact(dateStr) {
      if (!dateStr || dateStr === 'ÎÇ†Ïßú ÏóÜÏùå') return dateStr;
      const d = new Date(dateStr);
      const month = d.getMonth() + 1;
      const day = d.getDate();
      const weekdays = ['Ïùº', 'Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†'];
      const weekday = weekdays[d.getDay()];
      return `${month}/${day} (${weekday})`;
    }

    // ==================== ÏûÑÏãú Ìï®ÏàòÎì§ ====================
    function quickRecordInput() {
      // Í∞úÏù∏ Í∏∞Î°ù ÏûÖÎ†• ÌôîÎ©¥ÏúºÎ°ú Ïù¥Îèô
      document.getElementById('personal-date').value = new Date().toISOString().split('T')[0];
      document.getElementById('personal-location').value = '';
      currentPersonalDiscipline = 'STA';
      personalAttempts = [{ value: '', note: '' }];
      renderPersonalAttempts();
      updatePersonalDisciplineUI();
      showScreen('screen-personal-record');
    }

    // ==================== Í∞ïÏäµ Í∏∞Î°ù ÏûÖÎ†• (Ìëú ÌòïÌÉú) ====================
    let batchParticipants = [];
    let currentBatchDiscipline = 'STA';
    let batchDisciplines = ['STA', 'DYNB', 'FIM', 'CWTB']; // ÏÑ†ÌÉùÎêú Ï¢ÖÎ™©Îì§
    let batchSkillItems = []; // Ïä§ÌÇ¨ Ìï≠Î™©Îì§ (Í∞ïÏäµ Î†àÎ≤®Ïóê Îî∞Îùº)
    let batchAttemptCount = 2;
    let batchRecords = {};
    let batchSkills = {};
    let currentBatchScheduleId = null;
    
    // ÏõêÎ≥∏ Îç∞Ïù¥ÌÑ∞ (Î≥ÄÍ≤Ω Í∞êÏßÄÏö©)
    let batchOriginalRecords = {};
    let batchOriginalSkills = {};
    let batchOriginalScheduleNote = '';
    let batchOriginalStudentNotes = {};

    // ÏßÑÏûÖÏ†ê 1: Ìôà ‚Üí ÏµúÍ∑º Í∞ïÏäµ Í∏∞Î°ù ÏûÖÎ†•
    async function quickRecordInput() {
      if (currentUser.user_type !== 'Í∞ïÏÇ¨') {
        openPersonalRecordAdd();
        return;
      }
      
      try {
        const { data: schedules, error } = await db
          .from('schedules')
          .select('schedule_id, date, time, location')
          .eq('instructor_id', currentUser.user_id)
          .order('date', { ascending: false })
          .limit(5);
        
        if (error) throw error;
        
        if (!schedules || schedules.length === 0) {
          showToast('Îì±Î°ùÎêú ÏùºÏ†ïÏù¥ ÏóÜÏäµÎãàÎã§');
          return;
        }
        
        let html = '';
        for (const s of schedules) {
          html += `<div class="schedule-select-item" onclick="openLessonRecordInput('${s.schedule_id}'); closeBottomSheet('sheet-select-schedule');">
            <div style="font-weight: 600;">${formatDate(s.date)} ${formatTime(s.time)}</div>
            <div style="color: var(--text-secondary); font-size: 14px;">${s.location}</div>
          </div>`;
        }
        document.getElementById('recent-schedule-list').innerHTML = html;
        openBottomSheet('sheet-select-schedule');
      } catch (err) {
        console.error('ÏùºÏ†ï Î°úÎìú Ïò§Î•ò:', err);
        showToast('ÏùºÏ†ïÏùÑ Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§');
      }
    }

    // ÏßÑÏûÖÏ†ê 2: ÏùºÏ†ï Ïπ¥Îìú ‚Üí Í∏∞Î°ù ÏûÖÎ†•
    async function openLessonRecordInput(scheduleId) {
      currentBatchScheduleId = scheduleId;
      
      try {
        const { data: schedule } = await db
          .from('schedules')
          .select('*')
          .eq('schedule_id', scheduleId)
          .single();
        
        if (schedule) {
          document.getElementById('batch-schedule-date').textContent = formatDate(schedule.date) + ' ' + formatTime(schedule.time);
          document.getElementById('batch-schedule-location').textContent = schedule.location;
          
          // ÏùºÏ†ïÏóê Ï†ÄÏû•Îêú Ï¢ÖÎ™© Ï†ïÎ≥¥ ÏÇ¨Ïö© (ÏóÜÏúºÎ©¥ Îπà Î∞∞Ïó¥)
          batchDisciplines = schedule.common_disciplines ? schedule.common_disciplines.split(',') : [];
          
          // Ïä§ÌÇ¨ Ï¢ÖÎ™© (ÏòÅÏñ¥‚ÜíÌïúÍµ≠Ïñ¥ Î≥ÄÌôò)
          if (schedule.common_skill_disciplines) {
            batchSkillItems = schedule.common_skill_disciplines.split(',').map(s => toKoreanSkillName(s));
          } else {
            batchSkillItems = [];
          }
          
          // ÏùºÏ†ï Ï¥ùÌèâ ÎÖ∏Ìä∏ Î°úÎìú
          document.getElementById('batch-schedule-note').value = schedule.note || '';
          batchOriginalScheduleNote = schedule.note || '';
        } else {
          batchDisciplines = [];
          batchSkillItems = [];
          document.getElementById('batch-schedule-note').value = '';
          batchOriginalScheduleNote = '';
        }
        
        const { data: regs, error } = await db
          .from('registrations')
          .select(`
            reg_id,
            student_id,
            purpose,
            lesson_level,
            note_instructor,
            users!registrations_student_id_fkey (name, cert_level)
          `)
          .eq('schedule_id', scheduleId);
        
        if (error) throw error;
        
        if (!regs || regs.length === 0) {
          showToast('Ï∞∏Í∞ÄÏûêÍ∞Ä ÏóÜÏäµÎãàÎã§');
          return;
        }
        
        batchParticipants = regs.map(r => ({
          reg_id: r.reg_id,
          student_id: r.student_id,
          name: r.users?.name || 'Ïïå Ïàò ÏóÜÏùå',
          purpose: r.purpose,
          lesson_level: r.lesson_level,
          note_instructor: r.note_instructor || ''
        }));
        
        // ÌïôÏÉùÎ≥Ñ ÌîºÎìúÎ∞± ÏõêÎ≥∏ Ï†ÄÏû•
        batchOriginalStudentNotes = {};
        for (const p of batchParticipants) {
          batchOriginalStudentNotes[p.reg_id] = p.note_instructor || '';
        }
        
        // Ï¥àÍ∏∞Ìôî
        batchRecords = {};
        batchSkills = {};
        batchOriginalRecords = {};
        batchOriginalSkills = {};
        batchAttemptCount = 2;
        currentBatchDiscipline = batchDisciplines.length > 0 ? batchDisciplines[0] : 'STA';
        
        for (const p of batchParticipants) {
          batchRecords[p.reg_id] = {};
          batchSkills[p.reg_id] = {};
        }
        
        // Í∏∞Ï°¥ Í∏∞Î°ù Î°úÎìú
        await loadExistingBatchRecords();
        
        renderBatchDisciplineTabs();
        renderBatchSelectedDisciplines();
        renderBatchTable();
        renderBatchStudentNotes();
        
        showScreen('screen-batch-record');
      } catch (err) {
        console.error('Í∏∞Î°ù ÏûÖÎ†• Ïò§Î•ò:', err);
        showToast('Ï∞∏Í∞ÄÏûê Î°úÎìú Ïã§Ìå®');
      }
    }
    
    // ÌïôÏÉùÎ≥Ñ ÌîºÎìúÎ∞± ÏûÖÎ†•ÎûÄ Î†åÎçîÎßÅ
    function renderBatchStudentNotes() {
      let html = '';
      for (const p of batchParticipants) {
        html += `
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
            <span style="min-width: 60px; font-size: 14px; color: var(--text-secondary);">${p.name}</span>
            <input type="text" class="input" style="flex: 1; padding: 10px 12px;" 
              id="batch-note-${p.reg_id}" 
              value="${p.note_instructor || ''}" 
              placeholder="ÌîºÎìúÎ∞± ÏûÖÎ†•">
          </div>
        `;
      }
      document.getElementById('batch-student-notes').innerHTML = html;
    }

    // Ïä§ÌÇ¨ Ï¢ÖÎ™© ÏòÅÏñ¥‚ÜîÌïúÍµ≠Ïñ¥ Îß§Ìïë
    const SKILL_NAME_MAP = {
      // ÏòÅÏñ¥ ‚Üí ÌïúÍµ≠Ïñ¥ (DBÏóêÏÑú ÏùΩÏñ¥Ïò¨ Îïå)
      'neutral_buoyancy': 'Ï§ëÏÑ±Î∂ÄÎ†•',
      'freefall': 'ÌîÑÎ¶¨Ìè¥',
      'arms_only_15m': 'ÏïîÏä§Ïò®Î¶¨ 15m',
      'buddy_10_15m': 'Î≤ÑÎîî 10-15m',
      'lanyard_remove': 'Î†åÏïºÎìú Ï†úÍ±∞',
      'no_mask_10m': 'ÎÖ∏ÎßàÏä§ÌÅ¨ 10m',
      'rescue_towing': 'Î†àÏä§ÌÅê+ÌÜ†Ïûâ',
      'theory_test': 'Ïù¥Î°† ÌèâÍ∞Ä',
      'rescue_5_10m': 'Î†àÏä§ÌÅê 5-10m',
      'theory_test_lv2': 'Ïù¥Î°† ÌèâÍ∞Ä',
      // ÌïúÍµ≠Ïñ¥ ‚Üí ÏòÅÏñ¥ (DBÏóê Ï†ÄÏû•Ìï† Îïå)
      'Ï§ëÏÑ±Î∂ÄÎ†•': 'neutral_buoyancy',
      'ÌîÑÎ¶¨Ìè¥': 'freefall',
      'ÏïîÏä§Ïò®Î¶¨ 15m': 'arms_only_15m',
      'Î≤ÑÎîî 10-15m': 'buddy_10_15m',
      'Î†åÏïºÎìú Ï†úÍ±∞': 'lanyard_remove',
      'ÎÖ∏ÎßàÏä§ÌÅ¨ 10m': 'no_mask_10m',
      'Î†àÏä§ÌÅê+ÌÜ†Ïûâ': 'rescue_towing',
      'Ïù¥Î°† ÌèâÍ∞Ä': 'theory_test',
      'Î†àÏä§ÌÅê 5-10m': 'rescue_5_10m'
    };

    // Ïä§ÌÇ¨Î™ÖÏùÑ ÌïúÍµ≠Ïñ¥Î°ú Î≥ÄÌôò
    function toKoreanSkillName(name) {
      return SKILL_NAME_MAP[name] || name;
    }

    // Ïä§ÌÇ¨Î™ÖÏùÑ ÏòÅÏñ¥Î°ú Î≥ÄÌôò (DB Ï†ÄÏû•Ïö©)
    function toEnglishSkillName(name) {
      return SKILL_NAME_MAP[name] || name;
    }

    // Í∏∞Ï°¥ Í∏∞Î°ù Î°úÎìú
    async function loadExistingBatchRecords() {
      const regIds = batchParticipants.map(p => p.reg_id);
      
      try {
        // Îã§Ïù¥Î∏å Í∏∞Î°ù Î°úÎìú
        const { data: diveRecords } = await db
          .from('dive_records')
          .select('*')
          .in('reg_id', regIds);
        
        if (diveRecords) {
          for (const r of diveRecords) {
            if (!batchRecords[r.reg_id]) batchRecords[r.reg_id] = {};
            if (!batchRecords[r.reg_id][r.discipline]) {
              batchRecords[r.reg_id][r.discipline] = { attempts: [], note: '', recordIds: [] };
            }
            
            const attemptIdx = (r.attempt || 1) - 1;
            const valStr = r.value?.toString() || '';
            batchRecords[r.reg_id][r.discipline].attempts[attemptIdx] = valStr;
            // record_id Ï†ÄÏû• (Ïù¥ÎØ∏ Ï†ÄÏû•Îêú Í∏∞Î°ù ÌëúÏãú)
            batchRecords[r.reg_id][r.discipline].recordIds[attemptIdx] = r.record_id;
            if (r.note) {
              batchRecords[r.reg_id][r.discipline].note = r.note;
            }
            
            // ÏãúÎèÑ Ïàò ÏóÖÎç∞Ïù¥Ìä∏
            if (r.attempt > batchAttemptCount) {
              batchAttemptCount = r.attempt;
            }
            
            // Ï¢ÖÎ™© Ï∂îÍ∞Ä
            if (!batchDisciplines.includes(r.discipline)) {
              batchDisciplines.push(r.discipline);
            }
          }
        }
        
        // Ïä§ÌÇ¨ Í∏∞Î°ù Î°úÎìú (ÏãúÎèÑÎ≥ÑÎ°ú)
        const { data: skillRecords } = await db
          .from('skill_records')
          .select('*')
          .in('reg_id', regIds);
        
        if (skillRecords) {
          for (const r of skillRecords) {
            if (!batchSkills[r.reg_id]) batchSkills[r.reg_id] = {};
            
            // ÌïúÍµ≠Ïñ¥Î°ú Î≥ÄÌôò
            const koreanName = toKoreanSkillName(r.discipline);
            
            if (!batchSkills[r.reg_id][koreanName]) {
              batchSkills[r.reg_id][koreanName] = { attempts: [], recordIds: [] };
            }
            
            const attemptIdx = (r.attempt || 1) - 1;
            const result = r.result === 'Y' ? 'Y' : 'N';
            batchSkills[r.reg_id][koreanName].attempts[attemptIdx] = result;
            batchSkills[r.reg_id][koreanName].recordIds[attemptIdx] = r.record_id;
            
            // Ïä§ÌÇ¨ Ï¢ÖÎ™© Ï∂îÍ∞Ä (ÌïúÍµ≠Ïñ¥Î°ú)
            if (!batchSkillItems.includes(koreanName)) {
              batchSkillItems.push(koreanName);
            }
            
            // Ïä§ÌÇ¨ ÏãúÎèÑ Ïàò ÏóÖÎç∞Ïù¥Ìä∏
            if (r.attempt > batchAttemptCount) {
              batchAttemptCount = r.attempt;
            }
          }
        }
        
        // ÏõêÎ≥∏ Îç∞Ïù¥ÌÑ∞ ÍπäÏùÄ Î≥µÏÇ¨ (Î≥ÄÍ≤Ω Í∞êÏßÄÏö©)
        batchOriginalRecords = JSON.parse(JSON.stringify(batchRecords));
        batchOriginalSkills = JSON.parse(JSON.stringify(batchSkills));
        
      } catch (err) {
        console.error('Í∏∞Ï°¥ Í∏∞Î°ù Î°úÎìú Ïò§Î•ò:', err);
      }
    }

    function renderBatchDisciplineTabs() {
      // Lv2, Lv3 Ïä§ÌÇ¨ Î∂ÑÎ•ò
      const lv2SkillNames = ['Î†àÏä§ÌÅê 5-10m', 'Ïù¥Î°† ÌèâÍ∞Ä'];
      const lv3SkillNames = ['Î†åÏïºÎìú Ï†úÍ±∞', 'ÎÖ∏ÎßàÏä§ÌÅ¨ 10m', 'Î†àÏä§ÌÅê+ÌÜ†Ïûâ', 'Ï§ëÏÑ±Î∂ÄÎ†•', 'ÌîÑÎ¶¨Ìè¥', 'ÏïîÏä§Ïò®Î¶¨ 15m', 'Î≤ÑÎîî 10-15m'];
      
      const lv2Skills = batchSkillItems.filter(sk => lv2SkillNames.includes(sk));
      let lv3Skills = batchSkillItems.filter(sk => lv3SkillNames.includes(sk));
      // Ïù¥Î°† ÌèâÍ∞Ä Ï≤òÎ¶¨ (Lv2Ïóê ÏóÜÏúºÎ©¥ Lv3Ïóê Ï∂îÍ∞Ä)
      if (batchSkillItems.includes('Ïù¥Î°† ÌèâÍ∞Ä') && !lv2Skills.includes('Ïù¥Î°† ÌèâÍ∞Ä')) {
        lv3Skills.push('Ïù¥Î°† ÌèâÍ∞Ä');
      }
      
      let html = '<div style="display: flex; flex-wrap: wrap; gap: 6px;">';
      
      // Í∏∞Î°ù Ï¢ÖÎ™©
      for (const disc of batchDisciplines) {
        const active = disc === currentBatchDiscipline ? 'active' : '';
        html += `<button class="batch-disc-tag ${active}" onclick="selectBatchDiscipline('${disc}')">${disc}</button>`;
      }
      
      // Lv3 Ïä§ÌÇ¨ Î®ºÏ†Ä
      for (const skill of lv3Skills) {
        const active = currentBatchDiscipline === skill ? 'active' : '';
        html += `<button class="batch-skill-tag lv3 ${active}" onclick="selectBatchDiscipline('${skill}')">${skill}</button>`;
      }
      
      // Lv2 Ïä§ÌÇ¨
      for (const skill of lv2Skills) {
        const active = currentBatchDiscipline === skill ? 'active' : '';
        html += `<button class="batch-skill-tag lv2 ${active}" onclick="selectBatchDiscipline('${skill}')">${skill}</button>`;
      }
      
      html += '</div>';
      document.getElementById('batch-discipline-tabs').innerHTML = html;
    }

    function renderBatchSelectedDisciplines() {
      // ÏÉÅÎã® Ïπ¥ÎìúÏóêÏÑú Ï¢ÖÎ™© ÌëúÏãú Ï†úÍ±∞Îê® - Ïù¥Ï†ú ÏÇ¨Ïö©ÌïòÏßÄ ÏïäÏùå
    }

    function openBatchAddDisciplineSheet() {
      const allDiscs = ['STA', 'DYNB', 'FIM', 'CWTB', 'DNF', 'CNF', 'DYN', 'CWT'];
      const allSkills = {
        'Lv2': ['Î†àÏä§ÌÅê 5-10m', 'Ïù¥Î°† ÌèâÍ∞Ä'],
        'Lv3': ['Î†åÏïºÎìú Ï†úÍ±∞', 'ÎÖ∏ÎßàÏä§ÌÅ¨ 10m', 'Î†àÏä§ÌÅê+ÌÜ†Ïûâ', 'Ï§ëÏÑ±Î∂ÄÎ†•', 'ÌîÑÎ¶¨Ìè¥', 'ÏïîÏä§Ïò®Î¶¨ 15m', 'Î≤ÑÎîî 10-15m', 'Ïù¥Î°† ÌèâÍ∞Ä']
      };
      
      // Ï∞∏Í∞ÄÏûêÎì§Ïùò Î†àÏä® Î†àÎ≤® ÌôïÏù∏
      const lessonLevels = batchParticipants.filter(p => p.purpose === 'Í∞ïÏäµ').map(p => p.lesson_level);
      const hasLv2 = lessonLevels.includes(2);
      const hasLv3 = lessonLevels.includes(3);
      
      let html = '<div style="margin-bottom: 20px;">';
      html += '<div style="font-weight: 600; margin-bottom: 12px;">Í∏∞Î°ù Ï¢ÖÎ™©</div>';
      html += '<div style="display: flex; flex-wrap: wrap; gap: 4px;">';
      
      for (const d of allDiscs) {
        const checked = batchDisciplines.includes(d) ? 'checked' : '';
        html += `<label style="display: inline-flex; align-items: center; gap: 6px; padding: 8px 12px;">
          <input type="checkbox" value="${d}" data-type="disc" ${checked}> ${d}
        </label>`;
      }
      html += '</div></div>';
      
      // Ïä§ÌÇ¨ Ï¢ÖÎ™©
      if (hasLv2 || hasLv3) {
        html += '<div style="border-top: 1px solid var(--divider); padding-top: 16px;">';
        html += '<div style="font-weight: 600; margin-bottom: 12px;">Ïä§ÌÇ¨ Ï¢ÖÎ™©</div>';
        
        if (hasLv2) {
          html += '<div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">Lv2</div>';
          html += '<div style="display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 12px;">';
          for (const s of allSkills['Lv2']) {
            const checked = batchSkillItems.includes(s) ? 'checked' : '';
            html += `<label style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px;">
              <input type="checkbox" value="${s}" data-type="skill" ${checked}> ${s}
            </label>`;
          }
          html += '</div>';
        }
        
        if (hasLv3) {
          html += '<div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">Lv3</div>';
          html += '<div style="display: flex; flex-wrap: wrap; gap: 4px;">';
          for (const s of allSkills['Lv3']) {
            const checked = batchSkillItems.includes(s) ? 'checked' : '';
            html += `<label style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px;">
              <input type="checkbox" value="${s}" data-type="skill" ${checked}> ${s}
            </label>`;
          }
          html += '</div>';
        }
        html += '</div>';
      }
      
      document.getElementById('batch-add-discipline-options').innerHTML = html;
      openBottomSheet('sheet-batch-add-discipline');
    }

    function confirmBatchAddDiscipline() {
      const selectedDiscs = [];
      const selectedSkills = [];
      
      document.querySelectorAll('#batch-add-discipline-options input:checked').forEach(cb => {
        if (cb.dataset.type === 'disc') {
          selectedDiscs.push(cb.value);
        } else if (cb.dataset.type === 'skill') {
          selectedSkills.push(cb.value);
        }
      });
      
      if (selectedDiscs.length === 0) {
        showToast('ÏµúÏÜå 1Í∞ú Í∏∞Î°ù Ï¢ÖÎ™©ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî');
        return;
      }
      
      batchDisciplines = selectedDiscs;
      batchSkillItems = selectedSkills;
      
      // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú Ï¢ÖÎ™©Ïù¥ Ïú†Ìö®ÌïòÏßÄ ÏïäÏúºÎ©¥ Ï≤´ Î≤àÏß∏Î°ú Î≥ÄÍ≤Ω
      const allDisciplines = [...batchDisciplines, ...batchSkillItems];
      if (!allDisciplines.includes(currentBatchDiscipline)) {
        currentBatchDiscipline = batchDisciplines[0] || batchSkillItems[0];
      }
      
      closeBottomSheet('sheet-batch-add-discipline');
      renderBatchDisciplineTabs();
      renderBatchSelectedDisciplines();
      renderBatchTable();
    }

    function closeBatchRecord() {
      if (currentBatchScheduleId) {
        currentScheduleId = currentBatchScheduleId;
        showScreen('screen-schedule-manage');
      } else {
        goBack();
      }
    }

    function selectBatchDiscipline(disc) {
      saveBatchCurrentInput();
      currentBatchDiscipline = disc;
      renderBatchDisciplineTabs();
      renderBatchTable();
    }

    function updateBatchDisciplineUI() {
      renderBatchDisciplineTabs();
      renderBatchTable();
    }

    function renderBatchTable() {
      // Ï¢ÖÎ™©Ïù¥ ÏóÜÏúºÎ©¥ ÏïàÎÇ¥ Î©îÏãúÏßÄ
      if (batchDisciplines.length === 0 && batchSkillItems.length === 0) {
        document.getElementById('batch-record-table-card').style.display = 'block';
        document.getElementById('batch-skill-table-card').style.display = 'none';
        document.getElementById('batch-record-tbody').innerHTML = `
          <tr><td colspan="5" style="text-align: center; padding: 40px; color: var(--text-tertiary);">
            Ï¢ÖÎ™©Ïù¥ ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.<br>+ ÏàòÏ†ï Î≤ÑÌäºÏùÑ ÎàåÎü¨ Ï¢ÖÎ™©ÏùÑ Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî.
          </td></tr>`;
        document.querySelector('#batch-record-table thead').innerHTML = '<tr><th></th></tr>';
        return;
      }
      
      // Ïä§ÌÇ¨ Ï¢ÖÎ™©Ïù∏ÏßÄ ÌôïÏù∏
      const isSkillDiscipline = batchSkillItems.includes(currentBatchDiscipline);
      
      // Í∏∞Î°ù ÌÖåÏù¥Î∏îÎßå ÏÇ¨Ïö© (Ïä§ÌÇ¨ ÌÖåÏù¥Î∏î Ïà®ÍπÄ)
      document.getElementById('batch-record-table-card').style.display = 'block';
      document.getElementById('batch-skill-table-card').style.display = 'none';
      
      // Ìó§Îçî Î†åÎçîÎßÅ
      let headerHtml = '<tr><th class="col-name">ÌïôÏÉùÎ™Ö</th>';
      for (let i = 1; i <= batchAttemptCount; i++) {
        headerHtml += `<th class="col-attempt">${i}Ï∞®</th>`;
      }
      headerHtml += `<th class="col-add-attempt"><button class="btn-add-col" onclick="addBatchAttemptColumn()">+</button></th>`;
      if (!isSkillDiscipline) {
        headerHtml += '<th class="col-note">Î©îÎ™®</th>';
      }
      headerHtml += '</tr>';
      document.querySelector('#batch-record-table thead').innerHTML = headerHtml;
      
      // Î∞îÎîî Î†åÎçîÎßÅ
      let bodyHtml = '';
      for (const p of batchParticipants) {
        // Ïä§ÌÇ¨Ïù¥Î©¥ Í∞ïÏäµÏÉùÎßå ÌëúÏãú
        if (isSkillDiscipline && p.purpose !== 'Í∞ïÏäµ') continue;
        
        bodyHtml += `<tr data-reg-id="${p.reg_id}">
          <td class="col-name">${p.name}</td>`;
        
        if (isSkillDiscipline) {
          // Ïä§ÌÇ¨ Ï¢ÖÎ™©: Y/N Î≤ÑÌäº
          const skills = batchSkills[p.reg_id]?.[currentBatchDiscipline] || { attempts: [] };
          for (let i = 0; i < batchAttemptCount; i++) {
            const val = skills.attempts[i] || '';
            const successClass = val === 'Y' ? 'success' : '';
            const failClass = val === 'N' ? 'fail' : '';
            bodyHtml += `<td>
              <button class="skill-check-btn ${successClass} ${failClass}" 
                      onclick="toggleSkillAttempt('${p.reg_id}', ${i}, this)"
                      data-attempt="${i}">
                ${val === 'Y' ? '‚úì' : val === 'N' ? '‚úó' : '-'}
              </button>
            </td>`;
          }
          bodyHtml += `<td></td></tr>`;
        } else {
          // Í∏∞Î°ù Ï¢ÖÎ™©: Ïà´Ïûê ÏûÖÎ†•
          const records = batchRecords[p.reg_id]?.[currentBatchDiscipline] || { attempts: [], note: '' };
          for (let i = 0; i < batchAttemptCount; i++) {
            const val = records.attempts[i] || '';
            bodyHtml += `<td><input type="number" value="${val}" data-attempt="${i}" placeholder="-"></td>`;
          }
          bodyHtml += `<td></td>`;
          bodyHtml += `<td><input type="text" class="note-input" value="${records.note || ''}" data-note="true" placeholder=""></td>
          </tr>`;
        }
      }
      
      document.getElementById('batch-record-tbody').innerHTML = bodyHtml;
    }
    
    // Ïä§ÌÇ¨ ÏãúÎèÑ ÌÜ†Í∏Ä (Y ‚Üí N ‚Üí ÎπàÍ∞í ÏàúÌôò)
    function toggleSkillAttempt(regId, attemptIdx, btn) {
      if (!batchSkills[regId]) batchSkills[regId] = {};
      if (!batchSkills[regId][currentBatchDiscipline]) {
        batchSkills[regId][currentBatchDiscipline] = { attempts: [], recordIds: [] };
      }
      
      const current = batchSkills[regId][currentBatchDiscipline].attempts[attemptIdx] || '';
      let next = '';
      
      if (current === '') next = 'Y';
      else if (current === 'Y') next = 'N';
      else next = '';
      
      batchSkills[regId][currentBatchDiscipline].attempts[attemptIdx] = next;
      
      btn.className = 'skill-check-btn ' + (next === 'Y' ? 'success' : next === 'N' ? 'fail' : '');
      btn.textContent = next === 'Y' ? '‚úì' : next === 'N' ? '‚úó' : '-';
    }

    function addBatchAttemptColumn() {
      saveBatchCurrentInput();
      batchAttemptCount++;
      renderBatchTable();
    }

    function saveBatchCurrentInput() {
      const isSkillDiscipline = batchSkillItems.includes(currentBatchDiscipline);
      if (isSkillDiscipline) return; // Ïä§ÌÇ¨ÏùÄ Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú Ï¶âÏãú Ï†ÄÏû•Îê®
      
      const rows = document.querySelectorAll('#batch-record-tbody tr');
      rows.forEach(row => {
        const regId = row.dataset.regId;
        if (!regId) return;
        
        if (!batchRecords[regId]) batchRecords[regId] = {};
        if (!batchRecords[regId][currentBatchDiscipline]) {
          batchRecords[regId][currentBatchDiscipline] = { attempts: [], note: '' };
        }
        
        const inputs = row.querySelectorAll('input');
        const attempts = [];
        let note = '';
        
        inputs.forEach(input => {
          if (input.dataset.note) {
            note = input.value;
          } else if (input.dataset.attempt !== undefined) {
            attempts[parseInt(input.dataset.attempt)] = input.value;
          }
        });
        
        batchRecords[regId][currentBatchDiscipline] = { attempts, note };
      });
    }

    async function saveBatchRecords(finish = false) {
      saveBatchCurrentInput();
      
      try {
        let totalSaved = 0;
        let totalUpdated = 0;
        let totalDeleted = 0;
        
        // ===== Îã§Ïù¥Î∏å Í∏∞Î°ù Ï≤òÎ¶¨ =====
        for (const regId of Object.keys(batchRecords)) {
          for (const discipline of Object.keys(batchRecords[regId])) {
            const data = batchRecords[regId][discipline];
            const originalData = batchOriginalRecords[regId]?.[discipline] || { attempts: [], recordIds: [] };
            
            for (let i = 0; i < Math.max(data.attempts.length, originalData.attempts.length); i++) {
              const newVal = data.attempts[i] || '';
              const oldVal = originalData.attempts[i] || '';
              const existingRecordId = originalData.recordIds?.[i];
              
              // Í∞íÏù¥ ÏóÜÏñ¥ÏßÑ Í≤ΩÏö∞ (ÏÇ≠Ï†ú)
              if (oldVal && !newVal && existingRecordId) {
                await db.from('dive_records').delete().eq('record_id', existingRecordId);
                totalDeleted++;
              }
              // ÏÉàÎ°úÏö¥ Í∞í (Ï∂îÍ∞Ä)
              else if (newVal && !existingRecordId) {
                const recordId = 'DR_' + regId + '_' + discipline + '_' + Date.now() + '_' + i + '_' + Math.random().toString(36).substr(2, 5);
                await db.from('dive_records').insert({
                  record_id: recordId,
                  reg_id: regId,
                  discipline: discipline,
                  attempt: i + 1,
                  value: parseFloat(newVal),
                  note: i === 0 ? data.note : null
                });
                totalSaved++;
              }
              // Í∞íÏù¥ Î≥ÄÍ≤ΩÎêú Í≤ΩÏö∞ (ÏóÖÎç∞Ïù¥Ìä∏)
              else if (newVal && existingRecordId && newVal !== oldVal) {
                await db.from('dive_records').update({
                  value: parseFloat(newVal),
                  note: i === 0 ? data.note : null
                }).eq('record_id', existingRecordId);
                totalUpdated++;
              }
              // ÎÖ∏Ìä∏Îßå Î≥ÄÍ≤ΩÎêú Í≤ΩÏö∞
              else if (i === 0 && newVal && existingRecordId && data.note !== originalData.note) {
                await db.from('dive_records').update({ note: data.note || null }).eq('record_id', existingRecordId);
                totalUpdated++;
              }
            }
          }
        }
        
        // ===== Ïä§ÌÇ¨ Í∏∞Î°ù Ï≤òÎ¶¨ =====
        for (const regId of Object.keys(batchSkills)) {
          for (const skillName of Object.keys(batchSkills[regId])) {
            const data = batchSkills[regId][skillName];
            if (!data || !data.attempts) continue;
            
            const originalData = batchOriginalSkills[regId]?.[skillName] || { attempts: [], recordIds: [] };
            const englishName = toEnglishSkillName(skillName);
            
            for (let i = 0; i < Math.max(data.attempts.length, originalData.attempts.length); i++) {
              const newVal = data.attempts[i] || '';
              const oldVal = originalData.attempts[i] || '';
              const existingRecordId = originalData.recordIds?.[i];
              
              // Í∞íÏù¥ ÏóÜÏñ¥ÏßÑ Í≤ΩÏö∞ (ÏÇ≠Ï†ú)
              if (oldVal && !newVal && existingRecordId) {
                await db.from('skill_records').delete().eq('record_id', existingRecordId);
                totalDeleted++;
              }
              // ÏÉàÎ°úÏö¥ Í∞í (Ï∂îÍ∞Ä)
              else if (newVal && !existingRecordId) {
                const recordId = 'SR_' + regId + '_' + Date.now() + '_' + i + '_' + Math.random().toString(36).substr(2, 5);
                await db.from('skill_records').insert({
                  record_id: recordId,
                  reg_id: regId,
                  discipline: englishName,
                  attempt: i + 1,
                  result: newVal === 'Y' ? 'Y' : 'N',
                  note: null
                });
                totalSaved++;
              }
              // Í∞íÏù¥ Î≥ÄÍ≤ΩÎêú Í≤ΩÏö∞ (ÏóÖÎç∞Ïù¥Ìä∏)
              else if (newVal && existingRecordId && newVal !== oldVal) {
                await db.from('skill_records').update({
                  result: newVal === 'Y' ? 'Y' : 'N'
                }).eq('record_id', existingRecordId);
                totalUpdated++;
              }
            }
          }
        }
        
        // ===== ÎÖ∏Ìä∏ Ï≤òÎ¶¨ (Î≥ÄÍ≤ΩÎêú Í≤ΩÏö∞Îßå) =====
        const scheduleNote = document.getElementById('batch-schedule-note').value.trim();
        if (scheduleNote !== batchOriginalScheduleNote) {
          await db.from('schedules').update({ note: scheduleNote || null }).eq('schedule_id', currentBatchScheduleId);
        }
        
        for (const p of batchParticipants) {
          const noteInput = document.getElementById(`batch-note-${p.reg_id}`);
          const noteValue = noteInput ? noteInput.value.trim() : '';
          const originalNote = batchOriginalStudentNotes[p.reg_id] || '';
          
          if (noteValue !== originalNote) {
            await db.from('registrations').update({ note_instructor: noteValue || null }).eq('reg_id', p.reg_id);
          }
        }
        
        // Users Best Í∏∞Î°ù ÏóÖÎç∞Ïù¥Ìä∏ (Î≥ÄÍ≤ΩÏù¥ ÏûàÏùÑ ÎïåÎßå)
        if (totalSaved > 0 || totalUpdated > 0 || totalDeleted > 0) {
          await updateUsersBestRecords();
          await updateLvProgress();
        }
        
        const totalChanges = totalSaved + totalUpdated + totalDeleted;
        if (totalChanges > 0) {
          showToast(`Ï†ÄÏû• ÏôÑÎ£å (Ï∂îÍ∞Ä: ${totalSaved}, ÏàòÏ†ï: ${totalUpdated}, ÏÇ≠Ï†ú: ${totalDeleted})`);
        } else {
          showToast('Î≥ÄÍ≤ΩÏÇ¨Ìï≠Ïù¥ ÏóÜÏäµÎãàÎã§');
        }
        
        if (finish) {
          closeBatchRecord();
        } else {
          // DBÏóêÏÑú Îã§Ïãú Î°úÎìúÌï¥ÏÑú UI Í∞±Ïã†
          batchRecords = {};
          batchSkills = {};
          for (const p of batchParticipants) {
            batchRecords[p.reg_id] = {};
            batchSkills[p.reg_id] = {};
          }
          await loadExistingBatchRecords();
          renderBatchTable();
        }
      } catch (err) {
        console.error('Ï†ÄÏû• Ïò§Î•ò:', err);
        showToast('Ï†ÄÏû• Ïã§Ìå®: ' + err.message);
      }
    }
    
    // Users Best Í∏∞Î°ù ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò (Î™®Îì† ÌïôÏÉù ÎåÄÏÉÅ)
    async function updateUsersBestRecords() {
      try {
        const studentIds = [...new Set(batchParticipants.map(p => p.student_id))];
        
        const { data: students } = await db
          .from('users')
          .select('user_id, best_sta, best_dynb, best_fim, best_cwtb')
          .in('user_id', studentIds);
        
        if (!students) return;
        
        for (const student of students) {
          const participant = batchParticipants.find(p => p.student_id === student.user_id);
          if (!participant) continue;
          
          const regId = participant.reg_id;
          const diveRecords = batchRecords[regId] || {};
          
          const updates = {};
          for (const disc of ['STA', 'DYNB', 'FIM', 'CWTB']) {
            const data = diveRecords[disc];
            if (!data || !data.attempts) continue;
            
            const maxValue = Math.max(...data.attempts.filter(v => v && v !== '').map(v => parseFloat(v)));
            if (isNaN(maxValue) || maxValue <= 0) continue;
            
            const bestKey = 'best_' + disc.toLowerCase();
            const currentBest = student[bestKey] || 0;
            
            if (maxValue > currentBest) {
              updates[bestKey] = maxValue;
            }
          }
          
          if (Object.keys(updates).length > 0) {
            await db
              .from('users')
              .update(updates)
              .eq('user_id', student.user_id);
          }
        }
      } catch (err) {
        console.error('Best Í∏∞Î°ù ÏóÖÎç∞Ïù¥Ìä∏ Ïò§Î•ò:', err);
      }
    }
    
    // LV Progress ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò (Î†àÎ≤® Í≥ºÏ†ï Ï§ëÏù∏ ÌïôÏÉùÎßå)
    async function updateLvProgress() {
      try {
        const studentIds = [...new Set(batchParticipants.map(p => p.student_id))];
        
        const { data: students } = await db
          .from('users')
          .select('user_id, in_training_level')
          .in('user_id', studentIds);
        
        if (!students) return;
        
        for (const student of students) {
          const level = student.in_training_level;
          if (!level || (level !== 2 && level !== 3)) continue;
          
          const participant = batchParticipants.find(p => p.student_id === student.user_id);
          if (!participant) continue;
          
          const regId = participant.reg_id;
          const tableName = level === 2 ? 'lv2_progress' : 'lv3_progress';
          const req = LEVEL_REQUIREMENTS[level];
          
          // ÌòÑÏû¨ ÏßÑÎèÑ Ï°∞Ìöå
          let { data: progress } = await db
            .from(tableName)
            .select('*')
            .eq('user_id', student.user_id)
            .single();
          
          // ÏßÑÎèÑ Î†àÏΩîÎìúÍ∞Ä ÏóÜÏúºÎ©¥ ÏÉùÏÑ±
          if (!progress) {
            const { data: newProgress } = await db
              .from(tableName)
              .insert({ user_id: student.user_id })
              .select()
              .single();
            progress = newProgress || {};
          }
          
          const updates = {};
          
          // Í∏∞Î°ù Ï¢ÖÎ™© ÏóÖÎç∞Ïù¥Ìä∏ (STA, DYNB, FIM, CWTB)
          const diveRecords = batchRecords[regId] || {};
          for (const disc of ['STA', 'DYNB', 'FIM', 'CWTB']) {
            const data = diveRecords[disc];
            if (!data || !data.attempts) continue;
            
            const maxValue = Math.max(...data.attempts.filter(v => v && v !== '').map(v => parseFloat(v)));
            if (isNaN(maxValue) || maxValue <= 0) continue;
            
            const key = disc.toLowerCase();
            const currentValue = progress[key] || 0;
            
            if (maxValue > currentValue) {
              updates[key] = maxValue;
            }
          }
          
          // Ïä§ÌÇ¨ Ï¢ÖÎ™© ÏóÖÎç∞Ïù¥Ìä∏
          const skillRecords = batchSkills[regId] || {};
          for (const skill of req.skills) {
            const koreanName = toKoreanSkillName(skill.key);
            const skillData = skillRecords[koreanName];
            
            if (!skillData || !skillData.attempts) continue;
            
            // ÏãúÎèÑ ÌöüÏàò Í≥ÑÏÇ∞ (Y ÎòêÎäî NÏù¥ ÏûàÎäî ÏãúÎèÑÎßå)
            const attemptCount = skillData.attempts.filter(v => v === 'Y' || v === 'N').length;
            if (attemptCount > 0) {
              const attemptKey = skill.key + '_attempts';
              const currentAttempts = progress[attemptKey] || 0;
              updates[attemptKey] = currentAttempts + attemptCount;
            }
            
            // ÏÑ±Í≥µÏù¥ ÌïòÎÇòÎùºÎèÑ ÏûàÏúºÎ©¥ YÎ°ú ÏóÖÎç∞Ïù¥Ìä∏
            const hasSuccess = skillData.attempts.some(v => v === 'Y');
            if (hasSuccess && progress[skill.key] !== 'Y') {
              updates[skill.key] = 'Y';
            }
          }
          
          // Í∞ïÏäµ ÌöüÏàò ÏóÖÎç∞Ïù¥Ìä∏ (Í∞ïÏäµ Î™©Ï†ÅÏù∏ Í≤ΩÏö∞Îßå)
          if (participant.purpose === 'Í∞ïÏäµ') {
            const currentLessonCount = progress.lesson_count || 0;
            updates.lesson_count = currentLessonCount + 1;
          }
          
          if (Object.keys(updates).length > 0) {
            await db
              .from(tableName)
              .update(updates)
              .eq('user_id', student.user_id);
          }
        }
      } catch (err) {
        console.error('LV Progress ÏóÖÎç∞Ïù¥Ìä∏ Ïò§Î•ò:', err);
      }
    }

    // ==================== Í∞úÏù∏ Í∏∞Î°ù ÏûÖÎ†• ====================
    let personalDate = '';
    let personalTime = '';
    let personalLocation = '';
    let personalDisciplines = ['STA', 'DYNB', 'FIM', 'CWTB'];
    let personalAttemptCount = 2;
    let personalRecords = {}; // { discipline: [val1, val2, ...] }
    let personalMemo = '';

    // Í∞úÎ≥Ñ Ï∂îÍ∞Ä ÏßÑÏûÖÏ†ê
    function openPersonalRecordAdd() {
      document.getElementById('personal-add-date').value = new Date().toISOString().split('T')[0];
      document.getElementById('personal-add-time').value = '';
      document.getElementById('personal-add-location').value = '';
      
      // Ï≤¥ÌÅ¨Î∞ïÏä§ Ï¥àÍ∏∞Ìôî
      document.querySelectorAll('#personal-discipline-checks input').forEach(cb => {
        cb.checked = ['STA', 'DYNB', 'FIM', 'CWTB'].includes(cb.value);
      });
      
      openBottomSheet('sheet-personal-add');
    }

    function startPersonalRecordInput() {
      personalDate = document.getElementById('personal-add-date').value;
      personalTime = document.getElementById('personal-add-time').value;
      personalLocation = document.getElementById('personal-add-location').value;
      
      if (!personalDate) {
        showToast('ÎÇ†ÏßúÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî');
        return;
      }
      
      // ÏÑ†ÌÉùÎêú Ï¢ÖÎ™©
      personalDisciplines = [];
      document.querySelectorAll('#personal-discipline-checks input:checked').forEach(cb => {
        personalDisciplines.push(cb.value);
      });
      
      if (personalDisciplines.length === 0) {
        showToast('Ï¢ÖÎ™©ÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî');
        return;
      }
      
      // Ï¥àÍ∏∞Ìôî
      personalAttemptCount = 2;
      personalRecords = {};
      for (const d of personalDisciplines) {
        personalRecords[d] = [];
      }
      personalMemo = '';
      
      closeBottomSheet('sheet-personal-add');
      renderPersonalRecordScreen();
      showScreen('screen-personal-record');
    }

    function renderPersonalRecordScreen() {
      // ÎÇ†Ïßú/Ïû•ÏÜå ÌëúÏãú
      document.getElementById('personal-date-display').textContent = formatDate(personalDate) + (personalTime ? ' ' + formatTime(personalTime) : '');
      document.getElementById('personal-location-display').textContent = personalLocation || 'Ïû•ÏÜå ÎØ∏ÏûÖÎ†•';
      
      // ÌÖåÏù¥Î∏î Ìó§Îçî
      let headerHtml = '<tr><th class="col-name">Ï¢ÖÎ™©</th>';
      for (let i = 1; i <= personalAttemptCount; i++) {
        headerHtml += `<th class="col-attempt">${i}Ï∞®</th>`;
      }
      headerHtml += '</tr>';
      document.querySelector('#personal-record-table thead').innerHTML = headerHtml;
      
      // ÌÖåÏù¥Î∏î Î∞îÎîî
      let bodyHtml = '';
      for (const disc of personalDisciplines) {
        const records = personalRecords[disc] || [];
        
        bodyHtml += `<tr data-disc="${disc}">
          <td class="col-name">${disc}</td>`;
        
        for (let i = 0; i < personalAttemptCount; i++) {
          const val = records[i] || '';
          bodyHtml += `<td><input type="number" value="${val}" data-attempt="${i}" placeholder="-"></td>`;
        }
        
        bodyHtml += '</tr>';
      }
      
      document.getElementById('personal-record-tbody').innerHTML = bodyHtml;
      document.getElementById('personal-memo').value = personalMemo;
    }

    function addPersonalAttemptColumn() {
      savePersonalCurrentInput();
      personalAttemptCount++;
      renderPersonalRecordScreen();
    }

    function openAddDisciplineSheet() {
      const allDiscs = ['STA', 'DYNB', 'FIM', 'CWTB', 'DNF', 'CNF', 'DYN', 'CWT'];
      let html = '';
      
      for (const d of allDiscs) {
        const checked = personalDisciplines.includes(d) ? 'checked disabled' : '';
        html += `<label style="display: flex; align-items: center; gap: 8px; padding: 8px;">
          <input type="checkbox" value="${d}" ${checked}> ${d}
        </label>`;
      }
      
      document.getElementById('add-discipline-options').innerHTML = html;
      openBottomSheet('sheet-add-discipline');
    }

    function confirmAddDiscipline() {
      document.querySelectorAll('#add-discipline-options input:checked:not(:disabled)').forEach(cb => {
        if (!personalDisciplines.includes(cb.value)) {
          personalDisciplines.push(cb.value);
          personalRecords[cb.value] = [];
        }
      });
      
      closeBottomSheet('sheet-add-discipline');
      renderPersonalRecordScreen();
    }

    function openPersonalDateEdit() {
      const newDate = prompt('ÎÇ†Ïßú (YYYY-MM-DD):', personalDate);
      if (newDate) {
        personalDate = newDate;
        renderPersonalRecordScreen();
      }
    }

    function savePersonalCurrentInput() {
      const rows = document.querySelectorAll('#personal-record-tbody tr');
      rows.forEach(row => {
        const disc = row.dataset.disc;
        if (!disc) return;
        
        const inputs = row.querySelectorAll('input');
        const attempts = [];
        
        inputs.forEach(input => {
          if (input.dataset.attempt !== undefined) {
            attempts[parseInt(input.dataset.attempt)] = input.value;
          }
        });
        
        personalRecords[disc] = attempts;
      });
      
      personalMemo = document.getElementById('personal-memo')?.value || '';
    }

    async function savePersonalRecord(finish = false) {
      savePersonalCurrentInput();
      personalMemo = document.getElementById('personal-memo').value.trim();
      
      try {
        const personalScheduleId = 'PS_' + currentUser.user_id + '_' + Date.now();
        
        const { error: scheduleError } = await db
          .from('personal_schedules')
          .insert({
            personal_schedule_id: personalScheduleId,
            date: personalDate,
            time: personalTime || null,
            location: personalLocation || null,
            common_disciplines: personalDisciplines.join(','),
            note: personalMemo || null
          });
        
        if (scheduleError) throw scheduleError;
        
        let totalSaved = 0;
        
        for (const disc of Object.keys(personalRecords)) {
          const attempts = personalRecords[disc];
          
          for (let i = 0; i < attempts.length; i++) {
            const val = attempts[i];
            if (!val || val === '') continue;
            
            const recordId = 'PDR_' + currentUser.user_id + '_' + Date.now() + '_' + disc + '_' + i;
            
            const { error } = await db
              .from('personal_dive_records')
              .insert({
                record_id: recordId,
                personal_schedule_id: personalScheduleId,
                user_id: currentUser.user_id,
                discipline: disc,
                attempt: i + 1,
                value: parseFloat(val)
              });
            
            if (!error) totalSaved++;
          }
        }
        
        showToast(`${totalSaved}Í∞ú Í∏∞Î°ùÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§`);
        
        if (finish) {
          showScreen('screen-my-records');
        } else {
          personalRecords = {};
          for (const d of personalDisciplines) {
            personalRecords[d] = [];
          }
          renderPersonalRecordScreen();
        }
      } catch (err) {
        console.error('Í∞úÏù∏ Í∏∞Î°ù Ï†ÄÏû• Ïò§Î•ò:', err);
        showToast('Ï†ÄÏû• Ïã§Ìå®: ' + err.message);
      }
    }

    // ==================== Í∞úÏù∏ Í∏∞Î°ù ÏùºÍ¥Ñ Ï∂îÍ∞Ä ====================
    let bulkDates = [];
    let currentBulkDateIndex = 0;
    let bulkRecords = {};
    let bulkDisciplines = ['CWTB', 'FIM'];
    let bulkAttemptCount = 2;

    function openPersonalBulkAdd() {
      bulkDates = [{ date: '', location: '' }];
      bulkRecords = {};
      bulkDisciplines = ['CWTB', 'FIM'];
      bulkAttemptCount = 2;
      renderBulkDateList();
      renderBulkTabbar();
      showScreen('screen-personal-bulk');
    }

    function renderBulkTabbar() {
      const isInstructor = currentUser.user_type === 'Í∞ïÏÇ¨';
      const html = `
        <button class="tab-item" onclick="showScreen('${isInstructor ? 'screen-instructor-home' : 'screen-student-home'}')"><i class="fas fa-home"></i><span>Ìôà</span></button>
        <button class="tab-item" onclick="showScreen('${isInstructor ? 'screen-schedule-manage' : 'screen-student-schedule'}')"><i class="fas fa-calendar"></i><span>ÏùºÏ†ï</span></button>
        <button class="tab-item active"><i class="fas fa-chart-line"></i><span>ÎÇ¥Í∏∞Î°ù</span></button>
        <button class="tab-item" onclick="showScreen('screen-mypage')"><i class="fas fa-user"></i><span>ÎßàÏù¥</span></button>
      `;
      const tabbar1 = document.getElementById('bulk-tabbar');
      const tabbar2 = document.getElementById('bulk-input-tabbar');
      if (tabbar1) tabbar1.innerHTML = html;
      if (tabbar2) tabbar2.innerHTML = html;
    }

    function renderBulkDateList() {
      let html = '';
      bulkDates.forEach((d, idx) => {
        html += `<div class="card" style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px; padding: 12px;">
          <input type="text" class="input" style="flex: 0.4;" placeholder="YYMMDD" value="${d.date}" 
                 onchange="bulkDates[${idx}].date = this.value">
          <input type="text" class="input" style="flex: 0.6;" placeholder="Ïû•ÏÜå" value="${d.location}"
                 onchange="bulkDates[${idx}].location = this.value">
          ${bulkDates.length > 1 ? `<button class="attempt-delete" onclick="removeBulkDateRow(${idx})"><i class="fas fa-times"></i></button>` : ''}
        </div>`;
      });
      document.getElementById('bulk-date-list').innerHTML = html;
    }

    function addBulkDateRow() {
      bulkDates.push({ date: '', location: '' });
      renderBulkDateList();
    }

    function removeBulkDateRow(idx) {
      bulkDates.splice(idx, 1);
      renderBulkDateList();
    }

    function proceedToBulkRecordInput() {
      bulkDates = bulkDates.filter(d => d.date && d.date.length === 6);
      
      if (bulkDates.length === 0) {
        showToast('ÎÇ†ÏßúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî (YYMMDD ÌòïÏãù)');
        return;
      }
      
      currentBulkDateIndex = 0;
      bulkRecords = {};
      bulkAttemptCount = 2;
      
      for (let i = 0; i < bulkDates.length; i++) {
        bulkRecords[i] = {};
        for (const d of bulkDisciplines) {
          bulkRecords[i][d] = [];
        }
      }
      
      renderBulkDateTabs();
      renderBulkRecordTable();
      renderBulkTabbar();
      showScreen('screen-personal-bulk-input');
    }

    function renderBulkDateTabs() {
      let html = '';
      bulkDates.forEach((d, idx) => {
        const label = d.date.substring(0, 2) + '-' + d.date.substring(2, 4) + '-' + d.date.substring(4, 6) + ' ' + (d.location || '');
        const active = idx === currentBulkDateIndex ? 'active' : '';
        html += `<button class="participant-tab ${active}" onclick="selectBulkDate(${idx})">${label}</button>`;
      });
      document.getElementById('bulk-date-tabs').innerHTML = html;
    }

    function selectBulkDate(idx) {
      saveBulkCurrentInput();
      currentBulkDateIndex = idx;
      renderBulkDateTabs();
      renderBulkRecordTable();
    }

    function renderBulkRecordTable() {
      // Ìó§Îçî
      let headerHtml = '<tr><th class="col-name">Ï¢ÖÎ™©</th>';
      for (let i = 1; i <= bulkAttemptCount; i++) {
        headerHtml += `<th class="col-attempt">${i}Ï∞®</th>`;
      }
      headerHtml += `<th class="col-add-attempt"><button class="btn-add-col" onclick="addBulkAttemptColumn()">+</button></th></tr>`;
      document.querySelector('#bulk-record-table thead').innerHTML = headerHtml;
      
      // Î∞îÎîî
      let bodyHtml = '';
      for (const disc of bulkDisciplines) {
        const records = bulkRecords[currentBulkDateIndex]?.[disc] || [];
        
        bodyHtml += `<tr data-disc="${disc}">
          <td class="col-name">${disc}</td>`;
        
        for (let i = 0; i < bulkAttemptCount; i++) {
          bodyHtml += `<td><input type="number" value="${records[i] || ''}" data-attempt="${i}" placeholder="-"></td>`;
        }
        
        bodyHtml += `<td></td></tr>`;
      }
      
      document.getElementById('bulk-record-tbody').innerHTML = bodyHtml;
    }

    function addBulkAttemptColumn() {
      saveBulkCurrentInput();
      bulkAttemptCount++;
      renderBulkRecordTable();
    }

    function openBulkAddDisciplineSheet() {
      const allDiscs = ['STA', 'DYNB', 'FIM', 'CWTB', 'DNF', 'CNF', 'DYN', 'CWT'];
      let html = '';
      
      for (const d of allDiscs) {
        const checked = bulkDisciplines.includes(d) ? 'checked' : '';
        html += `<label style="display: flex; align-items: center; gap: 8px; padding: 8px;">
          <input type="checkbox" value="${d}" ${checked}> ${d}
        </label>`;
      }
      
      document.getElementById('bulk-add-discipline-options').innerHTML = html;
      openBottomSheet('sheet-bulk-add-discipline');
    }

    function confirmBulkAddDiscipline() {
      const selected = [];
      document.querySelectorAll('#bulk-add-discipline-options input:checked').forEach(cb => {
        selected.push(cb.value);
      });
      
      if (selected.length === 0) {
        showToast('ÏµúÏÜå 1Í∞ú Ï¢ÖÎ™©ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî');
        return;
      }
      
      // ÏÉàÎ°ú Ï∂îÍ∞ÄÎêú Ï¢ÖÎ™© Ï¥àÍ∏∞Ìôî
      for (const disc of selected) {
        if (!bulkDisciplines.includes(disc)) {
          for (let i = 0; i < bulkDates.length; i++) {
            if (!bulkRecords[i]) bulkRecords[i] = {};
            bulkRecords[i][disc] = [];
          }
        }
      }
      
      bulkDisciplines = selected;
      closeBottomSheet('sheet-bulk-add-discipline');
      renderBulkRecordTable();
    }

    function saveBulkCurrentInput() {
      const rows = document.querySelectorAll('#bulk-record-tbody tr');
      rows.forEach(row => {
        const disc = row.dataset.disc;
        if (!disc) return;
        
        const inputs = row.querySelectorAll('input');
        const attempts = [];
        
        inputs.forEach(input => {
          if (input.dataset.attempt !== undefined) {
            attempts[parseInt(input.dataset.attempt)] = input.value;
          }
        });
        
        if (!bulkRecords[currentBulkDateIndex]) bulkRecords[currentBulkDateIndex] = {};
        bulkRecords[currentBulkDateIndex][disc] = attempts;
      });
    }

    async function saveBulkRecords(finish = false) {
      saveBulkCurrentInput();
      
      try {
        let totalSaved = 0;
        
        for (let dateIdx = 0; dateIdx < bulkDates.length; dateIdx++) {
          const dateInfo = bulkDates[dateIdx];
          const fullDate = '20' + dateInfo.date.substring(0, 2) + '-' + dateInfo.date.substring(2, 4) + '-' + dateInfo.date.substring(4, 6);
          
          const personalScheduleId = 'PS_' + currentUser.user_id + '_' + Date.now() + '_' + dateIdx;
          
          await db.from('personal_schedules').insert({
            personal_schedule_id: personalScheduleId,
            date: fullDate,
            time: null,
            location: dateInfo.location || null,
            common_disciplines: bulkDisciplines.join(',')
          });
          
          const dateRecords = bulkRecords[dateIdx] || {};
          
          for (const disc of Object.keys(dateRecords)) {
            const attempts = dateRecords[disc];
            
            for (let i = 0; i < attempts.length; i++) {
              const val = attempts[i];
              if (!val || val === '') continue;
              
              const recordId = 'PDR_' + currentUser.user_id + '_' + Date.now() + '_' + dateIdx + '_' + disc + '_' + i;
              
              const { error } = await db.from('personal_dive_records').insert({
                record_id: recordId,
                personal_schedule_id: personalScheduleId,
                user_id: currentUser.user_id,
                discipline: disc,
                attempt: i + 1,
                value: parseFloat(val)
              });
              
              if (!error) totalSaved++;
            }
          }
        }
        
        showToast(`${totalSaved}Í∞ú Í∏∞Î°ùÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§`);
        
        if (finish) {
          showScreen('screen-my-records');
        }
      } catch (err) {
        console.error('ÏùºÍ¥Ñ Ï†ÄÏû• Ïò§Î•ò:', err);
        showToast('Ï†ÄÏû• Ïã§Ìå®: ' + err.message);
      }
    }

    // ==================== ÏÑ±Ïû• Í∑∏ÎûòÌîÑ ====================
    let growthChart = null;
    let currentChartDiscipline = 'STA';
    let allRecordsForChart = [];

    function selectChartDiscipline(disc) {
      currentChartDiscipline = disc;
      document.querySelectorAll('#chart-discipline-tabs .disc-tab').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.disc === disc);
      });
      renderGrowthChart();
    }

    function renderGrowthChart() {
      const ctx = document.getElementById('growth-chart');
      if (!ctx) return;
      
      const discRecords = allRecordsForChart.filter(r => r.discipline === currentChartDiscipline);
      
      if (discRecords.length === 0) {
        if (growthChart) {
          growthChart.destroy();
          growthChart = null;
        }
        return;
      }
      
      const dateMap = {};
      for (const r of discRecords) {
        const val = parseFloat(r.value) || 0;
        if (!dateMap[r.date] || val > dateMap[r.date]) {
          dateMap[r.date] = val;
        }
      }
      
      const sortedDates = Object.keys(dateMap).sort();
      const labels = sortedDates.map(d => {
        const date = new Date(d);
        return (date.getMonth() + 1) + '/' + date.getDate();
      });
      const data = sortedDates.map(d => dateMap[d]);
      
      if (growthChart) {
        growthChart.destroy();
      }
      
      growthChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: currentChartDiscipline,
            data: data,
            borderColor: '#3182F6',
            backgroundColor: 'rgba(49, 130, 246, 0.1)',
            borderWidth: 2,
            tension: 0.3,
            fill: true,
            pointRadius: 4,
            pointBackgroundColor: '#3182F6'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, grid: { color: '#E5E8EB' } },
            x: { grid: { display: false } }
          }
        }
      });
    }

    function toggleChecklist(type) {
      // Ïä§ÌÇ¨Í≥º Í∏∞Î°ù Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏ Îëò Îã§ ÌïúÎ≤àÏóê ÌÜ†Í∏Ä
      const skillsChecklist = document.getElementById('skills-checklist');
      const skillsIcon = document.getElementById('skills-toggle-icon');
      const recordsChecklist = document.getElementById('records-checklist');
      const recordsIcon = document.getElementById('records-toggle-icon');
      
      // ÌòÑÏû¨ ÏÉÅÌÉú ÌôïÏù∏ (Îëò Ï§ë ÌïòÎÇòÎùºÎèÑ Ïó¥Î†§ÏûàÏúºÎ©¥ Îã´Í∏∞, Îëò Îã§ Îã´ÌòÄÏûàÏúºÎ©¥ Ïó¥Í∏∞)
      const isAnyOpen = (skillsChecklist && skillsChecklist.classList.contains('open')) || 
                        (recordsChecklist && recordsChecklist.classList.contains('open'));
      
      if (isAnyOpen) {
        // Îëò Îã§ Îã´Í∏∞
        if (skillsChecklist) skillsChecklist.classList.remove('open');
        if (skillsIcon) skillsIcon.classList.remove('open');
        if (recordsChecklist) recordsChecklist.classList.remove('open');
        if (recordsIcon) recordsIcon.classList.remove('open');
      } else {
        // Îëò Îã§ Ïó¥Í∏∞
        if (skillsChecklist) skillsChecklist.classList.add('open');
        if (skillsIcon) skillsIcon.classList.add('open');
        if (recordsChecklist) recordsChecklist.classList.add('open');
        if (recordsIcon) recordsIcon.classList.add('open');
      }
    }

    // ==================== ÎìúÎùºÏù¥ Ìä∏Î†àÏù¥Îãù ====================
    let allDryTrainings = [];
    let myDryParticipations = [];
    let currentDryId = null;

    // Í∞ïÏÇ¨: ÎìúÎùºÏù¥ Ìä∏Î†àÏù¥Îãù Í¥ÄÎ¶¨ Î°úÎìú
    async function loadDryManage() {
      try {
        const { data, error } = await db
          .from('dry_trainings')
          .select('*')
          .eq('instructor_id', currentUser.user_id)
          .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        const container = document.getElementById('dry-training-list');
        
        if (!data || data.length === 0) {
          container.innerHTML = `<div class="card" style="text-align: center; padding: 40px;">
            <i class="fas fa-lungs" style="font-size: 48px; color: var(--text-tertiary); margin-bottom: 16px;"></i>
            <p style="color: var(--text-secondary); margin-bottom: 16px;">Îì±Î°ùÎêú Ìä∏Î†àÏù¥ÎãùÏù¥ ÏóÜÏäµÎãàÎã§</p>
            <button class="btn btn-primary" onclick="openDryForm()">+ ÏÉà Ìä∏Î†àÏù¥Îãù Ï∂îÍ∞Ä</button>
          </div>`;
          return;
        }
        
        let html = '';
        for (const d of data) {
          // participants Î∞∞Ïó¥ Í∏∏Ïù¥Î°ú Ï∞∏Ïó¨Ïûê Ïàò Í≥ÑÏÇ∞
          const participantCount = d.participants ? d.participants.length : 0;
          
          html += `<div class="card" style="margin-bottom: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: start;">
              <div style="flex: 1;">
                <div style="font-weight: 600; margin-bottom: 4px;">${d.name}</div>
                <div style="font-size: 13px; color: var(--text-secondary);">${d.description || 'ÏÑ§Î™Ö ÏóÜÏùå'}</div>
                <div style="font-size: 12px; color: var(--text-tertiary); margin-top: 8px;">
                  <i class="fas fa-users"></i> Ï∞∏Ïó¨Ïûê ${participantCount}Î™Ö
                </div>
              </div>
              <div style="display: flex; gap: 8px;">
                <button class="icon-btn" onclick="openDryForm('${d.dry_id}')"><i class="fas fa-pen"></i></button>
                <button class="icon-btn" onclick="deleteDryTraining('${d.dry_id}')"><i class="fas fa-trash"></i></button>
              </div>
            </div>
          </div>`;
        }
        
        container.innerHTML = html;
      } catch (err) {
        console.error('ÎìúÎùºÏù¥ Ìä∏Î†àÏù¥Îãù Î°úÎìú Ïò§Î•ò:', err);
      }
    }

    // Í∞ïÏÇ¨: ÎìúÎùºÏù¥ Ìä∏Î†àÏù¥Îãù Ìèº Ïó¥Í∏∞
    function openDryForm(dryId = null) {
      document.getElementById('edit-dry-id').value = dryId || '';
      document.getElementById('dry-form-title').textContent = dryId ? 'Ìä∏Î†àÏù¥Îãù ÏàòÏ†ï' : 'ÏÉà Ìä∏Î†àÏù¥Îãù Ï∂îÍ∞Ä';
      
      if (dryId) {
        // ÏàòÏ†ï Ïãú Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        db.from('dry_trainings').select('*').eq('dry_id', dryId).single()
          .then(({ data }) => {
            if (data) {
              document.getElementById('dry-name').value = data.name;
              document.getElementById('dry-description').value = data.description || '';
            }
          });
      } else {
        document.getElementById('dry-name').value = '';
        document.getElementById('dry-description').value = '';
      }
      
      openBottomSheet('sheet-dry-form');
    }

    // Í∞ïÏÇ¨: ÎìúÎùºÏù¥ Ìä∏Î†àÏù¥Îãù Ï†ÄÏû•
    async function saveDryTraining() {
      const dryId = document.getElementById('edit-dry-id').value;
      const name = document.getElementById('dry-name').value.trim();
      const description = document.getElementById('dry-description').value.trim();
      
      if (!name) {
        showToast('Ìä∏Î†àÏù¥Îãù Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî');
        return;
      }
      
      try {
        if (dryId) {
          // ÏàòÏ†ï
          const { error } = await db
            .from('dry_trainings')
            .update({ name, description })
            .eq('dry_id', dryId);
          if (error) throw error;
          showToast('ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§');
        } else {
          // Ï∂îÍ∞Ä
          const { error } = await db
            .from('dry_trainings')
            .insert({ name, description, instructor_id: currentUser.user_id });
          if (error) throw error;
          showToast('Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§');
        }
        
        closeBottomSheet('sheet-dry-form');
        loadDryManage();
      } catch (err) {
        console.error('Ï†ÄÏû• Ïò§Î•ò:', err);
        showToast('Ï†ÄÏû• Ïã§Ìå®: ' + err.message);
      }
    }

    // Í∞ïÏÇ¨: ÎìúÎùºÏù¥ Ìä∏Î†àÏù¥Îãù ÏÇ≠Ï†ú
    async function deleteDryTraining(dryId) {
      if (!confirm('Ïù¥ Ìä∏Î†àÏù¥ÎãùÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
      
      try {
        // Í¥ÄÎ†® Í∏∞Î°ùÎèÑ ÏÇ≠Ï†ú
        await db.from('dry_training_records').delete().eq('dry_id', dryId);
        const { error } = await db.from('dry_trainings').delete().eq('dry_id', dryId);
        if (error) throw error;
        
        showToast('ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§');
        loadDryManage();
      } catch (err) {
        console.error('ÏÇ≠Ï†ú Ïò§Î•ò:', err);
        showToast('ÏÇ≠Ï†ú Ïã§Ìå®: ' + err.message);
      }
    }

    // ==================== Ìä∏Î†àÏù¥Îãù ÌÉ≠ Ï†ÑÌôò ====================
    let currentTrainingTab = 'dry';
    let imageTrainingCategories = [];
    
    function switchTrainingTab(tab) {
      currentTrainingTab = tab;
      
      // ÌÉ≠ Î≤ÑÌäº Ïä§ÌÉÄÏùº Î≥ÄÍ≤Ω
      document.querySelectorAll('.training-tab').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tab);
      });
      
      // ÏΩòÌÖêÏ∏† ÌëúÏãú/Ïà®ÍπÄ
      document.getElementById('dry-training-content').style.display = tab === 'dry' ? 'block' : 'none';
      document.getElementById('image-training-content').style.display = tab === 'image' ? 'block' : 'none';
      
      // Ïù¥ÎØ∏ÏßÄ ÌÉ≠ ÏÑ†ÌÉù Ïãú Îç∞Ïù¥ÌÑ∞ Î°úÎìú
      if (tab === 'image' && imageTrainingCategories.length === 0) {
        loadImageTrainingCategories();
      }
    }
    
    // Ïù¥ÎØ∏ÏßÄ Ìä∏Î†àÏù¥Îãù Ïπ¥ÌÖåÍ≥†Î¶¨ Î°úÎìú
    async function loadImageTrainingCategories() {
      const container = document.getElementById('image-training-categories');
      
      try {
        const { data: categories, error } = await db
          .from('image_training_categories')
          .select('*')
          .order('sort_order', { ascending: true });
        
        if (error) throw error;
        
        imageTrainingCategories = categories || [];
        
        if (imageTrainingCategories.length === 0) {
          container.innerHTML = `<div class="card" style="text-align: center; color: var(--text-secondary); padding: 30px;">
            Îì±Î°ùÎêú ÎèôÏûë Í∞ÄÏù¥ÎìúÍ∞Ä ÏóÜÏäµÎãàÎã§
          </div>`;
          return;
        }
        
        let html = '';
        for (const cat of imageTrainingCategories) {
          html += `<div class="image-category-card" onclick="openImageTrainingDetail('${cat.category_id}')">
            <div class="category-icon">${cat.icon || 'üìñ'}</div>
            <div class="category-info">
              <div class="category-name">${cat.name}</div>
              <div class="category-desc">${cat.description || ''}</div>
            </div>
            <i class="fas fa-chevron-right category-arrow"></i>
          </div>`;
        }
        
        container.innerHTML = html;
      } catch (err) {
        console.error('Ïù¥ÎØ∏ÏßÄ Ìä∏Î†àÏù¥Îãù Ïπ¥ÌÖåÍ≥†Î¶¨ Î°úÎìú Ïò§Î•ò:', err);
        container.innerHTML = `<div class="card" style="text-align: center; color: var(--error); padding: 20px;">
          Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§
        </div>`;
      }
    }
    
    // Ïù¥ÎØ∏ÏßÄ Ìä∏Î†àÏù¥Îãù ÏÉÅÏÑ∏ Î≥¥Í∏∞
    async function openImageTrainingDetail(categoryId) {
      const category = imageTrainingCategories.find(c => c.category_id === categoryId);
      if (category) {
        document.getElementById('image-training-detail-title').textContent = category.name;
      }
      
      showScreen('screen-image-training-detail');
      
      const container = document.getElementById('image-training-steps');
      container.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';
      
      try {
        const { data: steps, error } = await db
          .from('image_training_steps')
          .select('*')
          .eq('category_id', categoryId)
          .order('step_order', { ascending: true });
        
        if (error) throw error;
        
        if (!steps || steps.length === 0) {
          container.innerHTML = `<div class="card" style="text-align: center; color: var(--text-secondary); padding: 30px;">
            Îì±Î°ùÎêú Îã®Í≥ÑÍ∞Ä ÏóÜÏäµÎãàÎã§
          </div>`;
          return;
        }
        
        let html = '';
        for (const step of steps) {
          html += `<div class="training-step-card">
            <div class="step-image-container">
              ${step.image_url 
                ? `<img src="${step.image_url}" alt="${step.title}" loading="lazy">`
                : `<i class="fas fa-image step-image-placeholder"></i>`
              }
            </div>
            <div class="step-content">
              <div class="step-title">
                <span class="step-number">${step.step_order}</span>
                <span class="step-title-text">${step.title}</span>
              </div>
              ${step.description ? `<div class="step-description">${step.description}</div>` : ''}
              ${step.tips ? `<div class="step-tips"><i class="fas fa-lightbulb"></i>${step.tips}</div>` : ''}
            </div>
          </div>`;
        }
        
        container.innerHTML = html;
      } catch (err) {
        console.error('Ïù¥ÎØ∏ÏßÄ Ìä∏Î†àÏù¥Îãù Ïä§ÌÖù Î°úÎìú Ïò§Î•ò:', err);
        container.innerHTML = `<div class="card" style="text-align: center; color: var(--error); padding: 20px;">
          Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§
        </div>`;
      }
    }
    
    // ==================== Í∞ïÏÇ¨Ïö© Ìä∏Î†àÏù¥Îãù ÌÉ≠ Ï†ÑÌôò ====================
    let currentInstructorTrainingTab = 'dry';
    
    function switchInstructorTrainingTab(tab) {
      currentInstructorTrainingTab = tab;
      
      // ÌÉ≠ Î≤ÑÌäº Ïä§ÌÉÄÏùº Î≥ÄÍ≤Ω
      document.querySelectorAll('#screen-dry-manage .training-tab').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tab);
      });
      
      // ÏΩòÌÖêÏ∏† ÌëúÏãú/Ïà®ÍπÄ
      document.getElementById('instructor-dry-content').style.display = tab === 'dry' ? 'block' : 'none';
      document.getElementById('instructor-image-content').style.display = tab === 'image' ? 'block' : 'none';
      
      // Ï∂îÍ∞Ä Î≤ÑÌäº ÌëúÏãú/Ïà®ÍπÄ (ÎìúÎùºÏù¥Îßå Ï∂îÍ∞Ä Í∞ÄÎä•)
      document.getElementById('instructor-training-add-btn').style.display = tab === 'dry' ? 'block' : 'none';
      
      // Ïù¥ÎØ∏ÏßÄ ÌÉ≠ ÏÑ†ÌÉù Ïãú Îç∞Ïù¥ÌÑ∞ Î°úÎìú
      if (tab === 'image') {
        loadInstructorImageCategories();
      }
    }
    
    // Í∞ïÏÇ¨Ïö© Ïù¥ÎØ∏ÏßÄ Ìä∏Î†àÏù¥Îãù Ïπ¥ÌÖåÍ≥†Î¶¨ Î°úÎìú
    async function loadInstructorImageCategories() {
      const container = document.getElementById('instructor-image-categories');
      
      try {
        const { data: categories, error } = await db
          .from('image_training_categories')
          .select('*')
          .order('sort_order', { ascending: true });
        
        if (error) throw error;
        
        imageTrainingCategories = categories || [];
        
        if (imageTrainingCategories.length === 0) {
          container.innerHTML = `<div class="card" style="text-align: center; color: var(--text-secondary); padding: 30px;">
            Îì±Î°ùÎêú ÎèôÏûë Í∞ÄÏù¥ÎìúÍ∞Ä ÏóÜÏäµÎãàÎã§
          </div>`;
          return;
        }
        
        let html = '';
        for (const cat of imageTrainingCategories) {
          html += `<div class="image-category-card" onclick="openInstructorImageDetail('${cat.category_id}')">
            <div class="category-icon">${cat.icon || 'üìñ'}</div>
            <div class="category-info">
              <div class="category-name">${cat.name}</div>
              <div class="category-desc">${cat.description || ''}</div>
            </div>
            <i class="fas fa-chevron-right category-arrow"></i>
          </div>`;
        }
        
        container.innerHTML = html;
      } catch (err) {
        console.error('Ïù¥ÎØ∏ÏßÄ Ìä∏Î†àÏù¥Îãù Ïπ¥ÌÖåÍ≥†Î¶¨ Î°úÎìú Ïò§Î•ò:', err);
        container.innerHTML = `<div class="card" style="text-align: center; color: var(--error); padding: 20px;">
          Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§
        </div>`;
      }
    }
    
    // Í∞ïÏÇ¨Ïö© Ïù¥ÎØ∏ÏßÄ Ìä∏Î†àÏù¥Îãù ÏÉÅÏÑ∏ Î≥¥Í∏∞
    async function openInstructorImageDetail(categoryId) {
      const category = imageTrainingCategories.find(c => c.category_id === categoryId);
      if (category) {
        document.getElementById('instructor-image-detail-title').textContent = category.name;
      }
      
      showScreen('screen-instructor-image-detail');
      
      const container = document.getElementById('instructor-image-steps');
      container.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';
      
      try {
        const { data: steps, error } = await db
          .from('image_training_steps')
          .select('*')
          .eq('category_id', categoryId)
          .order('step_order', { ascending: true });
        
        if (error) throw error;
        
        if (!steps || steps.length === 0) {
          container.innerHTML = `<div class="card" style="text-align: center; color: var(--text-secondary); padding: 30px;">
            Îì±Î°ùÎêú Îã®Í≥ÑÍ∞Ä ÏóÜÏäµÎãàÎã§
          </div>`;
          return;
        }
        
        let html = '';
        for (const step of steps) {
          html += `<div class="training-step-card">
            <div class="step-image-container">
              ${step.image_url 
                ? `<img src="${step.image_url}" alt="${step.title}" loading="lazy">`
                : `<i class="fas fa-image step-image-placeholder"></i>`
              }
            </div>
            <div class="step-content">
              <div class="step-title">
                <span class="step-number">${step.step_order}</span>
                <span class="step-title-text">${step.title}</span>
              </div>
              ${step.description ? `<div class="step-description">${step.description}</div>` : ''}
              ${step.tips ? `<div class="step-tips"><i class="fas fa-lightbulb"></i>${step.tips}</div>` : ''}
            </div>
          </div>`;
        }
        
        container.innerHTML = html;
      } catch (err) {
        console.error('Ïù¥ÎØ∏ÏßÄ Ìä∏Î†àÏù¥Îãù Ïä§ÌÖù Î°úÎìú Ïò§Î•ò:', err);
        container.innerHTML = `<div class="card" style="text-align: center; color: var(--error); padding: 20px;">
          Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§
        </div>`;
      }
    }

    // ÌïôÏÉù: ÎìúÎùºÏù¥ Ìä∏Î†àÏù¥Îãù Î™©Î°ù Î°úÎìú
    async function loadDryTraining() {
      try {
        // Î™®Îì† Ìä∏Î†àÏù¥Îãù Ï°∞Ìöå
        const { data: trainings } = await db
          .from('dry_trainings')
          .select('*, users!dry_trainings_instructor_id_fkey(name)')
          .order('created_at', { ascending: false });
        
        allDryTrainings = trainings || [];
        
        // ÎÇ¥Í∞Ä Ï∞∏Ïó¨ Ï§ëÏù∏ Ìä∏Î†àÏù¥Îãù (participants Î∞∞Ïó¥Ïóê ÏûàÎäîÏßÄ ÌôïÏù∏)
        const myTrainings = allDryTrainings.filter(t => 
          t.participants && t.participants.includes(currentUser.user_id)
        );
        
        // Ï∞∏Ïó¨ ÏïàÌïú Ìä∏Î†àÏù¥Îãù
        const otherTrainings = allDryTrainings.filter(t => 
          !t.participants || !t.participants.includes(currentUser.user_id)
        );
        
        // Ï∞∏Ïó¨ Ï§ëÏù∏ Ìä∏Î†àÏù¥Îãù ÏòÅÏó≠
        const myContainer = document.getElementById('my-dry-trainings');
        const calendarSection = document.getElementById('dry-training-calendar-section');
        const otherSection = document.getElementById('other-dry-trainings-section');
        const allSection = document.getElementById('all-dry-trainings-section');
        
        if (myTrainings.length === 0) {
          // Ï∞∏Ïó¨ Ï§ëÏù∏ Ìä∏Î†àÏù¥ÎãùÏù¥ ÏóÜÎäî Í≤ΩÏö∞ (ÏÇ¨ÏßÑ3)
          myContainer.innerHTML = `<div class="card" style="text-align: center; color: var(--text-secondary); padding: 20px;">
            Ï∞∏Ïó¨ Ï§ëÏù∏ Ìä∏Î†àÏù¥ÎãùÏù¥ ÏóÜÏäµÎãàÎã§<br>
            <span style="font-size: 12px;">ÏïÑÎûòÏóêÏÑú Ìä∏Î†àÏù¥ÎãùÏùÑ ÏÑ†ÌÉùÌï¥Î≥¥ÏÑ∏Ïöî!</span>
          </div>`;
          
          // Ï∫òÎ¶∞Îçî Ïà®Í∏∞Í∏∞, Ï∞∏Ïó¨Ï§ëÏù¥ÏßÄ ÏïäÏùÄ Ìä∏Î†àÏù¥Îãù ÏÑπÏÖò Ïà®Í∏∞Í∏∞
          calendarSection.style.display = 'none';
          otherSection.style.display = 'none';
          
          // Ï†ÑÏ≤¥ Ìä∏Î†àÏù¥Îãù ÌëúÏãú
          allSection.style.display = 'block';
          const allContainer = document.getElementById('all-dry-trainings-no-participation');
          
          if (allDryTrainings.length === 0) {
            allContainer.innerHTML = `<div class="card" style="text-align: center; color: var(--text-secondary); padding: 20px;">
              Îì±Î°ùÎêú Ìä∏Î†àÏù¥ÎãùÏù¥ ÏóÜÏäµÎãàÎã§
            </div>`;
          } else {
            let html = '';
            for (const t of allDryTrainings) {
              html += renderDryCard(t, false);
            }
            allContainer.innerHTML = html;
          }
        } else {
          // Ï∞∏Ïó¨ Ï§ëÏù∏ Ìä∏Î†àÏù¥ÎãùÏù¥ ÏûàÎäî Í≤ΩÏö∞ (ÏÇ¨ÏßÑ5)
          // Ï≤´ Î≤àÏß∏ Ï∞∏Ïó¨ Ï§ëÏù∏ Ìä∏Î†àÏù¥ÎãùÏùÑ currentDryIdÎ°ú ÏÑ§Ï†ï
          currentDryId = myTrainings[0].dry_id;
          
          // Ï∞∏Ïó¨ Ï§ëÏù∏ Ìä∏Î†àÏù¥Îãù Ïπ¥Îìú (Ï≤¥ÌÅ¨ Î≤ÑÌäº Ìè¨Ìï®)
          let myHtml = '';
          const today = new Date().toISOString().split('T')[0];
          const { data: todayRecords } = await db
            .from('dry_training_records')
            .select('dry_id')
            .eq('user_id', currentUser.user_id)
            .eq('date', today);
          
          const completedIds = (todayRecords || []).map(r => r.dry_id);
          
          for (const t of myTrainings) {
            const isDone = completedIds.includes(t.dry_id);
            myHtml += `<div class="card" style="margin-bottom: 12px;">
              <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div style="flex: 1;">
                  <div style="font-weight: 600; margin-bottom: 4px;">${t.name}</div>
                  <div style="font-size: 13px; color: var(--text-secondary);">${t.description || ''}</div>
                </div>
                ${isDone 
                  ? `<span style="color: var(--success); font-size: 13px; padding: 10px 16px;"><i class="fas fa-check-circle"></i> ÏôÑÎ£å</span>`
                  : `<button class="btn btn-primary btn-small" onclick="quickDryRecord('${t.dry_id}')">Ï≤¥ÌÅ¨</button>`
                }
              </div>
            </div>`;
          }
          myContainer.innerHTML = myHtml;
          
          // Ï∫òÎ¶∞Îçî ÌëúÏãú
          calendarSection.style.display = 'block';
          renderDryListCalendar();
          
          // Ï∞∏Ïó¨Ï§ëÏù¥ÏßÄ ÏïäÏùÄ Ìä∏Î†àÏù¥Îãù ÌëúÏãú
          allSection.style.display = 'none';
          
          if (otherTrainings.length > 0) {
            otherSection.style.display = 'block';
            const allContainer = document.getElementById('all-dry-trainings');
            let html = '';
            for (const t of otherTrainings) {
              html += renderDryCard(t, false);
            }
            allContainer.innerHTML = html;
          } else {
            otherSection.style.display = 'none';
          }
        }
      } catch (err) {
        console.error('ÎìúÎùºÏù¥ Ìä∏Î†àÏù¥Îãù Î°úÎìú Ïò§Î•ò:', err);
      }
    }
    
    // ÎìúÎùºÏù¥ Ìä∏Î†àÏù¥Îãù Î™©Î°ù Ï∫òÎ¶∞Îçî Î≥ÄÏàò
    let dryListCalendarYear = new Date().getFullYear();
    let dryListCalendarMonth = new Date().getMonth();
    
    // ÎìúÎùºÏù¥ Î™©Î°ù Ï∫òÎ¶∞Îçî Ïõî Î≥ÄÍ≤Ω
    function changeDryListMonth(delta) {
      dryListCalendarMonth += delta;
      if (dryListCalendarMonth > 11) {
        dryListCalendarMonth = 0;
        dryListCalendarYear++;
      } else if (dryListCalendarMonth < 0) {
        dryListCalendarMonth = 11;
        dryListCalendarYear--;
      }
      renderDryListCalendar();
    }
    
    // ÎìúÎùºÏù¥ Î™©Î°ù Ï∫òÎ¶∞Îçî Î†åÎçîÎßÅ
    async function renderDryListCalendar() {
      const monthNames = ['1Ïõî', '2Ïõî', '3Ïõî', '4Ïõî', '5Ïõî', '6Ïõî', '7Ïõî', '8Ïõî', '9Ïõî', '10Ïõî', '11Ïõî', '12Ïõî'];
      document.getElementById('dry-list-calendar-title').textContent = `${dryListCalendarYear}ÎÖÑ ${monthNames[dryListCalendarMonth]}`;
      
      // Ìï¥Îãπ Ïõî Í∏∞Î°ù Ï°∞Ìöå (Ï∞∏Ïó¨ Ï§ëÏù∏ Î™®Îì† Ìä∏Î†àÏù¥Îãù)
      const startDate = `${dryListCalendarYear}-${String(dryListCalendarMonth + 1).padStart(2, '0')}-01`;
      const endDate = `${dryListCalendarYear}-${String(dryListCalendarMonth + 1).padStart(2, '0')}-31`;
      
      const { data: records } = await db
        .from('dry_training_records')
        .select('date, achievement')
        .eq('user_id', currentUser.user_id)
        .gte('date', startDate)
        .lte('date', endDate);
      
      const recordMap = {};
      (records || []).forEach(r => {
        recordMap[r.date] = true;
      });
      
      const firstDay = new Date(dryListCalendarYear, dryListCalendarMonth, 1);
      const lastDay = new Date(dryListCalendarYear, dryListCalendarMonth + 1, 0);
      const startDayOfWeek = firstDay.getDay();
      const daysInMonth = lastDay.getDate();
      const today = new Date().toISOString().split('T')[0];
      
      let html = '';
      
      // Ïù¥Ï†Ñ Îã¨
      const prevMonthLastDay = new Date(dryListCalendarYear, dryListCalendarMonth, 0).getDate();
      for (let i = startDayOfWeek - 1; i >= 0; i--) {
        html += `<div class="calendar-day other-month">${prevMonthLastDay - i}</div>`;
      }
      
      // Ïù¥Î≤à Îã¨
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${dryListCalendarYear}-${String(dryListCalendarMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const isToday = dateStr === today;
        const hasRecord = recordMap[dateStr];
        
        let classes = 'calendar-day';
        if (isToday) classes += ' today';
        if (hasRecord) classes += ' has-dry';
        
        html += `<div class="${classes}">${day}</div>`;
      }
      
      // Îã§Ïùå Îã¨
      const totalCells = startDayOfWeek + daysInMonth;
      const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
      for (let i = 1; i <= remainingCells; i++) {
        html += `<div class="calendar-day other-month">${i}</div>`;
      }
      
      document.getElementById('dry-list-calendar-days').innerHTML = html;
    }

    // ÎìúÎùºÏù¥ Ìä∏Î†àÏù¥Îãù Ïπ¥Îìú Î†åÎçîÎßÅ (Í≥µÏö©)
    function renderDryCard(t, isParticipating) {
      return `<div class="card" style="margin-bottom: 12px;">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
          <div style="flex: 1;">
            <div style="font-weight: 600; margin-bottom: 4px;">${t.name}</div>
            <div style="font-size: 13px; color: var(--text-secondary);">${t.description || ''}</div>
            <div style="font-size: 12px; color: var(--text-tertiary); margin-top: 4px;">by ${t.users?.name || 'Í∞ïÏÇ¨'}</div>
          </div>
          ${isParticipating 
            ? `<button class="btn btn-primary btn-small" onclick="quickDryRecord('${t.dry_id}')">Ï≤¥ÌÅ¨</button>`
            : `<button class="btn btn-secondary btn-small" onclick="joinDryTraining('${t.dry_id}')">Ï∞∏Ïó¨ÌïòÍ∏∞</button>`
          }
        </div>
      </div>`;
    }

    // ÌïôÏÉù: Ìä∏Î†àÏù¥Îãù Ï∞∏Ïó¨ÌïòÍ∏∞ (ÎìúÎùºÏù¥ ÌÉ≠ÏóêÏÑú)
    async function joinDryTraining(dryId) {
      try {
        // ÌòÑÏû¨ Ìä∏Î†àÏù¥Îãù Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
        const training = allDryTrainings.find(t => t.dry_id === dryId);
        if (!training) return;
        
        // participants Î∞∞Ïó¥Ïóê ÌòÑÏû¨ Ïú†Ï†Ä Ï∂îÍ∞Ä
        const currentParticipants = training.participants || [];
        if (!currentParticipants.includes(currentUser.user_id)) {
          const newParticipants = [...currentParticipants, currentUser.user_id];
          
          await db.from('dry_trainings')
            .update({ participants: newParticipants })
            .eq('dry_id', dryId);
          
          // Î°úÏª¨ Îç∞Ïù¥ÌÑ∞ÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
          training.participants = newParticipants;
        }
        
        showToast('Ï∞∏Ïó¨ ÏôÑÎ£å!');
        currentDryId = dryId;
        // ÎìúÎùºÏù¥ ÌÉ≠ ÏÉàÎ°úÍ≥†Ïπ® (ÏÇ¨ÏßÑ3Ï≤òÎüº ÌëúÏãú)
        loadDryTraining();
      } catch (err) {
        console.error('Ï∞∏Ïó¨ Ïò§Î•ò:', err);
        showToast('Ï∞∏Ïó¨ Ïã§Ìå®: ' + err.message);
      }
    }

    // Í∏∞Î°ù ÏûÖÎ†• ÏãúÌä∏ Ïó¥Í∏∞
    function openDryRecordSheet() {
      // Í∏∞Î≥∏Í∞í 100%
      document.querySelectorAll('#dry-achievement-btns .purpose-btn').forEach(b => b.classList.remove('selected'));
      document.querySelector('#dry-achievement-btns .purpose-btn[data-value="1.0"]').classList.add('selected');
      document.getElementById('dry-record-note').value = '';
      openBottomSheet('sheet-dry-record');
    }

    function selectDryAchievement(btn) {
      document.querySelectorAll('#dry-achievement-btns .purpose-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
    }

    // Í∏∞Î°ù Ï†ÄÏû•
    async function saveDryRecord() {
      const achievementBtn = document.querySelector('#dry-achievement-btns .purpose-btn.selected');
      const achievement = parseFloat(achievementBtn.dataset.value);
      const note = document.getElementById('dry-record-note').value.trim();
      const today = new Date().toISOString().split('T')[0];
      
      try {
        // Í∏∞Ï°¥ Í∏∞Î°ù ÌôïÏù∏
        const { data: existing } = await db
          .from('dry_training_records')
          .select('record_id')
          .eq('dry_id', currentDryId)
          .eq('user_id', currentUser.user_id)
          .eq('date', today)
          .maybeSingle();
        
        if (existing) {
          // ÏàòÏ†ï
          await db.from('dry_training_records')
            .update({ achievement, note })
            .eq('record_id', existing.record_id);
        } else {
          // Ï∂îÍ∞Ä
          await db.from('dry_training_records')
            .insert({
              dry_id: currentDryId,
              user_id: currentUser.user_id,
              date: today,
              achievement,
              note
            });
        }
        
        showToast('ÏôÑÎ£å! üéâ');
        closeBottomSheet('sheet-dry-record');
        
        // ÌòÑÏû¨ ÌôîÎ©¥Ïóê Îî∞Îùº ÏÉàÎ°úÍ≥†Ïπ®
        const currentScreen = document.querySelector('.screen.active');
        if (currentScreen) {
          if (currentScreen.id === 'screen-student-home') {
            loadHomeDryTraining();
          } else if (currentScreen.id === 'screen-dry-training') {
            loadDryTraining();
          }
        }
        // Ìôà ÎìúÎùºÏù¥ ÏÑπÏÖòÎèÑ ÏÉàÎ°úÍ≥†Ïπ®
        loadHomeDryTraining();
      } catch (err) {
        console.error('Í∏∞Î°ù Ï†ÄÏû• Ïò§Î•ò:', err);
        showToast('Ï†ÄÏû• Ïã§Ìå®: ' + err.message);
      }
    }

    // ÌïôÏÉù Ìôà: ÎìúÎùºÏù¥ Ìä∏Î†àÏù¥Îãù ÏÑπÏÖò Î°úÎìú
    async function loadHomeDryTraining() {
      try {
        const { data: trainings } = await db
          .from('dry_trainings')
          .select('*, users!dry_trainings_instructor_id_fkey(name)')
          .limit(3);
        
        const container = document.getElementById('home-dry-training');
        
        if (!trainings || trainings.length === 0) {
          container.innerHTML = `<div class="card" style="text-align: center; color: var(--text-secondary); padding: 20px;">
            Îì±Î°ùÎêú ÎìúÎùºÏù¥ Ìä∏Î†àÏù¥ÎãùÏù¥ ÏóÜÏäµÎãàÎã§
          </div>`;
          return;
        }
        
        // ÎÇ¥Í∞Ä Ï∞∏Ïó¨ Ï§ëÏù∏ Ìä∏Î†àÏù¥ÎãùÎßå ÌïÑÌÑ∞ÎßÅ
        const myTrainings = trainings.filter(t => 
          t.participants && t.participants.includes(currentUser.user_id)
        );
        
        // Ï∞∏Ïó¨ÌïòÏßÄ ÏïäÏùÄ Ìä∏Î†àÏù¥Îãù
        const otherTrainings = trainings.filter(t => 
          !t.participants || !t.participants.includes(currentUser.user_id)
        );
        
        let html = '';
        
        // Ï∞∏Ïó¨Ìïú Ìä∏Î†àÏù¥ÎãùÏù¥ ÏûàÏúºÎ©¥ Ï≤¥ÌÅ¨ Î≤ÑÌäº ÌëúÏãú
        if (myTrainings.length > 0) {
          // Ïò§Îäò Í∏∞Î°ù ÌôïÏù∏
          const today = new Date().toISOString().split('T')[0];
          const { data: todayRecords } = await db
            .from('dry_training_records')
            .select('dry_id')
            .eq('user_id', currentUser.user_id)
            .eq('date', today);
          
          const completedIds = (todayRecords || []).map(r => r.dry_id);
          
          for (const t of myTrainings) {
            const isDone = completedIds.includes(t.dry_id);
            html += `<div class="card" style="margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
              <span>${t.name}</span>
              ${isDone 
                ? `<span style="color: var(--success); font-size: 13px;"><i class="fas fa-check-circle"></i> ÏôÑÎ£å</span>`
                : `<button class="btn btn-small btn-primary" onclick="quickDryRecord('${t.dry_id}')">Ï≤¥ÌÅ¨</button>`
              }
            </div>`;
          }
        }
        
        // Ï∞∏Ïó¨ÌïòÏßÄ ÏïäÏùÄ Ìä∏Î†àÏù¥ÎãùÏùÄ renderDryCard ÏÇ¨Ïö© (Ï∞∏Ïó¨ÌïòÍ∏∞ Î≤ÑÌäº)
        for (const t of otherTrainings) {
          html += renderDryCard(t, false);
        }
        
        // Ìä∏Î†àÏù¥ÎãùÏù¥ ÌïòÎÇòÎèÑ ÏóÜÏúºÎ©¥ Î©îÏãúÏßÄ ÌëúÏãú
        if (html === '') {
          html = `<div class="card" style="text-align: center; color: var(--text-secondary); padding: 20px;">
            Îì±Î°ùÎêú ÎìúÎùºÏù¥ Ìä∏Î†àÏù¥ÎãùÏù¥ ÏóÜÏäµÎãàÎã§
          </div>`;
        }
        
        container.innerHTML = html;
      } catch (err) {
        console.error('Ìôà ÎìúÎùºÏù¥ Ìä∏Î†àÏù¥Îãù Î°úÎìú Ïò§Î•ò:', err);
      }
    }
    
    // ÌôàÏóêÏÑú Ìä∏Î†àÏù¥Îãù Ï∞∏Ïó¨ÌïòÍ∏∞ (joinDryTrainingÍ≥º ÎèôÏùºÌïòÍ≤å ÎèôÏûëÌïòÏßÄÎßå Ìôà ÏÉàÎ°úÍ≥†Ïπ®)
    async function joinDryTrainingFromHome(dryId) {
      try {
        // ÌòÑÏû¨ Ìä∏Î†àÏù¥Îãù Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
        const { data: training } = await db
          .from('dry_trainings')
          .select('*')
          .eq('dry_id', dryId)
          .single();
        
        if (!training) return;
        
        // participants Î∞∞Ïó¥Ïóê ÌòÑÏû¨ Ïú†Ï†Ä Ï∂îÍ∞Ä
        const currentParticipants = training.participants || [];
        if (!currentParticipants.includes(currentUser.user_id)) {
          const newParticipants = [...currentParticipants, currentUser.user_id];
          
          await db.from('dry_trainings')
            .update({ participants: newParticipants })
            .eq('dry_id', dryId);
        }
        
        showToast('Ï∞∏Ïó¨ ÏôÑÎ£å!');
        loadHomeDryTraining(); // Ìôà ÏÉàÎ°úÍ≥†Ïπ®
      } catch (err) {
        console.error('Ï∞∏Ïó¨ Ïò§Î•ò:', err);
        showToast('Ï∞∏Ïó¨ Ïã§Ìå®: ' + err.message);
      }
    }

    // ÌôàÏóêÏÑú Îπ†Î•∏ Í∏∞Î°ù
    // ÌôàÏóêÏÑú Í∏∞Î°ùÌïòÍ∏∞ (Î∞îÌÖÄÏãúÌä∏ Ïó¥Í∏∞)
    function quickDryRecord(dryId) {
      currentDryId = dryId;
      openDryRecordSheet();
    }

    // Í∏∞Î°ù Ï†ÄÏû• ÌõÑ ÏΩúÎ∞± (ÌôàÏóêÏÑú Ìò∏Ï∂ú Ïãú ÌôàÎèÑ ÏÉàÎ°úÍ≥†Ïπ®)
    let afterDryRecordSave = null;

    // ==================== ÏûêÍ≤©Ï¶ù Ïù¥ÎØ∏ÏßÄ ====================

// ÎßàÏù¥ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú ÏûêÍ≤©Ï¶ù ÌëúÏãú
function renderCertImage() {
  const container = document.getElementById('cert-image-container');
  
  if (currentUser.cert_image_url) {
    // Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏûàÏúºÎ©¥ ÌëúÏãú
    container.innerHTML = `
      <div style="position: relative;">
        <img src="${currentUser.cert_image_url}" 
             style="width: 100%; border-radius: 12px; cursor: pointer;"
             onclick="viewCertImage('${currentUser.cert_image_url}')"
             alt="ÏûêÍ≤©Ï¶ù">
        <button onclick="deleteCertImage()" 
                style="position: absolute; top: 8px; right: 8px; 
                       width: 32px; height: 32px; border-radius: 50%; 
                       border: none; background: rgba(0,0,0,0.5); 
                       color: white; cursor: pointer;">
          <i class="fas fa-trash"></i>
        </button>
      </div>
    `;
  } else {
    // Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏóÜÏúºÎ©¥ ÏóÖÎ°úÎìú Î≤ÑÌäº
    container.innerHTML = `
      <label style="display: flex; flex-direction: column; align-items: center; 
                    padding: 40px 20px; border: 2px dashed var(--border); 
                    border-radius: 12px; cursor: pointer; color: var(--text-secondary);">
        <i class="fas fa-camera" style="font-size: 32px; margin-bottom: 12px;"></i>
        <span>ÏûêÍ≤©Ï¶ù ÏÇ¨ÏßÑ Îì±Î°ù</span>
        <span style="font-size: 12px; margin-top: 4px;">ÌÉ≠ÌïòÏó¨ ÏóÖÎ°úÎìú</span>
        <input type="file" accept="image/*" onchange="uploadCertImage(event)" style="display: none;">
      </label>
    `;
  }
}

// ÏûêÍ≤©Ï¶ù Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú
async function uploadCertImage(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  // ÌååÏùº ÌÅ¨Í∏∞ Ï≤¥ÌÅ¨ (5MB Ï†úÌïú)
  if (file.size > 5 * 1024 * 1024) {
    showToast('ÌååÏùº ÌÅ¨Í∏∞Îäî 5MB Ïù¥ÌïòÎ°ú Ìï¥Ï£ºÏÑ∏Ïöî');
    return;
  }
  
  showToast('ÏóÖÎ°úÎìú Ï§ë...');
  
  try {
    // ÌååÏùºÎ™Ö ÏÉùÏÑ±
    const fileExt = file.name.split('.').pop();
    const fileName = `${currentUser.user_id}_${Date.now()}.${fileExt}`;
    
    // Supabase StorageÏóê ÏóÖÎ°úÎìú
    const { data, error } = await db.storage
      .from('certifications')
      .upload(fileName, file);
    
    if (error) throw error;
    
    // Public URL Í∞ÄÏ†∏Ïò§Í∏∞
    const { data: urlData } = db.storage
      .from('certifications')
      .getPublicUrl(fileName);
    
    const imageUrl = urlData.publicUrl;
    
    // DBÏóê URL Ï†ÄÏû•
    const { error: updateError } = await db
      .from('users')
      .update({ cert_image_url: imageUrl })
      .eq('user_id', currentUser.user_id);
    
    if (updateError) throw updateError;
    
    // Î°úÏª¨ Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
    currentUser.cert_image_url = imageUrl;
    localStorage.setItem('divelog_user', JSON.stringify(currentUser));
    
    showToast('ÏûêÍ≤©Ï¶ùÏù¥ Îì±Î°ùÎêòÏóàÏäµÎãàÎã§!');
    renderCertImage();
    
  } catch (err) {
    console.error('ÏóÖÎ°úÎìú Ïò§Î•ò:', err);
    showToast('ÏóÖÎ°úÎìú Ïã§Ìå®: ' + err.message);
  }
}

// ÏûêÍ≤©Ï¶ù Ïù¥ÎØ∏ÏßÄ ÏÇ≠Ï†ú
async function deleteCertImage() {
  if (!confirm('ÏûêÍ≤©Ï¶ù Ïù¥ÎØ∏ÏßÄÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
  
  try {
    // StorageÏóêÏÑú ÌååÏùº ÏÇ≠Ï†ú (URLÏóêÏÑú ÌååÏùºÎ™Ö Ï∂îÏ∂ú)
    const url = currentUser.cert_image_url;
    const fileName = url.split('/').pop();
    
    await db.storage
      .from('certifications')
      .remove([fileName]);
    
    // DBÏóêÏÑú URL Ï†úÍ±∞
    const { error } = await db
      .from('users')
      .update({ cert_image_url: null })
      .eq('user_id', currentUser.user_id);
    
    if (error) throw error;
    
    // Î°úÏª¨ Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
    currentUser.cert_image_url = null;
    localStorage.setItem('divelog_user', JSON.stringify(currentUser));
    
    showToast('ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§');
    renderCertImage();
    
  } catch (err) {
    console.error('ÏÇ≠Ï†ú Ïò§Î•ò:', err);
    showToast('ÏÇ≠Ï†ú Ïã§Ìå®: ' + err.message);
  }
}

// ÏûêÍ≤©Ï¶ù Ïù¥ÎØ∏ÏßÄ ÌÅ¨Í≤å Î≥¥Í∏∞
function viewCertImage(url) {
  window.open(url, '_blank');
}
  </script>
</body>
</html>
