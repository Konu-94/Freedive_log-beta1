<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>DiveLog</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <!-- Supabase JS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --primary: #3182F6;
      --primary-light: #E8F3FF;
      --success: #00C853;
      --warning: #FF9100;
      --error: #F44336;
      --bg: #F7F8FA;
      --surface: #FFFFFF;
      --text-primary: #191F28;
      --text-secondary: #8B95A1;
      --text-tertiary: #B0B8C1;
      --border: #E5E8EB;
      --divider: #F2F4F6;
      --lv2-color: #FF9100;
      --lv2-light: #FFF3E0;
      --lv3-color: #00C853;
      --lv3-light: #E8F5E9;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text-primary);
      line-height: 1.5;
      min-height: 100vh;
    }
    .app { max-width: 480px; margin: 0 auto; min-height: 100vh; background: var(--bg); position: relative; padding-bottom: 80px; }
    .screen { display: none; }
    .screen.active { display: block; }
    .header { background: var(--surface); padding: 12px 20px; display: flex; align-items: center; gap: 12px; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid var(--divider); }
    .header-back { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border: none; background: none; font-size: 20px; color: var(--text-primary); cursor: pointer; border-radius: 12px; }
    .header-title { font-size: 18px; font-weight: 600; flex: 1; }
    .header-action { color: var(--primary); font-weight: 600; background: none; border: none; font-size: 16px; cursor: pointer; }
    .tab-bar { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 480px; background: var(--surface); border-top: 1px solid var(--divider); display: flex; padding: 8px 0 20px; z-index: 100; }
    .tab-item { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 8px; background: none; border: none; cursor: pointer; color: var(--text-tertiary); }
    .tab-item.active { color: var(--primary); }
    .tab-item i { font-size: 22px; }
    .tab-item span { font-size: 11px; font-weight: 500; }
    .container { padding: 20px; }
    .card { background: var(--surface); border-radius: 16px; padding: 20px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
    .greeting { font-size: 24px; font-weight: 700; margin-bottom: 4px; }
    .greeting-sub { color: var(--text-secondary); font-size: 15px; }
    .section-title { font-size: 16px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    .btn { width: 100%; padding: 16px; border-radius: 12px; font-size: 16px; font-weight: 600; border: none; cursor: pointer; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-secondary { background: var(--primary-light); color: var(--primary); }
    .btn-outline { background: transparent; border: 1px dashed var(--border); color: var(--text-secondary); }
    .btn-danger { background: #FEE; color: var(--error); }
    .btn-small { padding: 10px 16px; width: auto; font-size: 14px; }
    .input-group { margin-bottom: 16px; }
    .input-label { font-size: 14px; font-weight: 500; color: var(--text-secondary); margin-bottom: 8px; display: block; }
    .input { width: 100%; padding: 14px 16px; border: 1px solid var(--border); border-radius: 12px; font-size: 16px; font-family: inherit; background: var(--surface); }
    .input:focus { outline: none; border-color: var(--primary); }
    select.input { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%238B95A1' d='M6 8L1 3h10z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 16px center; }
    .schedule-card { display: flex; justify-content: space-between; align-items: center; }
    .schedule-info { flex: 1; }
    .schedule-time { font-size: 15px; font-weight: 600; margin-bottom: 2px; }
    .schedule-location { font-size: 14px; color: var(--text-secondary); }
    .schedule-meta { font-size: 13px; color: var(--text-tertiary); margin-top: 4px; }
    .schedule-arrow { color: var(--text-tertiary); font-size: 18px; }
    .participant-card { display: flex; align-items: center; gap: 12px; padding: 16px 0; border-bottom: 1px solid var(--divider); }
    .participant-card:last-child { border-bottom: none; }
    .participant-avatar { width: 44px; height: 44px; border-radius: 50%; background: var(--primary-light); display: flex; align-items: center; justify-content: center; color: var(--primary); font-weight: 600; }
    .participant-info { flex: 1; }
    .participant-name { font-weight: 600; font-size: 16px; }
    .participant-detail { font-size: 13px; color: var(--text-secondary); margin-top: 2px; }
    .attendance-badge { padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 500; }
    .attendance-yes { background: #E8F5E9; color: var(--success); }
    .attendance-no { background: #FFEBEE; color: var(--error); }
    .attendance-pending { background: var(--divider); color: var(--text-secondary); }
    .record-row { background: var(--bg); border-radius: 12px; padding: 16px; margin-bottom: 12px; }
    .record-row-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .record-row-title { font-weight: 600; font-size: 14px; color: var(--text-secondary); }
    .record-row-delete { background: none; border: none; color: var(--error); cursor: pointer; font-size: 18px; }
    .record-fields { display: grid; grid-template-columns: 1fr 80px 100px; gap: 8px; }
    .record-note { margin-top: 8px; }
    .record-note .input { padding: 10px 12px; font-size: 14px; }
    .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px; }
    .stat-card { background: var(--surface); border-radius: 12px; padding: 16px; text-align: center; }
    .stat-label { font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; }
    .stat-value { font-size: 20px; font-weight: 700; color: var(--primary); }
    .level-card { text-align: center; padding: 24px 20px; }
    .level-badge { font-size: 32px; font-weight: 700; color: var(--primary); margin-bottom: 8px; }
    .progress-bar { height: 8px; background: var(--divider); border-radius: 4px; overflow: hidden; margin: 12px 0; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary), #60A5FA); border-radius: 4px; }
    .quick-actions { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .quick-btn { background: var(--surface); border-radius: 16px; padding: 20px 12px; text-align: center; border: none; cursor: pointer; }
    .quick-btn i { font-size: 24px; color: var(--primary); margin-bottom: 8px; display: block; }
    .quick-btn span { font-size: 13px; font-weight: 500; }
    .btn-icon-delete { 
      background: none; 
      border: none; 
      color: var(--text-tertiary); 
      cursor: pointer; 
      padding: 8px; 
      margin-left: 4px;
      border-radius: 8px;
    }
    .btn-icon-delete:hover { color: var(--error); background: #FEE; }
    
    /* ì°¸ê°€ì íƒ­ */
    .participant-tabs {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding-bottom: 8px;
      margin-bottom: 16px;
    }
    .participant-tab {
      padding: 10px 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
      white-space: nowrap;
      cursor: pointer;
    }
    .participant-tab.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    
    /* ì¢…ëª© íƒ­ */
    .discipline-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      overflow-x: auto;
    }
    .disc-tab {
      padding: 8px 16px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .disc-tab.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    
    /* ê¸°ë¡ ì¼ê´„ ì…ë ¥ ì¢…ëª© íƒ­ (íƒœê·¸ í˜•íƒœ) */
    .batch-tabs-container { display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px; }
    .batch-tabs-row { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
    .batch-tabs-label { font-size: 11px; color: var(--text-tertiary); min-width: 24px; }
    .batch-disc-tag {
      padding: 4px 12px;
      background: var(--primary-light);
      border: none;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
      color: var(--primary);
      cursor: pointer;
    }
    .batch-disc-tag.active {
      background: var(--primary);
      color: white;
    }
    .batch-skill-tag {
      padding: 4px 10px;
      border: none;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
    }
    .batch-skill-tag.lv2 {
      background: var(--lv2-light);
      color: var(--lv2-color);
    }
    .batch-skill-tag.lv2.active {
      background: var(--lv2-color);
      color: white;
    }
    .batch-skill-tag.lv3 {
      background: var(--lv3-light);
      color: var(--lv3-color);
    }
    .batch-skill-tag.lv3.active {
      background: var(--lv3-color);
      color: white;
    }
    
    /* ì‹œë„ ì…ë ¥ í–‰ */
    .attempt-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      padding: 8px;
      background: var(--bg);
      border-radius: 8px;
    }
    .attempt-num {
      width: 30px;
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 13px;
    }
    .attempt-input {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 16px;
    }
    .attempt-input:focus {
      outline: none;
      border-color: var(--primary);
    }
    .attempt-delete {
      width: 32px;
      height: 32px;
      border: none;
      background: none;
      color: var(--text-tertiary);
      cursor: pointer;
      border-radius: 8px;
    }
    .attempt-delete:hover {
      color: var(--error);
      background: #FEE;
    }
    
    /* ê¸°ë¡ í…Œì´ë¸” */
    .record-table-container {
      overflow-x: auto;
    }
    .record-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    .record-table th, .record-table td {
      padding: 10px 8px;
      text-align: center;
      border-bottom: 1px solid var(--divider);
    }
    .record-table th {
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 13px;
      background: var(--bg);
    }
    .record-table .col-name {
      text-align: left;
      min-width: 70px;
      font-weight: 500;
    }
    .record-table .col-attempt {
      min-width: 60px;
    }
    .record-table .col-note {
      min-width: 80px;
    }
    .record-table .col-skill {
      min-width: 50px;
    }
    .record-table .col-add-attempt {
      width: 30px;
      padding: 4px;
      border-left: 1px solid var(--divider);
    }
    .btn-add-col {
      width: 24px;
      height: 24px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 16px;
      color: var(--text-tertiary);
    }
    .btn-add-col:hover {
      color: var(--primary);
    }
    .record-table input {
      width: 100%;
      padding: 8px 4px;
      border: none;
      background: transparent;
      text-align: center;
      font-size: 14px;
      color: var(--text-secondary);
    }
    .record-table input:focus {
      outline: none;
      color: var(--primary);
      font-weight: 600;
    }
    .record-table input::placeholder {
      color: var(--text-tertiary);
    }
    .record-table input.note-input {
      text-align: left;
      padding-left: 8px;
    }
    .record-table td {
      border-right: 1px solid var(--divider);
    }
    .record-table td:last-child {
      border-right: none;
    }
    
    /* ìŠ¤í‚¬ ì²´í¬ ë²„íŠ¼ */
    .skill-check-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 2px solid var(--border);
      background: white;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    .skill-check-btn.success {
      background: var(--success);
      border-color: var(--success);
      color: white;
    }
    .skill-check-btn.fail {
      background: var(--error);
      border-color: var(--error);
      color: white;
    }
    
    /* ìŠ¤í‚¬ íƒ­ */
    .disc-tab-skill {
      background: var(--lv3-light) !important;
      border-color: var(--lv3-color) !important;
      color: var(--lv3-color) !important;
    }
    .disc-tab-skill.active {
      background: var(--lv3-color) !important;
      color: white !important;
    }
    
    /* ì¼ì • ì„ íƒ ì•„ì´í…œ */
    .schedule-select-item {
      padding: 16px;
      border-bottom: 1px solid var(--divider);
      cursor: pointer;
    }
    .schedule-select-item:hover {
      background: var(--bg);
    }
    .schedule-select-item:last-child {
      border-bottom: none;
    }
    
    /* ì•„ì´ì½˜ ë²„íŠ¼ */
    .icon-btn {
      width: 36px;
      height: 36px;
      border: none;
      background: transparent;
      color: var(--text-tertiary);
      cursor: pointer;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    .icon-btn:hover {
      background: var(--bg);
      color: var(--text-secondary);
    }
    
    /* ëª¨ë“œ ìŠ¤ìœ„ì¹˜ ë²„íŠ¼ - í† ê¸€ í˜•íƒœ */
    .mode-switch-container {
      display: flex;
      background: var(--bg);
      border-radius: 8px;
      padding: 2px;
    }
    .mode-switch-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      color: var(--text-tertiary);
      cursor: pointer;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      transition: all 0.15s;
    }
    .mode-switch-btn.active {
      background: var(--surface);
      color: var(--text-primary);
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .mode-switch-btn:hover:not(.active) {
      color: var(--text-secondary);
    }
    
    /* ì„¹ì…˜ íƒ€ì´í‹€ (ì¼ì • êµ¬ë¶„) */
    .schedule-section-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-tertiary);
      margin: 20px 0 12px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .schedule-section-title:first-child {
      margin-top: 0;
    }
    
    /* ìº˜ë¦°ë” ìŠ¤íƒ€ì¼ */
    .calendar-header {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      padding: 12px 0;
      margin-bottom: 8px;
    }
    .calendar-nav {
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      border-radius: 8px;
      font-size: 14px;
    }
    .calendar-nav:hover {
      background: var(--bg);
    }
    .calendar-title {
      font-size: 16px;
      font-weight: 600;
    }
    .calendar-grid {
      background: white;
      border-radius: 16px;
      padding: 0; /* 16px â†’ 0ìœ¼ë¡œ ì¤„ì„ (ì¢Œìš° ì—¬ë°± ì œê±°) */
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .calendar-weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      text-align: center;
      margin-bottom: 4px;
      padding: 8px 0;  /* ì¶”ê°€: ìƒí•˜ ì—¬ë°±ë§Œ */
    }
    .calendar-weekdays .weekday {
      font-size: 12px;
      color: var(--text-tertiary);
      padding: 8px 0;
    }
    .calendar-weekdays .weekday.sun {
      color: var(--error);
    }
    .calendar-weekdays .weekday.sat {
      color: var(--primary);
    }
    .calendar-days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px 0;  /* ì„¸ë¡œ ê°„ê²© */
      padding: 0 0 12px 0;
    }
    .calendar-day {
      aspect-ratio: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      cursor: pointer;
      font-size: 14px;
      font-weight: 400;  /* ê¸°ë³¸: bold ì—†ìŒ */
      position: relative;
      color: var(--text-primary);
      width: 40px;
      height: 40px;
      max-width: 40px;
      max-height: 40px;
      margin: 0 auto;
    }
    .calendar-day:hover {
      background: var(--bg);
    }
    .calendar-day.other-month {
      color: var(--text-tertiary);
      font-weight: 400;
    }
    /* ì˜¤ëŠ˜ ë‚ ì§œ - ë°‘ì¤„ë¡œ í‘œì‹œ */
    .calendar-day.today::after {
      content: '';
      position: absolute;
      bottom: 6px;
      left: 50%;
      transform: translateX(-50%);
      width: 16px;
      height: 2px;
      background: var(--text-secondary);
      border-radius: 1px;
    }
    .calendar-day.today:hover {
      background: var(--bg);
    }
    .calendar-day.selected {
      /* ì„ íƒì‹œ bold */
      font-weight: 600;
    }
    .calendar-day.selected:hover {
      background: var(--bg);
    }
    .calendar-day.today.selected::after {
      background: var(--text-secondary);
    }
    /* ì¼ì • ìˆëŠ” ë‚ ì§œ - ì—°í•œ ìƒ‰ ë™ê·¸ë¼ë¯¸ í‘œì‹œ */
    .calendar-day.has-lesson {
      background: #BFDBFE; /* ì—°í•œ í•˜ëŠ˜ìƒ‰ */
      color: var(--text-primary);
    }
    .calendar-day.has-personal {
      background: #BBF7D0; /* ì—°í•œ ì—°ë‘ìƒ‰ */
      color: var(--text-primary);
    }
    .calendar-day.has-dry {
      background: #FED7AA; /* ì—°í•œ ì£¼í™©ìƒ‰ */
      color: var(--text-primary);
    }
    /* ì¼ì • ìˆëŠ” ë‚ ì§œ hover ì‹œ ë°°ê²½ìƒ‰ ìœ ì§€ */
    .calendar-day.has-lesson:hover {
      background: #BFDBFE;
    }
    .calendar-day.has-personal:hover {
      background: #BBF7D0;
    }
    .calendar-day.has-dry:hover {
      background: #FED7AA;
    }
    /* ì‹ ì²­ ê°€ëŠ¥í•œ ê°•ìŠµ - í…Œë‘ë¦¬ë§Œ */
    .calendar-day.has-available {
      box-shadow: inset 0 0 0 2px #93C5FD;
      color: var(--text-primary);
    }
    .calendar-day.has-available:hover {
      background: rgba(147, 197, 253, 0.1);
    }
    .calendar-day.has-lesson.selected,
    .calendar-day.has-personal.selected,
    .calendar-day.has-dry.selected,
    .calendar-day.has-available.selected {
      font-weight: 600;
    }
    /* ì˜¤ëŠ˜ì´ë©´ì„œ ì¼ì • ìˆëŠ” ë‚ ì§œ */
    .calendar-day.has-lesson.today::after,
    .calendar-day.has-personal.today::after,
    .calendar-day.has-dry.today::after {
      background: var(--text-primary);
    }
    .calendar-day.has-available.today::after {
      background: #3B82F6;
    }
    /* ì¼ì • ë°” ì œê±° (ë™ê·¸ë¼ë¯¸ë¡œ ëŒ€ì²´) */
    .calendar-day .schedule-bars {
      display: none;
    }
    
    /* ë²”ë¡€ */
    .calendar-legend {
      display: flex;
      justify-content: center;
      gap: 16px;
  padding: 8px 0;  /* 12px 0 â†’ 8px 0 */
      font-size: 12px;
      color: var(--text-secondary);
    }
    .calendar-legend span {
      display: flex;
      align-items: center;
      gap: 6px;
    }

/* ì„ íƒëœ ë‚ ì§œ í—¤ë” */
    .selected-date-header {
      display: flex;
      align-items: center;
      gap: 8px;
  padding: 12px 0;  /* 16px 0 12px 0 â†’ 12px 0 */
      font-weight: 600;
      color: var(--text-primary);
      border-top: 1px solid var(--divider);
      margin-top: 8px;
    }
    .selected-date-header i {
      color: var(--primary);
    }
    .tab-filter { display: flex; gap: 8px; margin-bottom: 16px; overflow-x: auto; }
    .filter-chip { padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 500; background: var(--surface); border: 1px solid var(--border); color: var(--text-secondary); cursor: pointer; white-space: nowrap; }
    .filter-chip.active { background: var(--primary); border-color: var(--primary); color: white; }
    .bottom-sheet-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); z-index: 200; opacity: 0; visibility: hidden; transition: all 0.3s; }
    .bottom-sheet-overlay.active { opacity: 1; visibility: visible; }
    .bottom-sheet { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%) translateY(100%); width: 100%; max-width: 480px; background: var(--surface); border-radius: 24px 24px 0 0; z-index: 201; transition: transform 0.3s ease; max-height: 90vh; overflow-y: auto; }
    .bottom-sheet-overlay.active .bottom-sheet { transform: translateX(-50%) translateY(0); }
    .bottom-sheet-handle { width: 40px; height: 4px; background: var(--border); border-radius: 2px; margin: 12px auto; }
    .bottom-sheet-content { padding: 8px 20px 32px; }
    .bottom-sheet-title { font-size: 20px; font-weight: 700; margin-bottom: 20px; }
    .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: var(--text-primary); color: white; padding: 14px 24px; border-radius: 12px; font-size: 15px; font-weight: 500; z-index: 300; opacity: 0; visibility: hidden; transition: all 0.3s; }
    .toast.show { opacity: 1; visibility: visible; }
    .login-screen { display: flex; flex-direction: column; min-height: 100vh; padding: 60px 24px 40px; }
    .login-logo { text-align: center; margin-bottom: 48px; }
    .login-logo i { font-size: 64px; color: var(--primary); margin-bottom: 16px; }
    .login-logo h1 { font-size: 32px; font-weight: 700; }
    .login-logo p { color: var(--text-secondary); margin-top: 8px; }
    .login-form { flex: 1; }
    .phone-input-wrapper { position: relative; }
    .phone-prefix { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: var(--text-primary); font-size: 16px; pointer-events: none; }
    .phone-input { padding-left: 46px !important; }
    .empty-state { text-align: center; padding: 48px 20px; }
    .empty-state i { font-size: 48px; color: var(--text-tertiary); margin-bottom: 16px; }
    .empty-state p { color: var(--text-secondary); }
    .purpose-buttons { display: flex; gap: 8px; margin-top: 12px; }
    .purpose-btn { flex: 1; padding: 12px; border-radius: 10px; font-size: 14px; font-weight: 500; border: 1px solid var(--border); background: var(--surface); cursor: pointer; }
    .purpose-btn.selected { background: var(--primary); border-color: var(--primary); color: white; }
    .chart-container { background: var(--surface); border-radius: 16px; padding: 20px; margin-bottom: 16px; }
    .chart-title { font-size: 16px; font-weight: 600; margin-bottom: 16px; }
    .record-list-item { padding: 16px 0; border-bottom: 1px solid var(--divider); }
    .record-list-item:last-child { border-bottom: none; }
    .record-date { font-size: 14px; font-weight: 600; margin-bottom: 8px; }
    .record-entry { display: flex; justify-content: space-between; padding: 4px 0; }
    .record-discipline { font-size: 14px; color: var(--text-secondary); }
    .record-value { font-weight: 600; }
    
    .discipline-checkbox { display: inline-block; margin: 8px 12px 8px 0; }
    .discipline-checkbox input { margin-right: 6px; }
    .batch-tabs { display: flex; gap: 8px; margin-bottom: 16px; border-bottom: 2px solid var(--border); overflow-x: auto; }
    .batch-tab { padding: 12px 20px; background: none; border: none; font-weight: 500; color: var(--text-secondary); cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px; white-space: nowrap; }
    .batch-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
    .batch-tab.skill-tab { color: var(--success); }
    .batch-tab.skill-tab.active { border-bottom-color: var(--success); }
    .batch-tab.skill-tab-lv2 { color: var(--lv2-color); }
    .batch-tab.skill-tab-lv2.active { border-bottom-color: var(--lv2-color); }
    .batch-table { width: 100%; border-collapse: collapse; }
    .batch-table th { background: var(--bg); padding: 12px 8px; font-size: 14px; font-weight: 600; text-align: left; }
    .batch-table td { padding: 12px 8px; border-bottom: 1px solid var(--divider); }
    .batch-table input { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; }
    .batch-table .student-name { font-weight: 500; }
    .common-disciplines-badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: var(--primary-light); color: var(--primary); border-radius: 20px; font-size: 13px; font-weight: 500; margin-top: 8px; }
    .common-disciplines-badge.skill-badge { background: #E8F5E9; color: var(--success); }
    .common-disciplines-badge.skill-badge-lv2 { background: var(--lv2-light); color: var(--lv2-color); }

    /* ìŠ¤í‚¬ í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
    .skill-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .skill-table th { background: var(--bg); padding: 8px 4px; font-weight: 600; text-align: center; border-bottom: 2px solid var(--border); }
    .skill-table th.skill-header { font-size: 11px; }
    .skill-table th.attempt-header { font-size: 10px; color: var(--text-tertiary); font-weight: 500; }
    .skill-table td { padding: 8px 4px; border-bottom: 1px solid var(--divider); text-align: center; }
    .skill-table td.student-name { text-align: left; font-weight: 500; padding-left: 8px; white-space: nowrap; }
    .skill-cell { 
      width: 32px; 
      height: 32px; 
      border-radius: 8px; 
      display: inline-flex; 
      align-items: center; 
      justify-content: center; 
      cursor: pointer; 
      font-size: 14px;
      transition: all 0.15s ease;
      user-select: none;
    }
    .skill-cell.empty { background: var(--divider); color: var(--text-tertiary); }
    .skill-cell.success { background: #E8F5E9; color: var(--success); }
    .skill-cell.fail { background: #FFEBEE; color: var(--error); }
    .skill-cell:active { transform: scale(0.9); }
    
    .skill-group-header { 
      background: var(--primary-light) !important; 
      color: var(--primary); 
      font-weight: 600 !important;
    }
    .skill-group-header-lv2 { 
      background: var(--lv2-light) !important; 
      color: var(--lv2-color); 
      font-weight: 600 !important;
    }

    /* Lv ì§„ë„ ì°¨íŠ¸ ìŠ¤íƒ€ì¼ */
    .lv-charts { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
    .lv-chart-card { background: var(--surface); border-radius: 16px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
    .chart-header { font-size: 14px; font-weight: 600; margin-bottom: 12px; text-align: center; color: var(--text-primary); display: flex; align-items: center; justify-content: center; gap: 6px; cursor: pointer; user-select: none; }
    .chart-header:hover { color: var(--primary); }
    .toggle-icon { font-size: 12px; transition: transform 0.3s ease; color: var(--text-tertiary); }
    .toggle-icon.open { transform: rotate(180deg); }
    .donut-container { position: relative; width: 140px; height: 140px; margin: 0 auto 16px; }
    .donut-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; pointer-events: none; }
    .donut-value { font-size: 24px; font-weight: 700; color: var(--primary); line-height: 1; }
    .donut-value.lv2 { color: var(--lv2-color); }
    .donut-value.lv3 { color: var(--lv3-color); }
    .donut-label { font-size: 11px; color: var(--text-secondary); margin-top: 4px; }
    .checklist { border-top: 1px solid var(--divider); padding-top: 0; max-height: 0; overflow: hidden; transition: max-height 0.3s ease, padding 0.3s ease; border-top: none; }
    .checklist.open { max-height: 300px; overflow-y: auto; padding-top: 12px; border-top: 1px solid var(--divider); }
    .checklist-item { display: flex; align-items: center; gap: 8px; padding: 8px 0; border-bottom: 1px solid var(--divider); }
    .checklist-item:last-child { border-bottom: none; }
    .checklist-icon { width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 11px; }
    .checklist-icon.done { background: #E8F5E9; color: var(--success); }
    .checklist-icon.undone { background: var(--divider); color: var(--text-tertiary); }
    .checklist-text { flex: 1; font-size: 12px; line-height: 1.3; }
    .checklist-text.done { color: var(--text-secondary); text-decoration: line-through; }
    .checklist-badge { font-size: 11px; padding: 2px 6px; border-radius: 10px; background: var(--bg); color: var(--text-secondary); white-space: nowrap; }

    /* ì¼ì • ì •ë³´ ì¹´ë“œ ìŠ¤íƒ€ì¼ ê°œì„  */
    .schedule-info-card { background: var(--surface); border-radius: 16px; padding: 16px; margin-bottom: 16px; }
    .schedule-info-row { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
    .schedule-info-row:last-child { margin-bottom: 0; }
    .schedule-info-row i { color: var(--primary); width: 16px; }
    .schedule-badges { display: flex; flex-wrap: wrap; gap: 6px; }
    .btn-edit-disciplines { 
      background: var(--bg); 
      border: 1px solid var(--border); 
      border-radius: 8px; 
      padding: 8px 12px; 
      font-size: 13px; 
      color: var(--text-secondary); 
      cursor: pointer; 
      display: flex; 
      align-items: center; 
      gap: 4px;
      flex-shrink: 0;
    }
    .btn-edit-disciplines:hover { background: var(--divider); color: var(--text-primary); }
    
    /* ìŠ¤í‚¬ ì„¹ì…˜ êµ¬ë¶„ */
    .skill-section-label { 
      font-size: 12px; 
      font-weight: 600; 
      padding: 8px 12px; 
      margin: 16px 0 8px; 
      border-radius: 8px;
    }
    .skill-section-label.lv2 { background: var(--lv2-light); color: var(--lv2-color); }
    .skill-section-label.lv3 { background: #E8F5E9; color: var(--success); }

    /* ì¼ì • ì¹´ë“œ ì•„ì´ì½˜ ë²„íŠ¼ */
    .schedule-card-header { display: flex; justify-content: space-between; align-items: flex-start; }
    .schedule-card-content { flex: 1; cursor: pointer; }
    .schedule-icon-buttons { display: flex; gap: 4px; flex-shrink: 0; margin-left: 8px; }
    .icon-btn { 
      width: 32px; 
      height: 32px; 
      border-radius: 8px; 
      border: none; 
      background: var(--bg); 
      color: var(--text-tertiary); 
      cursor: pointer; 
      display: flex; 
      align-items: center; 
      justify-content: center;
      font-size: 14px;
      transition: all 0.15s;
    }
    .icon-btn:hover { background: var(--divider); color: var(--text-secondary); }
    .icon-btn.danger:hover { background: #FFEBEE; color: var(--error); }
    .schedule-action-buttons { display: flex; gap: 8px; margin-top: 12px; }
    .schedule-action-buttons .btn { flex: 1; padding: 10px; font-size: 14px; }

    /* Notion ìŠ¤íƒ€ì¼ ê¸°ë¡ í…Œì´ë¸” */
    .record-table-container { margin-top: 16px; }
    .record-table-wrapper { display: flex; align-items: stretch; }
    .record-table { 
      flex: 1;
      border-collapse: collapse; 
      background: white; 
      border-radius: 12px; 
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .record-table th, .record-table td { 
      border: 1px solid var(--divider); 
      padding: 12px 8px; 
      text-align: center;
      min-width: 60px;
    }
    .record-table th { 
      background: var(--bg); 
      font-weight: 600; 
      font-size: 13px;
      color: var(--text-secondary);
    }
    .record-table th.discipline-col {
      min-width: 70px;
      background: var(--bg);
    }
    .record-table td.discipline-cell {
      background: var(--bg);
      font-weight: 600;
      color: var(--text);
      position: relative;
    }
    .record-table td.discipline-cell .remove-row-btn {
      position: absolute;
      left: 4px;
      top: 50%;
      transform: translateY(-50%);
      width: 18px;
      height: 18px;
      border: none;
      background: transparent;
      color: var(--text-tertiary);
      cursor: pointer;
      font-size: 10px;
      opacity: 0;
      transition: opacity 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
    }
    .record-table tr:hover td.discipline-cell .remove-row-btn { opacity: 1; }
    .record-table td.discipline-cell .remove-row-btn:hover { background: #FFEBEE; color: var(--error); }
    .record-table input.record-input {
      width: 100%;
      border: none;
      background: transparent;
      text-align: center;
      font-size: 15px;
      padding: 4px;
      outline: none;
    }
    .record-table input.record-input:focus {
      background: rgba(49, 130, 246, 0.05);
      border-radius: 4px;
    }
    .record-table input.record-input::placeholder {
      color: var(--text-tertiary);
      font-size: 13px;
    }
    .record-table th .remove-col-btn {
      display: inline-block;
      margin-left: 4px;
      width: 16px;
      height: 16px;
      border: none;
      background: transparent;
      color: var(--text-tertiary);
      cursor: pointer;
      font-size: 9px;
      opacity: 0;
      transition: opacity 0.15s;
      vertical-align: middle;
      border-radius: 4px;
    }
    .record-table th:hover .remove-col-btn { opacity: 1; }
    .record-table th .remove-col-btn:hover { background: #FFEBEE; color: var(--error); }
    
    /* ì¶”ê°€ ë²„íŠ¼ë“¤ */
    .add-col-btn {
      width: 36px;
      min-width: 36px;
      background: var(--bg);
      border: 1px dashed var(--divider);
      border-left: none;
      border-radius: 0 12px 12px 0;
      cursor: pointer;
      color: var(--text-tertiary);
      font-size: 14px;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .add-col-btn:hover { background: rgba(49, 130, 246, 0.05); color: var(--primary); }
    .add-row-btn {
      width: 100%;
      padding: 12px;
      margin-top: 8px;
      background: var(--bg);
      border: 1px dashed var(--divider);
      border-radius: 8px;
      cursor: pointer;
      color: var(--text-tertiary);
      font-size: 14px;
      transition: all 0.15s;
    }
    .add-row-btn:hover { background: rgba(49, 130, 246, 0.05); color: var(--primary); }

    /* ì¼ê´„ ì¶”ê°€ - ë‚ ì§œ ì…ë ¥ í–‰ */
    .bulk-date-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      align-items: center;
    }
    .bulk-date-row .date-input-wrapper {
      flex: 1;
      position: relative;
    }
    .bulk-date-row .date-display {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 15px;
      background: var(--surface);
      text-align: center;
      font-family: 'SF Mono', Monaco, monospace;
      letter-spacing: 1px;
    }
    .bulk-date-row .date-display:focus {
      outline: none;
      border-color: var(--primary);
    }
    .bulk-date-row .date-display::placeholder {
      color: var(--text-tertiary);
      letter-spacing: 0;
    }
    .bulk-date-row .location-input {
      flex: 1.2;
      padding: 12px 14px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 15px;
      background: var(--surface);
    }
    .bulk-date-row .location-input:focus {
      outline: none;
      border-color: var(--primary);
    }
    .bulk-date-row .remove-btn {
      width: 36px;
      height: 36px;
      border: none;
      background: transparent;
      color: var(--text-tertiary);
      cursor: pointer;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .bulk-date-row .remove-btn:hover {
      background: #FFEBEE;
      color: var(--error);
    }

    /* ì¼ê´„ ì¶”ê°€ - ë‚ ì§œ íƒ­ */
    .bulk-date-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      overflow-x: auto;
      padding-bottom: 4px;
    }
    .bulk-date-tab {
      padding: 10px 14px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.15s;
    }
    .bulk-date-tab.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    .bulk-date-tab.saved {
      background: #E8F5E9;
      border-color: var(--success);
      color: var(--success);
    }
    .bulk-date-tab.saved.active {
      background: var(--success);
      color: white;
    }

    /* ë‚ ì§œ ì¶”ê°€ ë²„íŠ¼ */
    .btn-add-date {
      padding: 8px 12px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: all 0.15s;
    }
    .btn-add-date:hover { background: #2563EB; }

    /* ìº˜ë¦°ë” ìŠ¤íƒ€ì¼ */
    .calendar-container {
      background: var(--surface);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .calendar-nav {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .calendar-nav-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: var(--bg);
      border-radius: 8px;
      cursor: pointer;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .calendar-nav-btn:hover {
      background: var(--divider);
      color: var(--text-primary);
    }
    .calendar-month {
      font-size: 16px;
      font-weight: 600;
    }
    .calendar-weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      text-align: center;
      margin-bottom: 8px;
    }
    .calendar-weekday {
      font-size: 12px;
      color: var(--text-tertiary);
      font-weight: 500;
      padding: 8px 0;
    }
    .calendar-weekday:first-child {
      color: #F44336;
    }
    .calendar-weekday:last-child {
      color: #3182F6;
    }

    /* ì„ íƒëœ ë‚ ì§œ ì¼ì • ì¹´ë“œ */
    .selected-date-header {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .selected-date-header i {
      color: var(--primary);
    }
    .schedule-detail-card {
      background: var(--surface);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 12px;
    }
    .schedule-detail-card .schedule-date-time {
      font-weight: 600;
      font-size: 15px;
      margin-bottom: 4px;
    }
    .schedule-detail-card .schedule-location,
    .schedule-detail-card .schedule-instructor {
      color: var(--text-secondary);
      font-size: 14px;
      margin-bottom: 4px;
    }
    .my-schedule-badge {
      display: inline-block;
      padding: 4px 10px;
      background: var(--primary-light);
      color: var(--primary);
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 8px;
    }
    /* ë©”ëª¨ ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
    .memo-section {
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid var(--divider);
    }
    .memo-section-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .memo-section-title i {
      color: var(--primary);
    }
    .memo-card {
      background: var(--bg);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 10px;
    }
    .memo-card-header {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .memo-card-header.instructor {
      color: var(--primary);
    }
    .memo-card-header.student {
      color: var(--success);
    }
    .memo-card-content {
      font-size: 14px;
      color: var(--text-primary);
      line-height: 1.5;
    }
    .memo-card-empty {
      font-size: 13px;
      color: var(--text-tertiary);
      font-style: italic;
    }
    .memo-textarea {
      width: 100%;
      min-height: 80px;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 14px;
      font-family: inherit;
      resize: vertical;
      background: var(--surface);
    }
    .memo-textarea:focus {
      outline: none;
      border-color: var(--primary);
    }
    .memo-textarea::placeholder {
      color: var(--text-tertiary);
    }
    /* ë¡œë”© ì¸ë””ì¼€ì´í„° */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 40px;
    }
    .loading-spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--divider);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="app" id="app">
    <!-- ë¡œê·¸ì¸ í™”ë©´ -->
    <div class="screen active" id="screen-login">
      <div class="login-screen">
        <div class="login-logo">
          <i class="fas fa-water"></i>
          <h1>DiveLog</h1>
          <p>í”„ë¦¬ë‹¤ì´ë¹™ ê¸°ë¡ì„ í•œëˆˆì—</p>
        </div>
        <div class="login-form">
          <div class="input-group">
            <label class="input-label">ì—°ë½ì²˜</label>
            <div class="phone-input-wrapper">
              <span class="phone-prefix">010-</span>
              <input type="tel" class="input phone-input" id="login-phone" placeholder="0000-0000" maxlength="9">
            </div>
          </div>
          <div class="input-group" style="margin-top: 12px;">
            <label class="input-label">ì•„ì´ë””</label>
            <input type="text" class="input" id="login-userid" placeholder="ì•„ì´ë”” ì…ë ¥">
          </div>
          <button class="btn btn-primary" onclick="handleLogin()">ì‹œì‘í•˜ê¸°</button>
        </div>
      </div>
    </div>

    <!-- ê°•ì‚¬ ëŒ€ì‹œë³´ë“œ -->
    <div class="screen" id="screen-instructor-home">
      <div class="container">
        <div style="padding: 20px 0;">
          <div class="greeting">ì•ˆë…•í•˜ì„¸ìš”, <span id="instructor-name">ì½”ì¹˜</span>ë‹˜ ğŸ‘‹</div>
          <div class="greeting-sub">ì˜¤ëŠ˜ë„ ì¢‹ì€ ê°•ìŠµ ë˜ì„¸ìš”</div>
        </div>
        <div class="section-title"><i class="fas fa-calendar-day"></i> ì˜¤ëŠ˜ì˜ ì¼ì •</div>
        <div id="today-schedules"></div>
        <div class="section-title" style="margin-top: 24px;"><i class="fas fa-bolt"></i> ë¹ ë¥¸ ì‹¤í–‰</div>
        <div class="quick-actions">
          <button class="quick-btn" onclick="openScheduleForm()"><i class="fas fa-calendar-plus"></i><span>ì¼ì • ë“±ë¡</span></button>
          <button class="quick-btn" onclick="showScreen('screen-dry-manage')"><i class="fas fa-lungs"></i><span>ë“œë¼ì´<br>íŠ¸ë ˆì´ë‹</span></button>
          <button class="quick-btn" onclick="quickRecordInput()"><i class="fas fa-pen"></i><span>ìµœê·¼ ê°•ìŠµ<br>ê¸°ë¡ ì…ë ¥</span></button>
        </div>
        <div class="card" style="margin-top: 24px;">
          <div class="section-title"><i class="fas fa-chart-bar"></i> ì´ë²ˆ ì£¼ ìš”ì•½</div>
          <div id="instructor-stats" style="color: var(--text-secondary);"></div>
        </div>
      </div>
      <div class="tab-bar">
        <button class="tab-item active" onclick="showScreen('screen-instructor-home')"><i class="fas fa-home"></i><span>í™ˆ</span></button>
        <button class="tab-item" onclick="showScreen('screen-schedule-manage')"><i class="fas fa-calendar"></i><span>ì¼ì •</span></button>
        <button class="tab-item" onclick="showScreen('screen-dry-manage')"><i class="fas fa-lungs"></i><span>ë“œë¼ì´</span></button>
        <button class="tab-item" onclick="showScreen('screen-my-records')"><i class="fas fa-chart-line"></i><span>ë‚´ê¸°ë¡</span></button>
        <button class="tab-item" onclick="showScreen('screen-mypage')"><i class="fas fa-user"></i><span>ë§ˆì´</span></button>
      </div>
    </div>

    <!-- ê°•ìŠµìƒ ëŒ€ì‹œë³´ë“œ -->
    <div class="screen" id="screen-student-home">
      <div class="container">
        <div style="padding: 20px 0;">
          <div class="greeting">ì•ˆë…•í•˜ì„¸ìš”, <span id="student-name">ê°•ìŠµìƒ</span>ë‹˜ ğŸŠâ€â™‚ï¸</div>
          <div class="greeting-sub">ê¾¸ì¤€íˆ ì„±ì¥í•˜ê³  ìˆì–´ìš”!</div>
        </div>

        <!-- ë ˆë²¨ë³„ ì§„ë„ ì°¨íŠ¸ ì„¹ì…˜ -->
        <div id="level-progress-section" style="display: none;">
          <div class="section-title" id="level-progress-title"><i class="fas fa-graduation-cap"></i> Level ì§„ë„</div>
          <div id="level-progress-summary" style="color: var(--text-secondary); font-size: 14px; margin: -8px 0 16px; padding-left: 24px;"></div>
          <div class="lv-charts">
            <div class="lv-chart-card">
              <div class="chart-header" onclick="toggleChecklist('skills')">
                ìŠ¤í‚¬ ì²´í¬ë¦¬ìŠ¤íŠ¸
                <i class="fas fa-chevron-down toggle-icon" id="skills-toggle-icon"></i>
              </div>
              <div class="donut-container">
                <canvas id="skills-chart"></canvas>
                <div class="donut-center">
                  <div class="donut-value" id="skills-progress-value">0/0</div>
                  <div class="donut-label">ì™„ë£Œ</div>
                </div>
              </div>
              <div class="checklist" id="skills-checklist"></div>
            </div>
            
            <div class="lv-chart-card">
              <div class="chart-header" onclick="toggleChecklist('records')">
                ê¸°ë¡ ë‹¬ì„±
                <i class="fas fa-chevron-down toggle-icon" id="records-toggle-icon"></i>
              </div>
              <div class="donut-container">
                <canvas id="records-chart"></canvas>
                <div class="donut-center">
                  <div class="donut-value" id="records-progress-value">0/0</div>
                  <div class="donut-label">ë‹¬ì„±</div>
                </div>
              </div>
              <div class="checklist" id="records-checklist"></div>
            </div>
          </div>
        </div>

        <div class="section-title"><i class="fas fa-trophy"></i> ì¢…ëª©ë³„ ìµœê³  ê¸°ë¡</div>
        <div class="stat-grid" id="best-records"></div>
        
        <div class="section-title"><i class="fas fa-calendar"></i> ë‹¤ê°€ì˜¤ëŠ” ì¼ì •</div>
        <div id="upcoming-schedules"></div>
        
        <!-- ë“œë¼ì´ íŠ¸ë ˆì´ë‹ ì„¹ì…˜ -->
        <div class="section-title" style="margin-top: 24px;"><i class="fas fa-lungs"></i> ë“œë¼ì´ íŠ¸ë ˆì´ë‹</div>
        <div id="home-dry-training"></div>
      </div>
      <div class="tab-bar">
        <button class="tab-item active" onclick="showScreen('screen-student-home')"><i class="fas fa-home"></i><span>í™ˆ</span></button>
        <button class="tab-item" onclick="showScreen('screen-student-schedule')"><i class="fas fa-calendar"></i><span>ì¼ì •</span></button>
        <button class="tab-item" onclick="showScreen('screen-dry-training')"><i class="fas fa-lungs"></i><span>ë“œë¼ì´</span></button>
        <button class="tab-item" onclick="showScreen('screen-my-records')"><i class="fas fa-chart-line"></i><span>ë‚´ê¸°ë¡</span></button>
        <button class="tab-item" onclick="showScreen('screen-mypage')"><i class="fas fa-user"></i><span>ë§ˆì´</span></button>
      </div>
    </div>

    <!-- ì¼ì • ê´€ë¦¬ (ê°•ì‚¬) -->
    <div class="screen" id="screen-schedule-manage">
      <div class="header">
        <button class="header-back" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">ì¼ì • ê´€ë¦¬</span>
        <div style="display: flex; align-items: center; gap: 12px;">
          <div class="mode-switch-container">
            <button class="mode-switch-btn active" id="schedule-calendar-btn" onclick="setScheduleViewMode('calendar')">
              <i class="fas fa-calendar-alt"></i>
            </button>
            <button class="mode-switch-btn" id="schedule-list-btn" onclick="setScheduleViewMode('list')">
              <i class="fas fa-list"></i>
            </button>
          </div>
          <button class="header-action" onclick="openScheduleForm()">ì¶”ê°€</button>
        </div>
      </div>
      <div class="container">
        <!-- ë¦¬ìŠ¤íŠ¸ ëª¨ë“œ -->
        <div id="schedule-list-mode" style="display: none;">
          <div id="schedule-list">
            <div class="loading"><div class="loading-spinner"></div></div>
          </div>
        </div>
        
        <!-- ìº˜ë¦°ë” ëª¨ë“œ -->
        <div id="schedule-calendar-mode">
          <!-- ìº˜ë¦°ë” í—¤ë” -->
          <div class="calendar-header">
            <button class="calendar-nav" onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
            <span class="calendar-title" id="calendar-title">2025ë…„ 12ì›”</span>
            <button class="calendar-nav" onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
          </div>
          
          <!-- ìº˜ë¦°ë” ê·¸ë¦¬ë“œ -->
          <div class="calendar-grid">
            <div class="calendar-weekdays">
              <span class="weekday sun">ì¼</span>
              <span class="weekday">ì›”</span>
              <span class="weekday">í™”</span>
              <span class="weekday">ìˆ˜</span>
              <span class="weekday">ëª©</span>
              <span class="weekday">ê¸ˆ</span>
              <span class="weekday sat">í† </span>
            </div>
            <div class="calendar-days" id="calendar-days"></div>
          </div>
          
          <!-- ë²”ë¡€ -->
          <div class="calendar-legend">
            <span><span style="display: inline-block; width: 10px; height: 10px; background: #BFDBFE; border-radius: 50%; vertical-align: middle;"></span> ê°•ìŠµ</span>
            <span><span style="display: inline-block; width: 10px; height: 10px; background: #BBF7D0; border-radius: 50%; vertical-align: middle;"></span> ê°œì¸</span>
            <span><span style="display: inline-block; width: 10px; height: 10px; background: #FED7AA; border-radius: 50%; vertical-align: middle;"></span> ë“œë¼ì´</span>
          </div>
          
          <!-- ì„ íƒëœ ë‚ ì§œ ì¼ì • -->
          <div class="selected-date-header" id="selected-date-header">
            <i class="fas fa-calendar"></i> <span id="selected-date-text">12ì›” 19ì¼ (ëª©)</span>
          </div>
          <div id="calendar-schedule-list"></div>
        </div>
      </div>
      <div class="tab-bar">
        <button class="tab-item" onclick="showScreen('screen-instructor-home')"><i class="fas fa-home"></i><span>í™ˆ</span></button>
        <button class="tab-item active"><i class="fas fa-calendar"></i><span>ì¼ì •</span></button>
        <button class="tab-item" onclick="showScreen('screen-dry-manage')"><i class="fas fa-lungs"></i><span>ë“œë¼ì´</span></button>
        <button class="tab-item" onclick="showScreen('screen-my-records')"><i class="fas fa-chart-line"></i><span>ë‚´ê¸°ë¡</span></button>
        <button class="tab-item" onclick="showScreen('screen-mypage')"><i class="fas fa-user"></i><span>ë§ˆì´</span></button>
      </div>
    </div>

    <!-- ì°¸ê°€ì ê´€ë¦¬ -->
    <div class="screen" id="screen-participants">
      <div class="header">
        <button class="header-back" onclick="showScreen('screen-schedule-manage')"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">ì°¸ê°€ì ê´€ë¦¬</span>
        <button class="header-action" onclick="openAddParticipant()">ì¶”ê°€</button>
      </div>
      <div class="container">
        <div class="card" style="margin-bottom: 20px;">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
            <i class="fas fa-calendar" style="color: var(--primary);"></i>
            <span id="participant-schedule-date" style="font-weight: 600;"></span>
          </div>
          <div style="display: flex; align-items: center; gap: 8px; color: var(--text-secondary);">
            <i class="fas fa-map-marker-alt"></i>
            <span id="participant-schedule-location"></span>
          </div>
        </div>
        <div class="section-title">ê°•ìŠµ</div>
        <div class="card" id="lesson-participants">
          <div class="loading"><div class="loading-spinner"></div></div>
        </div>
        <div class="section-title" style="margin-top: 20px;">í€ë‹¤ì´ë¹™</div>
        <div class="card" id="fun-participants">
          <div style="text-align: center; color: var(--text-secondary); padding: 20px;">í€ë‹¤ì´ë¹™ ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤</div>
        </div>
      </div>
    </div>

    <!-- ë“œë¼ì´ íŠ¸ë ˆì´ë‹ ê´€ë¦¬ (ê°•ì‚¬) -->
    <div class="screen" id="screen-dry-manage">
      <div class="header">
        <button class="header-back" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">ë“œë¼ì´ íŠ¸ë ˆì´ë‹ ê´€ë¦¬</span>
        <button class="header-action" onclick="openDryForm()">ì¶”ê°€</button>
      </div>
      <div class="container">
        <div class="section-title"><i class="fas fa-list"></i> íŠ¸ë ˆì´ë‹ ëª©ë¡</div>
        <div id="dry-training-list"></div>
      </div>
      <div class="tab-bar">
        <button class="tab-item" onclick="showScreen('screen-instructor-home')"><i class="fas fa-home"></i><span>í™ˆ</span></button>
        <button class="tab-item" onclick="showScreen('screen-schedule-manage')"><i class="fas fa-calendar"></i><span>ì¼ì •</span></button>
        <button class="tab-item active"><i class="fas fa-lungs"></i><span>ë“œë¼ì´</span></button>
        <button class="tab-item" onclick="showScreen('screen-my-records')"><i class="fas fa-chart-line"></i><span>ë‚´ê¸°ë¡</span></button>
        <button class="tab-item" onclick="showScreen('screen-mypage')"><i class="fas fa-user"></i><span>ë§ˆì´</span></button>
      </div>
    </div>

    <!-- ê°•ìŠµìƒ ì¼ì • -->
    <div class="screen" id="screen-student-schedule">
      <div class="header">
        <button class="header-back" onclick="showScreen('screen-student-home')"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">ì¼ì •</span>
        <div class="mode-switch-container">
          <button class="mode-switch-btn active" id="student-calendar-btn" onclick="setStudentScheduleViewMode('calendar')">
            <i class="fas fa-calendar-alt"></i>
          </button>
          <button class="mode-switch-btn" id="student-list-btn" onclick="setStudentScheduleViewMode('list')">
            <i class="fas fa-list"></i>
          </button>
        </div>
      </div>
      <div class="container">
        <!-- ë¦¬ìŠ¤íŠ¸ ëª¨ë“œ -->
        <div id="student-schedule-list-mode" style="display: none;">
          <div id="available-schedules">
            <div class="loading"><div class="loading-spinner"></div></div>
          </div>
        </div>
        
        <!-- ìº˜ë¦°ë” ëª¨ë“œ -->
        <div id="student-schedule-calendar-mode">
          <!-- ìº˜ë¦°ë” í—¤ë” -->
          <div class="calendar-header">
            <button class="calendar-nav" onclick="changeStudentMonth(-1)"><i class="fas fa-chevron-left"></i></button>
            <span class="calendar-title" id="student-calendar-title">2025ë…„ 12ì›”</span>
            <button class="calendar-nav" onclick="changeStudentMonth(1)"><i class="fas fa-chevron-right"></i></button>
          </div>
          
          <!-- ìº˜ë¦°ë” ê·¸ë¦¬ë“œ -->
          <div class="calendar-grid">
            <div class="calendar-weekdays">
              <span class="weekday sun">ì¼</span>
              <span class="weekday">ì›”</span>
              <span class="weekday">í™”</span>
              <span class="weekday">ìˆ˜</span>
              <span class="weekday">ëª©</span>
              <span class="weekday">ê¸ˆ</span>
              <span class="weekday sat">í† </span>
            </div>
            <div class="calendar-days" id="student-calendar-days"></div>
          </div>
          
          <!-- ë²”ë¡€ -->
          <div class="calendar-legend">
            <span><span style="display: inline-block; width: 10px; height: 10px; background: #BFDBFE; border-radius: 50%; vertical-align: middle;"></span> ë‹¤ì´ë¹™</span>
            <span><span style="display: inline-block; width: 10px; height: 10px; background: #FED7AA; border-radius: 50%; vertical-align: middle;"></span> ë“œë¼ì´</span>
          </div>
          
          <!-- ì„ íƒëœ ë‚ ì§œ ì¼ì • -->
          <div class="selected-date-header">
            <i class="fas fa-calendar"></i> <span id="student-selected-date-text">12ì›” 19ì¼ (ëª©)</span>
          </div>
          <div id="student-calendar-schedule-list"></div>
        </div>
      </div>
      <div class="tab-bar">
        <button class="tab-item" onclick="showScreen('screen-student-home')"><i class="fas fa-home"></i><span>í™ˆ</span></button>
        <button class="tab-item active"><i class="fas fa-calendar"></i><span>ì¼ì •</span></button>
        <button class="tab-item" onclick="showScreen('screen-dry-training')"><i class="fas fa-lungs"></i><span>ë“œë¼ì´</span></button>
        <button class="tab-item" onclick="showScreen('screen-my-records')"><i class="fas fa-chart-line"></i><span>ë‚´ê¸°ë¡</span></button>
        <button class="tab-item" onclick="showScreen('screen-mypage')"><i class="fas fa-user"></i><span>ë§ˆì´</span></button>
      </div>
    </div>

    <!-- í•™ìƒ ì¼ì • ìƒì„¸ í™”ë©´ -->
    <div class="screen" id="screen-schedule-detail">
      <div class="header">
        <button class="header-back" onclick="showScreen('screen-student-schedule')"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">ì¼ì • ìƒì„¸</span>
      </div>
      <div class="container">
        <!-- ì¼ì • ì •ë³´ -->
        <div class="card" id="schedule-detail-info"></div>
        
        <!-- ê¸°ë¡ ë³´ê¸° (ìœ„ë¡œ ì´ë™) -->
        <div class="card" id="schedule-detail-records" style="display: none;">
          <div class="section-title" style="margin-bottom: 12px;"><i class="fas fa-chart-bar"></i> ì´ ë‚ ì˜ ê¸°ë¡</div>
          <div id="schedule-detail-records-list"></div>
        </div>
        
        <!-- ê°•ì‚¬ í”¼ë“œë°± (ì½ê¸° ì „ìš©) -->
        <div class="card" id="schedule-detail-instructor-note" style="display: none;">
          <div class="section-title" style="margin-bottom: 8px;"><i class="fas fa-comment"></i> ê°•ì‚¬ í”¼ë“œë°±</div>
          <p id="schedule-detail-instructor-note-text" style="color: var(--text-secondary); font-size: 14px; line-height: 1.5;"></p>
        </div>
        
        <!-- ë‚´ ëŠë‚€ì  ì…ë ¥ -->
        <div class="card">
          <div class="section-title" style="margin-bottom: 8px;"><i class="fas fa-pen"></i> ë‚´ ëŠë‚€ì </div>
          <textarea class="input" id="schedule-detail-my-note" rows="3" placeholder="ì´ ë‚ ì˜ ëŠë‚€ì ì„ ê¸°ë¡í•´ë³´ì„¸ìš”"></textarea>
          <button class="btn btn-primary" style="width: 100%; margin-top: 12px;" onclick="saveStudentNote()">ì €ì¥</button>
        </div>
      </div>
      <div class="tab-bar">
        <button class="tab-item" onclick="showScreen('screen-student-home')"><i class="fas fa-home"></i><span>í™ˆ</span></button>
        <button class="tab-item active"><i class="fas fa-calendar"></i><span>ì¼ì •</span></button>
        <button class="tab-item" onclick="showScreen('screen-dry-training')"><i class="fas fa-lungs"></i><span>ë“œë¼ì´</span></button>
        <button class="tab-item" onclick="showScreen('screen-my-records')"><i class="fas fa-chart-line"></i><span>ë‚´ê¸°ë¡</span></button>
        <button class="tab-item" onclick="showScreen('screen-mypage')"><i class="fas fa-user"></i><span>ë§ˆì´</span></button>
      </div>
    </div>

    <!-- ë“œë¼ì´ íŠ¸ë ˆì´ë‹ (í•™ìƒ) -->
    <div class="screen" id="screen-dry-training">
      <div class="header">
        <button class="header-back" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">ë“œë¼ì´ íŠ¸ë ˆì´ë‹</span>
      </div>
      <div class="container">
        <!-- ì°¸ì—¬ ì¤‘ì¸ íŠ¸ë ˆì´ë‹ -->
        <div class="section-title"><i class="fas fa-fire"></i> ì°¸ì—¬ ì¤‘</div>
        <div id="my-dry-trainings"></div>
        
        <!-- ì´ë²ˆ ë‹¬ ê¸°ë¡ ìº˜ë¦°ë” (ì°¸ì—¬ ì¤‘ì¼ ë•Œë§Œ í‘œì‹œ) -->
        <div id="dry-training-calendar-section" style="display: none;">
          <div class="section-title" style="margin-top: 20px;"><i class="fas fa-calendar-check"></i> ì´ë²ˆ ë‹¬ ê¸°ë¡</div>
          <div class="card">
            <div class="calendar-header">
              <button class="calendar-nav" onclick="changeDryListMonth(-1)"><i class="fas fa-chevron-left"></i></button>
              <span class="calendar-title" id="dry-list-calendar-title">2025ë…„ 12ì›”</span>
              <button class="calendar-nav" onclick="changeDryListMonth(1)"><i class="fas fa-chevron-right"></i></button>
            </div>
            <div class="calendar-grid">
              <div class="calendar-weekdays">
                <span class="weekday sun">ì¼</span>
                <span class="weekday">ì›”</span>
                <span class="weekday">í™”</span>
                <span class="weekday">ìˆ˜</span>
                <span class="weekday">ëª©</span>
                <span class="weekday">ê¸ˆ</span>
                <span class="weekday sat">í† </span>
              </div>
              <div class="calendar-days" id="dry-list-calendar-days"></div>
            </div>
          </div>
        </div>
        
        <!-- ì „ì²´ íŠ¸ë ˆì´ë‹ ëª©ë¡ (ì°¸ì—¬ ì•ˆí•œ ê²ƒë§Œ) -->
        <div id="other-dry-trainings-section" style="display: none;">
          <div class="section-title" style="margin-top: 24px;"><i class="fas fa-list"></i> ì°¸ì—¬ì¤‘ì´ì§€ ì•Šì€ íŠ¸ë ˆì´ë‹</div>
          <div id="all-dry-trainings"></div>
        </div>
        
        <!-- ì „ì²´ íŠ¸ë ˆì´ë‹ ëª©ë¡ (ì°¸ì—¬ ì•ˆí–ˆì„ ë•Œ) -->
        <div id="all-dry-trainings-section" style="display: none;">
          <div class="section-title" style="margin-top: 24px;"><i class="fas fa-list"></i> ì „ì²´ íŠ¸ë ˆì´ë‹</div>
          <div id="all-dry-trainings-no-participation"></div>
        </div>
      </div>
      <div class="tab-bar">
        <button class="tab-item" onclick="showScreen('screen-student-home')"><i class="fas fa-home"></i><span>í™ˆ</span></button>
        <button class="tab-item" onclick="showScreen('screen-student-schedule')"><i class="fas fa-calendar"></i><span>ì¼ì •</span></button>
        <button class="tab-item active"><i class="fas fa-lungs"></i><span>ë“œë¼ì´</span></button>
        <button class="tab-item" onclick="showScreen('screen-my-records')"><i class="fas fa-chart-line"></i><span>ë‚´ê¸°ë¡</span></button>
        <button class="tab-item" onclick="showScreen('screen-mypage')"><i class="fas fa-user"></i><span>ë§ˆì´</span></button>
      </div>
    </div>

    <!-- ë“œë¼ì´ íŠ¸ë ˆì´ë‹ ìƒì„¸ -->

    <!-- ë‚˜ì˜ ê¸°ë¡ -->
    <div class="screen" id="screen-my-records">
      <div class="header">
        <button class="header-back" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">ë‚˜ì˜ ê¸°ë¡</span>
        <div style="display: flex; gap: 8px;">
          <button class="header-action" style="color: var(--text-secondary);" onclick="openPersonalBulkAdd()">ì¼ê´„</button>
          <button class="header-action" onclick="openPersonalRecordAdd()">ì¶”ê°€</button>
        </div>
      </div>
      <div class="container">
        <!-- ì„±ì¥ ê·¸ë˜í”„ -->
        <div class="card" id="growth-chart-card">
          <div class="section-title" style="margin-bottom: 12px;"><i class="fas fa-chart-line"></i> ì„±ì¥ ê·¸ë˜í”„</div>
          <div class="discipline-tabs" id="chart-discipline-tabs">
            <button class="disc-tab active" data-disc="STA" onclick="selectChartDiscipline('STA')">STA</button>
            <button class="disc-tab" data-disc="DYNB" onclick="selectChartDiscipline('DYNB')">DYNB</button>
            <button class="disc-tab" data-disc="FIM" onclick="selectChartDiscipline('FIM')">FIM</button>
            <button class="disc-tab" data-disc="CWTB" onclick="selectChartDiscipline('CWTB')">CWTB</button>
          </div>
          <div style="height: 200px; position: relative;">
            <canvas id="growth-chart"></canvas>
          </div>
        </div>
        
        <div class="section-title" style="margin-top: 20px;"><i class="fas fa-trophy"></i> ì¢…ëª©ë³„ ìµœê³  ê¸°ë¡</div>
        <div class="card" id="my-best-records">
          <div class="loading"><div class="loading-spinner"></div></div>
        </div>
        <div class="section-title" style="margin-top: 20px;"><i class="fas fa-list"></i> ì „ì²´ ê¸°ë¡</div>
        <div class="card" id="my-all-records">
          <div style="text-align: center; color: var(--text-secondary); padding: 20px;">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>
        </div>
      </div>
      <div class="tab-bar" id="my-records-tabbar">
        <!-- ë™ì ìœ¼ë¡œ ë Œë”ë§ -->
      </div>
    </div>

    <!-- Bottom Sheet: ì¼ì • ë“±ë¡ -->
    <div class="bottom-sheet-overlay" id="sheet-schedule">
      <div class="bottom-sheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-content">
          <div class="bottom-sheet-title" id="schedule-form-title">ìƒˆ ì¼ì • ë“±ë¡</div>
          <input type="hidden" id="edit-schedule-id">
          <div class="input-group">
            <label class="input-label">ë‚ ì§œ</label>
            <input type="date" class="input" id="schedule-date">
          </div>
          <div class="input-group">
            <label class="input-label">ì‹œê°„</label>
            <input type="time" class="input" id="schedule-time">
          </div>
          <div class="input-group">
            <label class="input-label">ì¥ì†Œ</label>
            <input type="text" class="input" id="schedule-location" placeholder="ì¥ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
          </div>
          
          <!-- ê¸°ë¡ ì¢…ëª© ì„ íƒ (í† ê¸€) -->
          <div class="input-group">
            <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleScheduleSection('disc')">
              <label class="input-label" style="margin-bottom: 0;">ê¸°ë¡ ì¢…ëª©</label>
              <span style="color: var(--text-tertiary); font-size: 13px;" id="schedule-disc-toggle">ì„ íƒ</span>
            </div>
            <div id="schedule-disc-section" style="display: none; margin-top: 8px;">
              <div style="display: flex; flex-wrap: wrap; gap: 4px;" id="schedule-disc-checks">
                <label style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;"><input type="checkbox" value="STA" checked> STA</label>
                <label style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;"><input type="checkbox" value="DYNB" checked> DYNB</label>
                <label style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;"><input type="checkbox" value="FIM" checked> FIM</label>
                <label style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;"><input type="checkbox" value="CWTB" checked> CWTB</label>
                <label style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;"><input type="checkbox" value="DNF"> DNF</label>
                <label style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;"><input type="checkbox" value="CNF"> CNF</label>
                <label style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;"><input type="checkbox" value="DYN"> DYN</label>
                <label style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;"><input type="checkbox" value="CWT"> CWT</label>
              </div>
            </div>
          </div>
          
          <!-- ìŠ¤í‚¬ ì¢…ëª© ì„ íƒ (í† ê¸€) -->
          <div class="input-group">
            <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleScheduleSection('skill')">
              <label class="input-label" style="margin-bottom: 0;">ìŠ¤í‚¬ ì¢…ëª©</label>
              <span style="color: var(--text-tertiary); font-size: 13px;" id="schedule-skill-toggle">ì„ íƒ</span>
            </div>
            <div id="schedule-skill-section" style="display: none; margin-top: 8px;">
              <div style="font-size: 12px; color: var(--text-tertiary); margin-bottom: 6px;">Lv2</div>
              <div style="display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 12px;">
                <label style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;"><input type="checkbox" value="ë ˆìŠ¤í 5-10m"> ë ˆìŠ¤í 5-10m</label>
                <label style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;"><input type="checkbox" value="ì´ë¡  í‰ê°€"> ì´ë¡  í‰ê°€</label>
              </div>
              <div style="font-size: 12px; color: var(--text-tertiary); margin-bottom: 6px;">Lv3</div>
              <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                <label style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;"><input type="checkbox" value="ë Œì•¼ë“œ ì œê±°"> ë Œì•¼ë“œ ì œê±°</label>
                <label style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;"><input type="checkbox" value="ë…¸ë§ˆìŠ¤í¬ 10m"> ë…¸ë§ˆìŠ¤í¬ 10m</label>
                <label style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;"><input type="checkbox" value="ë ˆìŠ¤í+í† ì‰"> ë ˆìŠ¤í+í† ì‰</label>
                <label style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;"><input type="checkbox" value="ì¤‘ì„±ë¶€ë ¥"> ì¤‘ì„±ë¶€ë ¥</label>
                <label style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;"><input type="checkbox" value="í”„ë¦¬í´"> í”„ë¦¬í´</label>
                <label style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;"><input type="checkbox" value="ì•”ìŠ¤ì˜¨ë¦¬ 15m"> ì•”ìŠ¤ì˜¨ë¦¬ 15m</label>
                <label style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;"><input type="checkbox" value="ë²„ë”” 10-15m"> ë²„ë”” 10-15m</label>
                <label style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px;"><input type="checkbox" value="ì´ë¡  í‰ê°€_lv3"> ì´ë¡  í‰ê°€</label>
              </div>
            </div>
          </div>
          
          <button class="btn btn-primary" onclick="saveSchedule()">ì €ì¥í•˜ê¸°</button>
          <button class="btn btn-secondary" style="margin-top: 8px;" onclick="closeBottomSheet('sheet-schedule')">ì·¨ì†Œ</button>
        </div>
      </div>
    </div>

    <!-- Bottom Sheet: ì°¸ê°€ì ì¶”ê°€ -->
    <div class="bottom-sheet-overlay" id="sheet-add-participant">
      <div class="bottom-sheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-content">
          <div class="bottom-sheet-title">ì°¸ê°€ì ì¶”ê°€</div>
          <div class="input-group">
            <label class="input-label">ê°•ìŠµìƒ ì„ íƒ</label>
            <select class="input" id="participant-student"></select>
          </div>
          <div class="input-group">
            <label class="input-label">ì°¸ê°€ ëª©ì </label>
            <div class="purpose-buttons">
              <button class="purpose-btn selected" data-purpose="ê°•ìŠµ" onclick="selectPurpose(this)">ê°•ìŠµ</button>
              <button class="purpose-btn" data-purpose="í€ë‹¤ì´ë¹™" onclick="selectPurpose(this)">í€ë‹¤ì´ë¹™</button>
            </div>
          </div>
          <div class="input-group" id="lesson-level-group">
            <label class="input-label">ê°•ìŠµ ë ˆë²¨</label>
            <select class="input" id="participant-level">
              <option value="2">Level 2</option>
              <option value="3">Level 3</option>
              <option value="4">Level 4</option>
            </select>
          </div>
          <button class="btn btn-primary" onclick="addParticipant()">ì¶”ê°€í•˜ê¸°</button>
        </div>
      </div>
    </div>

    <!-- ì¼ì • ê´€ë¦¬ (ê°•ì‚¬ìš©) -->
    <div class="screen" id="screen-schedule-manage">
      <div class="header">
        <button class="header-back" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">ì¼ì • ê´€ë¦¬</span>
        <button class="header-action" onclick="openScheduleForm()">ì¶”ê°€</button>
      </div>
      <div class="container">
        <div id="schedule-list">
          <div class="loading"><div class="loading-spinner"></div></div>
        </div>
      </div>
      <div class="tab-bar">
        <button class="tab-item" onclick="showScreen('screen-instructor-home')"><i class="fas fa-home"></i><span>í™ˆ</span></button>
        <button class="tab-item active"><i class="fas fa-calendar"></i><span>ì¼ì •</span></button>
        <button class="tab-item" onclick="showScreen('screen-my-records')"><i class="fas fa-chart-line"></i><span>ë‚´ê¸°ë¡</span></button>
        <button class="tab-item" onclick="showScreen('screen-mypage')"><i class="fas fa-user"></i><span>ë§ˆì´</span></button>
      </div>
    </div>

    <!-- ì°¸ê°€ì ê´€ë¦¬ -->
    <div class="screen" id="screen-participants">
      <div class="header">
        <button class="header-back" onclick="showScreen('screen-schedule-manage')"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">ì°¸ê°€ì ê´€ë¦¬</span>
        <button class="header-action" onclick="openAddParticipant()">ì¶”ê°€</button>
      </div>
      <div class="container">
        <div class="card" style="margin-bottom: 20px;">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
            <i class="fas fa-calendar" style="color: var(--primary);"></i>
            <span id="participant-schedule-date" style="font-weight: 600;"></span>
          </div>
          <div style="display: flex; align-items: center; gap: 8px; color: var(--text-secondary);">
            <i class="fas fa-map-marker-alt"></i>
            <span id="participant-schedule-location"></span>
          </div>
        </div>
        <button class="btn btn-primary" style="margin-bottom: 20px;" onclick="openBatchRecordInput()">
          <i class="fas fa-pen"></i> ì¼ê´„ ê¸°ë¡ ì…ë ¥
        </button>
        <div class="section-title">ê°•ìŠµ</div>
        <div class="card" id="lesson-participants"></div>
        <div class="section-title" style="margin-top: 20px;">í€ë‹¤ì´ë¹™</div>
        <div class="card" id="fun-participants"></div>
      </div>
    </div>

    <!-- ê°•ìŠµìƒ ì¼ì • í™”ë©´ -->
    <div class="screen" id="screen-student-schedule">
      <div class="header">
        <button class="header-back" onclick="showScreen('screen-student-home')"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">ì¼ì •</span>
      </div>
      <div class="container">
        <div id="student-schedule-list">
          <div class="loading"><div class="loading-spinner"></div></div>
        </div>
      </div>
      <div class="tab-bar">
        <button class="tab-item" onclick="showScreen('screen-student-home')"><i class="fas fa-home"></i><span>í™ˆ</span></button>
        <button class="tab-item active"><i class="fas fa-calendar"></i><span>ì¼ì •</span></button>
        <button class="tab-item" onclick="showScreen('screen-my-records')"><i class="fas fa-chart-line"></i><span>ë‚´ê¸°ë¡</span></button>
        <button class="tab-item" onclick="showScreen('screen-mypage')"><i class="fas fa-user"></i><span>ë§ˆì´</span></button>
      </div>
    </div>

    <!-- ì¼ê´„ ê¸°ë¡ ì…ë ¥ í™”ë©´ (ê°•ìŠµ) -->
    <div class="screen" id="screen-batch-record">
      <div class="header">
        <button class="header-back" onclick="closeBatchRecord()"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">ê¸°ë¡ ì¼ê´„ ì…ë ¥</span>
      </div>
      <div class="container">
        <!-- ì¼ì • ì •ë³´ (ê°„ì†Œí™”) -->
        <div class="card" style="margin-bottom: 16px;">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
            <i class="fas fa-calendar" style="color: var(--primary);"></i>
            <span id="batch-schedule-date" style="font-weight: 600;"></span>
          </div>
          <div style="display: flex; align-items: center; gap: 8px; color: var(--text-secondary);">
            <i class="fas fa-map-marker-alt"></i>
            <span id="batch-schedule-location"></span>
          </div>
        </div>
        
        <!-- ê¸°ë¡ ì…ë ¥ ì¹´ë“œ -->
        <div class="card" id="batch-record-table-card">
          <!-- ê¸°ë¡ í—¤ë” + ì¢…ëª© ìˆ˜ì • -->
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <div class="section-title" style="margin: 0;"><i class="fas fa-clipboard-list"></i> ê¸°ë¡</div>
            <button style="padding: 4px 10px; background: var(--bg); border: 1px dashed var(--border); border-radius: 10px; font-size: 12px; cursor: pointer;" onclick="openBatchAddDisciplineSheet()">ì¢…ëª© ìˆ˜ì •</button>
          </div>
          
          <!-- ì¢…ëª© íƒ­ (compact) -->
          <div id="batch-discipline-tabs" style="margin-bottom: 12px;"></div>
          
          <!-- ê¸°ë¡ í…Œì´ë¸” -->
          <div class="record-table-container">
            <table class="record-table" id="batch-record-table">
              <thead>
                <tr>
                  <th class="col-name">í•™ìƒëª…</th>
                  <th class="col-attempt">1ì°¨</th>
                  <th class="col-attempt">2ì°¨</th>
                  <th class="col-add-attempt"><button class="btn-add-col" onclick="addBatchAttemptColumn()">+</button></th>
                  <th class="col-note">ë©”ëª¨</th>
                </tr>
              </thead>
              <tbody id="batch-record-tbody"></tbody>
            </table>
          </div>
        </div>
        
        <!-- ìŠ¤í‚¬ ì²´í¬ í…Œì´ë¸” (ìˆ¨ê¹€ - ì‚¬ìš© ì•ˆ í•¨) -->
        <div class="card" id="batch-skill-table-card" style="display: none;">
          <div class="record-table-container">
            <table class="record-table" id="batch-skill-table">
              <thead>
                <tr>
                  <th class="col-name">í•™ìƒëª…</th>
                </tr>
              </thead>
              <tbody id="batch-skill-tbody"></tbody>
            </table>
          </div>
        </div>
        
        <!-- ë…¸íŠ¸ ì„¹ì…˜ -->
        <div class="card" style="margin-top: 16px;">
          <div class="section-title" style="margin-bottom: 12px;"><i class="fas fa-comment-alt"></i> ë…¸íŠ¸</div>
          
          <!-- ì˜¤ëŠ˜ ì´í‰ (schedules.note) -->
          <div style="margin-bottom: 16px;">
            <label class="input-label">ì˜¤ëŠ˜ ì´í‰</label>
            <input type="text" class="input" id="batch-schedule-note" placeholder="ì˜¤ëŠ˜ ê°•ìŠµ ì „ì²´ì— ëŒ€í•œ ëŠë‚€ì ">
          </div>
          
          <!-- í•™ìƒë³„ í”¼ë“œë°± (registrations.note_instructor) -->
          <div>
            <label class="input-label">í•™ìƒë³„ í”¼ë“œë°±</label>
            <div id="batch-student-notes"></div>
          </div>
        </div>
        
        <!-- ì €ì¥ ë²„íŠ¼ -->
        <div style="display: flex; gap: 12px; margin-top: 20px;">
          <button class="btn btn-secondary" style="flex: 1;" onclick="saveBatchRecords(false)">ì €ì¥í•˜ê³  ê³„ì†</button>
          <button class="btn btn-primary" style="flex: 1;" onclick="saveBatchRecords(true)">ì €ì¥í•˜ê³  ì™„ë£Œ</button>
        </div>
      </div>
    </div>

    <!-- ê°œì¸ ê¸°ë¡ ê°œë³„ ì¶”ê°€ í™”ë©´ -->
    <div class="screen" id="screen-personal-record">
      <div class="header">
        <button class="header-back" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">ê°œì¸ ê¸°ë¡ ì…ë ¥</span>
      </div>
      <div class="container">
        <!-- ë‚ ì§œ/ì¥ì†Œ ì •ë³´ -->
        <div class="card" style="margin-bottom: 16px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <div>
              <div style="display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-calendar" style="color: var(--primary);"></i>
                <span id="personal-date-display" style="font-weight: 600;"></span>
              </div>
              <div style="display: flex; align-items: center; gap: 8px; margin-top: 4px; color: var(--text-secondary);">
                <i class="fas fa-map-marker-alt"></i>
                <span id="personal-location-display"></span>
              </div>
            </div>
            <button class="btn btn-outline btn-small" onclick="openPersonalDateEdit()">+ ë‚ ì§œ</button>
          </div>
        </div>
        
        <!-- ê¸°ë¡ í…Œì´ë¸” -->
        <div class="card">
          <div class="record-table-container">
            <table class="record-table" id="personal-record-table">
              <thead>
                <tr>
                  <th class="col-name">ì¢…ëª©</th>
                  <th class="col-attempt">1ì°¨</th>
                  <th class="col-attempt">2ì°¨</th>
                </tr>
              </thead>
              <tbody id="personal-record-tbody"></tbody>
            </table>
          </div>
          <div style="display: flex; gap: 8px; margin-top: 12px;">
            <button class="btn btn-outline btn-small" style="flex: 1;" onclick="addPersonalAttemptColumn()">
              <i class="fas fa-plus"></i> ì‹œë„ ì¶”ê°€
            </button>
            <button class="btn btn-outline btn-small" style="flex: 1;" onclick="openAddDisciplineSheet()">
              <i class="fas fa-plus"></i> ì¢…ëª© ì¶”ê°€
            </button>
          </div>
        </div>
        
        <!-- ë©”ëª¨ -->
        <div class="card" style="margin-top: 16px;">
          <div class="section-title"><i class="fas fa-sticky-note"></i> ë©”ëª¨</div>
          <textarea class="input" id="personal-memo" rows="3" placeholder="ì´ ë‹¤ì´ë¹™ì— ëŒ€í•œ ë©”ëª¨ë¥¼ ë‚¨ê²¨ë³´ì„¸ìš”... (ì»¨ë””ì…˜, ëŠë‚€ì , ê°œì„ í•  ì  ë“±)"></textarea>
        </div>
        
        <!-- ì €ì¥ ë²„íŠ¼ -->
        <div style="display: flex; gap: 12px; margin-top: 20px;">
          <button class="btn btn-secondary" style="flex: 1;" onclick="savePersonalRecord(false)">ì €ì¥í•˜ê³  ê³„ì†</button>
          <button class="btn btn-primary" style="flex: 1;" onclick="savePersonalRecord(true)">ì €ì¥í•˜ê³  ì™„ë£Œ</button>
        </div>
      </div>
    </div>

    <!-- ê°œì¸ ê¸°ë¡ ì¼ê´„ ì¶”ê°€ í™”ë©´ -->
    <div class="screen" id="screen-personal-bulk">
      <div class="header">
        <button class="header-back" onclick="showScreen('screen-my-records')"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">ì¼ê´„ ê¸°ë¡ ì¶”ê°€</span>
      </div>
      <div class="container">
        <!-- ì•ˆë‚´ -->
        <div class="card" style="background: var(--primary-light); margin-bottom: 16px;">
          <div style="display: flex; align-items: flex-start; gap: 12px;">
            <i class="fas fa-info-circle" style="color: var(--primary); margin-top: 2px;"></i>
            <div style="font-size: 14px; color: var(--text-secondary);">
              ê³¼ê±° ë‹¤ì´ë¹™ ê¸°ë¡ì„ í•œë²ˆì— ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
              ë‚ ì§œëŠ” <strong>YYMMDD</strong> í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”.<br>
              ì˜ˆ: 231112 â†’ 2023-11-12
            </div>
          </div>
        </div>
        
        <!-- ë‚ ì§œ/ì¥ì†Œ ëª©ë¡ -->
        <div class="section-title"><i class="fas fa-calendar"></i> ë‚ ì§œ/ì¥ì†Œ ëª©ë¡</div>
        <div id="bulk-date-list"></div>
        <button class="btn btn-outline" style="margin-top: 8px;" onclick="addBulkDateRow()">
          <i class="fas fa-plus"></i> ë‚ ì§œ ì¶”ê°€
        </button>
        
        <button class="btn btn-primary" style="margin-top: 20px;" onclick="proceedToBulkRecordInput()">
          ë‹¤ìŒ: ê¸°ë¡ ì…ë ¥
        </button>
      </div>
      <div class="tab-bar" id="bulk-tabbar">
        <!-- ë™ì ìœ¼ë¡œ ë Œë”ë§ -->
      </div>
    </div>

    <!-- ê°œì¸ ê¸°ë¡ ì¼ê´„ ì…ë ¥ í™”ë©´ (2ë‹¨ê³„) -->
    <div class="screen" id="screen-personal-bulk-input">
      <div class="header">
        <button class="header-back" onclick="showScreen('screen-personal-bulk')"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">ì¼ê´„ ê¸°ë¡ ì…ë ¥</span>
      </div>
      <div class="container">
        <!-- ë‚ ì§œ íƒ­ -->
        <div class="participant-tabs" id="bulk-date-tabs"></div>
        
        <!-- ê¸°ë¡ í…Œì´ë¸” -->
        <div class="card">
          <div class="record-table-container">
            <table class="record-table" id="bulk-record-table">
              <thead>
                <tr>
                  <th class="col-name">ì¢…ëª©</th>
                  <th class="col-attempt">1ì°¨</th>
                  <th class="col-attempt">2ì°¨</th>
                  <th class="col-add-attempt"><button class="btn-add-col" onclick="addBulkAttemptColumn()">+</button></th>
                </tr>
              </thead>
              <tbody id="bulk-record-tbody"></tbody>
            </table>
          </div>
          <button class="btn btn-outline" style="margin-top: 12px;" onclick="openBulkAddDisciplineSheet()">
            <i class="fas fa-plus"></i> ì¢…ëª© ì¶”ê°€
          </button>
        </div>
        
        <!-- ì €ì¥ ë²„íŠ¼ -->
        <div style="display: flex; gap: 12px; margin-top: 20px;">
          <button class="btn btn-secondary" style="flex: 1;" onclick="saveBulkRecords(false)">ì €ì¥í•˜ê³  ê³„ì†</button>
          <button class="btn btn-primary" style="flex: 1;" onclick="saveBulkRecords(true)">ì €ì¥í•˜ê³  ì™„ë£Œ</button>
        </div>
      </div>
      <div class="tab-bar" id="bulk-input-tabbar">
        <!-- ë™ì ìœ¼ë¡œ ë Œë”ë§ -->
      </div>
    </div>

    <!-- ë‚´ ê¸°ë¡ í™”ë©´ -->
    <div class="screen" id="screen-my-records">
      <div class="header">
        <button class="header-back" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">ë‚˜ì˜ ê¸°ë¡</span>
      </div>
      <div class="container">
        <div class="section-title"><i class="fas fa-trophy"></i> ì¢…ëª©ë³„ ìµœê³  ê¸°ë¡</div>
        <div class="card" id="my-best-records"></div>
        <div class="section-title" style="margin-top: 20px;"><i class="fas fa-list"></i> ì „ì²´ ê¸°ë¡</div>
        <div class="card" id="my-all-records"></div>
      </div>
      <div class="tab-bar" id="my-records-tabbar"></div>
    </div>

    <!-- ë§ˆì´í˜ì´ì§€ -->
    <div class="screen" id="screen-mypage">
      <div class="header">
        <button class="header-back" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">ë§ˆì´í˜ì´ì§€</span>
      </div>
      <div class="container">
        <div class="card" style="display: flex; align-items: center; gap: 16px;">
          <div class="participant-avatar" style="width: 60px; height: 60px; font-size: 24px;" id="mypage-avatar"></div>
          <div style="flex: 1;">
            <div style="font-size: 20px; font-weight: 700;" id="mypage-name"></div>
            <div style="color: var(--text-secondary); margin-top: 4px;" id="mypage-phone"></div>
            <div style="color: var(--text-tertiary); font-size: 14px; margin-top: 2px;" id="mypage-info"></div>
          </div>
        </div>
        <button class="btn btn-danger" style="margin-top: 20px;" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>

    <!-- í† ìŠ¤íŠ¸ -->
    <div class="toast" id="toast"></div>

    <!-- Bottom Sheet: ì°¸ê°€ì ì¶”ê°€ -->
    <div class="bottom-sheet-overlay" id="sheet-add-participant">
      <div class="bottom-sheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-content">
          <div class="bottom-sheet-title">ì°¸ê°€ì ì¶”ê°€</div>
          <div class="input-group">
            <label class="input-label">ê°•ìŠµìƒ ì„ íƒ</label>
            <select class="input" id="participant-student"></select>
          </div>
          <div class="input-group">
            <label class="input-label">ì°¸ê°€ ëª©ì </label>
            <div class="purpose-buttons">
              <button class="purpose-btn selected" data-purpose="ê°•ìŠµ" onclick="selectPurpose(this)">ê°•ìŠµ</button>
              <button class="purpose-btn" data-purpose="í€ë‹¤ì´ë¹™" onclick="selectPurpose(this)">í€ë‹¤ì´ë¹™</button>
            </div>
          </div>
          <div class="input-group" id="lesson-level-group">
            <label class="input-label">ê°•ìŠµ ë ˆë²¨</label>
            <select class="input" id="participant-level">
              <option value="2">Level 2</option>
              <option value="3">Level 3</option>
              <option value="4">Level 4</option>
            </select>
          </div>
          <button class="btn btn-primary" onclick="addParticipant()">ì¶”ê°€í•˜ê¸°</button>
        </div>
      </div>
    </div>

    <!-- Bottom Sheet: ê°•ìŠµìƒ ì¼ì • ì‹ ì²­ -->
    <div class="bottom-sheet-overlay" id="sheet-register">
      <div class="bottom-sheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-content">
          <div class="bottom-sheet-title">ì¼ì • ì‹ ì²­</div>
          <div class="input-group">
            <label class="input-label">ì°¸ê°€ ëª©ì </label>
            <div class="purpose-buttons">
              <button class="purpose-btn selected" data-purpose="ê°•ìŠµ" onclick="selectRegisterPurpose(this)">ê°•ìŠµ</button>
              <button class="purpose-btn" data-purpose="í€ë‹¤ì´ë¹™" onclick="selectRegisterPurpose(this)">í€ë‹¤ì´ë¹™</button>
            </div>
          </div>
          <div class="input-group" id="register-level-group">
            <label class="input-label">ìˆ˜ê°• ë ˆë²¨</label>
            <select class="input" id="register-level">
              <option value="2">Level 2</option>
              <option value="3">Level 3</option>
              <option value="4">Level 4</option>
            </select>
          </div>
          <button class="btn btn-primary" onclick="registerSchedule()">ì‹ ì²­í•˜ê¸°</button>
        </div>
      </div>
    </div>

    <!-- Bottom Sheet: ìµœê·¼ ì¼ì • ì„ íƒ (ê°•ì‚¬ìš©) -->
    <div class="bottom-sheet-overlay" id="sheet-select-schedule">
      <div class="bottom-sheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-content">
          <div class="bottom-sheet-title">ì¼ì • ì„ íƒ</div>
          <div id="recent-schedule-list" style="max-height: 300px; overflow-y: auto;"></div>
        </div>
      </div>
    </div>

    <!-- Bottom Sheet: ê°œì¸ ê¸°ë¡ ì¶”ê°€ (ë‚ ì§œ/ì¥ì†Œ ì…ë ¥) -->
    <div class="bottom-sheet-overlay" id="sheet-personal-add">
      <div class="bottom-sheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-content">
          <div class="bottom-sheet-title">ê°œì¸ ê¸°ë¡ ì¶”ê°€</div>
          <div class="input-group">
            <label class="input-label">ë‚ ì§œ *</label>
            <input type="date" class="input" id="personal-add-date">
          </div>
          <div class="input-group">
            <label class="input-label">ì‹œê°„</label>
            <input type="time" class="input" id="personal-add-time">
          </div>
          <div class="input-group">
            <label class="input-label">ì¥ì†Œ</label>
            <input type="text" class="input" id="personal-add-location" placeholder="ì¥ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
          </div>
          <div class="input-group">
            <label class="input-label">ì¢…ëª© ì„ íƒ</label>
            <div style="display: flex; flex-wrap: wrap; gap: 8px;" id="personal-discipline-checks">
              <label style="display: flex; align-items: center; gap: 4px;">
                <input type="checkbox" value="STA" checked> STA
              </label>
              <label style="display: flex; align-items: center; gap: 4px;">
                <input type="checkbox" value="DYNB" checked> DYNB
              </label>
              <label style="display: flex; align-items: center; gap: 4px;">
                <input type="checkbox" value="FIM" checked> FIM
              </label>
              <label style="display: flex; align-items: center; gap: 4px;">
                <input type="checkbox" value="CWTB" checked> CWTB
              </label>
              <label style="display: flex; align-items: center; gap: 4px;">
                <input type="checkbox" value="DNF"> DNF
              </label>
              <label style="display: flex; align-items: center; gap: 4px;">
                <input type="checkbox" value="CNF"> CNF
              </label>
              <label style="display: flex; align-items: center; gap: 4px;">
                <input type="checkbox" value="DYN"> DYN
              </label>
              <label style="display: flex; align-items: center; gap: 4px;">
                <input type="checkbox" value="CWT"> CWT
              </label>
            </div>
          </div>
          <button class="btn btn-primary" onclick="startPersonalRecordInput()">ë‹¤ìŒ: ê¸°ë¡ ì…ë ¥</button>
          <button class="btn btn-secondary" style="margin-top: 8px;" onclick="closeBottomSheet('sheet-personal-add')">ì·¨ì†Œ</button>
        </div>
      </div>
    </div>

    <!-- Bottom Sheet: ì¢…ëª© ì¶”ê°€ -->
    <div class="bottom-sheet-overlay" id="sheet-add-discipline">
      <div class="bottom-sheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-content">
          <div class="bottom-sheet-title">ì¢…ëª© ì¶”ê°€</div>
          <div style="display: flex; flex-wrap: wrap; gap: 12px;" id="add-discipline-options"></div>
          <button class="btn btn-primary" style="margin-top: 16px;" onclick="confirmAddDiscipline()">ì¶”ê°€í•˜ê¸°</button>
          <button class="btn btn-secondary" style="margin-top: 8px;" onclick="closeBottomSheet('sheet-add-discipline')">ì·¨ì†Œ</button>
        </div>
      </div>
    </div>

    <!-- Bottom Sheet: ì¼ê´„ ì¢…ëª© ì¶”ê°€ -->
    <div class="bottom-sheet-overlay" id="sheet-bulk-add-discipline">
      <div class="bottom-sheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-content">
          <div class="bottom-sheet-title">ì¢…ëª© ì¶”ê°€</div>
          <div style="display: flex; flex-wrap: wrap; gap: 12px;" id="bulk-add-discipline-options"></div>
          <button class="btn btn-primary" style="margin-top: 16px;" onclick="confirmBulkAddDiscipline()">ì¶”ê°€í•˜ê¸°</button>
          <button class="btn btn-secondary" style="margin-top: 8px;" onclick="closeBottomSheet('sheet-bulk-add-discipline')">ì·¨ì†Œ</button>
        </div>
      </div>
    </div>

    <!-- Bottom Sheet: ê°•ìŠµ ì¢…ëª© ì¶”ê°€ -->
    <div class="bottom-sheet-overlay" id="sheet-batch-add-discipline">
      <div class="bottom-sheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-content">
          <div class="bottom-sheet-title">ì¢…ëª© ì¶”ê°€</div>
          <div style="display: flex; flex-wrap: wrap; gap: 12px;" id="batch-add-discipline-options"></div>
          <button class="btn btn-primary" style="margin-top: 16px;" onclick="confirmBatchAddDiscipline()">ì¶”ê°€í•˜ê¸°</button>
          <button class="btn btn-secondary" style="margin-top: 8px;" onclick="closeBottomSheet('sheet-batch-add-discipline')">ì·¨ì†Œ</button>
        </div>
      </div>
    </div>

    <!-- Bottom Sheet: ë“œë¼ì´ íŠ¸ë ˆì´ë‹ ì¶”ê°€/ìˆ˜ì • (ê°•ì‚¬ìš©) -->
    <div class="bottom-sheet-overlay" id="sheet-dry-form">
      <div class="bottom-sheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-content">
          <div class="bottom-sheet-title" id="dry-form-title">ìƒˆ íŠ¸ë ˆì´ë‹ ì¶”ê°€</div>
          <input type="hidden" id="edit-dry-id">
          <div class="input-group">
            <label class="input-label">íŠ¸ë ˆì´ë‹ ì´ë¦„</label>
            <input type="text" class="input" id="dry-name" placeholder="ì˜ˆ: í”„ë Œì ¤ 500íšŒ">
          </div>
          <div class="input-group">
            <label class="input-label">ì„¤ëª… (ì„ íƒ)</label>
            <textarea class="input" id="dry-description" rows="3" placeholder="íŠ¸ë ˆì´ë‹ ë°©ë²•ì´ë‚˜ ëª©í‘œë¥¼ ì„¤ëª…í•´ì£¼ì„¸ìš”"></textarea>
          </div>
          <button class="btn btn-primary" onclick="saveDryTraining()">ì €ì¥</button>
          <button class="btn btn-secondary" style="margin-top: 8px;" onclick="closeBottomSheet('sheet-dry-form')">ì·¨ì†Œ</button>
        </div>
      </div>
    </div>

    <!-- Bottom Sheet: ë“œë¼ì´ íŠ¸ë ˆì´ë‹ ê¸°ë¡ ì…ë ¥ (í•™ìƒìš©) -->
    <div class="bottom-sheet-overlay" id="sheet-dry-record">
      <div class="bottom-sheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-content">
          <div class="bottom-sheet-title">ì˜¤ëŠ˜ ê¸°ë¡</div>
          <div class="input-group">
            <label class="input-label">ë‹¬ì„±ë¥ </label>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;" id="dry-achievement-btns">
              <button class="purpose-btn" data-value="0.5" onclick="selectDryAchievement(this)">50%</button>
              <button class="purpose-btn" data-value="0.7" onclick="selectDryAchievement(this)">70%</button>
              <button class="purpose-btn" data-value="0.8" onclick="selectDryAchievement(this)">80%</button>
              <button class="purpose-btn" data-value="0.9" onclick="selectDryAchievement(this)">90%</button>
              <button class="purpose-btn selected" data-value="1.0" onclick="selectDryAchievement(this)">100%</button>
            </div>
          </div>
          <div class="input-group">
            <label class="input-label">ë©”ëª¨ (ì„ íƒ)</label>
            <input type="text" class="input" id="dry-record-note" placeholder="ì˜¤ëŠ˜ íŠ¸ë ˆì´ë‹ ëŠë‚Œì€?">
          </div>
          <button class="btn btn-primary" onclick="saveDryRecord()">ì €ì¥</button>
          <button class="btn btn-secondary" style="margin-top: 8px;" onclick="closeBottomSheet('sheet-dry-record')">ì·¨ì†Œ</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==================== Supabase ì´ˆê¸°í™” ====================
    const SUPABASE_URL = 'https://dnndjqlbjudnjpwescfl.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRubmRqcWxianVkbmpwd2VzY2ZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5MzE2NzMsImV4cCI6MjA4MTUwNzY3M30.0x3vKhKzZyn5MPDSoNJgbOvU-LGZ7q34N44DjWLQWz0';
    
    // Supabase í´ë¼ì´ì–¸íŠ¸ ìƒì„± (dbë¡œ ëª…ëª…í•˜ì—¬ ì¶©ëŒ ë°©ì§€)
    const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ==================== ì „ì—­ ë³€ìˆ˜ ====================
    let currentUser = null;
    let currentScheduleId = null;
    let currentRegId = null;
    let allSchedules = [];
    let screenHistory = [];
    let skillsDonutChart = null;
    let recordsDonutChart = null;

    // ==================== ì´ˆê¸°í™” ====================
    document.addEventListener('DOMContentLoaded', async function() {
      // ìë™ ë¡œê·¸ì¸ í™•ì¸
      const savedUser = localStorage.getItem('divelog_user');
      if (savedUser) {
        try {
          const user = JSON.parse(savedUser);
          // DBì—ì„œ ìµœì‹  ì •ë³´ í™•ì¸
          const { data, error } = await db
            .from('users')
            .select('*')
            .eq('user_id', user.user_id)
            .single();
          
          if (data && !error) {
            currentUser = data;
            // ìµœì‹  ì •ë³´ë¡œ localStorage ì—…ë°ì´íŠ¸
            localStorage.setItem('divelog_user', JSON.stringify(currentUser));
            
            if (currentUser.user_type === 'ê°•ì‚¬') {
              showScreen('screen-instructor-home');
            } else {
              showScreen('screen-student-home');
            }
            return;
          } else {
            // ìœ íš¨í•˜ì§€ ì•Šì€ ì €ì¥ëœ ì‚¬ìš©ì ì •ë³´ ì‚­ì œ
            localStorage.removeItem('divelog_user');
          }
        } catch (e) {
          localStorage.removeItem('divelog_user');
        }
      }
      
      const phoneInput = document.getElementById('login-phone');
      
      // ì „í™”ë²ˆí˜¸ ìë™ í¬ë§·íŒ… (ë’·ìë¦¬ë§Œ)
      phoneInput.addEventListener('input', function(e) {
        // ìˆ«ìë§Œ ì¶”ì¶œ
        let v = e.target.value.replace(/\D/g, '');
        
        // 8ìë¦¬ ì œí•œ (ë’·ë²ˆí˜¸ë§Œ)
        if (v.length > 8) v = v.slice(0, 8);
        
        // í•˜ì´í”ˆ ì¶”ê°€ (0000-0000 í˜•ì‹)
        if (v.length > 4) {
          v = v.slice(0, 4) + '-' + v.slice(4);
        }
        
        e.target.value = v;
      });

      const overlays = document.querySelectorAll('.bottom-sheet-overlay');
      overlays.forEach(overlay => {
        overlay.addEventListener('click', function(e) {
          if (e.target === this) closeBottomSheet(this.id);
        });
      });
    });

    // ==================== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ====================
    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 3000);
    }

    function showScreen(id) {
      const currentScreen = document.querySelector('.screen.active');
      if (currentScreen && currentScreen.id !== id) {
        screenHistory.push(currentScreen.id);
      }
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      window.scrollTo(0, 0);
      
      // í™”ë©´ë³„ ë¡œë“œ í•¨ìˆ˜ í˜¸ì¶œ
      if (id === 'screen-instructor-home') loadInstructorDashboard();
      else if (id === 'screen-student-home') loadStudentDashboard();
      else if (id === 'screen-mypage') loadMypage();
      else if (id === 'screen-schedule-manage') loadScheduleManage();
      else if (id === 'screen-student-schedule') loadStudentSchedule();
      else if (id === 'screen-my-records') loadMyRecords();
      else if (id === 'screen-dry-training') loadDryTraining();
      else if (id === 'screen-dry-manage') loadDryManage();
    }

    function goBack() {
      if (screenHistory.length > 0) {
        const prevScreen = screenHistory.pop();
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(prevScreen).classList.add('active');
      } else {
        if (currentUser && currentUser.user_type === 'ê°•ì‚¬') showScreen('screen-instructor-home');
        else showScreen('screen-student-home');
      }
    }

    function openBottomSheet(id) {
      document.getElementById(id).classList.add('active');
    }

    function closeBottomSheet(id) {
      document.getElementById(id).classList.remove('active');
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      const d = new Date(dateStr);
      const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
      return (d.getMonth()+1) + 'ì›” ' + d.getDate() + 'ì¼ (' + days[d.getDay()] + ')';
    }

    function formatTime(timeStr) {
      if (!timeStr) return '';
      const parts = timeStr.split(':');
      const h = parseInt(parts[0]);
      const m = parts[1];
      return (h < 12 ? 'ì˜¤ì „ ' : 'ì˜¤í›„ ') + (h > 12 ? h - 12 : h) + ':' + m;
    }

    // ==================== ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ====================
    async function handleLogin() {
      const phoneBack = document.getElementById('login-phone').value.replace(/-/g, '');
      const userId = document.getElementById('login-userid').value.trim();
      
      // ìœ íš¨ì„± ê²€ì‚¬
      if (!phoneBack || phoneBack.length < 8) {
        showToast('ì—°ë½ì²˜ë¥¼ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return;
      }
      
      if (!userId) {
        showToast('ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return;
      }
      
      // ì „ì²´ ì „í™”ë²ˆí˜¸ ì¡°í•© (010-0000-0000 í˜•ì‹)
      const phone = '010-' + phoneBack.slice(0, 4) + '-' + phoneBack.slice(4);
      
      console.log('ë¡œê·¸ì¸ ì‹œë„:', phone, userId);
      
      try {
        // Supabaseì—ì„œ ì‚¬ìš©ì ì¡°íšŒ (ì „í™”ë²ˆí˜¸ + ì•„ì´ë”” ë‘˜ ë‹¤ ì¼ì¹˜)
        const { data, error } = await db
          .from('users')
          .select('*')
          .eq('phone', phone)
          .eq('user_id', userId)
          .single();
        
        console.log('Supabase ì‘ë‹µ:', { data, error });
        
        if (error || !data) {
          showToast('ì—°ë½ì²˜ ë˜ëŠ” ì•„ì´ë””ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
          return;
        }
        
        currentUser = data;
        console.log('ë¡œê·¸ì¸ ì„±ê³µ:', currentUser);
        
        // ìë™ ë¡œê·¸ì¸ì„ ìœ„í•´ localStorageì— ì €ì¥
        localStorage.setItem('divelog_user', JSON.stringify(currentUser));
        
        if (currentUser.user_type === 'ê°•ì‚¬') {
          showScreen('screen-instructor-home');
        } else {
          showScreen('screen-student-home');
        }
      } catch (err) {
        console.error('ë¡œê·¸ì¸ ì˜¤ë¥˜:', err);
        showToast('ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + err.message);
      }
    }

    function logout() {
      currentUser = null;
      screenHistory = [];
      // ìë™ ë¡œê·¸ì¸ ì •ë³´ ì‚­ì œ
      localStorage.removeItem('divelog_user');
      showScreen('screen-login');
      document.getElementById('login-phone').value = '';
      document.getElementById('login-userid').value = '';
    }

    // ==================== ê°•ì‚¬ ëŒ€ì‹œë³´ë“œ ====================
    async function loadInstructorDashboard() {
      document.getElementById('instructor-name').textContent = currentUser.name;
      await loadTodaySchedules();
      await loadInstructorStats();
    }

    async function loadTodaySchedules() {
      try {
        const today = new Date().toISOString().split('T')[0];
        
        // ì˜¤ëŠ˜ ì¼ì • ì¡°íšŒ
        const { data: schedules, error } = await db
          .from('schedules')
          .select('*')
          .eq('instructor_id', currentUser.user_id)
          .eq('date', today);
        
        if (error) throw error;
        
        const container = document.getElementById('today-schedules');
        
        if (!schedules || schedules.length === 0) {
          container.innerHTML = '<div class="card" style="text-align: center; color: var(--text-secondary);">ì˜¤ëŠ˜ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤</div>';
          return;
        }
        
        // ê° ì¼ì •ì— ì°¸ê°€ì ìˆ˜ ì¶”ê°€
        let html = '';
        for (const s of schedules) {
          // ì°¸ê°€ì ìˆ˜ ì¡°íšŒ
          const { count } = await db
            .from('registrations')
            .select('*', { count: 'exact', head: true })
            .eq('schedule_id', s.schedule_id);
          
          html += `<div class="card schedule-card" style="cursor:pointer;" onclick="openParticipants('${s.schedule_id}')">`;
          html += '<div class="schedule-info">';
          html += `<div class="schedule-time">${formatTime(s.time)} Â· ${s.location}</div>`;
          html += `<div class="schedule-meta">ì°¸ê°€ì ${count || 0}ëª…</div>`;
          html += '</div>';
          html += '<i class="fas fa-chevron-right schedule-arrow"></i>';
          html += '</div>';
        }
        
        container.innerHTML = html;
        allSchedules = schedules;
      } catch (err) {
        console.error('ì¼ì • ë¡œë“œ ì˜¤ë¥˜:', err);
        document.getElementById('today-schedules').innerHTML = '<div class="card" style="text-align: center; color: var(--error);">ì¼ì •ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤</div>';
      }
    }

    async function loadInstructorStats() {
      try {
        // ì´ë²ˆ ì£¼ ì‹œì‘ì¼ ê³„ì‚°
        const now = new Date();
        const weekStart = new Date(now);
        weekStart.setDate(now.getDate() - now.getDay());
        weekStart.setHours(0, 0, 0, 0);
        const weekStartStr = weekStart.toISOString().split('T')[0];
        
        // ì´ë²ˆ ì£¼ ì¼ì • ìˆ˜
        const { count: weekLessons } = await db
          .from('schedules')
          .select('*', { count: 'exact', head: true })
          .eq('instructor_id', currentUser.user_id)
          .gte('date', weekStartStr);
        
        // ì´ë²ˆ ì£¼ ì¼ì • ID ì¡°íšŒ
        const { data: weekSchedules } = await db
          .from('schedules')
          .select('schedule_id')
          .eq('instructor_id', currentUser.user_id)
          .gte('date', weekStartStr);
        
        let weekStudents = 0;
        let weekRecords = 0;
        
        if (weekSchedules && weekSchedules.length > 0) {
          const scheduleIds = weekSchedules.map(s => s.schedule_id);
          
          // ì´ë²ˆ ì£¼ ì°¸ê°€ì ìˆ˜
          const { count: studentCount } = await db
            .from('registrations')
            .select('*', { count: 'exact', head: true })
            .in('schedule_id', scheduleIds);
          weekStudents = studentCount || 0;
          
          // ì´ë²ˆ ì£¼ reg_id ì¡°íšŒ
          const { data: regs } = await db
            .from('registrations')
            .select('reg_id')
            .in('schedule_id', scheduleIds);
          
          if (regs && regs.length > 0) {
            const regIds = regs.map(r => r.reg_id);
            
            // ì´ë²ˆ ì£¼ ê¸°ë¡ ìˆ˜
            const { count: recordCount } = await db
              .from('dive_records')
              .select('*', { count: 'exact', head: true })
              .in('reg_id', regIds);
            weekRecords = recordCount || 0;
          }
        }
        
        document.getElementById('instructor-stats').innerHTML = 
          `ê°•ìŠµ ${weekLessons || 0}íšŒ Â· ê°•ìŠµìƒ ${weekStudents}ëª… Â· ê¸°ë¡ ${weekRecords}ê±´`;
      } catch (err) {
        console.error('í†µê³„ ë¡œë“œ ì˜¤ë¥˜:', err);
        document.getElementById('instructor-stats').innerHTML = 'í†µê³„ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤';
      }
    }

    // ==================== ê°•ìŠµìƒ ëŒ€ì‹œë³´ë“œ ====================
    async function loadStudentDashboard() {
      document.getElementById('student-name').textContent = currentUser.name;
      
      // ì§„ë„ìœ¨ ë¡œë“œ (in_training_levelì´ ìˆìœ¼ë©´)
      await loadLevelProgress();
      
      // ìµœê³  ê¸°ë¡ ì¡°íšŒ
      await loadBestRecords();
      
      // ë‹¤ê°€ì˜¤ëŠ” ì¼ì • ì¡°íšŒ
      await loadUpcomingSchedules();
      
      // ë“œë¼ì´ íŠ¸ë ˆì´ë‹ ë¡œë“œ
      await loadHomeDryTraining();
    }
    
    // ë ˆë²¨ë³„ ìš”êµ¬ì‚¬í•­ ì •ì˜
    const LEVEL_REQUIREMENTS = {
      2: {
        skills: [
          { key: 'rescue_5_10m', name: 'ë ˆìŠ¤í 5-10m' },
          { key: 'theory_test_lv2', name: 'ì´ë¡  í‰ê°€' }
        ],
        records: [
          { key: 'sta', name: 'STA', target: 120, unit: 'ì´ˆ', display: "2'00\"" },  // 2ë¶„ = 120ì´ˆ
          { key: 'dynb', name: 'DYNB', target: 40, unit: 'm', display: '40m' },
          { key: 'cwtb', name: 'CWTB', target: 12, unit: 'm', display: '12m' }
        ],
        lessonRequired: 3
      },
      3: {
        skills: [
          { key: 'lanyard_remove', name: 'ëœì•¼ë“œ ì œê±°' },
          { key: 'no_mask_10m', name: 'ë…¸ë§ˆìŠ¤í¬ 10m' },
          { key: 'rescue_towing', name: 'ë ˆìŠ¤í 10-15m + í† ì‰ 50m' },
          { key: 'neutral_buoyancy', name: 'ì¤‘ì„±ë¶€ë ¥' },
          { key: 'freefall', name: 'í”„ë¦¬í´' },
          { key: 'arms_only_15m', name: 'ì•”ìŠ¤ ì˜¨ë¦¬ 15m' },
          { key: 'buddy_10_15m', name: 'ì ì ˆí•œ ë²„ë”” 10-15m' },
          { key: 'theory_test', name: 'ì´ë¡  í‰ê°€' }
        ],
        records: [
          { key: 'sta', name: 'STA', target: 165, unit: 'ì´ˆ', display: "2'45\"" },  // 2ë¶„45ì´ˆ = 165ì´ˆ
          { key: 'dynb', name: 'DYNB', target: 55, unit: 'm', display: '55m' },
          { key: 'cwtb', name: 'CWTB', target: 24, unit: 'm', display: '24m' }
        ],
        lessonRequired: 4
      }
    };
    
    // ì§„ë„ìœ¨ ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤
    let skillsChartInstance = null;
    let recordsChartInstance = null;
    
    // ì§„ë„ìœ¨ ë¡œë“œ
    async function loadLevelProgress() {
      const level = currentUser.in_training_level;
      const section = document.getElementById('level-progress-section');
      
      // ë ˆë²¨ ê³¼ì • ì¤‘ì´ ì•„ë‹ˆë©´ ìˆ¨ê¹€
      if (!level || (level !== 2 && level !== 3)) {
        section.style.display = 'none';
        return;
      }
      
      section.style.display = 'block';
      
      const req = LEVEL_REQUIREMENTS[level];
      const tableName = level === 2 ? 'lv2_progress' : 'lv3_progress';
      
      try {
        // ì§„ë„ ë°ì´í„° ì¡°íšŒ
        const { data: progress } = await db
          .from(tableName)
          .select('*')
          .eq('user_id', currentUser.user_id)
          .single();
        
        // ìŠ¤í‚¬ ì™„ë£Œ ê³„ì‚°
        let skillsDone = 0;
        const skillsTotal = req.skills.length;
        const skillItems = [];
        
        for (const skill of req.skills) {
          const isDone = progress && progress[skill.key] === 'Y';
          const attempts = progress ? (progress[skill.key + '_attempts'] || 0) : 0;
          if (isDone) skillsDone++;
          skillItems.push({ name: skill.name, done: isDone, attempts: attempts });
        }
        
        // ê¸°ë¡ ë‹¬ì„±ë¥  ê³„ì‚°
        let totalRecordPercent = 0;
        const recordItems = [];
        
        for (const rec of req.records) {
          const value = progress ? progress[rec.key] : null;
          let percent = 0;
          
          if (value && value > 0) {
            percent = Math.min(100, Math.round((value / rec.target) * 100));
          }
          
          totalRecordPercent += percent;
          recordItems.push({
            name: rec.name,
            target: rec.display,
            percent: percent,
            done: percent >= 100,
            currentValue: value,  // í˜„ì¬ ê¸°ë¡ ê°’ ì¶”ê°€
            unit: rec.unit || ''  // ë‹¨ìœ„ ì¶”ê°€
          });
        }
        
        const avgRecordPercent = Math.round(totalRecordPercent / req.records.length);
        
        // ê°•ìŠµ íšŸìˆ˜
        const lessonCount = progress?.lesson_count || 0;
        const lessonDone = lessonCount >= req.lessonRequired;
        
        // íƒ€ì´í‹€ ë° ìš”ì•½ ì—…ë°ì´íŠ¸
        document.getElementById('level-progress-title').innerHTML = `<i class="fas fa-graduation-cap"></i> Level ${level} ì§„ë„`;
        document.getElementById('level-progress-summary').innerHTML = `
          ê°•ìŠµ ${lessonCount}/${req.lessonRequired}íšŒ ${lessonDone ? '<i class="fas fa-check" style="color: var(--success);"></i>' : ''} Â· 
          ìŠ¤í‚¬ ${skillsDone}/${skillsTotal} Â· 
          ê¸°ë¡ ${avgRecordPercent}%
        `;
        
        // ë„ë„› ì°¨íŠ¸ ìƒ‰ìƒ
        const lvColor = level === 2 ? '#FF9100' : '#00C853';
        const lvColorLight = level === 2 ? '#FFF3E0' : '#E8F5E9';
        
        // ìŠ¤í‚¬ ì°¨íŠ¸ ë Œë”ë§
        renderDonutChart('skills-chart', skillsDone, skillsTotal, lvColor, lvColorLight, 'skillsChartInstance');
        document.getElementById('skills-progress-value').textContent = `${skillsDone}/${skillsTotal}`;
        document.getElementById('skills-progress-value').className = `donut-value lv${level}`;
        
        // ìŠ¤í‚¬ ì²´í¬ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
        let skillsHtml = '';
        for (const item of skillItems) {
          const attemptsText = item.attempts > 0 ? `${item.attempts}íšŒ` : '-';
          skillsHtml += `
            <div class="checklist-item">
              <div class="checklist-icon ${item.done ? 'done' : 'undone'}">
                <i class="fas fa-${item.done ? 'check' : 'circle'}"></i>
              </div>
              <span class="checklist-text ${item.done ? 'done' : ''}">${item.name}</span>
              <span class="checklist-badge" style="min-width: 40px; text-align: right;">${attemptsText}</span>
            </div>
          `;
        }
        document.getElementById('skills-checklist').innerHTML = skillsHtml;
        
        // ê¸°ë¡ ì°¨íŠ¸ ë Œë”ë§
        renderDonutChart('records-chart', avgRecordPercent, 100, lvColor, lvColorLight, 'recordsChartInstance');
        document.getElementById('records-progress-value').textContent = `${avgRecordPercent}%`;
        document.getElementById('records-progress-value').className = `donut-value lv${level}`;
        document.querySelector('#records-chart').parentElement.nextElementSibling.querySelector('.donut-label')?.remove;
        
        // ê¸°ë¡ ì²´í¬ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
        let recordsHtml = '';
        for (const item of recordItems) {
          // í˜„ì¬ ê¸°ë¡ í¬ë§·íŒ…
          let currentDisplay = '-';
          if (item.currentValue && item.currentValue > 0) {
            if (item.name === 'STA') {
              // STAëŠ” ì´ˆë¥¼ ë¶„:ì´ˆë¡œ ë³€í™˜
              const mins = Math.floor(item.currentValue / 60);
              const secs = item.currentValue % 60;
              currentDisplay = `${mins}'${secs.toString().padStart(2, '0')}"`;
            } else {
              // DYNB, CWTB ë“±ì€ m ë‹¨ìœ„
              currentDisplay = `${item.currentValue}m`;
            }
          }
          
          recordsHtml += `
            <div class="checklist-item">
              <div class="checklist-icon ${item.done ? 'done' : 'undone'}">
                <i class="fas fa-${item.done ? 'check' : 'circle'}"></i>
              </div>
              <span class="checklist-text">${item.name} â‰¥ ${item.target}</span>
              <span class="checklist-badge" style="min-width: 50px; text-align: right;">${currentDisplay}</span>
            </div>
          `;
        }
        document.getElementById('records-checklist').innerHTML = recordsHtml;
        
      } catch (err) {
        console.error('ì§„ë„ìœ¨ ë¡œë“œ ì˜¤ë¥˜:', err);
        section.style.display = 'none';
      }
    }
    
    // ë„ë„› ì°¨íŠ¸ ë Œë”ë§
    function renderDonutChart(canvasId, value, total, color, bgColor, instanceVar) {
      const canvas = document.getElementById(canvasId);
      const ctx = canvas.getContext('2d');
      
      // ê¸°ì¡´ ì°¨íŠ¸ íŒŒê´´
      if (instanceVar === 'skillsChartInstance' && skillsChartInstance) {
        skillsChartInstance.destroy();
      } else if (instanceVar === 'recordsChartInstance' && recordsChartInstance) {
        recordsChartInstance.destroy();
      }
      
      const chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          datasets: [{
            data: [value, Math.max(0, total - value)],
            backgroundColor: [color, bgColor],
            borderWidth: 0
          }]
        },
        options: {
          cutout: '70%',
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { display: false },
            tooltip: { enabled: false }
          }
        }
      });
      
      if (instanceVar === 'skillsChartInstance') {
        skillsChartInstance = chart;
      } else if (instanceVar === 'recordsChartInstance') {
        recordsChartInstance = chart;
      }
    }

    async function loadBestRecords() {
      try {
        const disciplines = ['STA', 'CWTB', 'DYNB'];
        let bestHtml = '';
        
        for (const disc of disciplines) {
          const key = 'best_' + disc.toLowerCase();
          const value = currentUser[key];
          
          let displayVal = '-';
          if (value && value > 0) {
            if (disc === 'STA') {
              // STAëŠ” ì´ˆ ë‹¨ìœ„ë¥¼ ë¶„'ì´ˆ" í˜•ì‹ìœ¼ë¡œ ë³€í™˜
              const minutes = Math.floor(value / 60);
              const seconds = Math.floor(value % 60);
              displayVal = `${minutes}'${seconds.toString().padStart(2, '0')}"`;
            } else {
              displayVal = value + 'm';
            }
          }
          
          bestHtml += `<div class="stat-card">
            <div class="stat-label">${disc}</div>
            <div class="stat-value">${displayVal}</div>
          </div>`;
        }
        
        document.getElementById('best-records').innerHTML = bestHtml;
      } catch (err) {
        console.error('ìµœê³  ê¸°ë¡ ë¡œë“œ ì˜¤ë¥˜:', err);
      }
    }

    async function loadUpcomingSchedules() {
      try {
        const today = new Date().toISOString().split('T')[0];
        
        // í•™ìƒì˜ ë“±ë¡ëœ ì¼ì • ì¡°íšŒ
        const { data: regs } = await db
          .from('registrations')
          .select(`
            reg_id,
            purpose,
            schedule_id,
            schedules (
              schedule_id,
              date,
              time,
              location
            )
          `)
          .eq('student_id', currentUser.user_id);
        
        const container = document.getElementById('upcoming-schedules');
        
        if (!regs || regs.length === 0) {
          container.innerHTML = '<div class="card" style="text-align: center; color: var(--text-secondary);">ì˜ˆì •ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤</div>';
          return;
        }
        
        // ë¯¸ë˜ ì¼ì •ë§Œ í•„í„°ë§
        const upcoming = regs
          .filter(r => r.schedules && r.schedules.date >= today)
          .sort((a, b) => new Date(a.schedules.date) - new Date(b.schedules.date))
          .slice(0, 3);
        
        if (upcoming.length === 0) {
          container.innerHTML = '<div class="card" style="text-align: center; color: var(--text-secondary);">ì˜ˆì •ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤</div>';
          return;
        }
        
        let html = '';
        for (const r of upcoming) {
          const s = r.schedules;
          html += `<div class="card schedule-card" onclick="openScheduleDetail('${r.reg_id}')" style="cursor: pointer;">
            <div class="schedule-info">
              <div class="schedule-time">${formatDate(s.date)} ${formatTime(s.time)}</div>
              <div class="schedule-location">${s.location} Â· ${r.purpose}</div>
            </div>
            <i class="fas fa-chevron-right schedule-arrow"></i>
          </div>`;
        }
        
        container.innerHTML = html;
      } catch (err) {
        console.error('ì¼ì • ë¡œë“œ ì˜¤ë¥˜:', err);
        document.getElementById('upcoming-schedules').innerHTML = '<div class="card" style="text-align: center; color: var(--error);">ì¼ì •ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤</div>';
      }
    }

    // ==================== ë§ˆì´í˜ì´ì§€ ====================
    function loadMypage() {
      document.getElementById('mypage-avatar').textContent = currentUser.name ? currentUser.name.charAt(0) : '?';
      document.getElementById('mypage-name').textContent = currentUser.name;
      document.getElementById('mypage-phone').textContent = currentUser.phone;
      document.getElementById('mypage-info').textContent = 'Level ' + (currentUser.cert_level === 'X' ? '1' : currentUser.cert_level) + ' Â· ' + currentUser.user_type;
    }

    // ==================== ì¼ì • ê´€ë¦¬ (ê°•ì‚¬) ====================
    async function loadScheduleManage() {
      try {
        const { data: schedules, error } = await db
          .from('schedules')
          .select('*')
          .eq('instructor_id', currentUser.user_id)
          .order('date', { ascending: false });
        
        if (error) throw error;
        
        allSchedules = schedules || [];
        renderScheduleList();
        // ìº˜ë¦°ë”í˜•ì´ ê¸°ë³¸ì´ë¯€ë¡œ ìº˜ë¦°ë”ë„ ë Œë”ë§
        renderCalendar();
      } catch (err) {
        console.error('ì¼ì • ë¡œë“œ ì˜¤ë¥˜:', err);
        document.getElementById('schedule-list').innerHTML = 
          '<div class="card" style="text-align: center; color: var(--error);">ì¼ì •ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤</div>';
      }
    }

    async function renderScheduleList() {
      const container = document.getElementById('schedule-list');
      
      if (allSchedules.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="fas fa-calendar-times"></i><p>ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤</p></div>';
        return;
      }
      
      const today = new Date().toISOString().split('T')[0];
      
      // ì¼ì • ë¶„ë¥˜
      const pastSchedules = allSchedules.filter(s => s.date < today);
      const todaySchedules = allSchedules.filter(s => s.date === today);
      const futureSchedules = allSchedules.filter(s => s.date > today);
      
      let html = '';
      
      // ë‹¤ê°€ì˜¬ ì¼ì • (ë¯¸ë˜ â†’ ë‚ ì§œìˆœ)
      if (futureSchedules.length > 0) {
        html += '<div class="schedule-section-title"><i class="fas fa-arrow-right"></i> ë‹¤ê°€ì˜¬ ì¼ì •</div>';
        for (const s of futureSchedules.sort((a, b) => a.date.localeCompare(b.date))) {
          html += await renderScheduleCard(s);
        }
      }
      
      // ì˜¤ëŠ˜ ì¼ì •
      if (todaySchedules.length > 0) {
        html += '<div class="schedule-section-title"><i class="fas fa-clock"></i> ì˜¤ëŠ˜ ì¼ì •</div>';
        for (const s of todaySchedules) {
          html += await renderScheduleCard(s);
        }
      }
      
      // ì§€ë‚œ ì¼ì • (ê³¼ê±° â†’ ìµœì‹ ìˆœ)
      if (pastSchedules.length > 0) {
        html += '<div class="schedule-section-title"><i class="fas fa-check"></i> ì§€ë‚œ ì¼ì •</div>';
        for (const s of pastSchedules.sort((a, b) => b.date.localeCompare(a.date))) {
          html += await renderScheduleCard(s);
        }
      }
      
      container.innerHTML = html;
    }

    async function renderScheduleCard(s) {
      // ì°¸ê°€ì ì •ë³´ ì¡°íšŒ (ê°•ìŠµ/í€ êµ¬ë¶„, ë ˆë²¨)
      const { data: regs } = await db
        .from('registrations')
        .select('purpose, lesson_level')
        .eq('schedule_id', s.schedule_id);
      
      // ê°•ìŠµìƒ ìˆ˜ì™€ ë ˆë²¨, í€ë‹¤ì´ë¹™ ìˆ˜
      const lessonRegs = (regs || []).filter(r => r.purpose === 'ê°•ìŠµ');
      const funRegs = (regs || []).filter(r => r.purpose === 'í€ë‹¤ì´ë¹™');
      const lessonLevels = [...new Set(lessonRegs.map(r => r.lesson_level).filter(l => l))].sort();
      
      let participantText = s.location;
      if (lessonRegs.length > 0 || funRegs.length > 0) {
        participantText += ' Â· ';
        if (lessonRegs.length > 0) {
          participantText += `ê°•ìŠµ ${lessonRegs.length}ëª…`;
          if (lessonLevels.length > 0) {
            participantText += `(${lessonLevels.map(l => 'Lv' + l).join(', ')})`;
          }
        }
        if (funRegs.length > 0) {
          if (lessonRegs.length > 0) participantText += ' Â· ';
          participantText += `í€ ${funRegs.length}ëª…`;
        }
      }
      
      return `<div class="card">
        <div class="schedule-card" style="margin-bottom: 12px;">
          <div class="schedule-info" style="flex: 1;">
            <div class="schedule-time">${formatDate(s.date)} ${formatTime(s.time)}</div>
            <div class="schedule-location">${participantText}</div>
          </div>
          <div style="display: flex; gap: 8px;">
            <button class="icon-btn" onclick="openScheduleForm('${s.schedule_id}')"><i class="fas fa-pen"></i></button>
            <button class="icon-btn" onclick="deleteSchedule('${s.schedule_id}')"><i class="fas fa-trash"></i></button>
          </div>
        </div>
        <div style="display: flex; gap: 8px;">
          <button class="btn btn-secondary btn-small" style="flex: 1;" onclick="openParticipants('${s.schedule_id}')">
            <i class="fas fa-users"></i> ì°¸ê°€ì
          </button>
          <button class="btn btn-primary btn-small" style="flex: 1;" onclick="openLessonRecordInput('${s.schedule_id}')">
            <i class="fas fa-pen"></i> ê¸°ë¡ ì…ë ¥
          </button>
        </div>
      </div>`;
    }

    async function deleteSchedule(scheduleId) {
      if (!confirm('ì´ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ê´€ë ¨ ì°¸ê°€ì ì •ë³´ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.')) return;
      
      try {
        // ë¨¼ì € ê´€ë ¨ ê¸°ë¡ ì‚­ì œ
        const { data: regs } = await db
          .from('registrations')
          .select('reg_id')
          .eq('schedule_id', scheduleId);
        
        if (regs && regs.length > 0) {
          const regIds = regs.map(r => r.reg_id);
          await db.from('dive_records').delete().in('reg_id', regIds);
          await db.from('skill_records').delete().in('reg_id', regIds);
          await db.from('registrations').delete().eq('schedule_id', scheduleId);
        }
        
        // ì¼ì • ì‚­ì œ
        const { error } = await db
          .from('schedules')
          .delete()
          .eq('schedule_id', scheduleId);
        
        if (error) throw error;
        
        showToast('ì¼ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
        loadScheduleManage();
      } catch (err) {
        console.error('ì¼ì • ì‚­ì œ ì˜¤ë¥˜:', err);
        showToast('ì‚­ì œ ì‹¤íŒ¨: ' + err.message);
      }
    }

    // ==================== ìº˜ë¦°ë” ëª¨ë“œ ====================
    let scheduleViewMode = 'calendar'; // 'list' or 'calendar' - ìº˜ë¦°ë”í˜• ê¸°ë³¸
    let calendarYear = new Date().getFullYear();
    let calendarMonth = new Date().getMonth();
    let selectedDate = new Date().toISOString().split('T')[0];

    function setScheduleViewMode(mode) {
      scheduleViewMode = mode;
      if (mode === 'calendar') {
        document.getElementById('schedule-list-mode').style.display = 'none';
        document.getElementById('schedule-calendar-mode').style.display = 'block';
        document.getElementById('schedule-calendar-btn').classList.add('active');
        document.getElementById('schedule-list-btn').classList.remove('active');
        renderCalendar();
      } else {
        document.getElementById('schedule-list-mode').style.display = 'block';
        document.getElementById('schedule-calendar-mode').style.display = 'none';
        document.getElementById('schedule-calendar-btn').classList.remove('active');
        document.getElementById('schedule-list-btn').classList.add('active');
      }
    }

    function toggleScheduleViewMode() {
      if (scheduleViewMode === 'list') {
        setScheduleViewMode('calendar');
      } else {
        setScheduleViewMode('list');
      }
    }

    function changeMonth(delta) {
      calendarMonth += delta;
      if (calendarMonth > 11) {
        calendarMonth = 0;
        calendarYear++;
      } else if (calendarMonth < 0) {
        calendarMonth = 11;
        calendarYear--;
      }
      renderCalendar();
    }

    function renderCalendar() {
      const monthNames = ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'];
      document.getElementById('calendar-title').textContent = `${calendarYear}ë…„ ${monthNames[calendarMonth]}`;
      
      const firstDay = new Date(calendarYear, calendarMonth, 1);
      const lastDay = new Date(calendarYear, calendarMonth + 1, 0);
      const startDayOfWeek = firstDay.getDay();
      const daysInMonth = lastDay.getDate();
      
      const today = new Date().toISOString().split('T')[0];
      
      // ì¼ì •ì´ ìˆëŠ” ë‚ ì§œ ë§µ ìƒì„±
      const scheduleDates = {};
      for (const s of allSchedules) {
        if (!scheduleDates[s.date]) {
          scheduleDates[s.date] = { lesson: false, personal: false, dry: false };
        }
        scheduleDates[s.date].lesson = true; // ê°•ì‚¬ìš©ì€ ì „ë¶€ ê°•ìŠµ ì¼ì •
      }
      
      let html = '';
      
      // ì´ì „ ë‹¬ ë‚ ì§œ
      const prevMonthLastDay = new Date(calendarYear, calendarMonth, 0).getDate();
      for (let i = startDayOfWeek - 1; i >= 0; i--) {
        const day = prevMonthLastDay - i;
        html += `<div class="calendar-day other-month">${day}</div>`;
      }
      
      // ì´ë²ˆ ë‹¬ ë‚ ì§œ
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${calendarYear}-${String(calendarMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const isToday = dateStr === today;
        const isSelected = dateStr === selectedDate;
        const schedule = scheduleDates[dateStr];
        
        let classes = 'calendar-day';
        if (isToday) classes += ' today';
        if (isSelected) classes += ' selected';
        
        // ì¼ì • ìˆëŠ” ë‚ ì§œì— ìƒ‰ ë™ê·¸ë¼ë¯¸ í´ë˜ìŠ¤ ì¶”ê°€ (ìš°ì„ ìˆœìœ„: ê°•ìŠµ > ê°œì¸ > ì±Œë¦°ì§€)
        if (schedule) {
          if (schedule.lesson) classes += ' has-lesson';
          else if (schedule.personal) classes += ' has-personal';
          else if (schedule.dry) classes += ' has-dry';
        }
        
        // ì¼ì • ë°”ëŠ” ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ (CSSì—ì„œ ìˆ¨ê¹€ ì²˜ë¦¬)
        let bars = '';
        
        html += `<div class="${classes}" onclick="selectCalendarDate('${dateStr}')">${day}${bars}</div>`;
      }
      
      // ë‹¤ìŒ ë‹¬ ë‚ ì§œ
      const totalCells = startDayOfWeek + daysInMonth;
      const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
      for (let i = 1; i <= remainingCells; i++) {
        html += `<div class="calendar-day other-month">${i}</div>`;
      }
      
      document.getElementById('calendar-days').innerHTML = html;
      
      // ì„ íƒëœ ë‚ ì§œ ì¼ì • í‘œì‹œ
      renderCalendarScheduleList();
    }

    function selectCalendarDate(dateStr) {
      selectedDate = dateStr;
      renderCalendar();
    }

    async function renderCalendarScheduleList() {
      const date = new Date(selectedDate);
      const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
      const dateText = `${date.getMonth() + 1}ì›” ${date.getDate()}ì¼ (${dayNames[date.getDay()]})`;
      document.getElementById('selected-date-text').textContent = dateText;
      
      const daySchedules = allSchedules.filter(s => s.date === selectedDate);
      const container = document.getElementById('calendar-schedule-list');
      
      if (daySchedules.length === 0) {
        container.innerHTML = '<div class="card" style="text-align: center; color: var(--text-tertiary); padding: 30px;">ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤</div>';
        return;
      }
      
      let html = '';
      for (const s of daySchedules) {
        html += await renderScheduleCard(s);
      }
      container.innerHTML = html;
    }

    // ==================== í•™ìƒìš© ìº˜ë¦°ë” ====================
    let studentScheduleViewMode = 'calendar'; // ìº˜ë¦°ë”í˜• ê¸°ë³¸
    let studentCalendarYear = new Date().getFullYear();
    let studentCalendarMonth = new Date().getMonth();
    let studentSelectedDate = new Date().toISOString().split('T')[0];
    let studentSchedules = []; // í•™ìƒì˜ ë“±ë¡ëœ ì¼ì •

    function setStudentScheduleViewMode(mode) {
      studentScheduleViewMode = mode;
      if (mode === 'calendar') {
        document.getElementById('student-schedule-list-mode').style.display = 'none';
        document.getElementById('student-schedule-calendar-mode').style.display = 'block';
        document.getElementById('student-calendar-btn').classList.add('active');
        document.getElementById('student-list-btn').classList.remove('active');
        renderStudentCalendar();
      } else {
        document.getElementById('student-schedule-list-mode').style.display = 'block';
        document.getElementById('student-schedule-calendar-mode').style.display = 'none';
        document.getElementById('student-calendar-btn').classList.remove('active');
        document.getElementById('student-list-btn').classList.add('active');
      }
    }

    function toggleStudentScheduleViewMode() {
      if (studentScheduleViewMode === 'list') {
        setStudentScheduleViewMode('calendar');
      } else {
        setStudentScheduleViewMode('list');
      }
    }

    function changeStudentMonth(delta) {
      studentCalendarMonth += delta;
      if (studentCalendarMonth > 11) {
        studentCalendarMonth = 0;
        studentCalendarYear++;
      } else if (studentCalendarMonth < 0) {
        studentCalendarMonth = 11;
        studentCalendarYear--;
      }
      renderStudentCalendar();
    }

    function renderStudentCalendar() {
      const monthNames = ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'];
      document.getElementById('student-calendar-title').textContent = `${studentCalendarYear}ë…„ ${monthNames[studentCalendarMonth]}`;
      
      const firstDay = new Date(studentCalendarYear, studentCalendarMonth, 1);
      const lastDay = new Date(studentCalendarYear, studentCalendarMonth + 1, 0);
      const startDayOfWeek = firstDay.getDay();
      const daysInMonth = lastDay.getDate();
      
      const today = new Date().toISOString().split('T')[0];
      
      // ë‚´ê°€ ì‹ ì²­í•œ ì¼ì • ID ëª©ë¡
      const myScheduleIds = studentSchedules.map(r => r.schedule_id);
      
      // ì¼ì •ì´ ìˆëŠ” ë‚ ì§œ ë§µ ìƒì„±
      const scheduleDates = {};
      
      // 1. ë‚´ê°€ ì‹ ì²­í•œ ê°•ìŠµ (í•˜ëŠ˜ìƒ‰ ë°°ê²½)
      for (const s of studentSchedules) {
        if (s.schedules) {
          const date = s.schedules.date;
          if (!scheduleDates[date]) {
            scheduleDates[date] = { lesson: false, personal: false, dry: false, available: false };
          }
          scheduleDates[date].lesson = true;
        }
      }
      
      // 2. ë“œë¼ì´ íŠ¸ë ˆì´ë‹ ê¸°ë¡ (ì£¼í™©ìƒ‰ ë°°ê²½)
      for (const r of studentDryRecords) {
        if (r.date) {
          if (!scheduleDates[r.date]) {
            scheduleDates[r.date] = { lesson: false, personal: false, dry: false, available: false };
          }
          // ì´ë¯¸ ê°•ìŠµì´ ìˆëŠ” ë‚ ì€ ê°•ìŠµ ìš°ì„ 
          if (!scheduleDates[r.date].lesson) {
            scheduleDates[r.date].dry = true;
          }
        }
      }
      
      // 3. ì‹ ì²­ ê°€ëŠ¥í•œ ê°•ìŠµ (í…Œë‘ë¦¬ë§Œ - ë¯¸ë˜ ì¼ì •ë§Œ)
      for (const s of availableSchedules) {
        if (!myScheduleIds.includes(s.schedule_id) && s.date >= today) {
          if (!scheduleDates[s.date]) {
            scheduleDates[s.date] = { lesson: false, personal: false, dry: false, available: false };
          }
          // ë‹¤ë¥¸ ì¼ì •ì´ ì—†ëŠ” ê²½ìš°ì—ë§Œ ì‹ ì²­ ê°€ëŠ¥ í‘œì‹œ
          if (!scheduleDates[s.date].lesson && !scheduleDates[s.date].challenge) {
            scheduleDates[s.date].available = true;
          }
        }
      }
      
      let html = '';
      
      // ì´ì „ ë‹¬ ë‚ ì§œ
      const prevMonthLastDay = new Date(studentCalendarYear, studentCalendarMonth, 0).getDate();
      for (let i = startDayOfWeek - 1; i >= 0; i--) {
        const day = prevMonthLastDay - i;
        html += `<div class="calendar-day other-month">${day}</div>`;
      }
      
      // ì´ë²ˆ ë‹¬ ë‚ ì§œ
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${studentCalendarYear}-${String(studentCalendarMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const isToday = dateStr === today;
        const isSelected = dateStr === studentSelectedDate;
        const schedule = scheduleDates[dateStr];
        
        let classes = 'calendar-day';
        if (isToday) classes += ' today';
        if (isSelected) classes += ' selected';
        
        // ì¼ì • ìˆëŠ” ë‚ ì§œì— ìƒ‰ ë™ê·¸ë¼ë¯¸ í´ë˜ìŠ¤ ì¶”ê°€ (ìš°ì„ ìˆœìœ„: ê°•ìŠµ > ë“œë¼ì´ > ì‹ ì²­ê°€ëŠ¥)
        if (schedule) {
          if (schedule.lesson) classes += ' has-lesson';
          else if (schedule.dry) classes += ' has-dry';
          else if (schedule.available) classes += ' has-available';
        }
        
        html += `<div class="${classes}" onclick="selectStudentCalendarDate('${dateStr}')">${day}</div>`;
      }
      
      // ë‹¤ìŒ ë‹¬ ë‚ ì§œ
      const totalCells = startDayOfWeek + daysInMonth;
      const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
      for (let i = 1; i <= remainingCells; i++) {
        html += `<div class="calendar-day other-month">${i}</div>`;
      }
      
      document.getElementById('student-calendar-days').innerHTML = html;
      
      // ì„ íƒëœ ë‚ ì§œ ì¼ì • í‘œì‹œ
      renderStudentCalendarScheduleList();
    }

    function selectStudentCalendarDate(dateStr) {
      studentSelectedDate = dateStr;
      renderStudentCalendar();
    }

    function renderStudentCalendarScheduleList() {
      const date = new Date(studentSelectedDate);
      const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
      const dateText = `${date.getMonth() + 1}ì›” ${date.getDate()}ì¼ (${dayNames[date.getDay()]})`;
      document.getElementById('student-selected-date-text').textContent = dateText;
      
      const container = document.getElementById('student-calendar-schedule-list');
      let html = '';
      
      const today = new Date().toISOString().split('T')[0];
      
      // ë‚´ê°€ ì‹ ì²­í•œ ì¼ì •
      const myDaySchedules = studentSchedules.filter(s => s.schedules && s.schedules.date === studentSelectedDate);
      
      // ì‹ ì²­ ê°€ëŠ¥í•œ ì¼ì • (ë‚´ê°€ ì‹ ì²­í•˜ì§€ ì•Šì€ ê²ƒ, ì˜¤ëŠ˜ ì´í›„ë§Œ)
      const myScheduleIds = studentSchedules.map(r => r.schedule_id);
      const availableDaySchedules = availableSchedules.filter(s => 
        s.date === studentSelectedDate && 
        !myScheduleIds.includes(s.schedule_id) &&
        s.date >= today  // ì§€ë‚œ ë‚ ì§œ ì œì™¸
      );
      
      // ë“œë¼ì´ íŠ¸ë ˆì´ë‹ ê¸°ë¡
      const hasDryRecord = studentDryRecords.some(r => r.date === studentSelectedDate);
      
      // ì‹ ì²­í•œ ì¼ì • í‘œì‹œ
      for (const r of myDaySchedules) {
        const s = r.schedules;
        html += `<div class="card schedule-card" style="cursor: pointer;" onclick="openScheduleDetail('${r.reg_id}')">
          <div class="schedule-info">
            <div class="schedule-time">${formatTime(s.time)}</div>
            <div class="schedule-location">${s.location} Â· ${s.users?.name || 'ê°•ì‚¬'}</div>
          </div>
          <span class="my-schedule-badge">${r.purpose === 'í€ë‹¤ì´ë¹™' ? 'í€ë‹¤ì´ë¹™' : 'ê°•ìŠµ'}</span>
        </div>`;
      }
      
      // ì‹ ì²­ ê°€ëŠ¥í•œ ì¼ì • í‘œì‹œ (ë¯¸ë˜ ì¼ì •ë§Œ)
      for (const s of availableDaySchedules) {
        html += `<div class="card schedule-card">
          <div class="schedule-info">
            <div class="schedule-time">${formatTime(s.time)}</div>
            <div class="schedule-location">${s.location} Â· ${s.users?.name || 'ê°•ì‚¬'}</div>
          </div>
          <button class="btn btn-small btn-primary" onclick="openRegisterSheet('${s.schedule_id}')">ì‹ ì²­</button>
        </div>`;
      }
      
      // ì˜¤ëŠ˜ì´ê³  ì°¸ì—¬ ì¤‘ì¸ ë“œë¼ì´ íŠ¸ë ˆì´ë‹ì´ ìˆìœ¼ë©´ í‘œì‹œ (ë‹¤ì´ë¹™ ì¼ì • ìœ ë¬´ì™€ ê´€ê³„ì—†ì´)
      const isToday = studentSelectedDate === today;
      if (isToday && studentMyDryTrainings.length > 0) {
        for (const t of studentMyDryTrainings) {
          // ì˜¤ëŠ˜ ì´ íŠ¸ë ˆì´ë‹ì„ ì™„ë£Œí–ˆëŠ”ì§€ í™•ì¸
          const todayDone = studentDryRecords.some(r => r.date === today && r.dry_id === t.dry_id);
          
          html += `<div class="card schedule-card">
            <div class="schedule-info">
              <div class="schedule-time"><i class="fas fa-lungs" style="color: var(--warning);"></i> ${t.name}</div>
              <div class="schedule-location">${t.description || 'ë“œë¼ì´ íŠ¸ë ˆì´ë‹'}</div>
            </div>
            ${todayDone 
              ? `<span style="color: var(--success); font-size: 13px;"><i class="fas fa-check-circle"></i> ì™„ë£Œ</span>`
              : `<button class="btn btn-small btn-primary" onclick="quickDryRecord('${t.dry_id}')">ì²´í¬</button>`
            }
          </div>`;
        }
      } else if (hasDryRecord) {
        // ì˜¤ëŠ˜ì´ ì•„ë‹Œ ë‚ ì§œì— ë“œë¼ì´ ê¸°ë¡ì´ ìˆìœ¼ë©´ ì™„ë£Œ í‘œì‹œ
        html += `<div class="card schedule-card">
          <div class="schedule-info">
            <div class="schedule-time"><i class="fas fa-lungs" style="color: var(--warning);"></i> ë“œë¼ì´ íŠ¸ë ˆì´ë‹</div>
            <div class="schedule-location">ì™„ë£Œ</div>
          </div>
          <span style="color: var(--success); font-size: 13px;"><i class="fas fa-check-circle"></i></span>
        </div>`;
      }
      
      if (!html) {
        html = '<div class="card" style="text-align: center; color: var(--text-tertiary); padding: 30px;">ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤</div>';
      }
      
      container.innerHTML = html;
    }

    function toggleScheduleSection(type) {
      const section = document.getElementById('schedule-' + type + '-section');
      const toggle = document.getElementById('schedule-' + type + '-toggle');
      
      if (section.style.display === 'none') {
        section.style.display = 'block';
        toggle.textContent = 'ì ‘ê¸°';
      } else {
        section.style.display = 'none';
        toggle.textContent = 'ì„ íƒ';
      }
    }

    function resetScheduleFormChecks(defaultDiscs, defaultSkills) {
      // ê¸°ë¡ ì¢…ëª© ì²´í¬ë°•ìŠ¤ ì´ˆê¸°í™”
      document.querySelectorAll('#schedule-disc-checks input[type="checkbox"]').forEach(cb => {
        cb.checked = defaultDiscs.includes(cb.value);
      });
      
      // ìŠ¤í‚¬ ì¢…ëª© ì²´í¬ë°•ìŠ¤ ì´ˆê¸°í™” (ì˜ì–´â†’í•œêµ­ì–´ ë§¤í•‘ ì ìš©)
      document.querySelectorAll('#schedule-skill-section input[type="checkbox"]').forEach(cb => {
        const koreanName = cb.value;
        const englishName = toEnglishSkillName(koreanName);
        cb.checked = defaultSkills.includes(koreanName) || defaultSkills.includes(englishName);
      });
    }

    function openScheduleForm(scheduleId) {
      document.getElementById('schedule-form-title').textContent = scheduleId ? 'ì¼ì • ìˆ˜ì •' : 'ìƒˆ ì¼ì • ë“±ë¡';
      document.getElementById('edit-schedule-id').value = scheduleId || '';
      
      // í† ê¸€ ì„¹ì…˜ ì´ˆê¸°í™” (ë‹«ê¸°)
      document.getElementById('schedule-disc-section').style.display = 'none';
      document.getElementById('schedule-disc-toggle').textContent = 'ì„ íƒ';
      document.getElementById('schedule-skill-section').style.display = 'none';
      document.getElementById('schedule-skill-toggle').textContent = 'ì„ íƒ';
      
      if (scheduleId) {
        // ìˆ˜ì • ëª¨ë“œ - ê¸°ì¡´ ë°ì´í„° ë¡œë“œ
        const s = allSchedules.find(x => x.schedule_id === scheduleId);
        if (s) {
          document.getElementById('schedule-date').value = s.date;
          document.getElementById('schedule-time').value = s.time;
          document.getElementById('schedule-location').value = s.location;
          
          // DBì— ì €ì¥ëœ ì¢…ëª© ì •ë³´ ë¡œë“œ (NULLì´ë©´ ë¹ˆ ë°°ì—´)
          const savedDiscs = s.common_disciplines ? s.common_disciplines.split(',') : [];
          const savedSkills = s.common_skill_disciplines ? s.common_skill_disciplines.split(',') : [];
          resetScheduleFormChecks(savedDiscs, savedSkills);
        }
      } else {
        // ìƒˆ ì¼ì • - ê¸°ë³¸ê°’
        document.getElementById('schedule-date').value = '';
        document.getElementById('schedule-time').value = '';
        document.getElementById('schedule-location').value = '';
        
        // ê¸°ë³¸ ì„ íƒ: STA, DYNB, FIM, CWTBë§Œ
        resetScheduleFormChecks(['STA', 'DYNB', 'FIM', 'CWTB'], []);
      }
      
      openBottomSheet('sheet-schedule');
    }

    async function saveSchedule() {
      const scheduleId = document.getElementById('edit-schedule-id').value;
      const date = document.getElementById('schedule-date').value;
      const time = document.getElementById('schedule-time').value;
      const location = document.getElementById('schedule-location').value;
      
      if (!date || !time || !location) {
        showToast('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return;
      }
      
      // ì„ íƒëœ ê¸°ë¡ ì¢…ëª©
      const recordDiscs = [];
      document.querySelectorAll('#schedule-disc-checks input[type="checkbox"]:checked').forEach(cb => {
        recordDiscs.push(cb.value);
      });
      
      // ì„ íƒëœ ìŠ¤í‚¬ ì¢…ëª© (ì˜ì–´ë¡œ ë³€í™˜í•´ì„œ ì €ì¥)
      const skillDiscs = [];
      document.querySelectorAll('#schedule-skill-section input[type="checkbox"]:checked').forEach(cb => {
        skillDiscs.push(toEnglishSkillName(cb.value));
      });
      
      try {
        const scheduleData = {
          date,
          time,
          location,
          common_disciplines: recordDiscs.length > 0 ? recordDiscs.join(',') : null,
          common_skill_disciplines: skillDiscs.length > 0 ? skillDiscs.join(',') : null
        };
        
        if (scheduleId) {
          // ìˆ˜ì •
          const { error } = await db
            .from('schedules')
            .update(scheduleData)
            .eq('schedule_id', scheduleId);
          
          if (error) throw error;
          showToast('ì¼ì •ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
        } else {
          // ìƒˆë¡œ ìƒì„±
          const newId = 'SCH_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
          const { error } = await db
            .from('schedules')
            .insert({
              schedule_id: newId,
              instructor_id: currentUser.user_id,
              ...scheduleData
            });
          
          if (error) throw error;
          showToast('ì¼ì •ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤');
        }
        
        closeBottomSheet('sheet-schedule');
        loadScheduleManage();
        loadTodaySchedules();
      } catch (err) {
        console.error('ì¼ì • ì €ì¥ ì˜¤ë¥˜:', err);
        showToast('ì €ì¥ ì‹¤íŒ¨: ' + err.message);
      }
    }

    // ==================== ì°¸ê°€ì ê´€ë¦¬ ====================
    async function openParticipants(scheduleId) {
      currentScheduleId = scheduleId;
      const s = allSchedules.find(x => x.schedule_id === scheduleId);
      
      if (s) {
        document.getElementById('participant-schedule-date').textContent = formatDate(s.date) + ' ' + formatTime(s.time);
        document.getElementById('participant-schedule-location').textContent = s.location;
      }
      
      showScreen('screen-participants');
      await loadParticipants();
    }

    async function loadParticipants() {
      try {
        // ì°¸ê°€ì ëª©ë¡ ì¡°íšŒ (users í…Œì´ë¸”ê³¼ ì¡°ì¸)
        const { data: regs, error } = await db
          .from('registrations')
          .select(`
            reg_id,
            student_id,
            purpose,
            lesson_level,
            attendance,
            users!registrations_student_id_fkey (
              user_id,
              name,
              cert_level
            )
          `)
          .eq('schedule_id', currentScheduleId);
        
        if (error) throw error;
        
        const lessons = [];
        const funs = [];
        
        for (const r of (regs || [])) {
          const participant = {
            reg_id: r.reg_id,
            student_id: r.student_id,
            purpose: r.purpose,
            lesson_level: r.lesson_level,
            attendance: r.attendance,
            student_name: r.users?.name || 'ì•Œ ìˆ˜ ì—†ìŒ',
            student_cert: r.users?.cert_level || 'X'
          };
          
          if (r.purpose === 'ê°•ìŠµ') lessons.push(participant);
          else funs.push(participant);
        }
        
        document.getElementById('lesson-participants').innerHTML = lessons.length === 0 
          ? '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">ê°•ìŠµ ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤</div>'
          : lessons.map(p => renderParticipantCard(p)).join('');
        
        document.getElementById('fun-participants').innerHTML = funs.length === 0
          ? '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">í€ë‹¤ì´ë¹™ ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤</div>'
          : funs.map(p => renderParticipantCard(p)).join('');
          
      } catch (err) {
        console.error('ì°¸ê°€ì ë¡œë“œ ì˜¤ë¥˜:', err);
        document.getElementById('lesson-participants').innerHTML = 
          '<div style="text-align: center; color: var(--error); padding: 20px;">ì°¸ê°€ìë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤</div>';
      }
    }

    function renderParticipantCard(p) {
      const attClass = p.attendance === 'Y' ? 'attendance-yes' : p.attendance === 'N' ? 'attendance-no' : 'attendance-pending';
      const attText = p.attendance === 'Y' ? 'ì¶œì„' : p.attendance === 'N' ? 'ë¶ˆì°¸' : 'ë¯¸ì •';
      
      return `<div class="participant-card">
        <div class="participant-avatar">${p.student_name ? p.student_name.charAt(0) : '?'}</div>
        <div class="participant-info">
          <div class="participant-name">${p.student_name}</div>
          <div class="participant-detail">Lv.${p.student_cert || 'X'}${p.lesson_level ? ' Â· Lv.' + p.lesson_level + ' ìˆ˜ê°•ì¤‘' : ''}</div>
        </div>
        <div class="attendance-badge ${attClass}" onclick="toggleAttendance('${p.reg_id}', '${p.attendance}')" style="cursor: pointer;">${attText}</div>
        <button class="btn-icon-delete" onclick="deleteParticipant('${p.reg_id}')" title="ì‚­ì œ">
          <i class="fas fa-times"></i>
        </button>
      </div>`;
    }

    async function deleteParticipant(regId) {
      if (!confirm('ì´ ì°¸ê°€ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      
      try {
        // ê´€ë ¨ ê¸°ë¡ ì‚­ì œ
        await db.from('dive_records').delete().eq('reg_id', regId);
        await db.from('skill_records').delete().eq('reg_id', regId);
        
        // ì°¸ê°€ì ì‚­ì œ
        const { error } = await db
          .from('registrations')
          .delete()
          .eq('reg_id', regId);
        
        if (error) throw error;
        
        showToast('ì°¸ê°€ìê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
        loadParticipants();
      } catch (err) {
        console.error('ì°¸ê°€ì ì‚­ì œ ì˜¤ë¥˜:', err);
        showToast('ì‚­ì œ ì‹¤íŒ¨: ' + err.message);
      }
    }

    async function toggleAttendance(regId, currentStatus) {
      const nextStatus = currentStatus === 'Y' ? 'N' : currentStatus === 'N' ? 'ë¯¸ì •' : 'Y';
      
      try {
        const { error } = await db
          .from('registrations')
          .update({ attendance: nextStatus })
          .eq('reg_id', regId);
        
        if (error) throw error;
        await loadParticipants();
      } catch (err) {
        console.error('ì¶œì„ ë³€ê²½ ì˜¤ë¥˜:', err);
        showToast('ì¶œì„ ë³€ê²½ ì‹¤íŒ¨');
      }
    }

    async function openAddParticipant() {
      try {
        // ê°•ìŠµìƒ ëª©ë¡ ì¡°íšŒ
        const { data: students, error } = await db
          .from('users')
          .select('user_id, name, phone')
          .eq('user_type', 'ê°•ìŠµìƒ');
        
        if (error) throw error;
        
        const select = document.getElementById('participant-student');
        let html = '<option value="">ê°•ìŠµìƒì„ ì„ íƒí•˜ì„¸ìš”</option>';
        for (const s of (students || [])) {
          html += `<option value="${s.user_id}">${s.name} (${s.phone})</option>`;
        }
        select.innerHTML = html;
        
        openBottomSheet('sheet-add-participant');
      } catch (err) {
        console.error('ê°•ìŠµìƒ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', err);
        showToast('ê°•ìŠµìƒ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤');
      }
    }

    function selectPurpose(btn) {
      document.querySelectorAll('#sheet-add-participant .purpose-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      document.getElementById('lesson-level-group').style.display = btn.dataset.purpose === 'ê°•ìŠµ' ? 'block' : 'none';
    }

    async function addParticipant() {
      const studentId = document.getElementById('participant-student').value;
      const purposeBtn = document.querySelector('#sheet-add-participant .purpose-btn.selected');
      const purpose = purposeBtn.dataset.purpose;
      const level = purpose === 'ê°•ìŠµ' ? parseInt(document.getElementById('participant-level').value) : null;
      
      if (!studentId) {
        showToast('ê°•ìŠµìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”');
        return;
      }
      
      try {
        const regId = 'REG_' + studentId + '_' + Date.now();
        const { error } = await db
          .from('registrations')
          .insert({
            reg_id: regId,
            schedule_id: currentScheduleId,
            student_id: studentId,
            purpose,
            lesson_level: level,
            attendance: 'Y'
          });
        
        if (error) throw error;
        
        showToast('ì°¸ê°€ìê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
        closeBottomSheet('sheet-add-participant');
        await loadParticipants();
      } catch (err) {
        console.error('ì°¸ê°€ì ì¶”ê°€ ì˜¤ë¥˜:', err);
        showToast('ì¶”ê°€ ì‹¤íŒ¨: ' + (err.message || 'ì´ë¯¸ ë“±ë¡ëœ ì°¸ê°€ìì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤'));
      }
    }

    // ==================== ê°•ìŠµìƒ ì¼ì • ====================
    let availableSchedules = []; // ì‹ ì²­ ê°€ëŠ¥í•œ ê°•ìŠµ
    let studentDryRecords = []; // ë“œë¼ì´ íŠ¸ë ˆì´ë‹ ê¸°ë¡
    let studentMyDryTrainings = []; // ì°¸ì—¬ ì¤‘ì¸ ë“œë¼ì´ íŠ¸ë ˆì´ë‹
    
    async function loadStudentSchedule() {
      try {
        const today = new Date().toISOString().split('T')[0];
        
        // ì—´ë¦° ì¼ì • ì¡°íšŒ (ëª¨ë“  ì¼ì • - ìº˜ë¦°ë”ìš©)
        const { data: schedules, error } = await db
          .from('schedules')
          .select(`
            schedule_id,
            date,
            time,
            location,
            instructor_id,
            users!schedules_instructor_id_fkey (name)
          `)
          .order('date', { ascending: true });
        
        if (error) throw error;
        
        // ì‹ ì²­ ê°€ëŠ¥í•œ ê°•ìŠµ ì €ì¥ (ìº˜ë¦°ë”ìš©)
        availableSchedules = schedules || [];
        
        // ë‚´ê°€ ì´ë¯¸ ì‹ ì²­í•œ ì¼ì • ì¡°íšŒ (ëª¨ë“  ì¼ì • - ê³¼ê±° í¬í•¨)
        const { data: myRegs } = await db
          .from('registrations')
          .select(`
            reg_id,
            schedule_id, 
            purpose,
            schedules (
              schedule_id,
              date,
              time,
              location,
              users!schedules_instructor_id_fkey (name)
            )
          `)
          .eq('student_id', currentUser.user_id);
        
        // í•™ìƒ ìº˜ë¦°ë”ìš© ì¼ì • ì €ì¥
        studentSchedules = myRegs || [];
        
        // ë“œë¼ì´ íŠ¸ë ˆì´ë‹ ê¸°ë¡ ì¡°íšŒ
        const { data: dryRecords } = await db
          .from('dry_training_records')
          .select('date, dry_id')
          .eq('user_id', currentUser.user_id);
        
        studentDryRecords = dryRecords || [];
        
        // ì°¸ì—¬ ì¤‘ì¸ ë“œë¼ì´ íŠ¸ë ˆì´ë‹ ì¡°íšŒ
        const { data: allDry } = await db
          .from('dry_trainings')
          .select('dry_id, name, description')
          .contains('participants', [currentUser.user_id]);
        
        studentMyDryTrainings = allDry || [];
        
        const myScheduleIds = myRegs ? myRegs.map(r => r.schedule_id) : [];
        
        // ë‚´ê°€ ì‹ ì²­í•œ ì¼ì • ì¤‘ ì§€ë‚œ ì¼ì •
        const pastMySchedules = (myRegs || []).filter(r => r.schedules && r.schedules.date < today);
        
        // ë¯¸ë˜ ì¼ì •ë§Œ í•„í„°ë§ (ë¦¬ìŠ¤íŠ¸ìš©)
        const futureSchedules = (schedules || []).filter(s => s.date >= today);
        
        const container = document.getElementById('available-schedules');
        let html = '';
        
        // ë‹¤ê°€ì˜¤ëŠ” ì¼ì • (ì—´ë¦° ì¼ì •)
        if (futureSchedules && futureSchedules.length > 0) {
          html += '<div class="schedule-section-title"><i class="fas fa-arrow-right"></i> ë‹¤ê°€ì˜¤ëŠ” ì¼ì •</div>';
          for (const s of futureSchedules) {
            const isRegistered = myScheduleIds.includes(s.schedule_id);
            const myReg = myRegs ? myRegs.find(r => r.schedule_id === s.schedule_id) : null;
            
            html += `<div class="card schedule-card">
              <div class="schedule-info">
                <div class="schedule-time">${formatDate(s.date)} ${formatTime(s.time)}</div>
                <div class="schedule-location">${s.location} Â· ${s.users?.name || 'ê°•ì‚¬'}</div>
              </div>
              ${isRegistered 
                ? `<span class="my-schedule-badge" style="cursor: pointer;" onclick="cancelRegistration('${myReg?.reg_id}')">${myReg?.purpose === 'í€ë‹¤ì´ë¹™' ? 'í€ë‹¤ì´ë¹™' : 'ê°•ìŠµ'} ì‹ ì²­ì™„ë£Œ</span>` 
                : `<button class="btn btn-small btn-primary" onclick="openRegisterSheet('${s.schedule_id}')">ì‹ ì²­</button>`
              }
            </div>`;
          }
        }
        
        // ì§€ë‚œ ì¼ì • (ë‚´ê°€ ì°¸ì—¬í•œ ê²ƒë§Œ)
        if (pastMySchedules.length > 0) {
          html += '<div class="schedule-section-title" style="margin-top: 24px;"><i class="fas fa-check"></i> ì§€ë‚œ ì¼ì •</div>';
          // ìµœì‹ ìˆœ ì •ë ¬
          const sortedPast = pastMySchedules.sort((a, b) => b.schedules.date.localeCompare(a.schedules.date));
          for (const r of sortedPast) {
            const s = r.schedules;
            html += `<div class="card schedule-card" style="cursor: pointer;" onclick="openScheduleDetail('${r.reg_id}')">
              <div class="schedule-info">
                <div class="schedule-time">${formatDate(s.date)} ${formatTime(s.time)}</div>
                <div class="schedule-location">${s.location} Â· ${s.users?.name || 'ê°•ì‚¬'}</div>
              </div>
              <span style="color: var(--text-tertiary); font-size: 13px;">${r.purpose} <i class="fas fa-chevron-right"></i></span>
            </div>`;
          }
        }
        
        if (!html) {
          html = '<div class="card" style="text-align: center; color: var(--text-secondary);">ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤</div>';
        }
        
        container.innerHTML = html;
        // ìº˜ë¦°ë”í˜•ì´ ê¸°ë³¸ì´ë¯€ë¡œ ìº˜ë¦°ë”ë„ ë Œë”ë§
        renderStudentCalendar();
      } catch (err) {
        console.error('ì¼ì • ë¡œë“œ ì˜¤ë¥˜:', err);
        document.getElementById('available-schedules').innerHTML = 
          '<div class="card" style="text-align: center; color: var(--error);">ì¼ì •ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤</div>';
      }
    }
    
    // í•™ìƒ ì¼ì • ìƒì„¸ í™”ë©´ ì—´ê¸°
    let currentDetailRegId = null;
    
    async function openScheduleDetail(regId) {
      currentDetailRegId = regId;
      
      try {
        // ë“±ë¡ ì •ë³´ ì¡°íšŒ (ì¼ì • ì •ë³´, ê°•ì‚¬ í”¼ë“œë°±, ë‚´ ë…¸íŠ¸ í¬í•¨)
        const { data: reg } = await db
          .from('registrations')
          .select(`
            reg_id,
            purpose,
            lesson_level,
            note_instructor,
            note_student,
            schedule_id,
            schedules (
              schedule_id,
              date,
              time,
              location,
              note,
              common_disciplines,
              common_skill_disciplines,
              users!schedules_instructor_id_fkey (name)
            )
          `)
          .eq('reg_id', regId)
          .single();
        
        if (!reg) {
          showToast('ì¼ì • ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
          return;
        }
        
        const s = reg.schedules;
        
        // ê°™ì€ ì¼ì •ì˜ ë‹¤ë¥¸ ì°¸ê°€ì ì¡°íšŒ (lesson_level í¬í•¨)
        const { data: otherParticipants } = await db
          .from('registrations')
          .select('student_id, purpose, lesson_level, users!registrations_student_id_fkey(name)')
          .eq('schedule_id', reg.schedule_id)
          .neq('student_id', currentUser.user_id);
        
        // ì°¸ê°€ì ëª©ë¡ ìƒì„± (ëª©ì ë³„ë¡œ ë¶„ë¥˜)
        const lv3Participants = [];
        const lv2Participants = [];
        const funDiveParticipants = [];
        
        // ë³¸ì¸ ì¶”ê°€
        if (reg.purpose === 'í€ë‹¤ì´ë¹™') {
          funDiveParticipants.push(currentUser.name);
        } else if (reg.lesson_level === 3) {
          lv3Participants.push(currentUser.name);
        } else if (reg.lesson_level === 2) {
          lv2Participants.push(currentUser.name);
        } else {
          // ë ˆë²¨ ë¯¸ì§€ì • ê°•ìŠµì€ Lv2ë¡œ ê°„ì£¼
          lv2Participants.push(currentUser.name);
        }
        
        // ë‹¤ë¥¸ ì°¸ê°€ì ì¶”ê°€
        if (otherParticipants && otherParticipants.length > 0) {
          for (const p of otherParticipants) {
            const name = p.users?.name || 'í•™ìƒ';
            if (p.purpose === 'í€ë‹¤ì´ë¹™') {
              funDiveParticipants.push(name);
            } else if (p.lesson_level === 3) {
              lv3Participants.push(name);
            } else if (p.lesson_level === 2) {
              lv2Participants.push(name);
            } else {
              lv2Participants.push(name);
            }
          }
        }
        
        // ì°¸ê°€ì HTML ìƒì„± (Lv3 â†’ Lv2 â†’ í€ë‹¤ì´ë¹™ ìˆœì„œ)
        let participantsHtml = '';
        if (lv3Participants.length > 0) {
          participantsHtml += `
            <div style="display: flex; align-items: flex-start; gap: 8px; color: var(--text-secondary); margin-top: 4px;">
              <i class="fas fa-graduation-cap" style="margin-top: 3px;"></i>
              <span>Lv3 ê°•ìŠµ: ${lv3Participants.join(', ')}</span>
            </div>
          `;
        }
        if (lv2Participants.length > 0) {
          participantsHtml += `
            <div style="display: flex; align-items: flex-start; gap: 8px; color: var(--text-secondary); margin-top: 4px;">
              <i class="fas fa-graduation-cap" style="margin-top: 3px;"></i>
              <span>Lv2 ê°•ìŠµ: ${lv2Participants.join(', ')}</span>
            </div>
          `;
        }
        if (funDiveParticipants.length > 0) {
          participantsHtml += `
            <div style="display: flex; align-items: flex-start; gap: 8px; color: var(--text-secondary); margin-top: 4px;">
              <i class="fas fa-water" style="margin-top: 3px;"></i>
              <span>í€ë‹¤ì´ë¹™: ${funDiveParticipants.join(', ')}</span>
            </div>
          `;
        }
        
        // ì¢…ëª© í‘œì‹œ
        let disciplinesHtml = '';
        const disciplines = s.common_disciplines ? s.common_disciplines.split(',') : [];
        const skillItems = s.common_skill_disciplines ? s.common_skill_disciplines.split(',') : [];
        
        // Lv2, Lv3 ìŠ¤í‚¬ ë¶„ë¥˜
        const lv2Skills = ['rescue_5_10m', 'theory_test_lv2'];
        const lv3Skills = ['lanyard_remove', 'no_mask_10m', 'rescue_towing', 'neutral_buoyancy', 'freefall', 'arms_only_15m', 'buddy_10_15m', 'theory_test'];
        
        const lv2SkillItems = skillItems.filter(sk => lv2Skills.includes(sk));
        const lv3SkillItems = skillItems.filter(sk => lv3Skills.includes(sk));
        
        if (disciplines.length > 0) {
          disciplinesHtml += `
            <div style="display: flex; align-items: center; gap: 8px; margin-top: 12px; flex-wrap: wrap;">
              <span style="color: var(--text-tertiary); font-size: 13px;">ê¸°ë¡ì¢…ëª©</span>
              ${disciplines.map(d => `<span style="padding: 2px 8px; background: var(--primary-light); color: var(--primary); border-radius: 10px; font-size: 12px;">${d}</span>`).join('')}
            </div>
          `;
        }
        if (lv3SkillItems.length > 0) {
          disciplinesHtml += `
            <div style="display: flex; align-items: center; gap: 8px; margin-top: 8px; flex-wrap: wrap;">
              <span style="color: var(--text-tertiary); font-size: 13px;">Lv3 ìŠ¤í‚¬</span>
              ${lv3SkillItems.map(sk => `<span style="padding: 2px 8px; background: var(--lv3-light); color: var(--lv3-color); border-radius: 10px; font-size: 12px;">${toKoreanSkillName(sk)}</span>`).join('')}
            </div>
          `;
        }
        if (lv2SkillItems.length > 0) {
          disciplinesHtml += `
            <div style="display: flex; align-items: center; gap: 8px; margin-top: 8px; flex-wrap: wrap;">
              <span style="color: var(--text-tertiary); font-size: 13px;">Lv2 ìŠ¤í‚¬</span>
              ${lv2SkillItems.map(sk => `<span style="padding: 2px 8px; background: var(--lv2-light); color: var(--lv2-color); border-radius: 10px; font-size: 12px;">${toKoreanSkillName(sk)}</span>`).join('')}
            </div>
          `;
        }
        
        // ì¼ì • ì •ë³´ í‘œì‹œ
        document.getElementById('schedule-detail-info').innerHTML = `
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
            <i class="fas fa-calendar" style="color: var(--primary);"></i>
            <span style="font-weight: 600;">${formatDate(s.date)} ${formatTime(s.time)}</span>
          </div>
          <div style="display: flex; align-items: center; gap: 8px; color: var(--text-secondary);">
            <i class="fas fa-map-marker-alt"></i>
            <span>${s.location}</span>
          </div>
          <div style="display: flex; align-items: center; gap: 8px; color: var(--text-secondary); margin-top: 4px;">
            <i class="fas fa-user"></i>
            <span>${s.users?.name || 'ê°•ì‚¬'}</span>
          </div>
          ${participantsHtml}
          ${disciplinesHtml}
        `;
        
        // ê°•ì‚¬ í”¼ë“œë°± í‘œì‹œ
        const instructorNoteSection = document.getElementById('schedule-detail-instructor-note');
        if (reg.note_instructor) {
          document.getElementById('schedule-detail-instructor-note-text').textContent = reg.note_instructor;
          instructorNoteSection.style.display = 'block';
        } else {
          instructorNoteSection.style.display = 'none';
        }
        
        // ë‚´ ë…¸íŠ¸ í‘œì‹œ
        document.getElementById('schedule-detail-my-note').value = reg.note_student || '';
        
        // ê¸°ë¡ ì¡°íšŒ ë° í‘œì‹œ
        const { data: diveRecords } = await db
          .from('dive_records')
          .select('discipline, attempt, value')
          .eq('reg_id', regId)
          .order('discipline')
          .order('attempt');
        
        const recordsSection = document.getElementById('schedule-detail-records');
        const recordsList = document.getElementById('schedule-detail-records-list');
        
        if (diveRecords && diveRecords.length > 0) {
          // ì¢…ëª©ë³„ë¡œ ê·¸ë£¹í•‘
          const grouped = {};
          for (const r of diveRecords) {
            if (!grouped[r.discipline]) grouped[r.discipline] = [];
            grouped[r.discipline].push(r);
          }
          
          let recordsHtml = '';
          for (const disc of Object.keys(grouped)) {
            const records = grouped[disc];
            const values = records.map(r => {
              if (disc === 'STA') {
                const min = Math.floor(r.value / 60);
                const sec = Math.floor(r.value % 60);
                return `${min}'${sec.toString().padStart(2, '0')}"`;
              }
              return r.value + 'm';
            });
            recordsHtml += `
              <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--divider);">
                <span style="font-weight: 500;">${disc}</span>
                <span style="color: var(--text-secondary);">${values.join(' / ')}</span>
              </div>
            `;
          }
          recordsList.innerHTML = recordsHtml;
          recordsSection.style.display = 'block';
        } else {
          recordsSection.style.display = 'none';
        }
        
        showScreen('screen-schedule-detail');
      } catch (err) {
        console.error('ì¼ì • ìƒì„¸ ë¡œë“œ ì˜¤ë¥˜:', err);
        showToast('ì¼ì • ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤');
      }
    }
    
    // í•™ìƒ ë…¸íŠ¸ ì €ì¥
    async function saveStudentNote() {
      const note = document.getElementById('schedule-detail-my-note').value.trim();
      
      try {
        await db
          .from('registrations')
          .update({ note_student: note || null })
          .eq('reg_id', currentDetailRegId);
        
        showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
      } catch (err) {
        console.error('ë…¸íŠ¸ ì €ì¥ ì˜¤ë¥˜:', err);
        showToast('ì €ì¥ ì‹¤íŒ¨: ' + err.message);
      }
    }

    let pendingScheduleId = null;
    
    function openRegisterSheet(scheduleId) {
      pendingScheduleId = scheduleId;
      // ê¸°ë³¸ê°’ ì„¤ì •
      document.querySelectorAll('#sheet-register .purpose-btn').forEach(b => b.classList.remove('selected'));
      document.querySelector('#sheet-register .purpose-btn[data-purpose="ê°•ìŠµ"]').classList.add('selected');
      document.getElementById('register-level-group').style.display = 'block';
      document.getElementById('register-level').value = currentUser.in_training_level || '2';
      openBottomSheet('sheet-register');
    }
    
    function selectRegisterPurpose(btn) {
      document.querySelectorAll('#sheet-register .purpose-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      document.getElementById('register-level-group').style.display = btn.dataset.purpose === 'ê°•ìŠµ' ? 'block' : 'none';
    }

    async function registerSchedule() {
      const purposeBtn = document.querySelector('#sheet-register .purpose-btn.selected');
      const purpose = purposeBtn.dataset.purpose;
      const level = purpose === 'ê°•ìŠµ' ? parseInt(document.getElementById('register-level').value) : null;
      
      try {
        const regId = 'REG_' + currentUser.user_id + '_' + Date.now();
        const { error } = await db
          .from('registrations')
          .insert({
            reg_id: regId,
            schedule_id: pendingScheduleId,
            student_id: currentUser.user_id,
            purpose,
            lesson_level: level,
            attendance: 'Y'
          });
        
        if (error) throw error;
        
        showToast('ì¼ì • ì‹ ì²­ ì™„ë£Œ!');
        closeBottomSheet('sheet-register');
        loadStudentSchedule();
        loadUpcomingSchedules();
      } catch (err) {
        console.error('ì¼ì • ì‹ ì²­ ì˜¤ë¥˜:', err);
        showToast('ì‹ ì²­ ì‹¤íŒ¨: ' + (err.message || 'ì´ë¯¸ ì‹ ì²­í–ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤'));
      }
    }

    async function cancelRegistration(regId) {
      if (!confirm('ì¼ì • ì‹ ì²­ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      
      try {
        const { error } = await db
          .from('registrations')
          .delete()
          .eq('reg_id', regId);
        
        if (error) throw error;
        
        showToast('ì‹ ì²­ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤');
        loadStudentSchedule();
        loadUpcomingSchedules();
      } catch (err) {
        console.error('ì‹ ì²­ ì·¨ì†Œ ì˜¤ë¥˜:', err);
        showToast('ì·¨ì†Œ ì‹¤íŒ¨: ' + err.message);
      }
    }

    // ==================== ë‚˜ì˜ ê¸°ë¡ ====================
    async function loadMyRecords() {
      // íƒ­ë°” ë Œë”ë§
      const isInstructor = currentUser.user_type === 'ê°•ì‚¬';
      document.getElementById('my-records-tabbar').innerHTML = `
        <button class="tab-item" onclick="showScreen('${isInstructor ? 'screen-instructor-home' : 'screen-student-home'}')"><i class="fas fa-home"></i><span>í™ˆ</span></button>
        <button class="tab-item" onclick="showScreen('${isInstructor ? 'screen-schedule-manage' : 'screen-student-schedule'}')"><i class="fas fa-calendar"></i><span>ì¼ì •</span></button>
        <button class="tab-item" onclick="showScreen('${isInstructor ? 'screen-dry-manage' : 'screen-dry-training'}')"><i class="fas fa-lungs"></i><span>ë“œë¼ì´</span></button>
        <button class="tab-item active"><i class="fas fa-chart-line"></i><span>ë‚´ê¸°ë¡</span></button>
        <button class="tab-item" onclick="showScreen('screen-mypage')"><i class="fas fa-user"></i><span>ë§ˆì´</span></button>
      `;
      
      try {
        let allRecords = [];
        
        // 1. ê°•ìŠµ ê¸°ë¡ ì¡°íšŒ (registrations â†’ dive_records)
        const { data: regs } = await db
          .from('registrations')
          .select('reg_id, schedule_id')
          .eq('student_id', currentUser.user_id);
        
        if (regs && regs.length > 0) {
          const regIds = regs.map(r => r.reg_id);
          const scheduleIds = regs.map(r => r.schedule_id);
          
          // ì¼ì • ë‚ ì§œ ì¡°íšŒ
          const { data: schedules } = await db
            .from('schedules')
            .select('schedule_id, date')
            .in('schedule_id', scheduleIds);
          
          const scheduleMap = {};
          for (const s of (schedules || [])) {
            scheduleMap[s.schedule_id] = s.date;
          }
          
          // reg_id â†’ schedule_id ë§¤í•‘
          const regToSchedule = {};
          for (const r of regs) {
            regToSchedule[r.reg_id] = r.schedule_id;
          }
          
          // ê°•ìŠµ ê¸°ë¡
          const { data: lessonRecords } = await db
            .from('dive_records')
            .select('record_id, reg_id, discipline, attempt, value, note')
            .in('reg_id', regIds);
          
          for (const r of (lessonRecords || [])) {
            const scheduleId = regToSchedule[r.reg_id];
            const date = scheduleMap[scheduleId] || 'ë‚ ì§œ ì—†ìŒ';
            allRecords.push({
              ...r,
              date,
              type: 'ê°•ìŠµ'
            });
          }
        }
        
        // 2. ê°œì¸ ê¸°ë¡ ì¡°íšŒ (personal_dive_records)
        const { data: personalRecords } = await db
          .from('personal_dive_records')
          .select(`
            record_id,
            personal_schedule_id,
            discipline,
            attempt,
            value,
            personal_schedules!personal_dive_records_personal_schedule_id_fkey (date)
          `)
          .eq('user_id', currentUser.user_id);
        
        for (const r of (personalRecords || [])) {
          allRecords.push({
            record_id: r.record_id,
            discipline: r.discipline,
            attempt: r.attempt,
            value: r.value,
            date: r.personal_schedules?.date || 'ë‚ ì§œ ì—†ìŒ',
            type: 'ê°œì¸'
          });
        }
        
        // ê¸°ë¡ì´ ì—†ëŠ” ê²½ìš°
        if (allRecords.length === 0) {
          document.getElementById('my-best-records').innerHTML = 
            '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>';
          document.getElementById('my-all-records').innerHTML = 
            '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>';
          document.getElementById('growth-chart-card').style.display = 'none';
          return;
        }
        
        // ì„±ì¥ ê·¸ë˜í”„ìš© ë°ì´í„° ì €ì¥
        allRecordsForChart = allRecords;
        document.getElementById('growth-chart-card').style.display = 'block';
        renderGrowthChart();
        
        // ì¢…ëª©ë³„ ìµœê³  ê¸°ë¡ ê³„ì‚°
        const bestByDiscipline = {};
        for (const r of allRecords) {
          const val = parseFloat(r.value) || 0;
          if (!bestByDiscipline[r.discipline] || val > bestByDiscipline[r.discipline]) {
            bestByDiscipline[r.discipline] = val;
          }
        }
        
        const disciplines = ['STA', 'DYNB', 'FIM', 'CWTB', 'DNF', 'CNF', 'DYN', 'CWT'];
        let bestHtml = '';
        for (const d of disciplines) {
          const best = bestByDiscipline[d];
          const val = best ? (d === 'STA' ? best + 's' : best + 'm') : '-';
          bestHtml += `<div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--divider);">
            <span style="font-weight: 500;">${d}</span>
            <span style="color: var(--primary); font-weight: 600;">${val}</span>
          </div>`;
        }
        
        document.getElementById('my-best-records').innerHTML = bestHtml;
        
        // ë‚ ì§œë³„ ê·¸ë£¹í•‘ (ë‚ ì§œë³„ ìµœê³  ê¸°ë¡ë§Œ)
        const recordsByDate = {};
        for (const r of allRecords) {
          if (!recordsByDate[r.date]) {
            recordsByDate[r.date] = {};
          }
          const val = parseFloat(r.value) || 0;
          if (!recordsByDate[r.date][r.discipline] || val > recordsByDate[r.date][r.discipline].value) {
            recordsByDate[r.date][r.discipline] = {
              value: val,
              type: r.type
            };
          }
        }
        
        // ë‚ ì§œ ì •ë ¬ (ìµœì‹ ìˆœ)
        const sortedDates = Object.keys(recordsByDate).sort((a, b) => b.localeCompare(a));
        
        // ì—°ë„ë³„ë¡œ ê·¸ë£¹í•‘
        const recordsByYear = {};
        for (const date of sortedDates) {
          const year = date.substring(0, 4);
          if (!recordsByYear[year]) {
            recordsByYear[year] = [];
          }
          recordsByYear[year].push(date);
        }
        
        let allHtml = '';
        const sortedYears = Object.keys(recordsByYear).sort((a, b) => b - a);
        
        for (const year of sortedYears) {
          const shortYear = year.substring(2); // '2025' -> '25'
          allHtml += `<div style="font-size: 14px; font-weight: 700; color: var(--text-primary); margin: 16px 0 12px 0; padding-bottom: 8px; border-bottom: 2px solid var(--primary);">
            ğŸ“† ${shortYear}ë…„
          </div>`;
          
          for (const date of recordsByYear[year].slice(0, 15)) { // ì—°ë„ë‹¹ ìµœëŒ€ 15ì¼
            const dateRecords = recordsByDate[date];
            const dateFormatted = formatDateCompact(date);
            
            allHtml += `<div style="margin-bottom: 12px; margin-left: 8px;">
              <div style="font-size: 13px; color: var(--text-secondary); font-weight: 500; margin-bottom: 6px;">
                ${dateFormatted}
              </div>
              <div style="display: flex; flex-wrap: wrap; gap: 6px;">`;
            
            for (const [disc, data] of Object.entries(dateRecords)) {
              const val = disc === 'STA' ? data.value + 's' : data.value + 'm';
              const typeColor = data.type === 'ê°œì¸' ? 'var(--warning)' : 'var(--primary)';
              allHtml += `<div style="background: var(--bg); padding: 6px 10px; border-radius: 8px; display: flex; align-items: center; gap: 4px;">
                <span style="font-weight: 500; font-size: 12px;">${disc}</span>
                <span style="color: ${typeColor}; font-weight: 600; font-size: 13px;">${val}</span>
              </div>`;
            }
            
            allHtml += `</div></div>`;
          }
        }
        
        document.getElementById('my-all-records').innerHTML = allHtml || 
          '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>';
        
      } catch (err) {
        console.error('ê¸°ë¡ ë¡œë“œ ì˜¤ë¥˜:', err);
        document.getElementById('my-best-records').innerHTML = 
          '<div style="text-align: center; color: var(--error); padding: 20px;">ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤</div>';
      }
    }
    
    function formatDateShort(dateStr) {
      if (!dateStr || dateStr === 'ë‚ ì§œ ì—†ìŒ') return dateStr;
      const d = new Date(dateStr);
      const month = d.getMonth() + 1;
      const day = d.getDate();
      const weekdays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
      const weekday = weekdays[d.getDay()];
      return `${month}ì›” ${day}ì¼ (${weekday})`;
    }
    
    function formatDateCompact(dateStr) {
      if (!dateStr || dateStr === 'ë‚ ì§œ ì—†ìŒ') return dateStr;
      const d = new Date(dateStr);
      const month = d.getMonth() + 1;
      const day = d.getDate();
      const weekdays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
      const weekday = weekdays[d.getDay()];
      return `${month}/${day} (${weekday})`;
    }

    // ==================== ì„ì‹œ í•¨ìˆ˜ë“¤ ====================
    function quickRecordInput() {
      // ê°œì¸ ê¸°ë¡ ì…ë ¥ í™”ë©´ìœ¼ë¡œ ì´ë™
      document.getElementById('personal-date').value = new Date().toISOString().split('T')[0];
      document.getElementById('personal-location').value = '';
      currentPersonalDiscipline = 'STA';
      personalAttempts = [{ value: '', note: '' }];
      renderPersonalAttempts();
      updatePersonalDisciplineUI();
      showScreen('screen-personal-record');
    }

    // ==================== ê°•ìŠµ ê¸°ë¡ ì…ë ¥ (í‘œ í˜•íƒœ) ====================
    let batchParticipants = [];
    let currentBatchDiscipline = 'STA';
    let batchDisciplines = ['STA', 'DYNB', 'FIM', 'CWTB']; // ì„ íƒëœ ì¢…ëª©ë“¤
    let batchSkillItems = []; // ìŠ¤í‚¬ í•­ëª©ë“¤ (ê°•ìŠµ ë ˆë²¨ì— ë”°ë¼)
    let batchAttemptCount = 2;
    let batchRecords = {};
    let batchSkills = {};
    let currentBatchScheduleId = null;
    
    // ì›ë³¸ ë°ì´í„° (ë³€ê²½ ê°ì§€ìš©)
    let batchOriginalRecords = {};
    let batchOriginalSkills = {};
    let batchOriginalScheduleNote = '';
    let batchOriginalStudentNotes = {};

    // ì§„ì…ì  1: í™ˆ â†’ ìµœê·¼ ê°•ìŠµ ê¸°ë¡ ì…ë ¥
    async function quickRecordInput() {
      if (currentUser.user_type !== 'ê°•ì‚¬') {
        openPersonalRecordAdd();
        return;
      }
      
      try {
        const { data: schedules, error } = await db
          .from('schedules')
          .select('schedule_id, date, time, location')
          .eq('instructor_id', currentUser.user_id)
          .order('date', { ascending: false })
          .limit(5);
        
        if (error) throw error;
        
        if (!schedules || schedules.length === 0) {
          showToast('ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤');
          return;
        }
        
        let html = '';
        for (const s of schedules) {
          html += `<div class="schedule-select-item" onclick="openLessonRecordInput('${s.schedule_id}'); closeBottomSheet('sheet-select-schedule');">
            <div style="font-weight: 600;">${formatDate(s.date)} ${formatTime(s.time)}</div>
            <div style="color: var(--text-secondary); font-size: 14px;">${s.location}</div>
          </div>`;
        }
        document.getElementById('recent-schedule-list').innerHTML = html;
        openBottomSheet('sheet-select-schedule');
      } catch (err) {
        console.error('ì¼ì • ë¡œë“œ ì˜¤ë¥˜:', err);
        showToast('ì¼ì •ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤');
      }
    }

    // ì§„ì…ì  2: ì¼ì • ì¹´ë“œ â†’ ê¸°ë¡ ì…ë ¥
    async function openLessonRecordInput(scheduleId) {
      currentBatchScheduleId = scheduleId;
      
      try {
        const { data: schedule } = await db
          .from('schedules')
          .select('*')
          .eq('schedule_id', scheduleId)
          .single();
        
        if (schedule) {
          document.getElementById('batch-schedule-date').textContent = formatDate(schedule.date) + ' ' + formatTime(schedule.time);
          document.getElementById('batch-schedule-location').textContent = schedule.location;
          
          // ì¼ì •ì— ì €ì¥ëœ ì¢…ëª© ì •ë³´ ì‚¬ìš© (ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´)
          batchDisciplines = schedule.common_disciplines ? schedule.common_disciplines.split(',') : [];
          
          // ìŠ¤í‚¬ ì¢…ëª© (ì˜ì–´â†’í•œêµ­ì–´ ë³€í™˜)
          if (schedule.common_skill_disciplines) {
            batchSkillItems = schedule.common_skill_disciplines.split(',').map(s => toKoreanSkillName(s));
          } else {
            batchSkillItems = [];
          }
          
          // ì¼ì • ì´í‰ ë…¸íŠ¸ ë¡œë“œ
          document.getElementById('batch-schedule-note').value = schedule.note || '';
          batchOriginalScheduleNote = schedule.note || '';
        } else {
          batchDisciplines = [];
          batchSkillItems = [];
          document.getElementById('batch-schedule-note').value = '';
          batchOriginalScheduleNote = '';
        }
        
        const { data: regs, error } = await db
          .from('registrations')
          .select(`
            reg_id,
            student_id,
            purpose,
            lesson_level,
            note_instructor,
            users!registrations_student_id_fkey (name, cert_level)
          `)
          .eq('schedule_id', scheduleId);
        
        if (error) throw error;
        
        if (!regs || regs.length === 0) {
          showToast('ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤');
          return;
        }
        
        batchParticipants = regs.map(r => ({
          reg_id: r.reg_id,
          student_id: r.student_id,
          name: r.users?.name || 'ì•Œ ìˆ˜ ì—†ìŒ',
          purpose: r.purpose,
          lesson_level: r.lesson_level,
          note_instructor: r.note_instructor || ''
        }));
        
        // í•™ìƒë³„ í”¼ë“œë°± ì›ë³¸ ì €ì¥
        batchOriginalStudentNotes = {};
        for (const p of batchParticipants) {
          batchOriginalStudentNotes[p.reg_id] = p.note_instructor || '';
        }
        
        // ì´ˆê¸°í™”
        batchRecords = {};
        batchSkills = {};
        batchOriginalRecords = {};
        batchOriginalSkills = {};
        batchAttemptCount = 2;
        currentBatchDiscipline = batchDisciplines.length > 0 ? batchDisciplines[0] : 'STA';
        
        for (const p of batchParticipants) {
          batchRecords[p.reg_id] = {};
          batchSkills[p.reg_id] = {};
        }
        
        // ê¸°ì¡´ ê¸°ë¡ ë¡œë“œ
        await loadExistingBatchRecords();
        
        renderBatchDisciplineTabs();
        renderBatchSelectedDisciplines();
        renderBatchTable();
        renderBatchStudentNotes();
        
        showScreen('screen-batch-record');
      } catch (err) {
        console.error('ê¸°ë¡ ì…ë ¥ ì˜¤ë¥˜:', err);
        showToast('ì°¸ê°€ì ë¡œë“œ ì‹¤íŒ¨');
      }
    }
    
    // í•™ìƒë³„ í”¼ë“œë°± ì…ë ¥ë€ ë Œë”ë§
    function renderBatchStudentNotes() {
      let html = '';
      for (const p of batchParticipants) {
        html += `
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
            <span style="min-width: 60px; font-size: 14px; color: var(--text-secondary);">${p.name}</span>
            <input type="text" class="input" style="flex: 1; padding: 10px 12px;" 
              id="batch-note-${p.reg_id}" 
              value="${p.note_instructor || ''}" 
              placeholder="í”¼ë“œë°± ì…ë ¥">
          </div>
        `;
      }
      document.getElementById('batch-student-notes').innerHTML = html;
    }

    // ìŠ¤í‚¬ ì¢…ëª© ì˜ì–´â†”í•œêµ­ì–´ ë§¤í•‘
    const SKILL_NAME_MAP = {
      // ì˜ì–´ â†’ í•œêµ­ì–´ (DBì—ì„œ ì½ì–´ì˜¬ ë•Œ)
      'neutral_buoyancy': 'ì¤‘ì„±ë¶€ë ¥',
      'freefall': 'í”„ë¦¬í´',
      'arms_only_15m': 'ì•”ìŠ¤ì˜¨ë¦¬ 15m',
      'buddy_10_15m': 'ë²„ë”” 10-15m',
      'lanyard_remove': 'ë Œì•¼ë“œ ì œê±°',
      'no_mask_10m': 'ë…¸ë§ˆìŠ¤í¬ 10m',
      'rescue_towing': 'ë ˆìŠ¤í+í† ì‰',
      'theory_test': 'ì´ë¡  í‰ê°€',
      'rescue_5_10m': 'ë ˆìŠ¤í 5-10m',
      'theory_test_lv2': 'ì´ë¡  í‰ê°€',
      // í•œêµ­ì–´ â†’ ì˜ì–´ (DBì— ì €ì¥í•  ë•Œ)
      'ì¤‘ì„±ë¶€ë ¥': 'neutral_buoyancy',
      'í”„ë¦¬í´': 'freefall',
      'ì•”ìŠ¤ì˜¨ë¦¬ 15m': 'arms_only_15m',
      'ë²„ë”” 10-15m': 'buddy_10_15m',
      'ë Œì•¼ë“œ ì œê±°': 'lanyard_remove',
      'ë…¸ë§ˆìŠ¤í¬ 10m': 'no_mask_10m',
      'ë ˆìŠ¤í+í† ì‰': 'rescue_towing',
      'ì´ë¡  í‰ê°€': 'theory_test',
      'ë ˆìŠ¤í 5-10m': 'rescue_5_10m'
    };

    // ìŠ¤í‚¬ëª…ì„ í•œêµ­ì–´ë¡œ ë³€í™˜
    function toKoreanSkillName(name) {
      return SKILL_NAME_MAP[name] || name;
    }

    // ìŠ¤í‚¬ëª…ì„ ì˜ì–´ë¡œ ë³€í™˜ (DB ì €ì¥ìš©)
    function toEnglishSkillName(name) {
      return SKILL_NAME_MAP[name] || name;
    }

    // ê¸°ì¡´ ê¸°ë¡ ë¡œë“œ
    async function loadExistingBatchRecords() {
      const regIds = batchParticipants.map(p => p.reg_id);
      
      try {
        // ë‹¤ì´ë¸Œ ê¸°ë¡ ë¡œë“œ
        const { data: diveRecords } = await db
          .from('dive_records')
          .select('*')
          .in('reg_id', regIds);
        
        if (diveRecords) {
          for (const r of diveRecords) {
            if (!batchRecords[r.reg_id]) batchRecords[r.reg_id] = {};
            if (!batchRecords[r.reg_id][r.discipline]) {
              batchRecords[r.reg_id][r.discipline] = { attempts: [], note: '', recordIds: [] };
            }
            
            const attemptIdx = (r.attempt || 1) - 1;
            const valStr = r.value?.toString() || '';
            batchRecords[r.reg_id][r.discipline].attempts[attemptIdx] = valStr;
            // record_id ì €ì¥ (ì´ë¯¸ ì €ì¥ëœ ê¸°ë¡ í‘œì‹œ)
            batchRecords[r.reg_id][r.discipline].recordIds[attemptIdx] = r.record_id;
            if (r.note) {
              batchRecords[r.reg_id][r.discipline].note = r.note;
            }
            
            // ì‹œë„ ìˆ˜ ì—…ë°ì´íŠ¸
            if (r.attempt > batchAttemptCount) {
              batchAttemptCount = r.attempt;
            }
            
            // ì¢…ëª© ì¶”ê°€
            if (!batchDisciplines.includes(r.discipline)) {
              batchDisciplines.push(r.discipline);
            }
          }
        }
        
        // ìŠ¤í‚¬ ê¸°ë¡ ë¡œë“œ (ì‹œë„ë³„ë¡œ)
        const { data: skillRecords } = await db
          .from('skill_records')
          .select('*')
          .in('reg_id', regIds);
        
        if (skillRecords) {
          for (const r of skillRecords) {
            if (!batchSkills[r.reg_id]) batchSkills[r.reg_id] = {};
            
            // í•œêµ­ì–´ë¡œ ë³€í™˜
            const koreanName = toKoreanSkillName(r.discipline);
            
            if (!batchSkills[r.reg_id][koreanName]) {
              batchSkills[r.reg_id][koreanName] = { attempts: [], recordIds: [] };
            }
            
            const attemptIdx = (r.attempt || 1) - 1;
            const result = r.result === 'Y' ? 'Y' : 'N';
            batchSkills[r.reg_id][koreanName].attempts[attemptIdx] = result;
            batchSkills[r.reg_id][koreanName].recordIds[attemptIdx] = r.record_id;
            
            // ìŠ¤í‚¬ ì¢…ëª© ì¶”ê°€ (í•œêµ­ì–´ë¡œ)
            if (!batchSkillItems.includes(koreanName)) {
              batchSkillItems.push(koreanName);
            }
            
            // ìŠ¤í‚¬ ì‹œë„ ìˆ˜ ì—…ë°ì´íŠ¸
            if (r.attempt > batchAttemptCount) {
              batchAttemptCount = r.attempt;
            }
          }
        }
        
        // ì›ë³¸ ë°ì´í„° ê¹Šì€ ë³µì‚¬ (ë³€ê²½ ê°ì§€ìš©)
        batchOriginalRecords = JSON.parse(JSON.stringify(batchRecords));
        batchOriginalSkills = JSON.parse(JSON.stringify(batchSkills));
        
      } catch (err) {
        console.error('ê¸°ì¡´ ê¸°ë¡ ë¡œë“œ ì˜¤ë¥˜:', err);
      }
    }

    function renderBatchDisciplineTabs() {
      // Lv2, Lv3 ìŠ¤í‚¬ ë¶„ë¥˜
      const lv2SkillNames = ['ë ˆìŠ¤í 5-10m', 'ì´ë¡  í‰ê°€'];
      const lv3SkillNames = ['ë Œì•¼ë“œ ì œê±°', 'ë…¸ë§ˆìŠ¤í¬ 10m', 'ë ˆìŠ¤í+í† ì‰', 'ì¤‘ì„±ë¶€ë ¥', 'í”„ë¦¬í´', 'ì•”ìŠ¤ì˜¨ë¦¬ 15m', 'ë²„ë”” 10-15m'];
      
      const lv2Skills = batchSkillItems.filter(sk => lv2SkillNames.includes(sk));
      let lv3Skills = batchSkillItems.filter(sk => lv3SkillNames.includes(sk));
      // ì´ë¡  í‰ê°€ ì²˜ë¦¬ (Lv2ì— ì—†ìœ¼ë©´ Lv3ì— ì¶”ê°€)
      if (batchSkillItems.includes('ì´ë¡  í‰ê°€') && !lv2Skills.includes('ì´ë¡  í‰ê°€')) {
        lv3Skills.push('ì´ë¡  í‰ê°€');
      }
      
      let html = '<div style="display: flex; flex-wrap: wrap; gap: 6px;">';
      
      // ê¸°ë¡ ì¢…ëª©
      for (const disc of batchDisciplines) {
        const active = disc === currentBatchDiscipline ? 'active' : '';
        html += `<button class="batch-disc-tag ${active}" onclick="selectBatchDiscipline('${disc}')">${disc}</button>`;
      }
      
      // Lv3 ìŠ¤í‚¬ ë¨¼ì €
      for (const skill of lv3Skills) {
        const active = currentBatchDiscipline === skill ? 'active' : '';
        html += `<button class="batch-skill-tag lv3 ${active}" onclick="selectBatchDiscipline('${skill}')">${skill}</button>`;
      }
      
      // Lv2 ìŠ¤í‚¬
      for (const skill of lv2Skills) {
        const active = currentBatchDiscipline === skill ? 'active' : '';
        html += `<button class="batch-skill-tag lv2 ${active}" onclick="selectBatchDiscipline('${skill}')">${skill}</button>`;
      }
      
      html += '</div>';
      document.getElementById('batch-discipline-tabs').innerHTML = html;
    }

    function renderBatchSelectedDisciplines() {
      // ìƒë‹¨ ì¹´ë“œì—ì„œ ì¢…ëª© í‘œì‹œ ì œê±°ë¨ - ì´ì œ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
    }

    function openBatchAddDisciplineSheet() {
      const allDiscs = ['STA', 'DYNB', 'FIM', 'CWTB', 'DNF', 'CNF', 'DYN', 'CWT'];
      const allSkills = {
        'Lv2': ['ë ˆìŠ¤í 5-10m', 'ì´ë¡  í‰ê°€'],
        'Lv3': ['ë Œì•¼ë“œ ì œê±°', 'ë…¸ë§ˆìŠ¤í¬ 10m', 'ë ˆìŠ¤í+í† ì‰', 'ì¤‘ì„±ë¶€ë ¥', 'í”„ë¦¬í´', 'ì•”ìŠ¤ì˜¨ë¦¬ 15m', 'ë²„ë”” 10-15m', 'ì´ë¡  í‰ê°€']
      };
      
      // ì°¸ê°€ìë“¤ì˜ ë ˆìŠ¨ ë ˆë²¨ í™•ì¸
      const lessonLevels = batchParticipants.filter(p => p.purpose === 'ê°•ìŠµ').map(p => p.lesson_level);
      const hasLv2 = lessonLevels.includes(2);
      const hasLv3 = lessonLevels.includes(3);
      
      let html = '<div style="margin-bottom: 20px;">';
      html += '<div style="font-weight: 600; margin-bottom: 12px;">ê¸°ë¡ ì¢…ëª©</div>';
      html += '<div style="display: flex; flex-wrap: wrap; gap: 4px;">';
      
      for (const d of allDiscs) {
        const checked = batchDisciplines.includes(d) ? 'checked' : '';
        html += `<label style="display: inline-flex; align-items: center; gap: 6px; padding: 8px 12px;">
          <input type="checkbox" value="${d}" data-type="disc" ${checked}> ${d}
        </label>`;
      }
      html += '</div></div>';
      
      // ìŠ¤í‚¬ ì¢…ëª©
      if (hasLv2 || hasLv3) {
        html += '<div style="border-top: 1px solid var(--divider); padding-top: 16px;">';
        html += '<div style="font-weight: 600; margin-bottom: 12px;">ìŠ¤í‚¬ ì¢…ëª©</div>';
        
        if (hasLv2) {
          html += '<div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">Lv2</div>';
          html += '<div style="display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 12px;">';
          for (const s of allSkills['Lv2']) {
            const checked = batchSkillItems.includes(s) ? 'checked' : '';
            html += `<label style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px;">
              <input type="checkbox" value="${s}" data-type="skill" ${checked}> ${s}
            </label>`;
          }
          html += '</div>';
        }
        
        if (hasLv3) {
          html += '<div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">Lv3</div>';
          html += '<div style="display: flex; flex-wrap: wrap; gap: 4px;">';
          for (const s of allSkills['Lv3']) {
            const checked = batchSkillItems.includes(s) ? 'checked' : '';
            html += `<label style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px;">
              <input type="checkbox" value="${s}" data-type="skill" ${checked}> ${s}
            </label>`;
          }
          html += '</div>';
        }
        html += '</div>';
      }
      
      document.getElementById('batch-add-discipline-options').innerHTML = html;
      openBottomSheet('sheet-batch-add-discipline');
    }

    function confirmBatchAddDiscipline() {
      const selectedDiscs = [];
      const selectedSkills = [];
      
      document.querySelectorAll('#batch-add-discipline-options input:checked').forEach(cb => {
        if (cb.dataset.type === 'disc') {
          selectedDiscs.push(cb.value);
        } else if (cb.dataset.type === 'skill') {
          selectedSkills.push(cb.value);
        }
      });
      
      if (selectedDiscs.length === 0) {
        showToast('ìµœì†Œ 1ê°œ ê¸°ë¡ ì¢…ëª©ì„ ì„ íƒí•˜ì„¸ìš”');
        return;
      }
      
      batchDisciplines = selectedDiscs;
      batchSkillItems = selectedSkills;
      
      // í˜„ì¬ ì„ íƒëœ ì¢…ëª©ì´ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ ì²« ë²ˆì§¸ë¡œ ë³€ê²½
      const allDisciplines = [...batchDisciplines, ...batchSkillItems];
      if (!allDisciplines.includes(currentBatchDiscipline)) {
        currentBatchDiscipline = batchDisciplines[0] || batchSkillItems[0];
      }
      
      closeBottomSheet('sheet-batch-add-discipline');
      renderBatchDisciplineTabs();
      renderBatchSelectedDisciplines();
      renderBatchTable();
    }

    function closeBatchRecord() {
      if (currentBatchScheduleId) {
        currentScheduleId = currentBatchScheduleId;
        showScreen('screen-schedule-manage');
      } else {
        goBack();
      }
    }

    function selectBatchDiscipline(disc) {
      saveBatchCurrentInput();
      currentBatchDiscipline = disc;
      renderBatchDisciplineTabs();
      renderBatchTable();
    }

    function updateBatchDisciplineUI() {
      renderBatchDisciplineTabs();
      renderBatchTable();
    }

    function renderBatchTable() {
      // ì¢…ëª©ì´ ì—†ìœ¼ë©´ ì•ˆë‚´ ë©”ì‹œì§€
      if (batchDisciplines.length === 0 && batchSkillItems.length === 0) {
        document.getElementById('batch-record-table-card').style.display = 'block';
        document.getElementById('batch-skill-table-card').style.display = 'none';
        document.getElementById('batch-record-tbody').innerHTML = `
          <tr><td colspan="5" style="text-align: center; padding: 40px; color: var(--text-tertiary);">
            ì¢…ëª©ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.<br>+ ìˆ˜ì • ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¢…ëª©ì„ ì¶”ê°€í•˜ì„¸ìš”.
          </td></tr>`;
        document.querySelector('#batch-record-table thead').innerHTML = '<tr><th></th></tr>';
        return;
      }
      
      // ìŠ¤í‚¬ ì¢…ëª©ì¸ì§€ í™•ì¸
      const isSkillDiscipline = batchSkillItems.includes(currentBatchDiscipline);
      
      // ê¸°ë¡ í…Œì´ë¸”ë§Œ ì‚¬ìš© (ìŠ¤í‚¬ í…Œì´ë¸” ìˆ¨ê¹€)
      document.getElementById('batch-record-table-card').style.display = 'block';
      document.getElementById('batch-skill-table-card').style.display = 'none';
      
      // í—¤ë” ë Œë”ë§
      let headerHtml = '<tr><th class="col-name">í•™ìƒëª…</th>';
      for (let i = 1; i <= batchAttemptCount; i++) {
        headerHtml += `<th class="col-attempt">${i}ì°¨</th>`;
      }
      headerHtml += `<th class="col-add-attempt"><button class="btn-add-col" onclick="addBatchAttemptColumn()">+</button></th>`;
      if (!isSkillDiscipline) {
        headerHtml += '<th class="col-note">ë©”ëª¨</th>';
      }
      headerHtml += '</tr>';
      document.querySelector('#batch-record-table thead').innerHTML = headerHtml;
      
      // ë°”ë”” ë Œë”ë§
      let bodyHtml = '';
      for (const p of batchParticipants) {
        // ìŠ¤í‚¬ì´ë©´ ê°•ìŠµìƒë§Œ í‘œì‹œ
        if (isSkillDiscipline && p.purpose !== 'ê°•ìŠµ') continue;
        
        bodyHtml += `<tr data-reg-id="${p.reg_id}">
          <td class="col-name">${p.name}</td>`;
        
        if (isSkillDiscipline) {
          // ìŠ¤í‚¬ ì¢…ëª©: Y/N ë²„íŠ¼
          const skills = batchSkills[p.reg_id]?.[currentBatchDiscipline] || { attempts: [] };
          for (let i = 0; i < batchAttemptCount; i++) {
            const val = skills.attempts[i] || '';
            const successClass = val === 'Y' ? 'success' : '';
            const failClass = val === 'N' ? 'fail' : '';
            bodyHtml += `<td>
              <button class="skill-check-btn ${successClass} ${failClass}" 
                      onclick="toggleSkillAttempt('${p.reg_id}', ${i}, this)"
                      data-attempt="${i}">
                ${val === 'Y' ? 'âœ“' : val === 'N' ? 'âœ—' : '-'}
              </button>
            </td>`;
          }
          bodyHtml += `<td></td></tr>`;
        } else {
          // ê¸°ë¡ ì¢…ëª©: ìˆ«ì ì…ë ¥
          const records = batchRecords[p.reg_id]?.[currentBatchDiscipline] || { attempts: [], note: '' };
          for (let i = 0; i < batchAttemptCount; i++) {
            const val = records.attempts[i] || '';
            bodyHtml += `<td><input type="number" value="${val}" data-attempt="${i}" placeholder="-"></td>`;
          }
          bodyHtml += `<td></td>`;
          bodyHtml += `<td><input type="text" class="note-input" value="${records.note || ''}" data-note="true" placeholder=""></td>
          </tr>`;
        }
      }
      
      document.getElementById('batch-record-tbody').innerHTML = bodyHtml;
    }
    
    // ìŠ¤í‚¬ ì‹œë„ í† ê¸€ (Y â†’ N â†’ ë¹ˆê°’ ìˆœí™˜)
    function toggleSkillAttempt(regId, attemptIdx, btn) {
      if (!batchSkills[regId]) batchSkills[regId] = {};
      if (!batchSkills[regId][currentBatchDiscipline]) {
        batchSkills[regId][currentBatchDiscipline] = { attempts: [], recordIds: [] };
      }
      
      const current = batchSkills[regId][currentBatchDiscipline].attempts[attemptIdx] || '';
      let next = '';
      
      if (current === '') next = 'Y';
      else if (current === 'Y') next = 'N';
      else next = '';
      
      batchSkills[regId][currentBatchDiscipline].attempts[attemptIdx] = next;
      
      btn.className = 'skill-check-btn ' + (next === 'Y' ? 'success' : next === 'N' ? 'fail' : '');
      btn.textContent = next === 'Y' ? 'âœ“' : next === 'N' ? 'âœ—' : '-';
    }

    function addBatchAttemptColumn() {
      saveBatchCurrentInput();
      batchAttemptCount++;
      renderBatchTable();
    }

    function saveBatchCurrentInput() {
      const isSkillDiscipline = batchSkillItems.includes(currentBatchDiscipline);
      if (isSkillDiscipline) return; // ìŠ¤í‚¬ì€ ë²„íŠ¼ í´ë¦­ ì‹œ ì¦‰ì‹œ ì €ì¥ë¨
      
      const rows = document.querySelectorAll('#batch-record-tbody tr');
      rows.forEach(row => {
        const regId = row.dataset.regId;
        if (!regId) return;
        
        if (!batchRecords[regId]) batchRecords[regId] = {};
        if (!batchRecords[regId][currentBatchDiscipline]) {
          batchRecords[regId][currentBatchDiscipline] = { attempts: [], note: '' };
        }
        
        const inputs = row.querySelectorAll('input');
        const attempts = [];
        let note = '';
        
        inputs.forEach(input => {
          if (input.dataset.note) {
            note = input.value;
          } else if (input.dataset.attempt !== undefined) {
            attempts[parseInt(input.dataset.attempt)] = input.value;
          }
        });
        
        batchRecords[regId][currentBatchDiscipline] = { attempts, note };
      });
    }

    async function saveBatchRecords(finish = false) {
      saveBatchCurrentInput();
      
      try {
        let totalSaved = 0;
        let totalUpdated = 0;
        let totalDeleted = 0;
        
        // ===== ë‹¤ì´ë¸Œ ê¸°ë¡ ì²˜ë¦¬ =====
        for (const regId of Object.keys(batchRecords)) {
          for (const discipline of Object.keys(batchRecords[regId])) {
            const data = batchRecords[regId][discipline];
            const originalData = batchOriginalRecords[regId]?.[discipline] || { attempts: [], recordIds: [] };
            
            for (let i = 0; i < Math.max(data.attempts.length, originalData.attempts.length); i++) {
              const newVal = data.attempts[i] || '';
              const oldVal = originalData.attempts[i] || '';
              const existingRecordId = originalData.recordIds?.[i];
              
              // ê°’ì´ ì—†ì–´ì§„ ê²½ìš° (ì‚­ì œ)
              if (oldVal && !newVal && existingRecordId) {
                await db.from('dive_records').delete().eq('record_id', existingRecordId);
                totalDeleted++;
              }
              // ìƒˆë¡œìš´ ê°’ (ì¶”ê°€)
              else if (newVal && !existingRecordId) {
                const recordId = 'DR_' + regId + '_' + discipline + '_' + Date.now() + '_' + i + '_' + Math.random().toString(36).substr(2, 5);
                await db.from('dive_records').insert({
                  record_id: recordId,
                  reg_id: regId,
                  discipline: discipline,
                  attempt: i + 1,
                  value: parseFloat(newVal),
                  note: i === 0 ? data.note : null
                });
                totalSaved++;
              }
              // ê°’ì´ ë³€ê²½ëœ ê²½ìš° (ì—…ë°ì´íŠ¸)
              else if (newVal && existingRecordId && newVal !== oldVal) {
                await db.from('dive_records').update({
                  value: parseFloat(newVal),
                  note: i === 0 ? data.note : null
                }).eq('record_id', existingRecordId);
                totalUpdated++;
              }
              // ë…¸íŠ¸ë§Œ ë³€ê²½ëœ ê²½ìš°
              else if (i === 0 && newVal && existingRecordId && data.note !== originalData.note) {
                await db.from('dive_records').update({ note: data.note || null }).eq('record_id', existingRecordId);
                totalUpdated++;
              }
            }
          }
        }
        
        // ===== ìŠ¤í‚¬ ê¸°ë¡ ì²˜ë¦¬ =====
        for (const regId of Object.keys(batchSkills)) {
          for (const skillName of Object.keys(batchSkills[regId])) {
            const data = batchSkills[regId][skillName];
            if (!data || !data.attempts) continue;
            
            const originalData = batchOriginalSkills[regId]?.[skillName] || { attempts: [], recordIds: [] };
            const englishName = toEnglishSkillName(skillName);
            
            for (let i = 0; i < Math.max(data.attempts.length, originalData.attempts.length); i++) {
              const newVal = data.attempts[i] || '';
              const oldVal = originalData.attempts[i] || '';
              const existingRecordId = originalData.recordIds?.[i];
              
              // ê°’ì´ ì—†ì–´ì§„ ê²½ìš° (ì‚­ì œ)
              if (oldVal && !newVal && existingRecordId) {
                await db.from('skill_records').delete().eq('record_id', existingRecordId);
                totalDeleted++;
              }
              // ìƒˆë¡œìš´ ê°’ (ì¶”ê°€)
              else if (newVal && !existingRecordId) {
                const recordId = 'SR_' + regId + '_' + Date.now() + '_' + i + '_' + Math.random().toString(36).substr(2, 5);
                await db.from('skill_records').insert({
                  record_id: recordId,
                  reg_id: regId,
                  discipline: englishName,
                  attempt: i + 1,
                  result: newVal === 'Y' ? 'Y' : 'N',
                  note: null
                });
                totalSaved++;
              }
              // ê°’ì´ ë³€ê²½ëœ ê²½ìš° (ì—…ë°ì´íŠ¸)
              else if (newVal && existingRecordId && newVal !== oldVal) {
                await db.from('skill_records').update({
                  result: newVal === 'Y' ? 'Y' : 'N'
                }).eq('record_id', existingRecordId);
                totalUpdated++;
              }
            }
          }
        }
        
        // ===== ë…¸íŠ¸ ì²˜ë¦¬ (ë³€ê²½ëœ ê²½ìš°ë§Œ) =====
        const scheduleNote = document.getElementById('batch-schedule-note').value.trim();
        if (scheduleNote !== batchOriginalScheduleNote) {
          await db.from('schedules').update({ note: scheduleNote || null }).eq('schedule_id', currentBatchScheduleId);
        }
        
        for (const p of batchParticipants) {
          const noteInput = document.getElementById(`batch-note-${p.reg_id}`);
          const noteValue = noteInput ? noteInput.value.trim() : '';
          const originalNote = batchOriginalStudentNotes[p.reg_id] || '';
          
          if (noteValue !== originalNote) {
            await db.from('registrations').update({ note_instructor: noteValue || null }).eq('reg_id', p.reg_id);
          }
        }
        
        // Users Best ê¸°ë¡ ì—…ë°ì´íŠ¸ (ë³€ê²½ì´ ìˆì„ ë•Œë§Œ)
        if (totalSaved > 0 || totalUpdated > 0 || totalDeleted > 0) {
          await updateUsersBestRecords();
          await updateLvProgress();
        }
        
        const totalChanges = totalSaved + totalUpdated + totalDeleted;
        if (totalChanges > 0) {
          showToast(`ì €ì¥ ì™„ë£Œ (ì¶”ê°€: ${totalSaved}, ìˆ˜ì •: ${totalUpdated}, ì‚­ì œ: ${totalDeleted})`);
        } else {
          showToast('ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤');
        }
        
        if (finish) {
          closeBatchRecord();
        } else {
          // DBì—ì„œ ë‹¤ì‹œ ë¡œë“œí•´ì„œ UI ê°±ì‹ 
          batchRecords = {};
          batchSkills = {};
          for (const p of batchParticipants) {
            batchRecords[p.reg_id] = {};
            batchSkills[p.reg_id] = {};
          }
          await loadExistingBatchRecords();
          renderBatchTable();
        }
      } catch (err) {
        console.error('ì €ì¥ ì˜¤ë¥˜:', err);
        showToast('ì €ì¥ ì‹¤íŒ¨: ' + err.message);
      }
    }
    
    // Users Best ê¸°ë¡ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ëª¨ë“  í•™ìƒ ëŒ€ìƒ)
    async function updateUsersBestRecords() {
      try {
        const studentIds = [...new Set(batchParticipants.map(p => p.student_id))];
        
        const { data: students } = await db
          .from('users')
          .select('user_id, best_sta, best_dynb, best_fim, best_cwtb')
          .in('user_id', studentIds);
        
        if (!students) return;
        
        for (const student of students) {
          const participant = batchParticipants.find(p => p.student_id === student.user_id);
          if (!participant) continue;
          
          const regId = participant.reg_id;
          const diveRecords = batchRecords[regId] || {};
          
          const updates = {};
          for (const disc of ['STA', 'DYNB', 'FIM', 'CWTB']) {
            const data = diveRecords[disc];
            if (!data || !data.attempts) continue;
            
            const maxValue = Math.max(...data.attempts.filter(v => v && v !== '').map(v => parseFloat(v)));
            if (isNaN(maxValue) || maxValue <= 0) continue;
            
            const bestKey = 'best_' + disc.toLowerCase();
            const currentBest = student[bestKey] || 0;
            
            if (maxValue > currentBest) {
              updates[bestKey] = maxValue;
            }
          }
          
          if (Object.keys(updates).length > 0) {
            await db
              .from('users')
              .update(updates)
              .eq('user_id', student.user_id);
          }
        }
      } catch (err) {
        console.error('Best ê¸°ë¡ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', err);
      }
    }
    
    // LV Progress ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ë ˆë²¨ ê³¼ì • ì¤‘ì¸ í•™ìƒë§Œ)
    async function updateLvProgress() {
      try {
        const studentIds = [...new Set(batchParticipants.map(p => p.student_id))];
        
        const { data: students } = await db
          .from('users')
          .select('user_id, in_training_level')
          .in('user_id', studentIds);
        
        if (!students) return;
        
        for (const student of students) {
          const level = student.in_training_level;
          if (!level || (level !== 2 && level !== 3)) continue;
          
          const participant = batchParticipants.find(p => p.student_id === student.user_id);
          if (!participant) continue;
          
          const regId = participant.reg_id;
          const tableName = level === 2 ? 'lv2_progress' : 'lv3_progress';
          const req = LEVEL_REQUIREMENTS[level];
          
          // í˜„ì¬ ì§„ë„ ì¡°íšŒ
          let { data: progress } = await db
            .from(tableName)
            .select('*')
            .eq('user_id', student.user_id)
            .single();
          
          // ì§„ë„ ë ˆì½”ë“œê°€ ì—†ìœ¼ë©´ ìƒì„±
          if (!progress) {
            const { data: newProgress } = await db
              .from(tableName)
              .insert({ user_id: student.user_id })
              .select()
              .single();
            progress = newProgress || {};
          }
          
          const updates = {};
          
          // ê¸°ë¡ ì¢…ëª© ì—…ë°ì´íŠ¸ (STA, DYNB, FIM, CWTB)
          const diveRecords = batchRecords[regId] || {};
          for (const disc of ['STA', 'DYNB', 'FIM', 'CWTB']) {
            const data = diveRecords[disc];
            if (!data || !data.attempts) continue;
            
            const maxValue = Math.max(...data.attempts.filter(v => v && v !== '').map(v => parseFloat(v)));
            if (isNaN(maxValue) || maxValue <= 0) continue;
            
            const key = disc.toLowerCase();
            const currentValue = progress[key] || 0;
            
            if (maxValue > currentValue) {
              updates[key] = maxValue;
            }
          }
          
          // ìŠ¤í‚¬ ì¢…ëª© ì—…ë°ì´íŠ¸
          const skillRecords = batchSkills[regId] || {};
          for (const skill of req.skills) {
            const koreanName = toKoreanSkillName(skill.key);
            const skillData = skillRecords[koreanName];
            
            if (!skillData || !skillData.attempts) continue;
            
            // ì‹œë„ íšŸìˆ˜ ê³„ì‚° (Y ë˜ëŠ” Nì´ ìˆëŠ” ì‹œë„ë§Œ)
            const attemptCount = skillData.attempts.filter(v => v === 'Y' || v === 'N').length;
            if (attemptCount > 0) {
              const attemptKey = skill.key + '_attempts';
              const currentAttempts = progress[attemptKey] || 0;
              updates[attemptKey] = currentAttempts + attemptCount;
            }
            
            // ì„±ê³µì´ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ Yë¡œ ì—…ë°ì´íŠ¸
            const hasSuccess = skillData.attempts.some(v => v === 'Y');
            if (hasSuccess && progress[skill.key] !== 'Y') {
              updates[skill.key] = 'Y';
            }
          }
          
          // ê°•ìŠµ íšŸìˆ˜ ì—…ë°ì´íŠ¸ (ê°•ìŠµ ëª©ì ì¸ ê²½ìš°ë§Œ)
          if (participant.purpose === 'ê°•ìŠµ') {
            const currentLessonCount = progress.lesson_count || 0;
            updates.lesson_count = currentLessonCount + 1;
          }
          
          if (Object.keys(updates).length > 0) {
            await db
              .from(tableName)
              .update(updates)
              .eq('user_id', student.user_id);
          }
        }
      } catch (err) {
        console.error('LV Progress ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', err);
      }
    }

    // ==================== ê°œì¸ ê¸°ë¡ ì…ë ¥ ====================
    let personalDate = '';
    let personalTime = '';
    let personalLocation = '';
    let personalDisciplines = ['STA', 'DYNB', 'FIM', 'CWTB'];
    let personalAttemptCount = 2;
    let personalRecords = {}; // { discipline: [val1, val2, ...] }
    let personalMemo = '';

    // ê°œë³„ ì¶”ê°€ ì§„ì…ì 
    function openPersonalRecordAdd() {
      document.getElementById('personal-add-date').value = new Date().toISOString().split('T')[0];
      document.getElementById('personal-add-time').value = '';
      document.getElementById('personal-add-location').value = '';
      
      // ì²´í¬ë°•ìŠ¤ ì´ˆê¸°í™”
      document.querySelectorAll('#personal-discipline-checks input').forEach(cb => {
        cb.checked = ['STA', 'DYNB', 'FIM', 'CWTB'].includes(cb.value);
      });
      
      openBottomSheet('sheet-personal-add');
    }

    function startPersonalRecordInput() {
      personalDate = document.getElementById('personal-add-date').value;
      personalTime = document.getElementById('personal-add-time').value;
      personalLocation = document.getElementById('personal-add-location').value;
      
      if (!personalDate) {
        showToast('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”');
        return;
      }
      
      // ì„ íƒëœ ì¢…ëª©
      personalDisciplines = [];
      document.querySelectorAll('#personal-discipline-checks input:checked').forEach(cb => {
        personalDisciplines.push(cb.value);
      });
      
      if (personalDisciplines.length === 0) {
        showToast('ì¢…ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
        return;
      }
      
      // ì´ˆê¸°í™”
      personalAttemptCount = 2;
      personalRecords = {};
      for (const d of personalDisciplines) {
        personalRecords[d] = [];
      }
      personalMemo = '';
      
      closeBottomSheet('sheet-personal-add');
      renderPersonalRecordScreen();
      showScreen('screen-personal-record');
    }

    function renderPersonalRecordScreen() {
      // ë‚ ì§œ/ì¥ì†Œ í‘œì‹œ
      document.getElementById('personal-date-display').textContent = formatDate(personalDate) + (personalTime ? ' ' + formatTime(personalTime) : '');
      document.getElementById('personal-location-display').textContent = personalLocation || 'ì¥ì†Œ ë¯¸ì…ë ¥';
      
      // í…Œì´ë¸” í—¤ë”
      let headerHtml = '<tr><th class="col-name">ì¢…ëª©</th>';
      for (let i = 1; i <= personalAttemptCount; i++) {
        headerHtml += `<th class="col-attempt">${i}ì°¨</th>`;
      }
      headerHtml += '</tr>';
      document.querySelector('#personal-record-table thead').innerHTML = headerHtml;
      
      // í…Œì´ë¸” ë°”ë””
      let bodyHtml = '';
      for (const disc of personalDisciplines) {
        const records = personalRecords[disc] || [];
        
        bodyHtml += `<tr data-disc="${disc}">
          <td class="col-name">${disc}</td>`;
        
        for (let i = 0; i < personalAttemptCount; i++) {
          const val = records[i] || '';
          bodyHtml += `<td><input type="number" value="${val}" data-attempt="${i}" placeholder="-"></td>`;
        }
        
        bodyHtml += '</tr>';
      }
      
      document.getElementById('personal-record-tbody').innerHTML = bodyHtml;
      document.getElementById('personal-memo').value = personalMemo;
    }

    function addPersonalAttemptColumn() {
      savePersonalCurrentInput();
      personalAttemptCount++;
      renderPersonalRecordScreen();
    }

    function openAddDisciplineSheet() {
      const allDiscs = ['STA', 'DYNB', 'FIM', 'CWTB', 'DNF', 'CNF', 'DYN', 'CWT'];
      let html = '';
      
      for (const d of allDiscs) {
        const checked = personalDisciplines.includes(d) ? 'checked disabled' : '';
        html += `<label style="display: flex; align-items: center; gap: 8px; padding: 8px;">
          <input type="checkbox" value="${d}" ${checked}> ${d}
        </label>`;
      }
      
      document.getElementById('add-discipline-options').innerHTML = html;
      openBottomSheet('sheet-add-discipline');
    }

    function confirmAddDiscipline() {
      document.querySelectorAll('#add-discipline-options input:checked:not(:disabled)').forEach(cb => {
        if (!personalDisciplines.includes(cb.value)) {
          personalDisciplines.push(cb.value);
          personalRecords[cb.value] = [];
        }
      });
      
      closeBottomSheet('sheet-add-discipline');
      renderPersonalRecordScreen();
    }

    function openPersonalDateEdit() {
      const newDate = prompt('ë‚ ì§œ (YYYY-MM-DD):', personalDate);
      if (newDate) {
        personalDate = newDate;
        renderPersonalRecordScreen();
      }
    }

    function savePersonalCurrentInput() {
      const rows = document.querySelectorAll('#personal-record-tbody tr');
      rows.forEach(row => {
        const disc = row.dataset.disc;
        if (!disc) return;
        
        const inputs = row.querySelectorAll('input');
        const attempts = [];
        
        inputs.forEach(input => {
          if (input.dataset.attempt !== undefined) {
            attempts[parseInt(input.dataset.attempt)] = input.value;
          }
        });
        
        personalRecords[disc] = attempts;
      });
      
      personalMemo = document.getElementById('personal-memo')?.value || '';
    }

    async function savePersonalRecord(finish = false) {
      savePersonalCurrentInput();
      personalMemo = document.getElementById('personal-memo').value.trim();
      
      try {
        const personalScheduleId = 'PS_' + currentUser.user_id + '_' + Date.now();
        
        const { error: scheduleError } = await db
          .from('personal_schedules')
          .insert({
            personal_schedule_id: personalScheduleId,
            date: personalDate,
            time: personalTime || null,
            location: personalLocation || null,
            common_disciplines: personalDisciplines.join(','),
            note: personalMemo || null
          });
        
        if (scheduleError) throw scheduleError;
        
        let totalSaved = 0;
        
        for (const disc of Object.keys(personalRecords)) {
          const attempts = personalRecords[disc];
          
          for (let i = 0; i < attempts.length; i++) {
            const val = attempts[i];
            if (!val || val === '') continue;
            
            const recordId = 'PDR_' + currentUser.user_id + '_' + Date.now() + '_' + disc + '_' + i;
            
            const { error } = await db
              .from('personal_dive_records')
              .insert({
                record_id: recordId,
                personal_schedule_id: personalScheduleId,
                user_id: currentUser.user_id,
                discipline: disc,
                attempt: i + 1,
                value: parseFloat(val)
              });
            
            if (!error) totalSaved++;
          }
        }
        
        showToast(`${totalSaved}ê°œ ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤`);
        
        if (finish) {
          showScreen('screen-my-records');
        } else {
          personalRecords = {};
          for (const d of personalDisciplines) {
            personalRecords[d] = [];
          }
          renderPersonalRecordScreen();
        }
      } catch (err) {
        console.error('ê°œì¸ ê¸°ë¡ ì €ì¥ ì˜¤ë¥˜:', err);
        showToast('ì €ì¥ ì‹¤íŒ¨: ' + err.message);
      }
    }

    // ==================== ê°œì¸ ê¸°ë¡ ì¼ê´„ ì¶”ê°€ ====================
    let bulkDates = [];
    let currentBulkDateIndex = 0;
    let bulkRecords = {};
    let bulkDisciplines = ['CWTB', 'FIM'];
    let bulkAttemptCount = 2;

    function openPersonalBulkAdd() {
      bulkDates = [{ date: '', location: '' }];
      bulkRecords = {};
      bulkDisciplines = ['CWTB', 'FIM'];
      bulkAttemptCount = 2;
      renderBulkDateList();
      renderBulkTabbar();
      showScreen('screen-personal-bulk');
    }

    function renderBulkTabbar() {
      const isInstructor = currentUser.user_type === 'ê°•ì‚¬';
      const html = `
        <button class="tab-item" onclick="showScreen('${isInstructor ? 'screen-instructor-home' : 'screen-student-home'}')"><i class="fas fa-home"></i><span>í™ˆ</span></button>
        <button class="tab-item" onclick="showScreen('${isInstructor ? 'screen-schedule-manage' : 'screen-student-schedule'}')"><i class="fas fa-calendar"></i><span>ì¼ì •</span></button>
        <button class="tab-item active"><i class="fas fa-chart-line"></i><span>ë‚´ê¸°ë¡</span></button>
        <button class="tab-item" onclick="showScreen('screen-mypage')"><i class="fas fa-user"></i><span>ë§ˆì´</span></button>
      `;
      const tabbar1 = document.getElementById('bulk-tabbar');
      const tabbar2 = document.getElementById('bulk-input-tabbar');
      if (tabbar1) tabbar1.innerHTML = html;
      if (tabbar2) tabbar2.innerHTML = html;
    }

    function renderBulkDateList() {
      let html = '';
      bulkDates.forEach((d, idx) => {
        html += `<div class="card" style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px; padding: 12px;">
          <input type="text" class="input" style="flex: 0.4;" placeholder="YYMMDD" value="${d.date}" 
                 onchange="bulkDates[${idx}].date = this.value">
          <input type="text" class="input" style="flex: 0.6;" placeholder="ì¥ì†Œ" value="${d.location}"
                 onchange="bulkDates[${idx}].location = this.value">
          ${bulkDates.length > 1 ? `<button class="attempt-delete" onclick="removeBulkDateRow(${idx})"><i class="fas fa-times"></i></button>` : ''}
        </div>`;
      });
      document.getElementById('bulk-date-list').innerHTML = html;
    }

    function addBulkDateRow() {
      bulkDates.push({ date: '', location: '' });
      renderBulkDateList();
    }

    function removeBulkDateRow(idx) {
      bulkDates.splice(idx, 1);
      renderBulkDateList();
    }

    function proceedToBulkRecordInput() {
      bulkDates = bulkDates.filter(d => d.date && d.date.length === 6);
      
      if (bulkDates.length === 0) {
        showToast('ë‚ ì§œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” (YYMMDD í˜•ì‹)');
        return;
      }
      
      currentBulkDateIndex = 0;
      bulkRecords = {};
      bulkAttemptCount = 2;
      
      for (let i = 0; i < bulkDates.length; i++) {
        bulkRecords[i] = {};
        for (const d of bulkDisciplines) {
          bulkRecords[i][d] = [];
        }
      }
      
      renderBulkDateTabs();
      renderBulkRecordTable();
      renderBulkTabbar();
      showScreen('screen-personal-bulk-input');
    }

    function renderBulkDateTabs() {
      let html = '';
      bulkDates.forEach((d, idx) => {
        const label = d.date.substring(0, 2) + '-' + d.date.substring(2, 4) + '-' + d.date.substring(4, 6) + ' ' + (d.location || '');
        const active = idx === currentBulkDateIndex ? 'active' : '';
        html += `<button class="participant-tab ${active}" onclick="selectBulkDate(${idx})">${label}</button>`;
      });
      document.getElementById('bulk-date-tabs').innerHTML = html;
    }

    function selectBulkDate(idx) {
      saveBulkCurrentInput();
      currentBulkDateIndex = idx;
      renderBulkDateTabs();
      renderBulkRecordTable();
    }

    function renderBulkRecordTable() {
      // í—¤ë”
      let headerHtml = '<tr><th class="col-name">ì¢…ëª©</th>';
      for (let i = 1; i <= bulkAttemptCount; i++) {
        headerHtml += `<th class="col-attempt">${i}ì°¨</th>`;
      }
      headerHtml += `<th class="col-add-attempt"><button class="btn-add-col" onclick="addBulkAttemptColumn()">+</button></th></tr>`;
      document.querySelector('#bulk-record-table thead').innerHTML = headerHtml;
      
      // ë°”ë””
      let bodyHtml = '';
      for (const disc of bulkDisciplines) {
        const records = bulkRecords[currentBulkDateIndex]?.[disc] || [];
        
        bodyHtml += `<tr data-disc="${disc}">
          <td class="col-name">${disc}</td>`;
        
        for (let i = 0; i < bulkAttemptCount; i++) {
          bodyHtml += `<td><input type="number" value="${records[i] || ''}" data-attempt="${i}" placeholder="-"></td>`;
        }
        
        bodyHtml += `<td></td></tr>`;
      }
      
      document.getElementById('bulk-record-tbody').innerHTML = bodyHtml;
    }

    function addBulkAttemptColumn() {
      saveBulkCurrentInput();
      bulkAttemptCount++;
      renderBulkRecordTable();
    }

    function openBulkAddDisciplineSheet() {
      const allDiscs = ['STA', 'DYNB', 'FIM', 'CWTB', 'DNF', 'CNF', 'DYN', 'CWT'];
      let html = '';
      
      for (const d of allDiscs) {
        const checked = bulkDisciplines.includes(d) ? 'checked' : '';
        html += `<label style="display: flex; align-items: center; gap: 8px; padding: 8px;">
          <input type="checkbox" value="${d}" ${checked}> ${d}
        </label>`;
      }
      
      document.getElementById('bulk-add-discipline-options').innerHTML = html;
      openBottomSheet('sheet-bulk-add-discipline');
    }

    function confirmBulkAddDiscipline() {
      const selected = [];
      document.querySelectorAll('#bulk-add-discipline-options input:checked').forEach(cb => {
        selected.push(cb.value);
      });
      
      if (selected.length === 0) {
        showToast('ìµœì†Œ 1ê°œ ì¢…ëª©ì„ ì„ íƒí•˜ì„¸ìš”');
        return;
      }
      
      // ìƒˆë¡œ ì¶”ê°€ëœ ì¢…ëª© ì´ˆê¸°í™”
      for (const disc of selected) {
        if (!bulkDisciplines.includes(disc)) {
          for (let i = 0; i < bulkDates.length; i++) {
            if (!bulkRecords[i]) bulkRecords[i] = {};
            bulkRecords[i][disc] = [];
          }
        }
      }
      
      bulkDisciplines = selected;
      closeBottomSheet('sheet-bulk-add-discipline');
      renderBulkRecordTable();
    }

    function saveBulkCurrentInput() {
      const rows = document.querySelectorAll('#bulk-record-tbody tr');
      rows.forEach(row => {
        const disc = row.dataset.disc;
        if (!disc) return;
        
        const inputs = row.querySelectorAll('input');
        const attempts = [];
        
        inputs.forEach(input => {
          if (input.dataset.attempt !== undefined) {
            attempts[parseInt(input.dataset.attempt)] = input.value;
          }
        });
        
        if (!bulkRecords[currentBulkDateIndex]) bulkRecords[currentBulkDateIndex] = {};
        bulkRecords[currentBulkDateIndex][disc] = attempts;
      });
    }

    async function saveBulkRecords(finish = false) {
      saveBulkCurrentInput();
      
      try {
        let totalSaved = 0;
        
        for (let dateIdx = 0; dateIdx < bulkDates.length; dateIdx++) {
          const dateInfo = bulkDates[dateIdx];
          const fullDate = '20' + dateInfo.date.substring(0, 2) + '-' + dateInfo.date.substring(2, 4) + '-' + dateInfo.date.substring(4, 6);
          
          const personalScheduleId = 'PS_' + currentUser.user_id + '_' + Date.now() + '_' + dateIdx;
          
          await db.from('personal_schedules').insert({
            personal_schedule_id: personalScheduleId,
            date: fullDate,
            time: null,
            location: dateInfo.location || null,
            common_disciplines: bulkDisciplines.join(',')
          });
          
          const dateRecords = bulkRecords[dateIdx] || {};
          
          for (const disc of Object.keys(dateRecords)) {
            const attempts = dateRecords[disc];
            
            for (let i = 0; i < attempts.length; i++) {
              const val = attempts[i];
              if (!val || val === '') continue;
              
              const recordId = 'PDR_' + currentUser.user_id + '_' + Date.now() + '_' + dateIdx + '_' + disc + '_' + i;
              
              const { error } = await db.from('personal_dive_records').insert({
                record_id: recordId,
                personal_schedule_id: personalScheduleId,
                user_id: currentUser.user_id,
                discipline: disc,
                attempt: i + 1,
                value: parseFloat(val)
              });
              
              if (!error) totalSaved++;
            }
          }
        }
        
        showToast(`${totalSaved}ê°œ ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤`);
        
        if (finish) {
          showScreen('screen-my-records');
        }
      } catch (err) {
        console.error('ì¼ê´„ ì €ì¥ ì˜¤ë¥˜:', err);
        showToast('ì €ì¥ ì‹¤íŒ¨: ' + err.message);
      }
    }

    // ==================== ì„±ì¥ ê·¸ë˜í”„ ====================
    let growthChart = null;
    let currentChartDiscipline = 'STA';
    let allRecordsForChart = [];

    function selectChartDiscipline(disc) {
      currentChartDiscipline = disc;
      document.querySelectorAll('#chart-discipline-tabs .disc-tab').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.disc === disc);
      });
      renderGrowthChart();
    }

    function renderGrowthChart() {
      const ctx = document.getElementById('growth-chart');
      if (!ctx) return;
      
      const discRecords = allRecordsForChart.filter(r => r.discipline === currentChartDiscipline);
      
      if (discRecords.length === 0) {
        if (growthChart) {
          growthChart.destroy();
          growthChart = null;
        }
        return;
      }
      
      const dateMap = {};
      for (const r of discRecords) {
        const val = parseFloat(r.value) || 0;
        if (!dateMap[r.date] || val > dateMap[r.date]) {
          dateMap[r.date] = val;
        }
      }
      
      const sortedDates = Object.keys(dateMap).sort();
      const labels = sortedDates.map(d => {
        const date = new Date(d);
        return (date.getMonth() + 1) + '/' + date.getDate();
      });
      const data = sortedDates.map(d => dateMap[d]);
      
      if (growthChart) {
        growthChart.destroy();
      }
      
      growthChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: currentChartDiscipline,
            data: data,
            borderColor: '#3182F6',
            backgroundColor: 'rgba(49, 130, 246, 0.1)',
            borderWidth: 2,
            tension: 0.3,
            fill: true,
            pointRadius: 4,
            pointBackgroundColor: '#3182F6'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, grid: { color: '#E5E8EB' } },
            x: { grid: { display: false } }
          }
        }
      });
    }

    function toggleChecklist(type) {
      // ìŠ¤í‚¬ê³¼ ê¸°ë¡ ì²´í¬ë¦¬ìŠ¤íŠ¸ ë‘˜ ë‹¤ í•œë²ˆì— í† ê¸€
      const skillsChecklist = document.getElementById('skills-checklist');
      const skillsIcon = document.getElementById('skills-toggle-icon');
      const recordsChecklist = document.getElementById('records-checklist');
      const recordsIcon = document.getElementById('records-toggle-icon');
      
      // í˜„ì¬ ìƒíƒœ í™•ì¸ (ë‘˜ ì¤‘ í•˜ë‚˜ë¼ë„ ì—´ë ¤ìˆìœ¼ë©´ ë‹«ê¸°, ë‘˜ ë‹¤ ë‹«í˜€ìˆìœ¼ë©´ ì—´ê¸°)
      const isAnyOpen = (skillsChecklist && skillsChecklist.classList.contains('open')) || 
                        (recordsChecklist && recordsChecklist.classList.contains('open'));
      
      if (isAnyOpen) {
        // ë‘˜ ë‹¤ ë‹«ê¸°
        if (skillsChecklist) skillsChecklist.classList.remove('open');
        if (skillsIcon) skillsIcon.classList.remove('open');
        if (recordsChecklist) recordsChecklist.classList.remove('open');
        if (recordsIcon) recordsIcon.classList.remove('open');
      } else {
        // ë‘˜ ë‹¤ ì—´ê¸°
        if (skillsChecklist) skillsChecklist.classList.add('open');
        if (skillsIcon) skillsIcon.classList.add('open');
        if (recordsChecklist) recordsChecklist.classList.add('open');
        if (recordsIcon) recordsIcon.classList.add('open');
      }
    }

    // ==================== ë“œë¼ì´ íŠ¸ë ˆì´ë‹ ====================
    let allDryTrainings = [];
    let myDryParticipations = [];
    let currentDryId = null;

    // ê°•ì‚¬: ë“œë¼ì´ íŠ¸ë ˆì´ë‹ ê´€ë¦¬ ë¡œë“œ
    async function loadDryManage() {
      try {
        const { data, error } = await db
          .from('dry_trainings')
          .select('*')
          .eq('instructor_id', currentUser.user_id)
          .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        const container = document.getElementById('dry-training-list');
        
        if (!data || data.length === 0) {
          container.innerHTML = `<div class="card" style="text-align: center; padding: 40px;">
            <i class="fas fa-lungs" style="font-size: 48px; color: var(--text-tertiary); margin-bottom: 16px;"></i>
            <p style="color: var(--text-secondary); margin-bottom: 16px;">ë“±ë¡ëœ íŠ¸ë ˆì´ë‹ì´ ì—†ìŠµë‹ˆë‹¤</p>
            <button class="btn btn-primary" onclick="openDryForm()">+ ìƒˆ íŠ¸ë ˆì´ë‹ ì¶”ê°€</button>
          </div>`;
          return;
        }
        
        let html = '';
        for (const d of data) {
          // participants ë°°ì—´ ê¸¸ì´ë¡œ ì°¸ì—¬ì ìˆ˜ ê³„ì‚°
          const participantCount = d.participants ? d.participants.length : 0;
          
          html += `<div class="card" style="margin-bottom: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: start;">
              <div style="flex: 1;">
                <div style="font-weight: 600; margin-bottom: 4px;">${d.name}</div>
                <div style="font-size: 13px; color: var(--text-secondary);">${d.description || 'ì„¤ëª… ì—†ìŒ'}</div>
                <div style="font-size: 12px; color: var(--text-tertiary); margin-top: 8px;">
                  <i class="fas fa-users"></i> ì°¸ì—¬ì ${participantCount}ëª…
                </div>
              </div>
              <div style="display: flex; gap: 8px;">
                <button class="icon-btn" onclick="openDryForm('${d.dry_id}')"><i class="fas fa-pen"></i></button>
                <button class="icon-btn" onclick="deleteDryTraining('${d.dry_id}')"><i class="fas fa-trash"></i></button>
              </div>
            </div>
          </div>`;
        }
        
        container.innerHTML = html;
      } catch (err) {
        console.error('ë“œë¼ì´ íŠ¸ë ˆì´ë‹ ë¡œë“œ ì˜¤ë¥˜:', err);
      }
    }

    // ê°•ì‚¬: ë“œë¼ì´ íŠ¸ë ˆì´ë‹ í¼ ì—´ê¸°
    function openDryForm(dryId = null) {
      document.getElementById('edit-dry-id').value = dryId || '';
      document.getElementById('dry-form-title').textContent = dryId ? 'íŠ¸ë ˆì´ë‹ ìˆ˜ì •' : 'ìƒˆ íŠ¸ë ˆì´ë‹ ì¶”ê°€';
      
      if (dryId) {
        // ìˆ˜ì • ì‹œ ê¸°ì¡´ ë°ì´í„° ë¡œë“œ
        db.from('dry_trainings').select('*').eq('dry_id', dryId).single()
          .then(({ data }) => {
            if (data) {
              document.getElementById('dry-name').value = data.name;
              document.getElementById('dry-description').value = data.description || '';
            }
          });
      } else {
        document.getElementById('dry-name').value = '';
        document.getElementById('dry-description').value = '';
      }
      
      openBottomSheet('sheet-dry-form');
    }

    // ê°•ì‚¬: ë“œë¼ì´ íŠ¸ë ˆì´ë‹ ì €ì¥
    async function saveDryTraining() {
      const dryId = document.getElementById('edit-dry-id').value;
      const name = document.getElementById('dry-name').value.trim();
      const description = document.getElementById('dry-description').value.trim();
      
      if (!name) {
        showToast('íŠ¸ë ˆì´ë‹ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return;
      }
      
      try {
        if (dryId) {
          // ìˆ˜ì •
          const { error } = await db
            .from('dry_trainings')
            .update({ name, description })
            .eq('dry_id', dryId);
          if (error) throw error;
          showToast('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
        } else {
          // ì¶”ê°€
          const { error } = await db
            .from('dry_trainings')
            .insert({ name, description, instructor_id: currentUser.user_id });
          if (error) throw error;
          showToast('ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
        }
        
        closeBottomSheet('sheet-dry-form');
        loadDryManage();
      } catch (err) {
        console.error('ì €ì¥ ì˜¤ë¥˜:', err);
        showToast('ì €ì¥ ì‹¤íŒ¨: ' + err.message);
      }
    }

    // ê°•ì‚¬: ë“œë¼ì´ íŠ¸ë ˆì´ë‹ ì‚­ì œ
    async function deleteDryTraining(dryId) {
      if (!confirm('ì´ íŠ¸ë ˆì´ë‹ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      
      try {
        // ê´€ë ¨ ê¸°ë¡ë„ ì‚­ì œ
        await db.from('dry_training_records').delete().eq('dry_id', dryId);
        const { error } = await db.from('dry_trainings').delete().eq('dry_id', dryId);
        if (error) throw error;
        
        showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
        loadDryManage();
      } catch (err) {
        console.error('ì‚­ì œ ì˜¤ë¥˜:', err);
        showToast('ì‚­ì œ ì‹¤íŒ¨: ' + err.message);
      }
    }

    // í•™ìƒ: ë“œë¼ì´ íŠ¸ë ˆì´ë‹ ëª©ë¡ ë¡œë“œ
    async function loadDryTraining() {
      try {
        // ëª¨ë“  íŠ¸ë ˆì´ë‹ ì¡°íšŒ
        const { data: trainings } = await db
          .from('dry_trainings')
          .select('*, users!dry_trainings_instructor_id_fkey(name)')
          .order('created_at', { ascending: false });
        
        allDryTrainings = trainings || [];
        
        // ë‚´ê°€ ì°¸ì—¬ ì¤‘ì¸ íŠ¸ë ˆì´ë‹ (participants ë°°ì—´ì— ìˆëŠ”ì§€ í™•ì¸)
        const myTrainings = allDryTrainings.filter(t => 
          t.participants && t.participants.includes(currentUser.user_id)
        );
        
        // ì°¸ì—¬ ì•ˆí•œ íŠ¸ë ˆì´ë‹
        const otherTrainings = allDryTrainings.filter(t => 
          !t.participants || !t.participants.includes(currentUser.user_id)
        );
        
        // ì°¸ì—¬ ì¤‘ì¸ íŠ¸ë ˆì´ë‹ ì˜ì—­
        const myContainer = document.getElementById('my-dry-trainings');
        const calendarSection = document.getElementById('dry-training-calendar-section');
        const otherSection = document.getElementById('other-dry-trainings-section');
        const allSection = document.getElementById('all-dry-trainings-section');
        
        if (myTrainings.length === 0) {
          // ì°¸ì—¬ ì¤‘ì¸ íŠ¸ë ˆì´ë‹ì´ ì—†ëŠ” ê²½ìš° (ì‚¬ì§„3)
          myContainer.innerHTML = `<div class="card" style="text-align: center; color: var(--text-secondary); padding: 20px;">
            ì°¸ì—¬ ì¤‘ì¸ íŠ¸ë ˆì´ë‹ì´ ì—†ìŠµë‹ˆë‹¤<br>
            <span style="font-size: 12px;">ì•„ë˜ì—ì„œ íŠ¸ë ˆì´ë‹ì„ ì„ íƒí•´ë³´ì„¸ìš”!</span>
          </div>`;
          
          // ìº˜ë¦°ë” ìˆ¨ê¸°ê¸°, ì°¸ì—¬ì¤‘ì´ì§€ ì•Šì€ íŠ¸ë ˆì´ë‹ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
          calendarSection.style.display = 'none';
          otherSection.style.display = 'none';
          
          // ì „ì²´ íŠ¸ë ˆì´ë‹ í‘œì‹œ
          allSection.style.display = 'block';
          const allContainer = document.getElementById('all-dry-trainings-no-participation');
          
          if (allDryTrainings.length === 0) {
            allContainer.innerHTML = `<div class="card" style="text-align: center; color: var(--text-secondary); padding: 20px;">
              ë“±ë¡ëœ íŠ¸ë ˆì´ë‹ì´ ì—†ìŠµë‹ˆë‹¤
            </div>`;
          } else {
            let html = '';
            for (const t of allDryTrainings) {
              html += renderDryCard(t, false);
            }
            allContainer.innerHTML = html;
          }
        } else {
          // ì°¸ì—¬ ì¤‘ì¸ íŠ¸ë ˆì´ë‹ì´ ìˆëŠ” ê²½ìš° (ì‚¬ì§„5)
          // ì²« ë²ˆì§¸ ì°¸ì—¬ ì¤‘ì¸ íŠ¸ë ˆì´ë‹ì„ currentDryIdë¡œ ì„¤ì •
          currentDryId = myTrainings[0].dry_id;
          
          // ì°¸ì—¬ ì¤‘ì¸ íŠ¸ë ˆì´ë‹ ì¹´ë“œ (ì²´í¬ ë²„íŠ¼ í¬í•¨)
          let myHtml = '';
          const today = new Date().toISOString().split('T')[0];
          const { data: todayRecords } = await db
            .from('dry_training_records')
            .select('dry_id')
            .eq('user_id', currentUser.user_id)
            .eq('date', today);
          
          const completedIds = (todayRecords || []).map(r => r.dry_id);
          
          for (const t of myTrainings) {
            const isDone = completedIds.includes(t.dry_id);
            myHtml += `<div class="card" style="margin-bottom: 12px;">
              <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div style="flex: 1;">
                  <div style="font-weight: 600; margin-bottom: 4px;">${t.name}</div>
                  <div style="font-size: 13px; color: var(--text-secondary);">${t.description || ''}</div>
                </div>
                ${isDone 
                  ? `<span style="color: var(--success); font-size: 13px; padding: 10px 16px;"><i class="fas fa-check-circle"></i> ì™„ë£Œ</span>`
                  : `<button class="btn btn-primary btn-small" onclick="quickDryRecord('${t.dry_id}')">ì²´í¬</button>`
                }
              </div>
            </div>`;
          }
          myContainer.innerHTML = myHtml;
          
          // ìº˜ë¦°ë” í‘œì‹œ
          calendarSection.style.display = 'block';
          renderDryListCalendar();
          
          // ì°¸ì—¬ì¤‘ì´ì§€ ì•Šì€ íŠ¸ë ˆì´ë‹ í‘œì‹œ
          allSection.style.display = 'none';
          
          if (otherTrainings.length > 0) {
            otherSection.style.display = 'block';
            const allContainer = document.getElementById('all-dry-trainings');
            let html = '';
            for (const t of otherTrainings) {
              html += renderDryCard(t, false);
            }
            allContainer.innerHTML = html;
          } else {
            otherSection.style.display = 'none';
          }
        }
      } catch (err) {
        console.error('ë“œë¼ì´ íŠ¸ë ˆì´ë‹ ë¡œë“œ ì˜¤ë¥˜:', err);
      }
    }
    
    // ë“œë¼ì´ íŠ¸ë ˆì´ë‹ ëª©ë¡ ìº˜ë¦°ë” ë³€ìˆ˜
    let dryListCalendarYear = new Date().getFullYear();
    let dryListCalendarMonth = new Date().getMonth();
    
    // ë“œë¼ì´ ëª©ë¡ ìº˜ë¦°ë” ì›” ë³€ê²½
    function changeDryListMonth(delta) {
      dryListCalendarMonth += delta;
      if (dryListCalendarMonth > 11) {
        dryListCalendarMonth = 0;
        dryListCalendarYear++;
      } else if (dryListCalendarMonth < 0) {
        dryListCalendarMonth = 11;
        dryListCalendarYear--;
      }
      renderDryListCalendar();
    }
    
    // ë“œë¼ì´ ëª©ë¡ ìº˜ë¦°ë” ë Œë”ë§
    async function renderDryListCalendar() {
      const monthNames = ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'];
      document.getElementById('dry-list-calendar-title').textContent = `${dryListCalendarYear}ë…„ ${monthNames[dryListCalendarMonth]}`;
      
      // í•´ë‹¹ ì›” ê¸°ë¡ ì¡°íšŒ (ì°¸ì—¬ ì¤‘ì¸ ëª¨ë“  íŠ¸ë ˆì´ë‹)
      const startDate = `${dryListCalendarYear}-${String(dryListCalendarMonth + 1).padStart(2, '0')}-01`;
      const endDate = `${dryListCalendarYear}-${String(dryListCalendarMonth + 1).padStart(2, '0')}-31`;
      
      const { data: records } = await db
        .from('dry_training_records')
        .select('date, achievement')
        .eq('user_id', currentUser.user_id)
        .gte('date', startDate)
        .lte('date', endDate);
      
      const recordMap = {};
      (records || []).forEach(r => {
        recordMap[r.date] = true;
      });
      
      const firstDay = new Date(dryListCalendarYear, dryListCalendarMonth, 1);
      const lastDay = new Date(dryListCalendarYear, dryListCalendarMonth + 1, 0);
      const startDayOfWeek = firstDay.getDay();
      const daysInMonth = lastDay.getDate();
      const today = new Date().toISOString().split('T')[0];
      
      let html = '';
      
      // ì´ì „ ë‹¬
      const prevMonthLastDay = new Date(dryListCalendarYear, dryListCalendarMonth, 0).getDate();
      for (let i = startDayOfWeek - 1; i >= 0; i--) {
        html += `<div class="calendar-day other-month">${prevMonthLastDay - i}</div>`;
      }
      
      // ì´ë²ˆ ë‹¬
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${dryListCalendarYear}-${String(dryListCalendarMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const isToday = dateStr === today;
        const hasRecord = recordMap[dateStr];
        
        let classes = 'calendar-day';
        if (isToday) classes += ' today';
        if (hasRecord) classes += ' has-dry';
        
        html += `<div class="${classes}">${day}</div>`;
      }
      
      // ë‹¤ìŒ ë‹¬
      const totalCells = startDayOfWeek + daysInMonth;
      const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
      for (let i = 1; i <= remainingCells; i++) {
        html += `<div class="calendar-day other-month">${i}</div>`;
      }
      
      document.getElementById('dry-list-calendar-days').innerHTML = html;
    }

    // ë“œë¼ì´ íŠ¸ë ˆì´ë‹ ì¹´ë“œ ë Œë”ë§ (ê³µìš©)
    function renderDryCard(t, isParticipating) {
      return `<div class="card" style="margin-bottom: 12px;">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
          <div style="flex: 1;">
            <div style="font-weight: 600; margin-bottom: 4px;">${t.name}</div>
            <div style="font-size: 13px; color: var(--text-secondary);">${t.description || ''}</div>
            <div style="font-size: 12px; color: var(--text-tertiary); margin-top: 4px;">by ${t.users?.name || 'ê°•ì‚¬'}</div>
          </div>
          ${isParticipating 
            ? `<button class="btn btn-primary btn-small" onclick="quickDryRecord('${t.dry_id}')">ì²´í¬</button>`
            : `<button class="btn btn-secondary btn-small" onclick="joinDryTraining('${t.dry_id}')">ì°¸ì—¬í•˜ê¸°</button>`
          }
        </div>
      </div>`;
    }

    // í•™ìƒ: íŠ¸ë ˆì´ë‹ ì°¸ì—¬í•˜ê¸° (ë“œë¼ì´ íƒ­ì—ì„œ)
    async function joinDryTraining(dryId) {
      try {
        // í˜„ì¬ íŠ¸ë ˆì´ë‹ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const training = allDryTrainings.find(t => t.dry_id === dryId);
        if (!training) return;
        
        // participants ë°°ì—´ì— í˜„ì¬ ìœ ì € ì¶”ê°€
        const currentParticipants = training.participants || [];
        if (!currentParticipants.includes(currentUser.user_id)) {
          const newParticipants = [...currentParticipants, currentUser.user_id];
          
          await db.from('dry_trainings')
            .update({ participants: newParticipants })
            .eq('dry_id', dryId);
          
          // ë¡œì»¬ ë°ì´í„°ë„ ì—…ë°ì´íŠ¸
          training.participants = newParticipants;
        }
        
        showToast('ì°¸ì—¬ ì™„ë£Œ!');
        currentDryId = dryId;
        // ë“œë¼ì´ íƒ­ ìƒˆë¡œê³ ì¹¨ (ì‚¬ì§„3ì²˜ëŸ¼ í‘œì‹œ)
        loadDryTraining();
      } catch (err) {
        console.error('ì°¸ì—¬ ì˜¤ë¥˜:', err);
        showToast('ì°¸ì—¬ ì‹¤íŒ¨: ' + err.message);
      }
    }

    // ê¸°ë¡ ì…ë ¥ ì‹œíŠ¸ ì—´ê¸°
    function openDryRecordSheet() {
      // ê¸°ë³¸ê°’ 100%
      document.querySelectorAll('#dry-achievement-btns .purpose-btn').forEach(b => b.classList.remove('selected'));
      document.querySelector('#dry-achievement-btns .purpose-btn[data-value="1.0"]').classList.add('selected');
      document.getElementById('dry-record-note').value = '';
      openBottomSheet('sheet-dry-record');
    }

    function selectDryAchievement(btn) {
      document.querySelectorAll('#dry-achievement-btns .purpose-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
    }

    // ê¸°ë¡ ì €ì¥
    async function saveDryRecord() {
      const achievementBtn = document.querySelector('#dry-achievement-btns .purpose-btn.selected');
      const achievement = parseFloat(achievementBtn.dataset.value);
      const note = document.getElementById('dry-record-note').value.trim();
      const today = new Date().toISOString().split('T')[0];
      
      try {
        // ê¸°ì¡´ ê¸°ë¡ í™•ì¸
        const { data: existing } = await db
          .from('dry_training_records')
          .select('record_id')
          .eq('dry_id', currentDryId)
          .eq('user_id', currentUser.user_id)
          .eq('date', today)
          .maybeSingle();
        
        if (existing) {
          // ìˆ˜ì •
          await db.from('dry_training_records')
            .update({ achievement, note })
            .eq('record_id', existing.record_id);
        } else {
          // ì¶”ê°€
          await db.from('dry_training_records')
            .insert({
              dry_id: currentDryId,
              user_id: currentUser.user_id,
              date: today,
              achievement,
              note
            });
        }
        
        showToast('ì™„ë£Œ! ğŸ‰');
        closeBottomSheet('sheet-dry-record');
        
        // í˜„ì¬ í™”ë©´ì— ë”°ë¼ ìƒˆë¡œê³ ì¹¨
        const currentScreen = document.querySelector('.screen.active');
        if (currentScreen) {
          if (currentScreen.id === 'screen-student-home') {
            loadHomeDryTraining();
          } else if (currentScreen.id === 'screen-dry-training') {
            loadDryTraining();
          }
        }
        // í™ˆ ë“œë¼ì´ ì„¹ì…˜ë„ ìƒˆë¡œê³ ì¹¨
        loadHomeDryTraining();
      } catch (err) {
        console.error('ê¸°ë¡ ì €ì¥ ì˜¤ë¥˜:', err);
        showToast('ì €ì¥ ì‹¤íŒ¨: ' + err.message);
      }
    }

    // í•™ìƒ í™ˆ: ë“œë¼ì´ íŠ¸ë ˆì´ë‹ ì„¹ì…˜ ë¡œë“œ
    async function loadHomeDryTraining() {
      try {
        const { data: trainings } = await db
          .from('dry_trainings')
          .select('*, users!dry_trainings_instructor_id_fkey(name)')
          .limit(3);
        
        const container = document.getElementById('home-dry-training');
        
        if (!trainings || trainings.length === 0) {
          container.innerHTML = `<div class="card" style="text-align: center; color: var(--text-secondary); padding: 20px;">
            ë“±ë¡ëœ ë“œë¼ì´ íŠ¸ë ˆì´ë‹ì´ ì—†ìŠµë‹ˆë‹¤
          </div>`;
          return;
        }
        
        // ë‚´ê°€ ì°¸ì—¬ ì¤‘ì¸ íŠ¸ë ˆì´ë‹ë§Œ í•„í„°ë§
        const myTrainings = trainings.filter(t => 
          t.participants && t.participants.includes(currentUser.user_id)
        );
        
        // ì°¸ì—¬í•˜ì§€ ì•Šì€ íŠ¸ë ˆì´ë‹
        const otherTrainings = trainings.filter(t => 
          !t.participants || !t.participants.includes(currentUser.user_id)
        );
        
        let html = '';
        
        // ì°¸ì—¬í•œ íŠ¸ë ˆì´ë‹ì´ ìˆìœ¼ë©´ ì²´í¬ ë²„íŠ¼ í‘œì‹œ
        if (myTrainings.length > 0) {
          // ì˜¤ëŠ˜ ê¸°ë¡ í™•ì¸
          const today = new Date().toISOString().split('T')[0];
          const { data: todayRecords } = await db
            .from('dry_training_records')
            .select('dry_id')
            .eq('user_id', currentUser.user_id)
            .eq('date', today);
          
          const completedIds = (todayRecords || []).map(r => r.dry_id);
          
          for (const t of myTrainings) {
            const isDone = completedIds.includes(t.dry_id);
            html += `<div class="card" style="margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
              <span>${t.name}</span>
              ${isDone 
                ? `<span style="color: var(--success); font-size: 13px;"><i class="fas fa-check-circle"></i> ì™„ë£Œ</span>`
                : `<button class="btn btn-small btn-primary" onclick="quickDryRecord('${t.dry_id}')">ì²´í¬</button>`
              }
            </div>`;
          }
        }
        
        // ì°¸ì—¬í•˜ì§€ ì•Šì€ íŠ¸ë ˆì´ë‹ì€ renderDryCard ì‚¬ìš© (ì°¸ì—¬í•˜ê¸° ë²„íŠ¼)
        for (const t of otherTrainings) {
          html += renderDryCard(t, false);
        }
        
        // íŠ¸ë ˆì´ë‹ì´ í•˜ë‚˜ë„ ì—†ìœ¼ë©´ ë©”ì‹œì§€ í‘œì‹œ
        if (html === '') {
          html = `<div class="card" style="text-align: center; color: var(--text-secondary); padding: 20px;">
            ë“±ë¡ëœ ë“œë¼ì´ íŠ¸ë ˆì´ë‹ì´ ì—†ìŠµë‹ˆë‹¤
          </div>`;
        }
        
        container.innerHTML = html;
      } catch (err) {
        console.error('í™ˆ ë“œë¼ì´ íŠ¸ë ˆì´ë‹ ë¡œë“œ ì˜¤ë¥˜:', err);
      }
    }
    
    // í™ˆì—ì„œ íŠ¸ë ˆì´ë‹ ì°¸ì—¬í•˜ê¸° (joinDryTrainingê³¼ ë™ì¼í•˜ê²Œ ë™ì‘í•˜ì§€ë§Œ í™ˆ ìƒˆë¡œê³ ì¹¨)
    async function joinDryTrainingFromHome(dryId) {
      try {
        // í˜„ì¬ íŠ¸ë ˆì´ë‹ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const { data: training } = await db
          .from('dry_trainings')
          .select('*')
          .eq('dry_id', dryId)
          .single();
        
        if (!training) return;
        
        // participants ë°°ì—´ì— í˜„ì¬ ìœ ì € ì¶”ê°€
        const currentParticipants = training.participants || [];
        if (!currentParticipants.includes(currentUser.user_id)) {
          const newParticipants = [...currentParticipants, currentUser.user_id];
          
          await db.from('dry_trainings')
            .update({ participants: newParticipants })
            .eq('dry_id', dryId);
        }
        
        showToast('ì°¸ì—¬ ì™„ë£Œ!');
        loadHomeDryTraining(); // í™ˆ ìƒˆë¡œê³ ì¹¨
      } catch (err) {
        console.error('ì°¸ì—¬ ì˜¤ë¥˜:', err);
        showToast('ì°¸ì—¬ ì‹¤íŒ¨: ' + err.message);
      }
    }

    // í™ˆì—ì„œ ë¹ ë¥¸ ê¸°ë¡
    // í™ˆì—ì„œ ê¸°ë¡í•˜ê¸° (ë°”í…€ì‹œíŠ¸ ì—´ê¸°)
    function quickDryRecord(dryId) {
      currentDryId = dryId;
      openDryRecordSheet();
    }

    // ê¸°ë¡ ì €ì¥ í›„ ì½œë°± (í™ˆì—ì„œ í˜¸ì¶œ ì‹œ í™ˆë„ ìƒˆë¡œê³ ì¹¨)
    let afterDryRecordSave = null;
  </script>
</body>
</html>


