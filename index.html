<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>DiveLog</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <!-- Supabase JS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --primary: #3182F6;
      --primary-light: #E8F3FF;
      --success: #00C853;
      --warning: #FF9100;
      --error: #F44336;
      --bg: #F7F8FA;
      --surface: #FFFFFF;
      --text-primary: #191F28;
      --text-secondary: #8B95A1;
      --text-tertiary: #B0B8C1;
      --border: #E5E8EB;
      --divider: #F2F4F6;
      --lv2-color: #FF9100;
      --lv2-light: #FFF3E0;
      --lv3-color: #00C853;
      --lv3-light: #E8F5E9;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text-primary);
      line-height: 1.5;
      min-height: 100vh;
    }
    .app { max-width: 480px; margin: 0 auto; min-height: 100vh; background: var(--bg); position: relative; padding-bottom: 80px; }
    .screen { display: none; }
    .screen.active { display: block; }
    .header { background: var(--surface); padding: 16px 20px; display: flex; align-items: center; gap: 12px; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid var(--divider); }
    .header-back { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border: none; background: none; font-size: 20px; color: var(--text-primary); cursor: pointer; border-radius: 12px; }
    .header-title { font-size: 18px; font-weight: 600; flex: 1; }
    .header-action { color: var(--primary); font-weight: 600; background: none; border: none; font-size: 16px; cursor: pointer; }
    .tab-bar { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 480px; background: var(--surface); border-top: 1px solid var(--divider); display: flex; padding: 8px 0 20px; z-index: 100; }
    .tab-item { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 8px; background: none; border: none; cursor: pointer; color: var(--text-tertiary); }
    .tab-item.active { color: var(--primary); }
    .tab-item i { font-size: 22px; }
    .tab-item span { font-size: 11px; font-weight: 500; }
    .container { padding: 20px; }
    .card { background: var(--surface); border-radius: 16px; padding: 20px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
    .greeting { font-size: 24px; font-weight: 700; margin-bottom: 4px; }
    .greeting-sub { color: var(--text-secondary); font-size: 15px; }
    .section-title { font-size: 16px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    .btn { width: 100%; padding: 16px; border-radius: 12px; font-size: 16px; font-weight: 600; border: none; cursor: pointer; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-secondary { background: var(--primary-light); color: var(--primary); }
    .btn-outline { background: transparent; border: 1px dashed var(--border); color: var(--text-secondary); }
    .btn-danger { background: #FEE; color: var(--error); }
    .btn-small { padding: 10px 16px; width: auto; font-size: 14px; }
    .input-group { margin-bottom: 16px; }
    .input-label { font-size: 14px; font-weight: 500; color: var(--text-secondary); margin-bottom: 8px; display: block; }
    .input { width: 100%; padding: 14px 16px; border: 1px solid var(--border); border-radius: 12px; font-size: 16px; font-family: inherit; background: var(--surface); }
    .input:focus { outline: none; border-color: var(--primary); }
    select.input { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%238B95A1' d='M6 8L1 3h10z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 16px center; }
    .schedule-card { display: flex; justify-content: space-between; align-items: center; }
    .schedule-info { flex: 1; }
    .schedule-time { font-size: 15px; font-weight: 600; margin-bottom: 2px; }
    .schedule-location { font-size: 14px; color: var(--text-secondary); }
    .schedule-meta { font-size: 13px; color: var(--text-tertiary); margin-top: 4px; }
    .schedule-arrow { color: var(--text-tertiary); font-size: 18px; }
    .participant-card { display: flex; align-items: center; gap: 12px; padding: 16px 0; border-bottom: 1px solid var(--divider); }
    .participant-card:last-child { border-bottom: none; }
    .participant-avatar { width: 44px; height: 44px; border-radius: 50%; background: var(--primary-light); display: flex; align-items: center; justify-content: center; color: var(--primary); font-weight: 600; }
    .participant-info { flex: 1; }
    .participant-name { font-weight: 600; font-size: 16px; }
    .participant-detail { font-size: 13px; color: var(--text-secondary); margin-top: 2px; }
    .attendance-badge { padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 500; }
    .attendance-yes { background: #E8F5E9; color: var(--success); }
    .attendance-no { background: #FFEBEE; color: var(--error); }
    .attendance-pending { background: var(--divider); color: var(--text-secondary); }
    .record-row { background: var(--bg); border-radius: 12px; padding: 16px; margin-bottom: 12px; }
    .record-row-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .record-row-title { font-weight: 600; font-size: 14px; color: var(--text-secondary); }
    .record-row-delete { background: none; border: none; color: var(--error); cursor: pointer; font-size: 18px; }
    .record-fields { display: grid; grid-template-columns: 1fr 80px 100px; gap: 8px; }
    .record-note { margin-top: 8px; }
    .record-note .input { padding: 10px 12px; font-size: 14px; }
    .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px; }
    .stat-card { background: var(--surface); border-radius: 12px; padding: 16px; text-align: center; }
    .stat-label { font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; }
    .stat-value { font-size: 20px; font-weight: 700; color: var(--primary); }
    .level-card { text-align: center; padding: 24px 20px; }
    .level-badge { font-size: 32px; font-weight: 700; color: var(--primary); margin-bottom: 8px; }
    .progress-bar { height: 8px; background: var(--divider); border-radius: 4px; overflow: hidden; margin: 12px 0; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary), #60A5FA); border-radius: 4px; }
    .quick-actions { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .quick-btn { background: var(--surface); border-radius: 16px; padding: 20px 12px; text-align: center; border: none; cursor: pointer; }
    .quick-btn i { font-size: 24px; color: var(--primary); margin-bottom: 8px; display: block; }
    .quick-btn span { font-size: 13px; font-weight: 500; }
    .btn-icon-delete { 
      background: none; 
      border: none; 
      color: var(--text-tertiary); 
      cursor: pointer; 
      padding: 8px; 
      margin-left: 4px;
      border-radius: 8px;
    }
    .btn-icon-delete:hover { color: var(--error); background: #FEE; }
    
    /* Ï∞∏Í∞ÄÏûê ÌÉ≠ */
    .participant-tabs {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding-bottom: 8px;
      margin-bottom: 16px;
    }
    .participant-tab {
      padding: 10px 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
      white-space: nowrap;
      cursor: pointer;
    }
    .participant-tab.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    
    /* Ï¢ÖÎ™© ÌÉ≠ */
    .discipline-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      overflow-x: auto;
    }
    .disc-tab {
      padding: 8px 16px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .disc-tab.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    
    /* ÏãúÎèÑ ÏûÖÎ†• Ìñâ */
    .attempt-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      padding: 8px;
      background: var(--bg);
      border-radius: 8px;
    }
    .attempt-num {
      width: 30px;
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 13px;
    }
    .attempt-input {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 16px;
    }
    .attempt-input:focus {
      outline: none;
      border-color: var(--primary);
    }
    .attempt-delete {
      width: 32px;
      height: 32px;
      border: none;
      background: none;
      color: var(--text-tertiary);
      cursor: pointer;
      border-radius: 8px;
    }
    .attempt-delete:hover {
      color: var(--error);
      background: #FEE;
    }
    
    /* Í∏∞Î°ù ÌÖåÏù¥Î∏î */
    .record-table-container {
      overflow-x: auto;
    }
    .record-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    .record-table th, .record-table td {
      padding: 10px 8px;
      text-align: center;
      border-bottom: 1px solid var(--divider);
    }
    .record-table th {
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 13px;
      background: var(--bg);
    }
    .record-table .col-name {
      text-align: left;
      min-width: 70px;
      font-weight: 500;
    }
    .record-table .col-attempt {
      min-width: 60px;
    }
    .record-table .col-note {
      min-width: 80px;
    }
    .record-table .col-skill {
      min-width: 50px;
    }
    .record-table .col-add-attempt {
      width: 30px;
      padding: 4px;
      border-left: 1px solid var(--divider);
    }
    .btn-add-col {
      width: 24px;
      height: 24px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 16px;
      color: var(--text-tertiary);
    }
    .btn-add-col:hover {
      color: var(--primary);
    }
    .record-table input {
      width: 100%;
      padding: 8px 4px;
      border: none;
      background: transparent;
      text-align: center;
      font-size: 14px;
      color: var(--text-secondary);
    }
    .record-table input:focus {
      outline: none;
      color: var(--primary);
      font-weight: 600;
    }
    .record-table input::placeholder {
      color: var(--text-tertiary);
    }
    .record-table input.note-input {
      text-align: left;
      padding-left: 8px;
    }
    .record-table td {
      border-right: 1px solid var(--divider);
    }
    .record-table td:last-child {
      border-right: none;
    }
    
    /* Ïä§ÌÇ¨ Ï≤¥ÌÅ¨ Î≤ÑÌäº */
    .skill-check-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 2px solid var(--border);
      background: white;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    .skill-check-btn.success {
      background: var(--success);
      border-color: var(--success);
      color: white;
    }
    .skill-check-btn.fail {
      background: var(--error);
      border-color: var(--error);
      color: white;
    }
    
    /* Ïä§ÌÇ¨ ÌÉ≠ */
    .disc-tab-skill {
      background: var(--lv3-light) !important;
      border-color: var(--lv3-color) !important;
      color: var(--lv3-color) !important;
    }
    .disc-tab-skill.active {
      background: var(--lv3-color) !important;
      color: white !important;
    }
    
    /* ÏùºÏ†ï ÏÑ†ÌÉù ÏïÑÏù¥ÌÖú */
    .schedule-select-item {
      padding: 16px;
      border-bottom: 1px solid var(--divider);
      cursor: pointer;
    }
    .schedule-select-item:hover {
      background: var(--bg);
    }
    .schedule-select-item:last-child {
      border-bottom: none;
    }
    .tab-filter { display: flex; gap: 8px; margin-bottom: 16px; overflow-x: auto; }
    .filter-chip { padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 500; background: var(--surface); border: 1px solid var(--border); color: var(--text-secondary); cursor: pointer; white-space: nowrap; }
    .filter-chip.active { background: var(--primary); border-color: var(--primary); color: white; }
    .bottom-sheet-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); z-index: 200; opacity: 0; visibility: hidden; transition: all 0.3s; }
    .bottom-sheet-overlay.active { opacity: 1; visibility: visible; }
    .bottom-sheet { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%) translateY(100%); width: 100%; max-width: 480px; background: var(--surface); border-radius: 24px 24px 0 0; z-index: 201; transition: transform 0.3s ease; max-height: 90vh; overflow-y: auto; }
    .bottom-sheet-overlay.active .bottom-sheet { transform: translateX(-50%) translateY(0); }
    .bottom-sheet-handle { width: 40px; height: 4px; background: var(--border); border-radius: 2px; margin: 12px auto; }
    .bottom-sheet-content { padding: 8px 20px 32px; }
    .bottom-sheet-title { font-size: 20px; font-weight: 700; margin-bottom: 20px; }
    .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: var(--text-primary); color: white; padding: 14px 24px; border-radius: 12px; font-size: 15px; font-weight: 500; z-index: 300; opacity: 0; visibility: hidden; transition: all 0.3s; }
    .toast.show { opacity: 1; visibility: visible; }
    .login-screen { display: flex; flex-direction: column; min-height: 100vh; padding: 60px 24px 40px; }
    .login-logo { text-align: center; margin-bottom: 48px; }
    .login-logo i { font-size: 64px; color: var(--primary); margin-bottom: 16px; }
    .login-logo h1 { font-size: 32px; font-weight: 700; }
    .login-logo p { color: var(--text-secondary); margin-top: 8px; }
    .login-form { flex: 1; }
    .empty-state { text-align: center; padding: 48px 20px; }
    .empty-state i { font-size: 48px; color: var(--text-tertiary); margin-bottom: 16px; }
    .empty-state p { color: var(--text-secondary); }
    .purpose-buttons { display: flex; gap: 8px; margin-top: 12px; }
    .purpose-btn { flex: 1; padding: 12px; border-radius: 10px; font-size: 14px; font-weight: 500; border: 1px solid var(--border); background: var(--surface); cursor: pointer; }
    .purpose-btn.selected { background: var(--primary); border-color: var(--primary); color: white; }
    .chart-container { background: var(--surface); border-radius: 16px; padding: 20px; margin-bottom: 16px; }
    .chart-title { font-size: 16px; font-weight: 600; margin-bottom: 16px; }
    .record-list-item { padding: 16px 0; border-bottom: 1px solid var(--divider); }
    .record-list-item:last-child { border-bottom: none; }
    .record-date { font-size: 14px; font-weight: 600; margin-bottom: 8px; }
    .record-entry { display: flex; justify-content: space-between; padding: 4px 0; }
    .record-discipline { font-size: 14px; color: var(--text-secondary); }
    .record-value { font-weight: 600; }
    
    .discipline-checkbox { display: inline-block; margin: 8px 12px 8px 0; }
    .discipline-checkbox input { margin-right: 6px; }
    .batch-tabs { display: flex; gap: 8px; margin-bottom: 16px; border-bottom: 2px solid var(--border); overflow-x: auto; }
    .batch-tab { padding: 12px 20px; background: none; border: none; font-weight: 500; color: var(--text-secondary); cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px; white-space: nowrap; }
    .batch-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
    .batch-tab.skill-tab { color: var(--success); }
    .batch-tab.skill-tab.active { border-bottom-color: var(--success); }
    .batch-tab.skill-tab-lv2 { color: var(--lv2-color); }
    .batch-tab.skill-tab-lv2.active { border-bottom-color: var(--lv2-color); }
    .batch-table { width: 100%; border-collapse: collapse; }
    .batch-table th { background: var(--bg); padding: 12px 8px; font-size: 14px; font-weight: 600; text-align: left; }
    .batch-table td { padding: 12px 8px; border-bottom: 1px solid var(--divider); }
    .batch-table input { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; }
    .batch-table .student-name { font-weight: 500; }
    .common-disciplines-badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: var(--primary-light); color: var(--primary); border-radius: 20px; font-size: 13px; font-weight: 500; margin-top: 8px; }
    .common-disciplines-badge.skill-badge { background: #E8F5E9; color: var(--success); }
    .common-disciplines-badge.skill-badge-lv2 { background: var(--lv2-light); color: var(--lv2-color); }

    /* Ïä§ÌÇ¨ ÌÖåÏù¥Î∏î Ïä§ÌÉÄÏùº */
    .skill-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .skill-table th { background: var(--bg); padding: 8px 4px; font-weight: 600; text-align: center; border-bottom: 2px solid var(--border); }
    .skill-table th.skill-header { font-size: 11px; }
    .skill-table th.attempt-header { font-size: 10px; color: var(--text-tertiary); font-weight: 500; }
    .skill-table td { padding: 8px 4px; border-bottom: 1px solid var(--divider); text-align: center; }
    .skill-table td.student-name { text-align: left; font-weight: 500; padding-left: 8px; white-space: nowrap; }
    .skill-cell { 
      width: 32px; 
      height: 32px; 
      border-radius: 8px; 
      display: inline-flex; 
      align-items: center; 
      justify-content: center; 
      cursor: pointer; 
      font-size: 14px;
      transition: all 0.15s ease;
      user-select: none;
    }
    .skill-cell.empty { background: var(--divider); color: var(--text-tertiary); }
    .skill-cell.success { background: #E8F5E9; color: var(--success); }
    .skill-cell.fail { background: #FFEBEE; color: var(--error); }
    .skill-cell:active { transform: scale(0.9); }
    
    .skill-group-header { 
      background: var(--primary-light) !important; 
      color: var(--primary); 
      font-weight: 600 !important;
    }
    .skill-group-header-lv2 { 
      background: var(--lv2-light) !important; 
      color: var(--lv2-color); 
      font-weight: 600 !important;
    }

    /* Lv ÏßÑÎèÑ Ï∞®Ìä∏ Ïä§ÌÉÄÏùº */
    .lv-charts { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
    .lv-chart-card { background: var(--surface); border-radius: 16px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
    .chart-header { font-size: 14px; font-weight: 600; margin-bottom: 12px; text-align: center; color: var(--text-primary); display: flex; align-items: center; justify-content: center; gap: 6px; cursor: pointer; user-select: none; }
    .chart-header:hover { color: var(--primary); }
    .toggle-icon { font-size: 12px; transition: transform 0.3s ease; color: var(--text-tertiary); }
    .toggle-icon.open { transform: rotate(180deg); }
    .donut-container { position: relative; width: 140px; height: 140px; margin: 0 auto 16px; }
    .donut-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; pointer-events: none; }
    .donut-value { font-size: 24px; font-weight: 700; color: var(--primary); line-height: 1; }
    .donut-value.lv2 { color: var(--lv2-color); }
    .donut-value.lv3 { color: var(--lv3-color); }
    .donut-label { font-size: 11px; color: var(--text-secondary); margin-top: 4px; }
    .checklist { border-top: 1px solid var(--divider); padding-top: 0; max-height: 0; overflow: hidden; transition: max-height 0.3s ease, padding 0.3s ease; border-top: none; }
    .checklist.open { max-height: 300px; overflow-y: auto; padding-top: 12px; border-top: 1px solid var(--divider); }
    .checklist-item { display: flex; align-items: center; gap: 8px; padding: 8px 0; border-bottom: 1px solid var(--divider); }
    .checklist-item:last-child { border-bottom: none; }
    .checklist-icon { width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 11px; }
    .checklist-icon.done { background: #E8F5E9; color: var(--success); }
    .checklist-icon.undone { background: var(--divider); color: var(--text-tertiary); }
    .checklist-text { flex: 1; font-size: 12px; line-height: 1.3; }
    .checklist-text.done { color: var(--text-secondary); text-decoration: line-through; }
    .checklist-badge { font-size: 11px; padding: 2px 6px; border-radius: 10px; background: var(--bg); color: var(--text-secondary); white-space: nowrap; }

    /* ÏùºÏ†ï Ï†ïÎ≥¥ Ïπ¥Îìú Ïä§ÌÉÄÏùº Í∞úÏÑ† */
    .schedule-info-card { background: var(--surface); border-radius: 16px; padding: 16px; margin-bottom: 16px; }
    .schedule-info-row { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
    .schedule-info-row:last-child { margin-bottom: 0; }
    .schedule-info-row i { color: var(--primary); width: 16px; }
    .schedule-badges { display: flex; flex-wrap: wrap; gap: 6px; }
    .btn-edit-disciplines { 
      background: var(--bg); 
      border: 1px solid var(--border); 
      border-radius: 8px; 
      padding: 8px 12px; 
      font-size: 13px; 
      color: var(--text-secondary); 
      cursor: pointer; 
      display: flex; 
      align-items: center; 
      gap: 4px;
      flex-shrink: 0;
    }
    .btn-edit-disciplines:hover { background: var(--divider); color: var(--text-primary); }
    
    /* Ïä§ÌÇ¨ ÏÑπÏÖò Íµ¨Î∂Ñ */
    .skill-section-label { 
      font-size: 12px; 
      font-weight: 600; 
      padding: 8px 12px; 
      margin: 16px 0 8px; 
      border-radius: 8px;
    }
    .skill-section-label.lv2 { background: var(--lv2-light); color: var(--lv2-color); }
    .skill-section-label.lv3 { background: #E8F5E9; color: var(--success); }

    /* ÏùºÏ†ï Ïπ¥Îìú ÏïÑÏù¥ÏΩò Î≤ÑÌäº */
    .schedule-card-header { display: flex; justify-content: space-between; align-items: flex-start; }
    .schedule-card-content { flex: 1; cursor: pointer; }
    .schedule-icon-buttons { display: flex; gap: 4px; flex-shrink: 0; margin-left: 8px; }
    .icon-btn { 
      width: 32px; 
      height: 32px; 
      border-radius: 8px; 
      border: none; 
      background: var(--bg); 
      color: var(--text-tertiary); 
      cursor: pointer; 
      display: flex; 
      align-items: center; 
      justify-content: center;
      font-size: 14px;
      transition: all 0.15s;
    }
    .icon-btn:hover { background: var(--divider); color: var(--text-secondary); }
    .icon-btn.danger:hover { background: #FFEBEE; color: var(--error); }
    .schedule-action-buttons { display: flex; gap: 8px; margin-top: 12px; }
    .schedule-action-buttons .btn { flex: 1; padding: 10px; font-size: 14px; }

    /* Notion Ïä§ÌÉÄÏùº Í∏∞Î°ù ÌÖåÏù¥Î∏î */
    .record-table-container { margin-top: 16px; }
    .record-table-wrapper { display: flex; align-items: stretch; }
    .record-table { 
      flex: 1;
      border-collapse: collapse; 
      background: white; 
      border-radius: 12px; 
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .record-table th, .record-table td { 
      border: 1px solid var(--divider); 
      padding: 12px 8px; 
      text-align: center;
      min-width: 60px;
    }
    .record-table th { 
      background: var(--bg); 
      font-weight: 600; 
      font-size: 13px;
      color: var(--text-secondary);
    }
    .record-table th.discipline-col {
      min-width: 70px;
      background: var(--bg);
    }
    .record-table td.discipline-cell {
      background: var(--bg);
      font-weight: 600;
      color: var(--text);
      position: relative;
    }
    .record-table td.discipline-cell .remove-row-btn {
      position: absolute;
      left: 4px;
      top: 50%;
      transform: translateY(-50%);
      width: 18px;
      height: 18px;
      border: none;
      background: transparent;
      color: var(--text-tertiary);
      cursor: pointer;
      font-size: 10px;
      opacity: 0;
      transition: opacity 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
    }
    .record-table tr:hover td.discipline-cell .remove-row-btn { opacity: 1; }
    .record-table td.discipline-cell .remove-row-btn:hover { background: #FFEBEE; color: var(--error); }
    .record-table input.record-input {
      width: 100%;
      border: none;
      background: transparent;
      text-align: center;
      font-size: 15px;
      padding: 4px;
      outline: none;
    }
    .record-table input.record-input:focus {
      background: rgba(49, 130, 246, 0.05);
      border-radius: 4px;
    }
    .record-table input.record-input::placeholder {
      color: var(--text-tertiary);
      font-size: 13px;
    }
    .record-table th .remove-col-btn {
      display: inline-block;
      margin-left: 4px;
      width: 16px;
      height: 16px;
      border: none;
      background: transparent;
      color: var(--text-tertiary);
      cursor: pointer;
      font-size: 9px;
      opacity: 0;
      transition: opacity 0.15s;
      vertical-align: middle;
      border-radius: 4px;
    }
    .record-table th:hover .remove-col-btn { opacity: 1; }
    .record-table th .remove-col-btn:hover { background: #FFEBEE; color: var(--error); }
    
    /* Ï∂îÍ∞Ä Î≤ÑÌäºÎì§ */
    .add-col-btn {
      width: 36px;
      min-width: 36px;
      background: var(--bg);
      border: 1px dashed var(--divider);
      border-left: none;
      border-radius: 0 12px 12px 0;
      cursor: pointer;
      color: var(--text-tertiary);
      font-size: 14px;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .add-col-btn:hover { background: rgba(49, 130, 246, 0.05); color: var(--primary); }
    .add-row-btn {
      width: 100%;
      padding: 12px;
      margin-top: 8px;
      background: var(--bg);
      border: 1px dashed var(--divider);
      border-radius: 8px;
      cursor: pointer;
      color: var(--text-tertiary);
      font-size: 14px;
      transition: all 0.15s;
    }
    .add-row-btn:hover { background: rgba(49, 130, 246, 0.05); color: var(--primary); }

    /* ÏùºÍ¥Ñ Ï∂îÍ∞Ä - ÎÇ†Ïßú ÏûÖÎ†• Ìñâ */
    .bulk-date-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      align-items: center;
    }
    .bulk-date-row .date-input-wrapper {
      flex: 1;
      position: relative;
    }
    .bulk-date-row .date-display {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 15px;
      background: var(--surface);
      text-align: center;
      font-family: 'SF Mono', Monaco, monospace;
      letter-spacing: 1px;
    }
    .bulk-date-row .date-display:focus {
      outline: none;
      border-color: var(--primary);
    }
    .bulk-date-row .date-display::placeholder {
      color: var(--text-tertiary);
      letter-spacing: 0;
    }
    .bulk-date-row .location-input {
      flex: 1.2;
      padding: 12px 14px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 15px;
      background: var(--surface);
    }
    .bulk-date-row .location-input:focus {
      outline: none;
      border-color: var(--primary);
    }
    .bulk-date-row .remove-btn {
      width: 36px;
      height: 36px;
      border: none;
      background: transparent;
      color: var(--text-tertiary);
      cursor: pointer;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .bulk-date-row .remove-btn:hover {
      background: #FFEBEE;
      color: var(--error);
    }

    /* ÏùºÍ¥Ñ Ï∂îÍ∞Ä - ÎÇ†Ïßú ÌÉ≠ */
    .bulk-date-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      overflow-x: auto;
      padding-bottom: 4px;
    }
    .bulk-date-tab {
      padding: 10px 14px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.15s;
    }
    .bulk-date-tab.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    .bulk-date-tab.saved {
      background: #E8F5E9;
      border-color: var(--success);
      color: var(--success);
    }
    .bulk-date-tab.saved.active {
      background: var(--success);
      color: white;
    }

    /* ÎÇ†Ïßú Ï∂îÍ∞Ä Î≤ÑÌäº */
    .btn-add-date {
      padding: 8px 12px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: all 0.15s;
    }
    .btn-add-date:hover { background: #2563EB; }
    
     /* Ï±åÎ¶∞ÏßÄ Ïπ¥Îìú Ïä§ÌÉÄÏùº */
    .challenge-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      color: white;
      position: relative;
      overflow: hidden;
    }
    .challenge-card::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      pointer-events: none;
    }
    .challenge-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
    }
    .challenge-title {
      font-size: 18px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .challenge-meta {
      font-size: 13px;
      opacity: 0.9;
      margin-top: 4px;
    }
    .challenge-streak {
      background: rgba(255,255,255,0.2);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
    }
    .challenge-tasks {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .challenge-task {
      display: flex;
      align-items: center;
      gap: 12px;
      background: rgba(255,255,255,0.15);
      padding: 14px 16px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .challenge-task:active {
      transform: scale(0.98);
    }
    .challenge-task.completed {
      background: rgba(255,255,255,0.3);
    }
    .task-checkbox {
      width: 24px;
      height: 24px;
      border: 2px solid rgba(255,255,255,0.8);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
      transition: all 0.2s ease;
    }
    .task-checkbox.checked {
      background: white;
      border-color: white;
      color: #667eea;
    }
    .task-name {
      flex: 1;
      font-size: 15px;
      font-weight: 500;
    }
    .task-name.completed {
      text-decoration: line-through;
      opacity: 0.7;
    }

    /* Ï∫òÎ¶∞Îçî Ïä§ÌÉÄÏùº */
    .calendar-container {
      background: var(--surface);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .calendar-nav {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .calendar-nav-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: var(--bg);
      border-radius: 8px;
      cursor: pointer;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .calendar-nav-btn:hover {
      background: var(--divider);
      color: var(--text-primary);
    }
    .calendar-month {
      font-size: 16px;
      font-weight: 600;
    }
    .calendar-weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      text-align: center;
      margin-bottom: 8px;
    }
    .calendar-weekday {
      font-size: 12px;
      color: var(--text-tertiary);
      font-weight: 500;
      padding: 8px 0;
    }
    .calendar-weekday:first-child {
      color: #F44336;
    }
    .calendar-weekday:last-child {
      color: #3182F6;
    }
    .calendar-days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }
    .calendar-day {
      aspect-ratio: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      border-radius: 12px;
      position: relative;
    }
    .calendar-day.other-month {
      color: var(--text-tertiary);
    }
    .calendar-day.today {
      background: var(--primary);
      color: white;
      font-weight: 600;
    }
    .calendar-day.sunday {
      color: #F44336;
    }
    .calendar-day.saturday {
      color: #3182F6;
    }
    .calendar-day.today.sunday,
    .calendar-day.today.saturday {
      color: white;
    }
    /* ÌÜµÌï© Ï∫òÎ¶∞Îçî Ïù∏ÎîîÏºÄÏù¥ÌÑ∞ */
    .calendar-indicators {
      display: flex;
      gap: 2px;
      justify-content: center;
      margin-top: 2px;
      flex-wrap: wrap;
      max-width: 28px;
    }
    .calendar-dot {
      width: 5px;
      height: 5px;
      border-radius: 50%;
    }
    .calendar-dot.lesson { background: #3182F6; }      /* Í∞ïÏäµ: ÌååÎûë */
    .calendar-dot.personal { background: #8B5CF6; }   /* Í∞úÏù∏: Î≥¥Îùº */
    .calendar-dot.task1 { background: #FF9100; }      /* ÌòÄÎøåÎ¶¨: Ï£ºÌô© */
    .calendar-dot.task2 { background: #00B8D9; }      /* ÌîÑÎ†åÏ†§: ÌïòÎäò */
    .calendar-dot.empty { 
      background: transparent;
      border: 1px solid var(--border);
    }

    /* Î†àÏ†ÑÎìú 2Ï§Ñ */
    .calendar-legend {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--divider);
      font-size: 11px;
      color: var(--text-secondary);
    }
    .calendar-legend-row {
      display: flex;
      justify-content: center;
      gap: 12px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .legend-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    .legend-dot.lesson { background: #3182F6; }
    .legend-dot.personal { background: #8B5CF6; }
    .legend-dot.task1 { background: #FF9100; }
    .legend-dot.task2 { background: #00B8D9; }
    .legend-dot.empty { border: 1.5px solid var(--border); background: transparent; }

    /* Ï±åÎ¶∞ÏßÄ ÏóÜÏùÑ Îïå */
    .no-challenge {
      text-align: center;
      padding: 24px;
      color: var(--text-secondary);
    }
    /* Ï∫òÎ¶∞Îçî ÎÇ†Ïßú ÏÑ†ÌÉù Ïä§ÌÉÄÏùº */
    .calendar-day {
      cursor: pointer;
      transition: all 0.15s;
    }
    .calendar-day:hover {
      background: var(--divider);
    }
    .calendar-day.other-month:hover {
      background: transparent;
    }
    .calendar-day.today:hover {
      background: var(--primary);
    }
    .calendar-day.selected {
      background: var(--primary-light);
      color: var(--primary);
      font-weight: 600;
    }
    .calendar-day.today.selected {
      background: var(--primary);
      color: white;
    }
    .calendar-day.selected.sunday,
    .calendar-day.selected.saturday {
      color: var(--primary);
    }

    /* ÏÑ†ÌÉùÎêú ÎÇ†Ïßú ÏùºÏ†ï Ïπ¥Îìú */
    .selected-date-header {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .selected-date-header i {
      color: var(--primary);
    }
    .schedule-detail-card {
      background: var(--surface);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 12px;
    }
    .schedule-detail-card .schedule-date-time {
      font-weight: 600;
      font-size: 15px;
      margin-bottom: 4px;
    }
    .schedule-detail-card .schedule-location,
    .schedule-detail-card .schedule-instructor {
      color: var(--text-secondary);
      font-size: 14px;
      margin-bottom: 4px;
    }
    .my-schedule-badge {
      display: inline-block;
      padding: 4px 10px;
      background: var(--primary-light);
      color: var(--primary);
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 8px;
    }
    /* Î©îÎ™® ÏÑπÏÖò Ïä§ÌÉÄÏùº */
    .memo-section {
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid var(--divider);
    }
    .memo-section-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .memo-section-title i {
      color: var(--primary);
    }
    .memo-card {
      background: var(--bg);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 10px;
    }
    .memo-card-header {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .memo-card-header.instructor {
      color: var(--primary);
    }
    .memo-card-header.student {
      color: var(--success);
    }
    .memo-card-content {
      font-size: 14px;
      color: var(--text-primary);
      line-height: 1.5;
    }
    .memo-card-empty {
      font-size: 13px;
      color: var(--text-tertiary);
      font-style: italic;
    }
    .memo-textarea {
      width: 100%;
      min-height: 80px;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 14px;
      font-family: inherit;
      resize: vertical;
      background: var(--surface);
    }
    .memo-textarea:focus {
      outline: none;
      border-color: var(--primary);
    }
    .memo-textarea::placeholder {
      color: var(--text-tertiary);
    }
/* Ï±åÎ¶∞ÏßÄ ÏÉÅÌÉú Ïπ¥Îìú */
    .challenge-status-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 0;
    }
    .challenge-status-item:first-child {
      border-bottom: 1px solid var(--divider);
      padding-bottom: 10px;
      margin-bottom: 2px;
    }
    .challenge-status-icon {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    .challenge-status-icon.done {
      background: #E8F5E9;
      color: var(--success);
    }
    .challenge-status-icon.undone {
      background: var(--divider);
      color: var(--text-tertiary);
    }
    .challenge-status-text {
      flex: 1;
      font-size: 15px;
    }
    .challenge-status-text.done {
      color: var(--success);
    }
    /* Ï∫òÎ¶∞Îçî Ï±åÎ¶∞ÏßÄ Ïπ¥Îìú */
    .calendar-challenge-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 12px;
      color: white;
    }
    .calendar-challenge-card .challenge-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .calendar-challenge-card .challenge-card-title {
      font-size: 16px;
      font-weight: 600;
    }
    .calendar-challenge-card .challenge-tasks-mini {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    .calendar-challenge-card .task-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
    }
    .calendar-challenge-card .task-badge.done {
      background: rgba(255,255,255,0.3);
    }
    .calendar-challenge-card .task-badge.undone {
      background: rgba(255,255,255,0.15);
      opacity: 0.7;
    }
    .calendar-challenge-card .challenge-memo-preview {
      background: rgba(255,255,255,0.15);
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 14px;
      line-height: 1.5;
    }
    .calendar-challenge-card .challenge-memo-empty {
      font-style: italic;
      opacity: 0.7;
    }
    .calendar-challenge-card .btn-edit-memo {
      margin-top: 10px;
      padding: 8px 16px;
      background: rgba(255,255,255,0.2);
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      width: 100%;
    }
    .calendar-challenge-card .btn-edit-memo:hover {
      background: rgba(255,255,255,0.3);
    }

    /* Î°úÎî© Ïù∏ÎîîÏºÄÏù¥ÌÑ∞ */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 40px;
    }
    .loading-spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--divider);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="app" id="app">
    <!-- Î°úÍ∑∏Ïù∏ ÌôîÎ©¥ -->
    <div class="screen active" id="screen-login">
      <div class="login-screen">
        <div class="login-logo">
          <i class="fas fa-water"></i>
          <h1>DiveLog</h1>
          <p>ÌîÑÎ¶¨Îã§Ïù¥Îπô Í∏∞Î°ùÏùÑ ÌïúÎààÏóê</p>
        </div>
        <div class="login-form">
          <div class="input-group">
            <label class="input-label">Ïó∞ÎùΩÏ≤ò</label>
            <input type="tel" class="input" id="login-phone" placeholder="010-0000-0000" maxlength="13">
          </div>
          <button class="btn btn-primary" onclick="handleLogin()">ÏãúÏûëÌïòÍ∏∞</button>
        </div>
      </div>
    </div>

    <!-- Í∞ïÏÇ¨ ÎåÄÏãúÎ≥¥Îìú -->
    <div class="screen" id="screen-instructor-home">
      <div class="container">
        <div style="padding: 20px 0;">
          <div class="greeting">ÏïàÎÖïÌïòÏÑ∏Ïöî, <span id="instructor-name">ÏΩîÏπò</span>Îãò üëã</div>
          <div class="greeting-sub">Ïò§ÎäòÎèÑ Ï¢ãÏùÄ Í∞ïÏäµ ÎêòÏÑ∏Ïöî</div>
        </div>
        <div class="section-title"><i class="fas fa-calendar-day"></i> Ïò§ÎäòÏùò ÏùºÏ†ï</div>
        <div id="today-schedules"></div>
        <div class="section-title" style="margin-top: 24px;"><i class="fas fa-bolt"></i> Îπ†Î•∏ Ïã§Ìñâ</div>
        <div class="quick-actions">
          <button class="quick-btn" onclick="openScheduleForm()"><i class="fas fa-calendar-plus"></i><span>ÏùºÏ†ï Îì±Î°ù</span></button>
          <button class="quick-btn" style="opacity: 0.4;" onclick="showToast('Ï§ÄÎπÑÏ§ëÏù∏ Í∏∞Îä•ÏûÖÎãàÎã§')"><i class="fas fa-ellipsis-h"></i><span>Ï§ÄÎπÑÏ§ë</span></button>
          <button class="quick-btn" onclick="quickRecordInput()"><i class="fas fa-pen"></i><span>ÏµúÍ∑º Í∞ïÏäµ<br>Í∏∞Î°ù ÏûÖÎ†•</span></button>
        </div>
        <div class="card" style="margin-top: 24px;">
          <div class="section-title"><i class="fas fa-chart-bar"></i> Ïù¥Î≤à Ï£º ÏöîÏïΩ</div>
          <div id="instructor-stats" style="color: var(--text-secondary);"></div>
        </div>
      </div>
      <div class="tab-bar">
        <button class="tab-item active" onclick="showScreen('screen-instructor-home')"><i class="fas fa-home"></i><span>Ìôà</span></button>
        <button class="tab-item" onclick="showScreen('screen-schedule-manage')"><i class="fas fa-calendar"></i><span>ÏùºÏ†ï</span></button>
        <button class="tab-item" onclick="showScreen('screen-my-records')"><i class="fas fa-chart-line"></i><span>ÎÇ¥Í∏∞Î°ù</span></button>
        <button class="tab-item" onclick="showScreen('screen-mypage')"><i class="fas fa-user"></i><span>ÎßàÏù¥</span></button>
      </div>
    </div>

    <!-- Í∞ïÏäµÏÉù ÎåÄÏãúÎ≥¥Îìú -->
    <div class="screen" id="screen-student-home">
      <div class="container">
        <div style="padding: 20px 0;">
          <div class="greeting">ÏïàÎÖïÌïòÏÑ∏Ïöî, <span id="student-name">Í∞ïÏäµÏÉù</span>Îãò üèä‚Äç‚ôÇÔ∏è</div>
          <div class="greeting-sub">Íæ∏Ï§ÄÌûà ÏÑ±Ïû•ÌïòÍ≥† ÏûàÏñ¥Ïöî!</div>
        </div>

        <!-- Ï±åÎ¶∞ÏßÄ ÏÑπÏÖò -->
        <div id="challenge-section" style="display: none;">
          <div class="section-title"><i class="fas fa-fire"></i> ÏßÑÌñâ Ï§ëÏù∏ Ï±åÎ¶∞ÏßÄ</div>
          <div id="challenge-cards"></div>
        </div>

        <!-- Î†àÎ≤®Î≥Ñ ÏßÑÎèÑ Ï∞®Ìä∏ ÏÑπÏÖò -->
        <div id="level-progress-section" style="display: none;">
          <div class="section-title" id="level-progress-title"><i class="fas fa-graduation-cap"></i> Level ÏßÑÎèÑ</div>
          <div id="level-progress-summary" style="color: var(--text-secondary); font-size: 14px; margin: -8px 0 16px; padding-left: 24px;"></div>
          <div class="lv-charts">
            <div class="lv-chart-card">
              <div class="chart-header" onclick="toggleChecklist('skills')">
                Ïä§ÌÇ¨ Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏
                <i class="fas fa-chevron-down toggle-icon" id="skills-toggle-icon"></i>
              </div>
              <div class="donut-container">
                <canvas id="skills-chart"></canvas>
                <div class="donut-center">
                  <div class="donut-value" id="skills-progress-value">0/0</div>
                  <div class="donut-label">ÏôÑÎ£å</div>
                </div>
              </div>
              <div class="checklist" id="skills-checklist"></div>
            </div>
            
            <div class="lv-chart-card">
              <div class="chart-header" onclick="toggleChecklist('records')">
                Í∏∞Î°ù Îã¨ÏÑ±
                <i class="fas fa-chevron-down toggle-icon" id="records-toggle-icon"></i>
              </div>
              <div class="donut-container">
                <canvas id="records-chart"></canvas>
                <div class="donut-center">
                  <div class="donut-value" id="records-progress-value">0/0</div>
                  <div class="donut-label">Îã¨ÏÑ±</div>
                </div>
              </div>
              <div class="checklist" id="records-checklist"></div>
            </div>
          </div>
        </div>

        <div class="section-title"><i class="fas fa-trophy"></i> Ï¢ÖÎ™©Î≥Ñ ÏµúÍ≥† Í∏∞Î°ù</div>
        <div class="stat-grid" id="best-records"></div>
        <div class="section-title"><i class="fas fa-calendar"></i> Îã§Í∞ÄÏò§Îäî ÏùºÏ†ï</div>
        <div id="upcoming-schedules"></div>
      </div>
      <div class="tab-bar">
        <button class="tab-item active" onclick="showScreen('screen-student-home')"><i class="fas fa-home"></i><span>Ìôà</span></button>
        <button class="tab-item" onclick="showScreen('screen-student-schedule')"><i class="fas fa-calendar"></i><span>ÏùºÏ†ï</span></button>
        <button class="tab-item" onclick="showScreen('screen-my-records')"><i class="fas fa-chart-line"></i><span>ÎÇ¥Í∏∞Î°ù</span></button>
        <button class="tab-item" onclick="showScreen('screen-mypage')"><i class="fas fa-user"></i><span>ÎßàÏù¥</span></button>
      </div>
    </div>

    <!-- ÏùºÏ†ï Í¥ÄÎ¶¨ (Í∞ïÏÇ¨) -->
    <div class="screen" id="screen-schedule-manage">
      <div class="header">
        <button class="header-back" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">ÏùºÏ†ï Í¥ÄÎ¶¨</span>
        <button class="header-action" onclick="openScheduleForm()">Ï∂îÍ∞Ä</button>
      </div>
      <div class="container">
        <div id="schedule-list">
          <div class="loading"><div class="loading-spinner"></div></div>
        </div>
      </div>
      <div class="tab-bar">
        <button class="tab-item" onclick="showScreen('screen-instructor-home')"><i class="fas fa-home"></i><span>Ìôà</span></button>
        <button class="tab-item active"><i class="fas fa-calendar"></i><span>ÏùºÏ†ï</span></button>
        <button class="tab-item" onclick="showScreen('screen-my-records')"><i class="fas fa-chart-line"></i><span>ÎÇ¥Í∏∞Î°ù</span></button>
        <button class="tab-item" onclick="showScreen('screen-mypage')"><i class="fas fa-user"></i><span>ÎßàÏù¥</span></button>
      </div>
    </div>

    <!-- Ï∞∏Í∞ÄÏûê Í¥ÄÎ¶¨ -->
    <div class="screen" id="screen-participants">
      <div class="header">
        <button class="header-back" onclick="showScreen('screen-schedule-manage')"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">Ï∞∏Í∞ÄÏûê Í¥ÄÎ¶¨</span>
        <button class="header-action" onclick="openAddParticipant()">Ï∂îÍ∞Ä</button>
      </div>
      <div class="container">
        <div class="card" style="margin-bottom: 20px;">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
            <i class="fas fa-calendar" style="color: var(--primary);"></i>
            <span id="participant-schedule-date" style="font-weight: 600;"></span>
          </div>
          <div style="display: flex; align-items: center; gap: 8px; color: var(--text-secondary);">
            <i class="fas fa-map-marker-alt"></i>
            <span id="participant-schedule-location"></span>
          </div>
        </div>
        <div class="section-title">Í∞ïÏäµ</div>
        <div class="card" id="lesson-participants">
          <div class="loading"><div class="loading-spinner"></div></div>
        </div>
        <div class="section-title" style="margin-top: 20px;">ÌéÄÎã§Ïù¥Îπô</div>
        <div class="card" id="fun-participants">
          <div style="text-align: center; color: var(--text-secondary); padding: 20px;">ÌéÄÎã§Ïù¥Îπô Ï∞∏Í∞ÄÏûêÍ∞Ä ÏóÜÏäµÎãàÎã§</div>
        </div>
      </div>
    </div>

    <!-- Í∞ïÏäµÏÉù ÏùºÏ†ï -->
    <div class="screen" id="screen-student-schedule">
      <div class="header">
        <button class="header-back" onclick="showScreen('screen-student-home')"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">ÏùºÏ†ï</span>
      </div>
      <div class="container">
        <div id="available-schedules">
          <div class="loading"><div class="loading-spinner"></div></div>
        </div>
      </div>
      <div class="tab-bar">
        <button class="tab-item" onclick="showScreen('screen-student-home')"><i class="fas fa-home"></i><span>Ìôà</span></button>
        <button class="tab-item active"><i class="fas fa-calendar"></i><span>ÏùºÏ†ï</span></button>
        <button class="tab-item" onclick="showScreen('screen-my-records')"><i class="fas fa-chart-line"></i><span>ÎÇ¥Í∏∞Î°ù</span></button>
        <button class="tab-item" onclick="showScreen('screen-mypage')"><i class="fas fa-user"></i><span>ÎßàÏù¥</span></button>
      </div>
    </div>

    <!-- ÎÇòÏùò Í∏∞Î°ù -->
    <div class="screen" id="screen-my-records">
      <div class="header">
        <button class="header-back" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">ÎÇòÏùò Í∏∞Î°ù</span>
        <div style="display: flex; gap: 8px;">
          <button class="header-action" style="color: var(--text-secondary);" onclick="openPersonalBulkAdd()">ÏùºÍ¥Ñ</button>
          <button class="header-action" onclick="openPersonalRecordAdd()">Ï∂îÍ∞Ä</button>
        </div>
      </div>
      <div class="container">
        <!-- ÏÑ±Ïû• Í∑∏ÎûòÌîÑ -->
        <div class="card" id="growth-chart-card">
          <div class="section-title" style="margin-bottom: 12px;"><i class="fas fa-chart-line"></i> ÏÑ±Ïû• Í∑∏ÎûòÌîÑ</div>
          <div class="discipline-tabs" id="chart-discipline-tabs">
            <button class="disc-tab active" data-disc="STA" onclick="selectChartDiscipline('STA')">STA</button>
            <button class="disc-tab" data-disc="DYNB" onclick="selectChartDiscipline('DYNB')">DYNB</button>
            <button class="disc-tab" data-disc="FIM" onclick="selectChartDiscipline('FIM')">FIM</button>
            <button class="disc-tab" data-disc="CWTB" onclick="selectChartDiscipline('CWTB')">CWTB</button>
          </div>
          <div style="height: 200px; position: relative;">
            <canvas id="growth-chart"></canvas>
          </div>
        </div>
        
        <div class="section-title" style="margin-top: 20px;"><i class="fas fa-trophy"></i> Ï¢ÖÎ™©Î≥Ñ ÏµúÍ≥† Í∏∞Î°ù</div>
        <div class="card" id="my-best-records">
          <div class="loading"><div class="loading-spinner"></div></div>
        </div>
        <div class="section-title" style="margin-top: 20px;"><i class="fas fa-list"></i> Ï†ÑÏ≤¥ Í∏∞Î°ù</div>
        <div class="card" id="my-all-records">
          <div style="text-align: center; color: var(--text-secondary); padding: 20px;">Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§</div>
        </div>
      </div>
      <div class="tab-bar" id="my-records-tabbar">
        <!-- ÎèôÏ†ÅÏúºÎ°ú Î†åÎçîÎßÅ -->
      </div>
    </div>

    <!-- Bottom Sheet: ÏùºÏ†ï Îì±Î°ù -->
    <div class="bottom-sheet-overlay" id="sheet-schedule">
      <div class="bottom-sheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-content">
          <div class="bottom-sheet-title" id="schedule-form-title">ÏÉà ÏùºÏ†ï Îì±Î°ù</div>
          <input type="hidden" id="edit-schedule-id">
          <div class="input-group">
            <label class="input-label">ÎÇ†Ïßú</label>
            <input type="date" class="input" id="schedule-date">
          </div>
          <div class="input-group">
            <label class="input-label">ÏãúÍ∞Ñ</label>
            <input type="time" class="input" id="schedule-time">
          </div>
          <div class="input-group">
            <label class="input-label">Ïû•ÏÜå</label>
            <input type="text" class="input" id="schedule-location" placeholder="Ïû•ÏÜåÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
          </div>
          <button class="btn btn-primary" onclick="saveSchedule()">Ï†ÄÏû•ÌïòÍ∏∞</button>
          <button class="btn btn-secondary" style="margin-top: 8px;" onclick="closeBottomSheet('sheet-schedule')">Ï∑®ÏÜå</button>
        </div>
      </div>
    </div>

    <!-- Bottom Sheet: Ï∞∏Í∞ÄÏûê Ï∂îÍ∞Ä -->
    <div class="bottom-sheet-overlay" id="sheet-add-participant">
      <div class="bottom-sheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-content">
          <div class="bottom-sheet-title">Ï∞∏Í∞ÄÏûê Ï∂îÍ∞Ä</div>
          <div class="input-group">
            <label class="input-label">Í∞ïÏäµÏÉù ÏÑ†ÌÉù</label>
            <select class="input" id="participant-student"></select>
          </div>
          <div class="input-group">
            <label class="input-label">Ï∞∏Í∞Ä Î™©Ï†Å</label>
            <div class="purpose-buttons">
              <button class="purpose-btn selected" data-purpose="Í∞ïÏäµ" onclick="selectPurpose(this)">Í∞ïÏäµ</button>
              <button class="purpose-btn" data-purpose="ÌéÄÎã§Ïù¥Îπô" onclick="selectPurpose(this)">ÌéÄÎã§Ïù¥Îπô</button>
            </div>
          </div>
          <div class="input-group" id="lesson-level-group">
            <label class="input-label">Í∞ïÏäµ Î†àÎ≤®</label>
            <select class="input" id="participant-level">
              <option value="2">Level 2</option>
              <option value="3">Level 3</option>
              <option value="4">Level 4</option>
            </select>
          </div>
          <button class="btn btn-primary" onclick="addParticipant()">Ï∂îÍ∞ÄÌïòÍ∏∞</button>
        </div>
      </div>
    </div>

    <!-- ÏùºÏ†ï Í¥ÄÎ¶¨ (Í∞ïÏÇ¨Ïö©) -->
    <div class="screen" id="screen-schedule-manage">
      <div class="header">
        <button class="header-back" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">ÏùºÏ†ï Í¥ÄÎ¶¨</span>
        <button class="header-action" onclick="openScheduleForm()">Ï∂îÍ∞Ä</button>
      </div>
      <div class="container">
        <div id="schedule-list">
          <div class="loading"><div class="loading-spinner"></div></div>
        </div>
      </div>
      <div class="tab-bar">
        <button class="tab-item" onclick="showScreen('screen-instructor-home')"><i class="fas fa-home"></i><span>Ìôà</span></button>
        <button class="tab-item active"><i class="fas fa-calendar"></i><span>ÏùºÏ†ï</span></button>
        <button class="tab-item" onclick="showScreen('screen-my-records')"><i class="fas fa-chart-line"></i><span>ÎÇ¥Í∏∞Î°ù</span></button>
        <button class="tab-item" onclick="showScreen('screen-mypage')"><i class="fas fa-user"></i><span>ÎßàÏù¥</span></button>
      </div>
    </div>

    <!-- Ï∞∏Í∞ÄÏûê Í¥ÄÎ¶¨ -->
    <div class="screen" id="screen-participants">
      <div class="header">
        <button class="header-back" onclick="showScreen('screen-schedule-manage')"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">Ï∞∏Í∞ÄÏûê Í¥ÄÎ¶¨</span>
        <button class="header-action" onclick="openAddParticipant()">Ï∂îÍ∞Ä</button>
      </div>
      <div class="container">
        <div class="card" style="margin-bottom: 20px;">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
            <i class="fas fa-calendar" style="color: var(--primary);"></i>
            <span id="participant-schedule-date" style="font-weight: 600;"></span>
          </div>
          <div style="display: flex; align-items: center; gap: 8px; color: var(--text-secondary);">
            <i class="fas fa-map-marker-alt"></i>
            <span id="participant-schedule-location"></span>
          </div>
        </div>
        <button class="btn btn-primary" style="margin-bottom: 20px;" onclick="openBatchRecordInput()">
          <i class="fas fa-pen"></i> ÏùºÍ¥Ñ Í∏∞Î°ù ÏûÖÎ†•
        </button>
        <div class="section-title">Í∞ïÏäµ</div>
        <div class="card" id="lesson-participants"></div>
        <div class="section-title" style="margin-top: 20px;">ÌéÄÎã§Ïù¥Îπô</div>
        <div class="card" id="fun-participants"></div>
      </div>
    </div>

    <!-- Í∞ïÏäµÏÉù ÏùºÏ†ï ÌôîÎ©¥ -->
    <div class="screen" id="screen-student-schedule">
      <div class="header">
        <button class="header-back" onclick="showScreen('screen-student-home')"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">ÏùºÏ†ï</span>
      </div>
      <div class="container">
        <div id="student-schedule-list">
          <div class="loading"><div class="loading-spinner"></div></div>
        </div>
      </div>
      <div class="tab-bar">
        <button class="tab-item" onclick="showScreen('screen-student-home')"><i class="fas fa-home"></i><span>Ìôà</span></button>
        <button class="tab-item active"><i class="fas fa-calendar"></i><span>ÏùºÏ†ï</span></button>
        <button class="tab-item" onclick="showScreen('screen-my-records')"><i class="fas fa-chart-line"></i><span>ÎÇ¥Í∏∞Î°ù</span></button>
        <button class="tab-item" onclick="showScreen('screen-mypage')"><i class="fas fa-user"></i><span>ÎßàÏù¥</span></button>
      </div>
    </div>

    <!-- ÏùºÍ¥Ñ Í∏∞Î°ù ÏûÖÎ†• ÌôîÎ©¥ (Í∞ïÏäµ) -->
    <div class="screen" id="screen-batch-record">
      <div class="header">
        <button class="header-back" onclick="closeBatchRecord()"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">Í∏∞Î°ù ÏùºÍ¥Ñ ÏûÖÎ†•</span>
      </div>
      <div class="container">
        <!-- ÏùºÏ†ï Ï†ïÎ≥¥ -->
        <div class="card" style="margin-bottom: 16px;">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
            <i class="fas fa-calendar" style="color: var(--primary);"></i>
            <span id="batch-schedule-date" style="font-weight: 600;"></span>
          </div>
          <div style="display: flex; align-items: center; gap: 8px; color: var(--text-secondary);">
            <i class="fas fa-map-marker-alt"></i>
            <span id="batch-schedule-location"></span>
          </div>
          <!-- Ï¢ÖÎ™© ÏÑ†ÌÉù ÌëúÏãú -->
          <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 12px;" id="batch-selected-disciplines"></div>
        </div>
        
        <!-- Ï¢ÖÎ™© ÌÉ≠ (ÎèôÏ†Å) -->
        <div class="discipline-tabs" id="batch-discipline-tabs"></div>
        
        <!-- Í∏∞Î°ù ÌÖåÏù¥Î∏î -->
        <div class="card" id="batch-record-table-card">
          <div class="record-table-container">
            <table class="record-table" id="batch-record-table">
              <thead>
                <tr>
                  <th class="col-name">ÌïôÏÉùÎ™Ö</th>
                  <th class="col-attempt">1Ï∞®</th>
                  <th class="col-attempt">2Ï∞®</th>
                  <th class="col-add-attempt"><button class="btn-add-col" onclick="addBatchAttemptColumn()">+</button></th>
                  <th class="col-note">Î©îÎ™®</th>
                </tr>
              </thead>
              <tbody id="batch-record-tbody"></tbody>
            </table>
          </div>
        </div>
        
        <!-- Ïä§ÌÇ¨ Ï≤¥ÌÅ¨ ÌÖåÏù¥Î∏î -->
        <div class="card" id="batch-skill-table-card" style="display: none;">
          <div class="record-table-container">
            <table class="record-table" id="batch-skill-table">
              <thead>
                <tr>
                  <th class="col-name">ÌïôÏÉùÎ™Ö</th>
                </tr>
              </thead>
              <tbody id="batch-skill-tbody"></tbody>
            </table>
          </div>
        </div>
        
        <!-- Ï†ÄÏû• Î≤ÑÌäº -->
        <div style="display: flex; gap: 12px; margin-top: 20px;">
          <button class="btn btn-secondary" style="flex: 1;" onclick="saveBatchRecords(false)">Ï†ÄÏû•ÌïòÍ≥† Í≥ÑÏÜç</button>
          <button class="btn btn-primary" style="flex: 1;" onclick="saveBatchRecords(true)">Ï†ÄÏû•ÌïòÍ≥† ÏôÑÎ£å</button>
        </div>
      </div>
    </div>

    <!-- Í∞úÏù∏ Í∏∞Î°ù Í∞úÎ≥Ñ Ï∂îÍ∞Ä ÌôîÎ©¥ -->
    <div class="screen" id="screen-personal-record">
      <div class="header">
        <button class="header-back" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">Í∞úÏù∏ Í∏∞Î°ù ÏûÖÎ†•</span>
      </div>
      <div class="container">
        <!-- ÎÇ†Ïßú/Ïû•ÏÜå Ï†ïÎ≥¥ -->
        <div class="card" style="margin-bottom: 16px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <div>
              <div style="display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-calendar" style="color: var(--primary);"></i>
                <span id="personal-date-display" style="font-weight: 600;"></span>
              </div>
              <div style="display: flex; align-items: center; gap: 8px; margin-top: 4px; color: var(--text-secondary);">
                <i class="fas fa-map-marker-alt"></i>
                <span id="personal-location-display"></span>
              </div>
            </div>
            <button class="btn btn-outline btn-small" onclick="openPersonalDateEdit()">+ ÎÇ†Ïßú</button>
          </div>
        </div>
        
        <!-- Í∏∞Î°ù ÌÖåÏù¥Î∏î -->
        <div class="card">
          <div class="record-table-container">
            <table class="record-table" id="personal-record-table">
              <thead>
                <tr>
                  <th class="col-name">Ï¢ÖÎ™©</th>
                  <th class="col-attempt">1Ï∞®</th>
                  <th class="col-attempt">2Ï∞®</th>
                </tr>
              </thead>
              <tbody id="personal-record-tbody"></tbody>
            </table>
          </div>
          <div style="display: flex; gap: 8px; margin-top: 12px;">
            <button class="btn btn-outline btn-small" style="flex: 1;" onclick="addPersonalAttemptColumn()">
              <i class="fas fa-plus"></i> ÏãúÎèÑ Ï∂îÍ∞Ä
            </button>
            <button class="btn btn-outline btn-small" style="flex: 1;" onclick="openAddDisciplineSheet()">
              <i class="fas fa-plus"></i> Ï¢ÖÎ™© Ï∂îÍ∞Ä
            </button>
          </div>
        </div>
        
        <!-- Î©îÎ™® -->
        <div class="card" style="margin-top: 16px;">
          <div class="section-title"><i class="fas fa-sticky-note"></i> Î©îÎ™®</div>
          <textarea class="input" id="personal-memo" rows="3" placeholder="Ïù¥ Îã§Ïù¥ÎπôÏóê ÎåÄÌïú Î©îÎ™®Î•º ÎÇ®Í≤®Î≥¥ÏÑ∏Ïöî... (Ïª®ÎîîÏÖò, ÎäêÎÇÄÏ†ê, Í∞úÏÑ†Ìï† Ï†ê Îì±)"></textarea>
        </div>
        
        <!-- Ï†ÄÏû• Î≤ÑÌäº -->
        <div style="display: flex; gap: 12px; margin-top: 20px;">
          <button class="btn btn-secondary" style="flex: 1;" onclick="savePersonalRecord(false)">Ï†ÄÏû•ÌïòÍ≥† Í≥ÑÏÜç</button>
          <button class="btn btn-primary" style="flex: 1;" onclick="savePersonalRecord(true)">Ï†ÄÏû•ÌïòÍ≥† ÏôÑÎ£å</button>
        </div>
      </div>
    </div>

    <!-- Í∞úÏù∏ Í∏∞Î°ù ÏùºÍ¥Ñ Ï∂îÍ∞Ä ÌôîÎ©¥ -->
    <div class="screen" id="screen-personal-bulk">
      <div class="header">
        <button class="header-back" onclick="showScreen('screen-my-records')"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">ÏùºÍ¥Ñ Í∏∞Î°ù Ï∂îÍ∞Ä</span>
      </div>
      <div class="container">
        <!-- ÏïàÎÇ¥ -->
        <div class="card" style="background: var(--primary-light); margin-bottom: 16px;">
          <div style="display: flex; align-items: flex-start; gap: 12px;">
            <i class="fas fa-info-circle" style="color: var(--primary); margin-top: 2px;"></i>
            <div style="font-size: 14px; color: var(--text-secondary);">
              Í≥ºÍ±∞ Îã§Ïù¥Îπô Í∏∞Î°ùÏùÑ ÌïúÎ≤àÏóê ÏûÖÎ†•Ìï† Ïàò ÏûàÏäµÎãàÎã§.<br>
              ÎÇ†ÏßúÎäî <strong>YYMMDD</strong> ÌòïÏãùÏúºÎ°ú ÏûÖÎ†•ÌïòÏÑ∏Ïöî.<br>
              Ïòà: 231112 ‚Üí 2023-11-12
            </div>
          </div>
        </div>
        
        <!-- ÎÇ†Ïßú/Ïû•ÏÜå Î™©Î°ù -->
        <div class="section-title"><i class="fas fa-calendar"></i> ÎÇ†Ïßú/Ïû•ÏÜå Î™©Î°ù</div>
        <div id="bulk-date-list"></div>
        <button class="btn btn-outline" style="margin-top: 8px;" onclick="addBulkDateRow()">
          <i class="fas fa-plus"></i> ÎÇ†Ïßú Ï∂îÍ∞Ä
        </button>
        
        <button class="btn btn-primary" style="margin-top: 20px;" onclick="proceedToBulkRecordInput()">
          Îã§Ïùå: Í∏∞Î°ù ÏûÖÎ†•
        </button>
      </div>
      <div class="tab-bar" id="bulk-tabbar">
        <!-- ÎèôÏ†ÅÏúºÎ°ú Î†åÎçîÎßÅ -->
      </div>
    </div>

    <!-- Í∞úÏù∏ Í∏∞Î°ù ÏùºÍ¥Ñ ÏûÖÎ†• ÌôîÎ©¥ (2Îã®Í≥Ñ) -->
    <div class="screen" id="screen-personal-bulk-input">
      <div class="header">
        <button class="header-back" onclick="showScreen('screen-personal-bulk')"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">ÏùºÍ¥Ñ Í∏∞Î°ù ÏûÖÎ†•</span>
      </div>
      <div class="container">
        <!-- ÎÇ†Ïßú ÌÉ≠ -->
        <div class="participant-tabs" id="bulk-date-tabs"></div>
        
        <!-- Í∏∞Î°ù ÌÖåÏù¥Î∏î -->
        <div class="card">
          <div class="record-table-container">
            <table class="record-table" id="bulk-record-table">
              <thead>
                <tr>
                  <th class="col-name">Ï¢ÖÎ™©</th>
                  <th class="col-attempt">1Ï∞®</th>
                  <th class="col-attempt">2Ï∞®</th>
                  <th class="col-add-attempt"><button class="btn-add-col" onclick="addBulkAttemptColumn()">+</button></th>
                </tr>
              </thead>
              <tbody id="bulk-record-tbody"></tbody>
            </table>
          </div>
          <button class="btn btn-outline" style="margin-top: 12px;" onclick="openBulkAddDisciplineSheet()">
            <i class="fas fa-plus"></i> Ï¢ÖÎ™© Ï∂îÍ∞Ä
          </button>
        </div>
        
        <!-- Ï†ÄÏû• Î≤ÑÌäº -->
        <div style="display: flex; gap: 12px; margin-top: 20px;">
          <button class="btn btn-secondary" style="flex: 1;" onclick="saveBulkRecords(false)">Ï†ÄÏû•ÌïòÍ≥† Í≥ÑÏÜç</button>
          <button class="btn btn-primary" style="flex: 1;" onclick="saveBulkRecords(true)">Ï†ÄÏû•ÌïòÍ≥† ÏôÑÎ£å</button>
        </div>
      </div>
      <div class="tab-bar" id="bulk-input-tabbar">
        <!-- ÎèôÏ†ÅÏúºÎ°ú Î†åÎçîÎßÅ -->
      </div>
    </div>

    <!-- ÎÇ¥ Í∏∞Î°ù ÌôîÎ©¥ -->
    <div class="screen" id="screen-my-records">
      <div class="header">
        <button class="header-back" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">ÎÇòÏùò Í∏∞Î°ù</span>
      </div>
      <div class="container">
        <div class="section-title"><i class="fas fa-trophy"></i> Ï¢ÖÎ™©Î≥Ñ ÏµúÍ≥† Í∏∞Î°ù</div>
        <div class="card" id="my-best-records"></div>
        <div class="section-title" style="margin-top: 20px;"><i class="fas fa-list"></i> Ï†ÑÏ≤¥ Í∏∞Î°ù</div>
        <div class="card" id="my-all-records"></div>
      </div>
      <div class="tab-bar" id="my-records-tabbar"></div>
    </div>

    <!-- ÎßàÏù¥ÌéòÏù¥ÏßÄ -->
    <div class="screen" id="screen-mypage">
      <div class="header">
        <button class="header-back" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
        <span class="header-title">ÎßàÏù¥ÌéòÏù¥ÏßÄ</span>
      </div>
      <div class="container">
        <div class="card" style="display: flex; align-items: center; gap: 16px;">
          <div class="participant-avatar" style="width: 60px; height: 60px; font-size: 24px;" id="mypage-avatar"></div>
          <div style="flex: 1;">
            <div style="font-size: 20px; font-weight: 700;" id="mypage-name"></div>
            <div style="color: var(--text-secondary); margin-top: 4px;" id="mypage-phone"></div>
            <div style="color: var(--text-tertiary); font-size: 14px; margin-top: 2px;" id="mypage-info"></div>
          </div>
        </div>
        <button class="btn btn-danger" style="margin-top: 20px;" onclick="logout()">Î°úÍ∑∏ÏïÑÏõÉ</button>
      </div>
    </div>

    <!-- ÌÜ†Ïä§Ìä∏ -->
    <div class="toast" id="toast"></div>

    <!-- Bottom Sheet: ÏùºÏ†ï Îì±Î°ù -->
    <div class="bottom-sheet-overlay" id="sheet-schedule">
      <div class="bottom-sheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-content">
          <div class="bottom-sheet-title" id="schedule-form-title">ÏÉà ÏùºÏ†ï Îì±Î°ù</div>
          <input type="hidden" id="edit-schedule-id">
          <div class="input-group">
            <label class="input-label">ÎÇ†Ïßú</label>
            <input type="date" class="input" id="schedule-date">
          </div>
          <div class="input-group">
            <label class="input-label">ÏãúÍ∞Ñ</label>
            <input type="time" class="input" id="schedule-time">
          </div>
          <div class="input-group">
            <label class="input-label">Ïû•ÏÜå</label>
            <input type="text" class="input" id="schedule-location" placeholder="Ïû•ÏÜåÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
          </div>
          <button class="btn btn-primary" onclick="saveSchedule()">Ï†ÄÏû•ÌïòÍ∏∞</button>
          <button class="btn btn-secondary" style="margin-top: 8px;" onclick="closeBottomSheet('sheet-schedule')">Ï∑®ÏÜå</button>
        </div>
      </div>
    </div>

    <!-- Bottom Sheet: Ï∞∏Í∞ÄÏûê Ï∂îÍ∞Ä -->
    <div class="bottom-sheet-overlay" id="sheet-add-participant">
      <div class="bottom-sheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-content">
          <div class="bottom-sheet-title">Ï∞∏Í∞ÄÏûê Ï∂îÍ∞Ä</div>
          <div class="input-group">
            <label class="input-label">Í∞ïÏäµÏÉù ÏÑ†ÌÉù</label>
            <select class="input" id="participant-student"></select>
          </div>
          <div class="input-group">
            <label class="input-label">Ï∞∏Í∞Ä Î™©Ï†Å</label>
            <div class="purpose-buttons">
              <button class="purpose-btn selected" data-purpose="Í∞ïÏäµ" onclick="selectPurpose(this)">Í∞ïÏäµ</button>
              <button class="purpose-btn" data-purpose="ÌéÄÎã§Ïù¥Îπô" onclick="selectPurpose(this)">ÌéÄÎã§Ïù¥Îπô</button>
            </div>
          </div>
          <div class="input-group" id="lesson-level-group">
            <label class="input-label">Í∞ïÏäµ Î†àÎ≤®</label>
            <select class="input" id="participant-level">
              <option value="2">Level 2</option>
              <option value="3">Level 3</option>
              <option value="4">Level 4</option>
            </select>
          </div>
          <button class="btn btn-primary" onclick="addParticipant()">Ï∂îÍ∞ÄÌïòÍ∏∞</button>
        </div>
      </div>
    </div>

    <!-- Bottom Sheet: Í∞ïÏäµÏÉù ÏùºÏ†ï Ïã†Ï≤≠ -->
    <div class="bottom-sheet-overlay" id="sheet-register">
      <div class="bottom-sheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-content">
          <div class="bottom-sheet-title">ÏùºÏ†ï Ïã†Ï≤≠</div>
          <div class="input-group">
            <label class="input-label">Ï∞∏Í∞Ä Î™©Ï†Å</label>
            <div class="purpose-buttons">
              <button class="purpose-btn selected" data-purpose="Í∞ïÏäµ" onclick="selectRegisterPurpose(this)">Í∞ïÏäµ</button>
              <button class="purpose-btn" data-purpose="ÌéÄÎã§Ïù¥Îπô" onclick="selectRegisterPurpose(this)">ÌéÄÎã§Ïù¥Îπô</button>
            </div>
          </div>
          <div class="input-group" id="register-level-group">
            <label class="input-label">ÏàòÍ∞ï Î†àÎ≤®</label>
            <select class="input" id="register-level">
              <option value="2">Level 2</option>
              <option value="3">Level 3</option>
              <option value="4">Level 4</option>
            </select>
          </div>
          <button class="btn btn-primary" onclick="registerSchedule()">Ïã†Ï≤≠ÌïòÍ∏∞</button>
        </div>
      </div>
    </div>

    <!-- Bottom Sheet: ÏµúÍ∑º ÏùºÏ†ï ÏÑ†ÌÉù (Í∞ïÏÇ¨Ïö©) -->
    <div class="bottom-sheet-overlay" id="sheet-select-schedule">
      <div class="bottom-sheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-content">
          <div class="bottom-sheet-title">ÏùºÏ†ï ÏÑ†ÌÉù</div>
          <div id="recent-schedule-list" style="max-height: 300px; overflow-y: auto;"></div>
        </div>
      </div>
    </div>

    <!-- Bottom Sheet: Í∞úÏù∏ Í∏∞Î°ù Ï∂îÍ∞Ä (ÎÇ†Ïßú/Ïû•ÏÜå ÏûÖÎ†•) -->
    <div class="bottom-sheet-overlay" id="sheet-personal-add">
      <div class="bottom-sheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-content">
          <div class="bottom-sheet-title">Í∞úÏù∏ Í∏∞Î°ù Ï∂îÍ∞Ä</div>
          <div class="input-group">
            <label class="input-label">ÎÇ†Ïßú *</label>
            <input type="date" class="input" id="personal-add-date">
          </div>
          <div class="input-group">
            <label class="input-label">ÏãúÍ∞Ñ</label>
            <input type="time" class="input" id="personal-add-time">
          </div>
          <div class="input-group">
            <label class="input-label">Ïû•ÏÜå</label>
            <input type="text" class="input" id="personal-add-location" placeholder="Ïû•ÏÜåÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
          </div>
          <div class="input-group">
            <label class="input-label">Ï¢ÖÎ™© ÏÑ†ÌÉù</label>
            <div style="display: flex; flex-wrap: wrap; gap: 8px;" id="personal-discipline-checks">
              <label style="display: flex; align-items: center; gap: 4px;">
                <input type="checkbox" value="STA" checked> STA
              </label>
              <label style="display: flex; align-items: center; gap: 4px;">
                <input type="checkbox" value="DYNB" checked> DYNB
              </label>
              <label style="display: flex; align-items: center; gap: 4px;">
                <input type="checkbox" value="FIM" checked> FIM
              </label>
              <label style="display: flex; align-items: center; gap: 4px;">
                <input type="checkbox" value="CWTB" checked> CWTB
              </label>
              <label style="display: flex; align-items: center; gap: 4px;">
                <input type="checkbox" value="DNF"> DNF
              </label>
              <label style="display: flex; align-items: center; gap: 4px;">
                <input type="checkbox" value="CNF"> CNF
              </label>
              <label style="display: flex; align-items: center; gap: 4px;">
                <input type="checkbox" value="DYN"> DYN
              </label>
              <label style="display: flex; align-items: center; gap: 4px;">
                <input type="checkbox" value="CWT"> CWT
              </label>
            </div>
          </div>
          <button class="btn btn-primary" onclick="startPersonalRecordInput()">Îã§Ïùå: Í∏∞Î°ù ÏûÖÎ†•</button>
          <button class="btn btn-secondary" style="margin-top: 8px;" onclick="closeBottomSheet('sheet-personal-add')">Ï∑®ÏÜå</button>
        </div>
      </div>
    </div>

    <!-- Bottom Sheet: Ï¢ÖÎ™© Ï∂îÍ∞Ä -->
    <div class="bottom-sheet-overlay" id="sheet-add-discipline">
      <div class="bottom-sheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-content">
          <div class="bottom-sheet-title">Ï¢ÖÎ™© Ï∂îÍ∞Ä</div>
          <div style="display: flex; flex-wrap: wrap; gap: 12px;" id="add-discipline-options"></div>
          <button class="btn btn-primary" style="margin-top: 16px;" onclick="confirmAddDiscipline()">Ï∂îÍ∞ÄÌïòÍ∏∞</button>
          <button class="btn btn-secondary" style="margin-top: 8px;" onclick="closeBottomSheet('sheet-add-discipline')">Ï∑®ÏÜå</button>
        </div>
      </div>
    </div>

    <!-- Bottom Sheet: ÏùºÍ¥Ñ Ï¢ÖÎ™© Ï∂îÍ∞Ä -->
    <div class="bottom-sheet-overlay" id="sheet-bulk-add-discipline">
      <div class="bottom-sheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-content">
          <div class="bottom-sheet-title">Ï¢ÖÎ™© Ï∂îÍ∞Ä</div>
          <div style="display: flex; flex-wrap: wrap; gap: 12px;" id="bulk-add-discipline-options"></div>
          <button class="btn btn-primary" style="margin-top: 16px;" onclick="confirmBulkAddDiscipline()">Ï∂îÍ∞ÄÌïòÍ∏∞</button>
          <button class="btn btn-secondary" style="margin-top: 8px;" onclick="closeBottomSheet('sheet-bulk-add-discipline')">Ï∑®ÏÜå</button>
        </div>
      </div>
    </div>

    <!-- Bottom Sheet: Í∞ïÏäµ Ï¢ÖÎ™© Ï∂îÍ∞Ä -->
    <div class="bottom-sheet-overlay" id="sheet-batch-add-discipline">
      <div class="bottom-sheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-content">
          <div class="bottom-sheet-title">Ï¢ÖÎ™© Ï∂îÍ∞Ä</div>
          <div style="display: flex; flex-wrap: wrap; gap: 12px;" id="batch-add-discipline-options"></div>
          <button class="btn btn-primary" style="margin-top: 16px;" onclick="confirmBatchAddDiscipline()">Ï∂îÍ∞ÄÌïòÍ∏∞</button>
          <button class="btn btn-secondary" style="margin-top: 8px;" onclick="closeBottomSheet('sheet-batch-add-discipline')">Ï∑®ÏÜå</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==================== Supabase Ï¥àÍ∏∞Ìôî ====================
    const SUPABASE_URL = 'https://dnndjqlbjudnjpwescfl.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRubmRqcWxianVkbmpwd2VzY2ZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5MzE2NzMsImV4cCI6MjA4MTUwNzY3M30.0x3vKhKzZyn5MPDSoNJgbOvU-LGZ7q34N44DjWLQWz0';
    
    // Supabase ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ ÏÉùÏÑ± (dbÎ°ú Î™ÖÎ™ÖÌïòÏó¨ Ï∂©Îèå Î∞©ÏßÄ)
    const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ==================== Ï†ÑÏó≠ Î≥ÄÏàò ====================
    let currentUser = null;
    let currentScheduleId = null;
    let currentRegId = null;
    let allSchedules = [];
    let screenHistory = [];
    let skillsDonutChart = null;
    let recordsDonutChart = null;

    // ==================== Ï¥àÍ∏∞Ìôî ====================
    document.addEventListener('DOMContentLoaded', function() {
      const phoneInput = document.getElementById('login-phone');
      
      // Ï†ÑÌôîÎ≤àÌò∏ ÏûêÎèô Ìè¨Îß∑ÌåÖ
      phoneInput.addEventListener('input', function(e) {
        // Ïà´ÏûêÎßå Ï∂îÏ∂ú
        let v = e.target.value.replace(/\D/g, '');
        
        // 11ÏûêÎ¶¨ Ï†úÌïú
        if (v.length > 11) v = v.slice(0, 11);
        
        // ÌïòÏù¥Ìîà Ï∂îÍ∞Ä
        if (v.length > 3 && v.length <= 7) {
          v = v.slice(0, 3) + '-' + v.slice(3);
        } else if (v.length > 7) {
          v = v.slice(0, 3) + '-' + v.slice(3, 7) + '-' + v.slice(7);
        }
        
        e.target.value = v;
      });

      const overlays = document.querySelectorAll('.bottom-sheet-overlay');
      overlays.forEach(overlay => {
        overlay.addEventListener('click', function(e) {
          if (e.target === this) closeBottomSheet(this.id);
        });
      });
    });

    // ==================== Ïú†Ìã∏Î¶¨Ìã∞ Ìï®Ïàò ====================
    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 3000);
    }

    function showScreen(id) {
      const currentScreen = document.querySelector('.screen.active');
      if (currentScreen && currentScreen.id !== id) {
        screenHistory.push(currentScreen.id);
      }
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      window.scrollTo(0, 0);
      
      // ÌôîÎ©¥Î≥Ñ Î°úÎìú Ìï®Ïàò Ìò∏Ï∂ú
      if (id === 'screen-instructor-home') loadInstructorDashboard();
      else if (id === 'screen-student-home') loadStudentDashboard();
      else if (id === 'screen-mypage') loadMypage();
      else if (id === 'screen-schedule-manage') loadScheduleManage();
      else if (id === 'screen-student-schedule') loadStudentSchedule();
      else if (id === 'screen-my-records') loadMyRecords();
    }

    function goBack() {
      if (screenHistory.length > 0) {
        const prevScreen = screenHistory.pop();
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(prevScreen).classList.add('active');
      } else {
        if (currentUser && currentUser.user_type === 'Í∞ïÏÇ¨') showScreen('screen-instructor-home');
        else showScreen('screen-student-home');
      }
    }

    function openBottomSheet(id) {
      document.getElementById(id).classList.add('active');
    }

    function closeBottomSheet(id) {
      document.getElementById(id).classList.remove('active');
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      const d = new Date(dateStr);
      const days = ['Ïùº', 'Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†'];
      return (d.getMonth()+1) + 'Ïõî ' + d.getDate() + 'Ïùº (' + days[d.getDay()] + ')';
    }

    function formatTime(timeStr) {
      if (!timeStr) return '';
      const parts = timeStr.split(':');
      const h = parseInt(parts[0]);
      const m = parts[1];
      return (h < 12 ? 'Ïò§Ï†Ñ ' : 'Ïò§ÌõÑ ') + (h > 12 ? h - 12 : h) + ':' + m;
    }

    // ==================== Î°úÍ∑∏Ïù∏/Î°úÍ∑∏ÏïÑÏõÉ ====================
    async function handleLogin() {
      const phone = document.getElementById('login-phone').value;
      
      // Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨: 010-0000-0000 ÌòïÏãù (13Ïûê)
      if (!phone || phone.length < 13) {
        showToast('Ïó∞ÎùΩÏ≤òÎ•º Ï†ïÌôïÌûà ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî');
        return;
      }
      
      console.log('Î°úÍ∑∏Ïù∏ ÏãúÎèÑ:', phone);
      
      try {
        // SupabaseÏóêÏÑú ÏÇ¨Ïö©Ïûê Ï°∞Ìöå
        const { data, error } = await db
          .from('users')
          .select('*')
          .eq('phone', phone)
          .single();
        
        console.log('Supabase ÏùëÎãµ:', { data, error });
        
        if (error) {
          console.error('Supabase ÏóêÎü¨:', error);
          showToast('Îì±Î°ùÎêòÏßÄ ÏïäÏùÄ Ïó∞ÎùΩÏ≤òÏûÖÎãàÎã§.');
          return;
        }
        
        if (!data) {
          showToast('Îì±Î°ùÎêòÏßÄ ÏïäÏùÄ Ïó∞ÎùΩÏ≤òÏûÖÎãàÎã§.');
          return;
        }
        
        currentUser = data;
        console.log('Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µ:', currentUser);
        
        if (currentUser.user_type === 'Í∞ïÏÇ¨') {
          showScreen('screen-instructor-home');
        } else {
          showScreen('screen-student-home');
        }
      } catch (err) {
        console.error('Î°úÍ∑∏Ïù∏ Ïò§Î•ò:', err);
        showToast('Î°úÍ∑∏Ïù∏ Ïã§Ìå®: ' + err.message);
      }
    }

    function logout() {
      currentUser = null;
      screenHistory = [];
      showScreen('screen-login');
      document.getElementById('login-phone').value = '';
    }

    // ==================== Í∞ïÏÇ¨ ÎåÄÏãúÎ≥¥Îìú ====================
    async function loadInstructorDashboard() {
      document.getElementById('instructor-name').textContent = currentUser.name;
      await loadTodaySchedules();
      await loadInstructorStats();
    }

    async function loadTodaySchedules() {
      try {
        const today = new Date().toISOString().split('T')[0];
        
        // Ïò§Îäò ÏùºÏ†ï Ï°∞Ìöå
        const { data: schedules, error } = await db
          .from('schedules')
          .select('*')
          .eq('instructor_id', currentUser.user_id)
          .eq('date', today);
        
        if (error) throw error;
        
        const container = document.getElementById('today-schedules');
        
        if (!schedules || schedules.length === 0) {
          container.innerHTML = '<div class="card" style="text-align: center; color: var(--text-secondary);">Ïò§Îäò ÏùºÏ†ïÏù¥ ÏóÜÏäµÎãàÎã§</div>';
          return;
        }
        
        // Í∞Å ÏùºÏ†ïÏóê Ï∞∏Í∞ÄÏûê Ïàò Ï∂îÍ∞Ä
        let html = '';
        for (const s of schedules) {
          // Ï∞∏Í∞ÄÏûê Ïàò Ï°∞Ìöå
          const { count } = await db
            .from('registrations')
            .select('*', { count: 'exact', head: true })
            .eq('schedule_id', s.schedule_id);
          
          html += `<div class="card schedule-card" style="cursor:pointer;" onclick="openParticipants('${s.schedule_id}')">`;
          html += '<div class="schedule-info">';
          html += `<div class="schedule-time">${formatTime(s.time)} ¬∑ ${s.location}</div>`;
          html += `<div class="schedule-meta">Ï∞∏Í∞ÄÏûê ${count || 0}Î™Ö</div>`;
          html += '</div>';
          html += '<i class="fas fa-chevron-right schedule-arrow"></i>';
          html += '</div>';
        }
        
        container.innerHTML = html;
        allSchedules = schedules;
      } catch (err) {
        console.error('ÏùºÏ†ï Î°úÎìú Ïò§Î•ò:', err);
        document.getElementById('today-schedules').innerHTML = '<div class="card" style="text-align: center; color: var(--error);">ÏùºÏ†ïÏùÑ Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§</div>';
      }
    }

    async function loadInstructorStats() {
      try {
        // Ïù¥Î≤à Ï£º ÏãúÏûëÏùº Í≥ÑÏÇ∞
        const now = new Date();
        const weekStart = new Date(now);
        weekStart.setDate(now.getDate() - now.getDay());
        weekStart.setHours(0, 0, 0, 0);
        const weekStartStr = weekStart.toISOString().split('T')[0];
        
        // Ïù¥Î≤à Ï£º ÏùºÏ†ï Ïàò
        const { count: weekLessons } = await db
          .from('schedules')
          .select('*', { count: 'exact', head: true })
          .eq('instructor_id', currentUser.user_id)
          .gte('date', weekStartStr);
        
        // Ïù¥Î≤à Ï£º ÏùºÏ†ï ID Ï°∞Ìöå
        const { data: weekSchedules } = await db
          .from('schedules')
          .select('schedule_id')
          .eq('instructor_id', currentUser.user_id)
          .gte('date', weekStartStr);
        
        let weekStudents = 0;
        let weekRecords = 0;
        
        if (weekSchedules && weekSchedules.length > 0) {
          const scheduleIds = weekSchedules.map(s => s.schedule_id);
          
          // Ïù¥Î≤à Ï£º Ï∞∏Í∞ÄÏûê Ïàò
          const { count: studentCount } = await db
            .from('registrations')
            .select('*', { count: 'exact', head: true })
            .in('schedule_id', scheduleIds);
          weekStudents = studentCount || 0;
          
          // Ïù¥Î≤à Ï£º reg_id Ï°∞Ìöå
          const { data: regs } = await db
            .from('registrations')
            .select('reg_id')
            .in('schedule_id', scheduleIds);
          
          if (regs && regs.length > 0) {
            const regIds = regs.map(r => r.reg_id);
            
            // Ïù¥Î≤à Ï£º Í∏∞Î°ù Ïàò
            const { count: recordCount } = await db
              .from('dive_records')
              .select('*', { count: 'exact', head: true })
              .in('reg_id', regIds);
            weekRecords = recordCount || 0;
          }
        }
        
        document.getElementById('instructor-stats').innerHTML = 
          `Í∞ïÏäµ ${weekLessons || 0}Ìöå ¬∑ Í∞ïÏäµÏÉù ${weekStudents}Î™Ö ¬∑ Í∏∞Î°ù ${weekRecords}Í±¥`;
      } catch (err) {
        console.error('ÌÜµÍ≥Ñ Î°úÎìú Ïò§Î•ò:', err);
        document.getElementById('instructor-stats').innerHTML = 'ÌÜµÍ≥ÑÎ•º Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§';
      }
    }

    // ==================== Í∞ïÏäµÏÉù ÎåÄÏãúÎ≥¥Îìú ====================
    async function loadStudentDashboard() {
      document.getElementById('student-name').textContent = currentUser.name;
      
      // ÏµúÍ≥† Í∏∞Î°ù Ï°∞Ìöå
      await loadBestRecords();
      
      // Îã§Í∞ÄÏò§Îäî ÏùºÏ†ï Ï°∞Ìöå
      await loadUpcomingSchedules();
    }

    async function loadBestRecords() {
      try {
        // ÌïôÏÉùÏùò Îì±Î°ù Î™©Î°ù Ï°∞Ìöå
        const { data: regs } = await db
          .from('registrations')
          .select('reg_id')
          .eq('student_id', currentUser.user_id);
        
        const disciplines = ['STA', 'CWTB', 'DYNB'];
        let bestHtml = '';
        
        if (regs && regs.length > 0) {
          const regIds = regs.map(r => r.reg_id);
          
          for (const disc of disciplines) {
            // Í∞Å Ï¢ÖÎ™©Î≥Ñ ÏµúÍ≥† Í∏∞Î°ù Ï°∞Ìöå
            const { data: records } = await db
              .from('dive_records')
              .select('value')
              .in('reg_id', regIds)
              .eq('discipline', disc)
              .order('value', { ascending: false })
              .limit(1);
            
            let val = '-';
            if (records && records.length > 0) {
              val = disc === 'STA' ? records[0].value : records[0].value + 'm';
            }
            
            bestHtml += `<div class="stat-card">
              <div class="stat-label">${disc}</div>
              <div class="stat-value">${val}</div>
            </div>`;
          }
        } else {
          for (const disc of disciplines) {
            bestHtml += `<div class="stat-card">
              <div class="stat-label">${disc}</div>
              <div class="stat-value">-</div>
            </div>`;
          }
        }
        
        document.getElementById('best-records').innerHTML = bestHtml;
      } catch (err) {
        console.error('ÏµúÍ≥† Í∏∞Î°ù Î°úÎìú Ïò§Î•ò:', err);
      }
    }

    async function loadUpcomingSchedules() {
      try {
        const today = new Date().toISOString().split('T')[0];
        
        // ÌïôÏÉùÏùò Îì±Î°ùÎêú ÏùºÏ†ï Ï°∞Ìöå
        const { data: regs } = await db
          .from('registrations')
          .select(`
            reg_id,
            purpose,
            schedule_id,
            schedules (
              schedule_id,
              date,
              time,
              location
            )
          `)
          .eq('student_id', currentUser.user_id);
        
        const container = document.getElementById('upcoming-schedules');
        
        if (!regs || regs.length === 0) {
          container.innerHTML = '<div class="card" style="text-align: center; color: var(--text-secondary);">ÏòàÏ†ïÎêú ÏùºÏ†ïÏù¥ ÏóÜÏäµÎãàÎã§</div>';
          return;
        }
        
        // ÎØ∏Îûò ÏùºÏ†ïÎßå ÌïÑÌÑ∞ÎßÅ
        const upcoming = regs
          .filter(r => r.schedules && r.schedules.date >= today)
          .sort((a, b) => new Date(a.schedules.date) - new Date(b.schedules.date))
          .slice(0, 3);
        
        if (upcoming.length === 0) {
          container.innerHTML = '<div class="card" style="text-align: center; color: var(--text-secondary);">ÏòàÏ†ïÎêú ÏùºÏ†ïÏù¥ ÏóÜÏäµÎãàÎã§</div>';
          return;
        }
        
        let html = '';
        for (const r of upcoming) {
          const s = r.schedules;
          html += `<div class="card schedule-card">
            <div class="schedule-info">
              <div class="schedule-time">${formatDate(s.date)} ${formatTime(s.time)}</div>
              <div class="schedule-location">${s.location} ¬∑ ${r.purpose}</div>
            </div>
            <i class="fas fa-chevron-right schedule-arrow"></i>
          </div>`;
        }
        
        container.innerHTML = html;
      } catch (err) {
        console.error('ÏùºÏ†ï Î°úÎìú Ïò§Î•ò:', err);
        document.getElementById('upcoming-schedules').innerHTML = '<div class="card" style="text-align: center; color: var(--error);">ÏùºÏ†ïÏùÑ Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§</div>';
      }
    }

    // ==================== ÎßàÏù¥ÌéòÏù¥ÏßÄ ====================
    function loadMypage() {
      document.getElementById('mypage-avatar').textContent = currentUser.name ? currentUser.name.charAt(0) : '?';
      document.getElementById('mypage-name').textContent = currentUser.name;
      document.getElementById('mypage-phone').textContent = currentUser.phone;
      document.getElementById('mypage-info').textContent = 'Level ' + (currentUser.cert_level === 'X' ? '1' : currentUser.cert_level) + ' ¬∑ ' + currentUser.user_type;
    }

    // ==================== ÏùºÏ†ï Í¥ÄÎ¶¨ (Í∞ïÏÇ¨) ====================
    async function loadScheduleManage() {
      try {
        const { data: schedules, error } = await db
          .from('schedules')
          .select('*')
          .eq('instructor_id', currentUser.user_id)
          .order('date', { ascending: false });
        
        if (error) throw error;
        
        allSchedules = schedules || [];
        renderScheduleList();
      } catch (err) {
        console.error('ÏùºÏ†ï Î°úÎìú Ïò§Î•ò:', err);
        document.getElementById('schedule-list').innerHTML = 
          '<div class="card" style="text-align: center; color: var(--error);">ÏùºÏ†ïÏùÑ Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§</div>';
      }
    }

    async function renderScheduleList() {
      const container = document.getElementById('schedule-list');
      
      if (allSchedules.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="fas fa-calendar-times"></i><p>ÏùºÏ†ïÏù¥ ÏóÜÏäµÎãàÎã§</p></div>';
        return;
      }
      
      let html = '';
      for (const s of allSchedules) {
        // Ï∞∏Í∞ÄÏûê Ïàò Ï°∞Ìöå
        const { count } = await db
          .from('registrations')
          .select('*', { count: 'exact', head: true })
          .eq('schedule_id', s.schedule_id);
        
        html += `<div class="card">
          <div class="schedule-card" style="margin-bottom: 12px;">
            <div class="schedule-info">
              <div class="schedule-time">${formatDate(s.date)} ${formatTime(s.time)}</div>
              <div class="schedule-location">${s.location} ¬∑ Ï∞∏Í∞ÄÏûê ${count || 0}Î™Ö</div>
            </div>
          </div>
          <div style="display: flex; gap: 8px; margin-bottom: 12px;">
            <button class="btn btn-secondary btn-small" style="flex: 1;" onclick="openParticipants('${s.schedule_id}')">
              <i class="fas fa-users"></i> Ï∞∏Í∞ÄÏûê
            </button>
            <button class="btn btn-primary btn-small" style="flex: 1;" onclick="openLessonRecordInput('${s.schedule_id}')">
              <i class="fas fa-pen"></i> Í∏∞Î°ù ÏûÖÎ†•
            </button>
          </div>
          <div style="display: flex; gap: 8px; padding-top: 12px; border-top: 1px solid var(--divider);">
            <button class="btn btn-outline btn-small" style="flex: 1;" onclick="openScheduleForm('${s.schedule_id}')">
              <i class="fas fa-edit"></i> ÏàòÏ†ï
            </button>
            <button class="btn btn-danger btn-small" style="flex: 1;" onclick="deleteSchedule('${s.schedule_id}')">
              <i class="fas fa-trash"></i> ÏÇ≠Ï†ú
            </button>
          </div>
        </div>`;
      }
      
      container.innerHTML = html;
    }

    async function deleteSchedule(scheduleId) {
      if (!confirm('Ïù¥ ÏùºÏ†ïÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå? Í¥ÄÎ†® Ï∞∏Í∞ÄÏûê Ï†ïÎ≥¥ÎèÑ Ìï®Íªò ÏÇ≠Ï†úÎê©ÎãàÎã§.')) return;
      
      try {
        // Î®ºÏ†Ä Í¥ÄÎ†® Í∏∞Î°ù ÏÇ≠Ï†ú
        const { data: regs } = await db
          .from('registrations')
          .select('reg_id')
          .eq('schedule_id', scheduleId);
        
        if (regs && regs.length > 0) {
          const regIds = regs.map(r => r.reg_id);
          await db.from('dive_records').delete().in('reg_id', regIds);
          await db.from('skill_records').delete().in('reg_id', regIds);
          await db.from('registrations').delete().eq('schedule_id', scheduleId);
        }
        
        // ÏùºÏ†ï ÏÇ≠Ï†ú
        const { error } = await db
          .from('schedules')
          .delete()
          .eq('schedule_id', scheduleId);
        
        if (error) throw error;
        
        showToast('ÏùºÏ†ïÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§');
        loadScheduleManage();
      } catch (err) {
        console.error('ÏùºÏ†ï ÏÇ≠Ï†ú Ïò§Î•ò:', err);
        showToast('ÏÇ≠Ï†ú Ïã§Ìå®: ' + err.message);
      }
    }

    function openScheduleForm(scheduleId) {
      document.getElementById('schedule-form-title').textContent = scheduleId ? 'ÏùºÏ†ï ÏàòÏ†ï' : 'ÏÉà ÏùºÏ†ï Îì±Î°ù';
      document.getElementById('edit-schedule-id').value = scheduleId || '';
      
      if (scheduleId) {
        const s = allSchedules.find(x => x.schedule_id === scheduleId);
        if (s) {
          document.getElementById('schedule-date').value = s.date;
          document.getElementById('schedule-time').value = s.time;
          document.getElementById('schedule-location').value = s.location;
        }
      } else {
        document.getElementById('schedule-date').value = '';
        document.getElementById('schedule-time').value = '';
        document.getElementById('schedule-location').value = '';
      }
      
      openBottomSheet('sheet-schedule');
    }

    async function saveSchedule() {
      const scheduleId = document.getElementById('edit-schedule-id').value;
      const date = document.getElementById('schedule-date').value;
      const time = document.getElementById('schedule-time').value;
      const location = document.getElementById('schedule-location').value;
      
      if (!date || !time || !location) {
        showToast('Î™®Îì† Ìï≠Î™©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî');
        return;
      }
      
      try {
        if (scheduleId) {
          // ÏàòÏ†ï
          const { error } = await db
            .from('schedules')
            .update({ date, time, location })
            .eq('schedule_id', scheduleId);
          
          if (error) throw error;
          showToast('ÏùºÏ†ïÏù¥ ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§');
        } else {
          // ÏÉàÎ°ú ÏÉùÏÑ±
          const newId = 'SCH_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
          const { error } = await db
            .from('schedules')
            .insert({
              schedule_id: newId,
              instructor_id: currentUser.user_id,
              date,
              time,
              location
            });
          
          if (error) throw error;
          showToast('ÏùºÏ†ïÏù¥ Îì±Î°ùÎêòÏóàÏäµÎãàÎã§');
        }
        
        closeBottomSheet('sheet-schedule');
        loadScheduleManage();
        loadTodaySchedules();
      } catch (err) {
        console.error('ÏùºÏ†ï Ï†ÄÏû• Ïò§Î•ò:', err);
        showToast('Ï†ÄÏû• Ïã§Ìå®: ' + err.message);
      }
    }

    // ==================== Ï∞∏Í∞ÄÏûê Í¥ÄÎ¶¨ ====================
    async function openParticipants(scheduleId) {
      currentScheduleId = scheduleId;
      const s = allSchedules.find(x => x.schedule_id === scheduleId);
      
      if (s) {
        document.getElementById('participant-schedule-date').textContent = formatDate(s.date) + ' ' + formatTime(s.time);
        document.getElementById('participant-schedule-location').textContent = s.location;
      }
      
      showScreen('screen-participants');
      await loadParticipants();
    }

    async function loadParticipants() {
      try {
        // Ï∞∏Í∞ÄÏûê Î™©Î°ù Ï°∞Ìöå (users ÌÖåÏù¥Î∏îÍ≥º Ï°∞Ïù∏)
        const { data: regs, error } = await db
          .from('registrations')
          .select(`
            reg_id,
            student_id,
            purpose,
            lesson_level,
            attendance,
            users!registrations_student_id_fkey (
              user_id,
              name,
              cert_level
            )
          `)
          .eq('schedule_id', currentScheduleId);
        
        if (error) throw error;
        
        const lessons = [];
        const funs = [];
        
        for (const r of (regs || [])) {
          const participant = {
            reg_id: r.reg_id,
            student_id: r.student_id,
            purpose: r.purpose,
            lesson_level: r.lesson_level,
            attendance: r.attendance,
            student_name: r.users?.name || 'Ïïå Ïàò ÏóÜÏùå',
            student_cert: r.users?.cert_level || 'X'
          };
          
          if (r.purpose === 'Í∞ïÏäµ') lessons.push(participant);
          else funs.push(participant);
        }
        
        document.getElementById('lesson-participants').innerHTML = lessons.length === 0 
          ? '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">Í∞ïÏäµ Ï∞∏Í∞ÄÏûêÍ∞Ä ÏóÜÏäµÎãàÎã§</div>'
          : lessons.map(p => renderParticipantCard(p)).join('');
        
        document.getElementById('fun-participants').innerHTML = funs.length === 0
          ? '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">ÌéÄÎã§Ïù¥Îπô Ï∞∏Í∞ÄÏûêÍ∞Ä ÏóÜÏäµÎãàÎã§</div>'
          : funs.map(p => renderParticipantCard(p)).join('');
          
      } catch (err) {
        console.error('Ï∞∏Í∞ÄÏûê Î°úÎìú Ïò§Î•ò:', err);
        document.getElementById('lesson-participants').innerHTML = 
          '<div style="text-align: center; color: var(--error); padding: 20px;">Ï∞∏Í∞ÄÏûêÎ•º Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§</div>';
      }
    }

    function renderParticipantCard(p) {
      const attClass = p.attendance === 'Y' ? 'attendance-yes' : p.attendance === 'N' ? 'attendance-no' : 'attendance-pending';
      const attText = p.attendance === 'Y' ? 'Ï∂úÏÑù' : p.attendance === 'N' ? 'Î∂àÏ∞∏' : 'ÎØ∏Ï†ï';
      
      return `<div class="participant-card">
        <div class="participant-avatar">${p.student_name ? p.student_name.charAt(0) : '?'}</div>
        <div class="participant-info">
          <div class="participant-name">${p.student_name}</div>
          <div class="participant-detail">Lv.${p.student_cert || 'X'}${p.lesson_level ? ' ¬∑ Lv.' + p.lesson_level + ' ÏàòÍ∞ïÏ§ë' : ''}</div>
        </div>
        <div class="attendance-badge ${attClass}" onclick="toggleAttendance('${p.reg_id}', '${p.attendance}')" style="cursor: pointer;">${attText}</div>
        <button class="btn-icon-delete" onclick="deleteParticipant('${p.reg_id}')" title="ÏÇ≠Ï†ú">
          <i class="fas fa-times"></i>
        </button>
      </div>`;
    }

    async function deleteParticipant(regId) {
      if (!confirm('Ïù¥ Ï∞∏Í∞ÄÏûêÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
      
      try {
        // Í¥ÄÎ†® Í∏∞Î°ù ÏÇ≠Ï†ú
        await db.from('dive_records').delete().eq('reg_id', regId);
        await db.from('skill_records').delete().eq('reg_id', regId);
        
        // Ï∞∏Í∞ÄÏûê ÏÇ≠Ï†ú
        const { error } = await db
          .from('registrations')
          .delete()
          .eq('reg_id', regId);
        
        if (error) throw error;
        
        showToast('Ï∞∏Í∞ÄÏûêÍ∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§');
        loadParticipants();
      } catch (err) {
        console.error('Ï∞∏Í∞ÄÏûê ÏÇ≠Ï†ú Ïò§Î•ò:', err);
        showToast('ÏÇ≠Ï†ú Ïã§Ìå®: ' + err.message);
      }
    }

    async function toggleAttendance(regId, currentStatus) {
      const nextStatus = currentStatus === 'Y' ? 'N' : currentStatus === 'N' ? 'ÎØ∏Ï†ï' : 'Y';
      
      try {
        const { error } = await db
          .from('registrations')
          .update({ attendance: nextStatus })
          .eq('reg_id', regId);
        
        if (error) throw error;
        await loadParticipants();
      } catch (err) {
        console.error('Ï∂úÏÑù Î≥ÄÍ≤Ω Ïò§Î•ò:', err);
        showToast('Ï∂úÏÑù Î≥ÄÍ≤Ω Ïã§Ìå®');
      }
    }

    async function openAddParticipant() {
      try {
        // Í∞ïÏäµÏÉù Î™©Î°ù Ï°∞Ìöå
        const { data: students, error } = await db
          .from('users')
          .select('user_id, name, phone')
          .eq('user_type', 'Í∞ïÏäµÏÉù');
        
        if (error) throw error;
        
        const select = document.getElementById('participant-student');
        let html = '<option value="">Í∞ïÏäµÏÉùÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>';
        for (const s of (students || [])) {
          html += `<option value="${s.user_id}">${s.name} (${s.phone})</option>`;
        }
        select.innerHTML = html;
        
        openBottomSheet('sheet-add-participant');
      } catch (err) {
        console.error('Í∞ïÏäµÏÉù Î™©Î°ù Î°úÎìú Ïò§Î•ò:', err);
        showToast('Í∞ïÏäµÏÉù Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§');
      }
    }

    function selectPurpose(btn) {
      document.querySelectorAll('#sheet-add-participant .purpose-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      document.getElementById('lesson-level-group').style.display = btn.dataset.purpose === 'Í∞ïÏäµ' ? 'block' : 'none';
    }

    async function addParticipant() {
      const studentId = document.getElementById('participant-student').value;
      const purposeBtn = document.querySelector('#sheet-add-participant .purpose-btn.selected');
      const purpose = purposeBtn.dataset.purpose;
      const level = purpose === 'Í∞ïÏäµ' ? parseInt(document.getElementById('participant-level').value) : null;
      
      if (!studentId) {
        showToast('Í∞ïÏäµÏÉùÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî');
        return;
      }
      
      try {
        const regId = 'REG_' + studentId + '_' + Date.now();
        const { error } = await db
          .from('registrations')
          .insert({
            reg_id: regId,
            schedule_id: currentScheduleId,
            student_id: studentId,
            purpose,
            lesson_level: level,
            attendance: 'Y'
          });
        
        if (error) throw error;
        
        showToast('Ï∞∏Í∞ÄÏûêÍ∞Ä Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§');
        closeBottomSheet('sheet-add-participant');
        await loadParticipants();
      } catch (err) {
        console.error('Ï∞∏Í∞ÄÏûê Ï∂îÍ∞Ä Ïò§Î•ò:', err);
        showToast('Ï∂îÍ∞Ä Ïã§Ìå®: ' + (err.message || 'Ïù¥ÎØ∏ Îì±Î°ùÎêú Ï∞∏Í∞ÄÏûêÏùº Ïàò ÏûàÏäµÎãàÎã§'));
      }
    }

    // ==================== Í∞ïÏäµÏÉù ÏùºÏ†ï ====================
    async function loadStudentSchedule() {
      try {
        const today = new Date().toISOString().split('T')[0];
        
        // Ïó¥Î¶∞ ÏùºÏ†ï Ï°∞Ìöå
        const { data: schedules, error } = await db
          .from('schedules')
          .select(`
            schedule_id,
            date,
            time,
            location,
            instructor_id,
            users!schedules_instructor_id_fkey (name)
          `)
          .gte('date', today)
          .order('date', { ascending: true });
        
        if (error) throw error;
        
        // ÎÇ¥Í∞Ä Ïù¥ÎØ∏ Ïã†Ï≤≠Ìïú ÏùºÏ†ï Ï°∞Ìöå
        const { data: myRegs } = await db
          .from('registrations')
          .select('schedule_id, purpose')
          .eq('student_id', currentUser.user_id);
        
        const myScheduleIds = myRegs ? myRegs.map(r => r.schedule_id) : [];
        
        const container = document.getElementById('available-schedules');
        
        if (!schedules || schedules.length === 0) {
          container.innerHTML = '<div class="card" style="text-align: center; color: var(--text-secondary);">ÏòàÏ†ïÎêú ÏùºÏ†ïÏù¥ ÏóÜÏäµÎãàÎã§</div>';
          return;
        }
        
        let html = '';
        for (const s of schedules) {
          const isRegistered = myScheduleIds.includes(s.schedule_id);
          const myReg = myRegs ? myRegs.find(r => r.schedule_id === s.schedule_id) : null;
          
          html += `<div class="card schedule-card">
            <div class="schedule-info">
              <div class="schedule-time">${formatDate(s.date)} ${formatTime(s.time)}</div>
              <div class="schedule-location">${s.location} ¬∑ ${s.users?.name || 'Í∞ïÏÇ¨'}</div>
            </div>
            ${isRegistered 
              ? `<span class="my-schedule-badge" style="cursor: pointer;" onclick="cancelRegistration('${myReg?.reg_id}')">${myReg?.purpose === 'ÌéÄÎã§Ïù¥Îπô' ? 'ÌéÄÎã§Ïù¥Îπô' : 'Í∞ïÏäµ'} Ïã†Ï≤≠ÏôÑÎ£å</span>` 
              : `<button class="btn btn-small btn-primary" onclick="openRegisterSheet('${s.schedule_id}')">Ïã†Ï≤≠</button>`
            }
          </div>`;
        }
        
        container.innerHTML = html;
      } catch (err) {
        console.error('ÏùºÏ†ï Î°úÎìú Ïò§Î•ò:', err);
        document.getElementById('available-schedules').innerHTML = 
          '<div class="card" style="text-align: center; color: var(--error);">ÏùºÏ†ïÏùÑ Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§</div>';
      }
    }

    let pendingScheduleId = null;
    
    function openRegisterSheet(scheduleId) {
      pendingScheduleId = scheduleId;
      // Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï
      document.querySelectorAll('#sheet-register .purpose-btn').forEach(b => b.classList.remove('selected'));
      document.querySelector('#sheet-register .purpose-btn[data-purpose="Í∞ïÏäµ"]').classList.add('selected');
      document.getElementById('register-level-group').style.display = 'block';
      document.getElementById('register-level').value = currentUser.in_training_level || '2';
      openBottomSheet('sheet-register');
    }
    
    function selectRegisterPurpose(btn) {
      document.querySelectorAll('#sheet-register .purpose-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      document.getElementById('register-level-group').style.display = btn.dataset.purpose === 'Í∞ïÏäµ' ? 'block' : 'none';
    }

    async function registerSchedule() {
      const purposeBtn = document.querySelector('#sheet-register .purpose-btn.selected');
      const purpose = purposeBtn.dataset.purpose;
      const level = purpose === 'Í∞ïÏäµ' ? parseInt(document.getElementById('register-level').value) : null;
      
      try {
        const regId = 'REG_' + currentUser.user_id + '_' + Date.now();
        const { error } = await db
          .from('registrations')
          .insert({
            reg_id: regId,
            schedule_id: pendingScheduleId,
            student_id: currentUser.user_id,
            purpose,
            lesson_level: level,
            attendance: 'Y'
          });
        
        if (error) throw error;
        
        showToast('ÏùºÏ†ï Ïã†Ï≤≠ ÏôÑÎ£å!');
        closeBottomSheet('sheet-register');
        loadStudentSchedule();
        loadUpcomingSchedules();
      } catch (err) {
        console.error('ÏùºÏ†ï Ïã†Ï≤≠ Ïò§Î•ò:', err);
        showToast('Ïã†Ï≤≠ Ïã§Ìå®: ' + (err.message || 'Ïù¥ÎØ∏ Ïã†Ï≤≠ÌñàÏùÑ Ïàò ÏûàÏäµÎãàÎã§'));
      }
    }

    async function cancelRegistration(regId) {
      if (!confirm('ÏùºÏ†ï Ïã†Ï≤≠ÏùÑ Ï∑®ÏÜåÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
      
      try {
        const { error } = await db
          .from('registrations')
          .delete()
          .eq('reg_id', regId);
        
        if (error) throw error;
        
        showToast('Ïã†Ï≤≠Ïù¥ Ï∑®ÏÜåÎêòÏóàÏäµÎãàÎã§');
        loadStudentSchedule();
        loadUpcomingSchedules();
      } catch (err) {
        console.error('Ïã†Ï≤≠ Ï∑®ÏÜå Ïò§Î•ò:', err);
        showToast('Ï∑®ÏÜå Ïã§Ìå®: ' + err.message);
      }
    }

    // ==================== ÎÇòÏùò Í∏∞Î°ù ====================
    async function loadMyRecords() {
      // ÌÉ≠Î∞î Î†åÎçîÎßÅ
      const isInstructor = currentUser.user_type === 'Í∞ïÏÇ¨';
      document.getElementById('my-records-tabbar').innerHTML = `
        <button class="tab-item" onclick="showScreen('${isInstructor ? 'screen-instructor-home' : 'screen-student-home'}')"><i class="fas fa-home"></i><span>Ìôà</span></button>
        <button class="tab-item" onclick="showScreen('${isInstructor ? 'screen-schedule-manage' : 'screen-student-schedule'}')"><i class="fas fa-calendar"></i><span>ÏùºÏ†ï</span></button>
        <button class="tab-item active"><i class="fas fa-chart-line"></i><span>ÎÇ¥Í∏∞Î°ù</span></button>
        <button class="tab-item" onclick="showScreen('screen-mypage')"><i class="fas fa-user"></i><span>ÎßàÏù¥</span></button>
      `;
      
      try {
        let allRecords = [];
        
        // 1. Í∞ïÏäµ Í∏∞Î°ù Ï°∞Ìöå (registrations ‚Üí dive_records)
        const { data: regs } = await db
          .from('registrations')
          .select('reg_id, schedule_id')
          .eq('student_id', currentUser.user_id);
        
        if (regs && regs.length > 0) {
          const regIds = regs.map(r => r.reg_id);
          const scheduleIds = regs.map(r => r.schedule_id);
          
          // ÏùºÏ†ï ÎÇ†Ïßú Ï°∞Ìöå
          const { data: schedules } = await db
            .from('schedules')
            .select('schedule_id, date')
            .in('schedule_id', scheduleIds);
          
          const scheduleMap = {};
          for (const s of (schedules || [])) {
            scheduleMap[s.schedule_id] = s.date;
          }
          
          // reg_id ‚Üí schedule_id Îß§Ìïë
          const regToSchedule = {};
          for (const r of regs) {
            regToSchedule[r.reg_id] = r.schedule_id;
          }
          
          // Í∞ïÏäµ Í∏∞Î°ù
          const { data: lessonRecords } = await db
            .from('dive_records')
            .select('record_id, reg_id, discipline, attempt, value, note')
            .in('reg_id', regIds);
          
          for (const r of (lessonRecords || [])) {
            const scheduleId = regToSchedule[r.reg_id];
            const date = scheduleMap[scheduleId] || 'ÎÇ†Ïßú ÏóÜÏùå';
            allRecords.push({
              ...r,
              date,
              type: 'Í∞ïÏäµ'
            });
          }
        }
        
        // 2. Í∞úÏù∏ Í∏∞Î°ù Ï°∞Ìöå (personal_dive_records)
        const { data: personalRecords } = await db
          .from('personal_dive_records')
          .select(`
            record_id,
            personal_schedule_id,
            discipline,
            attempt,
            value,
            personal_schedules!personal_dive_records_personal_schedule_id_fkey (date)
          `)
          .eq('user_id', currentUser.user_id);
        
        for (const r of (personalRecords || [])) {
          allRecords.push({
            record_id: r.record_id,
            discipline: r.discipline,
            attempt: r.attempt,
            value: r.value,
            date: r.personal_schedules?.date || 'ÎÇ†Ïßú ÏóÜÏùå',
            type: 'Í∞úÏù∏'
          });
        }
        
        // Í∏∞Î°ùÏù¥ ÏóÜÎäî Í≤ΩÏö∞
        if (allRecords.length === 0) {
          document.getElementById('my-best-records').innerHTML = 
            '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§</div>';
          document.getElementById('my-all-records').innerHTML = 
            '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§</div>';
          document.getElementById('growth-chart-card').style.display = 'none';
          return;
        }
        
        // ÏÑ±Ïû• Í∑∏ÎûòÌîÑÏö© Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
        allRecordsForChart = allRecords;
        document.getElementById('growth-chart-card').style.display = 'block';
        renderGrowthChart();
        
        // Ï¢ÖÎ™©Î≥Ñ ÏµúÍ≥† Í∏∞Î°ù Í≥ÑÏÇ∞
        const bestByDiscipline = {};
        for (const r of allRecords) {
          const val = parseFloat(r.value) || 0;
          if (!bestByDiscipline[r.discipline] || val > bestByDiscipline[r.discipline]) {
            bestByDiscipline[r.discipline] = val;
          }
        }
        
        const disciplines = ['STA', 'DYNB', 'FIM', 'CWTB', 'DNF', 'CNF', 'DYN', 'CWT'];
        let bestHtml = '';
        for (const d of disciplines) {
          const best = bestByDiscipline[d];
          const val = best ? (d === 'STA' ? best + 's' : best + 'm') : '-';
          bestHtml += `<div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--divider);">
            <span style="font-weight: 500;">${d}</span>
            <span style="color: var(--primary); font-weight: 600;">${val}</span>
          </div>`;
        }
        
        document.getElementById('my-best-records').innerHTML = bestHtml;
        
        // ÎÇ†ÏßúÎ≥Ñ Í∑∏Î£πÌïë (ÎÇ†ÏßúÎ≥Ñ ÏµúÍ≥† Í∏∞Î°ùÎßå)
        const recordsByDate = {};
        for (const r of allRecords) {
          if (!recordsByDate[r.date]) {
            recordsByDate[r.date] = {};
          }
          const val = parseFloat(r.value) || 0;
          if (!recordsByDate[r.date][r.discipline] || val > recordsByDate[r.date][r.discipline].value) {
            recordsByDate[r.date][r.discipline] = {
              value: val,
              type: r.type
            };
          }
        }
        
        // ÎÇ†Ïßú Ï†ïÎ†¨ (ÏµúÏã†Ïàú)
        const sortedDates = Object.keys(recordsByDate).sort((a, b) => b.localeCompare(a));
        
        // Ïó∞ÎèÑÎ≥ÑÎ°ú Í∑∏Î£πÌïë
        const recordsByYear = {};
        for (const date of sortedDates) {
          const year = date.substring(0, 4);
          if (!recordsByYear[year]) {
            recordsByYear[year] = [];
          }
          recordsByYear[year].push(date);
        }
        
        let allHtml = '';
        const sortedYears = Object.keys(recordsByYear).sort((a, b) => b - a);
        
        for (const year of sortedYears) {
          const shortYear = year.substring(2); // '2025' -> '25'
          allHtml += `<div style="font-size: 14px; font-weight: 700; color: var(--text-primary); margin: 16px 0 12px 0; padding-bottom: 8px; border-bottom: 2px solid var(--primary);">
            üìÜ ${shortYear}ÎÖÑ
          </div>`;
          
          for (const date of recordsByYear[year].slice(0, 15)) { // Ïó∞ÎèÑÎãπ ÏµúÎåÄ 15Ïùº
            const dateRecords = recordsByDate[date];
            const dateFormatted = formatDateCompact(date);
            
            allHtml += `<div style="margin-bottom: 12px; margin-left: 8px;">
              <div style="font-size: 13px; color: var(--text-secondary); font-weight: 500; margin-bottom: 6px;">
                ${dateFormatted}
              </div>
              <div style="display: flex; flex-wrap: wrap; gap: 6px;">`;
            
            for (const [disc, data] of Object.entries(dateRecords)) {
              const val = disc === 'STA' ? data.value + 's' : data.value + 'm';
              const typeColor = data.type === 'Í∞úÏù∏' ? 'var(--warning)' : 'var(--primary)';
              allHtml += `<div style="background: var(--bg); padding: 6px 10px; border-radius: 8px; display: flex; align-items: center; gap: 4px;">
                <span style="font-weight: 500; font-size: 12px;">${disc}</span>
                <span style="color: ${typeColor}; font-weight: 600; font-size: 13px;">${val}</span>
              </div>`;
            }
            
            allHtml += `</div></div>`;
          }
        }
        
        document.getElementById('my-all-records').innerHTML = allHtml || 
          '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§</div>';
        
      } catch (err) {
        console.error('Í∏∞Î°ù Î°úÎìú Ïò§Î•ò:', err);
        document.getElementById('my-best-records').innerHTML = 
          '<div style="text-align: center; color: var(--error); padding: 20px;">Í∏∞Î°ùÏùÑ Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§</div>';
      }
    }
    
    function formatDateShort(dateStr) {
      if (!dateStr || dateStr === 'ÎÇ†Ïßú ÏóÜÏùå') return dateStr;
      const d = new Date(dateStr);
      const month = d.getMonth() + 1;
      const day = d.getDate();
      const weekdays = ['Ïùº', 'Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†'];
      const weekday = weekdays[d.getDay()];
      return `${month}Ïõî ${day}Ïùº (${weekday})`;
    }
    
    function formatDateCompact(dateStr) {
      if (!dateStr || dateStr === 'ÎÇ†Ïßú ÏóÜÏùå') return dateStr;
      const d = new Date(dateStr);
      const month = d.getMonth() + 1;
      const day = d.getDate();
      const weekdays = ['Ïùº', 'Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†'];
      const weekday = weekdays[d.getDay()];
      return `${month}/${day} (${weekday})`;
    }

    // ==================== ÏûÑÏãú Ìï®ÏàòÎì§ ====================
    function quickRecordInput() {
      // Í∞úÏù∏ Í∏∞Î°ù ÏûÖÎ†• ÌôîÎ©¥ÏúºÎ°ú Ïù¥Îèô
      document.getElementById('personal-date').value = new Date().toISOString().split('T')[0];
      document.getElementById('personal-location').value = '';
      currentPersonalDiscipline = 'STA';
      personalAttempts = [{ value: '', note: '' }];
      renderPersonalAttempts();
      updatePersonalDisciplineUI();
      showScreen('screen-personal-record');
    }

    // ==================== Í∞ïÏäµ Í∏∞Î°ù ÏûÖÎ†• (Ìëú ÌòïÌÉú) ====================
    let batchParticipants = [];
    let currentBatchDiscipline = 'STA';
    let batchDisciplines = ['STA', 'DYNB', 'FIM', 'CWTB']; // ÏÑ†ÌÉùÎêú Ï¢ÖÎ™©Îì§
    let batchSkillItems = []; // Ïä§ÌÇ¨ Ìï≠Î™©Îì§ (Í∞ïÏäµ Î†àÎ≤®Ïóê Îî∞Îùº)
    let batchAttemptCount = 2;
    let batchRecords = {};
    let batchSkills = {};
    let currentBatchScheduleId = null;

    // ÏßÑÏûÖÏ†ê 1: Ìôà ‚Üí ÏµúÍ∑º Í∞ïÏäµ Í∏∞Î°ù ÏûÖÎ†•
    async function quickRecordInput() {
      if (currentUser.user_type !== 'Í∞ïÏÇ¨') {
        openPersonalRecordAdd();
        return;
      }
      
      try {
        const { data: schedules, error } = await db
          .from('schedules')
          .select('schedule_id, date, time, location')
          .eq('instructor_id', currentUser.user_id)
          .order('date', { ascending: false })
          .limit(5);
        
        if (error) throw error;
        
        if (!schedules || schedules.length === 0) {
          showToast('Îì±Î°ùÎêú ÏùºÏ†ïÏù¥ ÏóÜÏäµÎãàÎã§');
          return;
        }
        
        let html = '';
        for (const s of schedules) {
          html += `<div class="schedule-select-item" onclick="openLessonRecordInput('${s.schedule_id}'); closeBottomSheet('sheet-select-schedule');">
            <div style="font-weight: 600;">${formatDate(s.date)} ${formatTime(s.time)}</div>
            <div style="color: var(--text-secondary); font-size: 14px;">${s.location}</div>
          </div>`;
        }
        document.getElementById('recent-schedule-list').innerHTML = html;
        openBottomSheet('sheet-select-schedule');
      } catch (err) {
        console.error('ÏùºÏ†ï Î°úÎìú Ïò§Î•ò:', err);
        showToast('ÏùºÏ†ïÏùÑ Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§');
      }
    }

    // ÏßÑÏûÖÏ†ê 2: ÏùºÏ†ï Ïπ¥Îìú ‚Üí Í∏∞Î°ù ÏûÖÎ†•
    async function openLessonRecordInput(scheduleId) {
      currentBatchScheduleId = scheduleId;
      
      try {
        const { data: schedule } = await db
          .from('schedules')
          .select('*')
          .eq('schedule_id', scheduleId)
          .single();
        
        if (schedule) {
          document.getElementById('batch-schedule-date').textContent = formatDate(schedule.date) + ' ' + formatTime(schedule.time);
          document.getElementById('batch-schedule-location').textContent = schedule.location;
        }
        
        const { data: regs, error } = await db
          .from('registrations')
          .select(`
            reg_id,
            student_id,
            purpose,
            lesson_level,
            users!registrations_student_id_fkey (name, cert_level)
          `)
          .eq('schedule_id', scheduleId);
        
        if (error) throw error;
        
        if (!regs || regs.length === 0) {
          showToast('Ï∞∏Í∞ÄÏûêÍ∞Ä ÏóÜÏäµÎãàÎã§');
          return;
        }
        
        batchParticipants = regs.map(r => ({
          reg_id: r.reg_id,
          student_id: r.student_id,
          name: r.users?.name || 'Ïïå Ïàò ÏóÜÏùå',
          purpose: r.purpose,
          lesson_level: r.lesson_level
        }));
        
        // Í∞ïÏäµ Î†àÎ≤®Ïóê Îî∞Î•∏ Ïä§ÌÇ¨ Ìï≠Î™© ÏÑ§Ï†ï
        const lessonLevels = batchParticipants.filter(p => p.purpose === 'Í∞ïÏäµ').map(p => p.lesson_level);
        batchSkillItems = [];
        if (lessonLevels.includes(3)) {
          batchSkillItems = ['Ï§ëÏÑ±Î∂ÄÎ†•', 'ÌîÑÎ¶¨Ìè¥'];
        }
        
        // Ï¥àÍ∏∞Ìôî
        batchRecords = {};
        batchSkills = {};
        batchAttemptCount = 2;
        batchDisciplines = ['STA', 'DYNB', 'FIM', 'CWTB'];
        currentBatchDiscipline = 'STA';
        
        for (const p of batchParticipants) {
          batchRecords[p.reg_id] = {};
          batchSkills[p.reg_id] = {};
        }
        
        // Í∏∞Ï°¥ Í∏∞Î°ù Î°úÎìú
        await loadExistingBatchRecords();
        
        renderBatchDisciplineTabs();
        renderBatchSelectedDisciplines();
        renderBatchTable();
        
        showScreen('screen-batch-record');
      } catch (err) {
        console.error('Í∏∞Î°ù ÏûÖÎ†• Ïò§Î•ò:', err);
        showToast('Ï∞∏Í∞ÄÏûê Î°úÎìú Ïã§Ìå®');
      }
    }

    // Ïä§ÌÇ¨ Ï¢ÖÎ™© ÏòÅÏñ¥‚ÜîÌïúÍµ≠Ïñ¥ Îß§Ìïë
    const SKILL_NAME_MAP = {
      // ÏòÅÏñ¥ ‚Üí ÌïúÍµ≠Ïñ¥
      'neutral_buoyancy': 'Ï§ëÏÑ±Î∂ÄÎ†•',
      'freefall': 'ÌîÑÎ¶¨Ìè¥',
      'arms_only_15m': 'ÏïîÏä§Ïò®Î¶¨ 15m',
      'buddy_10_15m': 'Î≤ÑÎîî 10-15m',
      'lanyard_removal': 'Î†åÏïºÎìú Ï†úÍ±∞',
      'no_mask_10m': 'ÎÖ∏ÎßàÏä§ÌÅ¨ 10m',
      'rescue_towing': 'Î†àÏä§ÌÅê+ÌÜ†Ïûâ',
      'theory_test': 'Ïù¥Î°† ÌèâÍ∞Ä',
      'rescue_5_10m': 'Î†àÏä§ÌÅê 5-10m',
      // ÌïúÍµ≠Ïñ¥ ‚Üí ÏòÅÏñ¥ (Ï†ÄÏû•Ïö©)
      'Ï§ëÏÑ±Î∂ÄÎ†•': 'neutral_buoyancy',
      'ÌîÑÎ¶¨Ìè¥': 'freefall',
      'ÏïîÏä§Ïò®Î¶¨ 15m': 'arms_only_15m',
      'Î≤ÑÎîî 10-15m': 'buddy_10_15m',
      'Î†åÏïºÎìú Ï†úÍ±∞': 'lanyard_removal',
      'ÎÖ∏ÎßàÏä§ÌÅ¨ 10m': 'no_mask_10m',
      'Î†àÏä§ÌÅê+ÌÜ†Ïûâ': 'rescue_towing',
      'Ïù¥Î°† ÌèâÍ∞Ä': 'theory_test',
      'Î†àÏä§ÌÅê 5-10m': 'rescue_5_10m'
    };

    // Ïä§ÌÇ¨Î™ÖÏùÑ ÌïúÍµ≠Ïñ¥Î°ú Î≥ÄÌôò
    function toKoreanSkillName(name) {
      return SKILL_NAME_MAP[name] || name;
    }

    // Ïä§ÌÇ¨Î™ÖÏùÑ ÏòÅÏñ¥Î°ú Î≥ÄÌôò (DB Ï†ÄÏû•Ïö©)
    function toEnglishSkillName(name) {
      return SKILL_NAME_MAP[name] || name;
    }

    // Í∏∞Ï°¥ Í∏∞Î°ù Î°úÎìú
    async function loadExistingBatchRecords() {
      const regIds = batchParticipants.map(p => p.reg_id);
      
      try {
        // Îã§Ïù¥Î∏å Í∏∞Î°ù Î°úÎìú
        const { data: diveRecords } = await db
          .from('dive_records')
          .select('*')
          .in('reg_id', regIds);
        
        if (diveRecords) {
          for (const r of diveRecords) {
            if (!batchRecords[r.reg_id]) batchRecords[r.reg_id] = {};
            if (!batchRecords[r.reg_id][r.discipline]) {
              batchRecords[r.reg_id][r.discipline] = { attempts: [], note: '', recordIds: [] };
            }
            
            const attemptIdx = (r.attempt || 1) - 1;
            const valStr = r.value?.toString() || '';
            batchRecords[r.reg_id][r.discipline].attempts[attemptIdx] = valStr;
            // record_id Ï†ÄÏû• (Ïù¥ÎØ∏ Ï†ÄÏû•Îêú Í∏∞Î°ù ÌëúÏãú)
            batchRecords[r.reg_id][r.discipline].recordIds[attemptIdx] = r.record_id;
            if (r.note) {
              batchRecords[r.reg_id][r.discipline].note = r.note;
            }
            
            // ÏãúÎèÑ Ïàò ÏóÖÎç∞Ïù¥Ìä∏
            if (r.attempt > batchAttemptCount) {
              batchAttemptCount = r.attempt;
            }
            
            // Ï¢ÖÎ™© Ï∂îÍ∞Ä
            if (!batchDisciplines.includes(r.discipline)) {
              batchDisciplines.push(r.discipline);
            }
          }
        }
        
        // Ïä§ÌÇ¨ Í∏∞Î°ù Î°úÎìú
        const { data: skillRecords } = await db
          .from('skill_records')
          .select('*')
          .in('reg_id', regIds);
        
        if (skillRecords) {
          for (const r of skillRecords) {
            if (!batchSkills[r.reg_id]) batchSkills[r.reg_id] = {};
            
            // ÌïúÍµ≠Ïñ¥Î°ú Î≥ÄÌôò
            const koreanName = toKoreanSkillName(r.discipline);
            const result = r.result === 'Y' ? 'success' : 'fail';
            
            batchSkills[r.reg_id][koreanName] = result;
            // record_id Ï†ÄÏû• (Ïù¥ÎØ∏ Ï†ÄÏû•Îêú ÌëúÏãú)
            batchSkills[r.reg_id][koreanName + '_recordId'] = r.record_id;
            
            // Ïä§ÌÇ¨ Ï¢ÖÎ™© Ï∂îÍ∞Ä (ÌïúÍµ≠Ïñ¥Î°ú)
            if (!batchSkillItems.includes(koreanName)) {
              batchSkillItems.push(koreanName);
            }
          }
        }
      } catch (err) {
        console.error('Í∏∞Ï°¥ Í∏∞Î°ù Î°úÎìú Ïò§Î•ò:', err);
      }
    }

    function renderBatchDisciplineTabs() {
      let html = '';
      for (const disc of batchDisciplines) {
        const active = disc === currentBatchDiscipline ? 'active' : '';
        html += `<button class="disc-tab ${active}" data-disc="${disc}" onclick="selectBatchDiscipline('${disc}')">${disc}</button>`;
      }
      // Ïä§ÌÇ¨ ÌÉ≠ (ÏûàÏúºÎ©¥)
      if (batchSkillItems.length > 0) {
        const active = currentBatchDiscipline === 'SKILL' ? 'active' : '';
        html += `<button class="disc-tab disc-tab-skill ${active}" data-disc="SKILL" onclick="selectBatchDiscipline('SKILL')">Ïä§ÌÇ¨</button>`;
      }
      document.getElementById('batch-discipline-tabs').innerHTML = html;
    }

    function renderBatchSelectedDisciplines() {
      let html = '';
      for (const disc of batchDisciplines) {
        html += `<span style="padding: 4px 10px; background: var(--primary-light); color: var(--primary); border-radius: 12px; font-size: 13px; font-weight: 500;">${disc}</span>`;
      }
      if (batchSkillItems.length > 0) {
        html += `<span style="padding: 4px 10px; background: var(--lv3-light); color: var(--lv3-color); border-radius: 12px; font-size: 13px; font-weight: 500;">${batchSkillItems.join(', ')}</span>`;
      }
      html += `<button style="padding: 4px 10px; background: var(--bg); border: 1px dashed var(--border); border-radius: 12px; font-size: 13px; cursor: pointer;" onclick="openBatchAddDisciplineSheet()">+ ÏàòÏ†ï</button>`;
      document.getElementById('batch-selected-disciplines').innerHTML = html;
    }

    function openBatchAddDisciplineSheet() {
      const allDiscs = ['STA', 'DYNB', 'FIM', 'CWTB', 'DNF', 'CNF', 'DYN', 'CWT'];
      const allSkills = {
        'Lv2': ['Î†àÏä§ÌÅê 5-10m', 'Ïù¥Î°† ÌèâÍ∞Ä'],
        'Lv3': ['Î†åÏïºÎìú Ï†úÍ±∞', 'ÎÖ∏ÎßàÏä§ÌÅ¨ 10m', 'Î†àÏä§ÌÅê+ÌÜ†Ïûâ', 'Ï§ëÏÑ±Î∂ÄÎ†•', 'ÌîÑÎ¶¨Ìè¥', 'ÏïîÏä§Ïò®Î¶¨ 15m', 'Î≤ÑÎîî 10-15m', 'Ïù¥Î°† ÌèâÍ∞Ä']
      };
      
      // Ï∞∏Í∞ÄÏûêÎì§Ïùò Î†àÏä® Î†àÎ≤® ÌôïÏù∏
      const lessonLevels = batchParticipants.filter(p => p.purpose === 'Í∞ïÏäµ').map(p => p.lesson_level);
      const hasLv2 = lessonLevels.includes(2);
      const hasLv3 = lessonLevels.includes(3);
      
      let html = '<div style="margin-bottom: 20px;">';
      html += '<div style="font-weight: 600; margin-bottom: 12px;">Í∏∞Î°ù Ï¢ÖÎ™©</div>';
      html += '<div style="display: flex; flex-wrap: wrap; gap: 4px;">';
      
      for (const d of allDiscs) {
        const checked = batchDisciplines.includes(d) ? 'checked' : '';
        html += `<label style="display: inline-flex; align-items: center; gap: 6px; padding: 8px 12px;">
          <input type="checkbox" value="${d}" data-type="disc" ${checked}> ${d}
        </label>`;
      }
      html += '</div></div>';
      
      // Ïä§ÌÇ¨ Ï¢ÖÎ™©
      if (hasLv2 || hasLv3) {
        html += '<div style="border-top: 1px solid var(--divider); padding-top: 16px;">';
        html += '<div style="font-weight: 600; margin-bottom: 12px;">Ïä§ÌÇ¨ Ï¢ÖÎ™©</div>';
        
        if (hasLv2) {
          html += '<div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">Lv2</div>';
          html += '<div style="display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 12px;">';
          for (const s of allSkills['Lv2']) {
            const checked = batchSkillItems.includes(s) ? 'checked' : '';
            html += `<label style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px;">
              <input type="checkbox" value="${s}" data-type="skill" ${checked}> ${s}
            </label>`;
          }
          html += '</div>';
        }
        
        if (hasLv3) {
          html += '<div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">Lv3</div>';
          html += '<div style="display: flex; flex-wrap: wrap; gap: 4px;">';
          for (const s of allSkills['Lv3']) {
            const checked = batchSkillItems.includes(s) ? 'checked' : '';
            html += `<label style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px;">
              <input type="checkbox" value="${s}" data-type="skill" ${checked}> ${s}
            </label>`;
          }
          html += '</div>';
        }
        html += '</div>';
      }
      
      document.getElementById('batch-add-discipline-options').innerHTML = html;
      openBottomSheet('sheet-batch-add-discipline');
    }

    function confirmBatchAddDiscipline() {
      const selectedDiscs = [];
      const selectedSkills = [];
      
      document.querySelectorAll('#batch-add-discipline-options input:checked').forEach(cb => {
        if (cb.dataset.type === 'disc') {
          selectedDiscs.push(cb.value);
        } else if (cb.dataset.type === 'skill') {
          selectedSkills.push(cb.value);
        }
      });
      
      if (selectedDiscs.length === 0) {
        showToast('ÏµúÏÜå 1Í∞ú Í∏∞Î°ù Ï¢ÖÎ™©ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî');
        return;
      }
      
      batchDisciplines = selectedDiscs;
      batchSkillItems = selectedSkills;
      
      if (!batchDisciplines.includes(currentBatchDiscipline) && currentBatchDiscipline !== 'SKILL') {
        currentBatchDiscipline = batchDisciplines[0];
      }
      if (currentBatchDiscipline === 'SKILL' && batchSkillItems.length === 0) {
        currentBatchDiscipline = batchDisciplines[0];
      }
      
      closeBottomSheet('sheet-batch-add-discipline');
      renderBatchDisciplineTabs();
      renderBatchSelectedDisciplines();
      renderBatchTable();
    }

    function closeBatchRecord() {
      if (currentBatchScheduleId) {
        currentScheduleId = currentBatchScheduleId;
        showScreen('screen-schedule-manage');
      } else {
        goBack();
      }
    }

    function selectBatchDiscipline(disc) {
      saveBatchCurrentInput();
      currentBatchDiscipline = disc;
      renderBatchDisciplineTabs();
      renderBatchTable();
    }

    function updateBatchDisciplineUI() {
      renderBatchDisciplineTabs();
      
      const isSkill = currentBatchDiscipline === 'SKILL';
      document.getElementById('batch-record-table-card').style.display = isSkill ? 'none' : 'block';
      document.getElementById('batch-skill-table-card').style.display = isSkill ? 'block' : 'none';
      
      if (isSkill) {
        renderBatchSkillTable();
      }
    }

    function renderBatchTable() {
      if (currentBatchDiscipline === 'SKILL') {
        document.getElementById('batch-record-table-card').style.display = 'none';
        document.getElementById('batch-skill-table-card').style.display = 'block';
        renderBatchSkillTable();
        return;
      }
      
      document.getElementById('batch-record-table-card').style.display = 'block';
      document.getElementById('batch-skill-table-card').style.display = 'none';
      
      // Ìó§Îçî Î†åÎçîÎßÅ
      let headerHtml = '<tr><th class="col-name">ÌïôÏÉùÎ™Ö</th>';
      for (let i = 1; i <= batchAttemptCount; i++) {
        headerHtml += `<th class="col-attempt">${i}Ï∞®</th>`;
      }
      headerHtml += `<th class="col-add-attempt"><button class="btn-add-col" onclick="addBatchAttemptColumn()">+</button></th>`;
      headerHtml += '<th class="col-note">Î©îÎ™®</th></tr>';
      document.querySelector('#batch-record-table thead').innerHTML = headerHtml;
      
      // Î∞îÎîî Î†åÎçîÎßÅ
      let bodyHtml = '';
      for (const p of batchParticipants) {
        const records = batchRecords[p.reg_id]?.[currentBatchDiscipline] || { attempts: [], note: '' };
        
        bodyHtml += `<tr data-reg-id="${p.reg_id}">
          <td class="col-name">${p.name}</td>`;
        
        for (let i = 0; i < batchAttemptCount; i++) {
          const val = records.attempts[i] || '';
          bodyHtml += `<td><input type="number" value="${val}" data-attempt="${i}" placeholder="-"></td>`;
        }
        
        bodyHtml += `<td></td>`;
        bodyHtml += `<td><input type="text" class="note-input" value="${records.note || ''}" data-note="true" placeholder=""></td>
        </tr>`;
      }
      
      document.getElementById('batch-record-tbody').innerHTML = bodyHtml;
    }

    function renderBatchSkillTable() {
      if (batchSkillItems.length === 0) return;
      
      // Ìó§Îçî
      let headerHtml = '<tr><th class="col-name">ÌïôÏÉùÎ™Ö</th>';
      for (const skill of batchSkillItems) {
        headerHtml += `<th class="col-skill">${skill}</th>`;
      }
      headerHtml += '</tr>';
      document.querySelector('#batch-skill-table thead').innerHTML = headerHtml;
      
      // Î∞îÎîî
      let bodyHtml = '';
      for (const p of batchParticipants) {
        if (p.purpose !== 'Í∞ïÏäµ') continue; // Í∞ïÏäµÏÉùÎßå
        
        bodyHtml += `<tr data-reg-id="${p.reg_id}">
          <td class="col-name">${p.name}</td>`;
        
        for (const skill of batchSkillItems) {
          const status = batchSkills[p.reg_id]?.[skill] || '';
          const successClass = status === 'success' ? 'success' : '';
          const failClass = status === 'fail' ? 'fail' : '';
          
          bodyHtml += `<td>
            <button class="skill-check-btn ${successClass} ${failClass}" 
                    onclick="toggleSkill('${p.reg_id}', '${skill}', this)">
              ${status === 'success' ? '‚úì' : status === 'fail' ? '‚úó' : ''}
            </button>
          </td>`;
        }
        
        bodyHtml += '</tr>';
      }
      
      document.getElementById('batch-skill-tbody').innerHTML = bodyHtml;
    }

    function toggleSkill(regId, skillName, btn) {
      if (!batchSkills[regId]) batchSkills[regId] = {};
      
      const current = batchSkills[regId][skillName] || '';
      let next = '';
      
      if (current === '') next = 'success';
      else if (current === 'success') next = 'fail';
      else next = '';
      
      batchSkills[regId][skillName] = next;
      
      btn.className = 'skill-check-btn ' + (next === 'success' ? 'success' : next === 'fail' ? 'fail' : '');
      btn.textContent = next === 'success' ? '‚úì' : next === 'fail' ? '‚úó' : '';
    }

    function addBatchAttemptColumn() {
      saveBatchCurrentInput();
      batchAttemptCount++;
      renderBatchTable();
    }

    function saveBatchCurrentInput() {
      if (currentBatchDiscipline === 'SKILL') return;
      
      const rows = document.querySelectorAll('#batch-record-tbody tr');
      rows.forEach(row => {
        const regId = row.dataset.regId;
        if (!regId) return;
        
        if (!batchRecords[regId]) batchRecords[regId] = {};
        if (!batchRecords[regId][currentBatchDiscipline]) {
          batchRecords[regId][currentBatchDiscipline] = { attempts: [], note: '' };
        }
        
        const inputs = row.querySelectorAll('input');
        const attempts = [];
        let note = '';
        
        inputs.forEach(input => {
          if (input.dataset.note) {
            note = input.value;
          } else if (input.dataset.attempt !== undefined) {
            attempts[parseInt(input.dataset.attempt)] = input.value;
          }
        });
        
        batchRecords[regId][currentBatchDiscipline] = { attempts, note };
      });
    }

    async function saveBatchRecords(finish = false) {
      saveBatchCurrentInput();
      
      try {
        const regIds = batchParticipants.map(p => p.reg_id);
        
        // 1. Í∏∞Ï°¥ Í∏∞Î°ù Ï†ÑÏ≤¥ ÏÇ≠Ï†ú
        await db.from('dive_records').delete().in('reg_id', regIds);
        await db.from('skill_records').delete().in('reg_id', regIds);
        
        // 2. ÌòÑÏû¨ ÏûÖÎ†•Îêú Í∞íÎì§ Ï†ÑÏ≤¥ ÏÉàÎ°ú Ï†ÄÏû•
        let totalSaved = 0;
        
        // Îã§Ïù¥Î∏å Í∏∞Î°ù Ï†ÄÏû•
        for (const regId of Object.keys(batchRecords)) {
          for (const discipline of Object.keys(batchRecords[regId])) {
            const data = batchRecords[regId][discipline];
            
            for (let i = 0; i < data.attempts.length; i++) {
              const val = data.attempts[i];
              if (!val || val === '') continue;
              
              const recordId = 'DR_' + regId + '_' + discipline + '_' + Date.now() + '_' + i + '_' + Math.random().toString(36).substr(2, 5);
              
              const { error } = await db
                .from('dive_records')
                .insert({
                  record_id: recordId,
                  reg_id: regId,
                  discipline: discipline,
                  attempt: i + 1,
                  value: parseFloat(val),
                  note: i === 0 ? data.note : null
                });
              
              if (!error) totalSaved++;
            }
          }
        }
        
        // Ïä§ÌÇ¨ Í∏∞Î°ù Ï†ÄÏû•
        for (const regId of Object.keys(batchSkills)) {
          for (const skillName of Object.keys(batchSkills[regId])) {
            if (skillName.endsWith('_recordId')) continue;
            
            const result = batchSkills[regId][skillName];
            if (!result) continue;
            
            const englishName = toEnglishSkillName(skillName);
            const recordId = 'SR_' + regId + '_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
            
            const { error } = await db
              .from('skill_records')
              .insert({
                record_id: recordId,
                reg_id: regId,
                discipline: englishName,
                attempt: 1,
                result: result === 'success' ? 'Y' : 'N',
                note: null
              });
            
            if (!error) totalSaved++;
          }
        }
        
        showToast(`${totalSaved}Í∞ú Í∏∞Î°ùÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§`);
        
        if (finish) {
          closeBatchRecord();
        } else {
          // 3. DBÏóêÏÑú Îã§Ïãú Î°úÎìúÌï¥ÏÑú UI Í∞±Ïã†
          batchRecords = {};
          batchSkills = {};
          for (const p of batchParticipants) {
            batchRecords[p.reg_id] = {};
            batchSkills[p.reg_id] = {};
          }
          await loadExistingBatchRecords();
          renderBatchTable();
        }
      } catch (err) {
        console.error('Ï†ÄÏû• Ïò§Î•ò:', err);
        showToast('Ï†ÄÏû• Ïã§Ìå®: ' + err.message);
      }
    }

    // ==================== Í∞úÏù∏ Í∏∞Î°ù ÏûÖÎ†• ====================
    let personalDate = '';
    let personalTime = '';
    let personalLocation = '';
    let personalDisciplines = ['STA', 'DYNB', 'FIM', 'CWTB'];
    let personalAttemptCount = 2;
    let personalRecords = {}; // { discipline: [val1, val2, ...] }
    let personalMemo = '';

    // Í∞úÎ≥Ñ Ï∂îÍ∞Ä ÏßÑÏûÖÏ†ê
    function openPersonalRecordAdd() {
      document.getElementById('personal-add-date').value = new Date().toISOString().split('T')[0];
      document.getElementById('personal-add-time').value = '';
      document.getElementById('personal-add-location').value = '';
      
      // Ï≤¥ÌÅ¨Î∞ïÏä§ Ï¥àÍ∏∞Ìôî
      document.querySelectorAll('#personal-discipline-checks input').forEach(cb => {
        cb.checked = ['STA', 'DYNB', 'FIM', 'CWTB'].includes(cb.value);
      });
      
      openBottomSheet('sheet-personal-add');
    }

    function startPersonalRecordInput() {
      personalDate = document.getElementById('personal-add-date').value;
      personalTime = document.getElementById('personal-add-time').value;
      personalLocation = document.getElementById('personal-add-location').value;
      
      if (!personalDate) {
        showToast('ÎÇ†ÏßúÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî');
        return;
      }
      
      // ÏÑ†ÌÉùÎêú Ï¢ÖÎ™©
      personalDisciplines = [];
      document.querySelectorAll('#personal-discipline-checks input:checked').forEach(cb => {
        personalDisciplines.push(cb.value);
      });
      
      if (personalDisciplines.length === 0) {
        showToast('Ï¢ÖÎ™©ÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî');
        return;
      }
      
      // Ï¥àÍ∏∞Ìôî
      personalAttemptCount = 2;
      personalRecords = {};
      for (const d of personalDisciplines) {
        personalRecords[d] = [];
      }
      personalMemo = '';
      
      closeBottomSheet('sheet-personal-add');
      renderPersonalRecordScreen();
      showScreen('screen-personal-record');
    }

    function renderPersonalRecordScreen() {
      // ÎÇ†Ïßú/Ïû•ÏÜå ÌëúÏãú
      document.getElementById('personal-date-display').textContent = formatDate(personalDate) + (personalTime ? ' ' + formatTime(personalTime) : '');
      document.getElementById('personal-location-display').textContent = personalLocation || 'Ïû•ÏÜå ÎØ∏ÏûÖÎ†•';
      
      // ÌÖåÏù¥Î∏î Ìó§Îçî
      let headerHtml = '<tr><th class="col-name">Ï¢ÖÎ™©</th>';
      for (let i = 1; i <= personalAttemptCount; i++) {
        headerHtml += `<th class="col-attempt">${i}Ï∞®</th>`;
      }
      headerHtml += '</tr>';
      document.querySelector('#personal-record-table thead').innerHTML = headerHtml;
      
      // ÌÖåÏù¥Î∏î Î∞îÎîî
      let bodyHtml = '';
      for (const disc of personalDisciplines) {
        const records = personalRecords[disc] || [];
        
        bodyHtml += `<tr data-disc="${disc}">
          <td class="col-name">${disc}</td>`;
        
        for (let i = 0; i < personalAttemptCount; i++) {
          const val = records[i] || '';
          bodyHtml += `<td><input type="number" value="${val}" data-attempt="${i}" placeholder="-"></td>`;
        }
        
        bodyHtml += '</tr>';
      }
      
      document.getElementById('personal-record-tbody').innerHTML = bodyHtml;
      document.getElementById('personal-memo').value = personalMemo;
    }

    function addPersonalAttemptColumn() {
      savePersonalCurrentInput();
      personalAttemptCount++;
      renderPersonalRecordScreen();
    }

    function openAddDisciplineSheet() {
      const allDiscs = ['STA', 'DYNB', 'FIM', 'CWTB', 'DNF', 'CNF', 'DYN', 'CWT'];
      let html = '';
      
      for (const d of allDiscs) {
        const checked = personalDisciplines.includes(d) ? 'checked disabled' : '';
        html += `<label style="display: flex; align-items: center; gap: 8px; padding: 8px;">
          <input type="checkbox" value="${d}" ${checked}> ${d}
        </label>`;
      }
      
      document.getElementById('add-discipline-options').innerHTML = html;
      openBottomSheet('sheet-add-discipline');
    }

    function confirmAddDiscipline() {
      document.querySelectorAll('#add-discipline-options input:checked:not(:disabled)').forEach(cb => {
        if (!personalDisciplines.includes(cb.value)) {
          personalDisciplines.push(cb.value);
          personalRecords[cb.value] = [];
        }
      });
      
      closeBottomSheet('sheet-add-discipline');
      renderPersonalRecordScreen();
    }

    function openPersonalDateEdit() {
      const newDate = prompt('ÎÇ†Ïßú (YYYY-MM-DD):', personalDate);
      if (newDate) {
        personalDate = newDate;
        renderPersonalRecordScreen();
      }
    }

    function savePersonalCurrentInput() {
      const rows = document.querySelectorAll('#personal-record-tbody tr');
      rows.forEach(row => {
        const disc = row.dataset.disc;
        if (!disc) return;
        
        const inputs = row.querySelectorAll('input');
        const attempts = [];
        
        inputs.forEach(input => {
          if (input.dataset.attempt !== undefined) {
            attempts[parseInt(input.dataset.attempt)] = input.value;
          }
        });
        
        personalRecords[disc] = attempts;
      });
      
      personalMemo = document.getElementById('personal-memo')?.value || '';
    }

    async function savePersonalRecord(finish = false) {
      savePersonalCurrentInput();
      
      try {
        const personalScheduleId = 'PS_' + currentUser.user_id + '_' + Date.now();
        
        const { error: scheduleError } = await db
          .from('personal_schedules')
          .insert({
            personal_schedule_id: personalScheduleId,
            date: personalDate,
            time: personalTime || null,
            location: personalLocation || null,
            common_disciplines: personalDisciplines.join(',')
          });
        
        if (scheduleError) throw scheduleError;
        
        let totalSaved = 0;
        
        for (const disc of Object.keys(personalRecords)) {
          const attempts = personalRecords[disc];
          
          for (let i = 0; i < attempts.length; i++) {
            const val = attempts[i];
            if (!val || val === '') continue;
            
            const recordId = 'PDR_' + currentUser.user_id + '_' + Date.now() + '_' + disc + '_' + i;
            
            const { error } = await db
              .from('personal_dive_records')
              .insert({
                record_id: recordId,
                personal_schedule_id: personalScheduleId,
                user_id: currentUser.user_id,
                discipline: disc,
                attempt: i + 1,
                value: parseFloat(val)
              });
            
            if (!error) totalSaved++;
          }
        }
        
        showToast(`${totalSaved}Í∞ú Í∏∞Î°ùÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§`);
        
        if (finish) {
          showScreen('screen-my-records');
        } else {
          personalRecords = {};
          for (const d of personalDisciplines) {
            personalRecords[d] = [];
          }
          renderPersonalRecordScreen();
        }
      } catch (err) {
        console.error('Í∞úÏù∏ Í∏∞Î°ù Ï†ÄÏû• Ïò§Î•ò:', err);
        showToast('Ï†ÄÏû• Ïã§Ìå®: ' + err.message);
      }
    }

    // ==================== Í∞úÏù∏ Í∏∞Î°ù ÏùºÍ¥Ñ Ï∂îÍ∞Ä ====================
    let bulkDates = [];
    let currentBulkDateIndex = 0;
    let bulkRecords = {};
    let bulkDisciplines = ['CWTB', 'FIM'];
    let bulkAttemptCount = 2;

    function openPersonalBulkAdd() {
      bulkDates = [{ date: '', location: '' }];
      bulkRecords = {};
      bulkDisciplines = ['CWTB', 'FIM'];
      bulkAttemptCount = 2;
      renderBulkDateList();
      renderBulkTabbar();
      showScreen('screen-personal-bulk');
    }

    function renderBulkTabbar() {
      const isInstructor = currentUser.user_type === 'Í∞ïÏÇ¨';
      const html = `
        <button class="tab-item" onclick="showScreen('${isInstructor ? 'screen-instructor-home' : 'screen-student-home'}')"><i class="fas fa-home"></i><span>Ìôà</span></button>
        <button class="tab-item" onclick="showScreen('${isInstructor ? 'screen-schedule-manage' : 'screen-student-schedule'}')"><i class="fas fa-calendar"></i><span>ÏùºÏ†ï</span></button>
        <button class="tab-item active"><i class="fas fa-chart-line"></i><span>ÎÇ¥Í∏∞Î°ù</span></button>
        <button class="tab-item" onclick="showScreen('screen-mypage')"><i class="fas fa-user"></i><span>ÎßàÏù¥</span></button>
      `;
      const tabbar1 = document.getElementById('bulk-tabbar');
      const tabbar2 = document.getElementById('bulk-input-tabbar');
      if (tabbar1) tabbar1.innerHTML = html;
      if (tabbar2) tabbar2.innerHTML = html;
    }

    function renderBulkDateList() {
      let html = '';
      bulkDates.forEach((d, idx) => {
        html += `<div class="card" style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px; padding: 12px;">
          <input type="text" class="input" style="flex: 0.4;" placeholder="YYMMDD" value="${d.date}" 
                 onchange="bulkDates[${idx}].date = this.value">
          <input type="text" class="input" style="flex: 0.6;" placeholder="Ïû•ÏÜå" value="${d.location}"
                 onchange="bulkDates[${idx}].location = this.value">
          ${bulkDates.length > 1 ? `<button class="attempt-delete" onclick="removeBulkDateRow(${idx})"><i class="fas fa-times"></i></button>` : ''}
        </div>`;
      });
      document.getElementById('bulk-date-list').innerHTML = html;
    }

    function addBulkDateRow() {
      bulkDates.push({ date: '', location: '' });
      renderBulkDateList();
    }

    function removeBulkDateRow(idx) {
      bulkDates.splice(idx, 1);
      renderBulkDateList();
    }

    function proceedToBulkRecordInput() {
      bulkDates = bulkDates.filter(d => d.date && d.date.length === 6);
      
      if (bulkDates.length === 0) {
        showToast('ÎÇ†ÏßúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî (YYMMDD ÌòïÏãù)');
        return;
      }
      
      currentBulkDateIndex = 0;
      bulkRecords = {};
      bulkAttemptCount = 2;
      
      for (let i = 0; i < bulkDates.length; i++) {
        bulkRecords[i] = {};
        for (const d of bulkDisciplines) {
          bulkRecords[i][d] = [];
        }
      }
      
      renderBulkDateTabs();
      renderBulkRecordTable();
      renderBulkTabbar();
      showScreen('screen-personal-bulk-input');
    }

    function renderBulkDateTabs() {
      let html = '';
      bulkDates.forEach((d, idx) => {
        const label = d.date.substring(0, 2) + '-' + d.date.substring(2, 4) + '-' + d.date.substring(4, 6) + ' ' + (d.location || '');
        const active = idx === currentBulkDateIndex ? 'active' : '';
        html += `<button class="participant-tab ${active}" onclick="selectBulkDate(${idx})">${label}</button>`;
      });
      document.getElementById('bulk-date-tabs').innerHTML = html;
    }

    function selectBulkDate(idx) {
      saveBulkCurrentInput();
      currentBulkDateIndex = idx;
      renderBulkDateTabs();
      renderBulkRecordTable();
    }

    function renderBulkRecordTable() {
      // Ìó§Îçî
      let headerHtml = '<tr><th class="col-name">Ï¢ÖÎ™©</th>';
      for (let i = 1; i <= bulkAttemptCount; i++) {
        headerHtml += `<th class="col-attempt">${i}Ï∞®</th>`;
      }
      headerHtml += `<th class="col-add-attempt"><button class="btn-add-col" onclick="addBulkAttemptColumn()">+</button></th></tr>`;
      document.querySelector('#bulk-record-table thead').innerHTML = headerHtml;
      
      // Î∞îÎîî
      let bodyHtml = '';
      for (const disc of bulkDisciplines) {
        const records = bulkRecords[currentBulkDateIndex]?.[disc] || [];
        
        bodyHtml += `<tr data-disc="${disc}">
          <td class="col-name">${disc}</td>`;
        
        for (let i = 0; i < bulkAttemptCount; i++) {
          bodyHtml += `<td><input type="number" value="${records[i] || ''}" data-attempt="${i}" placeholder="-"></td>`;
        }
        
        bodyHtml += `<td></td></tr>`;
      }
      
      document.getElementById('bulk-record-tbody').innerHTML = bodyHtml;
    }

    function addBulkAttemptColumn() {
      saveBulkCurrentInput();
      bulkAttemptCount++;
      renderBulkRecordTable();
    }

    function openBulkAddDisciplineSheet() {
      const allDiscs = ['STA', 'DYNB', 'FIM', 'CWTB', 'DNF', 'CNF', 'DYN', 'CWT'];
      let html = '';
      
      for (const d of allDiscs) {
        const checked = bulkDisciplines.includes(d) ? 'checked' : '';
        html += `<label style="display: flex; align-items: center; gap: 8px; padding: 8px;">
          <input type="checkbox" value="${d}" ${checked}> ${d}
        </label>`;
      }
      
      document.getElementById('bulk-add-discipline-options').innerHTML = html;
      openBottomSheet('sheet-bulk-add-discipline');
    }

    function confirmBulkAddDiscipline() {
      const selected = [];
      document.querySelectorAll('#bulk-add-discipline-options input:checked').forEach(cb => {
        selected.push(cb.value);
      });
      
      if (selected.length === 0) {
        showToast('ÏµúÏÜå 1Í∞ú Ï¢ÖÎ™©ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî');
        return;
      }
      
      // ÏÉàÎ°ú Ï∂îÍ∞ÄÎêú Ï¢ÖÎ™© Ï¥àÍ∏∞Ìôî
      for (const disc of selected) {
        if (!bulkDisciplines.includes(disc)) {
          for (let i = 0; i < bulkDates.length; i++) {
            if (!bulkRecords[i]) bulkRecords[i] = {};
            bulkRecords[i][disc] = [];
          }
        }
      }
      
      bulkDisciplines = selected;
      closeBottomSheet('sheet-bulk-add-discipline');
      renderBulkRecordTable();
    }

    function saveBulkCurrentInput() {
      const rows = document.querySelectorAll('#bulk-record-tbody tr');
      rows.forEach(row => {
        const disc = row.dataset.disc;
        if (!disc) return;
        
        const inputs = row.querySelectorAll('input');
        const attempts = [];
        
        inputs.forEach(input => {
          if (input.dataset.attempt !== undefined) {
            attempts[parseInt(input.dataset.attempt)] = input.value;
          }
        });
        
        if (!bulkRecords[currentBulkDateIndex]) bulkRecords[currentBulkDateIndex] = {};
        bulkRecords[currentBulkDateIndex][disc] = attempts;
      });
    }

    async function saveBulkRecords(finish = false) {
      saveBulkCurrentInput();
      
      try {
        let totalSaved = 0;
        
        for (let dateIdx = 0; dateIdx < bulkDates.length; dateIdx++) {
          const dateInfo = bulkDates[dateIdx];
          const fullDate = '20' + dateInfo.date.substring(0, 2) + '-' + dateInfo.date.substring(2, 4) + '-' + dateInfo.date.substring(4, 6);
          
          const personalScheduleId = 'PS_' + currentUser.user_id + '_' + Date.now() + '_' + dateIdx;
          
          await db.from('personal_schedules').insert({
            personal_schedule_id: personalScheduleId,
            date: fullDate,
            time: null,
            location: dateInfo.location || null,
            common_disciplines: bulkDisciplines.join(',')
          });
          
          const dateRecords = bulkRecords[dateIdx] || {};
          
          for (const disc of Object.keys(dateRecords)) {
            const attempts = dateRecords[disc];
            
            for (let i = 0; i < attempts.length; i++) {
              const val = attempts[i];
              if (!val || val === '') continue;
              
              const recordId = 'PDR_' + currentUser.user_id + '_' + Date.now() + '_' + dateIdx + '_' + disc + '_' + i;
              
              const { error } = await db.from('personal_dive_records').insert({
                record_id: recordId,
                personal_schedule_id: personalScheduleId,
                user_id: currentUser.user_id,
                discipline: disc,
                attempt: i + 1,
                value: parseFloat(val)
              });
              
              if (!error) totalSaved++;
            }
          }
        }
        
        showToast(`${totalSaved}Í∞ú Í∏∞Î°ùÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§`);
        
        if (finish) {
          showScreen('screen-my-records');
        }
      } catch (err) {
        console.error('ÏùºÍ¥Ñ Ï†ÄÏû• Ïò§Î•ò:', err);
        showToast('Ï†ÄÏû• Ïã§Ìå®: ' + err.message);
      }
    }

    // ==================== ÏÑ±Ïû• Í∑∏ÎûòÌîÑ ====================
    let growthChart = null;
    let currentChartDiscipline = 'STA';
    let allRecordsForChart = [];

    function selectChartDiscipline(disc) {
      currentChartDiscipline = disc;
      document.querySelectorAll('#chart-discipline-tabs .disc-tab').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.disc === disc);
      });
      renderGrowthChart();
    }

    function renderGrowthChart() {
      const ctx = document.getElementById('growth-chart');
      if (!ctx) return;
      
      const discRecords = allRecordsForChart.filter(r => r.discipline === currentChartDiscipline);
      
      if (discRecords.length === 0) {
        if (growthChart) {
          growthChart.destroy();
          growthChart = null;
        }
        return;
      }
      
      const dateMap = {};
      for (const r of discRecords) {
        const val = parseFloat(r.value) || 0;
        if (!dateMap[r.date] || val > dateMap[r.date]) {
          dateMap[r.date] = val;
        }
      }
      
      const sortedDates = Object.keys(dateMap).sort();
      const labels = sortedDates.map(d => {
        const date = new Date(d);
        return (date.getMonth() + 1) + '/' + date.getDate();
      });
      const data = sortedDates.map(d => dateMap[d]);
      
      if (growthChart) {
        growthChart.destroy();
      }
      
      growthChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: currentChartDiscipline,
            data: data,
            borderColor: '#3182F6',
            backgroundColor: 'rgba(49, 130, 246, 0.1)',
            borderWidth: 2,
            tension: 0.3,
            fill: true,
            pointRadius: 4,
            pointBackgroundColor: '#3182F6'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, grid: { color: '#E5E8EB' } },
            x: { grid: { display: false } }
          }
        }
      });
    }

    function toggleChecklist(type) {
      const checklist = document.getElementById(type + '-checklist');
      const icon = document.getElementById(type + '-toggle-icon');
      
      if (checklist && icon) {
        if (checklist.classList.contains('open')) {
          checklist.classList.remove('open');
          icon.classList.remove('open');
        } else {
          checklist.classList.add('open');
          icon.classList.add('open');
        }
      }
    }
  </script>
</body>
</html>
